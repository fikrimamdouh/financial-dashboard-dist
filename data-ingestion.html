<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استيعاب وتدقيق البيانات | Polaris</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/polaris-theme.css">
    <style>
        .upload-slot { border: 2px dashed var(--color-border ); border-radius: 12px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s ease; position: relative; background-color: rgba(13, 17, 23, 0.5); }
        .upload-slot.drag-over { border-color: var(--color-primary); background-color: rgba(0, 191, 255, 0.05); }
        .upload-slot.completed { border-color: #28a745; background-color: rgba(40, 167, 69, 0.05); }
        .upload-slot.failed { border-color: #ffc107; background-color: rgba(255, 193, 7, 0.05); }
        .upload-slot .upload-content { transition: opacity 0.3s ease; }
        .upload-slot .upload-loader { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: rgba(13, 17, 23, 0.9); opacity: 0; visibility: hidden; transition: all 0.3s ease; border-radius: 12px; }
        .upload-slot.loading .upload-content { opacity: 0.2; }
        .upload-slot.loading .upload-loader { opacity: 1; visibility: visible; }
        .validation-summary { font-size: 0.85rem; text-align: right; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--color-border); }
        .history-log { font-size: 0.8rem; background-color: rgba(0,0,0,0.2); border-radius: 6px; }
        .history-log-item { border-bottom: 1px solid rgba(255,255,255,0.1); }
        .history-log-item:last-child { border-bottom: none; }
        
        /* تنسيقات نافذة تعيين الأعمدة */
        #columnMappingModal .table { font-size: 0.85rem; color: #ffffff; }
        #columnMappingModal .table th { background-color: rgba(0, 191, 255, 0.2); vertical-align: middle; color: #00bfff; font-weight: bold; border: 1px solid rgba(0, 191, 255, 0.3); }
        #columnMappingModal .table td { background-color: rgba(13, 17, 23, 0.8); color: #e6edf3; border: 1px solid rgba(255, 255, 255, 0.1); }
        #columnMappingModal .form-select { font-size: 0.8rem; padding: 0.25rem 0.5rem; background-color: #1c2128; color: #e6edf3; border: 1px solid #30363d; }
        #columnMappingModal .small.text-muted { color: #8b949e !important; font-weight: 500; }
    </style>
</head>
<body>
    <div class="grid-background"></div>
    <div class="glow-background"></div>

    <nav class="sidebar">
        <a href="company-setup.html" class="app-logo" title="العودة لتأسيس الكيانات"><i class="fas fa-chevron-left"></i></a>
    </nav>

    <main class="main-content">
        <div class="page-header d-flex justify-content-between align-items-center">
            <h1 id="pageTitle" class="page-title">محطة استيعاب البيانات</h1>
            <div>
                <button class="btn btn-outline-secondary" onclick="downloadTemplate()"><i class="fas fa-download me-2"></i>تحميل نموذج Excel</button>
                <button id="nextStepBtn" class="btn btn-primary ms-2" onclick="processAndProceed()" disabled><i class="fas fa-check-double me-2"></i>اعتماد البيانات والمتابعة</button>
            </div>
        </div>
        <div id="loader" class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">جاري تحميل بروتوكول التأسيس...</p></div>
        <div id="contentArea" class="control-pane" style="display: none;"></div>
    </main>

    <!-- Modal for Upload History -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="historyModalTitle">سجل الرفع</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="historyModalBody"></div>
            </div>
        </div>
    </div>

    <!-- Modal for Column Mapping -->
    <div class="modal fade" id="columnMappingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class="fas fa-map-signs me-2"></i>تعيين أعمدة ميزان المراجعة</h5>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>تعليمات:</strong> يرجى تعيين الأعمدة الأساسية يدوياً من القوائم المنسدلة أدناه. يجب تعيين "رقم الحساب" و "اسم الحساب" على الأقل.
                    </div>
                    <div class="table-responsive" style="max-height: 50vh;">
                        <table class="table table-bordered table-sm">
                            <thead id="mapping-table-head"></thead>
                            <tbody id="mapping-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" onclick="cancelUpload()"><i class="fas fa-times me-2"></i>إلغاء الرفع</button>
                    <button type="button" class="btn btn-primary" onclick="confirmMapping()"><i class="fas fa-check me-2"></i>تأكيد التعيين والمتابعة</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // ==================================================================
        // --- الإصدار النهائي الكامل لـ data-ingestion.js (V15) ---
        // --- يدعم: تعيين الأعمدة اليدوي + قراءة أي ميزان مراجعة ---
        // ==================================================================

        let clientSetup = {};
        let validationStates = {};
        let historyModal = null;
        let columnMappingModal = null;
        let tempFileData = { entityId: null, type: null, rawData: null, fileInfo: null };

        document.addEventListener('DOMContentLoaded', () => {
            const activeClientId = localStorage.getItem('activeClientId');
            if (!activeClientId) {
                handleFatalError('<h4>خطأ فادح: لم يتم العثور على عميل نشط.</h4><p>الرجاء العودة لصفحة "تأسيس الكيانات" أولاً.</p>');
                return;
            }
            const setupData = localStorage.getItem(`clientSetup_${activeClientId}`);
            if (!setupData) {
                handleFatalError('<h4>خطأ فادح: لم يتم العثور على بروتوكول التأسيس للعميل النشط.</h4>');
                return;
            }
            
            try {
                clientSetup = JSON.parse(setupData);
            } catch (e) {
                handleFatalError('<h4>خطأ فادح: بيانات بروتوكول التأسيس تالفة.</h4>');
                return;
            }

            historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
            columnMappingModal = new bootstrap.Modal(document.getElementById('columnMappingModal'));
            
            document.getElementById('loader').style.display = 'none';
            document.getElementById('contentArea').style.display = 'block';
            renderUI();
            
            // استعادة الحالة السابقة إذا كانت موجودة
            restorePreviousState();
        });

        // ==================================================================
        // --- دالة معالجة رفع الملف (مع القراءة الخام الكاملة) ---
        // ==================================================================
        function handleFileUpload(input, entityId, type) {
            if (input.files.length === 0) return;
            const file = input.files[0];
            const slot = document.getElementById(`slot_${type === 'current' ? '' : 'prev_'}${entityId}`);
            
            slot.classList.remove('completed', 'failed');
            if (type === 'current') slot.classList.add('loading');

            const reader = new FileReader();
            reader.onload = function(e) {
                const fileInfo = { name: file.name, size: file.size, type: file.type, uploadDate: new Date().toISOString(), user: "Current User" };

                // معالجة ملفات PDF (اختياري)
                if (file.type.includes('pdf')) {
                    fileInfo.status = "Acknowledged";
                    updateAndLog(entityId, type, fileInfo, null);
                    if (type === 'current') slot.classList.remove('loading');
                    return;
                }

                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // **القراءة الخام الكاملة: نقرأ كل شيء كمصفوفة من المصفوفات**
                    const rawData = XLSX.utils.sheet_to_json(worksheet, { 
                        header: 1, 
                        defval: "",
                        blankrows: false,
                        raw: false  // تحويل كل شيء لنص لتجنب مشاكل التنسيق
                    });

                    if (rawData.length < 2) {
                        throw new Error("الملف لا يحتوي على بيانات كافية (أقل من صفين).");
                    }

                    // حفظ البيانات الخام مؤقتاً
                    tempFileData = { entityId, type, rawData, fileInfo };
                    
                    // عرض نافذة تعيين الأعمدة
                    showColumnMappingUI(rawData);

                } catch (error) {
                    console.error("File processing error:", error);
                    fileInfo.status = `Error: ${error.message}`;
                    updateAndLog(entityId, type, fileInfo, null, { isValid: false, message: error.message });
                    if (type === 'current') slot.classList.remove('loading');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // ==================================================================
        // --- دالة عرض واجهة تعيين الأعمدة ---
        // ==================================================================
        function showColumnMappingUI(rawData) {
            // البحث عن أول صف يحتوي على بيانات نصية (العناوين المحتملة)
            const headerRowIndex = rawData.findIndex(row => 
                row.some(cell => typeof cell === 'string' && cell.trim() !== '')
            );
            
            if (headerRowIndex === -1) {
                alert("الملف لا يحتوي على أي بيانات نصية يمكن استخدامها كعناوين.");
                cancelUpload();
                return;
            }
            
            const headers = rawData[headerRowIndex];
            const previewData = rawData.slice(headerRowIndex + 1, headerRowIndex + 11); // أول 10 صفوف للمعاينة

            const tableHead = document.getElementById('mapping-table-head');
            const tableBody = document.getElementById('mapping-table-body');
            
            const requiredFields = [
                { value: 'account_id', label: 'رقم الحساب' },
                { value: 'account_name', label: 'اسم الحساب' },
                { value: 'ob_debit', label: 'أول المدة (مدين)' },
                { value: 'ob_credit', label: 'أول المدة (دائن)' },
                { value: 'move_debit', label: 'الحركة (مدين)' },
                { value: 'move_credit', label: 'الحركة (دائن)' },
                { value: 'cb_debit', label: 'آخر المدة (مدين)' },
                { value: 'cb_credit', label: 'آخر المدة (دائن)' }
            ];

            // بناء صف العناوين مع القوائم المنسدلة
            let headerHtml = '<tr>';
            headerHtml += '<th style="background-color: rgba(0, 191, 255, 0.3); text-align: center;"><i class="fas fa-ban"></i><br><small>تجاهل</small></th>';
            headers.forEach((header, index) => {
                const displayHeader = header || `عمود ${index + 1}`;
                headerHtml += `
                    <th>
                        <div class="mb-1 small text-muted">${displayHeader}</div>
                        <select class="form-select form-select-sm" id="mapping-select-${index}">
                            <option value="">-- تجاهل --</option>
                            ${requiredFields.map(field => 
                                `<option value="${field.value}">${field.label}</option>`
                            ).join('')}
                        </select>
                    </th>
                `;
            });
            headerHtml += '</tr>';
            tableHead.innerHTML = headerHtml;

            // بناء صفوف المعاينة مع خيار تجاهل
            let bodyHtml = '';
            previewData.forEach((row, rowIndex) => {
                const actualRowIndex = headerRowIndex + 1 + rowIndex;
                bodyHtml += '<tr>';
                bodyHtml += `<td style="background-color: rgba(0, 191, 255, 0.15); text-align: center; vertical-align: middle;"><input type="checkbox" class="form-check-input" id="ignore-row-${actualRowIndex}" title="تجاهل هذا الصف"></td>`;
                headers.forEach((_, colIndex) => {
                    const cellValue = row[colIndex] || '';
                    bodyHtml += `<td>${cellValue}</td>`;
                });
                bodyHtml += '</tr>';
            });
            tableBody.innerHTML = bodyHtml;

            // عرض النافذة المنبثقة
            columnMappingModal.show();
        }

        // ==================================================================
        // --- دالة تأكيد التعيين ومعالجة البيانات ---
        // ==================================================================
        function confirmMapping() {
            const mapping = {};
            const headerRowIndex = tempFileData.rawData.findIndex(row => 
                row.some(cell => typeof cell === 'string' && cell.trim() !== '')
            );
            const headers = tempFileData.rawData[headerRowIndex];
            
            let hasAccountId = false;
            let hasAccountName = false;

            // جمع التعيينات من القوائم المنسدلة
            headers.forEach((_, index) => {
                const select = document.getElementById(`mapping-select-${index}`);
                if (select && select.value) {
                    mapping[select.value] = index;
                    if (select.value === 'account_id') hasAccountId = true;
                    if (select.value === 'account_name') hasAccountName = true;
                }
            });

            // التحقق من الحد الأدنى من التعيينات المطلوبة
            if (!hasAccountId || !hasAccountName) {
                alert("يجب تعيين عمود 'رقم الحساب' و 'اسم الحساب' على الأقل.");
                return;
            }

            // جمع الصفوف المتجاهلة
            const ignoredRows = new Set();
            const checkboxes = document.querySelectorAll('[id^="ignore-row-"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const rowIndex = parseInt(checkbox.id.replace('ignore-row-', ''));
                    ignoredRows.add(rowIndex);
                }
            });

            // معالجة البيانات بناءً على التعيين
            processDataWithMapping(mapping, headerRowIndex, ignoredRows);
            
            // إخفاء النافذة
            columnMappingModal.hide();
        }

        // ==================================================================
        // --- دالة معالجة البيانات بناءً على التعيين ---
        // ==================================================================
        function processDataWithMapping(mapping, headerRowIndex, ignoredRows = new Set()) {
            const { entityId, type, rawData, fileInfo } = tempFileData;
            const slot = document.getElementById(`slot_${type === 'current' ? '' : 'prev_'}${entityId}`);
            
            // استخراج صفوف البيانات (بعد صف العناوين)
            const dataRows = rawData.slice(headerRowIndex + 1);
            
            // تحويل البيانات الخام إلى صيغة موحدة بناءً على التعيين
            const standardizedJson = dataRows.map((row, index) => {
                const actualRowIndex = headerRowIndex + 1 + index;
                
                // تجاهل الصفوف المحددة
                if (ignoredRows.has(actualRowIndex)) {
                    return null;
                }
                
                const standardized = {};
                
                for (const key in mapping) {
                    const colIndex = mapping[key];
                    let cellValue = row[colIndex];
                    
                    // معالجة خاصة للأعمدة الرقمية
                    if (key.includes('debit') || key.includes('credit')) {
                        if (typeof cellValue === 'string') {
                            // إزالة الفواصل والمسافات
                            cellValue = cellValue.replace(/,/g, '').replace(/\s/g, '').trim();
                        }
                        standardized[key] = cellValue;
                    } else {
                        standardized[key] = cellValue;
                    }
                }
                
                return standardized;
            }).filter(row => {
                // إزالة الصفوف المتجاهلة (null)
                if (row === null) return false;
                
                // **التنظيف النهائي: تجاهل أي صف لا يحتوي على رقم حساب أو اسم حساب**
                const hasId = row.account_id && String(row.account_id).trim() !== '';
// ✅ السطر الصحيح والمُحسّن
const hasName = (row.account_name || row.name) && String(row.account_name || row.name).trim() !== '';
// ✅ أضف هذا السطر
return hasId && hasName; 
});
           

            console.log(`✅ تم معالجة ${standardizedJson.length} حساب بنجاح من الملف.`);

            // التحقق من صحة وتوازن الميزان (للملفات الحالية فقط)
            if (type === 'current') {
                const validationResult = validateTrialBalance(standardizedJson);
                fileInfo.status = validationResult.isValid ? "Valid & Balanced" : `Accepted with Difference`;
                updateAndLog(entityId, type, fileInfo, standardizedJson, validationResult);
            } else {
                fileInfo.status = "Acknowledged";
                updateAndLog(entityId, type, fileInfo, standardizedJson);
            }
            
            slot.classList.remove('loading');
        }

        // ==================================================================
        // --- دالة إلغاء الرفع ---
        // ==================================================================
        function cancelUpload() {
            const { entityId, type } = tempFileData;
            if (entityId) {
                const slot = document.getElementById(`slot_${type === 'current' ? '' : 'prev_'}${entityId}`);
                if (slot) slot.classList.remove('loading');
            }
            tempFileData = { entityId: null, type: null, rawData: null, fileInfo: null };
            columnMappingModal.hide();
        }

   /**
 * ==================================================================
 * --- دالة التحقق من صحة وتوازن ميزان المراجعة (النسخة المصححة) ---
 * ==================================================================
 */
function validateTrialBalance(accounts) {
    if (!accounts || accounts.length === 0) {
        return { 
            isValid: false, 
            message: "<b>فشل:</b> لم يتم العثور على أي صفوف بيانات صالحة بعد التعيين.",
            summaryHTML: '<div class="alert alert-danger p-2 small"><i class="fas fa-times-circle"></i> لم يتم العثور على بيانات صالحة.</div>'
        };
    }
    
    let totalDebit = 0;
    let totalCredit = 0;

    accounts.forEach(acc => {
        // ✅ المعادلة الصحيحة: حساب الرصيد النهائي لكل حساب
        const openingBalance = (parseFloat(acc.ob_debit) || 0) - (parseFloat(acc.ob_credit) || 0);
        const movement = (parseFloat(acc.move_debit) || 0) - (parseFloat(acc.move_credit) || 0);
        const finalBalance = openingBalance + movement;

        // ✅ المنطق الصحيح: إضافة الرصيد إلى الجانب الصحيح
        if (finalBalance > 0) {
            totalDebit += finalBalance;
        } else {
            totalCredit += Math.abs(finalBalance);
        }
    });

    // ✅ المعادلة الصحيحة لحساب الفارق
    const difference = totalDebit - totalCredit;
    const isBalanced = Math.abs(difference) < 0.01; // استخدام هامش خطأ بسيط للكسور
    
    let summaryHTML;
    if (isBalanced) {
        summaryHTML = `
            <div class="alert alert-success p-2 small">
                <h6 class="alert-heading"><i class="fas fa-check-circle"></i> قبول</h6>
                <ul class="list-unstyled mb-0 mt-2">
                    <li><strong>الحالة:</strong> <span class="fw-bold text-success">متزن ✓</span></li>
                    <li><strong>إجمالي الحسابات:</strong> ${accounts.length}</li>
                    <li><strong>الإجمالي:</strong> ${totalDebit.toLocaleString('ar-SA', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</li>
                </ul>
            </div>
        `;
    } else {
        summaryHTML = `
            <div class="alert alert-warning p-2 small">
                <h6 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> قبول مع فارق</h6>
                <ul class="list-unstyled mb-0 mt-2">
                    <li><strong>الحالة:</strong> <span class="fw-bold text-warning">غير متزن</span></li>
                    <li><strong>الفارق:</strong> <span class="text-danger">${difference.toLocaleString('ar-SA', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span></li>
                    <li><strong>إجمالي الحسابات:</strong> ${accounts.length}</li>
                </ul>
                <hr class="my-2">
                <p class="mb-0 small"><i class="fas fa-info-circle me-1"></i>سيتم إنشاء حساب تسوية تلقائياً لمعالجة هذا الفارق.</p>
            </div>
        `;
    }
    
    return { 
        isValid: true, 
        summaryHTML, 
        leafAccounts: accounts, 
        difference 
    };
}


        // ==================================================================
        // --- دالة تحديث السجل والحالة ---
        // ==================================================================
        function updateAndLog(entityId, type, fileData, jsonData, validationResult) {
            const activeClientId = localStorage.getItem('activeClientId');
            
            // حفظ في سجل الرفع
            const storageKey = `uploadHistory_${activeClientId}_${entityId}_${type}`;
            const history = JSON.parse(localStorage.getItem(storageKey) || '[]');
            history.unshift(fileData); 
            localStorage.setItem(storageKey, JSON.stringify(history));

          // ✅✅✅ الصق هذا الكود الجديد مكانه ✅✅✅
// حفظ البيانات المعالجة
if (jsonData) {
    const dataKey = `data_${activeClientId}_${entityId}_${type}`;
    const dataToSave = validationResult?.leafAccounts || jsonData;
    if (dataToSave && dataToSave.length > 0) {
        localStorage.setItem(dataKey, JSON.stringify(dataToSave));
        console.log(`تم حفظ ${dataToSave.length} حسابًا في localStorage تحت المفتاح: ${dataKey}`);
    } else {
        console.error(`فشل الحفظ: لا توجد بيانات لحفظها للمفتاح: ${dataKey}`);
    }
}


            // تحديث واجهة المستخدم
            const fileNameEl = document.getElementById(`fileName_${type === 'current' ? '' : 'prev_'}${entityId}`);
            if (fileNameEl) {
                fileNameEl.innerHTML = `<span class="text-info">${fileData.name}</span>`;
            }

            // تحديث حالة التحقق (للملفات الحالية فقط)
            if (type === 'current') {
                const slot = document.getElementById(`slot_${entityId}`);
                const summaryEl = document.getElementById(`summary_${entityId}`);
                
                if (validationResult && validationResult.isValid) {
                    validationStates[entityId] = true;
                    const isBalanced = Math.abs(validationResult.difference || 0) <= 0.01;
                    slot.classList.add(isBalanced ? 'completed' : 'failed');
                    summaryEl.innerHTML = validationResult.summaryHTML;
                } else {
                    validationStates[entityId] = false;
                    slot.classList.add('failed');
                    summaryEl.innerHTML = validationResult?.summaryHTML || '<div class="alert alert-danger p-2 small">فشل التحقق</div>';
                }
                
                checkCompletion();
            }
        }

        // ==================================================================
        // --- دالة التحقق من اكتمال الرفع ---
        // ==================================================================
        function checkCompletion() {
            let allValid = false;
            
            if (clientSetup.path === 'single') {
                const entityId = clientSetup.details.cr.replace(/\s/g, '_');
                allValid = validationStates[entityId] === true;
            } else {
                const requiredIds = clientSetup.details.subsidiaries.map(sub => sub.cr.replace(/\s/g, '_'));
                allValid = requiredIds.length > 0 && requiredIds.every(id => validationStates[id] === true);
            }
            
            document.getElementById('nextStepBtn').disabled = !allValid;
        }

        // ==================================================================
        // --- دالة المعالجة النهائية والانتقال للصفحة التالية ---
        // ==================================================================
        function processAndProceed() {
            const activeClientId = localStorage.getItem('activeClientId');
            const fullClientInfo = clientSetup.details;

            let allAccounts = [];
            const entities = clientSetup.path === 'single' 
                ? [{ cr: fullClientInfo.cr.replace(/\s/g, '_') }] 
                : fullClientInfo.subsidiaries.map(sub => ({ cr: sub.cr.replace(/\s/g, '_') }));

            // جمع كل الحسابات من جميع الكيانات
            for (const entity of entities) {
                const dataKey = `data_${activeClientId}_${entity.cr}_current`;
                const storedData = localStorage.getItem(dataKey);
                if (!storedData) {
                    alert(`خطأ: لم يتم العثور على بيانات الميزان للكيان ${entity.cr}.`);
                    return;
                }
                allAccounts.push(...JSON.parse(storedData));
            }
            
            // حساب الفارق الإجمالي
            let totalDifference = 0;
            allAccounts.forEach(acc => {
                const ob = (parseFloat(acc.ob_debit) || 0) - (parseFloat(acc.ob_credit) || 0);
                const mv = (parseFloat(acc.move_debit) || 0) - (parseFloat(acc.move_credit) || 0);
                totalDifference += (ob + mv);
            });
            totalDifference = -totalDifference;

            // تحويل إلى صيغة ميزان المراجعة النهائية
            let finalTrialBalance = allAccounts.map(acc => ({
                account_id: acc.account_id,
                name: acc.account_name,
                ob_debit: parseFloat(acc.ob_debit) || 0,
                ob_credit: parseFloat(acc.ob_credit) || 0,
                move_debit: parseFloat(acc.move_debit) || 0,
                move_credit: parseFloat(acc.move_credit) || 0,
            }));

            // إضافة حساب تسوية الفروقات إذا لزم الأمر
            if (Math.abs(totalDifference) > 0.01) {
                finalTrialBalance.push({
                    account_id: "SUSP-001",
                    name: "حساب تسوية الفروقات المعلقة",
                    ob_debit: 0,
                    ob_credit: 0,
                    move_debit: totalDifference > 0 ? totalDifference : 0,
                    move_credit: totalDifference < 0 ? -totalDifference : 0,
                });
                alert(`تم اكتشاف فارق بقيمة ${totalDifference.toFixed(2)}. سيتم إنشاء "حساب تسوية الفروقات المعلقة" لمعالجة هذا الفارق.`);
            }

            // إنشاء ملف المراجعة النهائي
            const auditFile = {
                clientInfo: fullClientInfo,
                settings: { currency: 'SAR' },
                trialBalance: finalTrialBalance,
                adjustments: [],
                auditLog: [{
                    timestamp: new Date().toISOString(),
                    action: "تم إنشاء ملف المراجعة الأولي من مرحلة استيعاب البيانات."
                }]
            };

            // حفظ ملف المراجعة
            try {
                const auditFileKey = `polarisAuditFile_${activeClientId}`;
                localStorage.setItem(auditFileKey, JSON.stringify(auditFile));
                console.log("✅ Initial audit file created for mapping:", auditFile);
            } catch (e) {
                console.error("Failed to save the initial audit file:", e);
                alert("حدث خطأ أثناء حفظ ملف المراجعة. قد تكون مساحة التخزين ممتلئة.");
                return;
            }

            // تحديث حالة المشروع
            const newStatus = { 
                step: 2, 
                text: "جاهز لربط الحسابات", 
                icon: "fa-link", 
                color: "text-primary" 
            };
            localStorage.setItem(`projectStatus_${activeClientId}`, JSON.stringify(newStatus));
            
            alert("تم اعتماد البيانات بنجاح. سيتم نقلك الآن لربط وتصنيف الحسابات.");
            
            // الانتقال إلى صفحة ربط الحسابات
            window.location.href = 'account-mapping.html'; 
        }

        // ==================================================================
        // --- دالة تحميل نموذج Excel ---
        // ==================================================================
        function downloadTemplate() {
            const entityName = clientSetup.path === 'single' 
                ? clientSetup.details.companyName 
                : clientSetup.details.groupName;
            const fileName = `Template_TB_${entityName.replace(/\s/g, '_')}.xlsx`;
            
            const headers = [
                "رقم الحساب",
                "اسم الحساب",
                "رصيد أول المدة مدين",
                "رصيد أول المدة دائن",
                "الحركة مدين",
                "الحركة دائن",
                "رصيد آخر المدة مدين",
                "رصيد آخر المدة دائن"
            ];
            
            const ws = XLSX.utils.aoa_to_sheet([headers]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ميزان المراجعة");
            XLSX.writeFile(wb, fileName);
        }

        // ==================================================================
        // --- دالة عرض سجل الرفع ---
        // ==================================================================
        function showHistory(entityId, type) {
            const activeClientId = localStorage.getItem('activeClientId');
            const storageKey = `uploadHistory_${activeClientId}_${entityId}_${type}`;
            const history = JSON.parse(localStorage.getItem(storageKey) || '[]');

            const modalTitle = document.getElementById('historyModalTitle');
            const modalBody = document.getElementById('historyModalBody');

            modalTitle.textContent = `سجل الرفع: ${type === 'current' ? 'الفترة الحالية' : 'الفترة السابقة'}`;

            if (history.length === 0) {
                modalBody.innerHTML = '<p class="text-muted">لا يوجد سجل رفع حتى الآن.</p>';
            } else {
                let html = '<div class="history-log">';
                history.forEach((entry, index) => {
                    const date = new Date(entry.uploadDate).toLocaleString('ar-SA');
                    html += `
                        <div class="history-log-item p-2">
                            <div class="d-flex justify-content-between">
                                <span><i class="fas fa-file-alt me-2"></i>${entry.name}</span>
                                <span class="text-muted small">${date}</span>
                            </div>
                            <div class="small text-muted mt-1">
                                الحجم: ${(entry.size / 1024).toFixed(2)} KB | 
                                الحالة: ${entry.status || 'N/A'}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                modalBody.innerHTML = html;
            }

            historyModal.show();
        }

        // ==================================================================
        // --- دالة معالجة الأخطاء الفادحة ---
        // ==================================================================
        function handleFatalError(message) {
            const mainContent = document.querySelector('.main-content');
            mainContent.innerHTML = `
                <div class="alert alert-danger">
                    ${message}
                    <a href="company-setup.html" class="btn btn-primary mt-3">العودة لصفحة التأسيس</a>
                </div>
            `;
        }
// ==================================================================
// --- دالة تغيير الملف ---
// ==================================================================
function changeFile(entityId, type) {
    const confirmed = confirm("هل أنت متأكد من رغبتك في استبدال الملف الحالي؟ \n\nسيتم حذف البيانات الحالية واستبدالها بملف جديد.");
    
    if (!confirmed) return;
    
    // إعادة تعيين الحالة
    const slotId = type === 'current' ? `slot_${entityId}` : `slot_prev_${entityId}`;
    const fileNameId = type === 'current' ? `fileName_${entityId}` : `fileName_prev_${entityId}`;
    const summaryId = type === 'current' ? `summary_${entityId}` : null;
    
    const slot = document.getElementById(slotId);
    const fileNameEl = document.getElementById(fileNameId);
    const summaryEl = summaryId ? document.getElementById(summaryId) : null;
    
    // إعادة تعيين الواجهة
    if (slot) {
        slot.classList.remove('completed', 'failed');
    }
    if (fileNameEl) {
        fileNameEl.innerHTML = '';
    }
    if (summaryEl) {
        summaryEl.innerHTML = '<p class="text-muted small">بانتظار رفع الملف للتحقق...</p>';
    }
    
    // إخفاء زر "تغيير الملف"
    const changeBtn = document.getElementById(`changeFileBtn_${entityId}`);
    if (changeBtn) changeBtn.style.display = 'none';
    
    // حذف البيانات من localStorage
    const activeClientId = localStorage.getItem('activeClientId');
    const dataKey = `data_${activeClientId}_${entityId}_${type}`;
    localStorage.removeItem(dataKey);
    
    // إعادة تعيين حالة التحقق
    if (type === 'current') {
        validationStates[entityId] = false;
        checkCompletion();
    }
    
    // فتح نافذة اختيار ملف جديد
    const fileInput = slot.querySelector('input[type="file"]');
    if (fileInput) {
        fileInput.value = ''; // إعادة تعيين القيمة
        fileInput.click();
    }
}

        // ==================================================================
        // --- دالة استعادة الحالة السابقة ---
        // ==================================================================
        function restorePreviousState() {
            const activeClientId = localStorage.getItem('activeClientId');
            
            // تحديد الكيانات المطلوب فحصها
            const entities = clientSetup.path === 'single' 
                ? [{ cr: clientSetup.details.cr.replace(/\s/g, '_') }] 
                : clientSetup.details.subsidiaries.map(sub => ({ cr: sub.cr.replace(/\s/g, '_') }));

            entities.forEach(entity => {
                const entityId = entity.cr;
                
                // فحص إذا كان هناك بيانات محفوظة للفترة الحالية
                const dataKey = `data_${activeClientId}_${entityId}_current`;
                const storedData = localStorage.getItem(dataKey);
                
                if (storedData) {
                    // استعادة البيانات
                    const accounts = JSON.parse(storedData);
                    
                    // استعادة معلومات الملف من السجل
                    const historyKey = `uploadHistory_${activeClientId}_${entityId}_current`;
                    const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
                    const lastFile = history[0]; // آخر ملف تم رفعه
                    
                    if (lastFile) {
                        // تحديث واجهة المستخدم لإظهار الملف المحفوظ
                        const slot = document.getElementById(`slot_${entityId}`);
                        const fileNameEl = document.getElementById(`fileName_${entityId}`);
                        const summaryEl = document.getElementById(`summary_${entityId}`);
                        
                        if (slot && fileNameEl && summaryEl) {
                            // عرض اسم الملف
                            fileNameEl.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-1"></i>${lastFile.name}</span>`;
                            
                            // حساب التوازن
                            const validationResult = validateTrialBalance(accounts);
                            const isBalanced = Math.abs(validationResult.difference || 0) <= 0.01;
                            
                            // تحديث حالة الفحص
                            slot.classList.add(isBalanced ? 'completed' : 'failed');
                            summaryEl.innerHTML = validationResult.summaryHTML;
                            
                            // تحديث حالة التحقق
                            validationStates[entityId] = true;
                            
                            // إظهار زر "تغيير الملف"
                            const changeBtn = document.getElementById(`changeFileBtn_${entityId}`);
                            if (changeBtn) changeBtn.style.display = 'inline-block';
                        }
                    }
                }
            });
            
            // فحص اكتمال الرفع
            checkCompletion();
        }

        // ==================================================================
        // --- دالة رسم واجهة المستخدم ---
        // ==================================================================
        function renderUI() {
            const container = document.getElementById('contentArea');
            const pageTitle = document.getElementById('pageTitle');
            let html = '';

            if (clientSetup.path === 'single') {
// ✅✅✅ السطر الصحيح والمرن ✅✅✅
const entityName = clientSetup.details.companyName || clientSetup.details.name;
                const entityId = clientSetup.details.cr.replace(/\s/g, '_');
                pageTitle.innerHTML = `استيعاب بيانات: <span class="text-primary">${entityName}</span>`;
                html = createUploadSectionHTML(entityId, 'ميزان المراجعة الرئيسي');
            } else {
                const groupName = clientSetup.details.groupName;
                pageTitle.innerHTML = `استيعاب بيانات مجموعة: <span class="text-primary">${groupName}</span>`;
                if (clientSetup.details.subsidiaries && clientSetup.details.subsidiaries.length > 0) {
                    html = clientSetup.details.subsidiaries.map(sub => {
                        const entityId = sub.cr.replace(/\s/g, '_'); 
                        return `<div class="mb-5">${createUploadSectionHTML(entityId, `الكيان التابع: ${sub.name}`)}</div>`;
                    }).join('<hr class="my-5">');
                } else {
                    html = '<div class="alert alert-warning">لم يتم العثور على كيانات تابعة في هذا المشروع.</div>';
                }
            }
            container.innerHTML = html;
        }

        // ==================================================================
        // --- دالة إنشاء قسم الرفع ---
        // ==================================================================
        function createUploadSectionHTML(entityId, entityName) {
            return `
                <h5 class="font-family-display mb-3">${entityName}</h5>
                <div class="row g-4 align-items-start">
                    <div class="col-md-8">
                        <h6>1. رفع ميزان المراجعة للفترة الحالية</h6>
                        <div id="slot_${entityId}" class="upload-slot" onclick="this.querySelector('input').click()">
                            <div class="upload-content">
                                <i class="fas fa-file-invoice-dollar fa-3x mb-3 text-secondary"></i>
                                <p>اسحب وأفلت ملف Excel هنا، أو انقر للرفع</p>
                                <p id="fileName_${entityId}" class="fw-bold mt-2"></p>
                            </div>
                            <div class="upload-loader">
                                <div class="spinner-border text-primary"></div>
                                <p class="mt-2">جاري الفحص والتوثيق...</p>
                            </div>
                            <input type="file" class="d-none" accept=".xlsx, .xls, .csv" onchange="handleFileUpload(this, '${entityId}', 'current')">
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <button id="changeFileBtn_${entityId}" class="btn btn-sm btn-outline-warning" style="display: none;" onclick="event.stopPropagation(); changeFile('${entityId}', 'current');">
                                <i class="fas fa-sync-alt me-1"></i>تغيير الملف
                            </button>
                            <a href="#" class="small" onclick="event.preventDefault(); showHistory('${entityId}', 'current');">عرض سجل الرفع</a>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>&nbsp;</h6>
                        <div id="summary_${entityId}" class="validation-summary">
                            <p class="text-muted small">بانتظار رفع الملف للتحقق...</p>
                        </div>
                    </div>
                </div>
                <div class="row g-4 mt-3">
                    <div class="col-md-8">
                        <h6>2. مطابقة أرصدة أول المدة (اختياري)</h6>
                        <div id="slot_prev_${entityId}" class="upload-slot" onclick="this.querySelector('input').click()">
                            <div class="upload-content">
                                <i class="fas fa-history fa-3x mb-3 text-secondary"></i>
                                <p>ارفع هنا (ميزان العام السابق أو القوائم المالية PDF)</p>
                                <p id="fileName_prev_${entityId}" class="fw-bold mt-2"></p>
                            </div>
                            <input type="file" class="d-none" accept=".xlsx, .xls, .csv, .pdf" onchange="handleFileUpload(this, '${entityId}', 'previous')">
                        </div>
                        <div class="text-end mt-2">
                            <a href="#" class="small" onclick="event.preventDefault(); showHistory('${entityId}', 'previous');">عرض سجل الرفع</a>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
