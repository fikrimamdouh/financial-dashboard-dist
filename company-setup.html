<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بروتوكول التأسيس | Polaris</title>
    
    <!-- Bootstrap RTL + FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Polaris Theme (Assuming you have this file ) -->
    <link rel="stylesheet" href="css/polaris-theme.css">

    <!-- CryptoJS + Polaris Data Pipeline -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="dataPipeline.js"></script>

    <style>
        .client-card {
            background-color: rgba(255, 255, 255, 0.05 );
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 1.25rem;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
        }
        .client-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border-color: rgba(0, 123, 255, 0.5);
        }
        .project-status { 
            font-size: 0.9rem; 
            font-weight: 500;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 1rem;
            padding-top: 1rem;
        }
        .financial-period {
            font-size: 0.85rem;
            font-family: monospace;
            background-color: rgba(0, 123, 255, 0.1);
            color: #89c4ff;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            display: inline-block;
        }
        .client-actions {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 1rem;
            margin-top: 1rem;
        }
        .subsidiary-list-item { background-color: rgba(0,0,0,0.2); padding: 0.5rem 1rem; border-radius: 0.3rem; }

        /* Progress Bar */
        .progress-container { 
            position: fixed; top: 0; left: 0; right: 0; height: 4px; z-index: 9999; 
            background-color: rgba(0,0,0,0.3); 
        }
        #polarisProgressBar { 
            height: 100%; 
            background: linear-gradient(90deg, #00BFFF, #00D4AA); 
            width: 0%; 
            transition: width 0.5s ease; 
        }


/* ================================================================ */
/* --- START: إصلاح وضوح خط الطوابع الزمنية (V1) --- */
/* ================================================================ */

.client-card .timestamp-info {
    font-size: 0.8rem; /* تصغير الخط قليلاً ليتناسب مع التصميم */
    color: var(--color-text-secondary) !important; /* **الإصلاح الجوهري**: استخدام لون ثانوي واضح */
    opacity: 0.85; /* زيادة الوضوح قليلاً */
}

.client-card .timestamp-info i {
    width: 20px; /* محاذاة الأيقونات بشكل أفضل */
}

/* ================================================================ */
/* --- END: إصلاح وضوح الخط --- */
/* ================================================================ */
/* ================================================================ */
/* --- START: إصلاح وضوح مؤشرات الأداء على البطاقة --- */
/* ================================================================ */

.client-card .kpi-item span {
    color: var(--color-text-secondary) !important; /* استخدام لون ثانوي واضح */
    opacity: 0.9;
}

.client-card .kpi-item strong {
    font-size: 1.1rem; /* تكبير حجم الرقم قليلاً */
}

/* ================================================================ */
/* --- END: إصلاح وضوح المؤشرات --- */
/* ================================================================ */

    </style>
</head>

<!-- This page is the first step in the sequence -->
<body data-step="client-info">

    <!-- Progress Bar -->
    <div class="progress-container">
        <div id="polarisProgressBar"></div>
    </div>

    <div class="grid-background"></div>
    <div class="glow-background"></div>

    <nav class="sidebar">
        <a href="index.html" class="app-logo" title="العودة لمركز القيادة"><i class="fas fa-atom"></i></a>
    </nav>

    <main class="main-content">
        <div class="page-header d-flex justify-content-between align-items-center">
            <h1 class="page-title">بروتوكول التأسيس</h1>
            <div class="d-flex gap-2">
                <button id="backBtn" class="btn btn-secondary" onclick="goBackToSelection()" style="display: none;">
                    <i class="fas fa-redo-alt me-2"></i>الرجوع للاختيار
                </button>
                <button id="saveAndProceedBtn" class="btn btn-primary" onclick="saveAndProceed()" style="display: none;">
                    <i class="fas fa-arrow-left me-2"></i>حفظ والمتابعة
                </button>
            </div>
        </div>

        <div class="control-pane">
    <!-- ================================================================ -->
<!-- START: واجهة اختيار المسار مع خيار الاستعادة (V2) -->
<!-- ================================================================ -->
<div id="pathSelection">
    <h5 class="font-family-display text-center mb-4">اختر مسار العمل</h5>
    <div class="d-flex justify-content-center gap-4">
        <!-- المسار الأول: تأسيس جديد -->
        <button class="btn btn-outline-secondary p-4" onclick="selectPath('single')">
            <i class="fas fa-user-tie fa-2x mb-2"></i>  
تأسيس كيان فردي
        </button>
        <button class="btn btn-outline-secondary p-4" onclick="selectPath('group')">
            <i class="fas fa-sitemap fa-2x mb-2"></i>  
تأسيس مجموعة
        </button>
        
        <!-- فاصل بصري -->
        <div class="vr"></div>

        <!-- المسار الثاني: استعادة من نسخة احتياطية -->
       <!-- الكود المحدث -->
<button class="btn btn-outline-info p-4" onclick="triggerImport()">
    <i class="fas fa-file-import fa-2x mb-2"></i>  
استيراد مشروع
</button>

    </div>
</div>

<!-- حقل رفع الملفات المخفي (ضروري لعملية الاستعادة) -->
<input type="file" id="restoreInput" class="d-none" accept=".json" onchange="handleImport(event)">
<!-- ================================================================ -->
<!-- END: واجهة اختيار المسار المحدثة -->
<!-- ================================================================ -->


            <div id="formContainer" style="display: none;">
                <!-- Form for Single Entity -->
                <form id="singleEntityForm" style="display: none;" onsubmit="event.preventDefault();">
                    <div class="row g-4">
                        <div class="col-12"><h5 class="font-family-display">1. المعلومات الأساسية للكيان</h5>
                            <div class="row g-3">
                                <div class="col-md-6"><label class="form-label">الاسم القانوني <span class="text-danger">*</span></label><input type="text" class="form-control" id="single_companyName" required></div>
                                <div class="col-md-6"><label class="form-label">رقم السجل التجاري (CRN) <span class="text-danger">*</span></label><input type="text" class="form-control" id="single_cr" required></div>
                            </div>
                        </div>
                        <div class="col-12"><h5 class="font-family-display">2. تعريف الفترة المالية والتقارير</h5>
                            <div class="row g-3">
                                <div class="col-md-3"><label class="form-label">تاريخ بدء الفترة <span class="text-danger">*</span></label><input type="date" class="form-control" id="single_startDate" required></div>
                                <div class="col-md-3"><label class="form-label">تاريخ انتهاء الفترة <span class="text-danger">*</span></label><input type="date" class="form-control" id="single_endDate" required></div>
                                <div class="col-md-6"><label class="form-label">إطار إعداد التقارير</label><select class="form-select" id="single_framework"><option selected>المعايير الدولية (IFRS)</option><option>معايير المنشآت الصغيرة (IFRS for SMEs)</option></select></div>
                            </div>
                        </div>
                    </div>
                </form>
                
                <!-- Form for Group of Entities -->
                <form id="groupEntityForm" style="display: none;" onsubmit="event.preventDefault();">
                     <div class="row g-4">
                        <div class="col-12"><h5 class="font-family-display">1. المعلومات الأساسية للمجموعة</h5>
                            <div class="row g-3">
                                <div class="col-md-6"><label class="form-label">اسم المجموعة (الشركة القابضة) <span class="text-danger">*</span></label><input type="text" class="form-control" id="group_name" required></div>
                                <div class="col-md-3"><label class="form-label">تاريخ بدء الفترة <span class="text-danger">*</span></label><input type="date" class="form-control" id="group_startDate" required></div>
                                <div class="col-md-3"><label class="form-label">تاريخ انتهاء الفترة <span class="text-danger">*</span></label><input type="date" class="form-control" id="group_endDate" required></div>
                            </div>
                        </div>
                        <hr>
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="font-family-display mb-0">2. الكيانات التابعة للمجموعة</h5>
                                <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addSubsidiaryModal"><i class="fas fa-plus me-2"></i>إضافة كيان تابع</button>
                            </div>
                            <div id="subsidiariesList" class="d-flex flex-column gap-2">
                                <p id="noSubsidiariesMessage" class="text-muted">لم يتم إضافة أي كيانات تابعة بعد.</p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <hr class="my-5">

        <div id="establishedClientsSection">
            <h5 class="font-family-display mb-3"><i class="fas fa-tasks me-2"></i>سجل المشاريع المفتوحة (الهيستوري)</h5>
            <div id="clientsList" class="row g-4">
                 <p id="noClientsMessage" class="text-muted col-12">لا يوجد مشاريع مؤسسة حاليًا.</p>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div class="modal fade" id="addSubsidiaryModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary"><h5 class="modal-title">إضافة كيان تابع جديد</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="addSubsidiaryForm" onsubmit="event.preventDefault(); addSubsidiary();">
                        <div class="mb-3"><label class="form-label">الاسم القانوني للكيان التابع <span class="text-danger">*</span></label><input type="text" id="sub_name" class="form-control" required></div>
                        <div class="mb-3"><label class="form-label">رقم السجل التجاري (CRN) <span class="text-danger">*</span></label><input type="text" id="sub_cr" class="form-control" required></div>
                        <div class="mb-3"><label class="form-label">نسبة الملكية (%)</label><input type="number" id="sub_ownership" class="form-control" min="0" max="100" placeholder="مثال: 75"></div>
                    </form>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" form="addSubsidiaryForm" class="btn btn-primary">إضافة وحفظ</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary"><h5 class="modal-title"><i class="fas fa-exclamation-triangle text-danger me-2"></i> تأكيد عملية الحذف</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <p>أنت على وشك حذف: <strong id="clientNameToDelete"></strong>.</p>
                    <p id="periodToDeleteContainer" style="display: none;">الفترة: <span id="periodToDelete" class="text-warning"></span></p>
                    <p>للتأكيد، يرجى كتابة المعرف الفريد "<span id="clientIdToConfirm" class="text-warning font-monospace"></span>" في الحقل أدناه:</p>
                    <input type="text" class="form-control" id="deleteConfirmationInput" placeholder="اكتب المعرف هنا للتأكيد">
                    <div id="deleteError" class="text-danger mt-2" style="display: none;">المعرف الذي أدخلته غير مطابق.</div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">حذف نهائي</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentPath = '';
        let subsidiariesInGroup = [];
        let addSubsidiaryModal = null;
        let deleteConfirmModal = null;

        // ================================================================
        // START: الكود المُصحح والمُعدل
        // ================================================================

        /**
         * دالة مساعدة لإنشاء معرّف فريد للعميل أو المجموعة.
         * @param {string} identifier - اسم الشركة أو المجموعة.
         * @param {string} startDate - تاريخ بدء الفترة.
         * @param {string} path - 'single' أو 'group'.
         * @returns {string|null} - المعرّف الفريد أو null في حالة الخطأ.
         */
        function generateUniqueId(identifier, startDate, path ) {
            if (!identifier || !startDate || !path) return null;
            const prefix = path === 'group' ? 'GROUP' : 'SINGLE';
            // تنظيف الاسم وأخذ أول 15 حرفًا فقط
// السطر الصحيح
const cleanIdentifier = identifier.replace(/[^a-zA-Z0-9\u0600-\u06FF]/g, '_').substring(0, 15);
            const cleanDate = startDate.replace(/-/g, '');
            // إضافة جزء عشوائي لضمان عدم التكرار نهائيًا
            const randomSuffix = Math.random().toString(36).substring(2, 8);
            return `${prefix}_${cleanIdentifier}_${cleanDate}_${randomSuffix}`;
        }

        /**
         * الدالة الرئيسية للحفظ والانتقال بعد تصحيح الخطأ المنطقي.
         */
// في ملف company-setup.html داخل وسم <script>

// في ملف company-setup.html داخل وسم <script>

function saveAndProceed() {
    const form = document.getElementById(currentPath === 'single' ? 'singleEntityForm' : 'groupEntityForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    let clientInfo, newUniqueId;

    if (currentPath === 'single') {
        clientInfo = {
            type: 'single',
            name: document.getElementById('single_companyName').value.trim(),
            cr: document.getElementById('single_cr').value.trim(),
            startDate: document.getElementById('single_startDate').value,
            endDate: document.getElementById('single_endDate').value,
            framework: document.getElementById('single_framework').value
        };
        newUniqueId = generateUniqueId(clientInfo.name, clientInfo.startDate, 'single');
    } else { // 'group'
        if (subsidiariesInGroup.length === 0) {
            alert('يجب إضافة كيان تابع واحد على الأقل للمجموعة.');
            return;
        }
        clientInfo = {
            type: 'group',
            name: document.getElementById('group_name').value.trim(),
            startDate: document.getElementById('group_startDate').value,
            endDate: document.getElementById('group_endDate').value,
            subsidiaries: subsidiariesInGroup
        };
        newUniqueId = generateUniqueId(clientInfo.name, clientInfo.startDate, 'group');
    }

    clientInfo.id = newUniqueId;
    clientInfo.createdAt = new Date().toISOString();
    clientInfo.updatedAt = new Date().toISOString();

    // ================== الإصلاح النهائي هنا ==================
    
    // 1. الحفظ المشفر والمنظم عبر نظام تدفق البيانات (للتحقق من الخطوات)
    PolarisDataFlow.save('client-info', clientInfo);
    
    // 2. **(الإضافة الحاسمة)** الحفظ الخام لبيانات التأسيس لضمان التوافق مع الصفحات الأخرى
    const setupDataToSave = { 
        path: currentPath, 
        details: clientInfo 
    };
    localStorage.setItem(`clientSetup_${newUniqueId}`, JSON.stringify(setupDataToSave));

    // 3. تعيين العميل النشط للانتقال بين الصفحات
    localStorage.setItem('activeClientId', newUniqueId);
    console.log("تم تأسيس العميل بنجاح. المعرف النشط هو:", newUniqueId);
    
    // ==========================================================

    // الانتقال إلى صفحة استيعاب البيانات
    window.location.href = 'data-ingestion.html';
}

        // ================================================================
        // END: الكود المُصحح والمُعدل
        // ================================================================


        // --- باقي الدوال تبقى كما هي بدون تغيير ---

        function openWorkspace(uniqueId) {
            // هذا الجزء يضمن التوافق مع المشاريع القديمة
            if (!localStorage.getItem(`clientSetup_${uniqueId}`)) {
                alert('خطأ: بيانات المشروع غير موجودة أو تالفة. قد يكون تم حذفه.');
                loadEstablishedClients(); // إعادة تحميل القائمة لإزالة المشروع المفقود
                return;
            }

            // تحميل بيانات المشروع في نظام التدفق قبل الانتقال
            const savedData = JSON.parse(localStorage.getItem(`clientSetup_${uniqueId}`));
            PolarisDataFlow.save('client-info', savedData.details || savedData);

            // تعيين العميل النشط والانتقال
            localStorage.setItem('activeClientId', uniqueId);
            window.location.href = `account-mapping.html?clientId=${uniqueId}`;
        }

        function addSubsidiary() {
            const name = document.getElementById('sub_name').value.trim();
            const cr = document.getElementById('sub_cr').value.trim();
            const ownership = document.getElementById('sub_ownership').value;

            if (!name || !cr) { alert('اسم الكيان التابع ورقم سجله التجاري حقول إلزامية.'); return; }
            if (subsidiariesInGroup.some(sub => sub.cr === cr)) { alert('هذا السجل التجاري تم إضافته بالفعل.'); return; }

            subsidiariesInGroup.push({ name, cr, ownership });
            renderSubsidiariesList();
            if (addSubsidiaryModal) addSubsidiaryModal.hide();
            document.getElementById('addSubsidiaryForm').reset();
        }

        function renderSubsidiariesList() {
            const listElement = document.getElementById('subsidiariesList');
            const messageElement = document.getElementById('noSubsidiariesMessage');
            if (!listElement || !messageElement) return;
            listElement.innerHTML = '';

            if (subsidiariesInGroup.length === 0) {
                listElement.appendChild(messageElement);
                messageElement.style.display = 'block';
            } else {
                messageElement.style.display = 'none';
                subsidiariesInGroup.forEach((sub, index) => {
                    const item = document.createElement('div');
                    item.className = 'subsidiary-list-item d-flex justify-content-between align-items-center';
                    item.innerHTML = `<div><i class="fas fa-building me-2"></i><strong>${sub.name}</strong> (CR: ${sub.cr})</div><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSubsidiary(${index})"><i class="fas fa-times"></i></button>`;
                    listElement.appendChild(item);
                });
            }
        }

        function removeSubsidiary(index) {
            if (confirm(`هل أنت متأكد من حذف الكيان التابع "${subsidiariesInGroup[index].name}"؟`)) {
                subsidiariesInGroup.splice(index, 1);
                renderSubsidiariesList();
            }
        }

        function selectPath(path) {
            currentPath = path;
            subsidiariesInGroup = [];
            document.getElementById('pathSelection').style.display = 'none';
            document.getElementById('formContainer').style.display = 'block';
            document.getElementById('saveAndProceedBtn').style.display = 'block';
            document.getElementById('backBtn').style.display = 'block';
            document.getElementById('singleEntityForm').style.display = (path === 'single') ? 'block' : 'none';
            document.getElementById('groupEntityForm').style.display = (path === 'group') ? 'block' : 'none';
            if (path === 'group') { renderSubsidiariesList(); }
        }

     // ==================================================================
// --- دالة الرجوع الذكية (V2) - مع تأكيد عند الاستيراد ---
// ==================================================================
function goBackToSelection() {
    // **المنطق الجديد**: التحقق إذا كنا في وضع الاستيراد
    if (document.body.dataset.importMode === 'true') {
        // إذا كان المستخدم قد استورد ملفاً، قم بتحذيره قبل الإلغاء
        if (!confirm("لقد قمت باستيراد بيانات مشروع. هل أنت متأكد من رغبتك في إلغاء هذه العملية؟ ستفقد البيانات التي تم استيرادها.")) {
            return; // إذا ضغط المستخدم على "Cancel"، لا تفعل شيئاً
        }
    }

    // --- السلوك القديم (يتم تنفيذه فقط إذا وافق المستخدم على الإلغاء أو إذا لم يكن في وضع الاستيراد) ---
    currentPath = '';
    document.getElementById('formContainer').style.display = 'none';
    document.getElementById('saveAndProceedBtn').style.display = 'none';
    document.getElementById('backBtn').style.display = 'none';
    document.getElementById('pathSelection').style.display = 'block';
    
    // إعادة تعيين النماذج
    document.getElementById('singleEntityForm').reset();
    document.getElementById('groupEntityForm').reset();
    
    // (الأهم) تنظيف أي بيانات مستوردة مؤقتة
    sessionStorage.removeItem('importedTrialBalance');
    sessionStorage.removeItem('importedAdjustments');
    sessionStorage.removeItem('importedNotes');
    delete document.body.dataset.importMode;
}
// ==================================================================
// --- END: دالة الرجوع الذكية ---
// ==================================================================
// ==================================================================
// --- START: الدالة المفقودة لعرض حالة المشروع ---
// ==================================================================
/**
 * تقرأ حالة المشروع من localStorage وتعيد نصاً وأيقونة ولوناً للعرض.
 * @param {string} uniqueId - المعرف الفريد للمشروع.
 * @returns {object} - كائن يحتوي على { text, icon, color }.
 */
function getStatusDisplay(uniqueId) {
    const statusString = localStorage.getItem(`projectStatus_${uniqueId}`);
    if (statusString) {
        try {
            // محاولة قراءة الحالة ككائن JSON (الطريقة الجديدة)
            const status = JSON.parse(statusString);
            return { 
                text: status.text || "حالة غير معروفة", 
                icon: status.icon || "fa-question-circle", 
                color: status.color || "text-warning" 
            };
        } catch (e) {
            // إذا فشل التحليل، تعامل معها كنص عادي (للتوافق مع الإصدارات القديمة)
            return { 
                text: statusString, 
                icon: "fa-question-circle", 
                color: "text-warning" 
            };
        }
    }
    // الحالة الافتراضية لأي مشروع جديد لم تبدأ المراجعة فيه بعد
    return { text: "تأسيس جديد", icon: "fa-flag", color: "text-info" };
}
// ==================================================================
// --- END: الدالة المفقودة ---
// ==================================================================


 // ==================================================================
// ==================================================================
// --- دالة عرض سجل المشاريع (V3 - مع عرض الطوابع الزمنية) ---
// ==================================================================
// ==================================================================
// --- دالة عرض سجل المشاريع (V3 - النسخة النهائية الآمنة والشاملة) ---
// ==================================================================
// ==================================================================
// --- دالة عرض سجل المشاريع (V4 - مع مؤشرات الأداء) ---
// ==================================================================
function loadEstablishedClients() {
    const clientsList = document.getElementById('clientsList');
    const noClientsMessage = document.getElementById('noClientsMessage');
    if (!clientsList || !noClientsMessage) return;
    clientsList.innerHTML = '';
    
    const allSetups = [];
    // ... (كود جمع المشاريع من localStorage يبقى كما هو) ...
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('clientSetup_')) {
            try {
                const item = localStorage.getItem(key);
                const parsedData = JSON.parse(item);
                if (parsedData && parsedData.details) {
                    allSetups.push({ key: key.replace('clientSetup_', ''), data: parsedData });
                }
            } catch (e) { console.error(`Could not parse data for key: ${key}`, e); }
        }
    }

    allSetups.sort((a, b) => {
        const dateA = new Date(a.data.details.updatedAt || 0);
        const dateB = new Date(b.data.details.updatedAt || 0);
        return dateB - dateA;
    });

    noClientsMessage.style.display = allSetups.length > 0 ? 'none' : 'block';

    allSetups.forEach(({ key: uniqueId, data }) => {
        const details = data.details;
        const name = details.name || details.companyName || details.groupName || "مشروع بدون اسم";
        const { startDate, endDate, createdAt, updatedAt } = details;
        const statusDisplay = getStatusDisplay(uniqueId);

        // **الإضافة الجديدة: قراءة بيانات حقيبة المراجعة للحصول على المؤشرات**
        let kpiHtml = '';
        const auditFileJSON = localStorage.getItem(`polarisAuditFile_${uniqueId}`);
        if (auditFileJSON) {
            try {
                const auditFile = JSON.parse(auditFileJSON);
                const adjCount = auditFile.adjustments ? auditFile.adjustments.length : 0;
                const unclassifiedCount = auditFile.trialBalance ? auditFile.trialBalance.filter(acc => !acc.category).length : 0;

       // ===== استبدله بهذا الكود الجديد =====
kpiHtml = `
    <div class="d-flex justify-content-around mt-3 text-center">
        <div class="kpi-item">
            <strong class="d-block">${adjCount}</strong>
            <span>تسويات</span>
        </div>
        <div class="kpi-item">
            <strong class="d-block ${unclassifiedCount > 0 ? 'text-danger' : ''}">${unclassifiedCount}</strong>
            <span>غير مصنف</span>
                        </div>
                    </div>
                `;
            } catch (e) { /* تجاهل الخطأ إذا كان ملف المراجعة تالفاً */ }
        }

        const formatTimestamp = (isoString) => {
            if (!isoString) return 'غير متوفر';
            const date = new Date(isoString);
            return date.toLocaleString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        };
        
        const cardHtml = `
            <div class="col-lg-4 col-md-6">
                <div class="client-card">
                    <div>
                        <h6 class="font-family-display mb-2"><i class="fas fa-folder-open me-2"></i>${name}</h6>
                        <div class="mb-3"><span class="financial-period">${startDate || 'N/A'} → ${endDate || 'N/A'}</span></div>
                        
                        <div class="d-flex flex-column gap-2">
                            <div class="timestamp-info" title="تاريخ الإنشاء">
                                <i class="fas fa-calendar-plus fa-fw me-1 text-success"></i>
                                <span>${formatTimestamp(createdAt)}</span>
                            </div>
                            <div class="timestamp-info" title="آخر نشاط">
                                <i class="fas fa-pencil-alt fa-fw me-1 text-warning"></i>
                                <span>${formatTimestamp(updatedAt)}</span>
                            </div>
                        </div>
                        
                        <!-- ==== عرض المؤشرات الجديدة هنا ==== -->
                        ${kpiHtml}
                        
                    </div>
                    <div>
                        <div class="project-status ${statusDisplay.color}">
                            <i class="fas ${statusDisplay.icon} me-2"></i>${statusDisplay.text}
                        </div>
                        <div class="client-actions d-flex justify-content-between align-items-center">
                            <a href="#" onclick="openWorkspace('${uniqueId}')" class="btn btn-sm btn-outline-light"><i class="fas fa-door-open me-1"></i> إكمال العمل</a>
 
<button class="btn btn-sm btn-outline-danger" onclick="requestDeleteClient('${uniqueId}', '${name}', '${startDate || ''} to ${endDate || ''}', '${data.path}' === 'group')"><i class="fas fa-trash-alt"></i> حذف</button>
                        </div>
                    </div>
                </div>
            </div>`;
        clientsList.innerHTML += cardHtml;
    });
}


        function requestDeleteClient(uniqueId, name, period, isGroup) {
            document.getElementById('clientNameToDelete').textContent = name;
            document.getElementById('clientIdToConfirm').textContent = uniqueId;
            document.getElementById('periodToDelete').textContent = period;
            document.getElementById('periodToDeleteContainer').style.display = isGroup ? 'none' : 'block';
            document.getElementById('deleteConfirmationInput').value = '';
            document.getElementById('deleteError').style.display = 'none';
            
            document.getElementById('confirmDeleteBtn').onclick = () => performDelete(uniqueId);
            if (deleteConfirmModal) deleteConfirmModal.show();
        }

        function performDelete(uniqueId) {
            if (document.getElementById('deleteConfirmationInput').value === uniqueId) {
                // حذف جميع البيانات المرتبطة بالعميل
                localStorage.removeItem(`clientSetup_${uniqueId}`);
                localStorage.removeItem(`projectStatus_${uniqueId}`);
                localStorage.removeItem(`polarisAuditFile_${uniqueId}`);
                localStorage.removeItem(`accountMappingData_${uniqueId}`);
                
                if (localStorage.getItem('activeClientId') === uniqueId) {
                    localStorage.removeItem('activeClientId');
                }
                if (deleteConfirmModal) deleteConfirmModal.hide();
                loadEstablishedClients();
                alert(`تم حذف المشروع "${document.getElementById('clientNameToDelete').textContent}" وجميع بياناته بنجاح.`);
            } else {
                document.getElementById('deleteError').style.display = 'block';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const addModalEl = document.getElementById('addSubsidiaryModal');
            if (addModalEl) addSubsidiaryModal = new bootstrap.Modal(addModalEl);
            
            const deleteModalEl = document.getElementById('deleteConfirmModal');
            if (deleteModalEl) deleteConfirmModal = new bootstrap.Modal(deleteModalEl);

            loadEstablishedClients();

            // Update progress bar
            PolarisDataFlow._updateProgress('client-info');
        });
// =======================================================================
// --- START: دوال استيراد المشاريع الذكية (V2) ---
// =======================================================================

/**
 * يتم استدعاؤها عند الضغط على زر "استيراد مشروع".
 * تفتح نافذة اختيار الملفات.
 */
function triggerImport() {
    document.getElementById('restoreInput').click();
}

/**
 * يتم استدعاؤها بعد اختيار المستخدم لملف النسخة الاحتياطية.
 * تقرأ الملف وتملأ نموذج التأسيس بالبيانات.
 * @param {Event} event - الكائن الذي يحتوي على معلومات الملف المرفوع.
 */
function handleImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);

            // التحقق من أن الملف يحتوي على البيانات الأساسية
            if (data.clientInfo && data.clientInfo.name && data.trialBalance) {
                
                // 1. استدعاء دالة جديدة لملء النموذج بالبيانات المستوردة
                populateFormWithImportedData(data);

                // 2. تخزين بيانات ميزان المراجعة مؤقتاً
                // سيتم استخدامها لاحقاً عند الضغط على "حفظ والمتابعة"
                sessionStorage.setItem('importedTrialBalance', JSON.stringify(data.trialBalance));
                sessionStorage.setItem('importedAdjustments', JSON.stringify(data.adjustments || []));
                sessionStorage.setItem('importedNotes', JSON.stringify(data.notes || {})); // لتخزين الملاحظات

            } else {
                throw new Error("ملف النسخة الاحتياطية غير صالح أو لا يحتوي على البيانات المطلوبة.");
            }

        } catch (error) {
            console.error("❌ فشلت عملية الاستيراد:", error);
            alert(`فشلت عملية الاستيراد: ${error.message}`);
        } finally {
            event.target.value = '';
        }
    };
    reader.readAsText(file);
}

/**
// =======================================================================
// --- START: دالة ملء النموذج (V2 - تدعم تعديل التاريخ) ---
// =======================================================================
/**
 * تملأ نموذج التأسيس بالبيانات من الملف المستورد وتنقلك إلى وضع التعديل.
 * @param {object} data - البيانات المستوردة من ملف JSON.
 */
function populateFormWithImportedData(data) {
    const clientInfo = data.clientInfo;
    const isGroup = clientInfo.type === 'group';

    // 1. الانتقال إلى واجهة النموذج المناسبة
    selectPath(clientInfo.type || 'single');

    if (isGroup) {
        // ملء بيانات المجموعة
        document.getElementById('group_name').value = `${clientInfo.name} (نسخة مستوردة)`;
        
        // **التعديل الجوهري هنا: وضع التواريخ في حقول الإدخال**
        document.getElementById('group_startDate').value = clientInfo.startDate;
        document.getElementById('group_endDate').value = clientInfo.endDate;
        
        // ملء الكيانات التابعة
        subsidiariesInGroup = clientInfo.subsidiaries || [];
        renderSubsidiariesList();
    } else {
        // ملء بيانات الكيان الفردي
        document.getElementById('single_companyName').value = `${clientInfo.name} (نسخة مستوردة)`;
        document.getElementById('single_cr').value = clientInfo.cr || 'N/A';
        
        // **التعديل الجوهري هنا: وضع التواريخ في حقول الإدخال**
        document.getElementById('single_startDate').value = clientInfo.startDate;
        document.getElementById('single_endDate').value = clientInfo.endDate;
        
        document.getElementById('single_framework').value = clientInfo.framework || 'IFRS';
    }

    // 2. إضافة علامة مميزة للإشارة إلى أننا في وضع "الاستيراد"
    document.body.dataset.importMode = 'true';
    
    // 3. عرض رسالة إرشادية للمستخدم
    alert("تمت قراءة بيانات المشروع بنجاح. يمكنك الآن مراجعة البيانات وتعديلها (مثل اسم المشروع أو فترة المراجعة) ثم الضغط على 'حفظ والمتابعة' لإنشاء مشروع جديد.");
}

    </script>
</body>
</html>
