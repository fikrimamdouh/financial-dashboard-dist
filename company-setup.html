<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بروتوكول التأسيس | Polaris</title>
    
    <!-- Bootstrap RTL + FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Polaris Theme (Assuming you have this file ) -->
    <link rel="stylesheet" href="css/polaris-theme.css">

    <!-- CryptoJS + Polaris Data Pipeline -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="dataPipeline.js"></script>

    <style>
        .client-card {
            background-color: rgba(255, 255, 255, 0.05 );
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 1.25rem;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
        }
        .client-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border-color: rgba(0, 123, 255, 0.5);
        }
        .project-status { 
            font-size: 0.9rem; 
            font-weight: 500;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 1rem;
            padding-top: 1rem;
        }
        .financial-period {
            font-size: 0.85rem;
            font-family: monospace;
            background-color: rgba(0, 123, 255, 0.1);
            color: #89c4ff;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            display: inline-block;
        }
        .client-actions {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 1rem;
            margin-top: 1rem;
        }
        .subsidiary-list-item { background-color: rgba(0,0,0,0.2); padding: 0.5rem 1rem; border-radius: 0.3rem; }

        /* Progress Bar */
        .progress-container { 
            position: fixed; top: 0; left: 0; right: 0; height: 4px; z-index: 9999; 
            background-color: rgba(0,0,0,0.3); 
        }
        #polarisProgressBar { 
            height: 100%; 
            background: linear-gradient(90deg, #00BFFF, #00D4AA); 
            width: 0%; 
            transition: width 0.5s ease; 
        }
    </style>
</head>

<!-- This page is the first step in the sequence -->
<body data-step="client-info">

    <!-- Progress Bar -->
    <div class="progress-container">
        <div id="polarisProgressBar"></div>
    </div>

    <div class="grid-background"></div>
    <div class="glow-background"></div>

    <nav class="sidebar">
        <a href="index.html" class="app-logo" title="العودة لمركز القيادة"><i class="fas fa-atom"></i></a>
    </nav>

    <main class="main-content">
        <div class="page-header d-flex justify-content-between align-items-center">
            <h1 class="page-title">بروتوكول التأسيس</h1>
            <div class="d-flex gap-2">
                <button id="backBtn" class="btn btn-secondary" onclick="goBackToSelection()" style="display: none;">
                    <i class="fas fa-redo-alt me-2"></i>الرجوع للاختيار
                </button>
                <button id="saveAndProceedBtn" class="btn btn-primary" onclick="saveAndProceed()" style="display: none;">
                    <i class="fas fa-arrow-left me-2"></i>حفظ والمتابعة
                </button>
            </div>
        </div>

        <div class="control-pane">
            <div id="pathSelection">
                <h5 class="font-family-display text-center mb-4">اختر نوع العميل لتأسيس فترة مالية</h5>
                <div class="d-flex justify-content-center gap-4">
                    <button class="btn btn-outline-secondary p-4" onclick="selectPath('single')"><i class="fas fa-user-tie fa-2x mb-2"></i>  
كيان فردي مستقل</button>
                    <button class="btn btn-outline-secondary p-4" onclick="selectPath('group')"><i class="fas fa-sitemap fa-2x mb-2"></i>  
مجموعة كيانات مجمعة</button>
                </div>
            </div>

            <div id="formContainer" style="display: none;">
                <!-- Form for Single Entity -->
                <form id="singleEntityForm" style="display: none;" onsubmit="event.preventDefault();">
                    <div class="row g-4">
                        <div class="col-12"><h5 class="font-family-display">1. المعلومات الأساسية للكيان</h5>
                            <div class="row g-3">
                                <div class="col-md-6"><label class="form-label">الاسم القانوني <span class="text-danger">*</span></label><input type="text" class="form-control" id="single_companyName" required></div>
                                <div class="col-md-6"><label class="form-label">رقم السجل التجاري (CRN) <span class="text-danger">*</span></label><input type="text" class="form-control" id="single_cr" required></div>
                            </div>
                        </div>
                        <div class="col-12"><h5 class="font-family-display">2. تعريف الفترة المالية والتقارير</h5>
                            <div class="row g-3">
                                <div class="col-md-3"><label class="form-label">تاريخ بدء الفترة <span class="text-danger">*</span></label><input type="date" class="form-control" id="single_startDate" required></div>
                                <div class="col-md-3"><label class="form-label">تاريخ انتهاء الفترة <span class="text-danger">*</span></label><input type="date" class="form-control" id="single_endDate" required></div>
                                <div class="col-md-6"><label class="form-label">إطار إعداد التقارير</label><select class="form-select" id="single_framework"><option selected>المعايير الدولية (IFRS)</option><option>معايير المنشآت الصغيرة (IFRS for SMEs)</option></select></div>
                            </div>
                        </div>
                    </div>
                </form>
                
                <!-- Form for Group of Entities -->
                <form id="groupEntityForm" style="display: none;" onsubmit="event.preventDefault();">
                     <div class="row g-4">
                        <div class="col-12"><h5 class="font-family-display">1. المعلومات الأساسية للمجموعة</h5>
                            <div class="row g-3">
                                <div class="col-md-6"><label class="form-label">اسم المجموعة (الشركة القابضة) <span class="text-danger">*</span></label><input type="text" class="form-control" id="group_name" required></div>
                                <div class="col-md-3"><label class="form-label">تاريخ بدء الفترة <span class="text-danger">*</span></label><input type="date" class="form-control" id="group_startDate" required></div>
                                <div class="col-md-3"><label class="form-label">تاريخ انتهاء الفترة <span class="text-danger">*</span></label><input type="date" class="form-control" id="group_endDate" required></div>
                            </div>
                        </div>
                        <hr>
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="font-family-display mb-0">2. الكيانات التابعة للمجموعة</h5>
                                <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addSubsidiaryModal"><i class="fas fa-plus me-2"></i>إضافة كيان تابع</button>
                            </div>
                            <div id="subsidiariesList" class="d-flex flex-column gap-2">
                                <p id="noSubsidiariesMessage" class="text-muted">لم يتم إضافة أي كيانات تابعة بعد.</p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <hr class="my-5">

        <div id="establishedClientsSection">
            <h5 class="font-family-display mb-3"><i class="fas fa-tasks me-2"></i>سجل المشاريع المفتوحة (الهيستوري)</h5>
            <div id="clientsList" class="row g-4">
                 <p id="noClientsMessage" class="text-muted col-12">لا يوجد مشاريع مؤسسة حاليًا.</p>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div class="modal fade" id="addSubsidiaryModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary"><h5 class="modal-title">إضافة كيان تابع جديد</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="addSubsidiaryForm" onsubmit="event.preventDefault(); addSubsidiary();">
                        <div class="mb-3"><label class="form-label">الاسم القانوني للكيان التابع <span class="text-danger">*</span></label><input type="text" id="sub_name" class="form-control" required></div>
                        <div class="mb-3"><label class="form-label">رقم السجل التجاري (CRN) <span class="text-danger">*</span></label><input type="text" id="sub_cr" class="form-control" required></div>
                        <div class="mb-3"><label class="form-label">نسبة الملكية (%)</label><input type="number" id="sub_ownership" class="form-control" min="0" max="100" placeholder="مثال: 75"></div>
                    </form>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" form="addSubsidiaryForm" class="btn btn-primary">إضافة وحفظ</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary"><h5 class="modal-title"><i class="fas fa-exclamation-triangle text-danger me-2"></i> تأكيد عملية الحذف</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <p>أنت على وشك حذف: <strong id="clientNameToDelete"></strong>.</p>
                    <p id="periodToDeleteContainer" style="display: none;">الفترة: <span id="periodToDelete" class="text-warning"></span></p>
                    <p>للتأكيد، يرجى كتابة المعرف الفريد "<span id="clientIdToConfirm" class="text-warning font-monospace"></span>" في الحقل أدناه:</p>
                    <input type="text" class="form-control" id="deleteConfirmationInput" placeholder="اكتب المعرف هنا للتأكيد">
                    <div id="deleteError" class="text-danger mt-2" style="display: none;">المعرف الذي أدخلته غير مطابق.</div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">حذف نهائي</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentPath = '';
        let subsidiariesInGroup = [];
        let addSubsidiaryModal = null;
        let deleteConfirmModal = null;

        // ================================================================
        // START: الكود المُصحح والمُعدل
        // ================================================================

        /**
         * دالة مساعدة لإنشاء معرّف فريد للعميل أو المجموعة.
         * @param {string} identifier - اسم الشركة أو المجموعة.
         * @param {string} startDate - تاريخ بدء الفترة.
         * @param {string} path - 'single' أو 'group'.
         * @returns {string|null} - المعرّف الفريد أو null في حالة الخطأ.
         */
        function generateUniqueId(identifier, startDate, path ) {
            if (!identifier || !startDate || !path) return null;
            const prefix = path === 'group' ? 'GROUP' : 'SINGLE';
            // تنظيف الاسم وأخذ أول 15 حرفًا فقط
            const cleanIdentifier = identifier.replace(/[\s\W]/g, '_').substring(0, 15);
            const cleanDate = startDate.replace(/-/g, '');
            // إضافة جزء عشوائي لضمان عدم التكرار نهائيًا
            const randomSuffix = Math.random().toString(36).substring(2, 8);
            return `${prefix}_${cleanIdentifier}_${cleanDate}_${randomSuffix}`;
        }

        /**
         * الدالة الرئيسية للحفظ والانتقال بعد تصحيح الخطأ المنطقي.
         */
 // ==================================================================
// --- START: النسخة النهائية والمصححة لدالة الحفظ في company-setup.html ---
// ==================================================================
function saveAndProceed() {
    const form = document.getElementById(currentPath === 'single' ? 'singleEntityForm' : 'groupEntityForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    let dataToSave;
    let uniqueId;
    let clientNameForId, startDateForId;

    if (currentPath === 'single') {
        clientNameForId = document.getElementById('single_companyName').value.trim();
        startDateForId = document.getElementById('single_startDate').value;
        
        dataToSave = {
            type: 'single',
            companyName: clientNameForId,
            cr: document.getElementById('single_cr').value.trim(),
            startDate: startDateForId,
            // *** التصحيح هنا: إضافة تاريخ الانتهاء ***
            endDate: document.getElementById('single_endDate').value, 
            framework: document.getElementById('single_framework').value
        };
        uniqueId = generateUniqueId(clientNameForId, startDateForId, 'single');

    } else { // 'group'
        if (subsidiariesInGroup.length === 0) {
            alert('يجب إضافة كيان تابع واحد على الأقل للمجموعة.');
            return;
        }
        clientNameForId = document.getElementById('group_name').value.trim();
        startDateForId = document.getElementById('group_startDate').value;

        dataToSave = {
            type: 'group',
            groupName: clientNameForId,
            startDate: startDateForId,
            // *** التصحيح هنا: إضافة تاريخ الانتهاء ***
            endDate: document.getElementById('group_endDate').value,
            subsidiaries: subsidiariesInGroup
        };
        uniqueId = generateUniqueId(clientNameForId, startDateForId, 'group');
    }

    if (!uniqueId) {
        alert("خطأ حرج: لم يتمكن النظام من إنشاء معرّف فريد.");
        return;
    }

    // حفظ البيانات في المصدر الموثوق
    const legacyDataFormat = { path: currentPath, details: dataToSave };
    localStorage.setItem(`clientSetup_${uniqueId}`, JSON.stringify(legacyDataFormat));

    // تعيين العميل النشط والانتقال
    localStorage.setItem('activeClientId', uniqueId);
    window.location.href = `data-ingestion.html?clientId=${uniqueId}`;
}
// ==================================================================
// --- END: النسخة النهائية والمصححة ---
// ==================================================================

        // ================================================================
        // END: الكود المُصحح والمُعدل
        // ================================================================


        // --- باقي الدوال تبقى كما هي بدون تغيير ---

        function openWorkspace(uniqueId) {
            // هذا الجزء يضمن التوافق مع المشاريع القديمة
            if (!localStorage.getItem(`clientSetup_${uniqueId}`)) {
                alert('خطأ: بيانات المشروع غير موجودة أو تالفة. قد يكون تم حذفه.');
                loadEstablishedClients(); // إعادة تحميل القائمة لإزالة المشروع المفقود
                return;
            }

            // تحميل بيانات المشروع في نظام التدفق قبل الانتقال
            const savedData = JSON.parse(localStorage.getItem(`clientSetup_${uniqueId}`));
            PolarisDataFlow.save('client-info', savedData.details || savedData);

            // تعيين العميل النشط والانتقال
            localStorage.setItem('activeClientId', uniqueId);
            window.location.href = `account-mapping.html?clientId=${uniqueId}`;
        }

        function addSubsidiary() {
            const name = document.getElementById('sub_name').value.trim();
            const cr = document.getElementById('sub_cr').value.trim();
            const ownership = document.getElementById('sub_ownership').value;

            if (!name || !cr) { alert('اسم الكيان التابع ورقم سجله التجاري حقول إلزامية.'); return; }
            if (subsidiariesInGroup.some(sub => sub.cr === cr)) { alert('هذا السجل التجاري تم إضافته بالفعل.'); return; }

            subsidiariesInGroup.push({ name, cr, ownership });
            renderSubsidiariesList();
            if (addSubsidiaryModal) addSubsidiaryModal.hide();
            document.getElementById('addSubsidiaryForm').reset();
        }

        function renderSubsidiariesList() {
            const listElement = document.getElementById('subsidiariesList');
            const messageElement = document.getElementById('noSubsidiariesMessage');
            if (!listElement || !messageElement) return;
            listElement.innerHTML = '';

            if (subsidiariesInGroup.length === 0) {
                listElement.appendChild(messageElement);
                messageElement.style.display = 'block';
            } else {
                messageElement.style.display = 'none';
                subsidiariesInGroup.forEach((sub, index) => {
                    const item = document.createElement('div');
                    item.className = 'subsidiary-list-item d-flex justify-content-between align-items-center';
                    item.innerHTML = `<div><i class="fas fa-building me-2"></i><strong>${sub.name}</strong> (CR: ${sub.cr})</div><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSubsidiary(${index})"><i class="fas fa-times"></i></button>`;
                    listElement.appendChild(item);
                });
            }
        }

        function removeSubsidiary(index) {
            if (confirm(`هل أنت متأكد من حذف الكيان التابع "${subsidiariesInGroup[index].name}"؟`)) {
                subsidiariesInGroup.splice(index, 1);
                renderSubsidiariesList();
            }
        }

        function selectPath(path) {
            currentPath = path;
            subsidiariesInGroup = [];
            document.getElementById('pathSelection').style.display = 'none';
            document.getElementById('formContainer').style.display = 'block';
            document.getElementById('saveAndProceedBtn').style.display = 'block';
            document.getElementById('backBtn').style.display = 'block';
            document.getElementById('singleEntityForm').style.display = (path === 'single') ? 'block' : 'none';
            document.getElementById('groupEntityForm').style.display = (path === 'group') ? 'block' : 'none';
            if (path === 'group') { renderSubsidiariesList(); }
        }

        function goBackToSelection() {
            currentPath = '';
            document.getElementById('formContainer').style.display = 'none';
            document.getElementById('saveAndProceedBtn').style.display = 'none';
            document.getElementById('backBtn').style.display = 'none';
            document.getElementById('pathSelection').style.display = 'block';
            document.getElementById('singleEntityForm').reset();
            document.getElementById('groupEntityForm').reset();
        }

        function getStatusDisplay(uniqueId) {
            const statusString = localStorage.getItem(`projectStatus_${uniqueId}`);
            if (statusString) {
                try {
                    const status = JSON.parse(statusString);
                    return { text: status.text || "حالة غير معروفة", icon: status.icon || "fa-question-circle", color: status.color || "text-warning" };
                } catch (e) {
                    return { text: statusString, icon: "fa-question-circle", color: "text-warning" };
                }
            }
            return { text: "تأسيس جديد", icon: "fa-flag", color: "text-info" };
        }

        function loadEstablishedClients() {
            const clientsList = document.getElementById('clientsList');
            const noClientsMessage = document.getElementById('noClientsMessage');
            if (!clientsList || !noClientsMessage) return;
            clientsList.innerHTML = '';
            
            const allSetups = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('clientSetup_')) {
                    try {
                        const item = localStorage.getItem(key);
                        const parsedData = JSON.parse(item);
                        if (parsedData && parsedData.details) {
                            allSetups.push({ key: key.replace('clientSetup_', ''), data: parsedData });
                        }
                    } catch (e) {
                        console.error(`Could not parse corrupted data for key: ${key}`, e);
                    }
                }
            }

            allSetups.sort((a, b) => {
                const nameA = a.data.details.companyName || a.data.details.groupName;
                const nameB = b.data.details.companyName || b.data.details.groupName;
                return nameA.localeCompare(nameB) || a.data.details.startDate.localeCompare(b.data.details.startDate);
            });

            noClientsMessage.style.display = allSetups.length > 0 ? 'none' : 'block';

            allSetups.forEach(({ key: uniqueId, data }) => {
                const isGroup = data.path === 'group';
                const name = isGroup ? data.details.groupName : data.details.companyName;
                const identifier = isGroup ? `Group: ${data.details.groupName}` : `CR: ${data.details.cr}`;
                const { startDate, endDate } = data.details;
                const statusDisplay = getStatusDisplay(uniqueId);
                
                let subInfo = '';
                if (isGroup && data.details.subsidiaries && data.details.subsidiaries.length > 0) {
                    const count = data.details.subsidiaries.length;
                    subInfo = `<p class="text-muted small mt-2"><i class="fas fa-code-branch me-1"></i> ${count} كيانات تابعة</p>`;
                }

                const cardHtml = `
                    <div class="col-lg-4 col-md-6">
                        <div class="client-card">
                            <div>
                                <h6 class="font-family-display mb-2"><i class="fas ${isGroup ? 'fa-sitemap text-primary' : 'fa-user-tie'} me-2"></i>${name}</h6>
                                <div class="mb-3"><span class="financial-period">${startDate} → ${endDate}</span></div>
                                <p class="text-muted small font-monospace">${identifier}</p>
                                ${subInfo}
                            </div>
                            <div>
                                <div class="project-status ${statusDisplay.color}">
                                    <i class="fas ${statusDisplay.icon} me-2"></i>${statusDisplay.text}
                                </div>
                                <div class="client-actions d-flex justify-content-between align-items-center">
                                    <a href="#" onclick="openWorkspace('${uniqueId}')" class="btn btn-sm btn-outline-light"><i class="fas fa-door-open me-1"></i> إكمال العمل</a>
                                    <button class="btn btn-sm btn-outline-danger" onclick="requestDeleteClient('${uniqueId}', '${name}', '${startDate} to ${endDate}', ${isGroup})"><i class="fas fa-trash-alt"></i> حذف</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                clientsList.innerHTML += cardHtml;
            });
        }

        function requestDeleteClient(uniqueId, name, period, isGroup) {
            document.getElementById('clientNameToDelete').textContent = name;
            document.getElementById('clientIdToConfirm').textContent = uniqueId;
            document.getElementById('periodToDelete').textContent = period;
            document.getElementById('periodToDeleteContainer').style.display = isGroup ? 'none' : 'block';
            document.getElementById('deleteConfirmationInput').value = '';
            document.getElementById('deleteError').style.display = 'none';
            
            document.getElementById('confirmDeleteBtn').onclick = () => performDelete(uniqueId);
            if (deleteConfirmModal) deleteConfirmModal.show();
        }

        function performDelete(uniqueId) {
            if (document.getElementById('deleteConfirmationInput').value === uniqueId) {
                // حذف جميع البيانات المرتبطة بالعميل
                localStorage.removeItem(`clientSetup_${uniqueId}`);
                localStorage.removeItem(`projectStatus_${uniqueId}`);
                localStorage.removeItem(`polarisAuditFile_${uniqueId}`);
                localStorage.removeItem(`accountMappingData_${uniqueId}`);
                
                if (localStorage.getItem('activeClientId') === uniqueId) {
                    localStorage.removeItem('activeClientId');
                }
                if (deleteConfirmModal) deleteConfirmModal.hide();
                loadEstablishedClients();
                alert(`تم حذف المشروع "${document.getElementById('clientNameToDelete').textContent}" وجميع بياناته بنجاح.`);
            } else {
                document.getElementById('deleteError').style.display = 'block';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const addModalEl = document.getElementById('addSubsidiaryModal');
            if (addModalEl) addSubsidiaryModal = new bootstrap.Modal(addModalEl);
            
            const deleteModalEl = document.getElementById('deleteConfirmModal');
            if (deleteModalEl) deleteConfirmModal = new bootstrap.Modal(deleteModalEl);

            loadEstablishedClients();

            // Update progress bar
            PolarisDataFlow._updateProgress('client-info');
        });
    </script>
</body>
</html>
