<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المحطة المركزية عالم فكري ممدوح (المحاسبي)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700;900&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
/* ================================================================== */
/* --- START: POLARIS V9 - REVOLUTIONARY TABLE DESIGN --- */
/* ================================================================== */

:root {
    --color-bg: #0d1117;
    --color-surface: #161b22;
    --color-primary: #00aaff;
    --color-primary-glow: rgba(0, 170, 255, 0.5);
    --color-text-primary: #c9d1d9;
    --color-text-secondary: #8b949e;
    --color-border: #30363d;
    --color-success: #28a745;
    --color-danger: #dc3545;
    --color-warning: #ffc107;
    --border-radius-lg: 12px;
    --border-radius-md: 8px;
    --font-family-main: 'Tajawal', sans-serif;
    --font-family-display: 'Cairo', sans-serif;
}

body {
    font-family: var(--font-family-main);
    background-color: var(--color-bg);
    color: var(--color-text-primary);
}

.container-fluid { padding: 2rem; }

/* --- HEADER & GENERAL LAYOUT --- */
.page-header h1 {
    font-family: var(--font-family-display);
    font-weight: 900;
    color: var(--color-text-primary);
    text-shadow: 0 0 10px var(--color-primary-glow);
}
.page-header h4 { color: var(--color-text-secondary); font-weight: 500; }

.control-pane, .inspector-pane, .status-bar, .modal-content, .kpi-pane {
    background-color: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-lg);
}

.control-pane { padding: 1rem; }

/* --- BUTTONS & FORMS --- */
.btn {
    font-weight: 700;
    border-radius: var(--border-radius-md);
    transition: all 0.2s ease;
    padding: 0.5rem 1rem;
}
.btn-primary {
    background-color: var(--color-primary);
    border-color: var(--color-primary);
}
.btn-primary:hover {
    box-shadow: 0 0 15px var(--color-primary-glow);
    transform: translateY(-2px);
}
.btn-success {
    background-color: var(--color-success);
    border-color: var(--color-success);
}
.btn-success:hover {
    box-shadow: 0 0 15px rgba(40, 167, 69, 0.5);
    transform: translateY(-2px);
}

.form-select, .form-control, .form-control[type="search"] {
    background-color: var(--color-bg);
    border-color: var(--color-border);
    color: var(--color-text-primary);
}
.form-select:focus, .form-control:focus, .form-control[type="search"]:focus {
    box-shadow: 0 0 0 0.25rem var(--color-primary-glow);
    border-color: var(--color-primary);
}

/* --- REVOLUTIONARY TABLE DESIGN --- */
.table-responsive {
    max-height: 65vh;
    background-color: var(--color-surface);
    border-radius: var(--border-radius-lg);
    border: 1px solid var(--color-border);
}
.table { border-collapse: separate; border-spacing: 0; }
.table thead th {
    position: sticky; top: 0;
    background-color: #1c222b;
    z-index: 10;
    color: var(--color-text-primary);
    border-bottom: 2px solid var(--color-primary) !important;
}
.table td {
    border-color: var(--color-border);
    vertical-align: middle;
    padding: 1rem;
}
.table tbody tr {
    transition: background-color 0.2s ease;
}
.table-hover tbody tr:hover { background-color: rgba(0, 170, 255, 0.08); }
.table-hover tbody tr.table-active { background-color: rgba(0, 170, 255, 0.15); }

/* Account Card Layout */
.account-card-main {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.75rem; /* Space between main info and financials */
}
.account-card-identity { flex-grow: 1; }
.account-card-name {
    font-size: 1.4rem;
    font-weight: 700;
    color: #e6edf3 !important;
}
.btn-outline-success {
    border-color: var(--color-success);
    color: var(--color-success);
}
.btn-outline-success:hover {
    background-color: var(--color-success);
    color: white;
    box-shadow: 0 0 15px rgba(40, 167, 69, 0.5);
    transform: translateY(-2px);
}
/* إبراز الحسابات ذات التغيرات الجوهرية */
.table tr.high-variance {
    background-color: rgba(255, 193, 7, 0.2); /* أصفر فاتح */
}

/* إبراز الحسابات ذات الأرصدة غير المنطقية */
.table tr.abnormal-balance {
    background-color: rgba(220, 53, 69, 0.2); /* أحمر فاتح */
}

/* شارات نسبة التغير */
.variance-badge {
    font-size: 0.8rem;
    padding: 2px 6px;
    border-radius: 4px;
    margin-right: 5px;
}
.variance-badge.positive {
    background-color: rgba(40, 167, 69, 0.2);
    color: var(--color-success);
}
.variance-badge.negative {
    background-color: rgba(220, 53, 69, 0.2);
    color: var(--color-danger);
}
.account-card-id {
    font-size: 1rem;
    font-family: monospace;
    color: var(--color-text-secondary);
    background-color: rgba(139, 148, 158, 0.1);
    padding: 0.1rem 0.4rem;
    border-radius: 4px;
    display: inline-block;
}
.account-card-financials {
    display: flex;
    justify-content: space-around;
    text-align: center;
    background-color: rgba(0,0,0,0.2);
    padding: 0.5rem;
    border-radius: var(--border-radius-md);
}
.financial-item {
    flex: 1;
    border-left: 1px solid var(--color-border);
    padding: 0 0.5rem;
}
.financial-item:first-child { border-left: none; }
.financial-item .label {
    font-size: 0.8rem;
    color: var(--color-text-secondary);
    display: block;
}
.financial-item .value {
    font-size: 1.1rem;
    font-weight: 700;
    font-family: monospace;
    display: block;
}
.negative-balance { color: var(--color-danger) !important; }

/* --- KPI & STATUS BARS (No changes) --- */
.kpi-pane, .status-bar {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1.5rem; padding: 1.25rem; text-align: center;
}
.kpi-item, .status-item {
    display: flex; flex-direction: column;
    align-items: center; gap: 0.5rem;
}
.kpi-item .kpi-icon, .status-item i {
    font-size: 1.5rem; color: var(--color-primary);
    margin-bottom: 0.5rem; opacity: 0.8;
}
.kpi-item .kpi-value {
    font-family: var(--font-family-display);
    font-size: 1.75rem; font-weight: 700;
    color: var(--color-text-primary); line-height: 1.2;
}
.kpi-item .kpi-label, .status-item span {
    font-size: 0.9rem; color: var(--color-text-secondary);
}
.status-item strong {
    font-size: 1.1rem; color: var(--color-text-primary); font-weight: 700;
}

/* --- MISC & ICONS (No changes) --- */
.modal-header, .modal-footer { border-color: var(--color-border); }
.unclassified-cell { display: flex; align-items: center; gap: 5px; }
.confirm-btn {
    background: none; border: none; color: var(--color-success);
    cursor: pointer; padding: 2px 5px; transition: all 0.2s ease;
}
.confirm-btn:hover {
    color: white; background-color: var(--color-success);
    border-radius: 4px; transform: scale(1.1);
}
.logical-warning-icon {
    color: var(--color-warning);
    cursor: help; animation: blink-warning 2s infinite;
}
@keyframes blink-warning { 50% { opacity: 0.5; } }
.action-icon {
    color: var(--color-text-secondary);
    cursor: pointer; transition: all 0.2s ease;
}
.action-icon:hover { color: var(--color-primary); transform: scale(1.2); }

/* --- INSPECTOR PANE (No changes, but kept for completeness) --- */
.inspector-pane { padding: 1.5rem; height: 100%; }
.inspector-pane .card-title {
    font-size: 1.5rem; font-weight: 900;
    color: #e6edf3; margin-bottom: 0.25rem;
}
.inspector-pane .card-subtitle {
    font-size: 1.1rem; font-family: monospace;
    color: var(--color-warning) !important;
    background-color: rgba(255, 193, 7, 0.1);
    padding: 0.2rem 0.5rem; border-radius: var(--border-radius-md);
    display: inline-block;
}
.inspector-pane .list-group-item {
    padding-top: 0.8rem; padding-bottom: 0.8rem;
    color: var(--color-text-primary);
}
.inspector-pane .list-group-item span:last-child,
.inspector-pane .badge {
    font-weight: 700; font-size: 1.1rem; color: #e6edf3;
}
.inspector-pane .badge.bg-secondary { background-color: #444 !important; }
.inspector-pane .badge.bg-warning { color: #000 !important; }
.inspector-pane h6 {
    font-family: var(--font-family-display); font-weight: 700;
    color: var(--color-primary); margin-top: 1.5rem;
    padding-bottom: 0.25rem; border-bottom: 1px solid var(--color-border);
}
.inspector-pane #adjustment-log-container .text-muted {
    color: var(--color-text-secondary) !important;
    font-size: 0.95rem;
}
.journal-entry {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    font-family: 'Courier New', monospace;
}

.journal-header {
    background: #343a40;
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    margin-bottom: 10px;
    font-weight: bold;
}

.journal-line {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    border-bottom: 1px dotted #ccc;
}

.journal-line:last-child {
    border-bottom: none;
    font-weight: bold;
    background: #e9ecef;
    margin-top: 5px;
    padding: 8px 5px;
}

.account-debit {
    color: #dc3545;
    font-weight: bold;
}

.account-credit {
    color: #28a745;
    font-weight: bold;
    margin-right: 20px;
}

.amount {
    font-weight: bold;
    min-width: 100px;
    text-align: right;
}




/* تنسيق لوحة التحليل المالي */
/* ================================================================== */
/* --- START: FINANCIAL DASHBOARD V4 - ULTRA COMPACT ROW STYLE --- */
/* ================================================================== */

.financial-dashboard {
    background-color: transparent; /* بدون خلفية مستقلة */
    border-radius: 12px;
    padding: 0;
    margin-bottom: 1.5rem;
    border: none;
}

.dashboard-header {
    text-align: right; /* محاذاة لليمين */
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--color-border);
}

.dashboard-title {
    font-family: var(--font-family-display);
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text-primary);
}
.dashboard-subtitle { display: none; } /* إخفاء العنوان الفرعي */

/* بطاقة النسبة المدمجة جداً (شكل السطر) */
.ratio-card {
    background-color: var(--color-surface);
    border-radius: var(--border-radius-md);
    padding: 0.5rem 0.75rem; /* حشو صغير جداً */
    height: auto; /* ارتفاع تلقائي */
    border: 1px solid var(--color-border);
    display: flex; /* <-- أهم تغيير: عرض أفقي */
    align-items: center; /* محاذاة رأسية في المنتصف */
    justify-content: space-between;
    transition: all 0.2s ease;
}
.ratio-card:hover {
    transform: none; /* لا حاجة للحركة */
    box-shadow: none;
    border-color: var(--color-primary);
}

/* إخفاء العناصر غير الضرورية في هذا التصميم */
.ratio-card::before, .ratio-header, .ratio-content, .ratio-progress {
    display: none;
}

/* إعادة بناء البطاقة لتكون سطرًا واحدًا */
.ratio-card {
    gap: 0.75rem; /* مسافة بين العناصر */
}

/* إضافة العناصر من جديد داخل البطاقة باستخدام CSS */
.ratio-card::after {
    content: ''; /* تفريغ المحتوى القديم */
}

/* عرض العناصر الجديدة داخل البطاقة */
.ratio-card .icon-placeholder,
.ratio-card .label-placeholder,
.ratio-card .value-placeholder {
    display: block;
}

.ratio-card .icon-placeholder {
    font-size: 1.1rem;
    color: var(--color-text-secondary);
    flex-shrink: 0;
}
.ratio-card .label-placeholder {
    font-size: 0.85rem;
    color: var(--color-text-primary);
    font-weight: 500;
    flex-grow: 1; /* يأخذ المساحة المتبقية */
    white-space: nowrap;
}
.ratio-card .value-placeholder {
    font-family: monospace;
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--color-primary);
    flex-shrink: 0;
}
.ratio-card.negative .value-placeholder {
    color: var(--color-danger);
}

/* تعديل كلاسات الأعمدة لتناسب التصميم الجديد */
/* هذا يضمن أن تكون 4 بطاقات في الصف على الشاشات الكبيرة */
.financial-dashboard .row > * {
    flex: 0 0 auto;
    width: 25%;
}

@media (max-width: 1200px) {
    .financial-dashboard .row > * { width: 33.33%; }
}
@media (max-width: 992px) {
    .financial-dashboard .row > * { width: 50%; }
}
@media (max-width: 576px) {
    .financial-dashboard .row > * { width: 100%; }
}

/* ================================================================== */
/* --- END: FINANCIAL DASHBOARD V4 --- */
/* ================================================================== */
/* تظليل الحسابات ذات الأرصدة الشاذة */
.table tr.abnormal-balance {
    background-color: rgba(220, 53, 69, 0.15) !important; /* أحمر فاتح */
}
/* --- أضف هذا الكود --- */

/* إبراز الحسابات ذات التغيرات الجوهرية */
.table tr.high-variance {
    background-color: rgba(255, 193, 7, 0.15) !important; /* أصفر فاتح */
}


/* تظليل الحسابات غير المصنفة */
.table tr.unclassified-account {
    background-color: rgba(0, 170, 255, 0.15) !important; /* أزرق فاتح */
}
/* --- أزرار تأكيد وتراجع تعديل الفئة --- */
.category-actions {
    display: inline-flex;
    gap: 5px;
    margin-right: 5px; /* مسافة بين الأزرار والقائمة */
    vertical-align: middle;
}

.action-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 2px 5px;
    border-radius: 4px;
    transition: all 0.2s ease;
    font-size: 1.1rem;
}

.action-btn.confirm {
    color: var(--color-success);
}
.action-btn.confirm:hover {
    background-color: var(--color-success);
    color: white;
}

.action-btn.undo {
    color: var(--color-warning);
}
.action-btn.undo:hover {
    background-color: var(--color-warning);
    color: #0d1117;
}
/* --- تنسيقات لوحة المفتش المدمجة --- */
.risks-container, .adjustments-container {
    max-height: 200px; /* ارتفاع مناسب لكل قسم */
    overflow-y: auto;
    padding-right: 5px;
    margin-top: 0.5rem;
}
.risk-item {
    background-color: rgba(0,0,0,0.2);
    border-radius: var(--border-radius-md);
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border-left: 3px solid var(--color-warning);
}
.risk-title {
    display: flex;
    align-items: center;
    margin-bottom: 0.25rem;
}
.risk-title strong {
    color: var(--color-text-primary);
    font-size: 0.9rem;
}
.risk-procedure {
    font-size: 0.85rem;
    color: var(--color-text-secondary);
    margin: 0;
    line-height: 1.5;
}

/* تنسيق سجل القيود المصغر */
.journal-entry-small {
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    border-radius: 4px;
    background-color: rgba(255,255,255,0.03);
}
.journal-line-small {
    display: flex;
    justify-content: space-between;
}
.amount-small { font-weight: bold; }
.desc-small {
    font-style: italic;
    color: var(--color-text-secondary);
    margin-top: 4px;
    font-family: var(--font-family-main);
}
/* --- تنسيق ملحوظة المجلس المدمجة --- */
.council-note {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    background-color: rgba(255, 193, 7, 0.1); /* خلفية بلون تحذيري خفيف */
    border-left: 3px solid var(--color-warning);
    border-radius: var(--border-radius-md);
    padding: 0.75rem;
    margin-top: 1.5rem;
}
.council-note .icon {
    color: var(--color-warning);
    font-size: 1.2rem;
    margin-top: 3px;
}
.council-note .note-text {
    font-size: 0.9rem;
    color: var(--color-text-secondary);
    margin: 0;
    line-height: 1.6;
}
.council-note .note-text strong {
    color: var(--color-text-primary);
}

/* أضف هذا في نهاية قسم <style> */
.cockpit-title {
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 6px;
    transition: background-color 0.2s ease;
    border-bottom: 1px solid var(--color-border); 
    margin-bottom: 1rem;
    color: var(--color-primary); 
    font-family: var(--font-family-display);
}
.cockpit-title:hover {
    background-color: rgba(0, 170, 255, 0.08);
}
.cockpit-title .toggle-icon {
    transition: transform 0.3s ease;
}
.cockpit-title[aria-expanded="false"] .toggle-icon {
    transform: rotate(-90deg);
}
/* أضف هذا في نهاية قسم <style> */
.cockpit-item {
    cursor: pointer;
    border-radius: 8px;
    transition: background-color 0.2s ease;
}
.cockpit-item:hover {
    background-color: rgba(0, 170, 255, 0.08);
}
.cockpit-item .action-arrow {
    transition: transform 0.2s ease;
}
.cockpit-item:hover .action-arrow {
    transform: translateX(-5px);
    color: var(--color-primary) !important;
}

/* ======================================================= */
/* --- START: تصميم التظليل المتدرج والنابض (V3) --- */
/* ======================================================= */

/* 1. تعريف حركة النبض */
@keyframes pulse-glow {
    0% {
        box-shadow: 0 0 5px rgba(0, 170, 255, 0.3), inset 0 0 5px rgba(0, 170, 255, 0.2);
    }
    50% {
        box-shadow: 0 0 20px rgba(0, 170, 255, 0.6), inset 0 0 10px rgba(0, 170, 255, 0.4);
    }
    100% {
        box-shadow: 0 0 5px rgba(0, 170, 255, 0.3), inset 0 0 5px rgba(0, 170, 255, 0.2);
    }
}

/* 2. تطبيق التصميم على الصف المختار */
.table tbody tr.cockpit-focus {
    /* التدرج اللوني للخلفية */
    background: linear-gradient(
        90deg, 
        rgba(0, 170, 255, 0.2) 0%,  /* يبدأ بلون أزرق شفاف على اليمين */
        rgba(13, 17, 23, 0.1) 80%   /* يتلاشى إلى لون الخلفية على اليسار */
    ) !important;

    /* تطبيق حركة النبض بشكل مستمر وخفيف */
    animation: pulse-glow 2s infinite ease-in-out;

    /* إضافة حدود جانبية لزيادة التمييز */
    border-left: 3px solid var(--color-primary) !important;
    border-right: 3px solid var(--color-primary) !important;
    
    /* ضمان عدم اختفاء الحدود العادية للجدول */
    border-top: 1px solid var(--color-border) !important;
    border-bottom: 1px solid var(--color-border) !important;
}

/* 3. إزالة تأثير المرور بالماوس (hover) من الصف المظلل */
.table tbody tr.cockpit-focus:hover {
    /* نستخدم نفس الخلفية لمنع تغيير اللون عند المرور بالماوس */
    background: linear-gradient(
        90deg, 
        rgba(0, 170, 255, 0.2) 0%, 
        rgba(13, 17, 23, 0.1) 80%
    ) !important;
}

/* ======================================================= */
/* --- END: تصميم التظليل المتدرج والنابض --- */
/* ======================================================= */
    </style>
</head>
<body>
    <div class="container-fluid">
        <div id="loader" class="text-center my-5">
            <h3 style="color: var(--color-text-secondary); font-family: var(--font-family-main);">جاري تهيئة محطة عمل المراجعة...</h3>
        </div>

        <div id="appContainer" style="display: none;">
            <header class="page-header mb-4">
                <h1><i class="fas fa-rocket text-primary me-3"></i>المحطة المركزية عالم فكري ممدوح (المحاسبي)</h1>
                <h4 id="clientNameSubtitle"></h4>
            </header>
            <!-- ================================================================ -->
<!-- ================================================================ -->
<!-- START: لوحة التحكم التفاعلية القابلة للطي (V2) -->
<!-- ================================================================ -->
<div id="auditCockpit" class="mb-4 p-3" style="background-color: var(--color-surface); border-radius: var(--border-radius-lg); border: 1px solid var(--color-border);">
    <div class="row">
        <!-- قسم الأولوية القصوى -->
        <div class="col-md-6">
            <div class="cockpit-section">
                <!-- 1. جعلنا العنوان h5 زرًا -->
                <h5 class="cockpit-title" data-bs-toggle="collapse" data-bs-target="#cockpit-high-priority-content" aria-expanded="true">
                    <i class="fas fa-exclamation-triangle text-danger me-2"></i>الأولوية القصوى (يجب حلها)
                    <i class="fas fa-chevron-down float-start toggle-icon"></i>
                </h5>
                <!-- 2. وضعنا المحتوى داخل div قابل للطي -->
                <div id="cockpit-high-priority-content" class="collapse show">
                    <div id="cockpit-high-priority" class="mt-2">
                        <p class="text-muted small">جاري التحميل...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- قسم الأولوية الثانية -->
        <div class="col-md-6">
            <div class="cockpit-section">
                <!-- 1. جعلنا العنوان h5 زرًا -->
                <h5 class="cockpit-title" data-bs-toggle="collapse" data-bs-target="#cockpit-medium-priority-content" aria-expanded="true">
                    <i class="fas fa-lightbulb text-warning me-2"></i>الأولوية الثانية (تحتاج تحليل)
                    <i class="fas fa-chevron-down float-start toggle-icon"></i>
                </h5>
                <!-- 2. وضعنا المحتوى داخل div قابل للطي -->
                <div id="cockpit-medium-priority-content" class="collapse show">
                    <div id="cockpit-medium-priority" class="mt-2">
                        <p class="text-muted small">جاري التحميل...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- ================================================================ -->
<!-- END: لوحة التحكم التفاعلية -->
<!-- ================================================================ -->
<!-- ================================================================ -->
<!-- END: لوحة التحكم الرئيسية للمراجعة -->
<!-- ================================================================ -->

          <!-- قسم النسب المالية والتحليلات -->
<!-- قسم النسب المالية والتحليلات V3 - شامل -->
<!-- قسم النسب المالية والتحليلات V3.1 - تنسيق محسن -->
<div class="financial-dashboard">
    <div class="dashboard-header">
        <h4 class="dashboard-title"><i class="fas fa-chart-pie me-2"></i>لوحة التحليل المالي</h4>
        <p class="dashboard-subtitle">نظرة شاملة على مؤشرات الأداء الرئيسية</p>
    </div>

    <div class="row g-3">
        <!-- ================== الصف الأول: الربحية والسيولة ================== -->
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card profitability"><div class="ratio-header"><p class="ratio-label">هامش الربح الإجمالي</p><i class="fas fa-percent ratio-icon"></i></div><div class="ratio-content"><h3 class="ratio-value" id="grossMargin">--%</h3><div class="ratio-progress"><div class="progress-bar"></div></div></div></div>
        </div>
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card profitability"><div class="ratio-header"><p class="ratio-label">هامش الربح التشغيلي</p><i class="fas fa-cash-register ratio-icon"></i></div><div class="ratio-content"><h3 class="ratio-value" id="operatingMargin">--%</h3><div class="ratio-progress"><div class="progress-bar"></div></div></div></div>
        </div>
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card profitability"><div class="ratio-header"><p class="ratio-label">هامش صافي الربح</p<i class="fas fa-wallet ratio-icon"></i></div><div class="ratio-content"><h3 class="ratio-value" id="netMargin">--%</h3><div class="ratio-progress"><div class="progress-bar"></div></div></div></div>
        </div>
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card liquidity"><div class="ratio-header"><p class="ratio-label">نسبة التداول</p><i class="fas fa-hand-holding-usd ratio-icon"></i></div><div class="ratio-content"><h3 class="ratio-value" id="currentRatio">--</h3><div class="ratio-progress"><div class="progress-bar"></div></div></div></div>
        </div>

        <!-- ================== الصف الثاني: السيولة والمديونية ================== -->
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card liquidity"><div class="ratio-header"><p class="ratio-label">النسبة السريعة</p><i class="fas fa-shipping-fast ratio-icon"></i></div><div class="ratio-content"><h3 class="ratio-value" id="quickRatio">--</h3><div class="ratio-progress"><div class="progress-bar"></div></div></div></div>
        </div>
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card debt"><div class="ratio-header"><p class="ratio-label">نسبة المديونية</p><i class="fas fa-university ratio-icon"></i></div><div class="ratio-content"><h3 class="ratio-value" id="debtRatio">--%</h3><div class="ratio-progress"><div class="progress-bar"></div></div></div></div>
        </div>
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card debt"><div class="ratio-header"><p class="ratio-label">الديون إلى حقوق الملكية</p><i class="fas fa-balance-scale-left ratio-icon"></i></div><div class="ratio-content"><h3 class="ratio-value" id="debtToEquity">--</h3><div class="ratio-progress"><div class="progress-bar"></div></div></div></div>
        </div>
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card activity"><div class="ratio-header"><p class="ratio-label">معدل دوران الأصول</p><i class="fas fa-sync-alt ratio-icon"></i></div><div class="ratio-content"><h3 class="ratio-value" id="assetTurnover">--</h3><div class="ratio-progress"><div class="progress-bar"></div></div></div></div>
        </div>
        
        <!-- ================== الصف الثالث: النشاط والعائد ================== -->
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card activity"><div class="ratio-header"><p class="ratio-label">دوران المخزون (مرة)</p><i class="fas fa-boxes ratio-icon"></i></div><div class="ratio-content"><h3 class="ratio-value" id="inventoryTurnover">--</h3><div class="ratio-progress"><div class="progress-bar"></div></div></div></div>
        </div>
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card activity"><div class="ratio-header"><p class="ratio-label">فترة التحصيل (يوم)</p><i class="fas fa-calendar-check ratio-icon"></i></div><div class="ratio-content"><h3 class="ratio-value" id="collectionPeriod">--</h3><div class="ratio-progress"><div class="progress-bar"></div></div></div></div>
        </div>
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card additional"><div class="ratio-header"><p class="ratio-label">العائد على الأصول (ROA)</p><i class="fas fa-chart-line ratio-icon"></i></div><div class="ratio-content"><h3 class="ratio-value" id="roa">--%</h3><div class="ratio-progress"><div class="progress-bar"></div></div></div></div>
        </div>
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card profitability"><div class="ratio-header"><p class="ratio-label">العائد على حقوق الملكية</p><i class="fas fa-users-cog ratio-icon"></i></div><div class="ratio-content"><h3 class="ratio-value" id="roe">--%</h3><div class="ratio-progress"><div class="progress-bar"></div></div></div></div>
        </div>
    </div>
</div>

       <!-- ================= START: شريط التحكم النهائي حسب طلبك ================= -->
<div class="control-pane mb-3">
    <div class="d-flex gap-2 flex-wrap align-items-center">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#materialityModal"><i class="fas fa-bullseye me-2"></i>الأهمية النسبية</button>
        <select class="form-select w-auto" id="filterCategory">
            <option value="all">جميع الفئات</option>
            <option value="assets">الأصول</option>
            <option value="liabilities">الالتزامات</option>
            <option value="equity">حقوق الملكية</option>
            <option value="revenue">الإيرادات</option>
            <option value="expenses">المصروفات</option>
            <option value="unclassified">غير مصنف</option>
        </select>
        <select class="form-select w-auto" id="filterStatus">
            <option value="all">جميع الحالات</option>
            <option value="pending">قيد المراجعة</option>
            <option value="reviewed">تمت المراجعة</option>
            <option value="flagged">تحتاج تدقيق</option>
        </select>
        <input type="search" class="form-control w-auto flex-grow-1" id="searchInput" placeholder="ابحث بالاسم أو الرقم...">
        
        <!-- الأزرار الوظيفية -->
        <button class="btn btn-outline-primary" id="logicalCheckButton" title="تدقيق منطقية الأرصدة والحسابات غير المصنفة"><i class="fas fa-tasks me-2"></i>تدقيق المنطقية</button>
        <button class="btn btn-outline-success" id="saveChangesButton" title="حفظ التغييرات"><i class="fas fa-save me-2"></i>حفظ التغييرات</button>
        <button class="btn btn-outline-secondary" id="exportButton"><i class="fas fa-file-excel me-2"></i>تصدير Excel</button>
        <!-- 1. زر تنزيل النسخة الاحتياطية (جديد) -->
<button class="btn btn-outline-info" onclick="downloadBackup()" title="تنزيل نسخة احتياطية من العمل الحالي">
    <i class="fas fa-download me-2"></i>تنزيل نسخة
</button>

<!-- 2. زر استعادة النسخة الاحتياطية (جديد) -->
<button class="btn btn-info" onclick="triggerRestore()" title="استعادة بيانات المراجعة من ملف نسخة احتياطية">
    <i class="fas fa-upload me-2"></i>استعادة نسخة
</button>
<!-- حقل رفع الملفات المخفي للاستعادة -->
<input type="file" id="restoreInput" class="d-none" accept=".json" onchange="restoreFromBackup(event)">

        <!-- زر الأرشفة -->
        <button class="btn btn-warning" onclick="archiveForNextYear()" title="أرشفة الأرصدة النهائية للمقارنة المستقبلية">
            <i class="fas fa-archive me-2"></i>أرشفة
        </button>

        <!-- زر التقارير المالية -->
        <button class="btn btn-info" onclick="goToFinancialReports()">
            <i class="fas fa-chart-line me-2"></i>التقارير
        </button>

        <!-- زر الاعتماد والانتقال (في أقصى اليسار) -->
        <button class="btn btn-success ms-auto" id="consolidationButton" onclick="navigateToConsolidation()">
            <i class="fas fa-layer-group me-2"></i>الاعتماد والانتقال
        </button>
    </div>
</div>
<!-- ================= END: شريط التحكم النهائي ================= -->


            <div class="row g-3">
                <div class="col-lg-8">
                    <div class="table-responsive">
                        <table class="table table-hover" id="trialBalanceTable">
                           <thead>
    <tr>
        <th>الحساب</th>
        <th>الفئة</th>
        <th>التصنيف الفرعي</th>
        <th>رصيد سنة سابقة</th>
        <th>الرصيد النهائي</th>
        <th>التغير %</th>
        <th>الحالة</th>
    </tr>
</thead>

                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="inspector-pane">
                        <h5><i class="fas fa-search-location text-primary me-2"></i>لوحة المفتش الذكي</h5>
                        <hr class="my-3" style="border-color: var(--color-border);">
                        <div id="inspectorContent">
                            <p class="text-center mt-5 text-muted">الرجاء تحديد حساب من الجدول لعرض تفاصيله وإجراءات المراجعة المقترحة.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="status-bar mt-3">
                <div class="status-item">
                    <i class="fas fa-crosshairs"></i>
                    <span>الأهمية النسبية</span>
                    <strong id="materialityDisplay">لم تحدد</strong>
                </div>
                <div class="status-item">
                    <i class="fas fa-wallet"></i>
                    <span>صافي الربح المعدل</span>
                    <strong id="netProfitDisplay">لم يحسب</strong>
                </div>
                <div class="status-item">
                    <i class="fas fa-pen"></i>
                    <span>أثر التسويات</span>
                    <strong id="adjustmentsEffectDisplay">0</strong>
                </div>
                <div class="status-item">
                    <i class="fas fa-tasks"></i>
                    <span>نسبة الإنجاز</span>
                    <strong id="completionDisplay">0%</strong>
                </div>
            </div>
        </div>
        <!-- All Modals -->
        <!-- Materiality Modal -->
        <div class="modal fade" id="materialityModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">تحديد الأهمية النسبية</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-muted small">سيتم استخدام هذا الرقم لتحديد الحسابات الهامة وتوجيه إجراءات المراجعة.</p>
                        <div class="mb-3">
                            <label class="form-label">أساس الحساب</label>
                            <select class="form-select" id="materialityBasis">
                                <option value="profit">5% من صافي الربح قبل الزكاة</option>
                                <option value="revenue">1% من إجمالي الإيرادات</option>
                                <option value="assets">0.5% من إجمالي الأصول</option>
                                <option value="fixed">مبلغ مقطوع</option>
                            </select>
                        </div>
                        <div class="mb-3" id="fixedAmountInput" style="display: none;">
                            <label class="form-label">المبلغ النهائي</label>
                            <input type="number" class="form-control" id="materialityAmount" placeholder="أدخل المبلغ">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">إلغاء</button>
                        <button type="button" class="btn btn-primary" onclick="saveMateriality()">حفظ واعتماد</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- AJE Modal -->
        <div class="modal fade" id="ajeModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="ajeModalLabel">إدخال قيد تسوية / إعادة تصنيف</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="isRceSwitch">
                            <label class="form-check-label" for="isRceSwitch">هذا القيد هو **إعادة تصنيف (RCE)** ولا يؤثر على صافي الربح.</label>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الوصف</label>
                            <input type="text" class="form-control" id="ajeDescription">
                        </div>
             <div class="row">
    <div class="col-md-6 mb-3">
        <label class="form-label">الحساب المدين</label>
        <input type="text" class="form-control form-control-sm mb-1" id="searchDebitAccount" placeholder="ابحث...">
        <select class="form-select" id="ajeDebitAccount" size="8"></select>
    </div>
    <div class="col-md-6 mb-3">
        <label class="form-label">الحساب الدائن</label>
        <input type="text" class="form-control form-control-sm mb-1" id="searchCreditAccount" placeholder="ابحث...">
        <select class="form-select" id="ajeCreditAccount" size="8"></select>
    </div>
</div>
                        <div class="mb-3">
                            <label class="form-label">المبلغ</label>
                            <input type="number" class="form-control" id="ajeAmount">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">إلغاء</button>
                        <button type="button" class="btn btn-primary" onclick="saveAdjustment()">حفظ القيد</button>
                    </div>
                </div>
            </div>
        </div>
        
    <!-- ================================================================ -->
<!-- START: الإصلاح النهائي لنافذة الخبير التنفيذي -->
<!-- ================================================================ -->
<div class="modal fade" id="vAIAssistantModal" tabindex="-1">
    <div class="modal-dialog modal-xl"> <!-- حجم أكبر لراحة العين -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-secret text-primary me-2"></i>استشارة الخبير التنفيذي</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- القسم الأول لعرض التحليل -->
                <div id="vAIAssistantResponse">
                    <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                </div>
                
                <!-- القسم الثاني المفقود لعرض الأزرار -->
                <div id="vAIActionButtons" class="mt-3 pt-3 border-top" style="border-color: var(--color-border) !important;">
                    <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
<!-- ================================================================ -->
<!-- END: الإصلاح النهائي لنافذة الخبير التنفيذي -->
<!-- ================================================================ -->

<!-- Depreciation Wizard Modal -->
<div class="modal fade" id="depreciationWizardModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-magic text-info me-2"></i>المحلل الذكي للأصول</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">قام المحلل بقراءة البيانات التالية من ميزان المراجعة:</p>
                <div class="row p-2" style="background-color: var(--color-bg); border-radius: var(--border-radius-md);">
                    <div class="col-md-6">
                        <label class="small">إجمالي تكلفة الأصول الثابتة</label>
                        <h4 id="autoReadAssets" class="text-info">0.00</h4>
                    </div>
                     <div class="col-md-6">
                        <label class="small">مصروف الإهلاك المسجل خلال العام</label>
                        <h4 id="autoReadDepreciationMovement" class="text-info">0.00</h4>
                    </div>
                </div>
                <hr style="border-color: var(--color-border);">
                <div class="mb-3">
                    <label for="depreciationRate" class="form-label">أدخل متوسط نسبة الإهلاك السنوي (%):</label>
                    <input type="number" class="form-control" id="depreciationRate" placeholder="مثال: 20">
                </div>
                <div class="p-3 mt-3" style="background-color: var(--color-bg); border-radius: var(--border-radius-md);">
                    <p class="mb-1">إجمالي الإهلاك السنوي المستحق: <span id="totalRequiredDepreciation" class="fw-bold">0.00</span></p>
                    <p class="mb-1">(-) مصروف الإهلاك المسجل مسبقاً: <span id="alreadyBookedDepreciation" class="fw-bold">0.00</span></p>
                    <hr style="border-color: var(--color-border);">
                    <h5 class="mb-0">صافي قيد التسوية المطلوب: <span id="netAdjustmentNeeded" class="text-warning">0.00</span></h5>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="createDepreciationAdjustmentEntry()">
                    <i class="fas fa-check-circle me-2"></i>إنشاء قيد التسوية الصافي
                </button>
            </div>
        </div>
    </div>
</div>

        <!-- Workpapers Modal -->
        <div class="modal fade" id="workpapersModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="workpapersModalTitle">أوراق العمل</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>الحساب:</strong> <span id="workpapersAccountName" class="fw-bold"></span></p>
                        
                        <button class="btn btn-primary btn-sm" onclick="uploadWorkpaper()">رفع وحفظ</button>
                        <hr>
                        <h6>المستندات المرفقة:</h6>
                        <ul class="list-group" id="workpapersList">
                            <li class="list-group-item">لا توجد مستندات مرفقة حالياً.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
// ================================================================
// المهمة الاستراتيجية الأولى: بناء قاعدة معارف مجلس الحكمة
// ================================================================

const councilKnowledgeBase = {
    // مخاطر عامة تنطبق على معظم الحسابات
    generalRisks: [
        "خطر العرض والإفصاح: تأكد من تصنيف الحساب بشكل نهائي وصحيح في القوائم المالية.",
        "خطر الاكتمال: هل تم تسجيل جميع المعاملات المتعلقة بهذا الحساب؟",
        "خطر الحدوث: هل المعاملات المسجلة حدثت بالفعل وتخص الشركة؟"
    ],
    // مخاطر مخصصة بناءً على التصنيف الفرعي للحساب
    specificRisks: {
        'trade_receivables': [ // العملاء
            "خطر التحصيل: يجب تحليل أعمار الديون بشكل دقيق.",
            "خطر كفاية المخصص: هل مخصص الديون المشكوك في تحصيلها كافٍ لتغطية الديون المتعثرة؟"
        ],
        'inventory': [ // المخزون
            "خطر التقييم: هل تم تقييم المخزون بالتكلفة أو صافي القيمة القابلة للتحقق أيهما أقل؟",
            "خطر التقادم: يجب فحص المخزون لتحديد أي أصناف بطيئة الحركة أو تالفة وتكوين المخصص اللازم."
        ],
        'fixed_assets': [ // الأصول الثابتة
            "خطر الوجود: يجب إجراء جرد مادي لعينة من الأصول للتحقق من وجودها الفعلي.",
            "خطر الإهلاك: هل السياسة المتبعة للإهلاك معقولة وتطبق بشكل ثابت؟"
        ],
        'trade_payables': [ // الموردون
            "خطر الالتزامات غير المسجلة: يجب البحث عن أي فواتير أو التزامات غير مسجلة تخص الفترة."
        ],
        'main_revenue': [ // الإيرادات الرئيسية
            "خطر الاعتراف بالإيراد: هل تم الاعتراف بالإيراد في الفترة الصحيحة وفقًا لمعيار الإيراد من العقود مع العملاء؟"
        ],
        'salaries': [ // الرواتب
            "خطر الموظفين الوهميين: يجب مطابقة كشوف المرتبات مع سجلات الموظفين الفعلية.",
            "خطر الامتثال: هل تم حساب وسداد حصص التأمينات الاجتماعية والضرائب بشكل صحيح؟"
        ]
    }
};

        // --- GLOBAL VARIABLES & MAPS ---
        let auditFile = {};
        let userPrefs = {};
        let ajeModal, materialityModal, vAIAssistantModal, workpapersModal;
        let currentVAIContext = {};
        let currentWorkpaperAccountId = null;
        const CURRENCY = 'SAR';
        const VARIANCE_THRESHOLD = 25;

const subCategoryMap = {
    'assets': [
        { group: 'الأصول المتداولة', value: 'cash_on_hand', label: 'النقدية بالصندوق' },
        { group: 'الأصول المتداولة', value: 'cash_at_banks', label: 'النقدية لدى البنوك' },
        { group: 'الأصول المتداولة', value: 'trade_receivables', label: 'العملاء (الذمم المدينة)' },
        { group: 'الأصول المتداولة', value: 'related_parties_receivables', label: 'ذمم أطراف ذات علاقة' },
        { group: 'الأصول المتداولة', value: 'employee_advances', label: 'سلف الموظفين' },
        { group: 'الأصول المتداولة', value: 'custody_accounts', label: 'حسابات العهد' },
        { group: 'الأصول المتداولة', value: 'prepaid_expenses', label: 'مصروفات مدفوعة مقدماً' },
        { group: 'الأصول المتداولة', value: 'accrued_revenue', label: 'إيرادات مستحقة القبض' },
        { group: 'الأصول المتداولة', value: 'inventory', label: 'المخزون' },
        { group: 'الأصول غير المتداولة', value: 'fixed_assets', label: 'الأصول الثابتة (صافي)' },
        { group: 'الأصول غير المتداولة', value: 'wip_projects', label: 'مشاريع تحت التنفيذ' },
        { group: 'الأصول غير المتداولة', value: 'intangible_assets', label: 'أصول غير ملموسة' },
        { group: 'الأصول غير المتداولة', value: 'long_term_investments', label: 'استثمارات طويلة الأجل' }
    ],
    'liabilities': [
        { group: 'الالتزامات المتداولة', value: 'trade_payables', label: 'الموردون (الذمم الدائنة)' },
        { group: 'الالتزامات المتداولة', value: 'related_parties_payables', label: 'ذمم دائنة لأطراف ذات علاقة' },
        { group: 'الالتزامات المتداولة', value: 'accrued_expenses', label: 'مصروفات مستحقة الدفع' },
        { group: 'الالتزامات المتداولة', value: 'unearned_revenue', label: 'إيرادات غير مكتسبة' },
        { group: 'الالتزامات المتداولة', value: 'vat_payable', label: 'ضريبة القيمة المضافة المستحقة' },
        { group: 'الالتزامات المتداولة', value: 'short_term_loans', label: 'قروض قصيرة الأجل' },
        { group: 'الالتزامات غير المتداولة', value: 'long_term_loans', label: 'قروض طويلة الأجل' },
        { group: 'الالتزامات غير المتداولة', value: 'provisions', label: 'مخصصات' },
        { group: 'الالتزامات غير المتداولة', value: 'end_of_service_benefit', label: 'مخصص مكافأة نهاية الخدمة' }
    ],
    'equity': [
        { group: 'حقوق الملكية', value: 'capital', label: 'رأس المال' },
        { group: 'حقوق الملكية', value: 'retained_earnings', label: 'أرباح مبقاة / خسائر مدورة' },
        { group: 'حقوق الملكية', value: 'owners_current_account', label: 'جاري الشركاء / المالك' }
    ],
    'revenue': [
        { group: 'الإيرادات', value: 'main_revenue', label: 'إيرادات النشاط الرئيسي' },
        { group: 'الإيرادات', value: 'other_revenue', label: 'إيرادات أخرى' },
        { group: 'الإيرادات', value: 'investment_gains', label: 'أرباح استثمارات' },
        { group: 'الإيرادات (مقابل)', value: 'sales_discount', label: 'خصم مسموح به (مقابل)' },
        { group: 'الإيرادات (مقابل)', value: 'sales_returns', label: 'مردودات المبيعات (مقابل)' }
    ],
    'expenses': [
        { group: 'تكلفة الإيرادات', value: 'cogs', label: 'تكلفة البضاعة/الخدمات' },
        { group: 'مصاريف التشغيل', value: 'salaries', label: 'رواتب وأجور' },
        { group: 'مصاريف التشغيل', value: 'rent', label: 'مصروف إيجار' },
        { group: 'مصاريف التشغيل', value: 'utilities', label: 'كهرباء ومياه واتصالات' },
        { group: 'مصاريف التشغيل', value: 'maintenance', label: 'مصروف صيانة' },
        { group: 'مصاريف التشغيل', value: 'fuel_transport', label: 'محروقات ونقل' },
        { group: 'مصاريف عمومية وإدارية', value: 'general_admin', label: 'مصاريف عمومية وإدارية' },
        { group: 'مصاريف البيع والتسويق', value: 'selling_marketing', label: 'مصاريف بيع وتسويق' },
        { group: 'مصاريف أخرى', value: 'depreciation', label: 'مصروف إهلاك' },
        { group: 'مصاريف أخرى', value: 'amortization', label: 'مصروف إطفاء' },
        { group: 'مصاريف أخرى', value: 'zakat_expense', label: 'مصروف زكاة' },
        { group: 'مصاريف أخرى', value: 'bank_charges', label: 'رسوم بنكية' }
    ],
'clearing': [
    { group: 'حسابات وسيطة', value: 'clearing', label: 'حساب وسيط عام' },
    { group: 'حسابات رقابية', value: 'monitoring_accounts', label: 'حسابات رقابية / مراقبة' }
]
};



// ==================================================================
// --- قاعدة البيانات المحاسبية (V12) - النسخة النهائية مع الذكاء السياقي ---
// ==================================================================
// ==================================================================
// --- قاعدة البيانات المحاسبية (V30) - الضبط الدقيق النهائي ---
// ==================================================================
// ==================================================================
// --- قاعدة البيانات المحاسبية (V31) - الضبط الدقيق النهائي للأولويات ---
// ==================================================================
const keywordMapping = [



// --- 1. قواعد الأولوية القصوى ---
{ keyword: 'رواتب مستحقة', category: 'liabilities', sub_category: 'accrued_expenses' },
{ keyword: 'اجور مستحقة', category: 'liabilities', sub_category: 'accrued_expenses' },
{ keyword: 'مراقبة', category: 'clearing', sub_category: 'monitoring_accounts' },
{ keyword: 'رقابة', category: 'clearing', sub_category: 'monitoring_accounts' },
{ keyword: 'مراقبات', category: 'clearing', sub_category: 'monitoring_accounts' },
{ keyword: 'حسابات رقابية', category: 'clearing', sub_category: 'monitoring_accounts' },
{ keyword: 'حساب رقابي', category: 'clearing', sub_category: 'monitoring_accounts' },
{ keyword: 'تسويات رقابية', category: 'clearing', sub_category: 'monitoring_accounts' },
{ keyword: 'رقابي', category: 'clearing', sub_category: 'monitoring_accounts' },
// ... (باقي القواعد ذات الأولوية) ...
    // --- 2. قواعد عامة ---
    { keyword: 'رواتب', category: 'expenses', sub_category: 'salaries' }, // هذه القاعدة العامة ستطبق فقط إذا لم توجد كلمة "مستحقة"
    // ... (باقي القواعد العامة) ...    { keyword: 'الأرباح والخساير المرحله', category: 'equity', sub_category: 'retained_earnings' }, // <-- تم نقلها هنا للأولوية القصوى
    { keyword: 'مستحقات ضريبة القيمة المضافة', category: 'liabilities', sub_category: 'vat_payable' },
    { keyword: 'مستحقات مصلحة الزكاة و الدخل', category: 'liabilities', sub_category: 'zakat_expense' },
    { keyword: 'خصم مكتسب', category: 'revenue', sub_category: 'other_revenue' },
    // **********************************
    
{ keyword: 'مجمع اهلاك مصاريف التاسيس', category: 'assets', sub_category: 'intangible_assets' },
    { keyword: 'مصاريف تاسيس النشاط', category: 'assets', sub_category: 'intangible_assets' },
    { keyword: 'اهلاك مصاريف التاسيس', category: 'expenses', sub_category: 'amortization' },
    { keyword: 'تكلفة المبيعات', category: 'expenses', sub_category: 'cogs' },
    { keyword: 'تكلفة الإيرادات', category: 'expenses', sub_category: 'cogs' },
    { keyword: 'مجمع إهلاك', category: 'assets', sub_category: 'fixed_assets' },
    { keyword: 'مجمع استهلاك', category: 'assets', sub_category: 'fixed_assets' },
    { keyword: 'مخصص ديون مشكوك فيها', category: 'assets', sub_category: 'trade_receivables' },
    { keyword: 'خصم مسموح به', category: 'revenue', sub_category: 'sales_discount' },
    { keyword: 'دفعات مقدمة للموردين', category: 'assets', sub_category: 'prepaid_expenses' },
    { keyword: 'دفعات مقدمة من العملاء', category: 'liabilities', sub_category: 'unearned_revenue' },
    { keyword: 'مستحقات ( فندق لامبرت)', category: 'liabilities', sub_category: 'accrued_expenses' },
    { keyword: 'مستحقات تبع شركات تابعة', category: 'assets', sub_category: 'related_parties_receivables' },
    { keyword: 'مصروفات مستحقة', category: 'liabilities', sub_category: 'accrued_expenses' },
    { keyword: 'إيرادات مستحقة', category: 'assets', sub_category: 'accrued_revenue' },
    { keyword: 'مصروف مقدم', category: 'assets', sub_category: 'prepaid_expenses' },
    { keyword: 'إيرادات غير مكتسبة', category: 'liabilities', sub_category: 'unearned_revenue' },
    { keyword: 'جارى', category: 'equity', sub_category: 'owners_current_account' },
    { keyword: 'جاري', category: 'equity', sub_category: 'owners_current_account' },
    { keyword: 'فروقات جرد', category: 'assets', sub_category: 'custody_accounts' },
    { keyword: 'فروق التسويات', category: 'equity', sub_category: 'retained_earnings' },
    { keyword: 'أصول شركات شقيقه', category: 'assets', sub_category: 'long_term_investments' },
    { keyword: 'حسين حسن الحرازي', category: 'assets', sub_category: 'trade_receivables' },
    { keyword: 'مؤسسه محمد مهدى', category: 'liabilities', sub_category: 'related_parties_payables' },
    { keyword: 'عهدة', category: 'assets', sub_category: 'custody_accounts' },
    { keyword: 'سلفة', category: 'assets', sub_category: 'employee_advances' },
    { keyword: 'مقدم متنوع', category: 'assets', sub_category: 'prepaid_expenses' },
    { keyword: 'مقدم مخزن', category: 'assets', sub_category: 'prepaid_expenses' },
    { keyword: 'برامج حاسب', category: 'assets', sub_category: 'intangible_assets' },
    { keyword: 'حسابات مراقبة', category: 'clearing', sub_category: 'clearing' },
    { keyword: 'مراقبة مخزن', category: 'clearing', sub_category: 'clearing' },
    { keyword: 'تمويل', category: 'liabilities', sub_category: 'long_term_loans' },

    // --- 2. قواعد عامة (يتم اختيار الأنسب منها) ---
    { keyword: 'ايراد', category: 'revenue', sub_category: 'main_revenue' },
    { keyword: 'مبيعات', category: 'revenue', sub_category: 'main_revenue' },
    { keyword: 'مشتريات', category: 'expenses', sub_category: 'cogs' },
    { keyword: 'رواتب', category: 'expenses', sub_category: 'salaries' },
    { keyword: 'أجور', category: 'expenses', sub_category: 'salaries' },
    { keyword: 'ايجار', category: 'expenses', sub_category: 'rent' },
    { keyword: 'كهرباء', category: 'expenses', sub_category: 'utilities' },
    { keyword: 'صيانة', category: 'expenses', sub_category: 'maintenance' },
    { keyword: 'محروقات', category: 'expenses', sub_category: 'fuel_transport' },
    { keyword: 'مصروف', category: 'expenses', sub_category: 'general_admin' },
    { keyword: 'مصاريف', category: 'expenses', sub_category: 'general_admin' },
    { keyword: 'صندوق', category: 'assets', sub_category: 'cash_on_hand' },
    { keyword: 'نقدية', category: 'assets', sub_category: 'cash_on_hand' },
    { keyword: 'بنك', category: 'assets', sub_category: 'cash_at_banks' },
    { keyword: 'عملاء', category: 'assets', sub_category: 'trade_receivables' },
    { keyword: 'مدينون', category: 'assets', sub_category: 'trade_receivables' },
    { keyword: 'مخزن', category: 'assets', sub_category: 'inventory' },
    { keyword: 'مخزون', category: 'assets', sub_category: 'inventory' },
    { keyword: 'مبنى', category: 'assets', sub_category: 'fixed_assets' },
    { keyword: 'شاحنات', category: 'assets', sub_category: 'fixed_assets' },
    { keyword: 'سيارات', category: 'assets', sub_category: 'fixed_assets' },
    { keyword: 'معدات', category: 'assets', sub_category: 'fixed_assets' },
    { keyword: 'أثاث', category: 'assets', sub_category: 'fixed_assets' },
    { keyword: 'أجهزة', category: 'assets', sub_category: 'fixed_assets' },
    { keyword: 'اصول', category: 'assets', sub_category: 'fixed_assets' },
    { keyword: 'موردين', category: 'liabilities', sub_category: 'trade_payables' },
    { keyword: 'مقاول', category: 'liabilities', sub_category: 'trade_payables' },
    { keyword: 'دائنون', category: 'liabilities', sub_category: 'trade_payables' },
    { keyword: 'قرض', category: 'liabilities', sub_category: 'long_term_loans' },
    { keyword: 'مخصص', category: 'liabilities', sub_category: 'provisions' },
    { keyword: 'رأس المال', category: 'equity', sub_category: 'capital' },
    { keyword: 'ارباح', category: 'equity', sub_category: 'retained_earnings' },
    { keyword: 'خسائر', category: 'equity', sub_category: 'retained_earnings' },
    { keyword: 'احتياطي', category: 'equity', sub_category: 'reserves' }
];
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', initializeApplication);

               // *** ضع هذا الجزء الجديد مكانه ***
// ==================================================================
// ==================================================================
// --- START: NEW & UPGRADED JAVASCRIPT FUNCTIONS ---
// ==================================================================

// -- Pre-computation Function --
function preProcessAccountAnalysis() {
    auditFile.trialBalance.forEach(account => {
        const bookBalance = (account.book_balance || 0);
        const adjustments = calculateAdjustments(account.account_id);
        const finalBalance = bookBalance + adjustments;
        const priorYearBalance = account.pyb || 0;

        // Calculate Variance
        let variance = 0;
        if (priorYearBalance !== 0) variance = ((finalBalance - priorYearBalance) / Math.abs(priorYearBalance)) * 100;
        else if (finalBalance !== 0) variance = 100.0;
        account.isHighVariance = Math.abs(variance) > VARIANCE_THRESHOLD;
        account.variance = variance;

        // Check for Abnormal Balance
        const isContra = (account.sub_category === 'accumulated_depreciation');
        let isAbnormal = false;
        if ((account.category === 'assets' && !isContra) && finalBalance < 0) isAbnormal = true;
        if ((account.category === 'liabilities' || account.category === 'equity' || isContra) && finalBalance > 0) isAbnormal = true;
        if (account.category === 'revenue' && finalBalance > 0 && !['sales_discount', 'sales_returns'].includes(account.sub_category)) isAbnormal = true;
        if (account.category === 'expenses' && finalBalance < 0) isAbnormal = true;
        account.isAbnormal = isAbnormal;
    });
}

// -- Main Rendering Orchestrator --
// هذا هو الكود الصحيح
function renderAll() {
    processAndRender(); // تم تصحيح اسم الدالة هنا
    updateCockpit();
}

// -- Audit Cockpit Functions --
function updateCockpit() {
    const highPriorityDiv = document.getElementById('cockpit-high-priority');
    const mediumPriorityDiv = document.getElementById('cockpit-medium-priority');
    highPriorityDiv.innerHTML = '';
    mediumPriorityDiv.innerHTML = '';

    let highPriorityCount = 0;
    let mediumPriorityCount = 0;

    auditFile.trialBalance.forEach(acc => {
        if (acc.isAbnormal) {
            highPriorityCount++;
            highPriorityDiv.innerHTML += createCockpitItem(acc, 'رصيد شاذ', 'danger');
        }
        if (!acc.category) {
            highPriorityCount++;
            highPriorityDiv.innerHTML += createCockpitItem(acc, 'غير مصنف', 'primary');
        }
        if (acc.isHighVariance && !acc.isAbnormal) {
            mediumPriorityCount++;
            mediumPriorityDiv.innerHTML += createCockpitItem(acc, `تغير ${acc.variance.toFixed(0)}%`, 'warning');
        }
    });

    // Check for depreciation task
    const depExpenseAccount = auditFile.trialBalance.find(a => a.sub_category === 'depreciation_expense');
    if (depExpenseAccount) {
        const depAdjustments = auditFile.adjustments.filter(adj => adj.debit_account === depExpenseAccount.account_id && adj.description.includes('إهلاك')).length;
        if (depAdjustments === 0) {
            mediumPriorityCount++;
            mediumPriorityDiv.innerHTML += `
                <div class="d-flex justify-content-between align-items-center p-2" style="border-radius: 8px;">
                    <span><i class="fas fa-calculator text-info me-2"></i>مهمة مقترحة: تسوية الأصول</span>
                    <button class="btn btn-sm btn-outline-info" onclick="openDepreciationWizard()">ابدأ التسوية</button>
                </div>
            `;
        }
    }

    if (highPriorityCount === 0) highPriorityDiv.innerHTML = '<p class="text-muted small">لا توجد مهام ذات أولوية قصوى. عمل رائع!</p>';
    if (mediumPriorityCount === 0) mediumPriorityDiv.innerHTML = '<p class="text-muted small">لا توجد مهام ذات أولوية ثانية.</p>';
}

// ==================================================================
// --- START: FINAL UPGRADE PACK V3.0 ---
// ==================================================================
// ==================================================================
// --- START: النسخة النهائية والمصححة من updateInspectorPane ---
// ==================================================================
function updateInspectorPane(accountId) {
    const account = auditFile.trialBalance.find(acc => String(acc.account_id) === String(accountId));
    if (!account) return;

    document.querySelectorAll('#trialBalanceTable tbody tr').forEach(r => r.classList.remove('table-active'));
    const activeRow = document.querySelector(`tr[data-account-id="${accountId}"]`);
    if (activeRow) activeRow.classList.add('table-active');

    // --- استعادة حسابات الحركة التفصيلية ---
    const ob_debit = account.ob_debit || 0;
    const ob_credit = account.ob_credit || 0;
    const moveDebit = account.move_debit || 0;
    const moveCredit = account.move_credit || 0;
    const bookBalance = (ob_debit + moveDebit) - (ob_credit + moveCredit);
    const adjustments = calculateAdjustments(accountId);
    const finalBalance = bookBalance + adjustments;
    const accountAdjustments = auditFile.adjustments.filter(adj => String(adj.debit_account) === String(accountId) || String(adj.credit_account) === String(accountId));

    // --- بناء قسم الملاحظات (من الترقية الأخيرة) ---
    let notesHTML = `<h6 class="mt-4">ملاحظات المراجع</h6>`;
    if (account.notes && account.notes.length > 0) {
        notesHTML += `<div class="list-group list-group-flush">`;
        account.notes.slice().reverse().forEach(note => {
            notesHTML += `
                <div class="p-2 mb-2" style="background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 3px solid var(--color-primary);">
                    <p class="mb-1 small">${note.text}</p>
                    <small class="text-muted">${new Date(note.timestamp).toLocaleString('ar-EG')}</small>
                </div>
            `;
        });
        notesHTML += `</div>`;
    } else {
        notesHTML += '<p class="text-muted small">لا توجد ملاحظات على هذا الحساب.</p>';
    }

    // --- بناء زر الإجراءات الخاصة (من الترقية الأخيرة) ---
    let specialActions = '';
    if (account.sub_category === 'fixed_assets') {
        specialActions = `<button class="btn btn-info w-100 mt-2" onclick="openDepreciationWizard()"><i class="fas fa-magic me-2"></i>المحلل الذكي للأصول</button>`;
    }

    // --- بناء المحتوى الكامل للوحة المفتش ---
    const content = document.getElementById('inspectorContent');
    content.innerHTML = `
        <h5 class="card-title font-family-display">${account.name || 'غير مسمى'}</h5>
        <p class="text-muted small">${account.account_id}</p>

        <!-- استعادة تفاصيل الحركة الكاملة -->
        <h6 class="mt-4">تفاصيل حركة الحساب</h6>
        <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between align-items-center" style="background: none; border-color: var(--color-border);">
                <span>رصيد أول المدة (مدين)</span>
                <span class="badge bg-secondary rounded-pill">${formatCurrency(ob_debit)}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center" style="background: none; border-color: var(--color-border);">
                <span>رصيد أول المدة (دائن)</span>
                <span class="badge bg-secondary rounded-pill">${formatCurrency(ob_credit)}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center" style="background: none; border-color: var(--color-border);">
                <span>(+) إجمالي الحركة المدينة</span>
                <span class="text-success fw-bold">+ ${formatCurrency(moveDebit)}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center" style="background: none; border-color: var(--color-border);">
                <span>(-) إجمالي الحركة الدائنة</span>
                <span class="text-danger fw-bold">- ${formatCurrency(moveCredit)}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center fw-bold" style="background-color: rgba(255,255,255,0.05); border-color: var(--color-border);">
                <span>= الرصيد الدفتري</span>
                <span>${formatCurrency(bookBalance)}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center" style="background: none; border-color: var(--color-border);">
                <span>(+/-) قيود التسوية</span>
                <span class="badge bg-warning text-dark rounded-pill">${formatCurrency(adjustments)}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center fw-bold fs-5" style="background-color: var(--color-primary-glow); border-color: var(--color-primary);">
                <span>= الرصيد النهائي</span>
                <span>${formatCurrency(finalBalance)}</span>
            </li>
        </ul>
        
        <!-- الأزرار والميزات الجديدة -->
        <div class="d-grid gap-2 mt-3">
            <button class="btn btn-primary" onclick="openVAIModal('${accountId}')"><i class="fas fa-user-secret me-2"></i>استشارة الخبير التنفيذي</button>
            <button class="btn btn-outline-secondary" onclick="addNote('${accountId}')"><i class="fas fa-comment-dots me-2"></i>إضافة ملاحظة</button>
            ${specialActions}
        </div>
        
        <h6 class="mt-4">سجل قيود التسوية</h6>
        <div class="adjustments-container" style="max-height: 150px; overflow-y: auto;">
             ${accountAdjustments.length > 0 ? 
                accountAdjustments.map(adj => {
                    const debitName = auditFile.trialBalance.find(a => a.account_id === adj.debit_account)?.name || 'حساب محذوف';
                    const creditName = auditFile.trialBalance.find(a => a.account_id === adj.credit_account)?.name || 'حساب محذوف';
                    return `<div class="p-2 mb-1 small" style="background: rgba(0,0,0,0.2); border-radius: 4px;">
                                <strong>${adj.description}:</strong> ${formatCurrency(adj.amount)}
<div class="text-muted small">من ح/ ${debitName} إلى ح/ ${creditName}</div>
<div class="d-flex gap-1 mt-1">
    <button class="btn btn-sm btn-outline-primary" onclick="openAjeModal(null, '${adj.id}')">
        <i class="fas fa-edit"></i> تعديل
    </button>
    <button class="btn btn-sm btn-outline-warning" onclick="reverseAdjustment('${adj.id}')">
        <i class="fas fa-exchange-alt"></i> عكس
    </button>
    <button class="btn btn-sm btn-outline-danger" onclick="deleteAdjustment('${adj.id}')">
        <i class="fas fa-trash"></i> حذف
</div></button>                            </div>`;
                }).join('') 
                : '<p class="text-muted small">لا توجد قيود تسوية.</p>'
            }
        </div>
        
        ${notesHTML}
    `;
}
// ==================================================================
// --- END: النسخة النهائية والمصححة من updateInspectorPane ---
// ==================================================================
// ==================================================================
// --- START: الإصلاح النهائي لدوال الخبير التنفيذي ---
// ==================================================================

// ==================================================================
// --- START: الإصلاح النهائي لدالة فتح نافذة الخبير ---
// ==================================================================
function openVAIModal(accountId) {
    const account = auditFile.trialBalance.find(acc => acc.account_id === accountId);
    if (!account) {
        alert('خطأ: لم يتم العثور على الحساب.');
        return;
    }

    // تخزين السياق الحالي ليستخدمه الخبير
    currentVAIContext = { id: account.account_id };
    
    // إفراغ المحتوى القديم وتجهيز النافذة
    document.getElementById('vAIAssistantResponse').innerHTML = '<div class="text-center p-4"><div class="spinner-border" role="status"></div><p class="mt-2">الخبير يقوم بتحليل الحساب...</p></div>';
    document.getElementById('vAIActionButtons').innerHTML = '';
    
    // تغيير عنوان النافذة
    const modalTitle = document.querySelector('#vAIAssistantModal .modal-title');
    if(modalTitle) modalTitle.textContent = `استشارة الخبير حول: ${account.name}`;

    // فتح النافذة
    vAIAssistantModal.show();
    
    // استدعاء الخبير للقيام بالتحليل
    setTimeout(getVAIResponse, 500);
}
// ==================================================================
// --- END: الإصلاح النهائي لدالة فتح نافذة الخبير ---
// ==================================================================

function getVAIResponse() {
    const responseDiv = document.getElementById('vAIAssistantResponse');
    const actionsDiv = document.getElementById('vAIActionButtons');
    
    const account = auditFile.trialBalance.find(acc => acc.account_id === currentVAIContext.id);
    if (!account) {
        responseDiv.innerHTML = '<p class="text-danger">خطأ: انقطع الاتصال ببيانات الحساب.</p>';
        return;
    }

    // --- 1. بناء قسم التشخيص ---
    let analysisHTML = `<h6><i class="fas fa-stethoscope me-2"></i>1. تشخيص الوضع</h6><ul>`;
    let procedures = [];
    let hasHighRisk = false;

    if (account.isAbnormal) {
        hasHighRisk = true;
        analysisHTML += `<li><strong class="text-danger">⚠️ علامة خطر: تم اكتشاف رصيد شاذ.</strong> (الرصيد يخالف طبيعة الحساب)</li>`;
        procedures.push("تحليل مكونات الرصيد لتحديد سبب الرصيد الشاذ.");
        procedures.push("اقتراح قيد إعادة تصنيف (RCE) إذا لزم الأمر.");
    }
    if (account.isHighVariance) {
        hasHighRisk = true;
        analysisHTML += `<li><strong class="text-warning">💡 علامة تنبيه: تم اكتشاف تغير جوهري بنسبة ${account.variance.toFixed(0)}% مقارنة بالعام السابق.</strong></li>`;
        procedures.push("الاستفسار من الإدارة عن أسباب هذا التغير الكبير وتوثيق ردهم.");
    }
    if (!account.category) {
        analysisHTML += `<li><strong class="text-primary">🔵 ملاحظة: الحساب غير مصنف.</strong> (يجب تحديد الفئة والتصنيف الفرعي)</li>`;
        procedures.push("تحديد الفئة والتصنيف الفرعي المناسبين للحساب من الجدول الرئيسي.");
    }
    if (!hasHighRisk && account.category) {
        analysisHTML += `<li><strong class="text-success">✅ مؤشر أولي: لم يتم اكتشاف علامات خطر واضحة.</strong> (الرصيد والتغير ضمن الحدود المتوقعة)</li>`;
    }
    analysisHTML += `</ul>`;

    // --- 2. بناء قسم الإجراءات المقترحة ---
    analysisHTML += `<h6 class="mt-3"><i class="fas fa-tasks me-2"></i>2. الإجراءات المقترحة</h6><ol>`;
    if (account.sub_category && councilKnowledgeBase.specificRisks[account.sub_category]) {
        councilKnowledgeBase.specificRisks[account.sub_category].forEach(risk => procedures.push(risk.split(':')[1].trim()));
    }
    procedures.push("الحصول على المستندات المؤيدة (أوراق العمل) وتوثيقها.");
    
    // إزالة الإجراءات المكررة وعرضها
    [...new Set(procedures)].forEach(proc => { analysisHTML += `<li>${proc}</li>`; });
    analysisHTML += `</ol>`;

    // --- 3. بناء أزرار الإجراءات السريعة ---
    let actionsHTML = `
        <h6 class="mt-4"><i class="fas fa-play-circle me-2"></i>ابدأ التنفيذ</h6>
        <button class="btn btn-sm btn-outline-secondary me-2" onclick="addNote('${account.account_id}', 'بخصوص الاستفسار عن: ')">
            <i class="fas fa-comment-dots me-1"></i>إضافة ملاحظة
        </button>
        <button class="btn btn-sm btn-outline-secondary me-2" onclick="openAjeModal('${account.account_id}')">
            <i class="fas fa-exchange-alt me-1"></i>إنشاء قيد
        </button>
        <button class="btn btn-sm btn-outline-secondary" onclick="alert('سيتم فتح نافذة أوراق العمل')">
            <i class="fas fa-paperclip me-1"></i>إرفاق مستند
        </button>
    `;
    
    // عرض النتائج النهائية
    responseDiv.innerHTML = analysisHTML;
    actionsDiv.innerHTML = actionsHTML;
}
// ==================================================================
// --- END: الإصلاح النهائي لدوال الخبير التنفيذي ---
// ==================================================================

// ==================================================================
// --- START: النسخة التفاعلية من createCockpitItem (V2) ---
// ==================================================================
function createCockpitItem(account, reason, color) {
    // قمنا بتغليف العنصر بالكامل في <div> قابل للضغط ويستدعي دالة focusOnAccount
    return `
        <div class="d-flex justify-content-between align-items-center p-2 cockpit-item" 
             onclick="focusOnAccount('${account.account_id}')" 
             title="اضغط للانتقال إلى هذا الحساب">
            
            <span>
                <i class="fas fa-circle text-${color} me-2" style="font-size: 0.5rem;"></i>
                ${account.name} 
                <small class="text-muted">(${reason})</small>
            </span>
            
            <i class="fas fa-arrow-left text-secondary action-arrow"></i>
        </div>
    `;
}
// ==================================================================
// --- END: النسخة التفاعلية ---
// ==================================================================

// --- الدالة الجديدة لإضافة الملاحظات ---
function addNote(accountId, defaultText = '') {
    const noteText = prompt("أدخل ملاحظتك على الحساب:", defaultText);
    if (noteText && noteText.trim() !== '') {
        const account = auditFile.trialBalance.find(acc => acc.account_id === accountId);
        if (account) {
            if (!account.notes) account.notes = [];
            account.notes.push({
                text: noteText.trim(),
                timestamp: new Date().toISOString()
            });
            saveAuditFile();
            updateInspectorPane(accountId); // تحديث لوحة المفتش لعرض الملاحظة الجديدة
        }
    }
}
// ==================================================================
// --- END: FINAL UPGRADE PACK V3.0 ---
// ==================================================================
// ==================================================================
// --- START: دالة التركيز على الحساب (V4 - مع تظليل دائم) ---
// ==================================================================
function focusOnAccount(accountId) {
    const row = document.querySelector(`tr[data-account-id="${accountId}"]`);
    if (row) {
        // 1. الانتقال السلس إلى الصف في الجدول
        row.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // 2. بعد الانتقال، قم بتنفيذ الإجراءات
        setTimeout(() => {
            // 3. (الأهم) إزالة التظليل من أي صف آخر كان مظللاً
            document.querySelectorAll('.cockpit-focus').forEach(el => el.classList.remove('cockpit-focus'));

            // 4. إضافة التظليل الدائم إلى الصف الجديد
            row.classList.add('cockpit-focus');

            // 5. انقر على الصف لفتح تفاصيله في لوحة المفتش
            // هذا سيضيف كلاس .table-active أيضاً
            row.click();
        }, 300); // انتظر 300 مللي ثانية لضمان سلاسة الحركة
    }
}
// ==================================================================
// --- END: دالة التركيز على الحساب ---
// ==================================================================
// ==================================================================
// --- END: دالة التركيز على الحساب ---
// ==================================================================
// ==================================================================
// --- END: دالة التركيز على الحساب ---
// ==================================================================

// -- Depreciation Wizard Functions --
function openDepreciationWizard() {
    let totalAssetsCost = 0;
    let depreciationMovement = 0;

    const fixedAssetAccounts = auditFile.trialBalance.filter(acc => acc.sub_category === 'fixed_assets');
    totalAssetsCost = fixedAssetAccounts.reduce((sum, acc) => sum + (acc.book_balance || 0), 0);

    const depExpenseAccount = auditFile.trialBalance.find(acc => acc.sub_category === 'depreciation_expense');
    if (depExpenseAccount) {
        depreciationMovement = (depExpenseAccount.move_debit || 0) - (depExpenseAccount.move_credit || 0);
    }

    document.getElementById('autoReadAssets').textContent = formatCurrency(totalAssetsCost);
    document.getElementById('autoReadDepreciationMovement').textContent = formatCurrency(depreciationMovement);
    document.getElementById('depreciationRate').value = '';
    calculateDepreciation(); // Reset calculation fields
    depreciationWizardModal.show();
}

// === عكس قيد التسوية ===
function reverseAdjustment(adjustmentId) {
    if (!confirm("هل أنت متأكد من رغبتك في عكس هذا القيد؟ سيتم إنشاء قيد معاكس بنفس المبلغ.")) return;

    const original = auditFile.adjustments.find(a => a.id === adjustmentId);
    if (!original) {
        alert("لم يتم العثور على القيد الأصلي.");
        return;
    }

    const reversed = {
        id: `ADJ-${Date.now()}`,
        type: original.type,
        description: `عكس قيد: ${original.description}`,
        debit_account: original.credit_account,   // عكس المدين والدائن
        credit_account: original.debit_account,
        amount: original.amount,
        timestamp: new Date().toISOString()
    };

    auditFile.adjustments.push(reversed);
    saveAuditFile();
    processAndRender();

    // تحديث لوحة المفتش إذا كان الحساب لا يزال مفتوحًا
    const activeRow = document.querySelector('#trialBalanceTable tr.table-active');
    if (activeRow) updateInspectorPane(activeRow.dataset.accountId);

    alert("تم عكس القيد بنجاح.");
}

// === حذف قيد التسوية ===
function deleteAdjustment(adjustmentId) {
    if (!confirm("هل أنت متأكد من حذف هذا القيد نهائيًا؟")) return;

    const index = auditFile.adjustments.findIndex(a => a.id === adjustmentId);
    if (index === -1) {
        alert("القيد غير موجود.");
        return;
    }

    const deleted = auditFile.adjustments.splice(index, 1)[0];
    addAuditLogEntry(`تم حذف قيد ${deleted.type}: ${deleted.description}`);
    saveAuditFile();
    processAndRender();

    const activeRow = document.querySelector('#trialBalanceTable tr.table-active');
    if (activeRow) updateInspectorPane(activeRow.dataset.accountId);

    alert("تم حذف القيد بنجاح.");
}

function calculateDepreciation() {
    const totalAssetsCost = parseFloat(document.getElementById('autoReadAssets').textContent.replace(/[^0-9.-]+/g,""));
    const depreciationMovement = parseFloat(document.getElementById('autoReadDepreciationMovement').textContent.replace(/[^0-9.-]+/g,""));
    const rate = parseFloat(document.getElementById('depreciationRate').value) || 0;

    const totalRequired = totalAssetsCost * (rate / 100);
    const netAdjustment = totalRequired - depreciationMovement;

    document.getElementById('totalRequiredDepreciation').textContent = formatCurrency(totalRequired);
    document.getElementById('alreadyBookedDepreciation').textContent = formatCurrency(depreciationMovement);
    document.getElementById('netAdjustmentNeeded').textContent = formatCurrency(netAdjustment);
}

function createDepreciationAdjustmentEntry() {
    const netAdjustment = parseFloat(document.getElementById('netAdjustmentNeeded').textContent.replace(/[^0-9.-]+/g,""));
    if (netAdjustment <= 0) {
        alert("لا يوجد قيد تسوية مطلوب أو أن المبلغ سالب.");
        return;
    }

    const expenseAccount = auditFile.trialBalance.find(a => a.sub_category === 'depreciation_expense');
    const accumulatedAccount = auditFile.trialBalance.find(a => a.sub_category === 'accumulated_depreciation');

    if (!expenseAccount || !accumulatedAccount) {
        alert("خطأ: يجب تصنيف حساب 'مصروف الإهلاك' و 'مجمع الإهلاك' أولاً.");
        return;
    }

    const adjustment = {
        id: `ADJ-${Date.now()}`,
        type: 'AJE',
        description: `قيد تسوية إهلاك الأصول السنوي`,
        debit_account: expenseAccount.account_id,
        credit_account: accumulatedAccount.account_id,
        amount: netAdjustment,
        timestamp: new Date().toISOString()
    };

    auditFile.adjustments.push(adjustment);
    saveAuditFile();
    depreciationWizardModal.hide();
    
    // Refresh everything
    preProcessAccountAnalysis();
    renderAll();
    alert("تم إنشاء قيد تسوية الإهلاك بنجاح!");
}

// -- Helper function to save file --
function saveAuditFile() {
    const clientId = localStorage.getItem('activeClientId');
    PolarisDataFlow.save('trial-balance', { clientId, auditFile }); // dataPipeline
    localStorage.setItem(`polarisAuditFile_v6_${clientId}`, JSON.stringify(auditFile)); // توافق قديم
    console.log('✅ حفظ موحد – dataPipeline + localStorage');
}// ==================================================================
// --- END: NEW & UPGRADED JAVASCRIPT FUNCTIONS ---
// ==================================================================
// ==================================================================
// --- دالة حفظ بيانات تعيين الحسابات للتقارير ---
// ==================================================================
function saveMappingDataForReports() {
    try {
        const activeClientId = localStorage.getItem('activeClientId');
        if (!activeClientId) {
            console.error("لا يوجد عميل نشط لحفظ البيانات");
            return;
        }

        // تجهيز البيانات اللازمة للتقارير
        const mappingData = {
            finalized: true,
            finalizedAt: new Date().toISOString(),
            accounts: auditFile.trialBalance.map(acc => ({
                accountNumber: acc.account_id,
                accountName: acc.name,
                debitBalance: acc.book_balance > 0 ? acc.book_balance : 0,
                creditBalance: acc.book_balance < 0 ? Math.abs(acc.book_balance) : 0,
                category: acc.category,
                subCategory: acc.sub_category,
                finalBalance: (acc.book_balance || 0) + calculateAdjustments(acc.account_id),
                reviewStatus: acc.review_status
            })),
            adjustments: auditFile.adjustments || [],
            clientInfo: auditFile.clientInfo,
            settings: auditFile.settings || {},
            financials: calculateNetProfit(true)
        };

        // حفظ البيانات للتقارير
        localStorage.setItem(`accountMappingData_${activeClientId}`, JSON.stringify(mappingData));
        console.log("✅ تم حفظ بيانات تعيين الحسابات للتقارير");
        
    } catch (error) {
        console.error("خطأ في حفظ بيانات التعيين:", error);
    }
}

// ==================================================================
// --- تعديل دالة navigateToConsolidation لاستدعاء الحفظ ---
// ==================================================================
// ================================================================
// --- دالة الاعتماد والانتقال (النسخة النهائية والمصححة) ---
// ================================================================
function navigateToConsolidation() {
    if (!confirm("هل أنت متأكد من اعتماد الميزان والانتقال للقوائم المالية؟ سيتم أرشفة الأرصدة الحالية للمقارنات المستقبلية.")) {
        return;
    }

    const activeClientId = localStorage.getItem('activeClientId');
    if (!activeClientId) {
        alert("خطأ فادح: لا يمكن العثور على معرّف العميل النشط!");
        return;
    }

    // 1. حفظ بيانات العرض الحالية للتقارير
    const mappingSaved = saveMappingDataForReports();
    if (!mappingSaved) {
        alert("فشل حفظ بيانات التعيين الحالية. لا يمكن المتابعة.");
        return;
    }

    // 2. أرشفة البيانات للمقارنة (استدعاء الدالة التي لديك بالفعل)
    archiveForNextYear(false); // استدعاء الأرشفة بدون رسالة منبثقة للمستخدم

    // 3. حفظ الحالة النهائية لملف المراجعة
    addAuditLogEntry("تم اعتماد ميزان المراجعة والانتقال لمرحلة القوائم المالية.");
    saveAuditFile();
    
    // 4. الانتقال إلى صفحة القوائم المالية الأساسية
    console.log("🚀 الانتقال إلى صفحة القوائم المالية الأساسية (Cockpit)...");
    window.location.href = `consolidation-cockpit.html?clientId=${activeClientId}`;
}
// ==================================================================
// --- النسخة النهائية والمصححة من initializeApplication (V3) ---
// ==================================================================
function initializeApplication() {
    // تهيئة النوافذ المنبثقة (Modals)
    ajeModal = new bootstrap.Modal(document.getElementById('ajeModal'));
    materialityModal = new bootstrap.Modal(document.getElementById('materialityModal'));
    vAIAssistantModal = new bootstrap.Modal(document.getElementById('vAIAssistantModal'));
    workpapersModal = new bootstrap.Modal(document.getElementById('workpapersModal'));

    // --- معادلة الربط النهائية ---
    const activeClientId = localStorage.getItem('activeClientId');
    if (!activeClientId) {
        handleFatalError('<h4>خطأ فادح: لم يتم العثور على عميل نشط.</h4><p>الرجاء العودة لصفحة "تأسيس الكيانات" أولاً.</p>');
        return;
    }
    
    // 1. ابحث عن الحقيبة الحقيقية القادمة من صفحة الاستيعاب
    const realDataKey = `polarisAuditFile_${activeClientId}`;
    const savedAuditFile = localStorage.getItem(realDataKey);

    if (savedAuditFile) {
        console.log("✅ تم العثور على بيانات حقيقية! جاري تحميلها.");
        auditFile = JSON.parse(savedAuditFile);
        
        // التأكد من أن البيانات تحتوي على الحقول اللازمة
        auditFile.settings = auditFile.settings || {};
        auditFile.adjustments = auditFile.adjustments || [];
        auditFile.auditLog = auditFile.auditLog || [];
        
        // دمج بيانات المقارنة للسنة السابقة إن وجدت
        const comparisonYear = new Date(auditFile.clientInfo.endDate).getFullYear() - 1;
        const comparisonKey = `comparisonData_${activeClientId}_${comparisonYear}`;
        const comparisonDataJSON = localStorage.getItem(comparisonKey);
        
        if (comparisonDataJSON) {
            console.log(`✅ تم العثور على بيانات مقارنة للعام ${comparisonYear}.`);
            const comparisonData = JSON.parse(comparisonDataJSON);
            auditFile.trialBalance.forEach(acc => {
                const priorAcc = comparisonData.accounts.find(pAcc => pAcc.account_id === acc.account_id);
                if (priorAcc) {
                    acc.pyb = (priorAcc.ob_debit || 0) - (priorAcc.ob_credit || 0);
                }
            });
        }

        // معالجة مسبقة للحسابات (حساب الفروقات والأرصدة الشاذة)
        preProcessAccountAnalysis();

    } else {
        handleFatalError('<h4>خطأ: لم يتم العثور على ملف المراجعة.</h4><p>الرجاء التأكد من إكمال خطوة استيعاب البيانات أولاً.</p>');
        return;
    }
    
    // 3. استكمل تشغيل الصفحة كالمعتاد بالبيانات الصحيحة
    autoCategorizeAccounts();
    userPrefs = loadUserPrefs(activeClientId);
    setupEventListeners();
    
    // --- الإصلاح هنا: استدعاء الدالة الشاملة التي تحدث كل شيء ---
    renderAll(); 
    
    document.getElementById('loader').style.display = 'none';
    document.getElementById('appContainer').style.display = 'block';
}

// ==================================================================
// --- END: النسخة النهائية والمصححة من initializeApplication ---
// ==================================================================


        function saveAuditFile() {
    try {
        // **الإصلاح الجوهري: استخدام نفس مفتاح العميل النشط للحفظ**
        const activeClientId = localStorage.getItem('activeClientId');
        if (!activeClientId) {
            console.error("CRITICAL: Cannot save file. No active client ID found.");
            return; // منع الحفظ بدون معرّف
        }
        const realDataKey = `polarisAuditFile_${activeClientId}`;
        localStorage.setItem(realDataKey, JSON.stringify(auditFile));
        console.log(`✅ Audit file saved successfully to key: ${realDataKey}`);
    } catch (e) {
        console.error("CRITICAL: Failed to save audit file!", e);
        alert("خطأ حرج في حفظ ملف المراجعة. قد يكون حد التخزين ممتلئ.");
    }
}

// ==================================================================
// --- دالة حفظ بيانات تعيين الحسابات للتقارير ---
// ==================================================================
function saveMappingDataForReports() {
    try {
        const activeClientId = localStorage.getItem('activeClientId');
        if (!activeClientId) {
            console.error("لا يوجد عميل نشط لحفظ البيانات");
            return;
        }

        console.log("💾 بدء حفظ بيانات التعيين للتقارير...");

        // تجهيز البيانات اللازمة للتقارير
        const mappingData = {
            finalized: true,
            finalizedAt: new Date().toISOString(),
            accounts: auditFile.trialBalance.map(acc => {
                const finalBalance = (acc.book_balance || 0) + calculateAdjustments(acc.account_id);
                return {
                    accountNumber: acc.account_id,
                    accountName: acc.name || 'غير مسمى',
                    debitBalance: finalBalance > 0 ? finalBalance : 0,
                    creditBalance: finalBalance < 0 ? Math.abs(finalBalance) : 0,
                    category: acc.category,
                    subCategory: acc.sub_category,
                    finalBalance: finalBalance,
                    reviewStatus: acc.review_status || 'pending'
                };
            }),
            adjustments: auditFile.adjustments || [],
            clientInfo: auditFile.clientInfo || { id: activeClientId, name: 'عميل غير محدد' },
            settings: auditFile.settings || {},
            financials: calculateNetProfit(true),
            auditLog: auditFile.auditLog || []
        };

        // حفظ البيانات للتقارير
        const mappingKey = `accountMappingData_${activeClientId}`;
        localStorage.setItem(mappingKey, JSON.stringify(mappingData));
        
        console.log("✅ تم حفظ بيانات تعيين الحسابات للتقارير في:", mappingKey);
        console.log("📊 عدد الحسابات المحفوظة:", mappingData.accounts.length);
        
        return true;
        
    } catch (error) {
        console.error("❌ خطأ في حفظ بيانات التعيين:", error);
        return false;
    }
}
        function loadUserPrefs(clientId) {
            const prefsKey = `polarisUserPrefs_${clientId}`;
            const savedPrefs = localStorage.getItem(prefsKey);
            try {
                return savedPrefs ? JSON.parse(savedPrefs) : { filterCategory: 'all', filterStatus: 'all', searchTerm: '' };
            } catch (e) {
                return { filterCategory: 'all', filterStatus: 'all', searchTerm: '' };
            }
        }

               function setupEventListeners() {
            document.getElementById('clientNameSubtitle').textContent = auditFile.clientInfo.name || 'عميل غير محدد';
            document.getElementById('filterCategory').value = userPrefs.filterCategory;
            document.getElementById('filterStatus').value = userPrefs.filterStatus;
            document.getElementById('searchInput').value = userPrefs.searchTerm;

            document.getElementById('filterCategory').addEventListener('change', (e) => { userPrefs.filterCategory = e.target.value; saveUserPrefs(); processAndRender(); });
            document.getElementById('filterStatus').addEventListener('change', (e) => { userPrefs.filterStatus = e.target.value; saveUserPrefs(); processAndRender(); });
            document.getElementById('searchInput').addEventListener('input', (e) => { userPrefs.searchTerm = e.target.value; saveUserPrefs(); processAndRender(); });
            
            document.getElementById('materialityBasis').addEventListener('change', (e) => {
                document.getElementById('fixedAmountInput').style.display = e.target.value === 'fixed' ? 'block' : 'none';
            });
            
            // *** التغيير هنا: ربط الزر الجديد بالوظيفة الجديدة ***
            document.getElementById('logicalCheckButton').addEventListener('click', performLogicalCheck);
            
            document.getElementById('saveChangesButton').addEventListener('click', saveChangesManually);
            document.getElementById('exportButton').addEventListener('click', exportToExcel);
setupAjeModal();
      }
        function performLogicalCheck() {
            const rows = document.querySelectorAll('#trialBalanceTable tbody tr');
            let abnormalCount = 0;
            let unclassifiedCount = 0;

            rows.forEach(row => {
                // إزالة التظليل القديم أولاً
                row.classList.remove('abnormal-balance', 'unclassified-account');

                const accountId = row.dataset.accountId;
                const account = auditFile.trialBalance.find(acc => String(acc.account_id) === String(accountId));
                if (!account) return;

                const finalBalance = (account.book_balance || 0) + calculateAdjustments(account.account_id);

                // 1. تدقيق الحسابات غير المصنفة
                if (!account.category) {
                    row.classList.add('unclassified-account');
                    unclassifiedCount++;
                }

                // 2. تدقيق الأرصدة الشاذة
                const isAsset = account.category === 'assets';
                const isLiabilityOrEquity = account.category === 'liabilities' || account.category === 'equity';
                const isRevenue = account.category === 'revenue' && !['sales_discount', 'sales_returns'].includes(account.sub_category);
                const isContraRevenue = ['sales_discount', 'sales_returns'].includes(account.sub_category);
                const isExpense = account.category === 'expenses';

                let isAbnormal = false;
                if (isAsset && finalBalance < 0) isAbnormal = true;
                if (isLiabilityOrEquity && finalBalance > 0) isAbnormal = true;
                if (isRevenue && finalBalance > 0) isAbnormal = true;
                if (isContraRevenue && finalBalance < 0) isAbnormal = true;
                if (isExpense && finalBalance < 0) isAbnormal = true;
                
                if (isAbnormal) {
                    row.classList.add('abnormal-balance');
                    abnormalCount++;
                }
            });

            // عرض رسالة للمستخدم بنتيجة التدقيق
            alert(`تم الانتهاء من التدقيق.\n\n- تم العثور على ${abnormalCount} حسابات ذات أرصدة شاذة (مظللة بالأحمر).\n- تم العثور على ${unclassifiedCount} حسابات غير مصنفة (مظللة بالأزرق).`);
            addAuditLogEntry("تم إجراء تدقيق منطقية الأرصدة.");
            saveAuditFile();
        }


// ==================================================================
// --- دالة التصنيف التلقائي (V4) - منطق البحث عن أفضل تطابق ---
// ==================================================================
function autoCategorizeAccounts() {
    if (!auditFile.learningDb) {
        auditFile.learningDb = {};
    }

    const rangeRules = [
        { startsWith: '10107', category: 'assets', sub_category: 'custody_accounts' },
        { startsWith: '10106', category: 'assets', sub_category: 'employee_advances' },
        { startsWith: '102', category: 'assets', sub_category: 'fixed_assets' },
        { startsWith: '20108', category: 'equity', sub_category: 'owners_current_account' },
        { startsWith: '303', category: 'expenses', sub_category: 'cogs' },
        { startsWith: '401', category: 'revenue', sub_category: 'main_revenue' },
        { startsWith: '5', category: 'expenses', sub_category: 'general_admin' },
    ];

    auditFile.trialBalance.forEach(account => {
        if (account.category && account.is_confirmed) return;
        const accountId = String(account.account_id);
        const accountName = account.name ? account.name.toLowerCase().trim() : '';
        if (!accountName && !accountId) return;

        if (auditFile.learningDb[accountName]) {
            const learned = auditFile.learningDb[accountName];
            account.category = learned.category;
            account.sub_category = learned.sub_category;
            account.is_confirmed = false;
            return;
        }

        for (const rule of rangeRules) {
            if (accountId.startsWith(rule.startsWith)) {
                account.category = rule.category;
                account.sub_category = rule.sub_category;
                account.is_confirmed = false;
                return;
            }
        }

        let bestMatch = null;
        let highestScore = 0;
        for (const mapping of keywordMapping) {
            if (accountName.includes(mapping.keyword)) {
                const score = mapping.keyword.length;
                if (score > highestScore) {
                    highestScore = score;
                    bestMatch = mapping;
                }
            }
        }

        if (bestMatch) {
            account.category = bestMatch.category;
            account.sub_category = bestMatch.sub_category;
            account.is_confirmed = false;
        }
    });
    
    addAuditLogEntry("تم إجراء تصنيف تلقائي بالذكاء السياقي (V3).");
    saveAuditFile();
}

        function processAndRender() {
    // 1. احصل على الجزء المخصص لعرض صفوف الجدول
    const tbody = document.querySelector('#trialBalanceTable tbody');
    
    // 2. قم بإفراغه بالكامل من الصفوف القديمة
    tbody.innerHTML = ''; 
    
    // 3. قم بفلترة الحسابات بناءً على الاختيارات الحالية
    const filteredAccounts = filterAccounts();
    
    // 4. قم بإنشاء صف جديد لكل حساب وقم بإضافته إلى الجدول
    filteredAccounts.forEach(account => {
        const row = createAccountRow(account); // هذه الدالة ستقوم ببناء الصفوف الجديدة
        tbody.appendChild(row);
    });
    
    // 5. قم بتحديث الأشرطة السفلية بالأرقام الجديدة
    updateStatusBar();
    updateKpiPane();
}

        // FIXED: Search logic now works correctly.
        // ضع هذه الدالة الجديدة والذكية مكانها

// ==================================================================
// --- START: CLEAN CODE BLOCK TO PASTE ---
// ==================================================================

function filterAccounts() {
    const searchTerm = userPrefs.searchTerm.toLowerCase().trim();
    
    return auditFile.trialBalance.filter(account => {
        if (!account || !account.account_id) return false;

        // --- Filter Logic ---
        const categoryFilterMatch = userPrefs.filterCategory === 'all' || 
            (userPrefs.filterCategory === 'unclassified' ? !account.category : account.category === userPrefs.filterCategory);

        const statusFilterMatch = userPrefs.filterStatus === 'all' || account.review_status === userPrefs.filterStatus;

        // --- Smart Search Logic ---
        if (searchTerm === '') {
            return categoryFilterMatch && statusFilterMatch;
        }

        const categoryLabel = account.category ? getCategoryLabel(account.category).toLowerCase() : '';
        const subCategoryLabel = (account.category && account.sub_category && subCategoryMap[account.category]) 
            ? (subCategoryMap[account.category].find(sc => sc.value === account.sub_category)?.label.toLowerCase() || '') 
            : '';

        const searchMatch = 
            (account.name && account.name.toLowerCase().includes(searchTerm)) || 
            (account.account_id && String(account.account_id).toLowerCase().includes(searchTerm)) ||
            (categoryLabel && categoryLabel.includes(searchTerm)) ||
            (subCategoryLabel && subCategoryLabel.includes(searchTerm));

        return categoryFilterMatch && statusFilterMatch && searchMatch;
    });
}

// ==================================================================
// --- START: FUNCTIONALITY FIX FOR createAccountRow ---
// ==================================================================
    // ==================================================================
// --- START: النسخة المطورة من createAccountRow مع التحليل المقارن ---
// ==================================================================
// ==================================================================
// --- START: النسخة المطورة من createAccountRow مع التحليل المقارن ---
// ==================================================================

function createAccountRow(account) {
    const adjustments = calculateAdjustments(account.account_id);
    const bookBalance = account.book_balance || 0;
    const finalBalance = bookBalance + adjustments;
    const priorYearBalance = account.pyb || 0; // الحصول على رصيد السنة السابقة

    // حساب نسبة التغير
    let variance = 0;
    let varianceClass = '';
    if (priorYearBalance !== 0) {
        // الحالة الطبيعية: الرصيد السابق ليس صفراً
        variance = ((finalBalance - priorYearBalance) / Math.abs(priorYearBalance)) * 100;
    } else if (finalBalance !== 0) {
        // الحالة الخاصة: الرصيد السابق صفر والحالي ليس صفراً
        variance = 100.0; 
    }

    // تحديد إذا كان التغير جوهرياً (يمكنك تعديل النسبة 25 حسب الحاجة)
    const VARIANCE_THRESHOLD = 25; 
    if (Math.abs(variance) > VARIANCE_THRESHOLD) {
        varianceClass = 'high-variance'; // هذا الكلاس سيقوم بتظليل الصف بالأصفر
    }

    const row = document.createElement('tr');
    row.dataset.accountId = account.account_id;
    row.className = varianceClass; // تطبيق كلاس التظليل على الصف بأكمله
    
    row.addEventListener('click', (e) => {
        if (e.target.closest('tr') === row && !e.target.closest('select, button, .action-icon')) {
            updateInspectorPane(account.account_id);
        }
    });

 const allCategories = [
    { value: 'assets', label: 'أصول' },
    { value: 'liabilities', label: 'التزامات' },
    { value: 'equity', label: 'حقوق الملكية' },
    { value: 'revenue', label: 'إيرادات' },
    { value: 'expenses', label: 'مصروفات' },
    { value: 'clearing', label: 'حسابات وسيطة / رقابية' }
];
    const categoryDropdown = `
        <select class="form-select form-select-sm" onchange="updateCategory(this, '${account.account_id}')">
            <option value="">-- اختر فئة --</option>
            ${allCategories.map(c => `<option value="${c.value}" ${account.category === c.value ? 'selected' : ''}>${c.label}</option>`).join('')}
        </select>
    `;

    const subCategoryDropdown = `
        <select class="form-select form-select-sm" onchange="updateSubCategory(this, '${account.account_id}')" ${!account.category ? 'disabled' : ''}>
            ${generateSubCategoryOptions(account.category, account.sub_category)}
        </select>
    `;
    
    // بناء محتوى الصف مع الأعمدة الجديدة
    row.innerHTML = `
        <td>
            <span class="account-name">${account.name || 'غير مسمى'}</span>
            <div class="text-muted small">${account.account_id}</div>
        </td>
        <td>${categoryDropdown}</td>
        <td>${subCategoryDropdown}</td>
        <td class="${priorYearBalance < 0 ? 'negative-balance' : ''}">${formatCurrency(priorYearBalance)}</td>
        <td class="fw-bold ${finalBalance < 0 ? 'negative-balance' : ''}">${formatCurrency(finalBalance)}</td>
        <td class="fw-bold ${variance < 0 ? 'text-danger' : 'text-success'}">
            ${isFinite(variance) ? variance.toFixed(1) + '%' : 'N/A'}
        </td>
        <td>
            <select class="form-select form-select-sm" onchange="updateReviewStatus(this, '${account.account_id}')">
                <option value="pending" ${account.review_status === 'pending' ? 'selected' : ''}>قيد المراجعة</option>
                <option value="reviewed" ${account.review_status === 'reviewed' ? 'selected' : ''}>تمت المراجعة</option>
                <option value="flagged" ${account.review_status === 'flagged' ? 'selected' : ''}>تحتاج تدقيق</option>
            </select>
        </td>
    `;
    return row;
}

// ==================================================================
// --- END: النسخة المطورة من createAccountRow ---
// ==================================================================
// ==================================================================
// --- END: النسخة المطورة من createAccountRow ---
// ==================================================================


// --- الخطوة 3.2: إصلاح لوحة المفتش الذكي ---
// ==================================================================

// ==================================================================
// --- END: CLEAN CODE BLOCK TO PASTE ---
// ==================================================================

       

        function generateSubCategoryOptions(category, selectedSubCategory) {
            if (!category || !subCategoryMap[category]) {
                return '<option value="">- اختر فئة أولاً -</option>';
            }
            let options = '<option value="">اختر تصنيف فرعي...</option>';
            const groupedOptions = subCategoryMap[category].reduce((acc, option) => {
                acc[option.group] = acc[option.group] || [];
                acc[option.group].push(option);
                return acc;
            }, {});

            for (const groupName in groupedOptions) {
                options += `<optgroup label="${groupName}">`;
                groupedOptions[groupName].forEach(sub => {
                    options += `<option value="${sub.value}" ${selectedSubCategory === sub.value ? 'selected' : ''}>${sub.label}</option>`;
                });
                options += `</optgroup>`;
            }
            return options;
        }

        function confirmCategory(event, accountId) {
            event.stopPropagation();
            const account = auditFile.trialBalance.find(acc => acc.account_id === accountId);
            if (account) {
                account.is_confirmed = true;
                addAuditLogEntry(`تم تأكيد التصنيف للحساب ${accountId}.`);
                saveAuditFile();
                processAndRender();
            }
        }

        // ================================================================
// المهمة الأولى: إصلاح دالة تحديث الفئة الرئيسية
// ================================================================

function updateCategory(selectElement, accountId) {
    const account = auditFile.trialBalance.find(acc => String(acc.account_id) === String(accountId));
    if (account) {
        // تحديث الفئة الرئيسية
        account.category = selectElement.value || null;
        
        // **الإصلاح المطلوب: إفراغ التصنيف الفرعي عند تغيير الرئيسي**
        account.sub_category = null; 
        
        // تأكيد التغيير تلقائيًا
        account.is_confirmed = true; 
        
        addAuditLogEntry(`تم تحديث الفئة الرئيسية للحساب ${accountId} إلى ${selectElement.options[selectElement.selectedIndex].text}`);
        
        // **الحفظ الفوري وإعادة الرسم هما مفتاح الحل**
        saveAuditFile();
        processAndRender(); // إعادة رسم الجدول بالكامل لتحديث قائمة التصنيف الفرعي
    }
}
          // --- دالة تحديث التصنيف الفرعي (V2 - مع التعلم) ---
        function updateSubCategory(selectElement, accountId) {
            const account = auditFile.trialBalance.find(acc => String(acc.account_id) === String(accountId));
            if (account) {
                account.sub_category = selectElement.value || null;
                account.is_confirmed = true; // أي تغيير يدوي يعتبر مؤكداً

                // *** الجزء الجديد: إضافة القرار إلى ذاكرة التعلم ***
                const accountName = account.name ? account.name.toLowerCase().trim() : '';
                if (accountName && account.category && account.sub_category) {
                    if (!auditFile.learningDb) auditFile.learningDb = {};
                    auditFile.learningDb[accountName] = {
                        category: account.category,
                        sub_category: account.sub_category
                    };
                    console.log(`🧠 Learned: '${accountName}' -> ${account.category}/${account.sub_category}`);
                }
                // *** نهاية الجزء الجديد ***

                addAuditLogEntry(`تم تحديث التصنيف الفرعي للحساب ${accountId} إلى ${selectElement.options[selectElement.selectedIndex].text}`);
                saveAuditFile();

                const activeRow = document.querySelector('#trialBalanceTable tr.table-active');
                if (activeRow && activeRow.dataset.accountId === accountId) {
                    updateInspectorPane(accountId);
                }
            }
        }



      // ضع هذا الجزء الجديد والمحسّن مكانه


        // --- STATUS BAR & KPI CALCULATIONS ---
        function updateStatusBar() {
            const matDisplay = document.getElementById('materialityDisplay');
            if (auditFile.settings && auditFile.settings.materiality) {
                matDisplay.innerHTML = `${formatCurrency(auditFile.settings.materiality)} <small class="d-block text-muted">(${auditFile.settings.materiality_basis || ''})</small>`;
            } else {
                matDisplay.textContent = 'لم تحدد';
            }

            const { profitBefore, adjustmentsEffect } = calculateNetProfit();
            const profitAfter = profitBefore + adjustmentsEffect;
            document.getElementById('netProfitDisplay').innerHTML = `${formatCurrency(profitAfter)} <small class="d-block text-muted">(قبل: ${formatCurrency(profitBefore)})</small>`;
            document.getElementById('adjustmentsEffectDisplay').textContent = formatCurrency(adjustmentsEffect);

            const totalAccounts = auditFile.trialBalance.length;
            const reviewedAccounts = auditFile.trialBalance.filter(acc => acc.review_status === 'reviewed').length;
            const completion = totalAccounts > 0 ? (reviewedAccounts / totalAccounts * 100) : 0;
            document.getElementById('completionDisplay').textContent = `${completion.toFixed(1)}%`;
        }
                   function updateKpiPane() {
            const accounts = auditFile.trialBalance;
            const getFinalBalance = (acc) => (acc.book_balance || 0) + calculateAdjustments(acc.account_id);
            
            const getSumBySubCategory = (subCategory) => accounts
                .filter(acc => acc.sub_category === subCategory)
                .reduce((sum, acc) => sum + getFinalBalance(acc), 0);

            // --- 1. استخراج الأرقام الأساسية ---
            const mainRevenue = Math.abs(getSumBySubCategory('main_revenue'));
            const otherRevenue = Math.abs(getSumBySubCategory('other_revenue'));
            const salesReturns = Math.abs(getSumBySubCategory('sales_returns'));
            const salesDiscount = Math.abs(getSumBySubCategory('sales_discount'));
            const netRevenue = (mainRevenue + otherRevenue) - (salesReturns + salesDiscount);
            const cogs = Math.abs(getSumBySubCategory('cogs'));
            const grossProfit = netRevenue - cogs;
            const operatingExpensesList = ['salaries', 'rent', 'utilities', 'maintenance', 'fuel_transport', 'general_admin', 'gov_fees', 'professional_fees', 'selling_marketing', 'commission_expense', 'depreciation', 'amortization'];
            const operatingExpenses = operatingExpensesList.reduce((sum, sc) => sum + Math.abs(getSumBySubCategory(sc)), 0);
            const operatingProfit = grossProfit - operatingExpenses;
            
            // **استخدام القيم الصحيحة من الدالة الجديدة**
            const { profitAfter, profitForEquity } = calculateNetProfit(true); // profitAfter للعرض, profitForEquity للحسابات
            
            const totalAssets = accounts.filter(a => a.category === 'assets').reduce((s, a) => s + getFinalBalance(a), 0);
            const totalLiabilities = Math.abs(accounts.filter(a => a.category === 'liabilities').reduce((s, a) => s + getFinalBalance(a), 0));
            
            // **المعادلة المحاسبية الصحيحة لحقوق الملكية**
            // حقوق الملكية = (رأس المال + أرباح مبقاة) + ربح الفترة (بإشارته السالبة)
            const capitalAndRetained = getSumBySubCategory('capital') + getSumBySubCategory('retained_earnings');
            const totalEquity = Math.abs(capitalAndRetained + profitForEquity); // نجمع الربح بإشارته السالبة ثم نأخذ القيمة المطلقة للعرض

            const currentAssetsList = ['cash_on_hand', 'cash_at_banks', 'trade_receivables', 'inventory', 'prepaid_expenses', 'accrued_revenue'];
            const currentAssets = currentAssetsList.reduce((sum, sc) => sum + getSumBySubCategory(sc), 0);
            const currentLiabilitiesList = ['trade_payables', 'accrued_expenses', 'short_term_loans', 'vat_payable', 'unearned_revenue'];
            const currentLiabilities = Math.abs(currentLiabilitiesList.reduce((sum, sc) => sum + getSumBySubCategory(sc), 0));
            const inventory = getSumBySubCategory('inventory');
            const tradeReceivables = getSumBySubCategory('trade_receivables');

            // --- 2. حساب النسب المالية (تستخدم profitAfter للعرض) ---
            const ratios = [
                { id: 'grossMargin', label: 'هامش الربح الإجمالي', value: netRevenue > 0 ? (grossProfit / netRevenue * 100) : 0, format: 'percent', icon: 'fa-percent' },
                { id: 'operatingMargin', label: 'هامش الربح التشغيلي', value: netRevenue > 0 ? (operatingProfit / netRevenue * 100) : 0, format: 'percent', icon: 'fa-cash-register' },
                { id: 'netMargin', label: 'هامش صافي الربح', value: netRevenue > 0 ? (profitAfter / netRevenue * 100) : 0, format: 'percent', icon: 'fa-wallet' },
                { id: 'roe', label: 'العائد على حقوق الملكية', value: totalEquity !== 0 ? (profitAfter / totalEquity * 100) : 0, format: 'percent', icon: 'fa-users-cog' },
                { id: 'currentRatio', label: 'نسبة التداول', value: currentLiabilities > 0 ? (currentAssets / currentLiabilities) : 0, format: 'decimal', icon: 'fa-hand-holding-usd' },
                { id: 'quickRatio', label: 'النسبة السريعة', value: currentLiabilities > 0 ? ((currentAssets - inventory) / currentLiabilities) : 0, format: 'decimal', icon: 'fa-shipping-fast' },
                { id: 'debtRatio', label: 'نسبة المديونية', value: totalAssets > 0 ? (totalLiabilities / totalAssets * 100) : 0, format: 'percent', icon: 'fa-university' },
                { id: 'debtToEquity', label: 'الديون إلى حقوق الملكية', value: totalEquity !== 0 ? (totalLiabilities / totalEquity) : 0, format: 'decimal', icon: 'fa-balance-scale-left' },
                { id: 'assetTurnover', label: 'معدل دوران الأصول', value: totalAssets > 0 ? (netRevenue / totalAssets) : 0, format: 'decimal', icon: 'fa-sync-alt' },
                { id: 'inventoryTurnover', label: 'دوران المخزون (مرة)', value: inventory > 0 ? (cogs / inventory) : 0, format: 'decimal', icon: 'fa-boxes' },
                { id: 'collectionPeriod', label: 'فترة التحصيل (يوم)', value: netRevenue > 0 ? (tradeReceivables / (netRevenue / 365)) : 0, format: 'days', icon: 'fa-calendar-check' },
                { id: 'roa', label: 'العائد على الأصول (ROA)', value: totalAssets > 0 ? (profitAfter / totalAssets * 100) : 0, format: 'percent', icon: 'fa-chart-line' }
            ];

            // --- 3. تحديث الواجهة (DOM) ---
            ratios.forEach(ratio => {
                const card = document.getElementById(ratio.id)?.closest('.ratio-card');
                if (!card) return;
                let displayValue;
                switch (ratio.format) {
                    case 'percent': displayValue = `${ratio.value.toFixed(1)}%`; break;
                    case 'decimal': displayValue = ratio.value.toFixed(2); break;
                    case 'days': displayValue = isFinite(ratio.value) ? ratio.value.toFixed(0) : '∞'; break;
                    default: displayValue = ratio.value;
                }
                card.innerHTML = `<i class="fas ${ratio.icon} icon-placeholder"></i><span class="label-placeholder">${ratio.label}</span><span class="value-placeholder">${displayValue}</span>`;
                if (ratio.value < 0) { card.classList.add('negative'); } else { card.classList.remove('negative'); }
            });
        }



// ================================================================
// --- دالة الانتقال المباشر إلى ديوان التقارير (النسخة المصححة) ---
// ================================================================
function goToFinancialReports() {
    const activeClientId = localStorage.getItem('activeClientId');
    if (!activeClientId) {
        alert("خطأ: لا يمكن الانتقال لأنه لا يوجد عميل نشط حالياً.");
        return;
    }
    
    // هذا الشرط الذكي يضمن أن صفحة التقارير ستعمل حتى لو لم يتم الاعتماد بعد
    if (!localStorage.getItem(`accountMappingData_${activeClientId}`)) {
        if (confirm("لم يتم اعتماد الميزان بعد. قد تكون التقارير غير مكتملة. هل تريد المتابعة على أي حال؟")) {
            saveMappingDataForReports(); // حفظ نسخة أولية للسماح بالعرض
        } else {
            return; // إيقاف الانتقال
        }
    }
    
    // الانتقال إلى ديوان التقارير الشامل
    console.log("🚀 الانتقال المباشر إلى ديوان التقارير (Pantheon)...");
    window.location.href = `reporting-pantheon.html?clientId=${activeClientId}`;
}
                  function calculateNetProfit(final = false) {
            let netIncome_account_balance = 0; // سيحتفظ بالإشارة المحاسبية (سالب للربح)

            auditFile.trialBalance.forEach(acc => {
                const balance = final 
                    ? (acc.book_balance || 0) + calculateAdjustments(acc.account_id) 
                    : (acc.book_balance || 0);

                if (acc.category === 'revenue' || acc.category === 'expenses') {
                    netIncome_account_balance += balance;
                }
            });

            // **التصحيح الجوهري:**
            // profitForEquity: هذا هو الرقم الذي سيُستخدم في معادلة الميزانية.
            // يحتفظ بإشارته المحاسبية الصحيحة (سالب في حالة الربح).
            const profitForEquity = netIncome_account_balance;

            // profitForDisplay: هذا الرقم للعرض فقط في التقارير والنسب.
            // يكون دائمًا موجبًا في حالة الربح.
            const profitForDisplay = -netIncome_account_balance;

            // حساب أثر التسويات (للعرض فقط)
            let adjustmentsEffect = 0;
            if (!final) {
                auditFile.adjustments.forEach(adj => {
                    if (adj.type === 'AJE') {
                        const debitAcc = auditFile.trialBalance.find(a => String(a.account_id) === String(adj.debit_account));
                        const creditAcc = auditFile.trialBalance.find(a => String(a.account_id) === String(adj.credit_account));
                        const amount = Number(adj.amount) || 0;
                        if (debitAcc && debitAcc.category === 'expenses') adjustmentsEffect -= amount;
                        if (debitAcc && debitAcc.category === 'revenue') adjustmentsEffect += amount;
                        if (creditAcc && creditAcc.category === 'revenue') adjustmentsEffect += amount;
                        if (creditAcc && creditAcc.category === 'expenses') adjustmentsEffect -= amount;
                    }
                });
            }
            
            const profitBefore = profitForDisplay - adjustmentsEffect;

            // إرجاع كلا القيمتين لاستخدامهما في السياق الصحيح
            return { profitBefore, adjustmentsEffect, profitAfter: profitForDisplay, profitForEquity };
        }

        function calculateAdjustments(accountId) {
            return auditFile.adjustments
                .filter(adj => adj.debit_account === accountId || adj.credit_account === accountId)
                .reduce((sum, adj) => sum + (adj.debit_account === accountId ? adj.amount : -adj.amount), 0);
        }

        // --- USER ACTIONS & MODALS ---
        function saveMateriality() {
            const basis = document.getElementById('materialityBasis').value;
            const basisText = document.getElementById('materialityBasis').options[document.getElementById('materialityBasis').selectedIndex].text;
            let materiality = 0;

            const totalAssets = auditFile.trialBalance.filter(acc => acc.category === 'assets').reduce((sum, acc) => sum + acc.book_balance, 0);
            const totalRevenue = Math.abs(auditFile.trialBalance.filter(acc => acc.category === 'revenue').reduce((sum, acc) => sum + acc.book_balance, 0));
            const { profitBefore } = calculateNetProfit();

            switch (basis) {
                case 'profit': materiality = Math.abs(profitBefore * 0.05); break;
                case 'revenue': materiality = Math.abs(totalRevenue * 0.01); break;
                case 'assets': materiality = Math.abs(totalAssets * 0.005); break;
                case 'fixed': materiality = parseFloat(document.getElementById('materialityAmount').value) || 0; break;
            }

            if (materiality <= 0) {
                alert("قيمة الأهمية النسبية المحسوبة أو المدخلة غير صالحة.");
                return;
            }

            auditFile.settings.materiality = materiality;
            auditFile.settings.materiality_basis = basisText;
            addAuditLogEntry(`تم تحديد الأهمية النسبية: ${formatCurrency(materiality)}`);
            saveAuditFile();
            materialityModal.hide();
            processAndRender();
        }

// ==================================================================
// --- دالة فتح نافذة قيد التسوية (النسخة المعدلة) ---
// ==================================================================
function openAjeModal(accountId, adjustmentId = null) {
    const modal = document.getElementById('ajeModal');
    const isEditMode = !!adjustmentId;

    // مسح حقول البحث أولاً
    document.getElementById('searchDebitAccount').value = '';
    document.getElementById('searchCreditAccount').value = '';

    // ملء قوائم الحسابات بالبيانات الكاملة
    setupAjeModal(); // هذه الدالة تملأ القوائم بالـ <option>

    if (isEditMode) {
        // وضع التعديل
        const adj = auditFile.adjustments.find(a => a.id === adjustmentId);
        if (!adj) return;
        document.getElementById('ajeDescription').value = adj.description;
        document.getElementById('ajeDebitAccount').value = adj.debit_account; // تعيين القيمة
        document.getElementById('ajeCreditAccount').value = adj.credit_account; // تعيين القيمة
        document.getElementById('ajeAmount').value = adj.amount;
        document.getElementById('isRceSwitch').checked = adj.type === 'RCE';
        document.getElementById('ajeModalLabel').textContent = `تعديل قيد التسوية: ${adj.description}`;
        modal.dataset.editingId = adjustmentId;
    } else {
        // وضع الإنشاء
        document.getElementById('ajeDescription').value = '';
        document.getElementById('ajeAmount').value = '';
        document.getElementById('isRceSwitch').checked = false;
        document.getElementById('ajeModalLabel').textContent = `إضافة قيد تسوية جديد`;
        
        // تعيين قيمة افتراضية فارغة
        document.getElementById('ajeDebitAccount').value = ""; 
        document.getElementById('ajeCreditAccount').value = "";

        if (accountId) {
            const account = auditFile.trialBalance.find(acc => String(acc.account_id) === String(accountId));
            if (account) {
                const finalBalance = (account.book_balance || 0) + calculateAdjustments(accountId);
                if (finalBalance > 0) { // رصيد مدين -> نضعه في الجانب الدائن لتصفيته
                    document.getElementById('ajeCreditAccount').value = accountId;
                } else if (finalBalance < 0) { // رصيد دائن -> نضعه في الجانب المدين لتصفيته
                    document.getElementById('ajeDebitAccount').value = accountId;
                }
                document.getElementById('ajeAmount').value = Math.abs(finalBalance);
            }
        }
        delete modal.dataset.editingId;
    }

    // (الأهم) تفعيل البحث بعد ملء القوائم وتعيين القيم الأولية
    setupSearchableSelect('searchDebitAccount', 'ajeDebitAccount');
    setupSearchableSelect('searchCreditAccount', 'ajeCreditAccount');

    ajeModal.show();
}
       function setupAjeModal() {
            const debitSelect = document.getElementById('ajeDebitAccount');
            const creditSelect = document.getElementById('ajeCreditAccount');
            debitSelect.innerHTML = '<option value="">اختر الحساب المدين</option>';
            creditSelect.innerHTML = '<option value="">اختر الحساب الدائن</option>';
            auditFile.trialBalance.forEach(account => {
                const option = `<option value="${account.account_id}">${account.account_id} - ${account.name || 'غير مسمى'}</option>`;
                debitSelect.innerHTML += option;
                creditSelect.innerHTML += option;
            });
        }
function saveChanges() {
    try {
        // تخزين auditFile في LocalStorage (حل مؤقت إذا لم يكن هناك خادم)
        localStorage.setItem('auditFile', JSON.stringify(auditFile));
        alert('تم الحفظ بنجاح!');
        
        // إذا كنت تستخدم خادمًا، أرسل البيانات عبر API
        fetch('/api/save-audit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(auditFile),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('تم الحفظ على الخادم بنجاح!');
            } else {
                throw new Error('فشل الحفظ على الخادم');
            }
        })
        .catch(error => {
            console.error('خطأ في الحفظ:', error);
            alert('حدث خطأ أثناء الحفظ. تحقق من وحدة التحكم.');
        });
    } catch (error) {
        console.error('خطأ في الحفظ:', error);
        alert('حدث خطأ أثناء الحفظ.');
    }
}

// ربط زر الحفظ بالدالة
document.querySelector('.btn-primary').addEventListener('click', saveChanges);
 // ==================================================================
// --- دالة حفظ قيد التسوية (النسخة النهائية والمعدلة) ---
// ==================================================================
function saveAdjustment() {
    const description = document.getElementById('ajeDescription').value.trim();
    
    // --- التعديل الجوهري هنا ---
    // اقرأ القيمة المحددة مباشرة من القائمة المنسدلة في لحظة الحفظ
    const debitAccount = document.getElementById('ajeDebitAccount').value;
    const creditAccount = document.getElementById('ajeCreditAccount').value;
    // --- نهاية التعديل ---

    const amount = parseFloat(document.getElementById('ajeAmount').value);
    const isRCE = document.getElementById('isRceSwitch').checked;
    const editingId = document.getElementById('ajeModal').dataset.editingId;

    // التحقق من صحة المدخلات
    if (!description || !debitAccount || !creditAccount || isNaN(amount) || amount <= 0) {
        alert("الرجاء ملء جميع الحقول بشكل صحيح والتأكد من اختيار الحسابات.");
        return;
    }
    if (debitAccount === creditAccount) {
        alert("لا يمكن أن يكون الحساب المدين هو نفسه الحساب الدائن.");
        return;
    }

    if (editingId) {
        // وضع التحديث (Update mode)
        const index = auditFile.adjustments.findIndex(a => a.id === editingId);
        if (index !== -1) {
            auditFile.adjustments[index] = {
                id: editingId,
                type: isRCE ? 'RCE' : 'AJE',
                description,
                debit_account: debitAccount,
                credit_account: creditAccount,
                amount,
                timestamp: new Date().toISOString()
            };
            addAuditLogEntry(`تم تعديل قيد ${auditFile.adjustments[index].type}: ${description}`);
        }
    } else {
        // وضع الإنشاء (Create mode)
        const adjustment = {
            id: `ADJ-${Date.now()}`,
            type: isRCE ? 'RCE' : 'AJE',
            description,
            debit_account: debitAccount,
            credit_account: creditAccount,
            amount,
            timestamp: new Date().toISOString()
        };
        auditFile.adjustments.push(adjustment);
        addAuditLogEntry(`إضافة قيد ${adjustment.type}: ${description}`);
    }

    // حفظ الملف، إغلاق النافذة، وتحديث الواجهة
    saveAuditFile();
    ajeModal.hide();
    processAndRender(); // الدالة المسؤولة عن إعادة رسم الجدول الرئيسي
    const activeRow = document.querySelector('#trialBalanceTable tr.table-active');
    if (activeRow) {
        updateInspectorPane(activeRow.dataset.accountId); // تحديث لوحة المفتش إذا كان هناك حساب نشط
    }
}

window.onload = function() {
    const savedData = localStorage.getItem('auditFile');
    if (savedData) {
        auditFile = JSON.parse(savedData);
        // إعادة تحميل جدول البيانات
        updateTrialBalanceTable();
        // تحديث لوحة المفتش إذا كان هناك حساب محدد
        const selectedAccount = document.querySelector('#trialBalanceTable tr.table-active');
        if (selectedAccount) {
            updateInspectorPane(selectedAccount.dataset.accountId);
        }
    }
};
      

        

        // --- WORKPAPERS LOGIC ---
        function openWorkpapersModal(event, accountId) {
            event.stopPropagation();
            currentWorkpaperAccountId = accountId;
            const account = auditFile.trialBalance.find(acc => acc.account_id === accountId);
            if (!account) return;

            document.getElementById('workpapersModalTitle').textContent = `أوراق عمل: ${account.name || account.id}`;
            document.getElementById('workpapersAccountName').textContent = `${account.name || 'غير مسمى'} (${account.account_id})`;
            renderWorkpapersList(account.workpapers);
            workpapersModal.show();
        }

       

      // ==================================================================
// ==================================================================
// --- START: FINAL & CLEAN FUNCTIONALITY FIXES ---
// ==================================================================

// ================================================================
// المهمة الاستراتيجية الأولى: ترقية استجابة مجلس الحكمة
// ================================================================
function performComparativeAnalysis() {
    // إعادة عرض الجدول مع تطبيق التظليل
    processAndRender();
    addAuditLogEntry("تم إجراء تحليل مقارن للحسابات.");
    saveAuditFile();
}
function saveChangesManually() {
    try {
        saveAuditFile();
        addAuditLogEntry("تم حفظ التغييرات يدويًا بواسطة المستخدم.");
        alert("تم حفظ التغييرات بنجاح!");
    } catch (e) {
        console.error("خطأ أثناء الحفظ اليدوي:", e);
        alert("حدث خطأ أثناء حفظ التغييرات. الرجاء المحاولة مرة أخرى.");
    }
}
function renderWorkpapersList(workpapers) {
    const list = document.getElementById('workpapersList');
    list.innerHTML = '';
    if (!workpapers || workpapers.length === 0) {
        list.innerHTML = '<li class="list-group-item text-muted">لا توجد مستندات مرفقة حالياً.</li>';
        return;
    }
    workpapers.forEach((wp, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
            <span><i class="fas fa-file me-2"></i>${wp.name}</span>
            <div class="btn-group">
                <button class="btn btn-outline-primary btn-sm" onclick="downloadWorkpaper(event, ${index})"><i class="fas fa-download"></i></button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteWorkpaper(event, ${index})"><i class="fas fa-trash"></i></button>
            </div>
        `;
        list.appendChild(li);
    });
}

function uploadWorkpaper() {
    const fileInput = document.getElementById('fileUpload');
    if (!fileInput.files || fileInput.files.length === 0) {
        alert('الرجاء اختيار ملف أولاً.');
        return;
    }
    const file = fileInput.files[0];
    const reader = new FileReader();

    reader.onload = function(e) {
        const fileData = {
            name: file.name,
            type: file.type,
            content: e.target.result,
            uploadedAt: new Date().toISOString() // إضافة طابع زمني
        };

        const account = auditFile.trialBalance.find(acc => acc.account_id === currentWorkpaperAccountId);
        if (account) {
            if (!account.workpapers) account.workpapers = [];
            account.workpapers.push(fileData);
            addAuditLogEntry(`تم إرفاق مستند '${file.name}' للحساب ${currentWorkpaperAccountId}.`);
            saveAuditFile();
            renderWorkpapersList(account.workpapers);
            processAndRender();
            fileInput.value = ''; // إعادة تعيين حقل الإدخال
            alert('تم رفع المستند بنجاح!'); // رسالة تأكيد
        } else {
            alert('خطأ: لم يتم العثور على الحساب.');
        }
    };
    reader.onerror = function() {
        alert('حدث خطأ أثناء قراءة الملف.');
    };
    reader.readAsDataURL(file);
}
function downloadWorkpaper(event, index) {
    event.stopPropagation();
    const account = auditFile.trialBalance.find(acc => acc.account_id === currentWorkpaperAccountId);
    if (account && account.workpapers && account.workpapers[index]) {
        const wp = account.workpapers[index];
        const link = document.createElement('a');
        link.href = wp.content;
        link.download = wp.name;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

// ==================================================================
// --- END: FINAL & CLEAN FUNCTIONALITY FIXES ---
// ==================================================================


        function deleteWorkpaper(event, index) {
            event.stopPropagation();
            if (!confirm('هل أنت متأكد من حذف ورقة العمل هذه؟')) return;
            const account = auditFile.trialBalance.find(acc => acc.account_id === currentWorkpaperAccountId);
            if (account) {
                const deletedWp = account.workpapers.splice(index, 1);
                addAuditLogEntry(`تم حذف مستند '${deletedWp[0].name}' من الحساب ${currentWorkpaperAccountId}.`);
                saveAuditFile();
                renderWorkpapersList(account.workpapers);
                processAndRender();
            }
        }

        // --- HELPERS & UTILITIES ---
        function handleFatalError(message) {
            const container = document.querySelector('.container-fluid') || document.body;
            container.innerHTML = `<div class="alert alert-danger m-5">${message}</div>`;
        }

        function addAuditLogEntry(action) {
            if (!auditFile.auditLog) auditFile.auditLog = [];
            auditFile.auditLog.push({ timestamp: new Date().toISOString(), action });
        }

        function saveUserPrefs() {
            try {
                localStorage.setItem(`polarisUserPrefs_${auditFile.clientInfo.id}`, JSON.stringify(userPrefs));
            } catch (e) { console.warn("Could not save user preferences."); }
        }

        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value)) return '-';
            return new Intl.NumberFormat('ar-SA', { 
                style: 'currency', 
                currency: CURRENCY,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function getCategoryLabel(categoryKey) {
            return getCategoryLabel.labels[categoryKey] || 'غير مصنف';
        }
        getCategoryLabel.labels = {
            'assets': 'أصول', 'liabilities': 'التزامات', 'equity': 'حقوق الملكية',
            'revenue': 'إيرادات', 'expenses': 'مصروفات'
        };

       // ==================================================================
// --- دالة التصدير المحسنة مع معالجة الأخطاء ---
// ==================================================================

// ==================================================================
// --- START: دالة تصدير Excel المطورة (V4 - شاملة ومنسقة) ---
// ==================================================================
function exportToExcel() {
    try {
        if (typeof XLSX === 'undefined') {
            alert('خطأ: مكتبة XLSX غير محملة.');
            return;
        }
        if (!auditFile || !auditFile.trialBalance) {
            alert('خطأ: لا توجد بيانات للتصدير.');
            return;
        }

        console.log('🚀 بدء عملية تصدير Excel الشاملة...');
        
        // 1. إعداد رأس الجدول للتصدير
        const headers = [
            'رقم الحساب', 'اسم الحساب', 'الفئة', 'التصنيف الفرعي',
            'رصيد أول مدين', 'رصيد أول دائن',
            'حركة مدين', 'حركة دائن',
            'رصيد دفتري',
            'تسويات مدين', 'تسويات دائن',
            'الرصيد النهائي'
        ];
        
        // 2. معالجة كل حساب وإعداد بياناته
        const exportData = auditFile.trialBalance.map(account => {
            // حساب التسويات
            const accountAdjustments = auditFile.adjustments.filter(adj => 
                String(adj.debit_account) === String(account.account_id) || 
                String(adj.credit_account) === String(account.account_id)
            );
            const adjustmentDebit = accountAdjustments
                .filter(adj => String(adj.debit_account) === String(account.account_id))
                .reduce((sum, adj) => sum + (Number(adj.amount) || 0), 0);
            const adjustmentCredit = accountAdjustments
                .filter(adj => String(adj.credit_account) === String(account.account_id))
                .reduce((sum, adj) => sum + (Number(adj.amount) || 0), 0);

            // حساب الأرصدة
            const bookBalance = (account.book_balance || 0);
            const finalBalance = bookBalance + adjustmentDebit - adjustmentCredit;

            // تجهيز الصف للتصدير
            return [
                account.account_id || '',
                account.name || '',
                getCategoryLabel(account.category),
                getSubCategoryLabelSafe(account.category, account.sub_category),
                account.ob_debit || 0,
                account.ob_credit || 0,
                account.move_debit || 0,
                account.move_credit || 0,
                bookBalance,
                adjustmentDebit,
                adjustmentCredit,
                finalBalance
            ];
        });

        // 3. إنشاء ورقة العمل والمصنف
        const ws = XLSX.utils.aoa_to_sheet([headers, ...exportData]);
        
        // تحديد عرض الأعمدة لتحسين القراءة
        ws['!cols'] = [
            { wch: 15 }, { wch: 40 }, { wch: 15 }, { wch: 25 },
            { wch: 18 }, { wch: 18 }, { wch: 18 }, { wch: 18 },
            { wch: 18 }, { wch: 18 }, { wch: 18 }, { wch: 18 }
        ];

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ميزان المراجعة التفصيلي");

        // 4. تحديد اسم الملف وتنزيله
        const clientName = (auditFile.clientInfo && auditFile.clientInfo.name) ? auditFile.clientInfo.name.replace(/\s/g, '_') : 'Client';
        const fileName = `TB_Detailed_${clientName}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        console.log(`✅ تم تصدير ميزان المراجعة التفصيلي بنجاح: ${fileName}`);
        alert(`تم تصدير ملف Excel التفصيلي بنجاح!`);
        
    } catch (error) {
        console.error('❌ خطأ في تصدير Excel:', error);
        alert(`حدث خطأ أثناء تصدير الملف: ${error.message}`);
    }
}
// ==================================================================
// --- END: دالة تصدير Excel المطورة ---
// ==================================================================

// ==================================================================
// --- دوال مساعدة آمنة للتصدير ---
// ==================================================================

function getCategoryLabelSafe(category) {
    try {
        const categories = {
            'assets': 'أصول',
            'liabilities': 'التزامات',
            'equity': 'حقوق الملكية',
            'revenue': 'إيرادات',
            'expenses': 'مصروفات'
        };
        return categories[category] || '';
    } catch (e) {
        return '';
    }
}

function getSubCategoryLabelSafe(category, subCategory) {
    try {
        if (!category || !subCategory) return '';
        if (typeof subCategoryMap === 'undefined' || !subCategoryMap[category]) return '';
        const subCat = subCategoryMap[category].find(sc => sc.value === subCategory);
        return subCat ? subCat.label : '';
    } catch (e) {
        return '';
    }
}

function getReviewStatusLabelSafe(status) {
    try {
        const statuses = {
            'pending': 'قيد المراجعة',
            'reviewed': 'تمت المراجعة',
            'flagged': 'تحتاج تدقيق'
        };
        return statuses[status] || 'قيد المراجعة';
    } catch (e) {
        return 'قيد المراجعة';
    }
}


// ==================================================================
// --- دالة تشخيص المشاكل ---
// ==================================================================

function diagnoseExportIssues() {
    console.log('=== تشخيص مشاكل التصدير ===');
    
    // فحص مكتبة XLSX
    console.log('1. مكتبة XLSX:', typeof XLSX !== 'undefined' ? '✅ محملة' : '❌ غير محملة');
    
    // فحص البيانات
    console.log('2. متغير auditFile:', typeof auditFile !== 'undefined' ? '✅ موجود' : '❌ غير موجود');
    
    if (typeof auditFile !== 'undefined') {
        console.log('3. auditFile.trialBalance:', auditFile.trialBalance ? `✅ موجود (${auditFile.trialBalance.length} حساب)` : '❌ غير موجود');
        console.log('4. auditFile.adjustments:', auditFile.adjustments ? `✅ موجود (${auditFile.adjustments.length} تسوية)` : '❌ غير موجود');
        console.log('5. auditFile.clientInfo:', auditFile.clientInfo ? '✅ موجود' : '❌ غير موجود');
    }
    
    // فحص متغير subCategoryMap
    console.log('6. متغير subCategoryMap:', typeof subCategoryMap !== 'undefined' ? '✅ موجود' : '❌ غير موجود');
    
    console.log('=== انتهاء التشخيص ===');
}

// ==================================================================
// ==================================================================
// --- دالة البحث الذكي (النسخة النهائية مع مزامنة القيمة) ---
// ==================================================================
function setupSearchableSelect(inputId, selectId) {
    const input = document.getElementById(inputId);
    const select = document.getElementById(selectId);
    const allOptions = Array.from(select.options).map(opt => ({
        value: opt.value,
        text: opt.textContent
    }));

    function renderOptions(filter = '') {
        const lowerCaseFilter = filter.toLowerCase();
        // الاحتفاظ بالقيمة المحددة حاليًا (إذا كانت موجودة)
        const currentValue = select.value;
        select.innerHTML = ''; // إفراغ القائمة

        allOptions.forEach(opt => {
            if (!filter || opt.text.toLowerCase().includes(lowerCaseFilter) || opt.value.includes(lowerCaseFilter)) {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.text;
                select.appendChild(option);
            }
        });
        // إعادة تعيين القيمة المحددة بعد إعادة بناء القائمة
        select.value = currentValue;
    }

    input.addEventListener('input', function() {
        renderOptions(this.value);
    });

    // *** التعديل الأهم هنا ***
    select.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption) {
            // 1. قم بتحديث حقل البحث ليعكس الاختيار
            input.value = selectedOption.textContent;
            
            // 2. (الأهم) تأكد من أن قيمة العنصر <select> هي القيمة الصحيحة
            // هذا السطر يضمن أن القيمة "مثبتة" وجاهزة للحفظ
            select.value = selectedOption.value;
        }
    });

    // عند فتح النافذة لأول مرة
    const initialValue = select.value;
    if (initialValue) {
        const initialOption = allOptions.find(opt => opt.value === initialValue);
        if (initialOption) {
            input.value = initialOption.text;
        }
    }
}
// =======================================================================
// --- START: النسخة النهائية والمؤمّنة لدالة الأرشفة (تقرأ من المصدر) ---
// =======================================================================
function archiveForNextYear() {
    if (!confirm("هل أنت متأكد من رغبتك في أرشفة الأرصدة النهائية الحالية؟ سيتم استخدامها كرصيد افتتاحي للمقارنة في السنة القادمة.")) {
        return;
    }

    console.log("🚀 بدء عملية الأرشفة اليدوية...");

    const activeClientId = localStorage.getItem('activeClientId');
    if (!activeClientId) {
        alert("خطأ فادح: لا يمكن تحديد العميل النشط.");
        return;
    }

    // --- الخطوة 1 (الإصلاح الجذري): تحميل بيانات الإعداد الأصلية والموثوقة ---
    const clientSetupData = localStorage.getItem(`clientSetup_${activeClientId}`);
    if (!clientSetupData) {
        alert("خطأ فادح: لم يتم العثور على بيانات الإعداد الأصلية للعميل. لا يمكن تحديد سنة الأرشفة.");
        return;
    }

    try {
        const clientSetup = JSON.parse(clientSetupData);
        const clientDetails = clientSetup.details;

        // --- الخطوة 2: تحديد سنة الأرشفة من المصدر الموثوق ---
        let currentYear;
        if (clientDetails && clientDetails.endDate) {
            currentYear = new Date(clientDetails.endDate).getFullYear();
            console.log(`✅ تم العثور على سنة الأرشفة الصحيحة من بيانات الإعداد: ${currentYear}`);
        } else {
            // هذه الخطة البديلة أصبحت نادرة الحدوث الآن
            console.warn("⚠️ تنبيه: لم يتم العثور على تاريخ نهاية الفترة في بيانات الإعداد. سيتم استخدام السنة الحالية كخطة بديلة.");
            currentYear = new Date().getFullYear();
        }

        const comparisonKey = `comparisonData_${activeClientId}_${currentYear}`;
        
        // --- الخطوة 3: إنشاء بيانات المقارنة (لا تغيير هنا) ---
        const comparisonData = {
            year: currentYear,
            accounts: auditFile.trialBalance.map(acc => {
                const adjustments = (typeof calculateAdjustments === 'function') ? calculateAdjustments(acc.account_id) : 0;
                const finalBalance = (acc.book_balance || 0) + adjustments;
                return {
                    account_id: acc.account_id,
                    name: acc.name,
                    ob_debit: finalBalance > 0 ? finalBalance : 0,
                    ob_credit: finalBalance < 0 ? Math.abs(finalBalance) : 0,
                };
            })
        };

        // --- الخطوة 4: حفظ البيانات وعرض رسالة النجاح ---
        localStorage.setItem(comparisonKey, JSON.stringify(comparisonData));
        const successMessage = `✅ تمت أرشفة أرصدة نهاية الفترة للعام ${currentYear} بنجاح! \n\nالبيانات جاهزة الآن لاستخدامها في مقارنات السنة القادمة.`;
        console.log(successMessage);
        alert(successMessage);

    } catch (error) {
        const errorMessage = `❌ فشلت عملية الأرشفة بسبب خطأ: ${error.message}`;
        console.error(errorMessage, error);
        alert(errorMessage);
    }
}
// =======================================================================
// --- END: النسخة النهائية والمؤمّنة لدالة الأرشفة ---
// =======================================================================
// =======================================================================
// --- START: دوال النسخ الاحتياطي والاستعادة (النسخة النهائية) ---
// =======================================================================

/**
 * دالة مركزية لتنزيل أي بيانات كملف JSON.
 */
function downloadJSON(data, filename) {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
}

/**
 * وظيفة الزر "تنزيل نسخة": تقوم بتنزيل نسخة احتياطية من العمل الحالي.
 */
function downloadBackup() {
    if (auditFile && auditFile.clientInfo) {
        const clientName = auditFile.clientInfo.name || 'UnknownClient';
        const dateStr = new Date().toISOString().slice(0, 10);
        const filename = `AuditFile_Backup_${clientName}_${dateStr}.json`;
        
        // قبل التنزيل، نتأكد من أن آخر التغييرات قد تم حفظها في متغير auditFile
        saveAuditFile(); 
        
        downloadJSON(auditFile, filename);
        console.log(`✅ تم تنزيل نسخة احتياطية من ملف المراجعة: ${filename}`);
        alert("تم تنزيل نسخة احتياطية من عملك الحالي بنجاح.");
    } else {
        alert("لا توجد بيانات حالية لتنزيلها.");
    }
}

/**
 * تطلق نافذة اختيار الملف للاستعادة.
 */
function triggerRestore() {
    if (confirm("تحذير: سيتم استبدال البيانات الحالية في المتصفح ببيانات النسخة الاحتياطية. هل أنت متأكد من المتابعة؟")) {
        document.getElementById('restoreInput').click();
    }
}

/**
 * تعالج ملف النسخة الاحتياطية الذي تم رفعه.
 */
function restoreFromBackup(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);

            if (data.trialBalance && data.clientInfo && data.clientInfo.id) {
                const clientId = data.clientInfo.id;
                const auditFileKey = `polarisAuditFile_${clientId}`;
                localStorage.setItem(auditFileKey, JSON.stringify(data));
                
                alert(`✅ تم استعادة ملف المراجعة بنجاح للعميل: ${data.clientInfo.name}.\nسيتم إعادة تحميل الصفحة لتطبيق التغييرات.`);
                window.location.href = `account-mapping.html?clientId=${clientId}`;

            } else {
                throw new Error("صيغة ملف النسخة الاحتياطية غير صحيحة.");
            }

        } catch (error) {
            console.error("❌ فشلت عملية الاستعادة:", error);
            alert(`فشلت عملية الاستعادة: ${error.message}`);
        } finally {
            event.target.value = '';
        }
    };
    reader.readAsText(file);
}
// =======================================================================
// --- END: دوال النسخ الاحتياطي والاستعادة ---
// =======================================================================
// ================================================================
// --- START: الدالة المفقودة لتحديث حالة المراجعة ---
// ================================================================
function updateReviewStatus(selectElement, accountId) {
    // 1. ابحث عن الحساب المطابق في بياناتنا
    const account = auditFile.trialBalance.find(acc => String(acc.account_id) === String(accountId));
    
    if (account) {
        // 2. قم بتحديث قيمة حالة المراجعة بناءً على اختيار المستخدم
        account.review_status = selectElement.value;
        
        // 3. سجل هذا التغيير في سجل المراجعة
        addAuditLogEntry(`تم تحديث حالة الحساب ${accountId} إلى '${selectElement.options[selectElement.selectedIndex].text}'`);
        
        // 4. احفظ التغييرات في localStorage
        saveAuditFile();
        
        // 5. (الأهم) قم بتحديث شريط نسبة الإنجاز في الأسفل فوراً
        updateStatusBar();
    } else {
        console.error(`خطأ: لم يتم العثور على الحساب بالمعرف ${accountId} لتحديث حالته.`);
    }
}
// ================================================================
// --- END: الدالة المفقودة ---
// ================================================================

   </script>
<body **data-step="trial-balance"**></body>
</html>

