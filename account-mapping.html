<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مراجعه ميزان المراجعه والتسويات - النسخة الاحترافية</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- المكتبات الأساسية -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="dataPipeline.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700;900&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* === المتغيرات والتنسيقات الأساسية === */
        :root {
            --color-bg: #0d1117;
            --color-surface: #161b22;
            --color-primary: #00aaff;
            --color-primary-glow: rgba(0, 170, 255, 0.5);
            --color-text-primary: #c9d1d9;
            --color-text-secondary: #8b949e;
            --color-border: #30363d;
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-warning: #ffc107;
            --color-info: #17a2b8;
            --border-radius-lg: 12px;
            --border-radius-md: 8px;
            --font-family-main: 'Tajawal', sans-serif;
            --font-family-display: 'Cairo', sans-serif;
        }

        body {
            font-family: var(--font-family-main);
            background-color: var(--color-bg);
            color: var(--color-text-primary);
        }

        .container-fluid { 
            padding: 2rem; 
            max-width: 1920px;
            margin: 0 auto;
        }

        /* === لوحة التحكم الذكية للمراجعة (V4) === */
        .audit-cockpit {
            background: linear-gradient(135deg, rgba(0, 170, 255, 0.05) 0%, rgba(40, 167, 69, 0.05) 100%);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .cockpit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--color-primary);
        }

        .cockpit-title {
            font-family: var(--font-family-display);
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .cockpit-title i {
            color: var(--color-primary);
            font-size: 1.5rem;
        }

        .cockpit-section {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-md);
            padding: 1rem;
            height: 100%;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .cockpit-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--color-primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .cockpit-section:hover::before {
            transform: scaleY(1);
        }

        .cockpit-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 170, 255, 0.2);
            border-color: var(--color-primary);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }
        .top-icons{ display:flex; gap:.5rem; align-items:center; margin:.5rem 0 1rem 0 }
        .top-icons a{ display:inline-flex; align-items:center; justify-content:center; width:34px; height:34px; border:1px solid var(--color-border); border-radius:8px; color:var(--color-text-primary); text-decoration:none }
        .top-icons a:hover{ background:#1f2937 }

        .section-header:hover {
            background-color: rgba(0, 170, 255, 0.08);
        }

        .section-title {
            font-family: var(--font-family-display);
            font-weight: 700;
            color: var(--color-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .priority-badge {
            font-size: 0.9rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 700;
        }

        .priority-high {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--color-danger);
            border: 1px solid var(--color-danger);
        }

        .priority-medium {
            background-color: rgba(255, 193, 7, 0.2);
            color: var(--color-warning);
            border: 1px solid var(--color-warning);
        }

        .priority-follow {
            background-color: rgba(23, 162, 184, 0.2);
            color: var(--color-info);
            border: 1px solid var(--color-info);
        }

        .cockpit-list {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .cockpit-item {
            background-color: rgba(0,0,0,0.2);
            border-radius: var(--border-radius-md);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid var(--color-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .cockpit-item:hover {
            transform: translateX(-5px);
            box-shadow: 0 0 15px rgba(0, 170, 255, 0.2);
        }

        .cockpit-item.high-priority { 
            border-left-color: var(--color-danger); 
            background-color: rgba(220, 53, 69, 0.1);
        }

        .cockpit-item.medium-priority { 
            border-left-color: var(--color-warning); 
            background-color: rgba(255, 193, 7, 0.1);
        }

        .cockpit-item.follow-up { 
            border-left-color: var(--color-info); 
            background-color: rgba(23, 162, 184, 0.1);
        }

        .item-reason {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--color-text-primary);
            margin-bottom: 0.25rem;
        }

        .item-account {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        .item-details {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            margin-top: 0.25rem;
        }

        .risk-score {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: var(--color-danger);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }
/* === تحسينات نافذة قيد التسوية === */
.modal-header.bg-gradient-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
}

.search-container {
    position: relative;
}

.form-select-lg {
    font-size: 1rem;
    padding: 0.75rem;
}

.form-control-lg {
    font-size: 1rem;
    padding: 0.75rem;
}

.card-header.bg-light {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

#amountInWords {
    min-height: 38px;
    display: flex;
    align-items: center;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.375rem 0.75rem;
}

.border-primary {
    border-color: #007bff !important;
}

/* تحسينات للأجهزة المحمولة */
@media (max-width: 768px) {
    .modal-dialog {
        margin: 0.5rem;
    }
    
    .form-control-lg,
    .form-select-lg {
        font-size: 0.9rem;
        padding: 0.5rem;
    }
    
    .btn-lg {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
    }
}
      /* === لوحة التحليل المالي المقارن (V6) === */
.financial-dashboard {
    background: linear-gradient(135deg, rgba(0, 170, 255, 0.05) 0%, rgba(255, 193, 7, 0.05) 100%);
    border-radius: var(--border-radius-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
    border: 1px solid var(--color-border);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--color-primary);
}

.dashboard-title {
    font-family: var(--font-family-display);
    font-size: 1.8rem;
    font-weight: 800;
    color: var(--color-text-primary);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.ratio-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-md);
    padding: 1rem;
    height: 100%;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.ratio-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--color-primary);
    transform: scaleY(0);
    transition: transform 0.3s ease;
}

.ratio-card:hover::before {
    transform: scaleY(1);
}

.ratio-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 170, 255, 0.2);
    border-color: var(--color-primary);
}

.ratio-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.ratio-label {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--color-text-primary);
}

.ratio-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.ratio-indicator.good { background: var(--color-success); }
.ratio-indicator.warning { background: var(--color-warning); }
.ratio-indicator.danger { background: var(--color-danger); }
.ratio-indicator.indicator-warn { background: var(--color-warning); }

@keyframes pulse {
    0% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(1.1); }
    100% { opacity: 1; transform: scale(1); }
}

.ratio-content {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
}

.ratio-value {
    font-family: monospace;
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--color-primary);
}

.ratio-comparison {
    font-family: monospace;
    font-size: 0.85rem;
    color: var(--color-text-secondary);
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.ratio-comparison.up { color: var(--color-success); }
.ratio-comparison.down { color: var(--color-danger); }
        /* === لوحة القيادة المصغرة (V4) === */
        .kpi-dashboard {
            width: 100%;
            margin-top: 2rem;
        }

        .kpi-card {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-lg);
            padding: 1.25rem;
            display: flex;
            align-items: center;
            gap: 1.25rem;
            height: 100%;
            transition: all 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 170, 255, 0.2);
        }

        .kpi-icon-wrapper {
            flex-shrink: 0;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: #fff;
            transition: all 0.3s ease;
        }

        .kpi-card:hover .kpi-icon-wrapper {
            transform: scale(1.1);
        }

        .kpi-icon-wrapper.classification { background: linear-gradient(135deg, #00aaff, #0088cc); }
        .kpi-icon-wrapper.profit-before { background: linear-gradient(135deg, #ffc107, #e0a800); }
        .kpi-icon-wrapper.adjustments { background: linear-gradient(135deg, #dc3545, #c82333); }
        .kpi-icon-wrapper.profit-after { background: linear-gradient(135deg, #28a745, #218838); }

        .kpi-content {
            text-align: right;
            flex-grow: 1;
        }

        .kpi-label {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            margin-bottom: 0.25rem;
        }

        .kpi-main-value {
            font-family: var(--font-family-display);
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-text-primary);
            line-height: 1.2;
        }

        .kpi-sub-value {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            font-family: monospace;
        }

        /* === لوحة المفتش الذكي (V5) === */
        .inspector-pane {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            height: 100%;
        }

        .inspector-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--color-border);
        }

        .inspector-title {
            font-family: var(--font-family-display);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-text-primary);
            margin-bottom: 0.25rem;
        }

        .inspector-subtitle {
            font-family: monospace;
            color: var(--color-text-secondary);
            background-color: rgba(139, 148, 158, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .balance-summary-card {
            background: linear-gradient(135deg, rgba(0, 170, 255, 0.1) 0%, rgba(40, 167, 69, 0.1) 100%);
            border: 1px solid var(--color-primary);
            border-radius: var(--border-radius-md);
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .balance-item {
            text-align: center;
            padding: 0.5rem;
        }

        .balance-item .label {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            display: block;
            margin-bottom: 0.25rem;
        }

        .balance-item .value {
            font-size: 1.2rem;
            font-weight: 700;
            font-family: monospace;
            display: block;
        }

        .quick-actions-card {
            background: var(--color-surface);
            border: 1px solid var(--color-success);
            border-radius: var(--border-radius-md);
            margin-bottom: 1.5rem;
        }

        .adjustments-table {
            font-size: 0.85rem;
        }

        .adjustments-table .table {
            margin-bottom: 0;
        }

        .adjustments-table th {
            background-color: var(--color-bg);
            font-size: 0.8rem;
            padding: 0.5rem;
        }

        .adjustments-table td {
            padding: 0.5rem;
            vertical-align: middle;
        }

        .notes-section {
            background: var(--color-surface);
            border: 1px solid var(--color-warning);
            border-radius: var(--border-radius-md);
        }

        .note-item {
            background-color: rgba(255, 193, 7, 0.1);
            border-left: 3px solid var(--color-warning);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: var(--border-radius-md);
        }

        /* === الجدول الرئيسي === */
        .table-responsive {
            max-height: 65vh;
            background-color: var(--color-surface);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--color-border);
        }

        .table { 
            border-collapse: separate; 
            border-spacing: 0; 
        }

        .table thead th {
            position: sticky; 
            top: 0;
            background-color: #1c222b;
            z-index: 10;
            color: var(--color-text-primary);
            border-bottom: 2px solid var(--color-primary) !important;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .table td {
            border-color: var(--color-border);
            vertical-align: middle;
            padding: 0.75rem;
        }

        .table tbody tr {
            transition: background-color 0.2s ease;
        }

        .table-hover tbody tr:hover { 
            background-color: rgba(0, 170, 255, 0.08); 
        }

        .table-hover tbody tr.table-active { 
            background-color: rgba(0, 170, 255, 0.15); 
        }

        /* === تظليل الحسابات ذات الأولوية === */
        .table tr.high-variance {
            background-color: rgba(255, 193, 7, 0.15) !important;
        }

        .table tr.abnormal-balance {
            background-color: rgba(220, 53, 69, 0.15) !important;
        }

        .table tr.unclassified-account {
            background-color: rgba(0, 170, 255, 0.15) !important;
        }

        .table tr.cockpit-focus {
            background: linear-gradient(
                90deg, 
                rgba(0, 170, 255, 0.2) 0%, 
                rgba(13, 17, 23, 0.1) 80%
            ) !important;
            animation: pulse-glow 2s infinite ease-in-out;
            border-left: 3px solid var(--color-primary) !important;
            border-right: 3px solid var(--color-primary) !important;
        }

        @keyframes pulse-glow {
            0% {
                box-shadow: 0 0 5px rgba(0, 170, 255, 0.3), inset 0 0 5px rgba(0, 170, 255, 0.2);
            }
            50% {
                box-shadow: 0 0 20px rgba(0, 170, 255, 0.6), inset 0 0 10px rgba(0, 170, 255, 0.4);
            }
            100% {
                box-shadow: 0 0 5px rgba(0, 170, 255, 0.3), inset 0 0 5px rgba(0, 170, 255, 0.2);
            }
        }

        /* === الأزرار والنماذج === */
        .btn {
            font-weight: 700;
            border-radius: var(--border-radius-md);
            transition: all 0.2s ease;
            padding: 0.5rem 1rem;
        }

        .btn-primary {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
        }

        .btn-primary:hover {
            box-shadow: 0 0 15px var(--color-primary-glow);
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: var(--color-success);
            border-color: var(--color-success);
        }

        .btn-success:hover {
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.5);
            transform: translateY(-2px);
        }

        .form-select, .form-control, .form-control[type="search"] {
            background-color: var(--color-bg);
            border-color: var(--color-border);
            color: var(--color-text-primary);
        }

        .form-select:focus, .form-control:focus, .form-control[type="search"]:focus {
            box-shadow: 0 0 0 0.25rem var(--color-primary-glow);
            border-color: var(--color-primary);
        }

        /* === النوافذ المنبثقة === */
        .modal-content {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
        }

        .modal-header, .modal-footer { 
            border-color: var(--color-border); 
        }

        .modal-title {
            font-family: var(--font-family-display);
            font-weight: 700;
        }

        /* === مؤشرات الحالة === */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 0.5rem;
        }

        .status-good { background-color: var(--color-success); }
        .status-warning { background-color: var(--color-warning); }
        .status-danger { background-color: var(--color-danger); }

        /* === شارات النسب === */
        .variance-badge {
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 5px;
        }

        .variance-badge.positive {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--color-success);
        }

        .variance-badge.negative {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--color-danger);
        }

        /* === الأرصدة السالبة === */
        .negative-balance { 
            color: var(--color-danger) !important; 
        }

        /* === الرسوم المتحركة === */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* === مؤشرات التحميل === */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 170, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--color-primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* === الإشعارات === */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
        }

        /* === الأيقونات التفاعلية === */
        .action-icon {
            color: var(--color-text-secondary);
            cursor: pointer; 
            transition: all 0.2s ease;
            margin: 0 0.25rem;
        }

        .action-icon:hover { 
            color: var(--color-primary); 
            transform: scale(1.2); 
        }

        /* === تصميم متجاوب === */
        @media (max-width: 768px) {
            .container-fluid {
                padding: 1rem;
            }
            
            .kpi-card {
                flex-direction: column;
                text-align: center;
                gap: 0.75rem;
            }
            
            .cockpit-title {
                font-size: 1.4rem;
            }
            
            .dashboard-title {
                font-size: 1.4rem;
            }
        }

        /* === تحسينات الطباعة === */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .table-responsive {
                max-height: none;
            }
            
            body {
                background-color: white;
                color: black;
            }
        }
    </style>
</head>
<body>
    <div id="globalNavbar" style="background-color: #161b22; border-bottom: 1px solid #30363d;">
        <div class="container-fluid d-flex align-items-center justify-content-between" style="padding: 0.5rem 1rem;">
            <div class="d-flex gap-3">
                <a id="nav_home" href="index.html" class="text-decoration-none" style="color: #c9d1d9"><i class="fas fa-home me-1"></i>الرئيسية</a>
                <a id="nav_mapping" href="account-mapping.html" class="text-decoration-none fw-bold" style="color: #00aaff"><i class="fas fa-tasks me-1"></i>الاستيعاب</a>
                <a id="nav_cockpit" href="consolidation-cockpit.html" class="text-decoration-none" style="color: #c9d1d9"><i class="fas fa-sitemap me-1"></i>القوائم المالية</a>
                <a id="nav_reports" href="reporting-pantheon.html" class="text-decoration-none" style="color: #c9d1d9"><i class="fas fa-book-open me-1"></i>التقارير</a>
                <a id="nav_zakat" href="zakat-diwan.html" class="text-decoration-none" style="color: #c9d1d9"><i class="fas fa-moon me-1"></i>الزكاة</a>
                <a id="nav_vat" href="vat-center.html" class="text-decoration-none" style="color: #c9d1d9"><i class="fas fa-percentage me-1"></i>القيمة المضافة</a>
            </div>
            <div class="text-secondary">POLARIS</div>
        </div>
    </div>
    <div class="container-fluid">
        <!-- شاشة التحميل -->
        <div id="loader" class="text-center my-5">
            <div class="loading-spinner mb-3"></div>
            <h3 style="color: var(--color-text-secondary); font-family: var(--font-family-main);">
                جاري تهيئة محطة عمل المراجعة...
            </h3>
        </div>

        <!-- المحتوى الرئيسي -->
        <div id="appContainer" style="display: none;" class="fade-in">
            <!-- رأس الصفحة -->
            <header class="page-header mb-4">
                <h1>
                    <i class="fas fa-rocket text-primary me-3"></i>
                    مراجعه ميزان المراجعه والتسويات
                </h1>
                <h4 id="clientNameSubtitle"></h4>
            </header>
            <div class="top-icons">
                <a id="top_home" href="index.html" title="الرئيسية"><i class="fas fa-home"></i></a>
                <a id="top_mapping" href="account-mapping.html" title="الاستيعاب"><i class="fas fa-balance-scale"></i></a>
                <a id="top_cockpit" href="consolidation-cockpit.html" title="القوائم المالية"><i class="fas fa-file-invoice"></i></a>
                <a id="top_reports" href="reporting-pantheon.html" title="التقارير"><i class="fas fa-book-open"></i></a>
                <a id="top_vat" href="vat-center.html" title="القيمة المضافة"><i class="fas fa-percentage"></i></a>
            </div>
    
    

          

        

        <!-- لوحة التحكم الذكية للمراجعة (النسخة المعدلة) -->
<div class="audit-cockpit mb-4">
    <div class="cockpit-header">
        <h4 class="cockpit-title">
            <i class="fas fa-brain me-2"></i>
            لوحة التحكم الذكية للمراجعة
        </h4>
        <button class="btn btn-outline-primary btn-sm no-print" onclick="refreshCockpit()">
            <i class="fas fa-sync-alt me-1"></i>
            تحديث التحليل
        </button>
    </div>
    <!-- ========= الجزء الجديد الذي تم إضافته ========= -->
    <div id="cockpit-alerts-container" class="mb-4">
        <!-- حاوية تنبيه عدم التوازن ستظهر هنا بواسطة JavaScript -->
        <!-- حاوية ملاحظات المراجعة الأولية ستظهر هنا بواسطة JavaScript -->
    </div>
    <!-- ============================================== -->
    
    <div class="row g-3">
        <!-- الأولوية القصوى -->
        <div class="col-lg-4 col-md-12">
            <div class="cockpit-section">
                <div class="section-header" onclick="toggleSection('high-priority')">
                    <div class="section-title">
                        <i class="fas fa-exclamation-triangle text-danger"></i>
                        الأولوية القصوى
                    </div>
                    <span class="priority-badge priority-high" id="high-priority-count">0</span>
                </div>
                <div id="high-priority-content" class="cockpit-list"></div>
            </div>
        </div>

        <!-- الأولوية الثانية -->
        <div class="col-lg-4 col-md-12">
            <div class="cockpit-section">
                <div class="section-header" onclick="toggleSection('medium-priority')">
                    <div class="section-title">
                        <i class="fas fa-lightbulb text-warning"></i>
                        تحتاج تحليل
                    </div>
                    <span class="priority-badge priority-medium" id="medium-priority-count">0</span>
                </div>
                <div id="medium-priority-content" class="cockpit-list"></div>
            </div>
        </div>

        <!-- مؤشرات للمتابعة -->
        <div class="col-lg-4 col-md-12">
            <div class="cockpit-section">
                <div class="section-header" onclick="toggleSection('follow-up')">
                    <div class="section-title">
                        <i class="fas fa-info-circle text-info"></i>
                        مؤشرات للمتابعة
                    </div>
                    <span class="priority-badge priority-follow" id="follow-up-count">0</span>
                </div>
                <div id="follow-up-content" class="cockpit-list"></div>
            </div>
        </div>
    </div>
</div>

<!-- إضافة قسم خاص للفروض في لوحة التحكم -->
<div class="variance-resolution-panel">
    <h5>حل الفروق</h5>
    <div id="varianceAnalysis"></div>
    <div id="suggestedActions"></div>
</div>

 <!-- لوحة التحليل المالي المقارن (V6) -->
<div class="financial-dashboard">
    <div class="dashboard-header">
        <h4 class="dashboard-title">
            <i class="fas fa-chart-pie me-2"></i>
            لوحة التحليل المالي المقارن
        </h4>
  <button class="btn btn-outline-warning btn-sm" onclick="cleanupAndRebuildKpiCards()">
    <i class="fas fa-broom me-1"></i>تنظيف وإعادة بناء البطاقات
</button>
    </div>

    <div class="row g-3" id="financial-ratios-container">
        <!-- بطاقة هامش الربح الإجمالي -->
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card" data-ratio="grossMargin">
                <div class="ratio-header">
                    <span class="ratio-label">هامش الربح الإجمالي</span>
                    <i class="fas fa-circle ratio-indicator indicator-warn"></i>
                </div>
                <div class="ratio-content">
                    <div class="ratio-value value-placeholder">0.0%</div>
                    <div class="ratio-comparison">
                        <i class="fas fa-minus"></i>
                        0.0%
                    </div>
                </div>
            </div>
        </div>

        <!-- بطاقة هامش صافي الربح -->
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card" data-ratio="netMargin">
                <div class="ratio-header">
                    <span class="ratio-label">هامش صافي الربح</span>
                    <i class="fas fa-circle ratio-indicator indicator-warn"></i>
                </div>
                <div class="ratio-content">
                    <div class="ratio-value value-placeholder">0.0%</div>
                    <div class="ratio-comparison">
                        <i class="fas fa-minus"></i>
                        0.0%
                    </div>
                </div>
            </div>
        </div>

        <!-- بطاقة العائد على الأصول -->
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card" data-ratio="roa">
                <div class="ratio-header">
                    <span class="ratio-label">العائد على الأصول</span>
                    <i class="fas fa-circle ratio-indicator indicator-warn"></i>
                </div>
                <div class="ratio-content">
                    <div class="ratio-value value-placeholder">0.0%</div>
                    <div class="ratio-comparison">
                        <i class="fas fa-minus"></i>
                        0.0%
                    </div>
                </div>
            </div>
        </div>

        <!-- بطاقة العائد على حقوق الملكية -->
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card" data-ratio="roe">
                <div class="ratio-header">
                    <span class="ratio-label">العائد على حقوق الملكية</span>
                    <i class="fas fa-circle ratio-indicator indicator-warn"></i>
                </div>
                <div class="ratio-content">
                    <div class="ratio-value value-placeholder">0.0%</div>
                    <div class="ratio-comparison">
                        <i class="fas fa-minus"></i>
                        0.0%
                    </div>
                </div>
            </div>
        </div>

        <!-- بطاقة نسبة التداول -->
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card" data-ratio="currentRatio">
                <div class="ratio-header">
                    <span class="ratio-label">نسبة التداول</span>
                    <i class="fas fa-circle ratio-indicator indicator-warn"></i>
                </div>
                <div class="ratio-content">
                    <div class="ratio-value value-placeholder">0.0x</div>
                    <div class="ratio-comparison">
                        <i class="fas fa-minus"></i>
                        0.0x
                    </div>
                </div>
            </div>
        </div>

        <!-- بطاقة نسبة السيولة السريعة -->
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card" data-ratio="quickRatio">
                <div class="ratio-header">
                    <span class="ratio-label">نسبة السيولة السريعة</span>
                    <i class="fas fa-circle ratio-indicator indicator-warn"></i>
                </div>
                <div class="ratio-content">
                    <div class="ratio-value value-placeholder">0.0x</div>
                    <div class="ratio-comparison">
                        <i class="fas fa-minus"></i>
                        0.0x
                    </div>
                </div>
            </div>
        </div>

        <!-- بطاقة نسبة الديون إلى حقوق الملكية -->
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card" data-ratio="debtToEquity">
                <div class="ratio-header">
                    <span class="ratio-label">الديون إلى حقوق الملكية</span>
                    <i class="fas fa-circle ratio-indicator indicator-warn"></i>
                </div>
                <div class="ratio-content">
                    <div class="ratio-value value-placeholder">0.0x</div>
                    <div class="ratio-comparison">
                        <i class="fas fa-minus"></i>
                        0.0x
                    </div>
                </div>
            </div>
        </div>

        <!-- بطاقة معدل دوران الأصول -->
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card" data-ratio="assetTurnover">
                <div class="ratio-header">
                    <span class="ratio-label">معدل دوران الأصول</span>
                    <i class="fas fa-circle ratio-indicator indicator-warn"></i>
                </div>
                <div class="ratio-content">
                    <div class="ratio-value value-placeholder">0.0x</div>
                    <div class="ratio-comparison">
                        <i class="fas fa-minus"></i>
                        0.0x
                    </div>
                </div>
            </div>
        </div>

        <!-- بطاقة فترة التحصيل -->
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card" data-ratio="collectionPeriod">
                <div class="ratio-header">
                    <span class="ratio-label">فترة التحصيل (يوم)</span>
                    <i class="fas fa-circle ratio-indicator indicator-warn"></i>
                </div>
                <div class="ratio-content">
                    <div class="ratio-value value-placeholder">0</div>
                    <div class="ratio-comparison">
                        <i class="fas fa-minus"></i>
                        0 يوم
                    </div>
                </div>
            </div>
        </div>

        <!-- بطاقة معدل دوران المخزون -->
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card" data-ratio="inventoryTurnover">
                <div class="ratio-header">
                    <span class="ratio-label">معدل دوران المخزون</span>
                    <i class="fas fa-circle ratio-indicator indicator-warn"></i>
                </div>
                <div class="ratio-content">
                    <div class="ratio-value value-placeholder">0.0x</div>
                    <div class="ratio-comparison">
                        <i class="fas fa-minus"></i>
                        0.0x
                    </div>
                </div>
            </div>
        </div>

        <!-- بطاقة نسبة الديون -->
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="ratio-card" data-ratio="debtRatio">
                <div class="ratio-header">
                    <span class="ratio-label">نسبة الديون</span>
                    <i class="fas fa-circle ratio-indicator indicator-warn"></i>
                </div>
                <div class="ratio-content">
                    <div class="ratio-value value-placeholder">0.0%</div>
                    <div class="ratio-comparison">
                        <i class="fas fa-minus"></i>
                        0.0%
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

            <!-- شريط التحكم -->
            <div class="control-pane mb-3 p-3" style="background-color: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--border-radius-lg);">
                <div class="d-flex gap-2 flex-wrap align-items-center">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#materialityModal">
                        <i class="fas fa-bullseye me-2"></i>الأهمية النسبية
                    </button>
                    
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addAccountModal" title="إضافة حساب جديد للميزان">
                        <i class="fas fa-plus-circle me-2"></i>إضافة حساب جديد
                    </button>
                    
                    <select class="form-select w-auto" id="filterCategory">
                        <option value="all">جميع الفئات</option>
                        <option value="assets">الأصول</option>
                        <option value="liabilities">الالتزامات</option>
                        <option value="equity">حقوق الملكية</option>
                        <option value="revenue">الإيرادات</option>
                        <option value="expenses">المصروفات</option>
                        <option value="unclassified">غير مصنف (فئة رئيسية)</option>
                        <option value="no_subcategory" class="text-warning">-- بدون تصنيف فرعي --</option>
                    </select>
                    
                    <select class="form-select w-auto" id="filterStatus">
                        <option value="all">جميع الحالات</option>
                        <option value="pending">قيد المراجعة</option>
                        <option value="reviewed">تمت المراجعة</option>
                        <option value="flagged">تحتاج تدقيق</option>
                    </select>
                    
                    <input type="search" class="form-control w-auto flex-grow-1" id="searchInput" placeholder="ابحث بالاسم أو الرقم...">
                    
                    <!-- الأزرار الوظيفية -->
                    <button class="btn btn-outline-info" id="reclassifyButton" title="إعادة تطبيق قواعد التصنيف التلقائي">
                        <i class="fas fa-wand-magic-sparkles me-2"></i>إعادة التصنيف
                    </button>
                    
                    <button class="btn btn-outline-primary" id="logicalCheckButton" title="تدقيق منطقية الأرصدة">
                        <i class="fas fa-tasks me-2"></i>تدقيق المنطقية
                    </button>
                    
                    <button class="btn btn-outline-success" id="saveChangesButton" title="حفظ التغييرات">
                        <i class="fas fa-save me-2"></i>حفظ التغييرات
                    </button>
                    
                    <button class="btn btn-outline-primary" id="reviewAllButton" title="تغيير حالة جميع الحسابات إلى (تمت المراجعة)">
                        <i class="fas fa-check-double me-2"></i>مراجعة الكل
                    </button>
                    
                    <button class="btn btn-outline-secondary" id="exportButton">
                        <i class="fas fa-file-excel me-2"></i>تصدير Excel
                    </button>
                    <button class="btn btn-outline-info btn-sm me-2" onclick="diagnoseAdjustmentEffect()">
    <i class="fas fa-stethoscope me-1"></i>تشخيص تأثير القيود
</button>
                    <button class="btn btn-outline-info" onclick="downloadBackup()" title="تنزيل نسخة احتياطية">
                        <i class="fas fa-download me-2"></i>تنزيل نسخة
                    </button>
                    
                    <button class="btn btn-info" onclick="triggerRestore()" title="استعادة نسخة احتياطية">
                        <i class="fas fa-upload me-2"></i>استعادة نسخة
                    </button>
                    <input type="file" id="restoreInput" class="d-none" accept=".json" onchange="restoreFromBackup(event)">
                    
                    <button class="btn btn-warning" onclick="openAdjustmentJournals()">
                        <i class="fas fa-edit me-2"></i>قيود التسوية
                    </button>
 
<!-- أضف هذه الأزرار في قسم التحكم -->
<button class="btn btn-outline-warning btn-sm" onclick="cleanupBrokenAdjustments()">
    <i class="fas fa-broom me-1"></i>تنظيف القيود المعطوبة
</button>
<button class="btn btn-outline-success btn-sm" onclick="finalSystemTest()">
    <i class="fas fa-vial me-1"></i>اختبار النظام النهائي
</button>                  <!-- أزرار الاعتماد والتقارير -->
                    <div class="ms-auto d-flex gap-2">
                        <button class="btn btn-success" id="finalizeButton" onclick="finalizeData()">
                            <i class="fas fa-stamp me-2"></i>اعتماد نهائي
                        </button>
                        <div class="btn-group">
                            <button type="button" class="btn btn-info dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fas fa-arrow-alt-circle-right me-2"></i>الانتقال إلى
                            </button>
                            <ul class="dropdown-menu dropdown-menu-dark">
                                <li><a class="dropdown-item" href="#" onclick="goToFinancialStatements()">القوائم المالية</a></li>
                                <li><a class="dropdown-item" href="#" onclick="goToReportsPantheon()">ديوان التقارير</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="goToZakatPage()">
                                        <i class="fas fa-moon me-2 text-success"></i>غرفة عمليات الزكاة
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- المحتوى الرئيسي -->
            <div class="row g-3">
                <!-- الجدول الرئيسي -->
                <div class="col-lg-8">
                    <div class="table-responsive">
                        <table class="table table-hover" id="trialBalanceTable">
                            <thead>
                                <tr>
                                    <th>الحساب</th>
                                    <th>الفئة</th>
                                    <th>التصنيف الفرعي</th>
                                    <th>رصيد سنة سابقة</th>
                                    <th>الرصيد النهائي</th>
                                    <th>التغير %</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

             <!-- استبدل قسم لوحة المفتش الذكية بالكود التالي -->
<!-- لوحة المفتش الذكي المحسّنة (V9) -->
<div class="col-lg-4">
    <div class="inspector-pane" id="inspector-pane-container">
        <div id="inspector-content" class="h-100">
            <!-- المحتوى الافتراضي قبل اختيار حساب -->
            <div class="text-center d-flex flex-column justify-content-center h-100">
                <i class="fas fa-search-location fa-3x text-primary opacity-50"></i>
                <h5 class="mt-3">لوحة المفتش الذكي</h5>
                <p class="text-muted">الرجاء تحديد حساب من الجدول لعرض تحليله.</p>
            </div>

            <!-- قالب المفتش الذكي (سيتم ملؤه بواسطة JavaScript) -->
            <div id="inspector-template" class="d-none">
                <div class="inspector-header mb-3">
                    <h4 class="inspector-title" id="inspectorAccountName"></h4>
                    <div class="inspector-subtitle" id="inspectorAccountId"></div>
                </div>

                <!-- التبويبات -->
                <ul class="nav nav-tabs nav-fill mb-3" id="inspectorTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                            <i class="fas fa-tachometer-alt me-1"></i> نظرة عامة
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ajes-tab" data-bs-toggle="tab" data-bs-target="#ajes" type="button" role="tab">
                            <i class="fas fa-exchange-alt me-1"></i> قيود التسوية <span class="badge bg-danger ms-1" id="ajes-count"></span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab">
                            <i class="fas fa-sticky-note me-1"></i> الملاحظات <span class="badge bg-warning text-dark ms-1" id="notes-count"></span>
                        </button>
                    </li>
                </ul>

                <!-- محتوى التبويبات -->
                <div class="tab-content" id="inspectorTabContent">
                    <!-- 1. تبويب نظرة عامة -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                        <!-- سيتم ملؤه بواسطة JavaScript -->
                    </div>
                    <!-- 2. تبويب قيود التسوية -->
                    <div class="tab-pane fade" id="ajes" role="tabpanel">
                        <!-- سيتم ملؤه بواسطة JavaScript -->
                    </div>
                    <!-- 3. تبويب الملاحظات -->
                    <div class="tab-pane fade" id="notes" role="tabpanel">
                        <!-- سيتم ملؤه بواسطة JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

            <!-- لوحة القيادة المصغرة -->
            <div class="kpi-dashboard">
                <div class="row g-3">
                    <!-- بطاقة نسبة الإنجاز -->
                    <div class="col-lg-3 col-md-6">
                        <div class="kpi-card">
                            <div class="kpi-icon-wrapper classification">
                                <i class="fas fa-sitemap"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-label">نسبة التصنيف المكتمل</div>
                                <div class="kpi-main-value" id="classificationRateDisplay">0%</div>
                                <div class="kpi-sub-value" id="classifiedAccountsDisplay">0 / 0 حساب</div>
                            </div>
                        </div>
                    </div>

                    <!-- بطاقة صافي الربح قبل التسويات -->
                    <div class="col-lg-3 col-md-6">
                        <div class="kpi-card">
                            <div class="kpi-icon-wrapper profit-before">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-label">صافي الربح (قبل التسويات)</div>
                                <div class="kpi-main-value" id="profitBeforeDisplay">0.00</div>
                            </div>
                        </div>
                    </div>

                    <!-- بطاقة أثر التسويات -->
                    <div class="col-lg-3 col-md-6">
                        <div class="kpi-card">
                            <div class="kpi-icon-wrapper adjustments">
                                <i class="fas fa-magic"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-label">أثر قيود التسوية (AJE)</div>
                                <div class="kpi-main-value" id="adjustmentsEffectDisplay">0.00</div>
                            </div>
                        </div>
                    </div>

                    <!-- بطاقة صافي الربح النهائي -->
                    <div class="col-lg-3 col-md-6">
                        <div class="kpi-card">
                            <div class="kpi-icon-wrapper profit-after">
                                <i class="fas fa-check-double"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-label">صافي الربح النهائي (المعدل)</div>
                                <div class="kpi-main-value" id="netProfitDisplay">0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- جميع النوافذ المنبثقة -->
        <!-- Materiality Modal -->
        <div class="modal fade" id="materialityModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">الأهمية النسبية</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="materialityBase" class="form-label">أساس الحساب</label>
                            <select class="form-select" id="materialityBase">
                                <option value="profit">صافي الربح قبل التسويات</option>
                                <option value="revenue">إجمالي الإيرادات</option>
                                <option value="assets">إجمالي الأصول</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="materialityPercentage" class="form-label">النسبة (%)</label>
                            <input type="number" class="form-control" id="materialityPercentage" value="5" step="0.1">
                        </div>
                        <div class="alert alert-info">
                            القيمة المحسوبة: <strong id="materialityValue">0.00</strong>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                        <button type="button" class="btn btn-primary" onclick="applyMateriality()">تطبيق وحفظ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- مودال إضافة حساب جديد -->
        <div class="modal fade" id="addAccountModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
                        <h5 class="modal-title">
                            <i class="fas fa-plus-circle me-2"></i>إضافة حساب جديد للميزان
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info" role="alert">
                            <i class="fas fa-info-circle me-2"></i>الرجاء ملء جميع الحقول المطلوبة (بعلامة <span style="color: #dc3545;">*</span>)
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="newAccountId" class="form-label">رقم الحساب <span style="color: #dc3545;">*</span></label>
                                <input type="text" class="form-control" id="newAccountId" placeholder="مثال: 101001" required>
                                <small class="text-muted">يجب أن يكون رقماً فريداً</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="newAccountName" class="form-label">اسم الحساب <span style="color: #dc3545;">*</span></label>
                                <input type="text" class="form-control" id="newAccountName" placeholder="مثال: النقدية" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="newAccountCategory" class="form-label">الفئة <span style="color: #dc3545;">*</span></label>
                                <select class="form-select" id="newAccountCategory" required>
                                    <option value="">-- اختر الفئة --</option>
                                    <option value="assets">الأصول</option>
                                    <option value="liabilities">الالتزامات</option>
                                    <option value="equity">حقوق الملكية</option>
                                    <option value="revenue">الإيرادات</option>
                                    <option value="expenses">المصروفات</option>
                                    <option value="cost_of_revenue">تكلفة الإيرادات</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="newAccountSubCategory" class="form-label">التصنيف الفرعي</label>
                                <input type="text" class="form-control" id="newAccountSubCategory" placeholder="اختياري">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="newAccountDebit" class="form-label">رصيد مدين</label>
                                <input type="number" class="form-control" id="newAccountDebit" placeholder="0.00" step="0.01" value="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="newAccountCredit" class="form-label">رصيد دائن</label>
                                <input type="number" class="form-control" id="newAccountCredit" placeholder="0.00" step="0.01" value="0">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                        <button type="button" class="btn btn-success" onclick="addNewAccount()">
                            <i class="fas fa-plus me-1"></i>إضافة الحساب
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- AJE Modal -->
    <!-- نافذة قيد التسوية المحسّنة -->
<div class="modal fade" id="ajeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt me-2"></i>
                    <span id="ajeModalTitle">إنشاء قيد تسوية جديد</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- نوع القيد -->
                <div class="card mb-3 border-0 bg-light">
                    <div class="card-body">
                        <div class="form-check form-switch form-check-lg">
                            <input class="form-check-input" type="checkbox" role="switch" id="isRceSwitch">
                            <label class="form-check-label fw-bold" for="isRceSwitch">
                                <i class="fas fa-sync-alt me-2 text-info"></i>
                                إعادة تصنيف (RCE)
                                <small class="d-block text-muted">لا يؤثر على صافي الربح - لنقل المبالغ بين حسابات الأصول أو الالتزامات</small>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- معلومات القيد الأساسية -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            <i class="fas fa-calendar-alt me-1 text-primary"></i>
                            التاريخ
                        </label>
                        <input type="date" class="form-control form-control-lg" id="ajeDate" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            <i class="fas fa-hashtag me-1 text-primary"></i>
                            المرجع (اختياري)
                        </label>
                        <input type="text" class="form-control form-control-lg" id="ajeReference" placeholder="مثال: قيد/2024/001">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fas fa-edit me-1 text-primary"></i>
                        وصف القيد
                    </label>
                    <textarea class="form-control form-control-lg" id="ajeDescription" rows="2" placeholder="اكتب وصفاً واضحاً للقيد..." required></textarea>
                </div>

                <!-- تفاصيل القيد -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-coins me-2"></i>
                            تفاصيل القيد
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- الحساب المدين -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold text-danger">
                                    <i class="fas fa-arrow-up me-1"></i>
                                    الحساب المدين (منه)
                                </label>
                                <div class="search-container">
                                    <input type="text" class="form-control form-control-lg mb-2" id="searchDebitAccount" placeholder="ابحث عن الحساب...">
                                    <select class="form-select form-select-lg" id="ajeDebitAccount" size="6" required>
                                        <option value="">اختر الحساب المدين...</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- الحساب الدائن -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold text-success">
                                    <i class="fas fa-arrow-down me-1"></i>
                                    الحساب الدائن (له)
                                </label>
                                <div class="search-container">
                                    <input type="text" class="form-control form-control-lg mb-2" id="searchCreditAccount" placeholder="ابحث عن الحساب...">
                                    <select class="form-select form-select-lg" id="ajeCreditAccount" size="6" required>
                                        <option value="">اختر الحساب الدائن...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- المبلغ -->
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-money-bill-wave me-1 text-primary"></i>
                                    المبلغ
                                </label>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text">ر.س</span>
                                    <input type="number" class="form-control" id="ajeAmount" step="0.01" min="0" placeholder="0.00" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-calculator me-1 text-info"></i>
                                    المبلغ بالكلمات
                                </label>
                                <div class="form-control-plaintext fw-bold text-primary" id="amountInWords">
                                    سيتم عرض المبلغ بالكلمات هنا
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- معاينة القيد -->
                <div class="card mb-3 border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-eye me-2"></i>
                            معاينة القيد
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-5">
                                <div class="border rounded p-3 bg-light">
                                    <h6 class="text-danger mb-2">مدين</h6>
                                    <div id="debitPreview" class="fw-bold">لم يتم تحديد الحساب</div>
                                </div>
                            </div>
                            <div class="col-md-2 d-flex align-items-center justify-content-center">
                                <i class="fas fa-arrows-alt-h fa-2x text-muted"></i>
                            </div>
                            <div class="col-md-5">
                                <div class="border rounded p-3 bg-light">
                                    <h6 class="text-success mb-2">دائن</h6>
                                    <div id="creditPreview" class="fw-bold">لم يتم تحديد الحساب</div>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <div class="badge bg-primary fs-6" id="amountPreview">المبلغ: 0.00 ر.س</div>
                        </div>
                    </div>
                </div>

                <!-- الحسابات المفضلة -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-star me-2"></i>
                            الحسابات المفضلة
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-2" id="favoriteAccounts">
                            <!-- سيتم ملؤها ديناميكيًا -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    إلغاء
                </button>
                <button type="button" class="btn btn-primary btn-lg" onclick="validateAndSaveAdjustment()">
                    <i class="fas fa-save me-2"></i>
                    حفظ القيد
                </button>
            </div>
        </div>
    </div>
</div>

        <!-- vAI Assistant Modal -->
        <div class="modal fade" id="vAIAssistantModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-user-secret text-primary me-2"></i>
                            استشارة الخبير التنفيذي
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="vAIAssistantResponse">
                            <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                        </div>
                        <div id="vAIActionButtons" class="mt-3 pt-3 border-top">
                            <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Depreciation Wizard Modal -->
        <div class="modal fade" id="depreciationWizardModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-magic text-info me-2"></i>
                            المحلل الذكي للأصول
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-muted">قام المحلل بقراءة البيانات التالية من ميزان المراجعة:</p>
                        <div class="row p-2" style="background-color: var(--color-bg); border-radius: var(--border-radius-md);">
                            <div class="col-md-6">
                                <label class="small">إجمالي تكلفة الأصول الثابتة</label>
                                <h4 id="autoReadAssets" class="text-info">0.00</h4>
                            </div>
                            <div class="col-md-6">
                                <label class="small">مصروف الإهلاك المسجل خلال العام</label>
                                <h4 id="autoReadDepreciationMovement" class="text-info">0.00</h4>
                            </div>
                        </div>
                        <hr style="border-color: var(--color-border);">
                        <div class="mb-3">
                            <label for="depreciationRate" class="form-label">أدخل متوسط نسبة الإهلاك السنوي (%):</label>
                            <input type="number" class="form-control" id="depreciationRate" placeholder="مثال: 20">
                        </div>
                        <div class="p-3 mt-3" style="background-color: var(--color-bg); border-radius: var(--border-radius-md);">
                            <p class="mb-1">إجمالي الإهلاك السنوي المستحق: <span id="totalRequiredDepreciation" class="fw-bold">0.00</span></p>
                            <p class="mb-1">(-) مصروف الإهلاك المسجل مسبقاً: <span id="alreadyBookedDepreciation" class="fw-bold">0.00</span></p>
                            <hr style="border-color: var(--color-border);">
                            <h5 class="mb-0">صافي قيد التسوية المطلوب: <span id="netAdjustmentNeeded" class="text-warning">0.00</span></h5>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">إلغاء</button>
                        <button type="button" class="btn btn-primary" onclick="createDepreciationAdjustmentEntry()">
                            <i class="fas fa-check-circle me-2"></i>إنشاء قيد التسوية الصافي
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Adjustment Journals Modal -->
        <div class="modal fade" id="adjustmentJournalsModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-journal-whills me-2"></i>
                            مدير قيود التسوية الاحترافي
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- شريط الأدوات العلوي -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" id="adjustmentSearchInput" placeholder="ابحث في القيود...">
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-success me-2" onclick="showAddAdjustmentForm()">
                                    <i class="fas fa-plus-circle me-1"></i>قيد جديد
                                </button>
                                <button class="btn btn-info" onclick="exportAdjustmentsToExcel()">
                                    <i class="fas fa-file-excel me-1"></i>تصدير Excel
                                </button>
                            </div>
                        </div>

                        <!-- ملخص التأثير -->
                        <div class="card mb-3 border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i>
                                    ملخص تأثير القيود على صافي الربح
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <small class="text-muted">إجمالي القيود</small>
                                        <h5 class="mb-0" id="totalAdjCount">0</h5>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">إجمالي المدين</small>
                                        <h5 class="mb-0 text-danger" id="totalDebitAdj">0.00</h5>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">إجمالي الدائن</small>
                                        <h5 class="mb-0 text-success" id="totalCreditAdj">0.00</h5>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">صافي التأثير</small>
                                        <h5 class="mb-0" id="netAdjEffect">0.00</h5>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- جدول القيود -->
                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th width="40">#</th>
                                        <th width="100">التاريخ</th>
                                        <th width="120">الرقم</th>
                                        <th>الوصف</th>
                                        <th width="150">الحسابات</th>
                                        <th width="120">المبلغ</th>
                                        <th width="100">النوع</th>
                                        <th width="150">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="adjustmentsTableBody">
                                    <!-- سيتم ملؤه بواسطة JavaScript -->
                                </tbody>
                            </table>
                        </div>

                        <!-- نموذج إضافة/تعديل قيد -->
                        <div id="adjustmentFormSection" class="mt-4 p-3 border rounded bg-light" style="display: none;">
                            <h5 id="formTitle" class="mb-3">
                                <i class="fas fa-edit me-2"></i>
                                إضافة قيد تسوية جديد
                            </h5>
                            <form id="adjustmentForm" onsubmit="handleAdjustmentFormSubmit(event)">
                                <input type="hidden" id="editingAdjustmentId">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">الحساب المدين (منه)</label>
                                        <select id="adjDebitAccount" class="form-select" required></select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">الحساب الدائن (له)</label>
                                        <select id="adjCreditAccount" class="form-select" required></select>
                                    </div>
                                    <div class="col-md-8">
                                        <label class="form-label">الوصف/البيان</label>
                                        <input type="text" id="adjDescription" class="form-control" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">المبلغ</label>
                                        <input type="number" id="adjAmount" class="form-control" step="0.01" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">التاريخ</label>
                                        <input type="date" id="adjDate" class="form-control" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">نوع القيد</label>
                                        <select id="adjType" class="form-select">
                                            <option value="AJE">قيد تسوية عادي</option>
                                            <option value="RCE">إعادة تصنيف (لا يؤثر على الربح)</option>
                                        </select>
                                    </div>
                                    <div class="col-12 mt-3">
                                        <button type="submit" class="btn btn-success me-2">
                                            <i class="fas fa-save me-1"></i>حفظ القيد
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="hideAdjustmentForm()">
                                            <i class="fas fa-times me-1"></i>إلغاء
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workpapers Modal -->
        <div class="modal fade" id="workpapersModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="workpapersModalTitle">أوراق العمل</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>الحساب:</strong> <span id="workpapersAccountName" class="fw-bold"></span></p>
                        
                        <button class="btn btn-primary btn-sm" onclick="uploadWorkpaper()">رفع وحفظ</button>
                        <hr>
                        <h6>المستندات المرفقة:</h6>
                        <ul class="list-group" id="workpapersList">
                            <li class="list-group-item">لا توجد مستندات مرفقة حالياً.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
        <script>
        // === المتغيرات العامة ===
        let auditFile = {};
        let userPrefs = {};
        let ajeModal, materialityModal, vAIAssistantModal, workpapersModal, depreciationWizardModal, adjustmentJournalsModal;
        let currentVAIContext = {};
        let currentWorkpaperAccountId = null;
        const CURRENCY = 'SAR';
        const VARIANCE_THRESHOLD = 25;
        let isAppInitialized = false;

        // === قاعدة البيانات المحاسبية ===
        const subCategoryMap = {
            'assets': [
                // الأصول المتداولة
                { group: '1110: النقد وما في حكمه', value: '111001', label: 'الصندوق الرئيسي' },
                { group: '1110: النقد وما في حكمه', value: '111002', label: 'صناديق الفروع ونقاط البيع' },
                { group: '1110: النقد وما في حكمه', value: '111003', label: 'صندوق المصروفات النثرية (Petty Cash)' },
                { group: '1110: النقد وما في حكمه', value: '111011', label: 'حسابات جارية بالبنوك (محلي)' },
                { group: '1110: النقد وما في حكمه', value: '111012', label: 'حسابات جارية بالبنوك (أجنبي)' },
                { group: '1110: النقد وما في حكمه', value: '111021', label: 'ودائع بنكية قصيرة الأجل' },
                { group: '1110: النقد وما في حكمه', value: '111031', label: 'بطاقات ائتمان وأموال قيد التحصيل' },
                
                { group: '1120: استثمارات قصيرة الأجل', value: '112001', label: 'استثمارات في أوراق مالية للمتاجرة' },
                { group: '1120: استثمارات قصيرة الأجل', value: '112002', label: 'استثمارات متاحة للبيع (الجزء المتداول)' },

                { group: '1130: الذمم المدينة التجارية', value: '113001', label: 'عملاء - قطاع عام' },
                { group: '1130: الذمم المدينة التجارية', value: '113002', label: 'عملاء - قطاع خاص' },
                { group: '1130: الذمم المدينة التجارية', value: '113003', label: 'عملاء - أفراد' },
                { group: '1130: الذمم المدينة التجارية', value: '113004', label: 'عملاء - تصدير' },
                { group: '1130: الذمم المدينة التجارية', value: '113099', label: '(-) مخصص ديون مشكوك في تحصيلها' },

                { group: '1140: الذمم المدينة الأخرى', value: '114001', label: 'ذمم أطراف ذات علاقة (مدينة)' },
                { group: '1140: الذمم المدينة الأخرى', value: '114002', label: 'سلف الموظفين (رواتب، شخصية)' },
                { group: '1140: الذمم المدينة الأخرى', value: '114003', label: 'عهد مؤقتة ومستديمة' },
                { group: '1140: الذمم المدينة الأخرى', value: '114004', label: 'تأمينات لدى الغير (إيجار، خدمات)' },
                { group: '1140: الذمم المدينة الأخرى', value: '114005', label: 'خطابات ضمان (غطاء مدين)' },

                { group: '1150: المصروفات المدفوعة مقدماً', value: '115001', label: 'إيجار مدفوع مقدماً' },
                { group: '1150: المصروفات المدفوعة مقدماً', value: '115002', label: 'تأمين مدفوع مقدماً' },
                { group: '1150: المصروفات المدفوعة مقدماً', value: '115003', label: 'اشتراكات ورخص مدفوعة مقدماً' },
                { group: '1150: المصروفات المدفوعة مقدماً', value: '115099', label: 'مصروفات أخرى مدفوعة مقدماً' },
                
                { group: '1160: المخزون', value: '116001', label: 'مخزون - مواد خام' },
                { group: '1160: المخزون', value: '116002', label: 'مخزون - إنتاج تحت التشغيل' },
                { group: '1160: المخزون', value: '116003', label: 'مخزون - منتجات تامة الصنع' },
                { group: '1160: المخزون', value: '116004', label: 'مخزون - بضاعة بغرض التجارة' },
                { group: '1160: المخزون', value: '116005', label: 'مخزون - قطع غيار ومهمات تشغيل' },
                { group: '1160: المخزون', value: '116006', label: 'بضاعة بالطريق واعتمادات مستندية' },
                { group: '1160: المخزون', value: '116099', label: '(-) مخصص هبوط أسعار المخزون' },
                
                // الأصول غير المتداولة
                { group: '1210: الأصول الثابتة', value: '121001', label: 'أراضي' },
                { group: '1210: الأصول الثابتة', value: '121002', label: 'مباني وإنشاءات' },
                { group: '1210: الأصول الثابتة', value: '121003', label: 'آلات ومعدات المصنع' },
                { group: '1210: الأصول الثابتة', value: '121004', label: 'سيارات ووسائل نقل' },
                { group: '1210: الأصول الثابتة', value: '121005', label: 'أثاث وتجهيزات مكتبية' },
                { group: '1210: الأصول الثابتة', value: '121006', label: 'أجهزة كمبيوتر وشبكات' },
                { group: '1210: الأصول الثابتة', value: '121007', label: 'تحسينات على عقارات مستأجرة' },
                { group: '1210: الأصول الثابتة', value: '121099', label: '(-) مجمع الإهلاك' },

                { group: '1220: استثمارات طويلة الأجل', value: '122001', label: 'استثمارات في شركات تابعة' },
                { group: '1220: استثمارات طويلة الأجل', value: '122002', label: 'استثمارات في شركات زميلة' },
                { group: '1220: استثمارات طويلة الأجل', value: '122003', label: 'استثمارات عقارية' },
                { group: '1220: استثمارات طويلة الأجل', value: '122004', label: 'استثمارات مالية محتفظ بها لتاريخ الاستحقاق' },

                { group: '1230: أصول غير ملموسة', value: '123001', label: 'شهرة' },
                { group: '1230: أصول غير ملموسة', value: '123002', label: 'برامج وتراخيص وأنظمة' },
                { group: '1230: أصول غير ملموسة', value: '123003', label: 'علامات تجارية وبراءات اختراع' },
                { group: '1230: أصول غير ملموسة', value: '123004', label: 'تكاليف تطوير مؤجلة' },
                { group: '1230: أصول غير ملموسة', value: '123099', label: '(-) مجمع الإطفاء' },

                { group: '1240: أصول أخرى', value: '124001', label: 'مشاريع رأسمالية تحت التنفيذ' },
            ],
            'liabilities': [
                // الالتزامات المتداولة
                { group: '2110: الموردون والأرصدة الدائنة', value: '211001', label: 'الموردون (ذمم دائنة تجارية)' },
                { group: '2110: الموردون والأرصدة الدائنة', value: '211002', label: 'ذمم أطراف ذات علاقة (دائنة)' },
                { group: '2110: الموردون والأرصدة الدائنة', value: '211003', label: 'دفعات مقدمة من العملاء' },
                { group: '2110: الموردون والأرصدة الدائنة', value: '211004', label: 'أوراق دفع' },

                { group: '2120: المصروفات المستحقة', value: '212001', label: 'رواتب وأجور مستحقة' },
                { group: '2120: المصروفات المستحقة', value: '212002', label: 'مكافآت مستحقة للموظفين' },
                { group: '2120: المصروفات المستحقة', value: '212003', label: 'فواتير خدمات مستحقة' },
                { group: '2120: المصروفات المستحقة', value: '212004', label: 'فوائد مستحقة الدفع' },
                { group: '2120: المصروفات المستحقة', value: '212099', label: 'مصروفات أخرى مستحقة الدفع' },
                
                { group: '2130: مستحقات حكومية', value: '213001', label: 'ضريبة القيمة المضافة المستحقة' },
                { group: '2130: مستحقات حكومية', value: '213002', label: 'زكاة وضرائب مستحقة الدفع' },
                { group: '2130: مستحقات حكومية', value: '213003', label: 'ضريبة استقطاع مستحقة' },
                { group: '2130: مستحقات حكومية', value: '213004', label: 'تأمينات اجتماعية مستحقة' },

                { group: '2140: قروض ومخصصات متداولة', value: '214001', label: 'تسهيلات بنكية (سحب على المكشوف)' },
                { group: '2140: قروض ومخصصات متداولة', value: '214002', label: 'الجزء المتداول من القروض طويلة الأجل' },
                { group: '2140: قروض ومخصصات متداولة', value: '214003', label: 'توزيعات أرباح مستحقة' },

                // الالتزامات غير المتداولة
                { group: '2210: قروض طويلة الأجل', value: '221001', label: 'قروض طويلة الأجل' },
                { group: '2210: قروض طويلة الأجل', value: '221002', label: 'سندات وصكوك' },
                { group: '2220: مخصصات والتزامات أخرى', value: '222001', label: 'مخصص مكافأة نهاية الخدمة' },
                { group: '2220: مخصصات والتزامات أخرى', value: '222002', label: 'مخصص قضايا ومطالبات' },
                { group: '2220: مخصصات والتزامات أخرى', value: '222003', label: 'مخصص ضمان منتجات' },
                { group: '2220: مخصصات والتزامات أخرى', value: '222004', label: 'التزامات ضريبية مؤجلة' },
            ],
            'equity': [
                { group: '3100: رأس المال المصدر والمدفوع', value: '310001', label: 'رأس المال' },
                { group: '3100: رأس المال المصدر والمدفوع', value: '310002', label: 'علاوة إصدار أسهم' },
                { group: '3200: الاحتياطيات', value: '320001', label: 'احتياطي نظامي' },
                { group: '3200: الاحتياطيات', value: '320002', label: 'احتياطي اتفاقي / عام' },
                { group: '3200: الاحتياطيات', value: '320003', label: 'فائض إعادة تقييم' },
                { group: '3300: الأرباح والشركاء', value: '330001', label: 'أرباح مبقاة / (خسائر مدورة)' },
                { group: '3300: الأرباح والشركاء', value: '330002', label: 'صافي ربح الفترة (محسوب آلياً)' },
                { group: '3300: الأرباح والشركاء', value: '330003', label: 'توزيعات أرباح مدفوعة (مسحوبات)' },
                { group: '3300: الأرباح والشركاء', value: '330004', label: 'جاري المالك / الشركاء' }
            ],
            'revenue': [
                { group: '4100: إيرادات النشاط الرئيسي', value: '410001', label: 'إيرادات بيع منتجات' },
                { group: '4100: إيرادات النشاط الرئيسي', value: '410002', label: 'إيرادات تقديم خدمات' },
                { group: '4100: إيرادات النشاط الرئيسي', value: '410003', label: 'إيرادات عقود ومشاريع' },
                { group: '4100: إيرادات النشاط الرئيسي', value: '410098', label: '(-) مردودات المبيعات' },
                { group: '4100: إيرادات النشاط الرئيسي', value: '410099', label: '(-) خصم مسموح به' },
                
                { group: '4200: إيرادات أخرى', value: '420001', label: 'إيرادات تشغيلية أخرى (بيع خردة)' },
                { group: '4200: إيرادات أخرى', value: '420002', label: 'إيرادات تأجير ممتلكات' },
                { group: '4200: إيرادات أخرى', value: '420003', label: 'أرباح رأسمالية (بيع أصول)' },
                { group: '4200: إيرادات أخرى', value: '420004', label: 'فوائد دائنة وإيرادات استثمارات' },
                { group: '4200: إيرادات أخرى', value: '420005', label: 'إيرادات متنوعة (جزاءات، غرامات)' },
            ],
            'expenses': [
                { group: '5100: تكلفة الإيرادات', value: '510001', label: 'تكلفة المواد المباشرة المستخدمة' },
                { group: '5100: تكلفة الإيرادات', value: '510002', label: 'تكلفة الأجور المباشرة' },
                { group: '5100: تكلفة الإيرادات', value: '510003', label: 'تكاليف صناعية/تشغيلية غير مباشرة' },
                { group: '5100: تكلفة الإيرادات', value: '510004', label: 'تكلفة البضاعة المشتراة بغرض البيع' },

                { group: '6100: مصاريف بيع وتسويق', value: '610001', label: 'رواتب وعمولات فريق المبيعات' },
                { group: '6100: مصاريف بيع وتسويق', value: '610002', label: 'دعاية وإعلان وحملات تسويقية' },
                { group: '6100: مصاريف بيع وتسويق', value: '610003', label: 'مصاريف شحن وتوزيع' },
                { group: '6100: مصاريف بيع وتسويق', value: '610004', label: 'سفر وضيافة - فريق المبيعات' },

                { group: '6200: مصاريف عمومية وإدارية', value: '620001', label: 'رواتب ومزايا - الإدارة والموظفين' },
                { group: '6200: مصاريف عمومية وإدارية', value: '620002', label: 'حصة الشركة في التأمينات الاجتماعية' },
                { group: '6200: مصاريف عمومية وإدارية', value: '620003', label: 'إيجار المكاتب والمرافق' },
                { group: '6200: مصاريف عمومية وإدارية', value: '620004', label: 'كهرباء ومياه وهاتف وإنترنت' },
                { group: '6200: مصاريف عمومية وإدارية', value: '620005', label: 'صيانة وإصلاحات (غير صناعية)' },
                { group: '6200: مصاريف عمومية وإدارية', value: '620006', label: 'رسوم حكومية وتراخيص واشتراكات' },
                { group: '6200: مصاريف عمومية وإدارية', value: '620007', label: 'أتعاب مهنية (قانونية، مراجعة، استشارات)' },
                { group: '6200: مصاريف عمومية وإدارية', value: '620008', label: 'أدوات مكتبية ومطبوعات' },
                { group: '6200: مصاريف عمومية وإدارية', value: '620009', label: 'سفر وانتقالات - الإدارة' },
                { group: '6200: مصاريف عمومية وإدارية', value: '620010', label: 'مصروف ديون معدومة' },
                { group: '6200: مصاريف عمومية وإدارية', value: '620099', label: 'مصاريف عمومية وإدارية أخرى' },
                
                { group: '6300: إهلاك وإطفاء', value: '630001', label: 'مصروف إهلاك الأصول الثابتة' },
                { group: '6300: إهلاك وإطفاء', value: '630002', label: 'مصروف إطفاء الأصول غير الملموسة' },
                
                { group: '7100: مصاريف وخسائر أخرى', value: '710001', label: 'رسوم ومصاريف بنكية' },
                { group: '7100: مصاريف وخسائر أخرى', value: '710002', label: 'فوائد مدينة' },
                { group: '7100: مصاريف وخسائر أخرى', value: '710003', label: 'خسائر رأسمالية (بيع أصول)' },
                { group: '7100: مصاريف وخسائر أخرى', value: '710004', label: 'خسائر فروقات عملة' },
                { group: '7200: الزكاة والضرائب', value: '720001', label: 'مصروف زكاة وضرائب الدخل' }
            ],
            'clearing': [
                { group: '9100: حسابات نظامية', value: '910001', label: 'حسابات معلقة (Suspense)' },
                { group: '9100: حسابات نظامية', value: '910002', label: 'حسابات تسوية وسيطة (Clearing)' }
            ]
        };

// =====================================================================
// === قاعدة المعرفة المحاسبية (V22 - بناءً على عملك اليدوي) ===
// =====================================================================
const keywordMapping = [
    // =================================================================
    // === 1. قواعد الأولوية القصوى (الأكثر تحديداً ودقة) ==============
    // =================================================================
    
    // --- 1.0. القواعد الاستثنائية (الأولوية المطلقة) ---
    { keyword: 'مجمع اهلاك', value: '121099', priority: true },
    { keyword: 'مصروف مقدم', value: '115099', priority: true },

    // --- 1.1. المصروفات (بناءً على تقسيمك الدقيق) ---
    { keyword: 'تكلفة المبيعات', value: '510004', priority: true },
    { keyword: 'ديزل', value: '510003', priority: true },
    { keyword: 'اجور عمال', value: '510002', priority: true },
    { keyword: 'اهلاك', value: '630001', priority: true },
    { keyword: 'إهلاك', value: '630001', priority: true },
    { keyword: 'استهلاك', value: '630001', priority: true },
    { keyword: 'عمولة مبيعات', value: '610001', priority: true },
    { keyword: 'رواتب', value: '620001', priority: true },
    { keyword: 'اجور', value: '620001', priority: true },
    { keyword: 'ايجار', value: '620003', priority: true },
    { keyword: 'كهرباء', value: '620004', priority: true },
    { keyword: 'صيانه', value: '620005', priority: true },
    { keyword: 'صيانة', value: '620005', priority: true },
    { keyword: 'رسوم حكومية', value: '620006', priority: true },
    { keyword: 'رسوم بنكيه', value: '710001', priority: true },
    { keyword: 'قرطاسية', value: '620008', priority: true },
    { keyword: 'سفر وانتقالات', value: '620009', priority: true },
    { keyword: 'زكاة', value: '720001', priority: true },
    { keyword: 'قطع غيار', value: '620099', priority: true }, // ✨ تم تصحيحه إلى مصروف
    { keyword: 'زيوت وتشحيم', value: '620099', priority: true }, // ✨ تم تصحيحه إلى مصروف
    { keyword: 'كفرات', value: '620099', priority: true }, // ✨ تم تصحيحه إلى مصروف
    { keyword: 'فلاتر', value: '620099', priority: true }, // ✨ تم تصحيحه إلى مصروف
    { keyword: 'بطاريات', value: '620099', priority: true }, // ✨ تم تصحيحه إلى مصروف
    { keyword: 'بنشر', value: '620099', priority: true }, // ✨ تم تصحيحه إلى مصروف
    { keyword: 'مصاريف', value: '620099', priority: true },
    { keyword: 'مصروف', value: '620099', priority: true },

    // --- 1.2. الحسابات الرقابية والوسيطة ---
    { keyword: 'مراقبة', value: '910002', priority: true },
    { keyword: 'وسيط', value: '910002', priority: true },
    { keyword: 'تسوية', value: '910002', priority: true },
    { keyword: 'معلقة', value: '910001', priority: true },
    { keyword: 'فروق', value: '910002', priority: true },

    // --- 1.3. الأصول (بعد المصاريف) ---
    { keyword: 'برامج حاسب', value: '123002', priority: true },
    { keyword: 'مصاريف تاسيس', value: '123004', priority: true },
    { keyword: 'شركات شقيقه', value: '122002', priority: true },
    { keyword: 'مبنى', value: '121002', priority: true },
    { keyword: 'سيارات', value: '121004', priority: true },
    { keyword: 'شاحنات', value: '121004', priority: true },
    { keyword: 'الات و معدات', value: '121003', priority: true },
    { keyword: 'أجهزة حاسب', value: '121006', priority: true },
    { keyword: 'اصول اخري', value: '121005', priority: true },
    { keyword: 'مخزن', value: '116004', priority: true },
    { keyword: 'مخزون', value: '116004', priority: true },
    { keyword: 'عهد', value: '114003', priority: true },
    { keyword: 'سلف', value: '114002', priority: true },
    { keyword: 'عملاء', value: '113002', priority: true },
    { keyword: 'صندوق', value: '111001', priority: true },
    { keyword: 'بنك', value: '111011', priority: true },

    // --- 1.4. الالتزامات وحقوق الملكية ---
    { keyword: 'فندق لامبرت', value: '212099', priority: true },
    { keyword: 'مستحقات مصلحة الزكاة', value: '213002', priority: true },
    { keyword: 'مستحقات', value: '212099', priority: true },
    { keyword: 'ضريبة القيمة المضافة', value: '213001', priority: true },
    { keyword: 'تأمينات اجتماعية', value: '213004', priority: true },
    { keyword: 'شركة تمويل', value: '221001', priority: true },
    { keyword: 'مؤسسه محمد مهدى', value: '211002', priority: true },
    { keyword: 'موردين', value: '211001', priority: true },
    { keyword: 'الأرباح والخساير المرحله', value: '330001', priority: true },
    { keyword: 'جارى', value: '330004', priority: true },

    // --- 1.5. الإيرادات ---
    { keyword: 'ايراد الاستقطاع', value: '420005', priority: true },
    { keyword: 'خصم مسموح به', value: '410099', priority: true },
    { keyword: 'خصم مكتسب', value: '420001', priority: true },
    { keyword: 'ايراد', value: '410002', priority: true },
    { keyword: 'مبيعات', value: '410001', priority: true }
];


        // === الدوال الرئيسية ===

        /**
         * تهيئة التطبيق
         */
        function initializeApplication() {
            if (isAppInitialized) {
                console.log("🔄 التطبيق مهيأ بالفعل. سيتم تحديث البيانات فقط.");
                renderAll();
                updateKpiPane();
                return;
            }

            console.log("🚀 بدء تهيئة التطبيق لأول مرة...");

            try {
                // تهيئة النوافذ المنبثقة
                ajeModal = new bootstrap.Modal(document.getElementById('ajeModal'));
                materialityModal = new bootstrap.Modal(document.getElementById('materialityModal'));
                vAIAssistantModal = new bootstrap.Modal(document.getElementById('vAIAssistantModal'));
                workpapersModal = new bootstrap.Modal(document.getElementById('workpapersModal'));
                depreciationWizardModal = new bootstrap.Modal(document.getElementById('depreciationWizardModal'));
                adjustmentJournalsModal = new bootstrap.Modal(document.getElementById('adjustmentJournalsModal'));

                // تحميل البيانات
                const activeClientId = localStorage.getItem('activeClientId');
                if (!activeClientId) {
                    throw new Error('لم يتم العثور على عميل نشط');
                }

                const realDataKey = `polarisAuditFile_${activeClientId}`;
                const savedAuditFile = localStorage.getItem(realDataKey);

                if (!savedAuditFile) {
                    throw new Error('لم يتم العثور على ملف المراجعة');
                }

                auditFile = JSON.parse(savedAuditFile);
                auditFile.settings = auditFile.settings || {};
                auditFile.adjustments = auditFile.adjustments || [];
                auditFile.auditLog = auditFile.auditLog || [];

                // دمج بيانات المقارنة
                const comparisonYear = new Date(auditFile.clientInfo.endDate).getFullYear() - 1;
                const comparisonKey = `comparisonData_${activeClientId}_${comparisonYear}`;
                const comparisonDataJSON = localStorage.getItem(comparisonKey);
                
                if (comparisonDataJSON) {
                    const comparisonData = JSON.parse(comparisonDataJSON);
                    auditFile.trialBalance.forEach(acc => {
                        const priorAcc = comparisonData.accounts.find(pAcc => pAcc.account_id === acc.account_id);
                        if (priorAcc) {
                            acc.pyb = (priorAcc.ob_debit || 0) - (priorAcc.ob_credit || 0);
                        }
                    });
                }

                // معالجة مسبقة للحسابات
                preProcessAccountAnalysis();

                // إعداد الواجهة
                autoCategorizeAccounts();
                userPrefs = loadUserPrefs(activeClientId);
                setupEventListeners();
                
                document.getElementById('clientNameSubtitle').textContent = auditFile.clientInfo.name || 'عميل غير محدد';
                
                document.getElementById('loader').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                
                       // عرض كل شيء في الواجهة
                renderAll();
                
                               // --- الجزء الجديد والمُنظم ---
                          setTimeout(() => {
                    refreshCockpitAlerts(); // استدعاء المايسترو فقط
                    updateKpiPane();
                    updateCockpit();
                }, 500);


                
                window.addEventListener('focus', () => {
                    initializeApplication();
                });
                
                isAppInitialized = true;
                console.log("✅ تم تهيئة التطبيق بنجاح");

            } catch (error) {
                console.error("❌ خطأ في تهيئة التطبيق:", error);
                handleFatalError(`<h4>خطأ فادح</h4><p>${error.message}</p>`);
            }
        }



/**
 * (المايسترو)
 * دالة مركزية لمسح وتحديث جميع التنبيهات والملاحظات في لوحة التحكم
 */
/**
 * تحديث جميع تنبيهات لوحة التحكم (نسخة موحدة)
 */
/**
 * تحديث جميع تنبيهات لوحة التحكم (نسخة موحدة ومحسّنة)
 */
function refreshCockpitAlerts() {
    try {
        console.log("🔄 تحديث تنبيهات لوحة التحكم...");
        
        const alertsContainer = document.getElementById('cockpit-alerts-container');
        if (!alertsContainer) {
            console.warn("⚠️ حاوية التنبيهات غير موجودة");
            return;
        }
        
        // مسح جميع التنبيهات الحالية
        alertsContainer.innerHTML = '';
        
        // التحقق من وجود بيانات
        if (!auditFile || !auditFile.trialBalance) {
            console.warn("⚠️ بيانات المراجعة غير متاحة");
            return;
        }
        
        // تحديث فحص التوازن
        updateBalanceCheck();
        
        // تحديث ملاحظات المراجعة الأولية
        generateReviewNotes();
        
        console.log("✅ تم تحديث التنبيهات بنجاح");
        
    } catch (error) {
        console.error("❌ خطأ في تحديث التنبيهات:", error);
    }
} 


function enhancedBalanceAnalysis() {
    const balanceData = PolarisBalanceChecker.calculateBalance(auditFile.trialBalance);
    
    if (!balanceData.isBalanced) {
        const difference = balanceData.difference;
        
        // تحليل سبب الفرق
        const analysis = analyzeDifferenceSource(difference);
        
        // عرض توصيات محددة
        showSpecificRecommendations(analysis);
    }
}

function analyzeDifferenceSource(difference) {
    // تحليل ما إذا كان الفرق ناتجًا عن خطأ في الإدخال
    // أو عن خطأ في التصنيف
    // أو عن قيد تسوية ناقص
    return {
        likelyCause: 'data_entry_error', // أو 'classification_error', 'missing_adjustment'
        suggestedAction: 'review_recent_entries',
        affectedAccounts: findPotentiallyAffectedAccounts(difference)
    };
}
function doubleEntryVerification(newAdjustment) {
    // التحقق من أن القيد الجديد لا يخلق عدم توازن جديد
    const tempAdjustments = [...auditFile.adjustments, newAdjustment];
    const tempBalance = calculateBalanceWithAdjustments(tempAdjustments);
    
    if (!tempBalance.isBalanced) {
        return {
            valid: false,
            message: 'هذا القيد سيؤدي إلى عدم توازن جديد في الميزان'
        };
    }
    
    return { valid: true };
} 
function doubleEntryVerification(newAdjustment) {
    // التحقق من أن القيد الجديد لا يخلق عدم توازن جديد
    const tempAdjustments = [...auditFile.adjustments, newAdjustment];
    const tempBalance = calculateBalanceWithAdjustments(tempAdjustments);
    
    if (!tempBalance.isBalanced) {
        return {
            valid: false,
            message: 'هذا القيد سيؤدي إلى عدم توازن جديد في الميزان'
        };
    }
    
    return { valid: true };
}
function refreshAllUI() {
    try {
        console.log("🔄 بدء تحديث واجهة المستخدم بالكامل...");
        
        // إعادة معالجة البيانات
        preProcessAccountAnalysis();
        
        // تحديث الجدول والواجهة الأساسية
        renderAll(); 
        
        // تحديث لوحة التحكم الذكية
        updateCockpit(); 
        
        // تحديث لوحة القيادة المصغرة
        updateKpiPane();
        
        // تحديث لوحة المفتش إذا كانت مفتوحة
        const activeRow = document.querySelector('#trialBalanceTable tr.table-active');
        if (activeRow && activeRow.dataset.accountId) {
            updateInspectorPane(activeRow.dataset.accountId);
        }
        
        console.log("✅ تم تحديث واجهة المستخدم بنجاح");
        
    } catch (error) {
        handleError(error, 'refreshAllUI');
    }
}
/**
 * معالجة الأخطاء بشكل موحد
 */
function handleError(error, context = '') {
    console.error(`Error in ${context}:`, error);
    
    let message = 'حدث خطأ غير متوقع';
    if (error.message) {
        message = error.message;
    }
    
    // عرض الإشعار للمستخدم
    showNotification(message, 'danger');
    
    // تسجيل الخطأ في سجل المراجعة إذا كان ملف المراجعة متاحاً
    if (auditFile && auditFile.auditLog) {
        addAuditLogEntry(`خطأ في ${context}: ${message}`);
    }
    
    // في حالة الأخطاء الحرجة، عرض تفاصيل إضافية في وحدة التحكم
    if (error.stack) {
        console.error('Stack trace:', error.stack);
    }
}

/**
 * تهيئة التطبيق (نسخة محسّنة)
 */
function initializeApplication() {
    try {
        console.log("🚀 بدء تهيئة التطبيق...");
        
        if (isAppInitialized) {
            console.log("🔄 التطبيق مهيأ بالفعل. سيتم تحديث البيانات فقط.");
            refreshAllUI();
            return;
        }

        // تهيئة النوافذ المنبثقة
        ajeModal = new bootstrap.Modal(document.getElementById('ajeModal'));
        materialityModal = new bootstrap.Modal(document.getElementById('materialityModal'));
        vAIAssistantModal = new bootstrap.Modal(document.getElementById('vAIAssistantModal'));
        workpapersModal = new bootstrap.Modal(document.getElementById('workpapersModal'));
        depreciationWizardModal = new bootstrap.Modal(document.getElementById('depreciationWizardModal'));
        adjustmentJournalsModal = new bootstrap.Modal(document.getElementById('adjustmentJournalsModal'));

        // تحميل البيانات
        const activeClientId = localStorage.getItem('activeClientId');
        if (!activeClientId) {
            throw new Error('لم يتم العثور على عميل نشط');
        }

        const realDataKey = `polarisAuditFile_${activeClientId}`;
        const savedAuditFile = localStorage.getItem(realDataKey);

        if (!savedAuditFile) {
            throw new Error('لم يتم العثور على ملف المراجعة');
        }

        auditFile = JSON.parse(savedAuditFile);
        auditFile.settings = auditFile.settings || {};
        auditFile.adjustments = auditFile.adjustments || [];
        auditFile.auditLog = auditFile.auditLog || [];

        // دمج بيانات المقارنة
        const comparisonYear = new Date(auditFile.clientInfo.endDate).getFullYear() - 1;
        const comparisonKey = `comparisonData_${activeClientId}_${comparisonYear}`;
        const comparisonDataJSON = localStorage.getItem(comparisonKey);
        
        if (comparisonDataJSON) {
            const comparisonData = JSON.parse(comparisonDataJSON);
            auditFile.trialBalance.forEach(acc => {
                const priorAcc = comparisonData.accounts.find(pAcc => pAcc.account_id === acc.account_id);
                if (priorAcc) {
                    acc.pyb = (priorAcc.ob_debit || 0) - (priorAcc.ob_credit || 0);
                }
            });
        }

        // معالجة مسبقة للحسابات
        preProcessAccountAnalysis();

        // إعداد الواجهة
        autoCategorizeAccounts();
        userPrefs = loadUserPrefs(activeClientId);
        setupEventListeners();
        
        document.getElementById('clientNameSubtitle').textContent = auditFile.clientInfo.name || 'عميل غير محدد';
        
        document.getElementById('loader').style.display = 'none';
        document.getElementById('appContainer').style.display = 'block';
        
        // عرض كل شيء في الواجهة
        refreshAllUI();
        
        window.addEventListener('focus', () => {
            refreshAllUI();
        });
        
        isAppInitialized = true;
        console.log("✅ تم تهيئة التطبيق بنجاح");

    } catch (error) {
        handleError(error, 'initializeApplication');
        handleFatalError(`<h4>خطأ فادح</h4><p>${error.message}</p>`);
    }
}
/**
 * عرض رسالة تأكيد محسّنة
 */
function showConfirmation(title, message, onConfirm, onCancel) {
    const modalHtml = `
        <div class="modal fade" id="confirmationModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${title}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${message}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                        <button type="button" class="btn btn-primary" id="confirmBtn">تأكيد</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // إزالة المودال الموجود إن وجد
    const existingModal = document.getElementById('confirmationModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // إضافة المودال الجديد
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // إعداد مستمعي الأحداث
    document.getElementById('confirmBtn').addEventListener('click', function() {
        if (onConfirm) onConfirm();
        bootstrap.Modal.getInstance(document.getElementById('confirmationModal')).hide();
    });
    
    // عرض المودال
    const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    modal.show();
    
    // إزالة المودال عند الإغلاق
    document.getElementById('confirmationModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
        if (onCancel) onCancel();
    });
}
/**
 * فحص وجود تنبيهات خاصة
 */
function checkForSpecialAlerts() {
    const alertsContainer = document.getElementById('cockpit-alerts-container');
    
    // التحقق من وجود حسابات غير مصنفة
    const unclassifiedAccounts = auditFile.trialBalance.filter(acc => !acc.category || !acc.sub_category);
    if (unclassifiedAccounts.length > 0) {
        const alertHTML = `
            <div class="alert alert-warning">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>تنبيه: حسابات غير مصنفة</h5>
                <p>يوجد ${unclassifiedAccounts.length} حساب غير مصنف. يرجى تصنيفها لضمان دقة التقارير.</p>
                <button class="btn btn-sm btn-primary" onclick="runAutoCategorization()">تصنيف تلقائي</button>
            </div>
        `;
        alertsContainer.innerHTML += alertHTML;
    }
    
    // التحقق من وجود حسابات ذات أرصدة شاذة
    const abnormalAccounts = auditFile.trialBalance.filter(acc => acc.isAbnormal);
    if (abnormalAccounts.length > 0) {
        const alertHTML = `
            <div class="alert alert-danger">
                <h5><i class="fas fa-exclamation-circle me-2"></i>تنبيه: أرصدة شاذة</h5>
                <p>يوجد ${abnormalAccounts.length} حساب بأرصدة شاذة. يرجى مراجعتها.</p>
                <button class="btn btn-sm btn-primary" onclick="performLogicalCheck()">فحص منطقي</button>
            </div>
        `;
        alertsContainer.innerHTML += alertHTML;
    }
}

        /**
         * المعالجة المسبقة للحسابات
/**


/**
 * إنشاء قيد تسوية تلقائي للفروقات البسيطة
 * @param {string} targetAccountId - الحساب الذي سيتم التسوية عليه
 * @param {number} difference - قيمة الفرق
 */
/**
/**
 * إنشاء قيد تسوية تلقائي للفروقات البسيطة (النسخة النهائية مع تحديث منظم)
 */
/**
 * إنشاء قيد تسوية تلقائي للفروقات البسيطة (النسخة النهائية مع تحديث منظم)
 */
/**
 * إنشاء قيد تسوية تلقائي للفروقات البسيطة (نسخة نهائية مع تحديث فوري)
 */
/**
 * إنشاء قيد تسوية تلقائي للفروقات البسيطة (نسخة مصححة مع تحديث فوري)
 */
function createRoundingAdjustment(targetAccountId, difference) {
    try {
        console.log("🔄 بدء إنشاء قيد تسوية للفروقات...");
        console.log("📊 الفرق الأصلي:", difference);
        
        // التحقق من صحة المدخلات
        if (!difference || difference === 0) {
            showNotification('لا يوجد فرق لمعالجته', 'info');
            return;
        }
        
        // التعامل مع الفروق الصغيرة جداً
        if (Math.abs(difference) < 0.000001) {
            console.log("📏 الفرق صغير جداً، سيتم تجاهله");
            showNotification('الفرق صغير جداً ولا يتطلب قيد تسوية', 'info');
            return;
        }
        
        // 1. تحديد الحساب المناسب للتسوية
        const isDebitDifference = difference > 0;
        let roundingAccountId, roundingAccountName, roundingCategory, roundingSubCategory;
        
        if (isDebitDifference) {
            // المدين أكبر من الدائن → نحتاج حساب دائن لزيادة الدائن
            roundingAccountName = 'إيراد فروقات التقريب';
            roundingAccountId = 'REV-9999';
            roundingCategory = 'revenue';
            roundingSubCategory = '420005';
        } else {
            // الدائن أكبر من المدين → نحتاج حساب مدين لزيادة المدين
            roundingAccountName = 'مصروف فروقات التقريب';
            roundingAccountId = 'EXP-9999';
            roundingCategory = 'expenses';
            roundingSubCategory = '620099';
        }

        // البحث عن حساب التسوية أو إنشاؤه
        let roundingAccount = auditFile.trialBalance.find(acc => acc.account_id === roundingAccountId);
        if (!roundingAccount) {
            roundingAccount = {
                account_id: roundingAccountId, 
                name: roundingAccountName, 
                category: roundingCategory,
                sub_category: roundingSubCategory, 
                book_balance: 0,
                ob_debit: 0,
                ob_credit: 0,
                move_debit: 0,
                move_credit: 0,
                review_status: 'pending',
                is_confirmed: false
            };
            auditFile.trialBalance.push(roundingAccount);
            console.log(`✅ تم إنشاء حساب "${roundingAccountName}" تلقائيًا.`);
        }

        // 2. تحديد الحساب المقابل (بدلاً من AUTO-ACCOUNT)
        let counterpartAccount = null;
        
        // البحث عن حساب مناسب للقيد
        if (targetAccountId === 'AUTO') {
            // البحث عن حساب كبير يمكن استخدامه
            const largeAccounts = auditFile.trialBalance
                .filter(acc => {
                    const balance = (acc.book_balance || 0) + calculateAdjustments(acc.account_id);
                    return Math.abs(balance) > 1000 && acc.category !== 'revenue' && acc.category !== 'expenses';
                })
                .sort((a, b) => {
                    const balanceA = Math.abs((a.book_balance || 0) + calculateAdjustments(a.account_id));
                    const balanceB = Math.abs((b.book_balance || 0) + calculateAdjustments(b.account_id));
                    return balanceB - balanceA;
                });
            
            if (largeAccounts.length > 0) {
                counterpartAccount = largeAccounts[0];
                console.log(`🎯 تم اختيار الحساب المقابل تلقائياً: ${counterpartAccount.name}`);
            }
        } else {
            counterpartAccount = auditFile.trialBalance.find(acc => acc.account_id === targetAccountId);
        }

        if (!counterpartAccount) {
            showNotification('لم يتم العثور على حساب مناسب للقيد', 'warning');
            return;
        }

        // 3. إنشاء القيد بالمنطق الصحيح
        const newAdj = {
            id: `ADJ-ROUND-${Date.now()}`, 
            type: 'AJE',
            description: `قيد تسوية تلقائي لمعالجة فرق التقريب (${formatCurrency(Math.abs(difference))})`,
            // تحديد الحسابات بشكل صحيح
            debit_account: isDebitDifference ? counterpartAccount.account_id : roundingAccount.account_id,
            credit_account: isDebitDifference ? roundingAccount.account_id : counterpartAccount.account_id,
            amount: Math.abs(difference),
            timestamp: new Date().toISOString()
        };

        console.log("📝 تفاصيل القيد الذي سيتم إنشاؤه:");
        console.log(`   الحساب المدين: ${newAdj.debit_account} - ${auditFile.trialBalance.find(a => a.account_id === newAdj.debit_account)?.name}`);
        console.log(`   الحساب الدائن: ${newAdj.credit_account} - ${auditFile.trialBalance.find(a => a.account_id === newAdj.credit_account)?.name}`);
        console.log(`   المبلغ: ${newAdj.amount}`);

        // 4. تأكيد من المستخدم
        const confirmMessage = `هل أنت متأكد من إنشاء قيد تسوية بقيمة ${formatCurrency(Math.abs(difference))} لمعالجة الفرق؟\n\n` +
                             `من: ${auditFile.trialBalance.find(a => a.account_id === newAdj.debit_account)?.name}\n` +
                             `إلى: ${auditFile.trialBalance.find(a => a.account_id === newAdj.credit_account)?.name}`;
            
        if (confirm(confirmMessage)) {
            
            // 5. إضافة القيد إلى الذاكرة
            auditFile.adjustments.push(newAdj);
            addAuditLogEntry(`تم إنشاء قيد تسوية تلقائي: ${newAdj.description}`);
            
            // 6. حفظ التغييرات
            saveAuditFile();
            
            // 7. تحديث الواجهة
            processAndRender();
            
            // 8. التحقق من التوازن
            setTimeout(() => {
                updateBalanceCheck();
                showNotification('تم إنشاء قيد التسوية بنجاح', 'success');
            }, 500);
            
            console.log("✅ تم إنشاء قيد التسوية بنجاح");
        }
        
    } catch (error) {
        console.error("❌ خطأ في إنشاء قيد التسوية:", error);
        showNotification(`حدث خطأ: ${error.message}`, 'danger');
    }
} 

function checkBalanceStatus() {
    try {
        if (!auditFile || !auditFile.trialBalance) return;

        const balanceData = PolarisBalanceChecker.calculateBalance(auditFile.trialBalance);
        
        // البحث عن تنبيه التوازن الحالي
        const alertsContainer = document.getElementById('cockpit-alerts-container');
        const balanceAlerts = alertsContainer.querySelectorAll('.alert');
        
        // إزالة تنبيهات التوازن القديمة فقط
        balanceAlerts.forEach(alert => {
            const alertText = alert.textContent;
            if (alertText.includes('ميزان المراجعة') || alertText.includes('محلل الفروقات')) {
                alert.remove();
            }
        });
        
        // إضافة التنبيه الجديد
        updateBalanceCheck();
        
    } catch (error) {
        handleError(error, 'checkBalanceStatus');
    }
}


/**
 * التحقق من حالة التوازن الحالية وتحديث العرض
 */
function verifyBalanceStatus() {
    try {
        if (!auditFile || !auditFile.trialBalance) return;

        let totalDebits = 0;
        let totalCredits = 0;

        auditFile.trialBalance.forEach(account => {
            const bookBalance = (account.book_balance || 0);
            const adjustments = calculateAdjustments(account.account_id);
            const finalBalance = bookBalance + adjustments;
            
            if (finalBalance > 0) {
                totalDebits += finalBalance;
            } else if (finalBalance < 0) {
                totalCredits += Math.abs(finalBalance);
            }
        });

        const difference = totalDebits - totalCredits;
        const isBalanced = Math.abs(difference) < 0.01;

        console.log("🔍 التحقق من حالة التوازن:", {
            totalDebits: totalDebits,
            totalCredits: totalCredits,
            difference: difference,
            isBalanced: isBalanced
        });

        // تحديث التنبيهات فقط
        const alertsContainer = document.getElementById('cockpit-alerts-container');
        if (alertsContainer) {
            // إزالة تنبيهات التوازن القديمة فقط
            const balanceAlerts = alertsContainer.querySelectorAll('.alert');
            balanceAlerts.forEach(alert => {
                const alertText = alert.textContent;
                if (alertText.includes('ميزان المراجعة') || alertText.includes('محلل الفروقات')) {
                    alert.remove();
                }
            });
            
            // إضافة التنبيه الجديد
            updateBalanceCheck();
        }

        return isBalanced;
        
    } catch (error) {
        handleError(error, 'verifyBalanceStatus');
        return false;
    }
}
/**
 * تصنيف الحسابات غير المصنفة دفعة واحدة
 */
function batchCategorize() {
    const uncategorizedAccounts = auditFile.trialBalance.filter(acc => !acc.category || !acc.sub_category);
    const count = uncategorizedAccounts.length;
    
    if (count === 0) {
        showNotification('لا توجد حسابات غير مصنفة', 'info');
        return;
    }
    
    if (confirm(`هل تريد تصنيف ${count} حساب غير مصنف تلقائياً؟`)) {
        let categorizedCount = 0;
        
        uncategorizedAccounts.forEach(account => {
            const suggestedCategory = suggestCategory(account.name);
            const suggestedSubCategory = suggestSubCategory(account.name, suggestedCategory);
            
            if (suggestedCategory && suggestedSubCategory) {
                account.category = suggestedCategory;
                account.sub_category = suggestedSubCategory;
                account.is_confirmed = true;
                categorizedCount++;
            }
        });
        
        addAuditLogEntry(`تم تصنيف ${categorizedCount} حساب تلقائياً`);
        saveAuditFile();
        processAndRender();
        
        // إغلاق المودال
        const modal = bootstrap.Modal.getInstance(document.getElementById('customModal'));
        if (modal) modal.hide();
        
        showNotification(`تم تصنيف ${categorizedCount} حساب بنجاح`, 'success');
    }
}

/**
 * تصدير الحسابات المحددة إلى Excel
 */
function batchExport() {
    const filteredAccounts = filterAccounts();
    
    if (filteredAccounts.length === 0) {
        showNotification('لا توجد حسابات معروضة للتصدير', 'warning');
        return;
    }
    
    try {
        if (typeof XLSX === 'undefined') {
            showNotification('مكتبة XLSX غير محملة', 'danger');
            return;
        }
        
        const headers = [
            'رقم الحساب', 'اسم الحساب', 'الفئة', 'التصنيف الفرعي',
            'رصيد أول المدة', 'حركة الفترة', 'التسويات', 'الرصيد النهائي',
            'نسبة التغير', 'حالة المراجعة'
        ];
        
        const exportData = filteredAccounts.map(account => {
            const openingBalance = (parseFloat(account.ob_debit) || 0) - (parseFloat(account.ob_credit) || 0);
            const movementBalance = (parseFloat(account.move_debit) || 0) - (parseFloat(account.move_credit) || 0);
            const bookBalance = openingBalance + movementBalance;
            const adjustments = calculateAdjustments(account.account_id);
            const finalBalance = bookBalance + adjustments;
            
            const priorYearBalance = openingBalance;
            let variance = 0;
            if (priorYearBalance !== 0) {
                variance = ((finalBalance - priorYearBalance) / Math.abs(priorYearBalance)) * 100;
            } else if (finalBalance !== 0) {
                variance = 100.0;
            }
            
            return [
                account.account_id || '',
                account.name || '',
                getCategoryLabel(account.category),
                getSubCategoryLabelSafe(account.category, account.sub_category),
                formatCurrency(openingBalance),
                formatCurrency(movementBalance),
                formatCurrency(adjustments),
                formatCurrency(finalBalance),
                isFinite(variance) ? variance.toFixed(1) + '%' : 'N/A',
                account.review_status || 'pending'
            ];
        });
        
        const ws = XLSX.utils.aoa_to_sheet([headers, ...exportData]);
        
        // تعيين عرض الأعمدة
        ws['!cols'] = [
            { wch: 15 }, { wch: 40 }, { wch: 15 }, { wch: 25 },
            { wch: 18 }, { wch: 18 }, { wch: 18 }, { wch: 18 },
            { wch: 15 }, { wch: 15 }
        ];
        
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "الحسابات المصدرة");
        
        const clientName = (auditFile.clientInfo && auditFile.clientInfo.name) ? auditFile.clientInfo.name.replace(/\s/g, '_') : 'Client';
        const fileName = `Accounts_Export_${clientName}_${new Date().toISOString().slice(0,10)}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        // إغلاق المودال
        const modal = bootstrap.Modal.getInstance(document.getElementById('customModal'));
        if (modal) modal.hide();
        
        showNotification(`تم تصدير ${filteredAccounts.length} حساب بنجاح`, 'success');
        
    } catch (error) {
        console.error('خطأ في التصدير:', error);
        showNotification(`حدث خطأ أثناء التصدير: ${error.message}`, 'danger');
    }
}

/**
 * اقتراح فئة للحساب بناءً على الاسم
 */
function suggestCategory(accountName) {
    if (!accountName) return null;
    
    const name = accountName.toLowerCase();
    
    // قواعد الاقتراح
    if (name.includes('صندوق') || name.includes('نقد') || name.includes('بنك')) return 'assets';
    if (name.includes('عملاء') || name.includes('مدين') || name.includes('ذمم')) return 'assets';
    if (name.includes('مخزون') || name.includes('بضاعة')) return 'assets';
    if (name.includes('أصل') || name.includes('معدات') || name.includes('آلات') || name.includes('مباني')) return 'assets';
    
    if (name.includes('موردين') || name.includes('دائن') || name.includes('ذمم دائنة')) return 'liabilities';
    if (name.includes('قرض') || name.includes('تمويل') || name.includes('تسهيل')) return 'liabilities';
    if (name.includes('ضريبة') || name.includes('زكاة') || name.includes('مستحق')) return 'liabilities';
    
    if (name.includes('رأس مال') || name.includes('احتياطي') || name.includes('أرباح') || name.includes('خسائر')) return 'equity';
    if (name.includes('جاري') || name.includes('مالك') || name.includes('شريك')) return 'equity';
    
    if (name.includes('إيراد') || name.includes('مبيعات') || name.includes('عمولة') || name.includes('خدمة')) return 'revenue';
    if (name.includes('خصم') && name.includes('مبيعات')) return 'revenue';
    
    if (name.includes('مصروف') || name.includes('مرتب') || name.includes('إيجار') || name.includes('كهرباء')) return 'expenses';
    if (name.includes('اهلاك') || name.includes('إستهلاك')) return 'expenses';
    if (name.includes('شراء') || name.includes('تكلفة')) return 'expenses';
    
    return null;
}

/**
 * اقتراح تصنيف فرعي للحساب
 */
function suggestSubCategory(accountName, category) {
    if (!accountName || !category) return null;
    
    const name = accountName.toLowerCase();
    
    switch(category) {
        case 'assets':
            if (name.includes('صندوق')) return '111001';
            if (name.includes('بنك')) return '111011';
            if (name.includes('عملاء')) return '113002';
            if (name.includes('مخزون') || name.includes('بضاعة')) return '116004';
            if (name.includes('مباني')) return '121002';
            if (name.includes('آلات') || name.includes('معدات')) return '121003';
            if (name.includes('سيارات')) return '121004';
            if (name.includes('أثاث')) return '121005';
            if (name.includes('كمبيوتر')) return '121006';
            if (name.includes('اهلاك') || name.includes('إستهلاك')) return '121099';
            break;
            
        case 'liabilities':
            if (name.includes('موردين')) return '211001';
            if (name.includes('قرض') || name.includes('تمويل')) return '221001';
            if (name.includes('ضريبة') || name.includes('زكاة')) return '213001';
            if (name.includes('راتب') || name.includes('مكافأة')) return '212001';
            break;
            
        case 'equity':
            if (name.includes('رأس مال')) return '310001';
            if (name.includes('احتياطي')) return '320001';
            if (name.includes('أرباح') || name.includes('خسائر')) return '330001';
            if (name.includes('جاري')) return '330004';
            break;
            
        case 'revenue':
            if (name.includes('مبيعات')) return '410001';
            if (name.includes('خدمة')) return '410002';
            if (name.includes('إيراد')) return '420001';
            if (name.includes('خصم') && name.includes('مبيعات')) return '410099';
            break;
            
        case 'expenses':
            if (name.includes('شراء') || name.includes('تكلفة')) return '510004';
            if (name.includes('راتب') || name.includes('مرتب')) return '620001';
            if (name.includes('إيجار')) return '620003';
            if (name.includes('كهرباء') || name.includes('ماء') || name.includes('هاتف')) return '620004';
            if (name.includes('اهلاك') || name.includes('إستهلاك')) return '630001';
            if (name.includes('ضريبة') || name.includes('زكاة')) return '720001';
            break;
    }
    
    return null;
}

/**
 * تحديث دالة updateInspectorPane لاستدعاء updateQuickActions
 */
        /**
         * تحديث لوحة المفتش الذكي بنظام التبويبات (V7)
         */
        function updateInspectorPane(accountId) {
            const account = auditFile.trialBalance.find(acc => String(acc.account_id) === String(accountId));
            if (!account) return;

            // تفعيل الصف وتجهيز القالب
            document.querySelectorAll('#trialBalanceTable tbody tr').forEach(r => r.classList.remove('table-active'));
            document.querySelector(`tr[data-account-id="${accountId}"]`)?.classList.add('table-active');
            
            const inspectorContent = document.getElementById('inspector-content');
            const template = document.getElementById('inspector-template');
            inspectorContent.innerHTML = template.innerHTML; // نسخ القالب إلى المحتوى الفعلي

            // --- حساب البيانات الأساسية ---
            const openingBalance = (parseFloat(account.ob_debit) || 0) - (parseFloat(account.ob_credit) || 0);
            const finalBalance = (account.book_balance || 0) + calculateAdjustments(account.account_id);
            let variance = 0;
            if (openingBalance !== 0) {
                variance = ((finalBalance - openingBalance) / Math.abs(openingBalance)) * 100;
            } else if (finalBalance !== 0) {
                variance = 100.0;
            }

            // --- ملء رأس المفتش ---
            document.getElementById('inspectorAccountName').textContent = account.name;
            document.getElementById('inspectorAccountId').textContent = `#${account.account_id}`;

            // --- 1. ملء تبويب "نظرة عامة" ---
            const overviewTab = document.getElementById('overview');
            overviewTab.innerHTML = `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <small class="text-muted">رصيد سابق</small>
                                <h5 class="${openingBalance < 0 ? 'text-danger' : ''}">${formatCurrency(openingBalance)}</h5>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">الرصيد النهائي</small>
                                <h4 class="text-primary ${finalBalance < 0 ? 'text-danger' : ''}">${formatCurrency(finalBalance)}</h4>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">التغير</small>
                                <h5 class="${variance >= 0 ? 'text-success' : 'text-danger'}">${isFinite(variance) ? variance.toFixed(1) + '%' : 'N/A'}</h5>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">الإجراءات السريعة</div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="openAjeModal('${accountId}')"><i class="fas fa-plus-circle me-2"></i>إضافة قيد تسوية</button>
                            <button class="btn btn-outline-secondary" onclick="addNote('${accountId}')"><i class="fas fa-comment-dots me-2"></i>إضافة ملاحظة</button>
                            <button class="btn btn-outline-success" onclick="markAsReviewed('${accountId}')"><i class="fas fa-check-double me-2"></i>اعتماد المراجعة</button>
                            <button class="btn btn-outline-warning" onclick="flagForReview('${accountId}')"><i class="fas fa-flag me-2"></i>توسيم للمتابعة</button>
                        </div>
                    </div>
                </div>
            `;

       // --- 2. ملء تبويب "التحليل" بنظام الأكورديون ---
const analysisTab = document.getElementById('analysis');
const analysisHTML = analyzeAccount(account, finalBalance); // استخدام الدالة الموجودة مسبقاً

analysisTab.innerHTML = `
    <div class="accordion" id="analysisAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAnalysis" aria-expanded="false" aria-controls="collapseAnalysis">
                    <i class="fas fa-brain me-2"></i>
                    <strong>عرض التحليل الذكي للحساب</strong>
                </button>
            </h2>
            <div id="collapseAnalysis" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#analysisAccordion">
                <div class="accordion-body">
                    ${analysisHTML}
                </div>
            </div>
        </div>
    </div>
`;


            // --- 3. ملء تبويب "قيود التسوية" ---
            const ajesTab = document.getElementById('ajes');
            const accountAjes = auditFile.adjustments.filter(adj => 
                String(adj.debit_account) === accountId || String(adj.credit_account) === accountId
            );
            document.getElementById('ajes-count').textContent = accountAjes.length > 0 ? accountAjes.length : '';
            
            let ajesHTML = '<ul class="list-group">';
            if (accountAjes.length > 0) {
                accountAjes.forEach(adj => {
                    const isDebit = String(adj.debit_account) === accountId;
                    ajesHTML += `
                        <li class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${adj.description || 'قيد بدون وصف'}</h6>
                                <small>${new Date(adj.timestamp).toLocaleDateString('ar-SA')}</small>
                            </div>
                            <p class="mb-1 ${isDebit ? 'text-danger' : 'text-success'}">
                                ${isDebit ? 'مدين' : 'دائن'}: ${formatCurrency(adj.amount)}
                            </p>
                            <small>النوع: ${adj.type === 'RCE' ? 'إعادة تصنيف' : 'تسوية'}</small>
                        </li>
                    `;
                });
            } else {
                ajesHTML += '<li class="list-group-item text-center text-muted">لا توجد قيود تسوية على هذا الحساب.</li>';
            }
            ajesHTML += '</ul>';
            ajesTab.innerHTML = ajesHTML;

            // --- 4. ملء تبويب "الملاحظات" ---
            const notesTab = document.getElementById('notes');
            const accountNotes = account.notes || [];
            document.getElementById('notes-count').textContent = accountNotes.length > 0 ? accountNotes.length : '';

            let notesHTML = '<ul class="list-group">';
            if (accountNotes.length > 0) {
                [...accountNotes].reverse().forEach(note => {
                    notesHTML += `
                        <li class="list-group-item">
                            <p class="mb-1">${note.text}</p>
                            <small class="text-muted">${new Date(note.timestamp).toLocaleString('ar-SA')}</small>
                        </li>
                    `;
                });
            } else {
                notesHTML += '<li class="list-group-item text-center text-muted">لا توجد ملاحظات مسجلة.</li>';
            }
            notesHTML += '</ul>';
            notesTab.innerHTML = notesHTML;
        }
        function preProcessAccountAnalysis() {
            auditFile.trialBalance.forEach(account => {
                const ob_debit = parseFloat(account.ob_debit) || 0;
                const ob_credit = parseFloat(account.ob_credit) || 0;
                const move_debit = parseFloat(account.move_debit) || 0;
                const move_credit = parseFloat(account.move_credit) || 0;

                const bookBalance = (ob_debit - ob_credit) + (move_debit - move_credit);
                const priorYearBalance = ob_debit - ob_credit;
                
                const adjustments = calculateAdjustments(account.account_id);
                const finalBalance = bookBalance + adjustments;

                // حساب نسبة التغير
                let variance = 0;
                if (priorYearBalance !== 0) {
                    variance = ((finalBalance - priorYearBalance) / Math.abs(priorYearBalance)) * 100;
                } else if (finalBalance !== 0) {
                    variance = 100.0;
                }
                
                account.isHighVariance = Math.abs(variance) > VARIANCE_THRESHOLD;
                account.variance = variance;

                // التحقق من الأرصدة الشاذة
                const isContra = (account.sub_category === '121099');
                let isAbnormal = false;
                
                if ((account.category === 'assets' && !isContra) && finalBalance < 0) isAbnormal = true;
                if ((account.category === 'liabilities' || account.category === 'equity' || isContra) && finalBalance > 0) isAbnormal = true;
                if (account.category === 'revenue' && finalBalance > 0 && account.sub_category !== '410099') isAbnormal = true;
                if (account.category === 'expenses' && finalBalance < 0) isAbnormal = true;
                
                account.isAbnormal = isAbnormal;
                account.book_balance = bookBalance;
            });
        }

        /**
         * تحديث لوحة التحكم الذكية
         */
  /**
 * تحديث لوحة التحكم الذكية (نسخة موحدة)
 */
function updateCockpit() {
    const highPriorityDiv = document.getElementById('high-priority-content');
    const mediumPriorityDiv = document.getElementById('medium-priority-content');
    const followUpDiv = document.getElementById('follow-up-content');

    // مسح المحتوى السابق
    highPriorityDiv.innerHTML = '';
    mediumPriorityDiv.innerHTML = '';
    followUpDiv.innerHTML = '';

    let highCount = 0, mediumCount = 0, followCount = 0;

    // دالة مساعدة لإنشاء عنصر في لوحة التحكم
    const createCockpitItem = (account, reason, priorityClass, riskScore = null) => {
        const finalBalance = (account.book_balance || 0) + calculateAdjustments(account.account_id);
        const variance = account.variance || 0;
        
        return `
            <div class="cockpit-item ${priorityClass}" onclick="focusOnAccount('${account.account_id}')">
                ${riskScore ? `<div class="risk-score">${riskScore}</div>` : ''}
                <div class="item-reason">${reason}</div>
                <div class="item-account">${account.name} (${account.account_id})</div>
                <div class="item-details">
                    <span class="me-2">الرصيد: ${formatCurrency(finalBalance)}</span>
                    <span>التغير: ${variance.toFixed(1)}%</span>
                </div>
            </div>
        `;
    };

    // معالجة الحسابات وتصنيفها
    auditFile.trialBalance.forEach(acc => {
        const finalBalance = (acc.book_balance || 0) + calculateAdjustments(acc.account_id);
        const hasMovement = (acc.move_debit || 0) + (acc.move_credit || 0) !== 0;

        // الأولوية القصوى
        if (!acc.category || !acc.sub_category) {
            highPriorityDiv.innerHTML += createCockpitItem(acc, 'الحساب غير مصنف', 'high-priority', 95);
            highCount++;
        }
        if (acc.category === 'revenue' && finalBalance > 0) {
            highPriorityDiv.innerHTML += createCockpitItem(acc, 'رصيد إيراد مدين (خطر)', 'high-priority', 90);
            highCount++;
        }
        // ... باقي شروط الأولوية القصوى

        // الأولوية الثانية
        if (acc.isHighVariance) {
            mediumPriorityDiv.innerHTML += createCockpitItem(acc, `تغير جوهري (+${acc.variance.toFixed(0)}%)`, 'medium-priority', 70);
            mediumCount++;
        }
        // ... باقي شروط الأولوية الثانية

        // مؤشرات للمتابعة
        if (['assets', 'equity'].includes(acc.category) && finalBalance !== 0 && !hasMovement) {
            followUpDiv.innerHTML += createCockpitItem(acc, 'حساب جوهري بدون حركة', 'follow-up', 50);
            followCount++;
        }
        // ... باقي شروط المتابعة
    });

    // تحديث العدادات
    document.getElementById('high-priority-count').textContent = highCount;
    document.getElementById('medium-priority-count').textContent = mediumCount;
    document.getElementById('follow-up-count').textContent = followCount;

    // رسائل في حالة عدم وجود عناصر
    if (highCount === 0) highPriorityDiv.innerHTML = '<p class="text-muted small p-2">لا توجد مهام ذات أولوية قصوى. عمل رائع!</p>';
    if (mediumCount === 0) mediumPriorityDiv.innerHTML = '<p class="text-muted small p-2">لا توجد ملاحظات تحتاج لتحليل فوري.</p>';
    if (followCount === 0) followUpDiv.innerHTML = '<p class="text-muted small p-2">لا توجد مؤشرات خاصة للمتابعة.</p>';
}

        /**
         * تحديث لوحة التحليل المالي
         */
function updateKpiPane() {
    console.log("🔄 بدء تحديث لوحة التحليل المالي...");
    
    const container = document.getElementById('financial-ratios-container');
    if (!container) {
        console.error("❌ حاوية النسب المالية غير موجودة");
        return;
    }
    
    // التأكد من وجود البطاقات
    const cards = container.querySelectorAll('.ratio-card');
    if (cards.length === 0) {
        console.warn("⚠️ لا توجد بطاقات، سيتم إعادة بنائها...");
        if (!cleanupAndRebuildKpiCards()) {
            console.error("❌ فشل إعادة بناء البطاقات");
            return;
        }
    }
    
    if (!auditFile || !auditFile.trialBalance) {
        container.innerHTML = '<p class="text-danger">خطأ: بيانات الحسابات غير متاحة.</p>';
        return;
    }

    // حساب النسب المالية
    const ratios = calculateFinancialRatios();
    
    // تحديث كل بطاقة
    Object.keys(ratios).forEach(ratioId => {
        const card = container.querySelector(`[data-ratio="${ratioId}"]`);
        if (card) {
            const ratioData = ratios[ratioId];
            const valueElement = card.querySelector('.ratio-value');
            const comparisonElement = card.querySelector('.ratio-comparison');
            const indicatorElement = card.querySelector('.ratio-indicator');
            
            if (valueElement) {
                valueElement.textContent = ratioData.display;
            }
            
            if (comparisonElement && ratioData.priorValue !== null) {
                const change = ratioData.value - ratioData.priorValue;
                const changeClass = change > 0 ? 'up' : change < 0 ? 'down' : '';
                const changeIcon = change > 0 ? 'fa-arrow-up' : change < 0 ? 'fa-arrow-down' : 'fa-minus';
                
                comparisonElement.className = `ratio-comparison ${changeClass}`;
                comparisonElement.innerHTML = `
                    <i class="fas ${changeIcon}"></i>
                    ${Math.abs(change).toFixed(1)}${ratioData.unit}
                `;
            }
            
            if (indicatorElement) {
                indicatorElement.className = `ratio-indicator ${ratioData.indicator}`;
            }
        }
    });
    
    console.log("✅ تم تحديث لوحة التحليل المالي بنجاح");
}

// دالة حساب النسب المالية
function calculateFinancialRatios() {
    const getBalance = (acc, isPriorYear = false) => {
        if (isPriorYear) {
            return (parseFloat(acc.ob_debit) || 0) - (parseFloat(acc.ob_credit) || 0);
        }
        return (acc.book_balance || 0) + calculateAdjustments(acc.account_id);
    };

    const getSumByCategory = (category, isPriorYear = false) => {
        return auditFile.trialBalance
            .filter(acc => acc.category === category)
            .reduce((sum, acc) => sum + getBalance(acc, isPriorYear), 0);
    };

    const { profitBefore, profitAfter } = calculateNetProfit();
    const totalRevenue = Math.abs(getSumByCategory('revenue'));
    const cogs = Math.abs(auditFile.trialBalance
        .filter(a => a.category === 'expenses' && a.sub_category && a.sub_category.startsWith('5'))
        .reduce((s, a) => s + getBalance(a), 0));
    
    const totalAssets = getSumByCategory('assets');
    const totalLiabilities = getSumByCategory('liabilities');
    const totalEquity = getSumByCategory('equity') + profitAfter;
    
    const currentAssets = auditFile.trialBalance
        .filter(a => a.category === 'assets' && a.sub_category && a.sub_category.startsWith('11'))
        .reduce((s, a) => s + getBalance(a), 0);
    const currentLiabilities = Math.abs(auditFile.trialBalance
        .filter(a => a.category === 'liabilities' && a.sub_category && a.sub_category.startsWith('21'))
        .reduce((s, a) => s + getBalance(a), 0));
    
    const tradeReceivables = Math.abs(auditFile.trialBalance
        .filter(a => a.sub_category === '113002')
        .reduce((s, a) => s + getBalance(a), 0));
    const inventory = Math.abs(auditFile.trialBalance
        .filter(a => a.sub_category && a.sub_category.startsWith('116'))
        .reduce((s, a) => s + getBalance(a), 0));
    
    const grossProfit = totalRevenue - cogs;

    // حساب السنة السابقة
    const priorYear = new Date(auditFile.clientInfo.endDate).getFullYear() - 1;
    const priorRatios = {}; // يمكن حسابها إذا كانت البيانات متوفرة

    return {
        grossMargin: {
            value: totalRevenue > 0 ? (grossProfit / totalRevenue) * 100 : 0,
            display: totalRevenue > 0 ? `${((grossProfit / totalRevenue) * 100).toFixed(1)}%` : '0.0%',
            unit: '%',
            priorValue: priorRatios.grossMargin || 0,
            indicator: totalRevenue > 0 ? ((grossProfit / totalRevenue) * 100) >= 20 ? 'good' : ((grossProfit / totalRevenue) * 100) >= 10 ? 'warning' : 'danger' : 'warn'
        },
        netMargin: {
            value: totalRevenue > 0 ? (profitAfter / totalRevenue) * 100 : 0,
            display: totalRevenue > 0 ? `${((profitAfter / totalRevenue) * 100).toFixed(1)}%` : '0.0%',
            unit: '%',
            priorValue: priorRatios.netMargin || 0,
            indicator: totalRevenue > 0 ? (profitAfter / totalRevenue) * 100 >= 10 ? 'good' : (profitAfter / totalRevenue) * 100 >= 5 ? 'warning' : 'danger' : 'warn'
        },
        roa: {
            value: totalAssets > 0 ? (profitAfter / totalAssets) * 100 : 0,
            display: totalAssets > 0 ? `${((profitAfter / totalAssets) * 100).toFixed(1)}%` : '0.0%',
            unit: '%',
            priorValue: priorRatios.roa || 0,
            indicator: totalAssets > 0 ? (profitAfter / totalAssets) * 100 >= 5 ? 'good' : (profitAfter / totalAssets) * 100 >= 2 ? 'warning' : 'danger' : 'warn'
        },
        roe: {
            value: totalEquity !== 0 ? (profitAfter / totalEquity) * 100 : 0,
            display: totalEquity !== 0 ? `${((profitAfter / totalEquity) * 100).toFixed(1)}%` : '0.0%',
            unit: '%',
            priorValue: priorRatios.roe || 0,
            indicator: totalEquity !== 0 ? (profitAfter / totalEquity) * 100 >= 15 ? 'good' : (profitAfter / totalEquity) * 100 >= 10 ? 'warning' : 'danger' : 'warn'
        },
        currentRatio: {
            value: currentLiabilities > 0 ? currentAssets / currentLiabilities : 0,
            display: currentLiabilities > 0 ? `${(currentAssets / currentLiabilities).toFixed(1)}x` : '0.0x',
            unit: 'x',
            priorValue: priorRatios.currentRatio || 0,
            indicator: currentLiabilities > 0 ? (currentAssets / currentLiabilities) >= 1.5 ? 'good' : (currentAssets / currentLiabilities) >= 1 ? 'warning' : 'danger' : 'warn'
        },
        quickRatio: {
            value: currentLiabilities > 0 ? (currentAssets - inventory) / currentLiabilities : 0,
            display: currentLiabilities > 0 ? `${((currentAssets - inventory) / currentLiabilities).toFixed(1)}x` : '0.0x',
            unit: 'x',
            priorValue: priorRatios.quickRatio || 0,
            indicator: currentLiabilities > 0 ? ((currentAssets - inventory) / currentLiabilities) >= 1 ? 'good' : ((currentAssets - inventory) / currentLiabilities) >= 0.5 ? 'warning' : 'danger' : 'warn'
        },
        debtToEquity: {
            value: totalEquity !== 0 ? Math.abs(totalLiabilities) / totalEquity : 0,
            display: totalEquity !== 0 ? `${(Math.abs(totalLiabilities) / totalEquity).toFixed(1)}x` : '0.0x',
            unit: 'x',
            priorValue: priorRatios.debtToEquity || 0,
            indicator: totalEquity !== 0 ? (Math.abs(totalLiabilities) / totalEquity) <= 1 ? 'good' : (Math.abs(totalLiabilities) / totalEquity) <= 1.5 ? 'warning' : 'danger' : 'warn'
        },
        assetTurnover: {
            value: totalAssets > 0 ? totalRevenue / totalAssets : 0,
            display: totalAssets > 0 ? `${(totalRevenue / totalAssets).toFixed(1)}x` : '0.0x',
            unit: 'x',
            priorValue: priorRatios.assetTurnover || 0,
            indicator: totalAssets > 0 ? (totalRevenue / totalAssets) >= 1 ? 'good' : (totalRevenue / totalAssets) >= 0.5 ? 'warning' : 'danger' : 'warn'
        },
        collectionPeriod: {
            value: totalRevenue > 0 ? (tradeReceivables / (totalRevenue / 365)) : 0,
            display: totalRevenue > 0 ? `${Math.round(tradeReceivables / (totalRevenue / 365))}` : '0',
            unit: 'يوم',
            priorValue: priorRatios.collectionPeriod || 0,
            indicator: totalRevenue > 0 ? (tradeReceivables / (totalRevenue / 365)) <= 45 ? 'good' : (tradeReceivables / (totalRevenue / 365)) <= 60 ? 'warning' : 'danger' : 'warn'
        },
        inventoryTurnover: {
            value: inventory > 0 ? cogs / inventory : 0,
            display: inventory > 0 ? `${(cogs / inventory).toFixed(1)}x` : '0.0x',
            unit: 'x',
            priorValue: priorRatios.inventoryTurnover || 0,
            indicator: inventory > 0 ? (cogs / inventory) >= 6 ? 'good' : (cogs / inventory) >= 3 ? 'warning' : 'danger' : 'warn'
        },
        debtRatio: {
            value: totalAssets > 0 ? (Math.abs(totalLiabilities) / totalAssets) * 100 : 0,
            display: totalAssets > 0 ? `${((Math.abs(totalLiabilities) / totalAssets) * 100).toFixed(1)}%` : '0.0%',
            unit: '%',
            priorValue: priorRatios.debtRatio || 0,
            indicator: totalAssets > 0 ? (Math.abs(totalLiabilities) / totalAssets) * 100 <= 50 ? 'good' : (Math.abs(totalLiabilities) / totalAssets) * 100 <= 70 ? 'warning' : 'danger' : 'warn'
        }
    };
}
        /**
         * حساب صافي الربح
  /**
 * حساب صافي الربح (النسخة المعدلة والدقيقة)
 * @param {boolean} final - إذا كانت true، تُرجع كائنًا بسيطًا للاستخدام في القوائم المالية.
 * @returns {object} - كائن يحتوي على تفاصيل الربح.
 */
function calculateNetProfit(final = false) {
    let profitBefore = 0;

    // حساب الربح قبل التسويات
    auditFile.trialBalance.forEach(acc => {
        if (acc.category === 'revenue' || acc.category === 'expenses') {
            const bookBalance = (parseFloat(acc.ob_debit) || 0) - (parseFloat(acc.ob_credit) || 0) + 
                              (parseFloat(acc.move_debit) || 0) - (parseFloat(acc.move_credit) || 0);
            // الإيرادات دائنة (سالبة) والمصروفات مدينة (موجبة)، لذا نعكس الإشارة
            profitBefore -= bookBalance;
        }
    });

    // استخدام الدالة الجديدة لحساب تأثير التسويات
    const adjustmentsEffect = calculateAdjustmentsEffectOnProfit();
    const profitAfter = profitBefore + adjustmentsEffect;

    console.log("📊 ملخص حساب الربح (مع الإشارات):");
    console.log(`   الربح قبل التسويات: ${profitBefore}`);
    console.log(`   تأثير التسويات: ${adjustmentsEffect}`);
    console.log(`   الربح النهائي: ${profitAfter}`);
    console.log(`   هل خسارة؟ ${profitAfter < 0}`);

    // إرجاع النتائج
    if (final) {
        return { 
            profitAfter: profitAfter, 
            profitForEquity: -profitAfter, // 🔥 عكس الإشارة لحقوق الملكية
            profitBefore: profitBefore,
            adjustmentsEffect: adjustmentsEffect,
            isLoss: profitAfter < 0 // 🔥 إضافة مؤشر الخسارة
        };
    }

    return { 
        profitBefore: profitBefore, 
        adjustmentsEffect: adjustmentsEffect, 
        profitAfter: profitAfter,
        isLoss: profitAfter < 0
    };
}function calculateAdjustmentsEffectOnProfit() {
    if (!auditFile.adjustments || auditFile.adjustments.length === 0) {
        console.log("📊 لا توجد قيود تسوية لحساب تأثيرها");
        return 0;
    }

    let totalEffect = 0;
    console.log("📊 بدء حساب تأثير قيود التسوية على صافي الربح...");

    auditFile.adjustments.forEach(adj => {
        // تجاهل قيود إعادة التصنيف (RCE) لأنها لا تؤثر على الربح
        if (adj.type === 'RCE') {
            console.log(`⏭️ تجاهل قيد إعادة التصنيف: ${adj.id}`);
            return;
        }

        const amount = Number(adj.amount) || 0;
        const debitAccountId = String(adj.debit_account);
        const creditAccountId = String(adj.credit_account);

        // البحث عن الحسابات
        const debitAccount = auditFile.trialBalance.find(acc => String(acc.account_id) === debitAccountId);
        const creditAccount = auditFile.trialBalance.find(acc => String(acc.account_id) === creditAccountId);

        console.log(`\n🔍 تحليل القيد: ${adj.id}`);
        console.log(`💰 المبلغ: ${amount}`);
        console.log(`📝 الوصف: ${adj.description}`);

        if (!debitAccount) {
            console.log(`❌ الحساب المدين غير موجود: ${debitAccountId} - سيتم تجاهل تأثير هذا القيد`);
        }
        if (!creditAccount) {
            console.log(`❌ الحساب الدائن غير موجود: ${creditAccountId} - سيتم تجاهل تأثير هذا القيد`);
        }

        // حساب تأثير القيد على صافي الربح فقط إذا كانت الحسابات موجودة
        if (debitAccount && creditAccount) {
            let adjustmentEffect = 0;

            // إذا كان الحساب المدين مصروفاً: يقلل الربح
            if (debitAccount.category === 'expenses') {
                adjustmentEffect -= amount;
                console.log(`➖ حساب مدين مصروف (${debitAccount.name}): -${amount}`);
            }
            // إذا كان الحساب المدين إيراداً (مثل مردودات): يقلل الربح
            else if (debitAccount.category === 'revenue') {
                adjustmentEffect -= amount;
                console.log(`➖ حساب مدين إيراد (${debitAccount.name}): -${amount}`);
            }
            // إذا كان الحساب المدين من حقوق الملكية (مثل سحب أرباح): يقلل الربح
            else if (debitAccount.category === 'equity' && 
                    (debitAccount.sub_category === '330001' || debitAccount.sub_category === '330002')) {
                adjustmentEffect -= amount;
                console.log(`➖ حساب مدين حقوق ملكية (${debitAccount.name}): -${amount}`);
            }

            // إذا كان الحساب الدائن إيراداً: يزيد الربح
            if (creditAccount.category === 'revenue') {
                adjustmentEffect += amount;
                console.log(`➕ حساب دائن إيراد (${creditAccount.name}): +${amount}`);
            }
            // إذا كان الحساب الدائن مصروفاً (مثل عكس مصروف): يزيد الربح
            else if (creditAccount.category === 'expenses') {
                adjustmentEffect += amount;
                console.log(`➕ حساب دائن مصروف (${creditAccount.name}): +${amount}`);
            }
            // إذا كان الحساب الدائن من حقوق الملكية (مثل الأرباح المرحلة): يزيد الربح
            else if (creditAccount.category === 'equity' && 
                    (creditAccount.sub_category === '330001' || creditAccount.sub_category === '330002')) {
                adjustmentEffect += amount;
                console.log(`➕ حساب دائن حقوق ملكية (${creditAccount.name}): +${amount}`);
            }

            totalEffect += adjustmentEffect;
            console.log(`📈 تأثير القيد على الربح: ${adjustmentEffect}`);
        }
    });

    console.log(`\n✅ التأثير الإجمالي لقيود التسوية على صافي الربح: ${totalEffect}`);
    return totalEffect;
} 

function forceUpdateKpiCards() {
    console.log("🔄 التحديث القسري للبطاقات...");
    
    // تحديث لوحة التحليل المالي
    setTimeout(() => {
        updateKpiPane();
        showNotification("تم تحديث بطاقات التحليل المالي", "success");
    }, 100);
    
    // تشخيص البطاقات
    setTimeout(() => {
        diagnoseKpiPane();
    }, 500);
}
function cleanupAndRebuildKpiCards() {
    console.log("🧹 بدء تنظيف وإعادة بناء بطاقات KPI...");
    
    const container = document.getElementById('financial-ratios-container');
    if (!container) {
        console.error("❌ حاوية النسب المالية غير موجودة");
        return false;
    }
    
    // مسح جميع البطاقات القديمة
    container.innerHTML = '';
    console.log("✅ تم مسح البطاقات القديمة");
    
    // تعريف البطاقات الجديدة
    const kpiDefinitions = [
        { id: 'grossMargin', label: 'هامش الربح الإجمالي', unit: '%', icon: 'fa-chart-line' },
        { id: 'netMargin', label: 'هامش صافي الربح', unit: '%', icon: 'fa-chart-pie' },
        { id: 'roa', label: 'العائد على الأصول', unit: '%', icon: 'fa-coins' },
        { id: 'roe', label: 'العائد على حقوق الملكية', unit: '%', icon: 'fa-percentage' },
        { id: 'currentRatio', label: 'نسبة التداول', unit: 'x', icon: 'fa-balance-scale' },
        { id: 'quickRatio', label: 'نسبة السيولة السريعة', unit: 'x', icon: 'fa-tachometer-alt' },
        { id: 'debtToEquity', label: 'الديون إلى حقوق الملكية', unit: 'x', icon: 'fa-chart-bar' },
        { id: 'assetTurnover', label: 'معدل دوران الأصول', unit: 'x', icon: 'fa-sync' },
        { id: 'collectionPeriod', label: 'فترة التحصيل', unit: 'يوم', icon: 'fa-clock' },
        { id: 'inventoryTurnover', label: 'معدل دوران المخزون', unit: 'x', icon: 'fa-warehouse' },
        { id: 'debtRatio', label: 'نسبة الديون', unit: '%', icon: 'fa-percentage' }
    ];
    
    // بناء البطاقات الجديدة
    let cardsHTML = '';
    kpiDefinitions.forEach(kpi => {
        cardsHTML += `
            <div class="col-xl-3 col-lg-4 col-md-6">
                <div class="ratio-card" data-ratio="${kpi.id}">
                    <div class="ratio-header">
                        <span class="ratio-label">${kpi.label}</span>
                        <i class="fas fa-circle ratio-indicator indicator-warn"></i>
                    </div>
                    <div class="ratio-content">
                        <div class="ratio-value value-placeholder">0.0${kpi.unit}</div>
                        <div class="ratio-comparison">
                            <i class="fas fa-minus"></i>
                            0.0${kpi.unit}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    // إضافة البطاقات الجديدة
    container.innerHTML = cardsHTML;
    console.log(`✅ تم بناء ${kpiDefinitions.length} بطاقة جديدة`);
    
    // التحقق من البطاقات
    const newCards = container.querySelectorAll('.ratio-card');
    console.log(`✅ التحقق: تم العثور على ${newCards.length} بطاقة بعد البناء`);
    
    // التحقق من attributes
    let validCards = 0;
    newCards.forEach((card, index) => {
        const ratioId = card.getAttribute('data-ratio');
        if (ratioId) {
            console.log(`✅ البطاقة ${index + 1}: ${ratioId} - صالحة`);
            validCards++;
        } else {
            console.log(`❌ البطاقة ${index + 1}: لا يوجد data-ratio`);
        }
    });
    
    console.log(`✅ إجمالي البطاقات الصالحة: ${validCards}/${newCards.length}`);
    
    return validCards === kpiDefinitions.length;
}
function cleanupBrokenAdjustments() {
    console.log("🧹 بدء تنظيف القيود التلقائية المعطوبة...");
    
    let cleanedCount = 0;
    const originalCount = auditFile.adjustments.length;
    
    // فلترة القيود الصالحة فقط
    auditFile.adjustments = auditFile.adjustments.filter(adj => {
        const debitAccount = auditFile.trialBalance.find(acc => String(acc.account_id) === String(adj.debit_account));
        const creditAccount = auditFile.trialBalance.find(acc => String(acc.account_id) === String(adj.credit_account));
        
        const isValid = debitAccount && creditAccount && 
                       adj.debit_account !== 'AUTO-ACCOUNT' && 
                       adj.credit_account !== 'AUTO-ACCOUNT';
        
        if (!isValid) {
            console.log(`🗑️ حذف قيد معطوب: ${adj.id} - ${adj.description}`);
            cleanedCount++;
        }
        
        return isValid;
    });
    
    if (cleanedCount > 0) {
        saveAuditFile();
        processAndRender();
        showNotification(`تم تنظيف ${cleanedCount} قيد تسوية معطوب`, 'success');
        console.log(`✅ تم تنظيف ${cleanedCount} قيد من أصل ${originalCount} قيد`);
    } else {
        showNotification('لا توجد قيود معطوبة لتنظيفها', 'info');
    }
}
       /**
         * تحديث شريط الحالة
         */
        function updateStatusBar() {
            const { profitBefore, adjustmentsEffect, profitAfter } = calculateNetProfit();
            
            document.getElementById('profitBeforeDisplay').textContent = formatCurrency(profitBefore);
            
            const adjElement = document.getElementById('adjustmentsEffectDisplay');
            adjElement.textContent = formatCurrency(adjustmentsEffect);
            adjElement.className = 'kpi-main-value';
            if (adjustmentsEffect > 0) adjElement.classList.add('text-success');
            if (adjustmentsEffect < 0) adjElement.classList.add('text-danger');

            const profitAfterElement = document.getElementById('netProfitDisplay');
            profitAfterElement.textContent = formatCurrency(profitAfter);
            profitAfterElement.className = 'kpi-main-value';
            if (profitAfter < 0) profitAfterElement.classList.add('text-danger');

            const totalAccounts = auditFile.trialBalance.length;
            const classifiedAccounts = auditFile.trialBalance.filter(acc => acc.category && acc.sub_category).length;
            const classificationRate = totalAccounts > 0 ? (classifiedAccounts / totalAccounts * 100) : 0;

            document.getElementById('classificationRateDisplay').textContent = `${classificationRate.toFixed(1)}%`;
            document.getElementById('classifiedAccountsDisplay').textContent = `${classifiedAccounts} / ${totalAccounts} حساب`;
        }

        /**
         * عرض كل المحتوى
         */
        function renderAll() {
            processAndRender();
            updateCockpit();
            setTimeout(() => {
                updateKpiPane();
            }, 100);
        }

        /**
         * معالجة وعرض البيانات
         */
        function processAndRender() {
            const tbody = document.querySelector('#trialBalanceTable tbody');
            tbody.innerHTML = '';
            
            const filteredAccounts = filterAccounts();
            
            filteredAccounts.forEach(account => {
                const row = createAccountRow(account);
                tbody.appendChild(row);
            });
            
            updateStatusBar();
            updateBalanceCheck();
        }

        /**
         * فلترة الحسابات
         */
        function filterAccounts() {
            const searchTerm = userPrefs.searchTerm.toLowerCase().trim();
            const isNumericSearch = !isNaN(parseFloat(searchTerm)) && isFinite(searchTerm);
            const searchNumber = parseFloat(searchTerm);

            return auditFile.trialBalance.filter(account => {
                if (!account || !account.account_id) return false;

                const selectedCategory = userPrefs.filterCategory;
                let categoryFilterMatch = false;
                if (selectedCategory === 'all') {
                    categoryFilterMatch = true;
                } else if (selectedCategory === 'unclassified') {
                    categoryFilterMatch = !account.category;
                } else if (selectedCategory === 'no_subcategory') {
                    categoryFilterMatch = !!account.category && !account.sub_category;
                } else {
                    categoryFilterMatch = account.category === selectedCategory;
                }

                const statusFilterMatch = userPrefs.filterStatus === 'all' || account.review_status === userPrefs.filterStatus;

                let searchMatch = true;
                if (searchTerm !== '') {
                    if (isNumericSearch) {
                        const finalBalance = (account.book_balance || 0) + calculateAdjustments(account.account_id);
                        if (Math.abs(finalBalance).toFixed(2) === Math.abs(searchNumber).toFixed(2)) {
                            return true;
                        }
                        searchMatch = false;
                    } else {
                        const categoryLabel = account.category ? getCategoryLabel(account.category).toLowerCase() : '';
                        const subCategoryLabel = (account.category && account.sub_category && subCategoryMap[account.category]) 
                            ? (subCategoryMap[account.category].find(sc => sc.value === account.sub_category)?.label.toLowerCase() || '') 
                            : '';

                        searchMatch = 
                            (account.name && account.name.toLowerCase().includes(searchTerm)) || 
                            (String(account.account_id).toLowerCase().includes(searchTerm)) ||
                            (categoryLabel.includes(searchTerm)) ||
                            (subCategoryLabel.includes(searchTerm));
                    }
                }

                return categoryFilterMatch && statusFilterMatch && searchMatch;
            });
        }

        /**
         * إنشاء صف حساب
         */
        /**
         * إنشاء صف حساب مع مستمع حدث صريح (V2)
         */
        function createAccountRow(account) {
            const ob_debit = parseFloat(account.ob_debit) || 0;
            const ob_credit = parseFloat(account.ob_credit) || 0;
            const finalBalance = (account.book_balance || 0) + calculateAdjustments(account.account_id);
            const priorYearBalance = ob_debit - ob_credit;

            let variance = 0;
            if (priorYearBalance !== 0) {
                variance = ((finalBalance - priorYearBalance) / Math.abs(priorYearBalance)) * 100;
            } else if (finalBalance !== 0) {
                variance = 100.0;
            }
            const varianceClass = Math.abs(variance) > VARIANCE_THRESHOLD ? 'high-variance' : '';

            const row = document.createElement('tr');
            row.dataset.accountId = account.account_id;
            row.className = varianceClass;
            
            // --- هذا هو التعديل الجوهري ---
            // إضافة استدعاء الدالة مباشرة في HTML لضمان عمله
            row.setAttribute('onclick', `updateInspectorPane('${account.account_id}')`);

            const allCategories = [
                { value: 'assets', label: 'أصول' },
                { value: 'liabilities', label: 'التزامات' },
                { value: 'equity', label: 'حقوق الملكية' },
                { value: 'revenue', label: 'إيرادات' },
                { value: 'expenses', label: 'مصروفات' },
                { value: 'clearing', label: 'حسابات وسيطة / رقابية' }
            ];

            const categoryDropdown = `
                <select class="form-select form-select-sm" onchange="updateCategory(this, '${account.account_id}')" onclick="event.stopPropagation();">
                    <option value="">-- اختر فئة --</option>
                    ${allCategories.map(c => `<option value="${c.value}" ${account.category === c.value ? 'selected' : ''}>${c.label}</option>`).join('')}
                </select>
            `;

            const subCategoryDropdown = `
                <select class="form-select form-select-sm" onchange="updateSubCategory(this, '${account.account_id}')" ${!account.category ? 'disabled' : ''} onclick="event.stopPropagation();">
                    ${generateSubCategoryOptions(account.category, account.sub_category)}
                </select>
            `;
            
            row.innerHTML = `
                <td>
                    <span class="account-name">${account.name || 'غير مسمى'}</span>
                    <div class="text-muted small">${account.account_id}</div>
                </td>
                <td>${categoryDropdown}</td>
                <td>${subCategoryDropdown}</td>
                <td class="${priorYearBalance < 0 ? 'negative-balance' : ''}">${formatCurrency(priorYearBalance)}</td>
                <td class="fw-bold ${finalBalance < 0 ? 'negative-balance' : ''}">${formatCurrency(finalBalance)}</td>
                <td class="fw-bold ${variance < 0 ? 'text-danger' : 'text-success'}">
                    ${isFinite(variance) ? variance.toFixed(1) + '%' : 'N/A'}
                </td>
                <td>
                    <select class="form-select form-select-sm" onchange="updateReviewStatus(this, '${account.account_id}')" onclick="event.stopPropagation();">
                        <option value="pending" ${account.review_status === 'pending' ? 'selected' : ''}>قيد المراجعة</option>
                        <option value="reviewed" ${account.review_status === 'reviewed' ? 'selected' : ''}>تمت المراجعة</option>
                        <option value="flagged" ${account.review_status === 'flagged' ? 'selected' : ''}>تحتاج تدقيق</option>
                    </select>
                    <i class="fas fa-trash-alt action-icon text-danger ms-2" onclick="event.stopPropagation(); deleteAccount('${account.account_id}')" title="حذف الحساب"></i>
                </td>
            `;
            return row;
        }

        /**
         * تحديث لوحة المفتش
         */
 /**
 * تحديث لوحة المفتش الذكي (نسخة محسّنة)
 */
function updateInspectorPane(accountId) {
    const account = auditFile.trialBalance.find(acc => String(acc.account_id) === String(accountId));
    if (!account) return;

    document.querySelectorAll('#trialBalanceTable tbody tr').forEach(r => r.classList.remove('table-active'));
    const activeRow = document.querySelector(`tr[data-account-id="${accountId}"]`);
    if (activeRow) activeRow.classList.add('table-active');

    const inspectorContent = document.getElementById('inspector-content');
    
    const openingBalance = (parseFloat(account.ob_debit) || 0) - (parseFloat(account.ob_credit) || 0);
    const movementBalance = (parseFloat(account.move_debit) || 0) - (parseFloat(account.move_credit) || 0);
    const bookBalance = openingBalance + movementBalance;
    const adjustments = calculateAdjustments(account.account_id);
    const finalBalance = bookBalance + adjustments;

    // حساب نسبة التغير
    const priorYearBalance = openingBalance;
    let variance = 0;
    if (priorYearBalance !== 0) {
        variance = ((finalBalance - priorYearBalance) / Math.abs(priorYearBalance)) * 100;
    } else if (finalBalance !== 0) {
        variance = 100.0;
    }

    // حساب مؤشر المخاطر
    let riskScore = 0;
    let riskLevel = 'منخفض';
    let riskColor = 'success';
    
    if (!account.category || !account.sub_category) {
        riskScore += 30;
    }
    if (account.isAbnormal) {
        riskScore += 40;
    }
    if (account.isHighVariance) {
        riskScore += 20;
    }
    if (account.review_status === 'flagged') {
        riskScore += 10;
    }
    
    if (riskScore >= 60) {
        riskLevel = 'مرتفع';
        riskColor = 'danger';
    } else if (riskScore >= 30) {
        riskLevel = 'متوسط';
        riskColor = 'warning';
    }

    // تحليل الحساب
    const accountAnalysis = analyzeAccount(account, finalBalance);

    // إنشاء شريط تقدم بسيط
    const progressPercentage = Math.min(100, Math.abs(variance));
    const progressColor = variance > 0 ? 'bg-success' : 'bg-danger';

    // عرض قيود التسوية
    let ajesHTML = '';
    const accountAjes = auditFile.adjustments.filter(adj => 
        String(adj.debit_account) === accountId || String(adj.credit_account) === accountId
    );
    
    if (accountAjes.length > 0) {
        ajesHTML = `
            <div class="adjustments-table">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>الوصف</th>
                            <th>المبلغ</th>
                            <th>النوع</th>
                            <th>إجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${accountAjes.map(adj => {
                            const isDebit = String(adj.debit_account) === accountId;
                            const amount = formatCurrency(adj.amount);
                            const description = adj.description || 'بدون وصف';
                            const date = adj.timestamp ? new Date(adj.timestamp).toLocaleDateString('ar-SA') : 'غير محدد';
                            const type = adj.type === 'RCE' ? 'إعادة تصنيف' : 'قيد تسوية';
                            
                            return `
                                <tr>
                                    <td><span class="badge bg-secondary">${date}</span></td>
                                    <td>
                                        <strong>${description}</strong>
                                        ${isDebit ? '<span class="badge bg-danger ms-2">مدين</span>' : '<span class="badge bg-success ms-2">دائن</span>'}
                                    </td>
                                    <td class="${isDebit ? 'text-danger' : 'text-success'} fw-bold">${amount}</td>
                                    <td><span class="badge ${adj.type === 'RCE' ? 'bg-info' : 'bg-warning'}">${type}</span></td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="editAdjustment('${adj.id}')" title="تعديل">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="deleteAdjustment('${adj.id}')" title="حذف">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } else {
        ajesHTML = `
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle fa-2x mb-3"></i>
                <h5>لا توجد قيود تسوية على هذا الحساب</h5>
                <p class="mb-3">يمكنك إضافة قيد تسوية جديد من قسم الإجراءات السريعة أدناه</p>
            </div>
        `;
    }

    // عرض الملاحظات
    let notesHTML = '';
    if (account.notes && account.notes.length > 0) {
        notesHTML = `
            <div class="notes-list">
                ${account.notes.slice().reverse().map(note => `
                    <div class="note-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <p class="mb-1">${note.text}</p>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    ${new Date(note.timestamp).toLocaleString('ar-SA')}
                                </small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteNote('${accountId}', '${note.timestamp}')" title="حذف الملاحظة">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    } else {
        notesHTML = '<p class="text-muted text-center">لا توجد ملاحظات مسجلة</p>';
    }

    // بناء محتوى لوحة المفتش
    inspectorContent.innerHTML = `
        <div class="inspector-header">
            <h4 class="inspector-title">
                <i class="fas fa-search me-2 text-primary"></i>
                ${account.name}
            </h4>
            <div class="inspector-subtitle">
                <i class="fas fa-hashtag me-1"></i>
                ${account.account_id}
            </div>
        </div>

        <!-- مؤشر المخاطر -->
        <div class="risk-indicator-card mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">مؤشر المخاطر</h6>
                <span class="badge bg-${riskColor} fs-6">${riskLevel}</span>
            </div>
            <div class="progress mt-2" style="height: 8px;">
                <div class="progress-bar bg-${riskColor}" role="progressbar" style="width: ${riskScore}%" aria-valuenow="${riskScore}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <small class="text-muted">درجة المخاطر: ${riskScore}/100</small>
        </div>

        <!-- ملخص الأرصدة -->
        <div class="balance-summary-card">
            <div class="row text-center">
                <div class="col-md-3">
                    <div class="balance-item">
                        <div class="label">رصيد أول المدة</div>
                        <div class="value ${openingBalance < 0 ? 'negative-balance' : ''}">${formatCurrency(openingBalance)}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="balance-item">
                        <div class="label">حركة الفترة</div>
                        <div class="value ${movementBalance < 0 ? 'negative-balance' : ''}">${formatCurrency(movementBalance)}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="balance-item">
                        <div class="label">التسويات</div>
                        <div class="value text-warning">${formatCurrency(adjustments)}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="balance-item">
                        <div class="label">الرصيد النهائي</div>
                        <div class="value fs-5 ${finalBalance < 0 ? 'negative-balance' : ''}">${formatCurrency(finalBalance)}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- نسبة التغير -->
        <div class="variance-card mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">نسبة التغير</h6>
                <span class="badge ${variance > 0 ? 'bg-success' : 'bg-danger'} fs-6">${isFinite(variance) ? variance.toFixed(1) + '%' : 'N/A'}</span>
            </div>
            <div class="progress mt-2" style="height: 8px;">
                <div class="progress-bar ${progressColor}" role="progressbar" style="width: ${progressPercentage}%" aria-valuenow="${progressPercentage}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <small class="text-muted">مقارنة بالسنة السابقة</small>
        </div>

        <!-- تحليل الحساب -->
        <div class="analysis-card mb-3">
            <h6 class="card-title">
                <i class="fas fa-chart-line me-2"></i>
                تحليل الحساب
            </h6>
            <div class="analysis-content">
                ${accountAnalysis}
            </div>
        </div>

 <!-- استبدل قسم الإجراءات السريعة بالكود التالي -->
<!-- الإجراءات السريعة الذكية -->
    <div class="card-body">
        <!-- الإجراءات الأساسية -->
        <div class="row g-2 mb-3">
            <div class="col-6">
                <button class="btn btn-primary w-100 quick-action-btn" onclick="openAjeModal('${accountId}')" data-action="aje">
                    <i class="fas fa-plus-circle me-2"></i>
                    <span>قيد تسوية</span>
                    <small class="d-block">Ctrl+J</small>
                </button>
            </div>
            <div class="col-6">
                <button class="btn btn-outline-secondary w-100 quick-action-btn" onclick="addNote('${accountId}')" data-action="note">
                    <i class="fas fa-comment-dots me-2"></i>
                    <span>ملاحظة</span>
                    <small class="d-block">Ctrl+N</small>
                </button>
            </div>
        </div>

        <!-- الإجراءات الذكية (تتغير حسب الحساب) -->
        <div id="smart-actions" class="row g-2 mb-3">
            <!-- سيتم ملؤها ديناميكيًا -->
        </div>

   

        <!-- الإجراءات المخصصة -->
        <div class="mt-3">
            <h6 class="text-muted small mb-2">الإجراءات المخصصة</h6>
            <div id="custom-actions" class="row g-2">
                <!-- سيتم ملؤها من الإعدادات المحفوظة -->
            </div>
        </div>
    </div>
</div>

        <!-- سجل قيود التسوية -->
        <div class="card mb-4 border-info">
            <div class="card-header bg-info text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exchange-alt me-2"></i>
                        سجل قيود التسوية
                    </h5>
                    <span class="badge bg-light text-dark">${accountAjes.length} قيد</span>
                </div>
            </div>
            <div class="card-body p-0">
                ${ajesHTML}
            </div>
        </div>

        <!-- ملاحظات المراجع -->
        <div class="notes-section">
            <div class="card-header bg-warning text-dark">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-sticky-note me-2"></i>
                        ملاحظات المراجع
                    </h5>
                    <button class="btn btn-sm btn-dark" onclick="addNote('${accountId}')">
                        <i class="fas fa-plus me-1"></i>ملاحظة جديدة
                    </button>
                </div>
            </div>
            <div class="card-body">
                ${notesHTML}
            </div>
        </div>
    `;
}

/**
 * تحليل الحساب الذكي
 */
function analyzeAccount(account, finalBalance) {
    let analysis = '<ul class="list-unstyled">';
    
    // تحليل الفئة
    if (!account.category) {
        analysis += '<li class="mb-2"><i class="fas fa-exclamation-triangle text-warning me-2"></i>الحساب غير مصنف في فئة رئيسية</li>';
    } else {
        analysis += `<li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>الحساب مصنف ضمن فئة: ${getCategoryLabel(account.category)}</li>`;
    }
    
    // تحليل التصنيف الفرعي
    if (!account.sub_category) {
        analysis += '<li class="mb-2"><i class="fas fa-exclamation-triangle text-warning me-2"></i>الحساب غير مصنف في تصنيف فرعي</li>';
    } else {
        const subCategoryLabel = getSubCategoryLabelSafe(account.category, account.sub_category);
        analysis += `<li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>التصنيف الفرعي: ${subCategoryLabel}</li>`;
    }
    
    // تحليل الرصيد
    if (account.isAbnormal) {
        analysis += '<li class="mb-2"><i class="fas fa-exclamation-circle text-danger me-2"></i>رصيد الحساب يخالف طبيعته المحاسبية</li>';
    } else {
        analysis += '<li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>رصيد الحساب متوافق مع طبيعته المحاسبية</li>';
    }
    
    // تحليل التغير
    if (account.isHighVariance) {
        analysis += `<li class="mb-2"><i class="fas fa-chart-line text-warning me-2"></i>تغير جوهري في الرصيد بنسبة ${account.variance.toFixed(1)}%</li>`;
    } else {
        analysis += '<li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>التغير في الرصيد ضمن الحدود الطبيعية</li>';
    }
    
    // تحليل الحركة
    const hasMovement = (account.move_debit || 0) + (account.move_credit || 0) !== 0;
    if (!hasMovement && finalBalance !== 0) {
        analysis += '<li class="mb-2"><i class="fas fa-info-circle text-info me-2"></i>حساب برصيد بدون حركة خلال الفترة</li>';
    } else if (hasMovement) {
        analysis += '<li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>للحساب حركة خلال الفترة</li>';
    }
    
    // تحليل حالة المراجعة
    if (account.review_status === 'flagged') {
        analysis += '<li class="mb-2"><i class="fas fa-flag text-danger me-2"></i>الحساب موشح للمتابعة</li>';
    } else if (account.review_status === 'reviewed') {
        analysis += '<li class="mb-2"><i class="fas fa-check-double text-success me-2"></i>تمت مراجعة الحساب</li>';
    } else {
        analysis += '<li class="mb-2"><i class="fas fa-clock text-warning me-2"></i>الحساب قيد المراجعة</li>';
    }
    
    analysis += '</ul>';
    return analysis;
}

        /**
         * التركيز على حساب
         */
        function focusOnAccount(accountId) {
            const row = document.querySelector(`tr[data-account-id="${accountId}"]`);
            if (row) {
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });

                setTimeout(() => {
                    document.querySelectorAll('.cockpit-focus').forEach(el => el.classList.remove('cockpit-focus'));
                    row.classList.add('cockpit-focus');
                    row.click();
                }, 300);
            }
        }


function diagnoseAdjustmentEffect() {
    console.clear(); // مسح الكونسول للوضوح
    console.log("🔍 === بدء تشخيص تأثير قيود التسوية ===");
    
    if (!auditFile.adjustments || auditFile.adjustments.length === 0) {
        showNotification("لا توجد قيود تسوية لتشخيصها", "info");
        return;
    }
    
    // استدعاء الدالة الجديدة التي تحتوي على التشخيص المفصل
    const totalEffect = calculateAdjustmentsEffectOnProfit();
    
    // عرض نتيجة التشخيص للمستخدم
    const message = `
        التشخيص اكتمل!
        
        عدد القيود: ${auditFile.adjustments.length}
        التأثير الإجمالي على صافي الربح: ${formatCurrency(totalEffect)}
        
        تحقق من console.log للتفاصيل الكاملة
    `;
    
    showNotification(message, "info");
}
        /**
         * تبديل قسم في لوحة التحكم
         */
        function toggleSection(sectionId) {
            const content = document.getElementById(`${sectionId}-content`);
            const icon = event.currentTarget.querySelector('.fa-chevron-down, .fa-chevron-up');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                if (icon) icon.classList.remove('fa-chevron-down');
                if (icon) icon.classList.add('fa-chevron-up');
            } else {
                content.style.display = 'none';
                if (icon) icon.classList.remove('fa-chevron-up');
                if (icon) icon.classList.add('fa-chevron-down');
            }
        }

        /**
         * تحديث لوحة التحكم
         */
        function refreshCockpit() {
            updateCockpit();
            showNotification('تم تحديث لوحة التحكم الذكية', 'success');
        }

        /**
         * تشخيص لوحة التحليل المالي
         */
function diagnoseKpiPane() {
    console.log('=== تشخيص لوحة التحليل المالي ===');
    
    // أولاً تنظيف وإعادة البناء
    const rebuildSuccess = cleanupAndRebuildKpiCards();
    if (!rebuildSuccess) {
        console.error("❌ فشل إعادة بناء البطاقات");
        return;
    }
    
    const container = document.getElementById('financial-ratios-container');
    const cards = container.querySelectorAll('.ratio-card');
    
    console.log(`✅ تم العثور على ${cards.length} بطاقة بعد التنظيف`);
    
    // التحقق من كل بطاقة
    const expectedRatios = [
        'grossMargin', 'netMargin', 'roa', 'roe', 
        'currentRatio', 'quickRatio', 'debtToEquity', 
        'assetTurnover', 'collectionPeriod', 'inventoryTurnover', 'debtRatio'
    ];
    
    let validCards = 0;
    expectedRatios.forEach(ratioId => {
        const card = container.querySelector(`[data-ratio="${ratioId}"]`);
        if (card) {
            const valueElement = card.querySelector('.value-placeholder');
            if (valueElement) {
                console.log(`✅ ${ratioId}: ${valueElement.textContent}`);
                validCards++;
            } else {
                console.log(`⚠️ ${ratioId}: موجود ولكن لا يوجد عنصر قيمة`);
            }
        } else {
            console.log(`❌ ${ratioId}: غير موجود`);
        }
    });
    
    console.log(`\n✅ إجمالي البطاقات الصالحة: ${validCards}/${expectedRatios.length}`);
    
    if (validCards === expectedRatios.length) {
        console.log("🎉 جميع البطاقات صالحة وجاهزة للعمل!");
    } else {
        console.warn("⚠️ لا تزال هناك مشاكل في بعض البطاقات");
    }
    
    console.log('=== انتهاء تشخيص لوحة التحليل المالي ===');
}        // === دوال المساعدة ===
/**
 * تحديث الإجراءات السريعة الذكية
 */
function updateQuickActions(account) {
    const smartActionsDiv = document.getElementById('smart-actions');
    const customActionsDiv = document.getElementById('custom-actions');
    
    // مسح الإجراءات الحالية
    smartActionsDiv.innerHTML = '';
    customActionsDiv.innerHTML = '';
    
    // الإجراءات الذكية حسب نوع الحساب
    const smartActions = getSmartActions(account);
    
    smartActions.forEach(action => {
        const actionHtml = `
            <div class="col-6">
                <button class="btn ${action.btnClass} w-100 quick-action-btn" onclick="${action.onclick}" data-action="${action.id}">
                    <i class="${action.icon} me-2"></i>
                    <span>${action.label}</span>
                    ${action.shortcut ? `<small class="d-block">${action.shortcut}</small>` : ''}
                </button>
            </div>
        `;
        smartActionsDiv.innerHTML += actionHtml;
    });
    
    // تحميل الإجراءات المخصصة
    const customActions = loadCustomActions();
    customActions.forEach(action => {
        const actionHtml = `
            <div class="col-6">
                <button class="btn btn-outline-primary btn-sm w-100" onclick="executeCustomAction('${action.id}', '${account.account_id}')">
                    <i class="${action.icon} me-2"></i>${action.label}
                </button>
            </div>
        `;
        customActionsDiv.innerHTML += actionHtml;
    });
}

/**
 * الحصول على الإجراءات الذكية حسب الحساب
/**
 * الحصول على الإجراءات الذكية (بدون اختصارات)
 */
function getSmartActions(account) {
    const actions = [];
    const finalBalance = (account.book_balance || 0) + calculateAdjustments(account.account_id);
    
    // إجراءات عامة
    if (!account.category || !account.sub_category) {
        actions.push({
            id: 'categorize',
            label: 'تصنيف سريع',
            icon: 'fas fa-tags',
            btnClass: 'btn-outline-info',
            onclick: `quickCategorize('${account.account_id}')`
        });
    }
    
    // إجراءات حسب الفئة
    switch(account.category) {
        case 'assets':
            if (account.sub_category && account.sub_category.startsWith('121')) {
                actions.push({
                    id: 'depreciation',
                    label: 'حساب الإهلاك',
                    icon: 'fas fa-calculator',
                    btnClass: 'btn-outline-warning',
                    onclick: `calculateDepreciation('${account.account_id}')`
                });
            }
            if (account.sub_category && account.sub_category.startsWith('113')) {
                actions.push({
                    id: 'aging',
                    label: 'تحليل العمر',
                    icon: 'fas fa-clock',
                    btnClass: 'btn-outline-info',
                    onclick: `showAgingReport('${account.account_id}')`
                });
            }
            break;
            
        case 'liabilities':
            if (account.sub_category && account.sub_category.startsWith('21')) {
                actions.push({
                    id: 'payment-schedule',
                    label: 'جدول السداد',
                    icon: 'fas fa-calendar-alt',
                    btnClass: 'btn-outline-success',
                    onclick: `showPaymentSchedule('${account.account_id}')`
                });
            }
            break;
            
        case 'revenue':
            actions.push({
                id: 'revenue-analysis',
                label: 'تحليل الإيرادات',
                icon: 'fas fa-chart-line',
                btnClass: 'btn-outline-primary',
                onclick: `showRevenueAnalysis('${account.account_id}')`
            });
            break;
            
        case 'expenses':
            actions.push({
                id: 'expense-breakdown',
                label: 'تفصيل المصروفات',
                icon: 'fas fa-pie-chart',
                btnClass: 'btn-outline-warning',
                onclick: `showExpenseBreakdown('${account.account_id}')`
            });
            break;
    }
    
    // إجراءات حسب حالة الرصيد
    if (account.isAbnormal) {
        actions.push({
            id: 'fix-balance',
            label: 'إصلاح الرصيد',
            icon: 'fas fa-wrench',
            btnClass: 'btn-outline-danger',
            onclick: `fixAbnormalBalance('${account.account_id}')`
        });
    }
    
    if (account.isHighVariance) {
        actions.push({
            id: 'investigate-variance',
            label: 'تحقيق التغير',
            icon: 'fas fa-search',
            btnClass: 'btn-outline-warning',
            onclick: `investigateVariance('${account.account_id}')`
        });
    }
    
    // إجراءات حسب الحجم
    if (Math.abs(finalBalance) > 1000000) {
        actions.push({
            id: 'materiality-check',
            label: 'فحص الأهمية',
            icon: 'fas fa-balance-scale',
            btnClass: 'btn-outline-info',
            onclick: `checkMateriality('${account.account_id}')`
        });
    }
    
    return actions;
}// تصنيف سريع
function quickCategorize(accountId) {
    const account = auditFile.trialBalance.find(acc => acc.account_id === accountId);
    if (!account) return;
    
    const suggestedCategory = suggestCategory(account.name);
    const suggestedSubCategory = suggestSubCategory(account.name, suggestedCategory);
    
    if (confirm(`التصنيف المقترح:\nالفئة: ${getCategoryLabel(suggestedCategory)}\nالتصنيف الفرعي: ${getSubCategoryLabelSafe(suggestedCategory, suggestedSubCategory)}\n\nهل تريد تطبيق هذا التصنيف؟`)) {
        account.category = suggestedCategory;
        account.sub_category = suggestedSubCategory;
        saveAuditFile();
        processAndRender();
        updateInspectorPane(accountId);
        showNotification('تم تطبيق التصنيف المقترح بنجاح', 'success');
    }
}

// حساب الإهلاك السريع
function calculateDepreciation(accountId) {
    const account = auditFile.trialBalance.find(acc => acc.account_id === accountId);
    if (!account) return;
    
    const rate = prompt('أدخل نسبة الإهلاك السنوية (%):', '10');
    if (rate && !isNaN(rate)) {
        const finalBalance = (account.book_balance || 0) + calculateAdjustments(accountId);
        const depreciationAmount = finalBalance * (parseFloat(rate) / 100);
        
        if (confirm(`مبلغ الإهلاك المحسوب: ${formatCurrency(depreciationAmount)}\n\nهل تريد إنشاء قيد تسوية تلقائي؟`)) {
            createDepreciationEntry(accountId, depreciationAmount);
        }
    }
}

// إصلاح الرصيد الشاذ
function fixAbnormalBalance(accountId) {
    const account = auditFile.trialBalance.find(acc => acc.account_id === accountId);
    if (!account) return;
    
    const finalBalance = (account.book_balance || 0) + calculateAdjustments(accountId);
    
    if (confirm(`الرصيد الحالي: ${formatCurrency(finalBalance)}\n\nهل تريد إنشاء قيد إعادة تصنيف لتصحيح الرصيد؟`)) {
        openAjeModal(accountId);
        document.getElementById('isRceSwitch').checked = true;
        document.getElementById('ajeAmount').value = Math.abs(finalBalance);
    }
}

// تحقيق التغير الجوهري
function investigateVariance(accountId) {
    const account = auditFile.trialBalance.find(acc => acc.account_id === accountId);
    if (!account) return;
    
    const variance = account.variance || 0;
    const investigationNote = `تحقيق في التغير الجوهري بنسبة ${variance.toFixed(1)}%\n\nالخطوات المقترحة:\n1. مراجعة القيود المحاسبية\n2. التحقق من المستندات المؤيدة\n3. الاستفسار من الإدارة\n4. تحليل الاتجاهات التاريخية`;
    
    addNote(accountId, investigationNote);
    showNotification('تم إنشاء ملاحظة تحقيق تلقائي', 'info');
}

// فحص الأهمية النسبية
function checkMateriality(accountId) {
    const account = auditFile.trialBalance.find(acc => acc.account_id === accountId);
    if (!account) return;
    
    const finalBalance = Math.abs((account.book_balance || 0) + calculateAdjustments(accountId));
    const materiality = auditFile.settings?.materialityValue || 0;
    const materialityPercentage = materiality > 0 ? (finalBalance / materiality * 100) : 0;
    
    const alertClass = materialityPercentage > 50 ? 'danger' : materialityPercentage > 20 ? 'warning' : 'info';
    const message = `قيمة الحساب: ${formatCurrency(finalBalance)}\nالأهمية النسبية: ${formatCurrency(materiality)}\nالنسبة: ${materialityPercentage.toFixed(1)}%\n\n${materialityPercentage > 50 ? 'الحساب جوهري جداً' : materialityPercentage > 20 ? 'الحساب جوهري' : 'الحساب غير جوهري'}`;
    
    showNotification(message, alertClass);
}

// إنشاء قيد إهلاك
function createDepreciationEntry(accountId, amount) {
    const expenseAccount = auditFile.trialBalance.find(a => a.sub_category === '630001');
    const accumulatedAccount = auditFile.trialBalance.find(a => a.sub_category === '121099');
    
    if (!expenseAccount || !accumulatedAccount) {
        showNotification('يرجى تصنيف حسابات الإهلاك أولاً', 'warning');
        return;
    }
    
    const adjustment = {
        id: `ADJ-${Date.now()}`,
        type: 'AJE',
        description: `إهلاك تلقائي للحساب ${accountId}`,
        debit_account: expenseAccount.account_id,
        credit_account: accumulatedAccount.account_id,
        amount: amount,
        timestamp: new Date().toISOString()
    };
    
    auditFile.adjustments.push(adjustment);
    saveAuditFile();
    processAndRender();
    updateInspectorPane(accountId);
    showNotification('تم إنشاء قيد الإهلاك بنجاح', 'success');
}

// عرض تقرير العمر للذمم المدينة
function showAgingReport(accountId) {
    // هنا يمكن إضافة منطق عرض تقرير العمر
    showNotification('سيتم فتح تقرير العمر للذمم المدينة', 'info');
}

// عرض جدول السداد
function showPaymentSchedule(accountId) {
    // هنا يمكن إضافة منطق عرض جدول السداد
    showNotification('سيتم فتح جدول السداد', 'info');
}

// عرض تحليل الإيرادات
function showRevenueAnalysis(accountId) {
    // هنا يمكن إضافة منطق تحليل الإيرادات
    showNotification('سيتم فتح تحليل الإيرادات', 'info');
}

// عرض تفصيل المصروفات
function showExpenseBreakdown(accountId) {
    // هنا يمكن إضافة منطق تفصيل المصروفات
    showNotification('سيتم فتح تفصيل المصروفات', 'info');
}

// اعتماد المراجعة
function markAsReviewed(accountId) {
    const account = auditFile.trialBalance.find(acc => acc.account_id === accountId);
    if (account) {
        account.review_status = 'reviewed';
        saveAuditFile();
        processAndRender();
        updateInspectorPane(accountId);
        showNotification('تم اعتماد مراجعة الحساب', 'success');
    }
}

// توسيم للمتابعة
function flagForReview(accountId) {
    const account = auditFile.trialBalance.find(acc => acc.account_id === accountId);
    if (account) {
        account.review_status = 'flagged';
        saveAuditFile();
        processAndRender();
        updateInspectorPane(accountId);
        showNotification('تم توسيم الحساب للمتابعة', 'warning');
    }
}

// عرض سجل التغييرات
function showAccountHistory(accountId) {
    const account = auditFile.trialBalance.find(acc => acc.account_id === accountId);
    if (!account) return;
    
    const history = auditFile.auditLog?.filter(log => 
        log.action && log.action.includes(accountId)
    ) || [];
    
    let historyHtml = '<h6>سجل التغييرات</h6><ul class="list-unstyled">';
    history.forEach(log => {
        historyHtml += `
            <li class="mb-2">
                <small class="text-muted">${new Date(log.timestamp).toLocaleString('ar-SA')}</small>
                <p class="mb-0">${log.action}</p>
            </li>
        `;
    });
    historyHtml += '</ul>';
    
    showModal('سجل التغييرات', historyHtml);
}

// إنشاء تقرير الحساب
function generateAccountReport(accountId) {
    // هنا يمكن إضافة منطق إنشاء تقرير PDF
    showNotification('سيتم إنشاء تقرير PDF للحساب', 'info');
}

// تخصيص الإجراءات السريعة
function customizeQuickActions() {
    showModal('تخصيص الإجراءات', `
        <p>يمكنك تخصيص الإجراءات السريعة التي تظهر في لوحة المفتش.</p>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="showAdvanced" checked>
            <label class="form-check-label" for="showAdvanced">
                عرض الإجراءات المتقدمة
            </label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="showShortcuts" checked>
            <label class="form-check-label" for="showShortcuts">
                عرض اختصارات لوحة المفاتيح
            </label>
        </div>
    `);
}

// عرض اختصارات لوحة المفاتيح
function showKeyboardShortcuts() {
    const shortcuts = `
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>الاختصار</th>
                        <th>الإجراء</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Ctrl+J</td><td>إضافة قيد تسوية</td></tr>
                    <tr><td>Ctrl+N</td><td>إضافة ملاحظة</td></tr>
                    <tr><td>Ctrl+C</td><td>تصنيف سريع</td></tr>
                    <tr><td>Ctrl+R</td><td>تحديث لوحة المفتش</td></tr>
                    <tr><td>Ctrl+S</td><td>حفظ التغييرات</td></tr>
                    <tr><td>Ctrl+F</td><td>بحث في الحسابات</td></tr>
                </tbody>
            </table>
        </div>
    `;
    showModal('اختصارات لوحة المفاتيح', shortcuts);
}

// تنفيذ إجراءات جماعية
function executeBatchActions() {
    showModal('الإجراءات الجماعية', `
        <p>اختر الإجراء الجماعي الذي تريد تنفيذه:</p>
        <div class="list-group">
            <a href="#" class="list-group-item list-group-item-action" onclick="batchReviewAll()">
                <i class="fas fa-check-double me-2"></i>مراجعة جميع الحسابات المعروضة
            </a>
            <a href="#" class="list-group-item list-group-item-action" onclick="batchCategorize()">
                <i class="fas fa-tags me-2"></i>تصنيف الحسابات غير المصنفة
            </a>
            <a href="#" class="list-group-item list-group-item-action" onclick="batchExport()">
                <i class="fas fa-file-excel me-2"></i>تصدير الحسابات المحددة
            </a>
        </div>
    `);
}

/**
 * تحديث لوحة المفتش
 */
function refreshInspector() {
    const activeRow = document.querySelector('#trialBalanceTable tr.table-active');
    if (activeRow && activeRow.dataset.accountId) {
        updateInspectorPane(activeRow.dataset.accountId);
        showNotification('تم تحديث لوحة المفتش', 'info');
    } else {
        showNotification('يرجى تحديد حساب أولاً', 'warning');
    }
}
// تحميل الإجراءات المخصصة
function loadCustomActions() {
    const saved = localStorage.getItem('customQuickActions');
    return saved ? JSON.parse(saved) : [];
}

// تنفيذ إجراء مخصص
function executeCustomAction(actionId, accountId) {
    const actions = loadCustomActions();
    const action = actions.find(a => a.id === actionId);
    if (action) {
        // تنفيذ الإجراء المخصص
        eval(action.onclick);
    }
}

// إعداد اختصارات لوحة المفاتيح
function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey) {
            switch(e.key) {
                case 'j':
                    e.preventDefault();
                    const activeRow = document.querySelector('#trialBalanceTable tr.table-active');
                    if (activeRow) {
                        openAjeModal(activeRow.dataset.accountId);
                    }
                    break;
                case 'n':
                    e.preventDefault();
                    const activeRow2 = document.querySelector('#trialBalanceTable tr.table-active');
                    if (activeRow2) {
                        addNote(activeRow2.dataset.accountId);
                    }
                    break;
                case 's':
                    e.preventDefault();
                    saveChangesManually();
                    break;
                case 'f':
                    e.preventDefault();
                    document.getElementById('searchInput').focus();
                    break;
            }
        }
    });
}
function finalSystemTest() {
    console.clear();
    console.log("🧪 === اختبار النظام النهائي ===");
    
    // اختبار 1: البطاقات
    const container = document.getElementById('financial-ratios-container');
    const cards = container.querySelectorAll('.ratio-card');
    console.log(`✅ اختبار البطاقات: ${cards.length}/11 بطاقة`);
    
    // اختبار 2: التوازن (باستخدام نفس المعيار)
    const balanceData = calculateTrialBalanceBalance();
    const isBalancedForPractical = balanceData.isBalanced || Math.abs(balanceData.difference) < 0.1;
    console.log(`✅ اختبار التوازن: ${isBalancedForPractical ? 'متوازن' : 'غير متوازن'} (الفرق: ${balanceData.difference})`);
    
    // اختبار 3: حسابات الربح
    const profitData = calculateNetProfit();
    console.log(`✅ اختبار الربح: قبل=${profitData.profitBefore}, بعد=${profitData.profitAfter}, تأثير=${profitData.adjustmentsEffect}`);
    
    // اختبار 4: قيود التسوية
    const adjustmentsCount = auditFile.adjustments ? auditFile.adjustments.length : 0;
    console.log(`✅ اختبار القيود: ${adjustmentsCount} قيد`);
    
    // النتيجة النهائية
    const allTestsPassed = 
        cards.length === 11 && 
        isBalancedForPractical &&
        !isNaN(profitData.profitAfter);
    
    if (allTestsPassed) {
        showNotification(
            "🎉 جميع الاختبارات نجحت!\n\n" +
            "• 11 بطاقة KPI عاملة\n" +
            "• ميزان المراجعة متوازن (فرق تقريب مقبول)\n" +
            "• حسابات الربح صحيحة\n" +
            "• قيود التسوية محسوبة\n\n" +
            "النظام جاهز للاعتماد والانتقال للصفحات التالية!",
            "success"
        );
        console.log("🎉 === جميع الاختبارات نجحت! النظام جاهز ===");
    } else {
        showNotification("⚠️ بعض الاختبارات فشلت، يرجى المراجعة", "warning");
    }
}// عرض نافذة منبثقة
/**
 * عرض نافذة منبثقة
 */
function showModal(title, content) {
    const modalHtml = `
        <div class="modal fade" id="customModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${title}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // إزالة المودال الموجود إن وجد
    const existingModal = document.getElementById('customModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // إضافة المودال الجديد
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // عرض المودال
    const modal = new bootstrap.Modal(document.getElementById('customModal'));
    modal.show();
    
    // إزالة المودال عند الإغلاق
    document.getElementById('customModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}       function calculateAdjustments(accountId) {
    if (!auditFile.adjustments) return 0;

    let totalAdjustment = 0;
    const accountIdStr = String(accountId);

    auditFile.adjustments.forEach(adj => {
        if (adj.entries && Array.isArray(adj.entries)) {
            adj.entries.forEach(entry => {
                if (String(entry.accountId) === accountIdStr) {
                    if (entry.type === 'debit') {
                        totalAdjustment += Number(entry.amount) || 0;
                    } else if (entry.type === 'credit') {
                        totalAdjustment -= Number(entry.amount) || 0;
                    }
                }
            });
        } else {
            const amount = Number(adj.amount) || 0;
            if (String(adj.debit_account) === accountIdStr) {
                totalAdjustment += amount;
            }
            if (String(adj.credit_account) === accountIdStr) {
                totalAdjustment -= amount;
            }
        }
    });

    return totalAdjustment;
}

        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value)) return '-';
            return new Intl.NumberFormat('ar-SA', { 
                style: 'currency', 
                currency: CURRENCY,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function getCategoryLabel(categoryKey) {
            const labels = {
                'assets': 'أصول', 
                'liabilities': 'التزامات', 
                'equity': 'حقوق الملكية',
                'revenue': 'إيرادات', 
                'expenses': 'مصروفات',
                'clearing': 'حسابات وسيطة'
            };
            return labels[categoryKey] || 'غير مصنف';
        }

        function generateSubCategoryOptions(category, selectedSubCategory) {
            if (!category || !subCategoryMap[category]) {
                return '<option value="">- اختر فئة أولاً -</option>';
            }
            let options = '<option value="">اختر تصنيف فرعي...</option>';
            const groupedOptions = subCategoryMap[category].reduce((acc, option) => {
                acc[option.group] = acc[option.group] || [];
                acc[option.group].push(option);
                return acc;
            }, {});

            for (const groupName in groupedOptions) {
                options += `<optgroup label="${groupName}">`;
                groupedOptions[groupName].forEach(sub => {
                    options += `<option value="${sub.value}" ${selectedSubCategory === sub.value ? 'selected' : ''}>${sub.label}</option>`;
                });
                options += `</optgroup>`;
            }
            return options;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed notification-toast`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);';
            notification.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.body.appendChild(notification);
            setTimeout(() => {
                const bsAlert = bootstrap.Alert.getOrCreateInstance(notification);
                if (bsAlert) {
                    bsAlert.close();
                }
            }, 5000);
        }

        function handleFatalError(message) {
            const container = document.querySelector('.container-fluid') || document.body;
            container.innerHTML = `<div class="alert alert-danger m-5">${message}</div>`;
        }

        // === إعداد مستمعي الأحداث ===
        function setupEventListeners() {
            document.getElementById('clientNameSubtitle').textContent = auditFile.clientInfo.name || 'عميل غير محدد';
            document.getElementById('filterCategory').value = userPrefs.filterCategory;
            document.getElementById('filterStatus').value = userPrefs.filterStatus;
            document.getElementById('searchInput').value = userPrefs.searchTerm;
            
            document.getElementById('reclassifyButton').addEventListener('click', runAutoCategorization);
            document.getElementById('reviewAllButton').addEventListener('click', reviewAllAccounts);

            document.getElementById('filterCategory').addEventListener('change', (e) => { 
                userPrefs.filterCategory = e.target.value; 
                saveUserPrefs(); 
                processAndRender(); 
            });
            document.getElementById('filterStatus').addEventListener('change', (e) => { 
                userPrefs.filterStatus = e.target.value; 
                saveUserPrefs(); 
                processAndRender(); 
            });
            document.getElementById('searchInput').addEventListener('input', (e) => { 
                userPrefs.searchTerm = e.target.value; 
                saveUserPrefs(); 
                processAndRender(); 
            });
             // إعداد مستمعي الأحداث للأهمية النسبية
    const materialityBase = document.getElementById('materialityBase');
    const materialityPercentage = document.getElementById('materialityPercentage');
    
    if (materialityBase) {
        materialityBase.addEventListener('change', updateMaterialityValue);
    }
    
    if (materialityPercentage) {
        materialityPercentage.addEventListener('input', updateMaterialityValue);
    }
    
    // تحديث القيمة عند فتح المودال
    const materialityModal = document.getElementById('materialityModal');
    if (materialityModal) {
        materialityModal.addEventListener('show.bs.modal', function () {
            setTimeout(updateMaterialityValue, 100);
        });
    }
            document.getElementById('materialityBase').addEventListener('change', updateMaterialityValue);
            document.getElementById('materialityPercentage').addEventListener('input', updateMaterialityValue);
            
            document.getElementById('logicalCheckButton').addEventListener('click', performLogicalCheck);
            document.getElementById('saveChangesButton').addEventListener('click', saveChangesManually);
            document.getElementById('exportButton').addEventListener('click', exportToExcel);

            setupAjeModal();
        }

        // === دوال إضافية (سيتم إضافتها لاحقاً) ===
        function runAutoCategorization() {
            if (confirm("هل أنت متأكد من رغبتك في إعادة التصنيف التلقائي؟")) {
                autoCategorizeAccounts();
                preProcessAccountAnalysis();
                renderAll();
                showNotification('تمت إعادة التصنيف التلقائي بنجاح!', 'success');
            }
        }

        function reviewAllAccounts() {
            if (!confirm("هل أنت متأكد من رغبتك في تحديث حالة جميع الحسابات المعروضة إلى (تمت المراجعة)؟")) {
                return;
            }

            const filteredAccounts = filterAccounts();
            const accountIdsToUpdate = filteredAccounts.map(acc => acc.account_id);

            auditFile.trialBalance.forEach(account => {
                if (accountIdsToUpdate.includes(account.account_id)) {
                    account.review_status = 'reviewed';
                }
            });

            addAuditLogEntry(`تم تحديث حالة ${accountIdsToUpdate.length} حساب إلى "تمت المراجعة" دفعة واحدة.`);
            saveAuditFile();

            processAndRender();

            showNotification(`تم تحديث حالة ${accountIdsToUpdate.length} حساب بنجاح.`, 'success');
        }

        function performLogicalCheck() {
            const rows = document.querySelectorAll('#trialBalanceTable tbody tr');
            let abnormalCount = 0;
            let unclassifiedCount = 0;

            rows.forEach(row => {
                row.classList.remove('abnormal-balance', 'unclassified-account');

                const accountId = row.dataset.accountId;
                const account = auditFile.trialBalance.find(acc => String(acc.account_id) === String(accountId));
                if (!account) return;

                const finalBalance = (account.book_balance || 0) + calculateAdjustments(account.account_id);

                if (!account.category) {
                    row.classList.add('unclassified-account');
                    unclassifiedCount++;
                }

                const isAsset = account.category === 'assets';
                const isLiabilityOrEquity = account.category === 'liabilities' || account.category === 'equity';
                const isRevenue = account.category === 'revenue' && !['sales_discount', 'sales_returns'].includes(account.sub_category);
                const isContraRevenue = ['sales_discount', 'sales_returns'].includes(account.sub_category);
                const isExpense = account.category === 'expenses';

                let isAbnormal = false;
                if (isAsset && finalBalance < 0) isAbnormal = true;
                if (isLiabilityOrEquity && finalBalance > 0) isAbnormal = true;
                if (isRevenue && finalBalance > 0) isAbnormal = true;
                if (isContraRevenue && finalBalance < 0) isAbnormal = true;
                if (isExpense && finalBalance < 0) isAbnormal = true;
                
                if (isAbnormal) {
                    row.classList.add('abnormal-balance');
                    abnormalCount++;
                }
            });

            showNotification(`تم الانتهاء من التدقيق.\n\n- تم العثور على ${abnormalCount} حسابات ذات أرصدة شاذة.\n- تم العثور على ${unclassifiedCount} حسابات غير مصنفة.`, 'info');
            addAuditLogEntry("تم إجراء تدقيق منطقية الأرصدة.");
            saveAuditFile();
        }

        function saveChangesManually() {
            try {
                saveAuditFile();
                addAuditLogEntry("تم حفظ التغييرات يدويًا بواسطة المستخدم.");
                showNotification("تم حفظ التغييرات بنجاح!", 'success');
            } catch (e) {
                console.error("خطأ أثناء الحفظ اليدوي:", e);
                showNotification("حدث خطأ أثناء حفظ التغييرات. الرجاء المحاولة مرة أخرى.", 'danger');
            }
        }

        function exportToExcel() {
            try {
                if (typeof XLSX === 'undefined') {
                    showNotification('خطأ: مكتبة XLSX غير محملة.', 'danger');
                    return;
                }
                if (!auditFile || !auditFile.trialBalance) {
                    showNotification('خطأ: لا توجد بيانات للتصدير.', 'danger');
                    return;
                }

                const headers = [
                    'رقم الحساب', 'اسم الحساب', 'الفئة', 'التصنيف الفرعي',
                    'رصيد أول مدين', 'رصيد أول دائن',
                    'حركة مدين', 'حركة دائن',
                    'رصيد دفتري',
                    'تسويات مدين', 'تسويات دائن',
                    'الرصيد النهائي'
                ];
                
                const exportData = auditFile.trialBalance.map(account => {
                    const accountAdjustments = (auditFile.adjustments || []).filter(adj => 
                        String(adj.debit_account) === String(account.account_id) || 
                        String(adj.credit_account) === String(account.account_id)
                    );
                    const adjustmentDebit = accountAdjustments
                        .filter(adj => String(adj.debit_account) === String(account.account_id))
                        .reduce((sum, adj) => sum + (Number(adj.amount) || 0), 0);
                    const adjustmentCredit = accountAdjustments
                        .filter(adj => String(adj.credit_account) === String(account.account_id))
                        .reduce((sum, adj) => sum + (Number(adj.amount) || 0), 0);

                    const bookBalance = (parseFloat(account.ob_debit) || 0) - (parseFloat(account.ob_credit) || 0) + (parseFloat(account.move_debit) || 0) - (parseFloat(account.move_credit) || 0);
                    const finalBalance = bookBalance + adjustmentDebit - adjustmentCredit;

                    return [
                        account.account_id || '',
                        account.name || '',
                        getCategoryLabel(account.category),
                        getSubCategoryLabelSafe(account.category, account.sub_category),
                        parseFloat(account.ob_debit) || 0,
                        parseFloat(account.ob_credit) || 0,
                        parseFloat(account.move_debit) || 0,
                        parseFloat(account.move_credit) || 0,
                        bookBalance,
                        adjustmentDebit,
                        adjustmentCredit,
                        finalBalance
                    ];
                });

                const ws = XLSX.utils.aoa_to_sheet([headers, ...exportData]);
                
                ws['!cols'] = [
                    { wch: 15 }, { wch: 40 }, { wch: 15 }, { wch: 25 },
                    { wch: 18 }, { wch: 18 }, { wch: 18 }, { wch: 18 },
                    { wch: 18 }, { wch: 18 }, { wch: 18 }, { wch: 18 }
                ];

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ميزان المراجعة التفصيلي");

                const clientName = (auditFile.clientInfo && auditFile.clientInfo.name) ? auditFile.clientInfo.name.replace(/\s/g, '_') : 'Client';
                const fileName = `TB_Detailed_${clientName}_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showNotification(`تم تصدير ميزان المراجعة التفصيلي بنجاح!`, 'success');
                
            } catch (error) {
                console.error('❌ خطأ في تصدير Excel:', error);
                showNotification(`حدث خطأ أثناء تصدير الملف: ${error.message}`, 'danger');
            }
        }

        function getSubCategoryLabelSafe(category, subCategory) {
            try {
                if (!category || !subCategory) return '';
                if (typeof subCategoryMap === 'undefined' || !subCategoryMap[category]) return '';
                const subCat = subCategoryMap[category].find(sc => sc.value === subCategory);
                return subCat ? subCat.label : '';
            } catch (e) {
                return '';
            }
        }

        // === دوال إضافية ستكتمل لاحقاً ===
     /**
 * التصنيف التلقائي للحسابات
 */
/**
 * =================================================================
 * --- التصنيف التلقائي (V7 - مع محرك بحث مُعاد بناؤه بالكامل) ---
 * =================================================================
 * هذا الإصلاح يعالج مشكلة تجاهل القواعد ذات الأولوية.
 */
function autoCategorizeAccounts() {
    console.log("🤖 بدء محرك التصنيف الذكي (V7)...");
    
    let categorizedCount = 0;
    
    auditFile.trialBalance.forEach(account => {
        // إذا كان الحساب مصنفاً ومؤكداً من المستخدم، لا تلمسه.
        if (account.category && account.sub_category && account.is_confirmed) {
            return;
        }
        
        const accountNameLower = account.name.toLowerCase();
        let bestMatch = null;

        // --- الجزء الذي تم إعادة بنائه بالكامل ---
        // الخطوة 1: ابحث عن تطابق تام في القواعد ذات الأولوية أولاً
        for (const rule of keywordMapping) {
            if (rule.priority && accountNameLower.includes(rule.keyword)) {
                bestMatch = rule;
                break; // وجدنا أفضل تطابق ممكن، أوقف البحث.
            }
        }

        // الخطوة 2: إذا لم نجد تطابقًا ذا أولوية، ابحث في القواعد العامة
        if (!bestMatch) {
            for (const rule of keywordMapping) {
                if (!rule.priority && accountNameLower.includes(rule.keyword)) {
                    bestMatch = rule;
                    break; // وجدنا أول تطابق عام، يكفي.
                }
            }
        }
        // --- نهاية الجزء المُعاد بناؤه ---
        
        // إذا وجدنا أي تطابق (سواء كان ذا أولوية أو عامًا)، قم بتطبيق التصنيف
        if (bestMatch) {
            const subCategoryData = Object.values(subCategoryMap).flat().find(sc => sc.value === bestMatch.value);
            if (subCategoryData) {
                const mainCategory = Object.keys(subCategoryMap).find(key => subCategoryMap[key].some(sc => sc.value === bestMatch.value));
                
                // قم بالتحديث فقط إذا كان التصنيف الجديد مختلفاً
                if (account.category !== mainCategory || account.sub_category !== bestMatch.value) {
                    account.category = mainCategory;
                    account.sub_category = bestMatch.value;
                    account.is_confirmed = false; // ضع علامة "غير مؤكد" لأنه تصنيف آلي
                    categorizedCount++;
                }
            }
        }
    });
    
    console.log(`✅ اكتمل التصنيف: تم تحديث ${categorizedCount} حساب.`);
    
    if (categorizedCount > 0) {
        addAuditLogEntry(`قام النظام بتصنيف ${categorizedCount} حساب تلقائياً.`);
        saveAuditFile();
    }
    
    return categorizedCount;
}
        function loadUserPrefs(clientId) {
            const prefsKey = `polarisUserPrefs_${clientId}`;
            const savedPrefs = localStorage.getItem(prefsKey);
            try {
                return savedPrefs ? JSON.parse(savedPrefs) : { filterCategory: 'all', filterStatus: 'all', searchTerm: '' };
            } catch (e) {
                return { filterCategory: 'all', filterStatus: 'all', searchTerm: '' };
            }
        }

        function saveUserPrefs() {
            try {
                localStorage.setItem(`polarisUserPrefs_${auditFile.clientInfo.id}`, JSON.stringify(userPrefs));
            } catch (e) { 
                console.warn("Could not save user preferences."); 
            }
        }

function saveAuditFile() {
    try {
        if (!auditFile || !auditFile.clientInfo || !auditFile.clientInfo.id) {
            console.error("CRITICAL: Cannot save file. Client ID is missing from audit file object.");
            showNotification("خطأ فادح: لا يمكن حفظ الملف لعدم وجود معرّف العميل.", "danger");
            return false;
        }
        
        const activeClientId = auditFile.clientInfo.id;
        const auditFileKey = `polarisAuditFile_${activeClientId}`;

        // حفظ ملف المراجعة الرئيسي مع جميع البيانات المحدثة
        localStorage.setItem(auditFileKey, JSON.stringify(auditFile));
        
        // 🔥 حفظ بيانات مالية منفصلة (بعد التسويات) للصفحات التالية
        const financialData = {
            clientInfo: auditFile.clientInfo,
            trialBalance: auditFile.trialBalance,
            adjustments: auditFile.adjustments || [], // 🔥 ننقل التسويات
            settings: auditFile.settings || {},
            // حسابات الربح بعد التسويات
            profitCalculations: calculateNetProfit(true),
            lastUpdated: new Date().toISOString(),
            note: 'بيانات مبنية على الربح بعد التسويات للصفحات التالية'
        };
        
        const financialKey = `financialData_${activeClientId}`;
        localStorage.setItem(financialKey, JSON.stringify(financialData));
        
        // حفظ بيانات التعيين للتقارير
        saveMappingDataForReports();
        
        // تحديث تاريخ آخر تعديل في إعدادات العميل
        const setupKey = `clientSetup_${activeClientId}`;
        const clientSetupJSON = localStorage.getItem(setupKey);
        if (clientSetupJSON) {
            const clientSetup = JSON.parse(clientSetupJSON);
            if (clientSetup.details) {
                clientSetup.details.updatedAt = new Date().toISOString();
                clientSetup.details.lastProfitUpdate = new Date().toISOString();
                clientSetup.details.profitType = 'after_adjustments'; // 🔥 بعد التسويات
                localStorage.setItem(setupKey, JSON.stringify(clientSetup));
            }
        }

        localStorage.setItem('activeClientId', activeClientId);

        console.log(`✅ Audit file saved successfully for client ID: ${activeClientId}`);
        console.log(`💰 Profit being transferred (after adjustments): ${financialData.profitCalculations.profitAfter}`);
        
        return true; // إرجاع true للنجاح
        
    } catch (e) {
        console.error("CRITICAL: Failed to save audit file!", e);
        showNotification("فشل حفظ البيانات في المتصفح. قد تكون الذاكرة ممتلئة.", "danger");
        return false; // إرجاع false للفشل
    }
}
function calculateProfitBeforeAdjustments() {
    let profitBefore = 0;

    // حساب الربح قبل التسويات فقط
    auditFile.trialBalance.forEach(acc => {
        if (acc.category === 'revenue' || acc.category === 'expenses') {
            const bookBalance = (parseFloat(acc.ob_debit) || 0) - (parseFloat(acc.ob_credit) || 0) + 
                              (parseFloat(acc.move_debit) || 0) - (parseFloat(acc.move_credit) || 0);
            // الإيرادات دائنة (سالبة) والمصروفات مدينة (موجبة)، لذا نعكس الإشارة
            profitBefore -= bookBalance;
        }
    });

    console.log("💰 حساب الربح قبل التسويات للنقل:", profitBefore);

    return { 
        profitAfter: profitBefore, 
        profitForEquity: -profitBefore,
        profitBefore: profitBefore,
        adjustmentsEffect: 0
    };
}
  function setupAjeModal() {
            const debitSelect = document.getElementById('ajeDebitAccount');
            const creditSelect = document.getElementById('ajeCreditAccount');
            debitSelect.innerHTML = '<option value="">اختر الحساب المدين</option>';
            creditSelect.innerHTML = '<option value="">اختر الحساب الدائن</option>';
            auditFile.trialBalance.forEach(account => {
                const option = `<option value="${account.account_id}">${account.account_id} - ${account.name || 'غير مسمى'}</option>`;
                debitSelect.innerHTML += option;
                creditSelect.innerHTML += option;
            });
        }

        function updateCategory(selectElement, accountId) {
            const account = auditFile.trialBalance.find(acc => String(acc.account_id) === String(accountId));
            if (account) {
                account.category = selectElement.value || null;
                account.sub_category = null;
                account.is_confirmed = true;
                
                addAuditLogEntry(`تم تحديث الفئة الرئيسية للحساب ${accountId} إلى ${selectElement.options[selectElement.selectedIndex].text}`);
                
                saveAuditFile();
                processAndRender();
            }
        }



/**
 * تحديث قيمة الأهمية النسبية بناءً على الأساس والنسبة المئوية
 */
function updateMaterialityValue() {
    try {
        const base = document.getElementById('materialityBase').value;
        const percentage = parseFloat(document.getElementById('materialityPercentage').value) || 0;
        let baseValue = 0;
        
        // حساب صافي الربح قبل التسويات
        const { profitBefore } = calculateNetProfit();
        const totalAssets = auditFile.trialBalance.filter(a => a.category === 'assets').reduce((s, a) => s + (a.book_balance || 0), 0);
        const totalRevenue = Math.abs(auditFile.trialBalance.filter(a => a.category === 'revenue').reduce((s, a) => s + (a.book_balance || 0), 0));

        // تحديد القاعدة بناءً على الاختيار
        switch (base) {
            case 'revenue': 
                baseValue = totalRevenue; 
                console.log(`📊 حساب الأهمية بناءً على الإيرادات: ${formatCurrency(totalRevenue)}`);
                break;
            case 'assets': 
                baseValue = totalAssets; 
                console.log(`📊 حساب الأهمية بناءً على الأصول: ${formatCurrency(totalAssets)}`);
                break;
            case 'profit': 
                baseValue = profitBefore; 
                console.log(`📊 حساب الأهمية بناءً على صافي الربح: ${formatCurrency(profitBefore)}`);
                break;
            default:
                baseValue = 0;
        }
        
        const materialityValue = Math.abs(baseValue * (percentage / 100));
        
        // تحديث العنصر في الواجهة
        const materialityElement = document.getElementById('materialityValue');
        if (materialityElement) {
            materialityElement.textContent = formatCurrency(materialityValue);
        }
        
        console.log(`💰 قيمة الأهمية النسبية المحسوبة: ${formatCurrency(materialityValue)}`);
        console.log(`📈 النسبة المئوية: ${percentage}%`);
        
        return materialityValue;
        
    } catch (error) {
        console.error("❌ خطأ في تحديث قيمة الأهمية النسبية:", error);
        return 0;
    }
}

        function updateSubCategory(selectElement, accountId) {
            const account = auditFile.trialBalance.find(acc => String(acc.account_id) === String(accountId));
            if (account) {
                const newSubCategory = selectElement.value;
                account.sub_category = newSubCategory;
                account.is_confirmed = true;
                
                saveAuditFile();
                
                const selectedOption = selectElement.options[selectElement.selectedIndex];
                addAuditLogEntry(`تم تحديث التصنيف الفرعي للحساب ${accountId} إلى ${selectedOption.text}`);
                
                const activeRow = document.querySelector('#trialBalanceTable tr.table-active');
                if (activeRow && activeRow.dataset.accountId === accountId) {
                    updateInspectorPane(accountId);
                }
                
                updateKpiPane();
            }
        }

        /**
         * تحديث حالة المراجعة للحساب، مع إعادة تحديث لوحة التحكم الذكية
         */
        function updateReviewStatus(selectElement, accountId) {
            const account = auditFile.trialBalance.find(acc => String(acc.account_id) === String(accountId));
            
            if (account) {
                // 1. تحديث حالة الحساب (لا تغيير هنا)
                account.review_status = selectElement.value;
                
                // 2. تسجيل الإجراء في سجل المراجعة (لا تغيير هنا)
                addAuditLogEntry(`تم تحديث حالة الحساب ${accountId} إلى '${selectElement.options[selectElement.selectedIndex].text}'`);
                
                // 3. حفظ التغييرات (لا تغيير هنا)
                saveAuditFile();
                
                // 4. تحديث شريط الحالة السفلي (لا تغيير هنا)
                updateStatusBar();

                // 5. ========= الإضافة الجديدة والمهمة =========
                // إعادة تحليل وتحديث لوحة التحكم الذكية لإخفاء الملاحظات التي تم حلها
                console.log('🔄 تحديث لوحة التحكم الذكية بعد تغيير حالة المراجعة...');
                updateCockpit(); 
                // ==========================================
            }
        }
        function deleteAccount(accountId) {
            const account = auditFile.trialBalance.find(acc => String(acc.account_id) === String(accountId));
            
            if (!account) {
                showNotification('خطأ: لم يتم العثور على الحساب.', 'danger');
                return;
            }
            
            const confirmed = confirm(`هل أنت متأكد من حذف الحساب التالي بشكل نهائي؟\n\nالاسم: ${account.name}\nالرقم: ${accountId}\n\nتحذير: لا يمكن التراجع عن هذا الإجراء.`);
            
            if (!confirmed) {
                return;
            }
            
            auditFile.trialBalance = auditFile.trialBalance.filter(acc => String(acc.account_id) !== String(accountId));
            
            if (auditFile.adjustments) {
                auditFile.adjustments = auditFile.adjustments.filter(adj => 
                    String(adj.debit_account) !== String(accountId) && 
                    String(adj.credit_account) !== String(accountId)
                );
            }
            
            addAuditLogEntry(`تم حذف الحساب: ${account.name} (${accountId})`);
            saveAuditFile();
            
            processAndRender();
            
            showNotification('تم حذف الحساب بنجاح.', 'success');
        }

            /**
         * فتح نافذة قيد التسوية
         */
     /**
 * فتح نافذة قيد التسوية المحسّنة
 */
function openAjeModal(accountId, adjustmentId = null) {
    const modal = document.getElementById('ajeModal');
    const isEditMode = !!adjustmentId;

    // مسح الحقول أولاً
    clearAjeForm();

    // ملء قوائم الحسابات
    populateAjeAccounts();

    // تعيين التاريخ الافتراضي
    document.getElementById('ajeDate').valueAsDate = new Date();

    if (isEditMode) {
        // وضع التعديل
        const adj = auditFile.adjustments.find(a => a.id === adjustmentId);
        if (!adj) return;
        
        document.getElementById('ajeModalTitle').textContent = `تعديل قيد التسوية: ${adj.description}`;
        document.getElementById('ajeDescription').value = adj.description;
        document.getElementById('ajeReference').value = adj.reference || '';
        document.getElementById('ajeDebitAccount').value = adj.debit_account;
        document.getElementById('ajeCreditAccount').value = adj.credit_account;
        document.getElementById('ajeAmount').value = adj.amount;
        document.getElementById('isRceSwitch').checked = adj.type === 'RCE';
        
        if (adj.timestamp) {
            const date = new Date(adj.timestamp);
            document.getElementById('ajeDate').valueAsDate = date;
        }
        
        modal.dataset.editingId = adjustmentId;
    } else {
        // وضع الإنشاء
        document.getElementById('ajeModalTitle').textContent = 'إنشاء قيد تسوية جديد';
        
        if (accountId) {
            const account = auditFile.trialBalance.find(acc => String(acc.account_id) === String(accountId));
            if (account) {
                const finalBalance = (account.book_balance || 0) + calculateAdjustments(accountId);
                if (finalBalance > 0) {
                    document.getElementById('ajeCreditAccount').value = accountId;
                } else if (finalBalance < 0) {
                    document.getElementById('ajeDebitAccount').value = accountId;
                }
                document.getElementById('ajeAmount').value = Math.abs(finalBalance);
            }
        }
        delete modal.dataset.editingId;
    }

    // تحديث المعاينة
    updateAjePreview();

    // عرض الحسابات المفضلة
    loadFavoriteAccounts();

    // إعداد مستمعي الأحداث
    setupAjeEventListeners();

    ajeModal.show();
}

/**
 * مسح نموذج قيد التسوية
 */
function clearAjeForm() {
    document.getElementById('ajeDescription').value = '';
    document.getElementById('ajeReference').value = '';
    document.getElementById('ajeDebitAccount').value = '';
    document.getElementById('ajeCreditAccount').value = '';
    document.getElementById('ajeAmount').value = '';
    document.getElementById('isRceSwitch').checked = false;
    document.getElementById('searchDebitAccount').value = '';
    document.getElementById('searchCreditAccount').value = '';
    document.getElementById('amountInWords').textContent = 'سيتم عرض المبلغ بالكلمات هنا';
}

/**
 * ملء قوائم الحسابات في نافذة قيد التسوية
 */
function populateAjeAccounts() {
    const debitSelect = document.getElementById('ajeDebitAccount');
    const creditSelect = document.getElementById('ajeCreditAccount');
    
    // حفظ القيم المحددة حالياً
    const currentDebit = debitSelect.value;
    const currentCredit = creditSelect.value;
    
    // مسح القوائم
    debitSelect.innerHTML = '<option value="">اختر الحساب المدين...</option>';
    creditSelect.innerHTML = '<option value="">اختر الحساب الدائن...</option>';
    
    // تجميع الحسابات حسب الفئة
    const accountsByCategory = {};
    
    auditFile.trialBalance.forEach(account => {
        const category = account.category || 'غير مصنف';
        if (!accountsByCategory[category]) {
            accountsByCategory[category] = [];
        }
        accountsByCategory[category].push(account);
    });
    
    // ملء القوائم
    for (const [category, accounts] of Object.entries(accountsByCategory)) {
        const debitOptgroup = `<optgroup label="${getCategoryLabel(category)}">`;
        const creditOptgroup = `<optgroup label="${getCategoryLabel(category)}">`;
        
        let debitOptions = '';
        let creditOptions = '';
        
        accounts.forEach(account => {
            const finalBalance = (account.book_balance || 0) + calculateAdjustments(account.account_id);
            const optionText = `${account.account_id} - ${account.name || 'غير مسمى'} (${formatCurrency(finalBalance)})`;
            const optionValue = `<option value="${account.account_id}">${optionText}</option>`;
            
            debitOptions += optionValue;
            creditOptions += optionValue;
        });
        
        debitSelect.innerHTML += debitOptgroup + debitOptions + '</optgroup>';
        creditSelect.innerHTML += creditOptgroup + creditOptions + '</optgroup>';
    }
    
    // استعادة القيم المحددة
    debitSelect.value = currentDebit;
    creditSelect.value = currentCredit;
}

/**
 * إعداد مستمعي الأحداث لنافذة قيد التسوية
 */
function setupAjeEventListeners() {
    // البحث في الحسابات
    setupAccountSearch('searchDebitAccount', 'ajeDebitAccount');
    setupAccountSearch('searchCreditAccount', 'ajeCreditAccount');
    
    // تحديث المعاينة عند التغيير
    document.getElementById('ajeDebitAccount').addEventListener('change', updateAjePreview);
    document.getElementById('ajeCreditAccount').addEventListener('change', updateAjePreview);
    document.getElementById('ajeAmount').addEventListener('input', updateAjePreview);
    
    // تحويل المبلغ إلى كلمات
    document.getElementById('ajeAmount').addEventListener('input', function() {
        const amount = parseFloat(this.value) || 0;
        document.getElementById('amountInWords').textContent = numberToWords(amount);
    });
    
    // تغيير نوع القيد
    document.getElementById('isRceSwitch').addEventListener('change', function() {
        const modalTitle = document.getElementById('ajeModalTitle');
        if (this.checked) {
            modalTitle.innerHTML = '<i class="fas fa-sync-alt me-2"></i>إنشاء قيد إعادة تصنيف (RCE)';
        } else {
            modalTitle.innerHTML = '<i class="fas fa-exchange-alt me-2"></i>إنشاء قيد تسوية جديد';
        }
    });
}

/**
 * تحديث معاينة القيد
 */
function updateAjePreview() {
    const debitAccountId = document.getElementById('ajeDebitAccount').value;
    const creditAccountId = document.getElementById('ajeCreditAccount').value;
    const amount = parseFloat(document.getElementById('ajeAmount').value) || 0;
    
    // تحديث الحساب المدين
    const debitPreview = document.getElementById('debitPreview');
    if (debitAccountId) {
        const debitAccount = auditFile.trialBalance.find(acc => acc.account_id === debitAccountId);
        if (debitAccount) {
            debitPreview.innerHTML = `
                <div>${debitAccount.name}</div>
                <small class="text-muted">${debitAccountId}</small>
            `;
        }
    } else {
        debitPreview.textContent = 'لم يتم تحديد الحساب';
    }
    
    // تحديث الحساب الدائن
    const creditPreview = document.getElementById('creditPreview');
    if (creditAccountId) {
        const creditAccount = auditFile.trialBalance.find(acc => acc.account_id === creditAccountId);
        if (creditAccount) {
            creditPreview.innerHTML = `
                <div>${creditAccount.name}</div>
                <small class="text-muted">${creditAccountId}</small>
            `;
        }
    } else {
        creditPreview.textContent = 'لم يتم تحديد الحساب';
    }
    
    // تحديث المبلغ
    document.getElementById('amountPreview').textContent = `المبلغ: ${formatCurrency(amount)}`;
}

/**
 * التحقق من القيد وحفظه
 */
function validateAndSaveAdjustment() {
    // ... الكود الحالي للتحقق من صحة القيد ...
    
    // حفظ القيد
    saveAdjustment({
        debit_account: debitAccount,
        credit_account: creditAccount,
        amount: amount,
        description: description,
        reference: reference,
        timestamp: new Date(date).toISOString(),
        type: isRce ? 'RCE' : 'AJE'
    });
    
    // تحديث الواجهة فوراً
    setTimeout(() => {
        updateStatusBar();
        updateKpiPane();
        updateBalanceCheck();
    }, 100);
}

function saveAdjustment(adjustmentData) {
    // ... الكود الحالي لحفظ القيد ...
    
    // بعد حفظ القيد، قم بتحديث الواجهة
    saveAuditFile();
    
    // إغلاق المودال
    ajeModal.hide();
    
    // تحديث الواجهة
    processAndRender();
    
    // تحديث لوحة المفتش إذا كانت مفتوحة
    const activeRow = document.querySelector('#trialBalanceTable tr.table-active');
    if (activeRow) {
        updateInspectorPane(activeRow.dataset.accountId);
    }
    
    showNotification(editingId ? 'تم تعديل القيد بنجاح' : 'تم إضافة القيد بنجاح', 'success');
}
/**
 * التحقق من المنطق المحاسبي
 */
function validateAccountingLogic(debitAcc, creditAcc, amount, isRce) {
    // إذا كان قيد إعادة تصنيف، يجب أن يكون كلا الحسابين من نفس النوع
    if (isRce) {
        if ((debitAcc.category === 'assets' && creditAcc.category !== 'assets') ||
            (debitAcc.category === 'liabilities' && creditAcc.category !== 'liabilities') ||
            (debitAcc.category === 'equity' && creditAcc.category !== 'equity')) {
            return {
                valid: false,
                message: 'في قيد إعادة التصنيف، يجب أن يكون الحسابان من نفس النوع (أصول، التزامات، أو حقوق ملكية)'
            };
        }
    }
    
    return { valid: true };
}

/**
 * حفظ القيد
 */
function saveAdjustment(adjustmentData) {
    const modal = document.getElementById('ajeModal');
    const editingId = modal.dataset.editingId;
    
    if (editingId) {
        // تعديل قيد موجود
        const adjIndex = auditFile.adjustments.findIndex(a => a.id === editingId);
        if (adjIndex !== -1) {
            auditFile.adjustments[adjIndex] = {
                ...auditFile.adjustments[adjIndex],
                ...adjustmentData
            };
            addAuditLogEntry(`تم تعديل قيد: ${adjustmentData.description}`);
        }
    } else {
        // إضافة قيد جديد
        const newAdj = {
            id: `ADJ-${Date.now()}`,
            ...adjustmentData
        };
        auditFile.adjustments.push(newAdj);
        addAuditLogEntry(`تم إضافة قيد جديد: ${adjustmentData.description}`);
    }
    
    saveAuditFile();
    
    // إغلاق المودال
    ajeModal.hide();
    
    // تحديث الواجهة
    processAndRender();
    
    // تحديث لوحة المفتش إذا كانت مفتوحة
    const activeRow = document.querySelector('#trialBalanceTable tr.table-active');
    if (activeRow) {
        updateInspectorPane(activeRow.dataset.accountId);
    }
    
    showNotification(editingId ? 'تم تعديل القيد بنجاح' : 'تم إضافة القيد بنجاح', 'success');
}

/**
 * تحميل الحسابات المفضلة
 */
function loadFavoriteAccounts() {
    const favorites = getFavoriteAccounts();
    const container = document.getElementById('favoriteAccounts');
    
    if (favorites.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">لا توجد حسابات مفضلة</p>';
        return;
    }
    
    container.innerHTML = favorites.map(account => `
        <div class="col-md-6">
            <button class="btn btn-outline-primary w-100 text-start" onclick="selectFavoriteAccount('${account.id}')">
                <i class="fas fa-star me-2"></i>
                ${account.id} - ${account.name}
            </button>
        </div>
    `).join('');
}

/**
 * اختيار حساب مفضل
 */
function selectFavoriteAccount(accountId) {
    // تحديد الحقل الفارغ تلقائياً
    const debitField = document.getElementById('ajeDebitAccount');
    const creditField = document.getElementById('ajeCreditAccount');
    
    if (!debitField.value) {
        debitField.value = accountId;
    } else if (!creditField.value) {
        creditField.value = accountId;
    } else {
        // إذا كان الحقلان ممتلئين، اسأل المستخدم
        if (confirm('هل تريد استبدال الحساب المدين؟')) {
            debitField.value = accountId;
        } else {
            creditField.value = accountId;
        }
    }
    
    updateAjePreview();
}

/**
 * البحث في الحسابات
 */
function setupAccountSearch(inputId, selectId) {
    const input = document.getElementById(inputId);
    const select = document.getElementById(selectId);
    
    input.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const options = select.querySelectorAll('option');
        
        options.forEach(option => {
            if (option.value === '') return;
            
            const text = option.textContent.toLowerCase();
            const matches = text.includes(searchTerm);
            
            option.style.display = matches ? '' : 'none';
            
            // إبراز النتائج المطابقة
            if (matches && searchTerm) {
                option.style.backgroundColor = 'rgba(0, 123, 255, 0.1)';
            } else {
                option.style.backgroundColor = '';
            }
        });
    });
    
    // تحديث حقل البحث عند الاختيار
    select.addEventListener('change', function() {
        if (this.value) {
            const selectedOption = this.querySelector(`option[value="${this.value}"]`);
            if (selectedOption) {
                input.value = selectedOption.textContent.split(' (')[0]; // إزالة الرصيد
            }
        }
    });
}

/**
 * تحويل الأرقام إلى كلمات (بالعربية)
 */
function numberToWords(num) {
    if (num === 0) return 'صفر ريال سعودي';
    
    const units = ['', 'واحد', 'اثنان', 'ثلاثة', 'أربعة', 'خمسة', 'ستة', 'سبعة', 'ثمانية', 'تسعة'];
    const teens = ['عشرة', 'أحد عشر', 'اثنا عشر', 'ثلاثة عشر', 'أربعة عشر', 'خمسة عشر', 'ستة عشر', 'سبعة عشر', 'ثمانية عشر', 'تسعة عشر'];
    const tens = ['', '', 'عشرون', 'ثلاثون', 'أربعون', 'خمسون', 'ستون', 'سبعون', 'ثمانون', 'تسعون'];
    const hundreds = ['', 'مئة', 'مئتان', 'ثلاثمئة', 'أربعمئة', 'خمسمئة', 'ستمئة', 'سبعمئة', 'ثمانمئة', 'تسمئة'];
    
    // تبسيط للتحويل الأساسي
    const integerPart = Math.floor(num);
    const decimalPart = Math.round((num - integerPart) * 100);
    
    let words = '';
    
    if (integerPart > 0) {
        if (integerPart < 10) {
            words = units[integerPart];
        } else if (integerPart < 20) {
            words = teens[integerPart - 10];
        } else if (integerPart < 100) {
            const ten = Math.floor(integerPart / 10);
            const unit = integerPart % 10;
            words = (unit > 0 ? units[unit] + ' و' : '') + tens[ten];
        } else {
            words = hundreds[Math.floor(integerPart / 100)];
            const remainder = integerPart % 100;
            if (remainder > 0) {
                words += ' و' + numberToWords(remainder);
            }
        }
        
        words += ' ريال سعودي';
        if (integerPart !== 1 && integerPart !== 2) {
            words += 'ات';
        }
    }
    
    if (decimalPart > 0) {
        if (words) words += ' و';
        words += numberToWords(decimalPart) + ' هللة';
    }
    
    return words || 'صفر ريال سعودي';
}

/**
 * الحصول على الحسابات المفضلة
 */
function getFavoriteAccounts() {
    const saved = localStorage.getItem('favoriteAccounts');
    return saved ? JSON.parse(saved) : [];
}

/**
 * إضافة حساب للمفضلة
 */
function addToFavorites(accountId) {
    const account = auditFile.trialBalance.find(acc => acc.account_id === accountId);
    if (!account) return;
    
    let favorites = getFavoriteAccounts();
    
    // التحقق إذا كان الحساب موجوداً بالفعل
    if (!favorites.find(fav => fav.id === accountId)) {
        favorites.push({
            id: account.account_id,
            name: account.name
        });
        
        // الحفظ في localStorage
        localStorage.setItem('favoriteAccounts', JSON.stringify(favorites));
        
        showNotification('تم إضافة الحساب للمفضلة', 'success');
    }
}
        /**
         * معالجة نموذج قيد التسوية
         */
        function handleAdjustmentFormSubmit(event) {
            event.preventDefault();
            
            const editingId = document.getElementById('editingAdjustmentId').value;
            const debitAccount = document.getElementById('adjDebitAccount').value;
            const creditAccount = document.getElementById('adjCreditAccount').value;
            const amount = parseFloat(document.getElementById('adjAmount').value);
            const description = document.getElementById('adjDescription').value.trim();
            const date = document.getElementById('adjDate').value;
            const type = document.getElementById('adjType').value;
            
            if (!debitAccount || !creditAccount || !amount || !description || !date) {
                showNotification('يرجى ملء جميع الحقول المطلوبة', 'warning');
                return;
            }
            
            if (editingId) {
                // تعديل قيد موجود
                const adjIndex = auditFile.adjustments.findIndex(a => a.id === editingId);
                if (adjIndex !== -1) {
                    auditFile.adjustments[adjIndex] = {
                        ...auditFile.adjustments[adjIndex],
                        debit_account: debitAccount,
                        credit_account: creditAccount,
                        amount: amount,
                        description: description,
                        timestamp: new Date(date).toISOString(),
                        type: type
                    };
                    addAuditLogEntry(`تم تعديل قيد التسوية: ${description}`);
                }
            } else {
                // إضافة قيد جديد
                const newAdj = {
                    id: `ADJ-${Date.now()}`,
                    debit_account: debitAccount,
                    credit_account: creditAccount,
                    amount: amount,
                    description: description,
                    timestamp: new Date(date).toISOString(),
                    type: type
                };
                auditFile.adjustments.push(newAdj);
                addAuditLogEntry(`تم إضافة قيد تسوية جديد: ${description}`);
            }
            
            saveAuditFile();
            hideAdjustmentForm();
            renderAdjustmentsTable();
            processAndRender();
            
            showNotification(editingId ? 'تم تعديل القيد بنجاح' : 'تم إضافة القيد بنجاح', 'success');
        }

        /**
         * فتح نافذة الخبير التنفيذي
         */
        function openVAIModal(accountId) {
            const account = auditFile.trialBalance.find(acc => acc.account_id === accountId);
            if (!account) {
                showNotification('خطأ: لم يتم العثور على الحساب.', 'danger');
                return;
            }

            currentVAIContext = { id: account.account_id };
            
            document.getElementById('vAIAssistantResponse').innerHTML = '<div class="text-center p-4"><div class="spinner-border" role="status"></div><p class="mt-2">الخبير يقوم بتحليل الحساب...</p></div>';
            document.getElementById('vAIActionButtons').innerHTML = '';
            
            const modalTitle = document.querySelector('#vAIAssistantModal .modal-title');
            if(modalTitle) modalTitle.textContent = `استشارة الخبير حول: ${account.name}`;

            vAIAssistantModal.show();
            
            setTimeout(getVAIResponse, 500);
        }

        /**
         * الحصول على استجابة الخبير التنفيذي
         */
        function getVAIResponse() {
            const responseDiv = document.getElementById('vAIAssistantResponse');
            const actionsDiv = document.getElementById('vAIActionButtons');
            
            const account = auditFile.trialBalance.find(acc => acc.account_id === currentVAIContext.id);
            if (!account) {
                responseDiv.innerHTML = '<p class="text-danger">خطأ: انقطع الاتصال ببيانات الحساب.</p>';
                return;
            }

            let analysisHTML = `<h6><i class="fas fa-stethoscope me-2"></i>1. تشخيص الوضع</h6><ul>`;
            let procedures = [];
            let hasHighRisk = false;

            if (account.isAbnormal) {
                hasHighRisk = true;
                analysisHTML += `<li><strong class="text-danger">⚠️ علامة خطر: تم اكتشاف رصيد شاذ.</strong></li>`;
                procedures.push("تحليل مكونات الرصيد لتحديد سبب الرصيد الشاذ.");
                procedures.push("اقتراح قيد إعادة تصنيف (RCE) إذا لزم الأمر.");
            }
            if (account.isHighVariance) {
                hasHighRisk = true;
                analysisHTML += `<li><strong class="text-warning">💡 علامة تنبيه: تغير جوهري بنسبة ${account.variance.toFixed(0)}%.</strong></li>`;
                procedures.push("الاستفسار من الإدارة عن أسباب هذا التغير الكبير.");
            }
            if (!account.category) {
                analysisHTML += `<li><strong class="text-primary">🔵 ملاحظة: الحساب غير مصنف.</strong></li>`;
                procedures.push("تحديد الفئة والتصنيف الفرعي المناسبين.");
            }
            if (!hasHighRisk && account.category) {
                analysisHTML += `<li><strong class="text-success">✅ مؤشر أولي: لم يتم اكتشاف علامات خطر.</strong></li>`;
            }
            analysisHTML += `</ul>`;

            analysisHTML += `<h6 class="mt-3"><i class="fas fa-tasks me-2"></i>2. الإجراءات المقترحة</h6><ol>`;
            procedures.push("الحصول على المستندات المؤيدة وتوثيقها.");
            [...new Set(procedures)].forEach(proc => { analysisHTML += `<li>${proc}</li>`; });
            analysisHTML += `</ol>`;

            let actionsHTML = `
                <h6 class="mt-4"><i class="fas fa-play-circle me-2"></i>ابدأ التنفيذ</h6>
                <button class="btn btn-sm btn-outline-secondary me-2" onclick="addNote('${account.account_id}', 'بخصوص الاستفسار عن: ')">
                    <i class="fas fa-comment-dots me-1"></i>إضافة ملاحظة
                </button>
                <button class="btn btn-sm btn-outline-secondary me-2" onclick="openAjeModal('${account.account_id}')">
                    <i class="fas fa-exchange-alt me-1"></i>إنشاء قيد
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="alert('سيتم فتح نافذة أوراق العمل')">
                    <i class="fas fa-paperclip me-1"></i>إرفاق مستند
                </button>
            `;
            
            responseDiv.innerHTML = analysisHTML;
            actionsDiv.innerHTML = actionsHTML;
        }

        /**
         * إضافة ملاحظة
         */
        function addNote(accountId, defaultText = '') {
            const noteText = prompt("أدخل ملاحظتك على الحساب:", defaultText);
            if (noteText && noteText.trim() !== '') {
                const account = auditFile.trialBalance.find(acc => acc.account_id === accountId);
                if (account) {
                    if (!account.notes) account.notes = [];
                    account.notes.push({
                        text: noteText.trim(),
                        timestamp: new Date().toISOString()
                    });
                    saveAuditFile();
                    updateInspectorPane(accountId);
                    showNotification('تم إضافة الملاحظة بنجاح', 'success');
                }
            }
        }

        /**
         * حذف ملاحظة
         */
        function deleteNote(accountId, timestamp) {
            if (!confirm("هل أنت متأكد من حذف هذه الملاحظة؟")) return;
            
            const account = auditFile.trialBalance.find(acc => acc.account_id === accountId);
            if (account && account.notes) {
                account.notes = account.notes.filter(note => note.timestamp !== timestamp);
                saveAuditFile();
                updateInspectorPane(accountId);
                showNotification('تم حذف الملاحظة بنجاح', 'info');
            }
        }

        /**
         * فتح معالج الإهلاك
         */
        function openDepreciationWizard() {
            let totalAssetsCost = 0;
            let depreciationMovement = 0;

            const fixedAssetAccounts = auditFile.trialBalance.filter(acc => 
                acc.category === 'assets' && acc.sub_category && acc.sub_category.startsWith('121')
            );
            totalAssetsCost = fixedAssetAccounts.reduce((sum, acc) => {
                const balance = (acc.book_balance || 0) + calculateAdjustments(acc.account_id);
                return sum + (acc.sub_category === '121099' ? 0 : balance);
            }, 0);

            const depExpenseAccount = auditFile.trialBalance.find(acc => acc.sub_category === '630001');
            if (depExpenseAccount) {
                depreciationMovement = (depExpenseAccount.move_debit || 0) - (depExpenseAccount.move_credit || 0);
            }

            document.getElementById('autoReadAssets').textContent = formatCurrency(totalAssetsCost);
            document.getElementById('autoReadDepreciationMovement').textContent = formatCurrency(depreciationMovement);
            document.getElementById('depreciationRate').value = '';
            calculateDepreciation();
            depreciationWizardModal.show();
        }

        /**
         * حساب الإهلاك
         */
        function calculateDepreciation() {
            const totalAssetsCost = parseFloat(document.getElementById('autoReadAssets').textContent.replace(/[^0-9.-]+/g,""));
            const depreciationMovement = parseFloat(document.getElementById('autoReadDepreciationMovement').textContent.replace(/[^0-9.-]+/g,""));
            const rate = parseFloat(document.getElementById('depreciationRate').value) || 0;

            const totalRequired = totalAssetsCost * (rate / 100);
            const netAdjustment = totalRequired - depreciationMovement;

            document.getElementById('totalRequiredDepreciation').textContent = formatCurrency(totalRequired);
            document.getElementById('alreadyBookedDepreciation').textContent = formatCurrency(depreciationMovement);
            document.getElementById('netAdjustmentNeeded').textContent = formatCurrency(netAdjustment);
        }

        /**
         * إنشاء قيد إهلاك
         */
        function createDepreciationAdjustmentEntry() {
            const netAdjustment = parseFloat(document.getElementById('netAdjustmentNeeded').textContent.replace(/[^0-9.-]+/g,""));
            if (netAdjustment <= 0) {
                showNotification("لا يوجد قيد تسوية مطلوب أو أن المبلغ سالب.", 'warning');
                return;
            }

            const expenseAccount = auditFile.trialBalance.find(a => a.sub_category === '630001');
            const accumulatedAccount = auditFile.trialBalance.find(a => a.sub_category === '121099');

            if (!expenseAccount || !accumulatedAccount) {
                showNotification("خطأ: يجب تصنيف حساب 'مصروف الإهلاك' و 'مجمع الإهلاك' أولاً.", 'danger');
                return;
            }

            const adjustment = {
                id: `ADJ-${Date.now()}`,
                type: 'AJE',
                description: `قيد تسوية إهلاك الأصول السنوي`,
                debit_account: expenseAccount.account_id,
                credit_account: accumulatedAccount.account_id,
                amount: netAdjustment,
                timestamp: new Date().toISOString()
            };

            auditFile.adjustments.push(adjustment);
            saveAuditFile();
            depreciationWizardModal.hide();
            
            preProcessAccountAnalysis();
            renderAll();
            showNotification("تم إنشاء قيد تسوية الإهلاك بنجاح!", 'success');
        }

        /**
         * فتح نافذة قيود التسوية
         */
        function openAdjustmentJournals() {
            populateAccountDropdowns();
            renderAdjustmentsTable();
            adjustmentJournalsModal.show();
        }

        /**
         * عرض جدول القيود
         */
        function renderAdjustmentsTable() {
            const tbody = document.getElementById('adjustmentsTableBody');
            const adjustments = auditFile.adjustments || [];
            
            const searchTerm = document.getElementById('adjustmentSearchInput')?.value.toLowerCase() || '';
            const filtered = adjustments.filter(adj => 
                String(adj.debit_account).toLowerCase().includes(searchTerm) ||
                String(adj.credit_account).toLowerCase().includes(searchTerm) ||
                (adj.description && adj.description.toLowerCase().includes(searchTerm))
            );
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">لا توجد قيود تسوية</td></tr>';
                updateAdjustmentSummary();
                return;
            }
            
            tbody.innerHTML = filtered.map((adj, index) => {
                const debitAccount = auditFile.trialBalance.find(acc => String(acc.account_id) === String(adj.debit_account));
                const creditAccount = auditFile.trialBalance.find(acc => String(acc.account_id) === String(adj.credit_account));
                
                const debitName = debitAccount ? debitAccount.name : 'حساب محذوف';
                const creditName = creditAccount ? creditAccount.name : 'حساب محذوف';
                const amount = formatCurrency(adj.amount);
                const date = adj.timestamp ? new Date(adj.timestamp).toLocaleDateString('ar-SA') : 'N/A';
                const typeBadge = adj.type === 'RCE' 
                    ? '<span class="badge bg-info">إعادة تصنيف</span>' 
                    : '<span class="badge bg-warning">تسوية</span>';
                
                return `
                    <tr class="${adj.type === 'RCE' ? 'table-info' : ''}">
                        <td>${index + 1}</td>
                        <td>${date}</td>
                        <td><span class="badge bg-secondary">${adj.id}</span></td>
                        <td>${adj.description}</td>
                        <td>
                            <div class="small">
                                <div class="text-danger">من: ${adj.debit_account} - ${debitName}</div>
                                <div class="text-success">لـ: ${adj.credit_account} - ${creditName}</div>
                            </div>
                        </td>
                        <td class="fw-bold">${amount}</td>
                        <td>${typeBadge}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editAdjustment('${adj.id}')" title="تعديل">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteAdjustment('${adj.id}')" title="حذف">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateAdjustmentSummary();
        }

        /**
         * تحديث ملخص القيود
         */
     function updateAdjustmentSummary() {
    const adjustments = auditFile.adjustments || [];
    
    let totalDebit = 0;
    let totalCredit = 0;
    
    adjustments.forEach(adj => {
        const amount = Number(adj.amount) || 0;
        totalDebit += amount;
        totalCredit += amount;
    });
    
    // استخدام الدالة الجديدة لحساب التأثير الصحيح
    const netEffect = calculateAdjustmentsEffectOnProfit();
    
    document.getElementById('totalAdjCount').textContent = adjustments.length;
    document.getElementById('totalDebitAdj').textContent = formatCurrency(totalDebit);
    document.getElementById('totalCreditAdj').textContent = formatCurrency(totalCredit);
    
    const netEffectElement = document.getElementById('netAdjEffect');
    netEffectElement.textContent = formatCurrency(netEffect);
    netEffectElement.className = netEffect >= 0 ? 'mb-0 text-success' : 'mb-0 text-danger';
    
    console.log(`📊 تحديث ملخص القيود:`);
    console.log(`   إجمالي القيود: ${adjustments.length}`);
    console.log(`   إجمالي المدين: ${totalDebit}`);
    console.log(`   إجمالي الدائن: ${totalCredit}`);
    console.log(`   صافي التأثير: ${netEffect}`);
}

        /**
         * تعديل قيد
         */
        function editAdjustment(adjustmentId) {
            const adj = auditFile.adjustments.find(a => a.id === adjustmentId);
            if (!adj) return;
            
            document.getElementById('formTitle').innerHTML = '<i class="fas fa-edit me-2"></i>تعديل قيد التسوية';
            document.getElementById('adjustmentFormSection').style.display = 'block';
            
            document.getElementById('editingAdjustmentId').value = adjustmentId;
            document.getElementById('adjDebitAccount').value = adj.debit_account;
            document.getElementById('adjCreditAccount').value = adj.credit_account;
            document.getElementById('adjAmount').value = adj.amount;
            document.getElementById('adjDescription').value = adj.description;
            document.getElementById('adjType').value = adj.type || 'AJE';
            
            const dateFromTimestamp = new Date(adj.timestamp);
            if (!isNaN(dateFromTimestamp)) {
                const year = dateFromTimestamp.getFullYear();
                const month = String(dateFromTimestamp.getMonth() + 1).padStart(2, '0');
                const day = String(dateFromTimestamp.getDate()).padStart(2, '0');
                document.getElementById('adjDate').value = `${year}-${month}-${day}`;
            } else {
                document.getElementById('adjDate').valueAsDate = new Date();
            }
            
            document.getElementById('adjustmentFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        /**
         * حذف قيد
         */
        function deleteAdjustment(adjustmentId) {
            if (!confirm("هل أنت متأكد من حذف هذا القيد نهائيًا؟")) return;
            
            const index = auditFile.adjustments.findIndex(a => a.id === adjustmentId);
            if (index === -1) return;
            
            const deleted = auditFile.adjustments.splice(index, 1)[0];
            addAuditLogEntry(`تم حذف قيد ${deleted.type}: ${deleted.description}`);
            saveAuditFile();
            
            renderAdjustmentsTable();
            processAndRender();
            
            showNotification('تم حذف القيد بنجاح', 'info');
        }

        /**
         * إخفاء نموذج القيد
         */
        function hideAdjustmentForm() {
            document.getElementById('adjustmentFormSection').style.display = 'none';
            document.getElementById('adjustmentForm').reset();
            document.getElementById('editingAdjustmentId').value = '';
        }

        /**
         * ملء قوائم الحسابات
         */
        function populateAccountDropdowns() {
            const debitSelect = document.getElementById('adjDebitAccount');
            const creditSelect = document.getElementById('adjCreditAccount');
            
            if (!debitSelect || !creditSelect) return;
            
            debitSelect.innerHTML = '<option value="">-- اختر الحساب المدين --</option>';
            creditSelect.innerHTML = '<option value="">-- اختر الحساب الدائن --</option>';
            
            if (auditFile && auditFile.trialBalance) {
                auditFile.trialBalance.forEach(account => {
                    const optionHTML = `<option value="${account.account_id}">${account.account_id} - ${account.name}</option>`;
                    debitSelect.innerHTML += optionHTML;
                    creditSelect.innerHTML += optionHTML;
                });
            }
        }

        /**
         * تنزيل نسخة احتياطية
         */
        function downloadBackup() {
            if (!auditFile || !auditFile.clientInfo) {
                showNotification("لا توجد بيانات حالية لإنشاء نسخة احتياطية.", 'warning');
                return;
            }

            const comprehensiveClientInfo = {
                id: auditFile.clientInfo.id,
                name: auditFile.clientInfo.name || auditFile.clientInfo.companyName || auditFile.clientInfo.groupName,
                type: auditFile.clientInfo.type || 'single',
                cr: auditFile.clientInfo.cr || 'N/A',
                startDate: auditFile.clientInfo.startDate,
                endDate: auditFile.clientInfo.endDate,
                framework: auditFile.clientInfo.framework || 'IFRS',
                subsidiaries: auditFile.clientInfo.subsidiaries || []
            };

            const backupData = {
                clientInfo: comprehensiveClientInfo,
                settings: auditFile.settings || {},
                trialBalance: auditFile.trialBalance || [],
                adjustments: auditFile.adjustments || [],
                auditLog: auditFile.auditLog || [],
                learningDb: auditFile.learningDb || {}
            };

            const clientNameForFile = (comprehensiveClientInfo.name || 'Untitled_Project').replace(/[\s\W]/g, '_');
            const dateStr = new Date().toISOString().slice(0, 10);
            const filename = `Polaris_Backup_${clientNameForFile}_${dateStr}.json`;
            
            downloadJSON(backupData, filename);
            
            showNotification("تم تنزيل نسخة احتياطية شاملة من عملك الحالي بنجاح.", 'success');
        }

        /**
         * تنزيل ملف JSON
         */
        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }

        /**
         * تشغيل استعادة النسخة الاحتياطية
         */
        function triggerRestore() {
            if (confirm("تحذير: سيتم استبدال البيانات الحالية في المتصفح ببيانات النسخة الاحتياطية. هل أنت متأكد من المتابعة؟")) {
                document.getElementById('restoreInput').click();
            }
        }

        /**
         * استعادة من نسخة احتياطية
         */
 function restoreFromBackup(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();

    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);

            if (data.trialBalance && data.clientInfo && data.clientInfo.id) {

                const clientId = data.clientInfo.id;
                const auditFileKey = `polarisAuditFile_${clientId}`;

                // 🧹 تنظيف كامل قبل الاستعادة
                console.log("🧹 تنظيف البيانات القديمة...");

                localStorage.removeItem(auditFileKey);
                localStorage.removeItem(`accountMappingData_${clientId}`);
                localStorage.removeItem(`finalAudit_${clientId}`);
                localStorage.removeItem(`priorYearData_${clientId}`);
                localStorage.removeItem("priorYearDataLoaded");

                // حفظ النسخة الجديدة
                localStorage.setItem(auditFileKey, JSON.stringify(data));

                showNotification(
                    `✅ تم استعادة ملف المراجعة بنجاح للعميل: ${data.clientInfo.name}. سيتم إعادة تحميل الصفحة.`,
                    "success"
                );

                setTimeout(() => {
                    window.location.href = `account-mapping.html?clientId=${clientId}`;
                }, 1500);

            } else {
                throw new Error("صيغة ملف النسخة الاحتياطية غير صحيحة.");
            }

        } catch (error) {
            console.error("❌ فشلت عملية الاستعادة:", error);
            showNotification(`فشلت عملية الاستعادة: ${error.message}`, "danger");
        } finally {
            event.target.value = "";
        }
    };

    reader.readAsText(file);
}


        /**
         * الانتقال للتقارير المالية
         */
        function goToFinancialReports() {
            const activeClientId = localStorage.getItem('activeClientId');
            if (!activeClientId) {
                showNotification("خطأ: لا يمكن تحديد العميل النشط للانتقال إلى التقارير.", 'danger');
                return;
            }

            const isSaved = saveMappingDataForReports();
            if (!isSaved) {
                showNotification("فشل حفظ البيانات الحالية. لا يمكن المتابعة إلى التقارير.", 'danger');
                return;
            }

            console.log(`الانتقال إلى صفحة التقارير للعميل: ${activeClientId}`);
            window.location.href = `reporting-pantheon.html?clientId=${activeClientId}`;
        }

        /**
         * حفظ بيانات التعيين للتقارير
         */
function saveMappingDataForReports() {
    try {
        const activeClientId = localStorage.getItem('activeClientId');
        if (!activeClientId) {
            console.error("لا يوجد عميل نشط لحفظ البيانات");
            return false;
        }

        console.log("💾 بدء حفظ بيانات التعيين والتقارير (مع معالجة الإشارات)...");

        // حساب الأرصدة النهائية مع التسويات
        const accountsForReporting = auditFile.trialBalance.map(acc => {
            if (!acc) return null;
            
            const finalBalance = (acc.book_balance || 0) + calculateAdjustments(acc.account_id);
            
            return {
                accountNumber: acc.account_id,
                accountName: acc.name || 'غير مسمى',
                debitBalance: finalBalance > 0 ? finalBalance : 0,
                creditBalance: finalBalance < 0 ? Math.abs(finalBalance) : 0,
                category: acc.category,
                subCategory: acc.sub_category,
                finalBalance: finalBalance,
                reviewStatus: acc.review_status || 'pending',
                openingBalance: (parseFloat(acc.ob_debit) || 0) - (parseFloat(acc.ob_credit) || 0),
                movementBalance: (parseFloat(acc.move_debit) || 0) - (parseFloat(acc.move_credit) || 0),
                adjustments: calculateAdjustments(acc.account_id)
            };
        }).filter(acc => acc !== null);

        // 🔥 حسابات الربح بعد التسويات مع معالجة الإشارة
        const profitData = calculateNetProfit(true);
        
        console.log("💰 حسابات الربح للنقل (مع الإشارات):");
        console.log(`   الربح قبل التسويات: ${profitData.profitBefore}`);
        console.log(`   تأثير التسويات: ${profitData.adjustmentsEffect}`);
        console.log(`   الربح النهائي: ${profitData.profitAfter}`);
        console.log(`   هل خسارة؟ ${profitData.isLoss ? 'نعم' : 'لا'}`);
        console.log(`   القيمة للنقل: ${Math.abs(profitData.profitAfter)}`);

        const mappingData = {
            finalized: true,
            finalizedAt: new Date().toISOString(),
            accounts: accountsForReporting,
            adjustments: auditFile.adjustments || [],
            clientInfo: auditFile.clientInfo || { id: activeClientId, name: 'عميل غير محدد' },
            settings: auditFile.settings || {},
            // 🔥 إضافة حسابات الربح مع الإشارات الصحيحة
            financials: {
                profitBefore: profitData.profitBefore,
                adjustmentsEffect: profitData.adjustmentsEffect,
                profitAfter: profitData.profitAfter, // القيمة الأصلية مع الإشارة
                profitAfterAbsolute: Math.abs(profitData.profitAfter), // 🔥 القيمة المطلقة للعرض
                profitForEquity: profitData.profitForEquity,
                isLoss: profitData.isLoss, // 🔥 مؤشر الخسارة
                displayText: profitData.isLoss ? 
                    `خسارة ${formatCurrency(Math.abs(profitData.profitAfter))}` : 
                    `ربح ${formatCurrency(profitData.profitAfter)}`
            },
            auditLog: auditFile.auditLog || [],
            lastUpdated: new Date().toISOString()
        };

        const mappingKey = `accountMappingData_${activeClientId}`;
        localStorage.setItem(mappingKey, JSON.stringify(mappingData));
        
        // حفظ نسخة احتياطية للقوائم المالية
        const statementsKey = `financialStatements_${activeClientId}`;
        localStorage.setItem(statementsKey, JSON.stringify({
            ...mappingData,
            type: 'statements',
            note: 'بيانات مبنية على الربح بعد التسويات مع الإشارات الصحيحة'
        }));
        
        console.log("✅ تم حفظ بيانات التعيين والتقارير بنجاح");
        console.log("💰 صافي الربح المحفوظ (بعد التسويات):", profitData.profitAfter);
        console.log("💰 القيمة المطلقة للعرض:", Math.abs(profitData.profitAfter));
        console.log("📊 عدد الحسابات المحفوظة:", mappingData.accounts.length);
        
        return true;
        
    } catch (error) {
        console.error("❌ خطأ في حفظ بيانات التعيين:", error);
        return false;
    }
}
function verifyBalanceConsistency() {
    console.clear();
    console.log("🔍 === التحقق من تناسق حساب التوازن ===");
    
    const balance1 = calculateTrialBalanceBalance();
    const balance2 = PolarisBalanceChecker.calculateBalance(auditFile.trialBalance);
    
    console.log("\n📊 النتيجة من الدالة الموحدة:");
    console.log(`   المدين: ${balance1.totalDebits}`);
    console.log(`   الدائن: ${balance1.totalCredits}`);
    console.log(`   الفرق: ${balance1.difference}`);
    console.log(`   متوازن: ${balance1.isBalanced}`);
    
    console.log("\n📊 النتيجة من PolarisBalanceChecker:");
    console.log(`   المدين: ${balance2.totalDebits}`);
    console.log(`   الدائن: ${balance2.totalCredits}`);
    console.log(`   الفرق: ${balance2.difference}`);
    console.log(`   متوازن: ${balance2.isBalanced}`);
    
    // تجاهل الفروق الصغيرة جداً (أقل من 0.000001)
    const isConsistent = 
        Math.abs(balance1.totalDebits - balance2.totalDebits) < 0.000001 &&
        Math.abs(balance1.totalCredits - balance2.totalCredits) < 0.000001;
    
    // التحقق من حالة التوازن (مع السماح بالفروق الصغيرة)
    const balanceConsistent = 
        (balance1.isBalanced && balance2.isBalanced) ||
        (Math.abs(balance1.difference) < 0.01 && Math.abs(balance2.difference) < 0.01);
    
    if (isConsistent && balanceConsistent) {
        showNotification("✅ جميع أنظمة حساب التوازن متسقة", "success");
        console.log("✅ التناسق confirmed: الفروق ضمن حدود التقريب المقبولة");
    } else {
        showNotification("⚠️ يوجد عدم تناسق في أنظمة حساب التوازن", "warning");
        console.log("❌ عدم تناسق detected:");
        console.log(`   فرق المدين: ${Math.abs(balance1.totalDebits - balance2.totalDebits)}`);
        console.log(`   فرق الدائن: ${Math.abs(balance1.totalCredits - balance2.totalCredits)}`);
    }
}     /**
         * اعتماد البيانات النهائي
         */
function finalizeData() {
    console.log("🔒 بدء عملية الاعتماد النهائي...");
    
    // التحقق من صحة البيانات باستخدام الدالة الموحدة
    const validation = validateDataForTransfer();
    
    if (!validation.isValid) {
        console.log("❌ فشل التحقق من البيانات:");
        validation.issues.forEach(issue => console.log(`   - ${issue}`));
        
        const issuesText = validation.issues.join('\n- ');
        showNotification(
            `لا يمكن اعتماد البيانات بسبب المشاكل التالية:\n\n- ${issuesText}\n\n` +
            `ملاحظة: الفرق ${Math.abs(validation.balanceData.difference).toFixed(2)} ريال`, 
            'warning'
        );
        return;
    }

    // رسالة التأكيد النهائية
    const confirmMessage = 
        `هل أنت متأكد من اعتماد ميزان المراجعة بشكل نهائي؟\n\n` +
        `📊 ملخص البيانات:\n` +
        `• صافي الربح النهائي: ${formatCurrency(validation.profitData.profitAfter)}\n` +
        `• إجمالي المدين: ${formatCurrency(validation.balanceData.totalDebits)}\n` +
        `• إجمالي الدائن: ${formatCurrency(validation.balanceData.totalCredits)}\n` +
        `• الفرق: ${formatCurrency(validation.balanceData.difference)}\n\n` +
        `سيتم حفظ نسخة نهائية من عملك الحالي للتقارير.`;

    if (!confirm(confirmMessage)) {
        return;
    }

    try {
        console.log("💾 بدء عملية الاعتماد النهائية...");

        // حفظ البيانات النهائية
        const isSaved = saveAuditFile();
        const isMappingSaved = saveMappingDataForReports();
        
        if (!isSaved || !isMappingSaved) {
            throw new Error("فشل حفظ البيانات النهائية");
        }

        // حفظ نسخة نهائية منفصلة
        const finalAuditPackage = {
            ...auditFile,
            finalizedAt: new Date().toISOString(),
            finalProfit: validation.profitData,
            finalBalance: validation.balanceData,
            status: 'finalized'
        };
        
        const finalKey = `finalAudit_${auditFile.clientInfo.id}`;
        localStorage.setItem(finalKey, JSON.stringify(finalAuditPackage));

        console.log(`✅ تم اعتماد وحفظ حقيبة المراجعة بنجاح.`);
        console.log(`💰 صافي الربح النهائي المعتمد: ${validation.profitData.profitAfter}`);
        console.log(`⚖️ التوازن النهائي: ${validation.balanceData.isBalanced ? 'متوازن' : 'فرق بسيط مقبول'}`);
        
        showNotification(
            `✅ تم اعتماد البيانات بنجاح!\n\n` +
            `📊 ملخص نهائي:\n` +
            `• صافي الربح: ${formatCurrency(validation.profitData.profitAfter)}\n` +
            `• التوازن: ${validation.balanceData.isBalanced ? 'متوازن' : 'فرق تقريب مقبول'}\n` +
            `• الحسابات: ${auditFile.trialBalance.length} حساب\n\n` +
            `يمكنك الآن الانتقال إلى صفحة القوائم المالية أو ديوان التقارير.`, 
            'success'
        );
        
        // تحديث زر الاعتماد
        const finalizeButton = document.getElementById('finalizeButton');
        if(finalizeButton) {
            finalizeButton.classList.remove('btn-success');
            finalizeButton.classList.add('btn-outline-success');
            finalizeButton.disabled = true;
            finalizeButton.innerHTML = '<i class="fas fa-check-circle me-2"></i>تم الاعتماد';
        }
        
    } catch (error) {
        console.error("❌ خطأ فادح أثناء الاعتماد:", error);
        showNotification(`فشلت عملية الاعتماد: ${error.message}`, 'danger');
    }
}function validateDataForTransfer() {
    const issues = [];
    
    // التحقق من وجود بيانات أساسية
    if (!auditFile || !auditFile.trialBalance) {
        issues.push("بيانات ميزان المراجعة غير مكتملة");
        return { isValid: false, issues: issues, profitData: null };
    }
    
    // استخدام نفس طريقة حساب التوازن في updateBalanceCheck
    let totalDebits = 0;
    let totalCredits = 0;

    auditFile.trialBalance.forEach(account => {
        const bookBalance = (account.book_balance || 0);
        const adjustments = calculateAdjustments(account.account_id);
        const finalBalance = bookBalance + adjustments;
        
        if (finalBalance > 0) {
            totalDebits += finalBalance;
        } else if (finalBalance < 0) {
            totalCredits += Math.abs(finalBalance);
        }
    });

    const difference = totalDebits - totalCredits;
    // استخدام نفس المعيار: تجاهل الفروق أقل من 0.1
    const isBalanced = Math.abs(difference) < 0.1;
    
    console.log("🔍 التحقق من التوازن (في validateDataForTransfer - النسخة النهائية):");
    console.log(`   إجمالي المدين: ${totalDebits}`);
    console.log(`   إجمالي الدائن: ${totalCredits}`);
    console.log(`   الفرق: ${difference}`);
    console.log(`   متوازن: ${isBalanced} (حد التوازن: 0.1)`);

    // التحقق من التوازن بنفس الطريقة
    if (!isBalanced && Math.abs(difference) >= 0.1) {
        issues.push(`ميزان المراجعة غير متوازن: الفرق ${formatCurrency(difference)}`);
    }
    
    // التحقق من وجود قيود تسوية
    if (!auditFile.adjustments || auditFile.adjustments.length === 0) {
        console.log("⚠️ لا توجد قيود تسوية مسجلة");
    }
    
    // حسابات الربح
    const profitData = calculateNetProfit(true);
    if (isNaN(profitData.profitAfter)) {
        issues.push("صافي الربح غير صالح");
    }
    
    return {
        isValid: issues.length === 0,
        issues: issues,
        profitData: profitData,
        balanceData: {
            totalDebits: totalDebits,
            totalCredits: totalCredits,
            difference: difference,
            isBalanced: isBalanced
        }
    };
}

/**
 * دالة موحدة لحساب توازن ميزان المراجعة
 * تستخدم في جميع أنحاء التطبيق لضمان التناسق
 */
function calculateTrialBalanceBalance() {
    if (!auditFile || !auditFile.trialBalance) {
        return {
            totalDebits: 0,
            totalCredits: 0,
            difference: 0,
            isBalanced: false,
            error: "لا توجد بيانات ميزان مراجعة"
        };
    }

    let totalDebits = 0;
    let totalCredits = 0;

    auditFile.trialBalance.forEach(account => {
        const bookBalance = (account.book_balance || 0);
        const adjustments = calculateAdjustments(account.account_id);
        const finalBalance = bookBalance + adjustments;
        
        if (finalBalance > 0) {
            totalDebits += finalBalance;
        } else if (finalBalance < 0) {
            totalCredits += Math.abs(finalBalance);
        }
    });

    const difference = totalDebits - totalCredits;
    // تجاهل الفروق الصغيرة جداً (أقل من 0.0001)
    const isBalanced = Math.abs(difference) < 0.0001;

    console.log("📊 حساب التوازن المحدث:");
    console.log(`   إجمالي المدين: ${totalDebits}`);
    console.log(`   إجمالي الدائن: ${totalCredits}`);
    console.log(`   الفرق: ${difference}`);
    console.log(`   متوازن: ${isBalanced} (حد التوازن: 0.0001)`);

    return {
        totalDebits: totalDebits,
        totalCredits: totalCredits,
        difference: difference,
        isBalanced: isBalanced,
        error: null
    };
}      /**
         * الانتقال للقوائم المالية
         */
function goToFinancialStatements() {
    const activeClientId = localStorage.getItem('activeClientId');
    if (!activeClientId) {
        showNotification("خطأ: لا يمكن تحديد العميل النشط.", 'danger');
        return;
    }

    const isSaved = saveAuditFile();
    const isMappingSaved = saveMappingDataForReports();
    
    if (!isSaved || !isMappingSaved) {
        showNotification("فشل حفظ البيانات المحدثة. لا يمكن المتابعة.", 'danger');
        return;
    }

    // 🔥 عرض رسالة توضح القيمة المطلقة الصحيحة
    const profitData = calculateNetProfit(true);
    const profitText = profitData.isLoss ? 
        `خسارة ${formatCurrency(Math.abs(profitData.profitAfter))}` : 
        `ربح ${formatCurrency(profitData.profitAfter)}`;
    
    showNotification(
        `جاري الانتقال للقوائم المالية...\n\n` +
        `📊 سيتم نقل البيانات التالية:\n` +
        `• صافي الربح (بعد التسويات): ${profitText}\n` +
        `• القيمة الأصلية: ${formatCurrency(profitData.profitAfter)}\n` +
        `• تأثير التسويات: ${formatCurrency(profitData.adjustmentsEffect)}\n` +
        `• جميع قيود التسوية: سيتم نقلها`, 
        'success'
    );

    console.log(`🔄 الانتقال إلى القوائم المالية للعميل: ${activeClientId}`);
    console.log(`💰 صافي الربح المنقول: ${profitData.profitAfter}`);
    console.log(`💰 القيمة المطلقة للعرض: ${Math.abs(profitData.profitAfter)}`);
    
    setTimeout(() => {
        window.location.href = `consolidation-cockpit.html?clientId=${activeClientId}`;
    }, 1500);
}function goToReportsPantheon() {
    const activeClientId = localStorage.getItem('activeClientId');
    if (!activeClientId) {
        showNotification("خطأ: لا يمكن تحديد العميل النشط.", 'danger');
        return;
    }

    const isSaved = saveAuditFile();
    const isMappingSaved = saveMappingDataForReports();
    
    if (!isSaved || !isMappingSaved) {
        showNotification("فشل حفظ البيانات المحدثة. لا يمكن المتابعة.", 'danger');
        return;
    }

    const profitData = calculateProfitBeforeAdjustments();
    showNotification(
        `جاري الانتقال لديوان التقارير...\n\n` +
        `📊 سيتم نقل البيانات التالية:\n` +
        `• صافي الربح (قبل التسويات): ${formatCurrency(profitData.profitBefore)}\n` +
        `• قيود التسوية: لن يتم نقلها\n` +
        `• جميع الحسابات: كما هي في الميزان`, 
        'info'
    );

    console.log(`🔄 الانتقال لديوان التقارير للعميل: ${activeClientId}`);
    console.log(`💰 صافي الربح المنقول (قبل التسويات): ${profitData.profitBefore}`);
    
    setTimeout(() => {
        window.location.href = `reporting-pantheon.html?clientId=${activeClientId}`;
    }, 1500);
}        /**
         * رفع مستند
         */
        function uploadWorkpaper() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileData = {
                        name: file.name,
                        type: file.type,
                        content: e.target.result,
                        uploadedAt: new Date().toISOString()
                    };

                    const account = auditFile.trialBalance.find(acc => acc.account_id === currentWorkpaperAccountId);
                    if (account) {
                        if (!account.workpapers) account.workpapers = [];
                        account.workpapers.push(fileData);
                        addAuditLogEntry(`تم إرفاق مستند '${file.name}' للحساب ${currentWorkpaperAccountId}.`);
                        saveAuditFile();
                        renderWorkpapersList(account.workpapers);
                        processAndRender();
                        showNotification('تم رفع المستند بنجاح!', 'success');
                    } else {
                        showNotification('خطأ: لم يتم العثور على الحساب.', 'danger');
                    }
                };
                reader.readAsDataURL(file);
            };
            fileInput.click();
        }
function verifyTransferredData() {
    const activeClientId = localStorage.getItem('activeClientId');
    if (!activeClientId) return;
    
    const mappingKey = `accountMappingData_${activeClientId}`;
    const mappingData = JSON.parse(localStorage.getItem(mappingKey) || '{}');
    
    if (mappingData.financials) {
        console.log("🔍 التحقق من البيانات المنقولة:");
        console.log(`   الربح النهائي: ${mappingData.financials.profitAfter}`);
        console.log(`   القيمة المطلقة: ${mappingData.financials.profitAfterAbsolute}`);
        console.log(`   نص العرض: ${mappingData.financials.displayText}`);
        console.log(`   هل خسارة؟ ${mappingData.financials.isLoss}`);
        
        // التحقق من الإشارة
        const expectedValue = -347913.33; // القيمة المتوقعة
        const transferredValue = mappingData.financials.profitAfter;
        
        if (Math.abs(transferredValue - expectedValue) < 1) {
            console.log("✅ الإشارة المنقولة صحيحة");
            showNotification("✅ التحقق: الإشارة المنقولة صحيحة", "success");
        } else {
            console.log("❌ الإشارة المنقولة غير صحيحة");
            console.log(`   المتوقع: ${expectedValue}`);
            console.log(`   المنقول: ${transferredValue}`);
            showNotification("❌ التحقق: الإشارة المنقولة غير صحيحة", "danger");
        }
    }
}
        /**
         * عرض قائمة المستندات
         */
        function renderWorkpapersList(workpapers) {
            const list = document.getElementById('workpapersList');
            list.innerHTML = '';
            if (!workpapers || workpapers.length === 0) {
                list.innerHTML = '<li class="list-group-item text-muted">لا توجد مستندات مرفقة حالياً.</li>';
                return;
            }
            workpapers.forEach((wp, index) => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    <span><i class="fas fa-file me-2"></i>${wp.name}</span>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary btn-sm" onclick="downloadWorkpaper(event, ${index})"><i class="fas fa-download"></i></button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteWorkpaper(event, ${index})"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        /**
         * تنزيل مستند
         */
        function downloadWorkpaper(event, index) {
            event.stopPropagation();
            const account = auditFile.trialBalance.find(acc => acc.account_id === currentWorkpaperAccountId);
            if (account && account.workpapers && account.workpapers[index]) {
                const wp = account.workpapers[index];
                const link = document.createElement('a');
                link.href = wp.content;
                link.download = wp.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        /**
         * حذف مستند
         */
        function deleteWorkpaper(event, index) {
            event.stopPropagation();
            if (!confirm('هل أنت متأكد من حذف ورقة العمل هذه؟')) return;
            const account = auditFile.trialBalance.find(acc => acc.account_id === currentWorkpaperAccountId);
            if (account) {
                const deletedWp = account.workpapers.splice(index, 1);
                addAuditLogEntry(`تم حذف مستند '${deletedWp[0].name}' من الحساب ${currentWorkpaperAccountId}.`);
                saveAuditFile();
                renderWorkpapersList(account.workpapers);
                processAndRender();
                showNotification('تم حذف المستند بنجاح', 'info');
            }
        }

        /**




         * إعداد البحث في القوائم المنسدلة
         */
        function setupSearchableSelect(inputId, selectId) {
            const input = document.getElementById(inputId);
            const select = document.getElementById(selectId);
            const allOptions = Array.from(select.options).map(opt => ({
                value: opt.value,
                text: opt.textContent
            }));

            function renderOptions(filter = '') {
                const lowerCaseFilter = filter.toLowerCase();
                const currentValue = select.value;
                select.innerHTML = '';

                allOptions.forEach(opt => {
                    if (!filter || opt.text.toLowerCase().includes(lowerCaseFilter) || opt.value.includes(lowerCaseFilter)) {
                        const option = document.createElement('option');
                        option.value = opt.value;
                        option.textContent = opt.text;
                        select.appendChild(option);
                    }
                });
                select.value = currentValue;
            }

            input.addEventListener('input', function() {
                renderOptions(this.value);
            });

            select.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption) {
                    input.value = selectedOption.textContent;
                    select.value = selectedOption.value;
                }
            });

            const initialValue = select.value;
            if (initialValue) {
                const initialOption = allOptions.find(opt => opt.value === initialValue);
                if (initialOption) {
                    input.value = initialOption.text;
                }
            }
        }

        // ================================================================
        // --- الدوال الجديدة: عرض الفرق وملاحظات المراجعة ---
        // ================================================================

  /**
 * تحديث عرض الفرق في ميزان المراجعة (النسخة النهائية المركزة)
 * هذه الدالة مسؤولة فقط عن تنبيهات التوازن.
 */
/**
 * تحديث عرض الفرق في ميزان المراجعة (نسخة محسّنة بالكامل)
 */
/**
 * تحديث عرض الفرق في ميزان المراجعة (نسخة مصححة بالكامل)
 */
function updateBalanceCheck() {
    try {
        const alertsContainer = document.getElementById('cockpit-alerts-container');
        if (!alertsContainer) return;

        const balanceData = calculateTrialBalanceBalance();
        
        console.log("📊 تحديث عرض الفرق (النسخة النهائية):");
        console.log(`   إجمالي المدين: ${balanceData.totalDebits}`);
        console.log(`   إجمالي الدائن: ${balanceData.totalCredits}`);
        console.log(`   الفرق: ${balanceData.difference}`);
        console.log(`   متوازن: ${balanceData.isBalanced}`);

        alertsContainer.innerHTML = '';

        // اعتبار الفرق البسيط متوازناً
        if (balanceData.isBalanced || Math.abs(balanceData.difference) < 0.1) {
            const message = balanceData.isBalanced ? 
                "جميع الأرصدة متوازنة بنجاح!" : 
                "جميع الأرصدة متوازنة مع فرق بسيط بسبب التقريب!";
                
            alertsContainer.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <h5 class="alert-heading">
                        <i class="fas fa-check-circle me-2"></i>
                        ميزان المراجعة متوازن
                        ${!balanceData.isBalanced ? '(فرق تقريب)' : ''}
                    </h5>
                    <p class="mb-0">${message}</p>
                    <small>
                        إجمالي المدين: ${formatCurrency(balanceData.totalDebits)} | 
                        إجمالي الدائن: ${formatCurrency(balanceData.totalCredits)}
                        ${!balanceData.isBalanced ? ` | الفرق: ${formatCurrency(balanceData.difference)}` : ''}
                    </small>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            return;
        }

        // الفرق كبير
        alertsContainer.innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <h5 class="alert-heading">
                    <i class="fas fa-balance-scale-left me-2"></i>
                    ميزان المراجعة غير متوازن
                </h5>
                <p class="mb-0">الفرق: <strong>${formatCurrency(balanceData.difference)}</strong></p>
                <small>
                    إجمالي المدين: ${formatCurrency(balanceData.totalDebits)} | 
                    إجمالي الدائن: ${formatCurrency(balanceData.totalCredits)}
                </small>
                <div class="mt-3">
                    <button class="btn btn-sm btn-success" onclick="createRoundingAdjustment('AUTO', ${balanceData.difference})">
                        <i class="fas fa-magic me-2"></i>إنشاء قيد تسوية تلقائي
                    </button>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;

    } catch (error) {
        console.error("❌ خطأ في تحديث التوازن:", error);
    }
}
   


/**
 * إضافة إدخال إلى سجل المراجعة
 */
function addAuditLogEntry(action) {
    if (!auditFile.auditLog) {
        auditFile.auditLog = [];
    }
    auditFile.auditLog.push({
        timestamp: new Date().toISOString(),
        action: action
    });
}
      /**
         * الحصول على لون الخلفية بناءاً على نوع الملاحظة
         */
        function getBackgroundByType(type) {
            const backgrounds = {
                'success': 'rgba(40, 167, 69, 0.1)',
                'danger': 'rgba(220, 53, 69, 0.1)',
                'warning': 'rgba(255, 193, 7, 0.1)',
                'info': 'rgba(23, 162, 184, 0.1)'
            };
            return backgrounds[type] || 'rgba(108, 117, 125, 0.1)';
        }

        /**
         * موافقة ملاحظة وإخفاؤها
         */
        function approveNote(noteId) {
            const noteElement = document.querySelector(`[data-note-id="${noteId}"]`);
            if (noteElement) {
                const button = noteElement.querySelector('button:first-child');
                button.classList.remove('btn-outline-success');
                button.classList.add('btn-success');
                
                setTimeout(() => {
                    noteElement.style.transition = 'all 0.3s ease-out';
                    noteElement.style.opacity = '0';
                    noteElement.style.maxHeight = '0';
                    noteElement.style.overflow = 'hidden';
                    noteElement.style.marginBottom = '0';
                    
                    setTimeout(() => {
                        noteElement.remove();
                    }, 300);
                }, 500);
                
                showNotification(`تم اعتماد الملاحظة وإخفاؤها`, 'success');
            }
        }

        /**
         * تعديل ملاحظة واحدة
         */
        function editNote(noteId) {
            showNotification(`تعديل الملاحظة: ${noteId}`, 'info');
            // يمكن إضافة مودال للتعديل هنا
        }

        /**
         * موافقة جميع الملاحظات
         */
        function approveAllReviewNotes() {
            const buttons = document.querySelectorAll('#reviewNotesList button:first-child');
            buttons.forEach(btn => {
                btn.classList.remove('btn-outline-success');
                btn.classList.add('btn-success');
            });
            showNotification('تم اعتماد جميع الملاحظات', 'success');
            saveAuditFile();
        }

        /**
         * فتح نموذج التعديل
         */
        function editReviewNotes() {
            showNotification('فتح نموذج التعديل', 'info');
            // يمكن إضافة مودال للتعديل هنا
        }

        /**
         * إضافة حساب جديد للميزان
         */
        function addNewAccount() {
            const accountId = document.getElementById('newAccountId').value.trim();
            const accountName = document.getElementById('newAccountName').value.trim();
            const category = document.getElementById('newAccountCategory').value;
            const subCategory = document.getElementById('newAccountSubCategory').value.trim();
            const debit = parseFloat(document.getElementById('newAccountDebit').value) || 0;
            const credit = parseFloat(document.getElementById('newAccountCredit').value) || 0;

            // التحقق من البيانات
            if (!accountId || !accountName || !category) {
                showNotification('الرجاء ملء جميع الحقول المطلوبة', 'warning');
                return;
            }

            // التحقق من عدم تكرار رقم الحساب
            if (auditFile.trialBalance.find(acc => acc.account_id === accountId)) {
                showNotification(`الحساب برقم ${accountId} موجود بالفعل`, 'danger');
                return;
            }

            // إنشاء حساب جديد
            const newAccount = {
                account_id: accountId,
                name: accountName,
                category: category,
                sub_category: subCategory || null,
                ob_debit: 0,
                ob_credit: 0,
                move_debit: debit,
                move_credit: credit,
                book_balance: debit - credit,
                calculated_balance: debit - credit,
                review_status: 'pending',
                is_confirmed: false,
                workpapers: [],
                notes: []
            };

            // إضافة الحساب الجديد
            auditFile.trialBalance.push(newAccount);

            // تسجيل العملية
            addAuditLogEntry(`تم إضافة حساب جديد: ${accountId} - ${accountName}`);

            // حفظ البيانات
            saveAuditFile();

            // تحديث العرض
            processAndRender();

            // إغلاق المودال
            const modal = bootstrap.Modal.getInstance(document.getElementById('addAccountModal'));
            if (modal) modal.hide();

            // مسح النموذج
            document.getElementById('newAccountId').value = '';
            document.getElementById('newAccountName').value = '';
            document.getElementById('newAccountCategory').value = '';
            document.getElementById('newAccountSubCategory').value = '';
            document.getElementById('newAccountDebit').value = '0';
            document.getElementById('newAccountCredit').value = '0';

            showNotification(`تم إضافة الحساب ${accountId} بنجاح`, 'success');
        }

        // === بدء التطبيق عند تحميل الصفحة ===
        document.addEventListener('DOMContentLoaded', initializeApplication);
        (function(){ const params=new URLSearchParams(location.search); const cid=params.get('clientId')||localStorage.getItem('activeClientId'); if(cid){ ['top_home','top_mapping','top_cockpit','top_reports','top_vat'].forEach(id=>{ const el=document.getElementById(id); if(el){ const u=new URL(el.getAttribute('href'), location.origin); if(!u.searchParams.get('clientId')) u.searchParams.set('clientId', cid); el.setAttribute('href', u.pathname+u.search); } }); } })();
        </script>
    <script>
    (function(){
        const cid = localStorage.getItem('activeClientId');
        const withCid = (url) => cid ? `${url}?clientId=${cid}` : url;
        const setHref = (id, url) => { const el = document.getElementById(id); if (el) el.href = withCid(url); };
        setHref('nav_mapping','account-mapping.html');
        setHref('nav_cockpit','consolidation-cockpit.html');
        setHref('nav_reports','reporting-pantheon.html');
    })();
    </script>
    <script>
    (function(){
        const params = new URLSearchParams(window.location.search);
        const cid = params.get('clientId') || localStorage.getItem('activeClientId');
        // لا يوجد شريط جانبي هنا بعد الآن
    })();
    </script>
</body>
</html>