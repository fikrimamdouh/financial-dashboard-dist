<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ديوان الزكاة | Polaris 2025</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">

    <style>
        :root { 
            --font-family-main: 'Tajawal', sans-serif; 
            --font-family-display: 'Orbitron', sans-serif; 
            --color-primary: #00BFFF; 
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-warning: #ffc107;
            --color-bg: #010409; 
            --color-surface: #0d1117; 
            --color-border: rgba(56, 139, 253, 0.2 ); 
            --color-text-primary: #E6EDF3; 
            --color-text-secondary: #7D8590;
        }
        body { font-family: var(--font-family-main); direction: rtl; background-color: var(--color-bg); color: var(--color-text-primary); }
        .main-content { padding: 2rem 3rem; }
        .page-header { text-align: center; margin-bottom: 3rem; }
        .page-title { font-family: var(--font-family-display); font-size: 3rem; margin: 0; color: var(--color-primary); text-shadow: 0 0 15px rgba(0, 191, 255, 0.5); }
        .page-subtitle { font-size: 1.1rem; color: var(--color-text-secondary); margin-top: 0.5rem; }
        
        .zakat-card { background-color: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; padding: 1.5rem; height: 100%; display: flex; flex-direction: column; }
        .card-header-custom { display: flex; align-items: center; gap: 0.75rem; padding-bottom: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--color-border); }
        .card-header-custom i { font-size: 1.5rem; }
        .card-header-custom h4 { margin: 0; font-size: 1.25rem; font-weight: 700; }
        .calculation-grid { display: grid; gap: 1rem; margin-bottom: 1.5rem; }
        .grid-item { display: flex; justify-content: space-between; align-items: center; background-color: rgba(0,0,0,0.2); padding: 0.75rem; border-radius: 6px; }
        .grid-item .label { color: var(--color-text-secondary); font-size: 0.9rem; }
        .grid-item .value { font-family: var(--font-family-display); font-size: 1.2rem; font-weight: 700; }
        .grid-item.total-row .label { color: var(--color-text-primary); font-weight: bold; }
        .grid-item.total-row .value { color: var(--color-warning); }
        .final-result-box { margin-top: auto; padding: 1.25rem; border-radius: 8px; text-align: center; }
        .final-result-box .result-label { font-size: 1rem; margin-bottom: 0.5rem; }
        .final-result-box .result-value { font-family: var(--font-family-display); font-size: 2.5rem; font-weight: 700; letter-spacing: 1px; }
        .zakat-card.official .card-header-custom i, .zakat-card.official .result-value { color: var(--color-success); }
        .zakat-card.official .final-result-box { background-color: rgba(40, 167, 69, 0.1); border: 1px solid rgba(40, 167, 69, 0.3); }
        .zakat-card.estimate .card-header-custom i, .zakat-card.estimate .result-value { color: var(--color-primary); }
        .zakat-card.estimate .final-result-box { background-color: rgba(0, 191, 255, 0.1); border: 1px solid rgba(0, 191, 255, 0.3); }
        .zakat-card.calculator .card-header-custom i, .zakat-card.calculator .result-value { color: var(--color-warning); }
        .zakat-card.calculator .final-result-box { background-color: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); }
        .form-control-dark { background-color: rgba(0,0,0,0.3); border: 1px solid var(--color-border); color: var(--color-text-primary); font-family: var(--font-family-display); font-size: 1.2rem; text-align: center; }
        .form-control-dark:focus { background-color: rgba(0,0,0,0.4); border-color: var(--color-primary); box-shadow: 0 0 0 0.25rem rgba(0, 191, 255, 0.25); color: var(--color-text-primary); }

        .simulator-container { background-color: var(--color-surface); border: 1px solid var(--color-border); border-radius: 16px; padding: 2rem; margin-top: 3rem; }
        .simulator-header { text-align: center; margin-bottom: 2rem; }
        .simulator-header h2 { font-family: var(--font-family-display); color: var(--color-primary); }
        .form-section { margin-bottom: 2rem; }
        .section-title { display: flex; align-items: center; gap: 0.75rem; font-size: 1.25rem; font-weight: 700; padding-bottom: 0.75rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--color-border); }
        .section-title.additions { color: var(--color-success); }
        .section-title.deductions { color: var(--color-danger); }
        .input-group-text-custom { background-color: rgba(0,0,0,0.3); border: 1px solid var(--color-border); color: var(--color-text-secondary); min-width: 180px; font-size: 0.9rem; }
        .form-control-simulator { background-color: transparent; border: 1px solid var(--color-border); color: var(--color-text-primary); font-family: var(--font-family-display); font-weight: 700; }
        .form-control-simulator:focus { background-color: rgba(0, 191, 255, 0.05); border-color: var(--color-primary); box-shadow: none; color: var(--color-text-primary); }
        .summary-section { background-color: #010409; border-radius: 12px; padding: 1.5rem; position: sticky; top: 2rem; }
        .summary-item { display: flex; justify-content: space-between; font-size: 1.1rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px dashed var(--color-border); }
        .summary-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .summary-item .label { color: var(--color-text-secondary); }
        .summary-item .value { font-family: var(--font-family-display); font-weight: 700; }
        .summary-item .value.additions-total { color: var(--color-success); }
        .summary-item .value.deductions-total { color: var(--color-danger); }
        .summary-item .value.net-base { color: var(--color-warning); font-size: 1.5rem; }
        .final-zakat-box-sim { background: linear-gradient(135deg, rgba(0, 191, 255, 0.1), rgba(0, 191, 255, 0.2)); border: 1px solid var(--color-primary); border-radius: 8px; padding: 1.5rem; text-align: center; margin-top: 1.5rem; }
        .final-zakat-box-sim .label { font-size: 1.2rem; }
        .final-zakat-box-sim .value { font-family: var(--font-family-display); font-size: 2.8rem; font-weight: 700; color: var(--color-primary); }
        
        #placeholder { background-color: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; }

        /* ✅✅✅ كود الطباعة الجديد ✅✅✅ */
        @media print {
            body { background-color: #fff; color: #000; }
            .main-content { padding: 1rem; }
            .page-header, .zakat-card, .simulator-header button, .summary-section .btn { display: none; }
            .simulator-container { border: none; padding: 0; margin-top: 0; }
            .col-lg-7, .col-lg-5 { width: 50% !important; }
            .summary-section { position: static; }
            .input-group-text-custom { background-color: #f8f9fa; color: #000; border-color: #dee2e6; }
            .form-control-simulator { border-color: #dee2e6; -webkit-print-color-adjust: exact; }
            .section-title { color: #000 !important; }
            .summary-item .value.additions-total { color: #198754 !important; }
            .summary-item .value.deductions-total { color: #dc3545 !important; }
            .summary-item .value.net-base { color: #ffc107 !important; }
            .final-zakat-box-sim .value { color: #0dcaf0 !important; }
        }
    </style>
</head>
<body>
    <div id="globalNavbar" style="background-color: var(--color-surface); border-bottom: 1px solid var(--color-border);">
        <div class="container-fluid d-flex align-items-center justify-content-between" style="padding: 0.5rem 1rem;">
            <div class="d-flex gap-3">
                <a id="nav_home" href="index.html" class="text-decoration-none" style="color: var(--color-text-primary)"><i class="fas fa-home me-1"></i>الرئيسية</a>
                <a id="nav_mapping" href="account-mapping.html" class="text-decoration-none" style="color: var(--color-text-primary)"><i class="fas fa-tasks me-1"></i>الاستيعاب</a>
                <a id="nav_cockpit" href="consolidation-cockpit.html" class="text-decoration-none" style="color: var(--color-text-primary)"><i class="fas fa-sitemap me-1"></i>القوائم المالية</a>
                <a id="nav_reports" href="reporting-pantheon.html" class="text-decoration-none" style="color: var(--color-text-primary)"><i class="fas fa-book-open me-1"></i>التقارير</a>
                <a id="nav_zakat" href="zakat-diwan.html" class="text-decoration-none fw-bold" style="color: var(--color-primary)"><i class="fas fa-moon me-1"></i>الزكاة</a>
                <a id="nav_vat" href="vat-center.html" class="text-decoration-none" style="color: var(--color-text-primary)"><i class="fas fa-percentage me-1"></i>القيمة المضافة</a>
            </div>
            <div class="text-secondary">POLARIS</div>
        </div>
    </div>

    <main class="main-content">
        <div class="page-header">
            <div>
                <h1 class="page-title">ديوان الزكاة</h1>
                <p class="page-subtitle" id="clientNameDisplay">لوحة القيادة ومحاكي الإقرار الزكوي</p>
            </div>
        </div>

        <div id="zakatContent" style="display: none;">
            <!-- القسم الأول: لوحة القيادة (البطاقات الثلاث) -->
            <div class="row g-4">
                <!-- البطاقة الأولى: السيناريو الرسمي -->
                <div class="col-lg-4 col-md-6">
                    <div class="zakat-card official">
                        <div class="card-header-custom"><i class="fas fa-file-invoice-dollar"></i><h4>السيناريو الرسمي (موجز)</h4></div>
                        <div class="calculation-grid">
                            <div class="grid-item"><span class="label">إجمالي الإضافات للوعاء</span><span class="value" id="official-additions"></span></div>
                            <div class="grid-item"><span class="label">إجمالي الحسميات من الوعاء</span><span class="value" id="official-deductions"></span></div>
                            <div class="grid-item total-row"><span class="label">صافي الوعاء الزكوي</span><span class="value" id="official-zakat-base"></span></div>
                        </div>
                        <div class="final-result-box"><p class="result-label">الزكاة المستحقة (2.5%)</p><h3 class="result-value" id="official-zakat-due"></h3></div>
                    </div>
                </div>
                <!-- ✅✅✅ البطاقة الثانية: السيناريو التقديري (النسخة الكاملة) ✅✅✅ -->
                <div class="col-lg-4 col-md-6">
                    <div class="zakat-card estimate">
                        <div class="card-header-custom"><i class="fas fa-chart-line"></i><h4>السيناريو التقديري</h4></div>
                        <div class="calculation-grid">
                            <div class="grid-item"><span class="label">إجمالي الإيرادات</span><span class="value" id="estimate-revenue"></span></div>
                            <hr class="my-0" style="border-color: var(--color-border);">
                            <div class="grid-item"><span class="label">صافي الربح (الإيرادات ÷ 8)</span><span class="value" id="estimate-profit-part"></span></div>
                            <div class="grid-item"><span class="label">رأس المال العامل (الإيرادات × 15%)</span><span class="value" id="estimate-capital-part"></span></div>
                            <div class="grid-item total-row"><span class="label">صافي الوعاء الزكوي</span><span class="value" id="estimate-zakat-base"></span></div>
                        </div>
                        <div class="final-result-box"><p class="result-label">الزكاة المستحقة (2.5%)</p><h3 class="result-value" id="estimate-zakat-due"></h3></div>
                    </div>
                </div>
                <!-- ✅✅✅ البطاقة الثالثة: الآلة الحاسبة (النسخة الكاملة) ✅✅✅ -->
                <div class="col-lg-4 col-md-12">
                    <div class="zakat-card calculator">
                        <div class="card-header-custom"><i class="fas fa-calculator"></i><h4>حاسبة تقديرية سريعة</h4></div>
                        <div class="calculation-grid">
                            <div class="mb-2"><label for="manualRevenueInput" class="form-label small">أدخل إجمالي المبيعات:</label><input type="number" class="form-control form-control-dark" id="manualRevenueInput" placeholder="0.00"></div>
                            <hr class="my-0" style="border-color: var(--color-border);">
                            <div class="grid-item"><span class="label">صافي الربح (المدخلات ÷ 8)</span><span class="value" id="manual-profit-part"></span></div>
                            <div class="grid-item"><span class="label">رأس المال العامل (المدخلات × 15%)</span><span class="value" id="manual-capital-part"></span></div>
                            <div class="grid-item total-row"><span class="label">صافي الوعاء الزكوي</span><span class="value" id="manual-zakat-base"></span></div>
                        </div>
                        <div class="final-result-box"><p class="result-label">الزكاة المستحقة التقديرية</p><h3 class="result-value" id="manual-zakat-due">0.00</h3></div>
                    </div>
                </div>
            </div>

            <!-- القسم الثاني: محاكي الإقرار الزكوي التفصيلي -->
            <div class="simulator-container" id="print-section">
                <div class="simulator-header">
                    <h2>محاكي الإقرار الزكوي (الطريقة الرسمية)</h2>
                    <p class="text-secondary">أدخل أرقام قائمة المركز المالي لحساب الوعاء الزكوي والزكاة المستحقة بدقة</p>
                </div>
                <div class="row g-5">
                    <div class="col-lg-7">
                        <button class="btn btn-outline-primary w-100 mb-4" id="autoFillButton"><i class="fas fa-magic me-2"></i>تعبئة تلقائية من بيانات العميل الحالية</button>
                        <div class="form-section">
                            <h3 class="section-title additions"><i class="fas fa-plus-circle"></i>الإضافات للوعاء (مصادر التمويل)</h3>
                            <div class="d-flex flex-column gap-3">
                                <div class="input-group"><span class="input-group-text input-group-text-custom">حقوق الملكية</span><input type="number" id="equity" class="form-control form-control-simulator zakat-input" placeholder="0.00"></div>
                                <div class="input-group"><span class="input-group-text input-group-text-custom">صافي الربح المعدل</span><input type="number" id="netProfit" class="form-control form-control-simulator zakat-input" placeholder="0.00"></div>
                                <div class="input-group"><span class="input-group-text input-group-text-custom">الديون طويلة الأجل</span><input type="number" id="longTermDebt" class="form-control form-control-simulator zakat-input" placeholder="0.00"></div>
                                <div class="input-group"><span class="input-group-text input-group-text-custom">المخصصات</span><input type="number" id="provisions" class="form-control form-control-simulator zakat-input" placeholder="0.00"></div>
                                <div class="input-group"><span class="input-group-text input-group-text-custom">إضافات أخرى</span><input type="number" id="otherAdditions" class="form-control form-control-simulator zakat-input" placeholder="0.00"></div>
                            </div>
                        </div>
                        <div class="form-section">
                            <h3 class="section-title deductions"><i class="fas fa-minus-circle"></i>الحسميات من الوعاء (الأصول غير الزكوية)</h3>
                            <div class="d-flex flex-column gap-3">
                                <div class="input-group"><span class="input-group-text input-group-text-custom">صافي الأصول الثابتة</span><input type="number" id="fixedAssets" class="form-control form-control-simulator zakat-input" placeholder="0.00"></div>
                                <div class="input-group"><span class="input-group-text input-group-text-custom">الاستثمارات طويلة الأجل</span><input type="number" id="longTermInvestments" class="form-control form-control-simulator zakat-input" placeholder="0.00"></div>
                                <div class="input-group"><span class="input-group-text input-group-text-custom">الأصول غير الملموسة</span><input type="number" id="intangibleAssets" class="form-control form-control-simulator zakat-input" placeholder="0.00"></div>
                                <div class="input-group"><span class="input-group-text input-group-text-custom">حسميات أخرى</span><input type="number" id="otherDeductions" class="form-control form-control-simulator zakat-input" placeholder="0.00"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="summary-section">
                            <h3 class="section-title" style="color: var(--color-text-primary);"><i class="fas fa-receipt"></i>ملخص الحساب</h3>
                            <div class="summary-item"><span class="label">إجمالي الإضافات</span><span class="value additions-total" id="totalAdditions">0.00</span></div>
                            <div class="summary-item"><span class="label">إجمالي الحسميات</span><span class="value deductions-total" id="totalDeductions">0.00</span></div>
                            <div class="summary-item"><span class="label">صافي الوعاء الزكوي</span><span class="value net-base" id="netZakatBase">0.00</span></div>
                            <div class="final-zakat-box-sim"><p class="label">الزكاة المستحقة (2.5%)</p><p class="value" id="finalZakatDue">0.00</p></div>
                            <!-- ✅✅✅ زر الطباعة الجديد ✅✅✅ -->
                            <button class="btn btn-info w-100 mt-3" onclick="window.print()"><i class="fas fa-print me-2"></i>طباعة ملخص الإقرار</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="placeholder" class="text-center p-5" style="display: none;"></div>
    </main>

    <script>
        let clientFinancialData = {};

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const clientId = urlParams.get('clientId') || localStorage.getItem('activeClientId');
            if (!clientId) { showPlaceholder('العميل غير محدد', 'يرجى العودة إلى الاستيعاب لاعتماد البيانات أو اختيار عميل.'); return; }
            const auditFileKey = `polarisAuditFile_${clientId}`; const auditDataJSON = localStorage.getItem(auditFileKey);
            if (!auditDataJSON) { showPlaceholder('بيانات المراجعة غير موجودة', 'لم يتم العثور على ملف المراجعة المعتمد لهذا العميل.'); return; }
            try {
                const auditData = JSON.parse(auditDataJSON);
                if (!auditData.trialBalance || auditData.trialBalance.length === 0) { showPlaceholder('بيانات فارغة', 'ملف المراجعة موجود ولكنه لا يحتوي على بيانات.'); return; }
                document.getElementById('zakatContent').style.display = 'block'; document.getElementById('placeholder').style.display = 'none';
                if (auditData.clientInfo && auditData.clientInfo.name) { document.getElementById('clientNameDisplay').textContent = `ديوان الزكاة لـ: ${auditData.clientInfo.name}`; }
                clientFinancialData = processFinancialData(auditData);
                populateDashboard();
                setupEventListeners();
                calculateZakatFromSimulator();
            } catch (error) { showPlaceholder('خطأ في البيانات', 'حدث خطأ أثناء قراءة بيانات المراجعة.'); console.error("Error parsing audit data:", error); }
        });

        // بناء الروابط مع clientId إن وجد
        (function(){
            const params = new URLSearchParams(window.location.search);
            const cid = params.get('clientId') || localStorage.getItem('activeClientId');
            const withCid = (url) => cid ? `${url}?clientId=${cid}` : url;
            const setHref = (id, url) => { const el = document.getElementById(id); if (el) el.href = withCid(url); };
            setHref('nav_mapping','account-mapping.html');
            setHref('nav_cockpit','consolidation-cockpit.html');
            setHref('nav_reports','reporting-pantheon.html');
            setHref('nav_zakat','zakat-diwan.html');
            setHref('nav_vat','vat-center.html');
        })();

        // ✅✅✅ START: الكود المحدث لملء لوحة القيادة الكاملة ✅✅✅
        function populateDashboard() {
            // السيناريو الرسمي (كامل)
            const totalAdditions = clientFinancialData.equity + clientFinancialData.netProfit + clientFinancialData.longTermDebt + clientFinancialData.provisions;
            const totalDeductions = clientFinancialData.fixedAssets + clientFinancialData.longTermInvestments + clientFinancialData.intangibleAssets;
            const zakatBaseOfficial = totalAdditions - totalDeductions;
            const zakatDueOfficial = zakatBaseOfficial > 0 ? zakatBaseOfficial * 0.025 : 0;
            document.getElementById('official-additions').textContent = formatCurrency(totalAdditions);
            document.getElementById('official-deductions').textContent = formatCurrency(totalDeductions);
            document.getElementById('official-zakat-base').textContent = formatCurrency(zakatBaseOfficial);
            document.getElementById('official-zakat-due').textContent = formatCurrency(zakatDueOfficial);

            // السيناريو التقديري (كامل)
            const revenue = clientFinancialData.revenue;
            const profitPart = revenue / 8;
            const capitalPart = revenue * 0.15;
            const zakatBaseEstimate = profitPart + capitalPart;
            const zakatDueEstimate = zakatBaseEstimate > 0 ? zakatBaseEstimate * 0.025 : 0;
            document.getElementById('estimate-revenue').textContent = formatCurrency(revenue); // إضافة الإيرادات
            document.getElementById('estimate-profit-part').textContent = formatCurrency(profitPart);
            document.getElementById('estimate-capital-part').textContent = formatCurrency(capitalPart);
            document.getElementById('estimate-zakat-base').textContent = formatCurrency(zakatBaseEstimate);
            document.getElementById('estimate-zakat-due').textContent = formatCurrency(zakatDueEstimate);
        }
        // ✅✅✅ END: الكود المحدث لملء لوحة القيادة الكاملة ✅✅✅

        function setupEventListeners() {
            document.querySelectorAll('.zakat-input').forEach(input => { input.addEventListener('input', calculateZakatFromSimulator); });
            document.getElementById('autoFillButton').addEventListener('click', autoFillForm);
            document.getElementById('manualRevenueInput').addEventListener('input', calculateManualZakat);
        }

        // ✅✅✅ START: الكود المحدث للحاسبة السريعة الكاملة ✅✅✅
        function calculateManualZakat() {
            const revenue = parseFloat(document.getElementById('manualRevenueInput').value) || 0;
            const profitPart = revenue / 8;
            const capitalPart = revenue * 0.15;
            const zakatBase = profitPart + capitalPart;
            const zakatDue = zakatBase * 0.025;
            document.getElementById('manual-profit-part').textContent = formatCurrency(profitPart);
            document.getElementById('manual-capital-part').textContent = formatCurrency(capitalPart);
            document.getElementById('manual-zakat-base').textContent = formatCurrency(zakatBase);
            document.getElementById('manual-zakat-due').textContent = formatCurrency(zakatDue);
        }
        // ✅✅✅ END: الكود المحدث للحاسبة السريعة الكاملة ✅✅✅

        function autoFillForm() { /* ... الكود هنا لا يتغير ... */
            document.getElementById('equity').value = clientFinancialData.equity.toFixed(2);
            document.getElementById('netProfit').value = clientFinancialData.netProfit.toFixed(2);
            document.getElementById('longTermDebt').value = clientFinancialData.longTermDebt.toFixed(2);
            document.getElementById('provisions').value = clientFinancialData.provisions.toFixed(2);
            document.getElementById('fixedAssets').value = clientFinancialData.fixedAssets.toFixed(2);
            document.getElementById('longTermInvestments').value = clientFinancialData.longTermInvestments.toFixed(2);
            document.getElementById('intangibleAssets').value = clientFinancialData.intangibleAssets.toFixed(2);
            calculateZakatFromSimulator();
        }
        function calculateZakatFromSimulator() { /* ... الكود هنا لا يتغير ... */
            const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;
            const totalAdditions = getVal('equity') + getVal('netProfit') + getVal('longTermDebt') + getVal('provisions') + getVal('otherAdditions');
            const totalDeductions = getVal('fixedAssets') + getVal('longTermInvestments') + getVal('intangibleAssets') + getVal('otherDeductions');
            const netZakatBase = totalAdditions - totalDeductions;
            const finalZakatDue = netZakatBase > 0 ? netZakatBase * 0.025 : 0;
            document.getElementById('totalAdditions').textContent = formatCurrency(totalAdditions);
            document.getElementById('totalDeductions').textContent = formatCurrency(totalDeductions);
            document.getElementById('netZakatBase').textContent = formatCurrency(netZakatBase);
            document.getElementById('finalZakatDue').textContent = formatCurrency(finalZakatDue);
        }
        function processFinancialData(auditData) { /* ... الكود هنا لا يتغير ... */
            const finalTB = buildFinalTrialBalance(auditData.trialBalance, auditData.adjustments);
            const data = { equity: 0, netProfit: 0, longTermDebt: 0, provisions: 0, fixedAssets: 0, longTermInvestments: 0, intangibleAssets: 0, revenue: 0, expenses: 0 };
            finalTB.forEach(acc => {
                const cat = acc.category || ''; const sub = acc.sub_category || ''; const bal = acc.finalBalance;
                if (cat === 'revenue') data.revenue -= bal;
                if (cat === 'expenses') data.expenses += bal;
                if (cat === 'equity') data.equity -= bal;
                if (sub.startsWith('22')) data.longTermDebt -= bal;
                if (sub === '222001' || sub === '113099' || sub === '116099') data.provisions -= bal;
                if (sub.startsWith('121')) data.fixedAssets += bal;
                if (sub.startsWith('122')) data.longTermInvestments += bal;
                if (sub.startsWith('123')) data.intangibleAssets += bal;
            });
            data.netProfit = data.revenue - data.expenses;
            data.equity -= data.netProfit;
            return data;
        }
        function buildFinalTrialBalance(trialBalance, adjustments = []) { /* ... الكود هنا لا يتغير ... */ return trialBalance.map(acc => { const bookBalance = (parseFloat(acc.ob_debit) || 0) - (parseFloat(acc.ob_credit) || 0) + (parseFloat(acc.move_debit) || 0) - (parseFloat(acc.move_credit) || 0); const adjAmount = (adjustments || []).reduce((sum, adj) => { if (String(adj.debit_account) === String(acc.account_id)) return sum + (parseFloat(adj.amount) || 0); if (String(adj.credit_account) === String(acc.account_id)) return sum - (parseFloat(adj.amount) || 0); return sum; }, 0); return { ...acc, finalBalance: bookBalance + adjAmount }; }); }
        function showPlaceholder(title, message) { const placeholder = document.getElementById('placeholder'); placeholder.innerHTML = `<div class="p-5"><i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i><h4>${title}</h4><p class="text-secondary">${message}</p><a href="account-mapping.html" class="btn btn-primary mt-3">العودة لصفحة المراجعة</a></div>`; placeholder.style.display = 'block'; document.getElementById('zakatContent').style.display = 'none'; }
        function formatCurrency(value) { if (value === null || value === undefined || isNaN(value)) return '0.00'; return new Intl.NumberFormat('ar-SA', { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value); }
    </script>
</body>
</html>
