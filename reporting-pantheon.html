<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ديوان الحكمة المالية - Polaris 2025</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
<script src="dataPipeline.js"></script>
<!-- للتصدير PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- للتصدير Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Tajawal:wght@400;500;700&display=swap');
        :root { 
            --font-family-main: 'Tajawal', sans-serif; 
            --font-family-display: 'Orbitron', sans-serif; 
            --color-primary-glow: #00BFFF; 
            --color-bg: #010409; 
            --color-surface: rgba(13, 17, 23, 0.8); 
            --color-border: rgba(56, 139, 253, 0.3); 
            --color-text-primary: #E6EDF3; 
            --color-text-secondary: #7D8590; 
            --color-finance: #007bff;
            --color-management: #28a745;
            --color-strategy: #ffc107;
            --color-risk: #dc3545;
            --color-investment: #6f42c1;
        }
        body { 
            font-family: var(--font-family-main); 
            direction: rtl; 
            background-color: var(--color-bg); 
            color: var(--color-text-primary); 
            display: flex; 
            margin: 0;
            overflow-x: hidden;
        }
        .grid-background { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-image: linear-gradient(to right, rgba(56, 139, 253, 0.1) 1px, transparent 1px), 
                            linear-gradient(to bottom, rgba(56, 139, 253, 0.1) 1px, transparent 1px); 
            background-size: 40px 40px; 
            z-index: -2; 
        }
        .glow-background { 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            width: 800px; 
            height: 800px; 
            background: radial-gradient(circle, rgba(0, 191, 255, 0.1), transparent 60%); 
            transform: translate(-50%, -50%); 
            animation: pulse 10s infinite ease-in-out; 
            z-index: -1; 
        }
        @keyframes pulse { 
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; } 
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.8; } 
        }
        .sidebar { 
            width: 80px; 
            height: 100vh; 
            background-color: var(--color-surface); 
            border-left: 1px solid var(--color-border); 
            backdrop-filter: blur(10px); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 1.5rem 0; 
            flex-shrink: 0; 
            position: sticky; 
            top: 0; 
        }
        .app-logo { 
            color: var(--color-primary-glow); 
            font-size: 2rem; 
            margin-bottom: 2.5rem; 
            text-decoration: none;
            transition: all 0.3s ease;
        }
        .app-logo:hover {
            transform: rotate(180deg);
            color: #fff;
        }
.sidebar-icon {
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-secondary);
    font-size: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
    text-decoration: none;
    position: relative;
}

.sidebar-icon:hover {
    background-color: rgba(0, 191, 255, 0.1);
    color: var(--color-primary-glow);
    transform: scale(1.1);
}

.sidebar-icon::after {
    content: attr(title);
    position: absolute;
    right: 60px;
    background-color: var(--color-surface);
    color: var(--color-text-primary);
    padding: 0.5rem 1rem;
    border-radius: 6px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    border: 1px solid var(--color-border);
}

.sidebar-icon:hover::after {
    opacity: 1;
}

        .main-content { 
            flex-grow: 1; 
            padding: 2rem 3rem; 
            overflow-y: auto; 
            height: 100vh; 
        }
        .page-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 2rem; 
        }
        .page-title { 
            font-family: var(--font-family-display); 
            font-size: 2.5rem; 
            margin: 0;
            background: linear-gradient(135deg, var(--color-primary-glow), #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .pantheon-wing { 
            background-color: var(--color-surface); 
            border: 1px solid var(--color-border); 
            border-radius: 12px; 
            padding: 1.5rem; 
            margin-bottom: 2rem; 
            backdrop-filter: blur(5px); 
            transition: all 0.3s ease;
        }
        .pantheon-wing:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 191, 255, 0.2);
        }
        .wing-header { 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            margin-bottom: 1.5rem; 
            padding-bottom: 1rem; 
            border-bottom: 1px solid var(--color-border); 
        }
        .wing-icon { 
            font-size: 2rem; 
            text-shadow: 0 0 10px currentColor; 
        }
        .wing-title { 
            font-family: var(--font-family-display); 
            font-size: 1.5rem; 
            margin: 0; 
        }
        .wing-subtitle { 
            color: var(--color-text-secondary); 
            margin: 0; 
            font-size: 0.9rem;
        }
        .wing-badge {
            background-color: rgba(0, 191, 255, 0.2);
            color: var(--color-primary-glow);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            margin-right: auto;
        }
        .report-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 1rem; 
        }
        .report-card { 
            background-color: rgba(0,0,0,0.2); 
            border: 1px solid transparent; 
            padding: 1rem; 
            border-radius: 8px; 
            transition: all 0.3s ease; 
            cursor: pointer; 
            position: relative;
        }
        .report-card:hover { 
            transform: translateY(-5px); 
            border-color: var(--color-primary-glow); 
            background-color: rgba(0, 191, 255, 0.05); 
            box-shadow: 0 5px 15px rgba(0, 191, 255, 0.3);
        }
        .report-card h6 { 
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .report-card p { 
            font-size: 0.85rem; 
            color: var(--color-text-secondary); 
            margin-bottom: 0; 
        }
        .report-status {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status-ready { 
            background-color: rgba(40, 167, 69, 0.3); 
            color: #28a745; 
            border: 1px solid #28a745;
        }
        .status-dev { 
            background-color: rgba(255, 193, 7, 0.3); 
            color: #ffc107; 
            border: 1px solid #ffc107;
        }
        
        /* Modal Styles */
        .modal-content { 
            background-color: var(--color-surface); 
            border: 1px solid var(--color-border); 
            color: var(--color-text-primary); 
            backdrop-filter: blur(15px); 
            border-radius: 12px; 
        }
        .modal-header, .modal-footer { 
            border-color: var(--color-border); 
        }
        .modal-header {
            background: linear-gradient(135deg, rgba(0, 191, 255, 0.1), transparent);
        }
        .modal-title {
            font-family: var(--font-family-display);
            color: var(--color-primary-glow);
        }
        .btn-close { 
            filter: invert(1) grayscale(100%) brightness(200%); 
        }
        .btn-primary {
            background-color: var(--color-primary-glow);
            border-color: var(--color-primary-glow);
            color: #000;
            font-weight: bold;
        }
        .btn-primary:hover {
            background-color: #0099cc;
            border-color: #0099cc;
            transform: scale(1.05);
        }
        
        /* Stats Cards */
        .stats-card {
            background: linear-gradient(135deg, rgba(0, 191, 255, 0.1), rgba(0, 191, 255, 0.05));
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 191, 255, 0.2);
        }
        .stats-card h3 {
            font-family: var(--font-family-display);
            font-size: 2rem;
            margin: 0;
            color: var(--color-primary-glow);
        }
        .stats-card p {
            margin: 0;
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }
        
        /* Search Box */
        .search-box {
            position: relative;
            margin-bottom: 2rem;
        }
        .search-box input {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            padding: 0.75rem 1rem 0.75rem 3rem;
            border-radius: 8px;
            width: 100%;
            transition: all 0.3s ease;
        }
        .search-box input:focus {
            outline: none;
            border-color: var(--color-primary-glow);
            box-shadow: 0 0 10px rgba(0, 191, 255, 0.3);
        }
        .search-box i {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-secondary);
        }
        
        /* Filter Buttons */
        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        .filter-btn {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        .filter-btn:hover, .filter-btn.active {
            background-color: var(--color-primary-glow);
            color: #000;
            border-color: var(--color-primary-glow);
            transform: scale(1.05);
        }
        
        /* Table Styles */
        .table {
            color: var(--color-text-primary);
        }
        .table-dark {
            background-color: rgba(0, 0, 0, 0.3);
        }
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0, 191, 255, 0.05);
        }
        .table-hover tbody tr:hover {
            background-color: rgba(0, 191, 255, 0.1);
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 2rem 0;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 191, 255, 0.3);
            border-top-color: var(--color-primary-glow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Alert Styles */
        .alert {
            border-radius: 8px;
            border: 1px solid;
        }
        .alert-info {
            background-color: rgba(0, 191, 255, 0.1);
            border-color: var(--color-primary-glow);
            color: var(--color-text-primary);
        }
        .alert-success {
            background-color: rgba(40, 167, 69, 0.1);
            border-color: #28a745;
            color: var(--color-text-primary);
        }
        .alert-warning {
            background-color: rgba(255, 193, 7, 0.1);
            border-color: #ffc107;
            color: var(--color-text-primary);
        }
        .alert-danger {
            background-color: rgba(220, 53, 69, 0.1);
            border-color: #dc3545;
            color: var(--color-text-primary);
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: var(--color-bg);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-primary-glow);
        }
    </style>
</head>
<body>

    <div class="grid-background"></div>
    <div class="glow-background"></div>

<!-- Sidebar -->
<div class="sidebar">
    <!-- Logo -->
    <a href="index.html" class="app-logo" title="ديوان الحكمة المالية">
        <i class="fas fa-crown"></i>
    </a>
    
    <!-- Navigation Icons -->
    <a href="index.html" class="sidebar-icon" title="الصفحة الرئيسية">
        <i class="fas fa-home"></i>
    </a>
    
    <a href="account-mapping.html" class="sidebar-icon" title="ميزان المراجعة" onclick="goToAccountMapping(); return false;">
        <i class="fas fa-balance-scale"></i>
    </a>
    
    <a href="consolidation-cockpit.html" class="sidebar-icon" title="القوائم المالية" onclick="goToFinancialStatements(); return false;">
        <i class="fas fa-file-invoice"></i>
    </a>
    
    <a href="#" class="sidebar-icon" title="التقارير" onclick="window.location.reload(); return false;">
        <i class="fas fa-chart-bar"></i>
    </a>
    
    <!-- Spacer -->
    <div style="flex-grow: 1;"></div>
    
    <!-- Bottom Icons -->
    <a href="#" class="sidebar-icon" title="مساعدة" onclick="alert('للمساعدة: info@polaris.com'); return false;">
        <i class="fas fa-question-circle"></i>
    </a>
</div>    <main class="main-content">
        <div class="page-header">
            <div>
                <h1 class="page-title">ديوان الحكمة المالية</h1>
                <p class="text-secondary">35 تقريرًا استراتيجيًا موزعة على 5 أجنحة - نسخة 2025</p>
            </div>
            <button class="btn btn-primary" onclick="exportAllReports()">
                <i class="fas fa-file-pdf"></i> تصدير Board Pack
            </button>
        </div>

        <!-- Statistics Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <h3>35</h3>
                    <p>إجمالي التقارير</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3>5</h3>
                    <p>الأجنحة الرئيسية</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3>100%</h3>
                    <p>جاهزة للعمل</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3>IFRS</h3>
                    <p>متوافق مع المعايير</p>
                </div>
            </div>
        </div>

        <!-- Search Box -->
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="ابحث عن تقرير معين..." onkeyup="searchReports()">
        </div>
<!-- Budget Section -->
<div class="pantheon-wing" data-wing="finance">
    <div class="wing-header">
        <i class="wing-icon fas fa-calculator" style="color: var(--color-finance);"></i>
        <div>
            <h3 class="wing-title">قسم الموازنة (Budget)</h3>
            <p class="wing-subtitle">إعداد ومتابعة الموازنات التقديرية</p>
        </div>
        <span class="wing-badge">4 تقارير</span>
    </div>
    <div class="report-grid">
        <div class="report-card" onclick="openReport('budget-preparation', 'إعداد الموازنة السنوية')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-chart-bar"></i> إعداد الموازنة السنوية</h6>
            <p>إدخال الموازنة التقديرية للإيرادات والمصروفات</p>
        </div>
        <div class="report-card" onclick="openReport('budget-comparison', 'مقارنة الموازنة بالفعلي')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-balance-scale"></i> مقارنة الموازنة بالفعلي</h6>
            <p>تحليل الانحرافات وتفسير الفروقات</p>
        </div>
        <div class="report-card" onclick="openReport('budget-update', 'تحديث الموازنة')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-sync-alt"></i> تحديث الموازنة</h6>
            <p>تعديل الموازنة بناءً على المستجدات</p>
        </div>
        <div class="report-card" onclick="openReport('budget-analysis', 'تحليل الموازنة')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-chart-pie"></i> تحليل الموازنة</h6>
            <p>رسوم بيانية ومؤشرات الأداء</p>
        </div>
    </div>
</div>

<!-- Forecasting Section -->
<div class="pantheon-wing" data-wing="finance">
    <div class="wing-header">
        <i class="wing-icon fas fa-crystal-ball" style="color: var(--color-strategy);"></i>
        <div>
            <h3 class="wing-title">قسم التنبؤات المالية</h3>
            <p class="wing-subtitle">التوقعات والسيناريوهات المستقبلية</p>
        </div>
        <span class="wing-badge">4 تقارير</span>
    </div>
    <div class="report-grid">
        <div class="report-card" onclick="openReport('revenue-forecast', 'تنبؤ الإيرادات')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-chart-line"></i> تنبؤ الإيرادات</h6>
            <p>توقعات الإيرادات للـ 12 شهر القادمة</p>
        </div>
        <div class="report-card" onclick="openReport('cashflow-forecast', 'تنبؤ التدفقات النقدية')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-money-bill-wave"></i> تنبؤ التدفقات النقدية</h6>
            <p>توقعات السيولة والاحتياجات النقدية</p>
        </div>
        <div class="report-card" onclick="openReport('multiple-scenarios', 'سيناريوهات متعددة')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-sitemap"></i> سيناريوهات متعددة</h6>
            <p>سيناريو متفائل، واقعي، متشائم</p>
        </div>
        <div class="report-card" onclick="openReport('ai-forecast', 'تنبؤ ذكي AI')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-robot"></i> تنبؤ ذكي AI</h6>
            <p>استخدام الذكاء الاصطناعي للتنبؤ</p>
        </div>
    </div>
</div>
        <!-- Filter Buttons -->
        <div class="filter-buttons">
            <button class="filter-btn active" onclick="filterWing('all')">الكل</button>
            <button class="filter-btn" onclick="filterWing('finance')">ديوان المالية</button>
            <button class="filter-btn" onclick="filterWing('management')">ديوان الإدارة</button>
            <button class="filter-btn" onclick="filterWing('strategy')">ديوان الاستراتيجية</button>
            <button class="filter-btn" onclick="filterWing('risk')">ديوان المخاطر</button>
            <button class="filter-btn" onclick="filterWing('investment')">ديوان الاستثمار</button>
        </div>

        <!-- Wing 1: Finance (8 Reports) -->
        <div class="pantheon-wing" data-wing="finance">
            <div class="wing-header">
                <i class="wing-icon fas fa-coins" style="color: var(--color-finance);"></i>
                <div>
                    <h3 class="wing-title">ديوان المالية</h3>
                    <p class="wing-subtitle">التقارير المالية الأساسية والالتزامات القانونية</p>
                </div>
                <span class="wing-badge">8 تقارير</span>
            </div>
            <div class="report-grid">
                <div class="report-card" onclick="openReport('yearend-checklist', 'إغلاق نهاية العام')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-tasks"></i> إغلاق نهاية العام</h6>
                    <p>إعداد ملفات ZATCA، XML، Qawaem، زكاة</p>
                </div>
                <div class="report-card" onclick="openReport('sovereign-fs', 'قوائم مالية + 13 إيضاح')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-file-invoice"></i> قوائم مالية + 13 إيضاح</h6>
                    <p>قائمة الدخل، المركز المالي، التدفقات، التغيرات في حقوق الملكية</p>
                </div>
                <div class="report-card" onclick="openReport('sovereign-audit', 'تقرير المراجعة')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-stamp"></i> تقرير المراجعة</h6>
                    <p>رأي المراجع، ملاحظات، مطابقة IFRS</p>
                </div>
                <div class="report-card" onclick="openReport('budget-variance', 'Budget vs Actual')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-chart-line"></i> Budget vs Actual</h6>
                    <p>مقارنة الإيرادات والمصروفات بالموازنة (رسم بياني)</p>
                </div>
                <div class="report-card" onclick="openReport('profit-forecast', 'تنبؤ ربح 12 شهر')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-crystal-ball"></i> تنبؤ ربح 12 شهر</h6>
                    <p>توقعات شهرية (Base, High, Low) – خط بياني</p>
                </div>
                <div class="report-card" onclick="openReport('cash-forecast', 'تدفق نقدي Sankey')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-water"></i> تدفق نقدي (Sankey)</h6>
                    <p>تدفقات نقدية من/إلى الأنشطة (مخطط Sankey)</p>
                </div>
                <div class="report-card" onclick="openReport('loan-capacity', 'سعة القروض DSCR')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-hand-holding-usd"></i> سعة القروض (DSCR)</h6>
                    <p>نسبة تغطية الدين، الحد الأقصى للقروض</p>
                </div>
                <div class="report-card" onclick="openReport('money-flow', 'مصادر واستخدامات')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-exchange-alt"></i> مصادر واستخدامات</h6>
                    <p>مصادر الأموال، استخداماتها (رسوم دائرية)</p>
                </div>
            </div>
        </div>

        <!-- Wing 2: Management (4 Reports) -->
        <div class="pantheon-wing" data-wing="management">
            <div class="wing-header">
                <i class="wing-icon fas fa-chart-pie" style="color: var(--color-management);"></i>
                <div>
                    <h3 class="wing-title">ديوان الإدارة</h3>
                    <p class="wing-subtitle">مؤشرات الأداء والتحليلات التشغيلية</p>
                </div>
                <span class="wing-badge">4 تقارير</span>
            </div>
            <div class="report-grid">
                <div class="report-card" onclick="openReport('kpi-dashboard', 'KPIs Dashboard')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-tachometer-alt"></i> KPIs Dashboard</h6>
                    <p>هامش الربح، DSCR، ROE، CCC</p>
                </div>
                <div class="report-card" onclick="openReport('profitability-dim', 'ربحية حسب البعد')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-cube"></i> ربحية حسب البعد</h6>
                    <p>حسب المنتج، العميل، القسم، المنطقة</p>
                </div>
                <div class="report-card" onclick="openReport('working-capital', 'رأس المال العامل')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-cogs"></i> رأس المال العامل</h6>
                    <p>CCC، النسبة الحالية، السيولة</p>
                </div>
                <div class="report-card" onclick="openReport('abc-costing', 'تحليل التكاليف ABC')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-layer-group"></i> تحليل التكاليف (ABC)</h6>
                    <p>توزيع التكاليف حسب الأنشطة</p>
                </div>
            </div>
        </div>

        <!-- Wing 3: Strategy (8 Reports) -->
        <div class="pantheon-wing" data-wing="strategy">
            <div class="wing-header">
                <i class="wing-icon fas fa-lightbulb" style="color: var(--color-strategy);"></i>
                <div>
                    <h3 class="wing-title">ديوان الاستراتيجية</h3>
                    <p class="wing-subtitle">التقييم والتخطيط الاستراتيجي طويل المدى</p>
                </div>
                <span class="wing-badge">8 تقارير</span>
            </div>
            <div class="report-grid">
                <div class="report-card" onclick="openReport('breakeven-analysis', 'نقطة التعادل')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-balance-scale"></i> نقطة التعادل</h6>
                    <p>BEP بالوحدات والريال، هامش الأمان</p>
                </div>
                <div class="report-card" onclick="openReport('whatif-scenarios', 'تحليل ماذا لو')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-question-circle"></i> تحليل ماذا لو</h6>
                    <p>سيناريوهات تفاعلية (إيرادات، تكاليف)</p>
                </div>
                <div class="report-card" onclick="openReport('integrated-report', 'التقرير المتكامل')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-project-diagram"></i> التقرير المتكامل</h6>
                    <p>6 رؤوس رأسمالية (مالي، صناعي، فكري، بشري، اجتماعي، طبيعي)</p>
                </div>
                <div class="report-card" onclick="openReport('dcf-valuation', 'DCF Valuation')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-calculator"></i> DCF Valuation</h6>
                    <p>تقييم الشركة بـ DCF (FCFF + WACC)</p>
                </div>
                <div class="report-card" onclick="openReport('rim-valuation', 'Residual Income (RIM)')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-money-bill-wave"></i> Residual Income (RIM)</h6>
                    <p>القيمة الدفترية + الأرباح المتبقية</p>
                </div>
                <div class="report-card" onclick="openReport('ddm-valuation', 'Dividend Discount (DDM)')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-percentage"></i> Dividend Discount (DDM)</h6>
                    <p>تقييم بناءً على توزيعات الأرباح</p>
                </div>
                <div class="report-card" onclick="openReport('dupont-analysis', 'تحليل دوبونت')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-sitemap"></i> تحليل دوبونت</h6>
                    <p>تفكيك ROE: هامش × دوران × رافعة</p>
                </div>
                <div class="report-card" onclick="openReport('eva-analysis', 'EVA (القيمة الاقتصادية المضافة)')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-chart-area"></i> EVA</h6>
                    <p>NOPAT – (WACC × رأس المال)</p>
                </div>
            </div>
        </div>

        <!-- Wing 4: Risk (8 Reports) -->
        <div class="pantheon-wing" data-wing="risk">
            <div class="wing-header">
                <i class="wing-icon fas fa-exclamation-triangle" style="color: var(--color-risk);"></i>
                <div>
                    <h3 class="wing-title">ديوان المخاطر</h3>
                    <p class="wing-subtitle">نماذج التنبؤ بالإفلاس وإدارة المخاطر</p>
                </div>
                <span class="wing-badge">8 تقارير</span>
            </div>
            <div class="report-grid">
                <div class="report-card" onclick="openReport('altman-zscore', 'نموذج ألتمان Z-Score')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-shield-alt"></i> نموذج ألتمان (Z-Score)</h6>
                    <p>تنبؤ الإفلاس (آمن / رمادي / خطر)</p>
                </div>
                <div class="report-card" onclick="openReport('ohlson-oscore', 'نموذج أوهلسون O-Score')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-chart-line"></i> نموذج أوهلسون (O-Score)</h6>
                    <p>احتمالية الإفلاس (%) – Logistic</p>
                </div>
                <div class="report-card" onclick="openReport('zmijewski-xscore', 'نموذج زيميخوسكي X-Score')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-wave-square"></i> نموذج زيميخوسكي (X-Score)</h6>
                    <p>Probit – قوي في الأسواق المضطربة</p>
                </div>
                <div class="report-card" onclick="openReport('sherrod-model', 'نموذج شيرود')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-water"></i> نموذج شيرود (Cash Flow)</h6>
                    <p>التركيز على التدفق النقدي</p>
                </div>
                <div class="report-card" onclick="openReport('fulmer-hscore', 'نموذج فولمر H-Score')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-h-square"></i> نموذج فولمر (H-Score)</h6>
                    <p>9 نسب – أكثر دقة في بعض الحالات</p>
                </div>
                <div class="report-card" onclick="openReport('springate-sscore', 'نموذج سبرينجيت S-Score')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-s"></i> نموذج سبرينجيت (S-Score)</h6>
                    <p>4 نسب فقط – بسيط وفعّال</p>
                </div>
                <div class="report-card" onclick="openReport('ca-score-ai', 'CA-Score (AI)')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-robot"></i> CA-Score (AI)</h6>
                    <p>شبكات عصبية + بيانات ضخمة</p>
                </div>
                <div class="report-card" onclick="openReport('var-risk', 'Value at Risk (VaR)')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-dice"></i> Value at Risk (VaR)</h6>
                    <p>أقصى خسارة محتملة (99%)</p>
                </div>
            </div>
        </div>

        <!-- Wing 5: Investment (4 Reports) -->
        <div class="pantheon-wing" data-wing="investment">
            <div class="wing-header">
                <i class="wing-icon fas fa-chart-pie" style="color: var(--color-investment);"></i>
                <div>
                    <h3 class="wing-title">ديوان الاستثمار</h3>
                    <p class="wing-subtitle">نماذج التقييم وإدارة المحافظ الاستثمارية</p>
                </div>
                <span class="wing-badge">4 تقارير</span>
            </div>
            <div class="report-grid">
  
                <div class="report-card" onclick="openReport('famafrench-model', 'Fama-French 3-Factor')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-cubes"></i> Fama-French 3-Factor</h6>
                    <p>CAPM + حجم + قيمة</p>
                </div>
                <div class="report-card" onclick="openReport('mpt-portfolio', 'نظرية المحفظة الحديثة MPT')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-briefcase"></i> نظرية المحفظة الحديثة (MPT)</h6>
                    <p>الحد الأمثل للمخاطر والعائد</p>
                </div>
                <div class="report-card" onclick="openReport('sharpe-ratio', 'Sharpe Ratio')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-divide"></i> Sharpe Ratio</h6>
                    <p>العائد لكل وحدة مخاطرة</p>
                </div>
            </div>
        </div>

        <!-- Wing 6: Quality (2 Reports) -->
        <div class="pantheon-wing" data-wing="quality">
            <div class="wing-header">
                <i class="wing-icon fas fa-check-double" style="color: var(--color-primary-glow);"></i>
                <div>
                  <h3 class="wing-title">ديوان جودة الأرباح</h3>
                    <p class="wing-subtitle">الكشف عن التلاعب وجودة التقارير المالية</p>
                </div>
                <span class="wing-badge">2 تقارير</span>
            </div>
            <div class="report-grid">
                <div class="report-card" onclick="openReport('beneish-mscore', 'Beneish M-Score')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-search-dollar"></i> Beneish M-Score</h6>
                    <p>الكشف عن التلاعب في الأرباح</p>
                </div>
                <div class="report-card" onclick="openReport('sloan-accruals', 'Sloan\'s Accruals')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-file-contract"></i> Sloan's Accruals</h6>
                    <p>نسبة الاستحقاقات إلى النقد</p>
                </div>
            </div>
        </div>

    </main>

    <!-- Report Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportModalLabel">التقرير</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="reportModalBody">
                    <div class="text-center p-5">
                        <div class="loading-spinner"></div>
                        <p class="mt-3">جارٍ تحميل التقرير...</p>
                    </div>
                </div>
<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
    <button type="button" class="btn btn-info" onclick="exportToImage()">
        <i class="fas fa-image"></i> تصدير صورة
    </button>
    <button type="button" class="btn btn-success" onclick="exportToExcel()">
        <i class="fas fa-file-excel"></i> تصدير Excel
    </button>
    <button type="button" class="btn btn-primary" onclick="exportToWord()">
        <i class="fas fa-file-word"></i> تصدير Word
    </button>
    <button type="button" class="btn btn-danger" onclick="exportToPDF()">
        <i class="fas fa-file-pdf"></i> تصدير PDF
    </button>
</div>
               
 <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                    <button type="button" class="btn btn-primary" id="exportPdfBtn" onclick="exportCurrentReport()">
                        <i class="fas fa-file-pdf"></i> تصدير PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    
    // ========== Global Variables ==========

// ========== Navigation Functions ==========
function goToFinancialStatements() {
    const activeClientId = localStorage.getItem('activeClientId');
    if (activeClientId) {
        window.location.href = `consolidation-cockpit.html?clientId=${activeClientId}`;
    } else {
        window.location.href = 'consolidation-cockpit.html';
    }
}

function goToAccountMapping() {
    const activeClientId = localStorage.getItem('activeClientId');
    if (activeClientId) {
        window.location.href = `account-mapping.html?clientId=${activeClientId}`;
    } else {
        window.location.href = 'account-mapping.html';
    }
}

        let reportModal;
        let currentReportId = '';
        let currentReportTitle = '';
        const formatCurrency = (val) => new Intl.NumberFormat('ar-SA', { 
            style: 'currency', 
            currency: 'SAR', 
            minimumFractionDigits: 0, 
            maximumFractionDigits: 0 
        }).format(val || 0);

        // ========== Initialize ==========
        document.addEventListener('DOMContentLoaded', function() {
            reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
            loadSampleData();
        });

        // ========== Sample Data Generator ==========
        function loadSampleData() {
            // تحميل بيانات تجريبية من localStorage أو إنشاء بيانات افتراضية
            if (!localStorage.getItem('polarisData')) {
                const sampleData = {
                    companyName: 'شركة النجم الساطع المحدودة',
                    fiscalYear: 2024,
                    revenue: 50000000,
                    cogs: 30000000,
                    operatingExpenses: 12000000,
                    otherIncome: 2000000,
                    currentAssets: 25000000,
                    fixedAssets: 40000000,
                    currentLiabilities: 15000000,
                    longTermLiabilities: 20000000,
                    equity: 30000000,
                    cashFlow: 8000000,
                    budget: {
                        revenue: 48000000,
                        expenses: 40000000
                    }
                };
                localStorage.setItem('polarisData', JSON.stringify(sampleData));
            }
        }

function getData() {
    const activeClientId = localStorage.getItem('activeClientId');
    
    if (!activeClientId) {
        console.error('لا يوجد عميل نشط');
        return null;
    }
    
    // ✅ قراءة من نفس المفتاح اللي بتستخدمه consolidation-cockpit
    const auditFileKey = `polarisAuditFile_${activeClientId}`;
    const savedAuditFile = localStorage.getItem(auditFileKey);
    
    if (!savedAuditFile) {
        console.error('❌ لا توجد بيانات للعميل:', activeClientId);
        return null;
    }
    
    try {
        const auditData = JSON.parse(savedAuditFile);
        console.log('✅ تم تحميل بيانات المراجعة بنجاح');
        
        // استخراج ميزان المراجعة من الهيكل
        const rawData = auditData.trialBalance || auditData.accounts || [];
        
        if (!rawData || rawData.length === 0) {
            console.error('❌ ميزان المراجعة فارغ');
            return null;
        }
        
        console.log('✅ عدد الحسابات:', rawData.length);
        
        const processed = processFinancialData(rawData);
        return processed;
        
    } catch (e) {
        console.error('خطأ في قراءة البيانات:', e);
        return null;
    }
}

// ==================================================================
// دالة حساب الرصيد النهائي (منسوخة من consolidation-cockpit.html)
// ==================================================================
function calculateFinalBalance(account, adjustments = [], isPriorYear = false) {
    if (!account) return 0;
    if (isPriorYear) {
        const obDebit = Number(account.ob_debit) || 0;
        const obCredit = Number(account.ob_credit) || 0;
        return obDebit - obCredit;
    }
    const bookBalance = Number(account.book_balance) || 0;
    const accountAdjustments = (adjustments || []).filter(adj => 
        String(adj.debit_account) === String(account.account_id) || 
        String(adj.credit_account) === String(account.account_id)
    );
    const adjustmentEffect = accountAdjustments.reduce((sum, adj) => {
        return sum + (String(adj.debit_account) === String(account.account_id) ? adj.amount : -adj.amount);
    }, 0);
    return isNaN(bookBalance + adjustmentEffect) ? 0 : bookBalance + adjustmentEffect;
}

// ==================================================================
// دالة التصنيف المحاسبي (منسوخة من consolidation-cockpit.html)
// ==================================================================
const categorizeAccounts = (function() {
    const cache = new Map();
    return function(trialBalance, adjustments = []) {
        const cacheKey = JSON.stringify({ tb: trialBalance?.length, adj: adjustments?.length });
        if (cache.has(cacheKey)) return cache.get(cacheKey);
        
        const accounts = trialBalance || [];
        
        // 1. إنشاء صناديق منفصلة لكل إيضاح
        const categorized = { 
            revenue: [], cogs: [], operatingExpenses: [], otherRevenues: [], 
            currentAssets: [], fixedAssets: [], currentLiabilities: [], longTermLiabilities: [], 
            equity: [], clearing: [],
            // -- صناديق مخصصة للإيضاحات --
            note3_cash: [],
            note4_tradeReceivables: [],
            note5_otherReceivables: [],
            note6_inventory: [],
            note7_fixedAssets: [],
            note8_tradePayables: [],
            note9_otherPayables: [],
            note10_zakatProvision: [],
            note11_revenueDetails: [],
            note12_adminExpenses: []
        };

        accounts.forEach(account => {
            if (account.category === 'ignore') return;
            const finalBalance = calculateFinalBalance(account, adjustments, false);
            const accountWithBalance = { ...account, finalBalance };
            const mainCategory = (account.category || '').toLowerCase();
            const subCategory = (account.sub_category || '').toLowerCase();

            // 2. توزيع الحسابات على الصناديق الصحيحة
            switch (mainCategory) {
                case 'assets':
                    if (['fixed_assets', 'intangible_assets', 'long_term_investments'].includes(subCategory)) {
                        categorized.fixedAssets.push(accountWithBalance);
                        categorized.note7_fixedAssets.push(accountWithBalance);
                    } else {
                        categorized.currentAssets.push(accountWithBalance);
                        if (subCategory.includes('cash')) categorized.note3_cash.push(accountWithBalance);
                        if (subCategory === 'trade_receivables') categorized.note4_tradeReceivables.push(accountWithBalance);
                        if (subCategory === 'other_receivables') categorized.note5_otherReceivables.push(accountWithBalance);
                        if (subCategory === 'inventory') categorized.note6_inventory.push(accountWithBalance);
                    }
                    break;
                case 'liabilities':
                    if (['long_term_loans', 'end_of_service_benefit'].includes(subCategory)) {
                        categorized.longTermLiabilities.push(accountWithBalance);
                    } else {
                        categorized.currentLiabilities.push(accountWithBalance);
                        if (subCategory === 'trade_payables') categorized.note8_tradePayables.push(accountWithBalance);
                        if (subCategory === 'other_payables') categorized.note9_otherPayables.push(accountWithBalance);
                        if (subCategory === 'zakat_tax_provision') categorized.note10_zakatProvision.push(accountWithBalance);
                    }
                    break;
                case 'equity':
                    categorized.equity.push(accountWithBalance);
                    break;
                case 'revenue':
                    categorized.note11_revenueDetails.push(accountWithBalance);
                    if (subCategory.includes('other') || subCategory.includes('gains')) {
                        categorized.otherRevenues.push(accountWithBalance);
                    } else {
                        categorized.revenue.push(accountWithBalance);
                    }
                    break;
                case 'expenses':
                    if (subCategory === 'cogs') {
                        categorized.cogs.push(accountWithBalance);
                    } else {
                        categorized.operatingExpenses.push(accountWithBalance);
                        if (!['depreciation', 'amortization', 'zakat_expense'].includes(subCategory)) {
                            categorized.note12_adminExpenses.push(accountWithBalance);
                        }
                    }
                    break;
                case 'clearing':
                    categorized.clearing.push(accountWithBalance);
                    break;
            }
        });
        cache.set(cacheKey, categorized);
        return categorized;
    };
})();

// ==================================================================
// دالة توليد قائمة الدخل (منسوخة من consolidation-cockpit.html)
// ==================================================================
function generateIncomeStatement(categorizedData) {
    if (!categorizedData || typeof categorizedData !== 'object' || !categorizedData.revenue) {
        console.error('Error: categorizedData is invalid or missing revenue', categorizedData);
        return {
            totalRevenue: 0, totalCOGS: 0, grossProfit: 0, adminExpenses: 0,
            depreciationExpense: 0, amortizationExpense: 0, otherRevenues: 0,
            netProfitBeforeZakat: 0, zakatExpense: 0, netProfit: 0,
            allAccounts: categorizedData
        };
    }
    const grossRevenue = -categorizedData.revenue.filter(acc => acc.sub_category !== 'sales_discount').reduce((sum, acc) => sum + acc.finalBalance, 0);
    const salesDiscounts = categorizedData.revenue.filter(acc => acc.sub_category === 'sales_discount').reduce((sum, acc) => sum + acc.finalBalance, 0);
    const netRevenue = grossRevenue - salesDiscounts;
    const totalCOGS = categorizedData.cogs.reduce((sum, acc) => sum + acc.finalBalance, 0);
    const grossProfit = netRevenue - totalCOGS;
const depreciationExpense = categorizedData.operatingExpenses
    .filter(acc => 
        acc.sub_category === 'depreciation' || 
        (acc.name && acc.name.includes('استهلاك')) ||
        (acc.account_id && acc.account_id.toString().startsWith('60101'))
    )
    .reduce((sum, acc) => sum + acc.finalBalance, 0);
const amortizationExpense = categorizedData.operatingExpenses
    .filter(acc => acc.sub_category === 'amortization')
const adminExpenses = categorizedData.operatingExpenses
    .filter(acc => 
        !['depreciation', 'amortization', 'zakat_expense'].includes(acc.sub_category) &&
        !(acc.name && acc.name.includes('استهلاك')) &&
        !(acc.account_id && acc.account_id.toString().startsWith('60101'))
    )
    .reduce((sum, acc) => sum + acc.finalBalance, 0);
    const otherRevenues = -categorizedData.otherRevenues.reduce((sum, acc) => sum + acc.finalBalance, 0);
const zakatExpense = categorizedData.operatingExpenses
    .filter(acc => acc.sub_category === 'zakat_expense')
    .reduce((sum, acc) => sum + acc.finalBalance, 0);    const netProfitBeforeZakat = grossProfit + otherRevenues - (adminExpenses + depreciationExpense + amortizationExpense);
    const netProfit = netProfitBeforeZakat - zakatExpense;
    return { 
        totalRevenue: netRevenue, totalCOGS, grossProfit, adminExpenses, 
        depreciationExpense, amortizationExpense, otherRevenues, netProfitBeforeZakat, 
        zakatExpense, netProfit, allAccounts: categorizedData 
    };
}

// ==================================================================
// دالة توليد قائمة المركز المالي (منسوخة من consolidation-cockpit.html)
// ==================================================================
function generateBalanceSheet(categorizedData, netProfit, isPriorYear = false) {
    const currentAssets = categorizedData.currentAssets.reduce((sum, acc) => sum + acc.finalBalance, 0);
    const fixedAssets = categorizedData.fixedAssets.reduce((sum, acc) => sum + acc.finalBalance, 0);
    const totalAssets = currentAssets + fixedAssets;
    const currentLiabilities = categorizedData.currentLiabilities.reduce((sum, acc) => sum + acc.finalBalance, 0);
    const longTermLiabilities = categorizedData.longTermLiabilities.reduce((sum, acc) => sum + acc.finalBalance, 0);
    const totalLiabilities = currentLiabilities + longTermLiabilities;
    const equityAccountsBalance = categorizedData.equity.reduce((sum, acc) => sum + acc.finalBalance, 0);
    const totalEquity = isPriorYear ? equityAccountsBalance : (equityAccountsBalance - netProfit);
    const accountingEquationBalance = totalAssets + totalLiabilities + totalEquity;
    const isBalanced = Math.abs(accountingEquationBalance) < 2;
    return {
        currentAssets, fixedAssets, totalAssets,
        currentLiabilities: -currentLiabilities,
        longTermLiabilities: -longTermLiabilities,
        totalLiabilities: -totalLiabilities,
        totalEquity: -totalEquity,
        isBalanced, accountingEquationBalance,
        allAccounts: categorizedData
    };
}

// ==================================================================
// دالة معالجة البيانات المالية (محدثة)
// ==================================================================
function processFinancialData(rawData) {
    let tb = Array.isArray(rawData) ? rawData : [];
    
    if (!tb || tb.length === 0) {
        console.error('ميزان المراجعة فارغ');
        return null;
    }
    
    console.log('✅ عدد الحسابات:', tb.length);
    
    // تصنيف الحسابات باستخدام نفس الدالة من consolidation-cockpit
    const categorized = categorizeAccounts(tb, []);
    
    // توليد قائمة الدخل
    const incomeData = generateIncomeStatement(categorized);
    
    // توليد قائمة المركز المالي
    const balanceData = generateBalanceSheet(categorized, incomeData.netProfit, false);
    
    console.log('💰 صافي الإيرادات:', incomeData.totalRevenue.toFixed(2));
    console.log('🛒 تكلفة الإيرادات:', incomeData.totalCOGS.toFixed(2));
    console.log('📊 مجمل الدخل:', incomeData.grossProfit.toFixed(2));
    console.log('💸 المصروفات الإدارية:', incomeData.adminExpenses.toFixed(2));
    console.log('📉 الإهلاك:', incomeData.depreciationExpense.toFixed(2));
    console.log('💰 إيرادات أخرى:', incomeData.otherRevenues.toFixed(2));
    console.log('✅ صافي الدخل قبل الزكاة:', incomeData.netProfitBeforeZakat.toFixed(2));
    console.log('📿 الزكاة:', incomeData.zakatExpense.toFixed(2));
    console.log('🎯 صافي الربح/الخسارة:', incomeData.netProfit.toFixed(2));
    console.log('🏦 الأصول المتداولة:', balanceData.currentAssets.toFixed(2));
    console.log('🏢 الأصول الثابتة:', balanceData.fixedAssets.toFixed(2));
    console.log('📉 الخصوم المتداولة:', balanceData.currentLiabilities.toFixed(2));
    console.log('📈 الخصوم طويلة الأجل:', balanceData.longTermLiabilities.toFixed(2));
    console.log('💼 حقوق الملكية:', balanceData.totalEquity.toFixed(2));
    
    return {
        // بيانات قائمة الدخل
        revenue: incomeData.totalRevenue,
        cogs: incomeData.totalCOGS,
        grossProfit: incomeData.grossProfit,
        operatingExpenses: incomeData.adminExpenses,
        depreciationExpense: incomeData.depreciationExpense,
        otherIncome: incomeData.otherRevenues,
        netProfitBeforeZakat: incomeData.netProfitBeforeZakat,
        zakatExpense: incomeData.zakatExpense,
        netIncome: incomeData.netProfit,
        
        // بيانات قائمة المركز المالي
        currentAssets: balanceData.currentAssets,
        fixedAssets: balanceData.fixedAssets,
        assets: balanceData.totalAssets,
        currentLiabilities: balanceData.currentLiabilities,
        longTermLiabilities: balanceData.longTermLiabilities,
        liabilities: balanceData.totalLiabilities,
        equity: balanceData.totalEquity,
        
        // بيانات إضافية
        expenses: incomeData.totalCOGS + incomeData.adminExpenses,
        operatingProfit: incomeData.grossProfit - incomeData.adminExpenses,
        cashFlow: incomeData.netProfit + incomeData.depreciationExpense,
        
        // البيانات المصنفة الكاملة
        categorized: categorized,
        trialBalance: tb,
        
        // معلومات إضافية
        fiscalYear: new Date().getFullYear(),
        companyName: 'شركة النجم الساطع المحدودة'
    };
}
        function filterWing(wingName) {
            const wings = document.querySelectorAll('.pantheon-wing');
            const filterBtns = document.querySelectorAll('.filter-btn');
            
            // Update active button
            filterBtns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide wings
            wings.forEach(wing => {
                if (wingName === 'all' || wing.dataset.wing === wingName) {
                    wing.style.display = 'block';
                } else {
                    wing.style.display = 'none';
                }
            });
        }

        // ========== Report Opening Function ==========
        function openReport(reportId, title) {
            currentReportId = reportId;
            currentReportTitle = title;
            
            document.getElementById('reportModalLabel').textContent = title;
            document.getElementById('reportModalBody').innerHTML = `
                <div class="text-center p-5">
                    <div class="loading-spinner"></div>
                    <p class="mt-3">جارٍ تحميل التقرير...</p>
                </div>
            `;
            
            reportModal.show();
            
            // Simulate loading delay
            setTimeout(() => {
                const content = generateReportContent(reportId, title);
                document.getElementById('reportModalBody').innerHTML = content;
            }, 500);
        }

    // ========== Report Content Generator ==========
function generateReportContent(reportId, title) {
    currentReportTitle = title;
    const data = getData();
    
    // فحص البيانات
    if (!data) {
        return `
            <div class="alert alert-danger text-center p-5">
                <i class="fas fa-database fa-3x mb-3"></i>
                <h4>خطأ في تحميل البيانات</h4>
                <p>لم يتم العثور على بيانات مالية. الرجاء التأكد من وجود ملف المراجعة.</p>
            </div>
        `;
    }
    
    switch(reportId) {
        // ========== FINANCE WING ==========
        case 'yearend-checklist':
            return generateYearEndChecklist(data);
        case 'sovereign-fs':
            return generateFinancialStatements(data);
        case 'sovereign-audit':
            return generateAuditReport(data);
        case 'budget-variance':
            return generateBudgetVariance(data);
        case 'profit-forecast':
            return generateProfitForecast(data);
        case 'cash-forecast':
            return generateCashForecast(data);
        case 'loan-capacity':
            return generateLoanCapacity(data);
        case 'money-flow':
            return generateMoneyFlow(data);
        
        // ========== BUDGET SECTION (NEW) ==========
        case 'budget-preparation':
            return generateBudgetPreparation(data);
        case 'budget-comparison':
            return generateBudgetComparison(data);
        case 'budget-update':
            return generateBudgetUpdate(data);
        case 'budget-analysis':
            return generateBudgetAnalysis(data);
        
        // ========== FORECAST SECTION (NEW) ==========
        case 'revenue-forecast':
            return generateRevenueForecast(data);
        case 'cashflow-forecast':
            return generateCashFlowForecast(data);
        case 'multiple-scenarios':
            return generateMultipleScenarios(data);
        case 'ai-forecast':
            return generateAIForecast(data);
        
        // ========== MANAGEMENT WING ==========
        case 'kpi-dashboard':
            return generateKPIDashboard(data);
        case 'profitability-dim':
            return generateProfitabilityDim(data);
        case 'working-capital':
            return generateWorkingCapital(data);
        case 'abc-costing':
            return generateABCCosting(data);
        
        // ========== STRATEGY WING ==========
        case 'breakeven-analysis':
            return generateBreakevenAnalysis(data);
        case 'whatif-scenarios':
            return generateWhatIfScenarios(data);
        case 'integrated-report':
            return generateIntegratedReport(data);
        case 'dcf-valuation':
            return generateDCFValuation(data);
        case 'rim-valuation':
            return generateRIMValuation(data);
        case 'ddm-valuation':
            return generateDDMValuation(data);
        case 'dupont-analysis':
            return generateDupontAnalysis(data);
        case 'eva-analysis':
            return generateEVAAnalysis(data);
        
        // ========== RISK WING ==========
        case 'altman-zscore':
            return generateAltmanZScore(data);
        case 'ohlson-oscore':
            return generateOhlsonOScore(data);
        case 'zmijewski-xscore':
            return generateZmijewskiXScore(data);
        case 'sherrod-model':
            return generateSherrodModel(data);
        case 'fulmer-hscore':
            return generateFulmerHScore(data);
        case 'springate-sscore':
            return generateSpringateSScore(data);
        case 'ca-score-ai':
            return generateCAScoreAI(data);
        case 'var-risk':
            return generateVaRRisk(data);
        
        // ========== INVESTMENT WING ==========
        case 'capm-model':
            return generateCAPM(data);
        case 'famafrench-model':
            return generateFamaFrench(data);
        case 'mpt-portfolio':
            return generateMPT(data);
        case 'sharpe-ratio':
            return generateSharpeRatio(data);
        
        // ========== QUALITY WING ==========
        case 'beneish-mscore':
            return generateBeneishMScore(data);
        case 'sloan-accruals':
            return generateSloanAccruals(data);
        
        default:
            return `<div class="alert alert-info text-center p-5">
                <i class="fas fa-info-circle fa-3x mb-3"></i>
                <h4>التقرير قيد التطوير</h4>
                <p>هذا التقرير سيكون متاحاً قريباً</p>
            </div>`;
    }
}


        // ========== FINANCE REPORTS ==========
        function generateYearEndChecklist(data) {
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-tasks"></i> قائمة إغلاق نهاية العام ${data.fiscalYear}</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> هذه القائمة تساعدك على إتمام جميع الإجراءات المطلوبة لإغلاق السنة المالية
                    </div>

                    <div class="accordion" id="checklistAccordion">
                        <div class="accordion-item bg-dark">
                            <h2 class="accordion-header">
                                <button class="accordion-button bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#zatca">
                                    <i class="fas fa-check-circle text-success me-2"></i> 1. إعداد ملفات ZATCA
                                </button>
                            </h2>
                            <div id="zatca" class="accordion-collapse collapse show" data-bs-parent="#checklistAccordion">
                                <div class="accordion-body">
                                    <ul>
                                        <li>تجهيز الفواتير الإلكترونية بصيغة XML</li>
                                        <li>التأكد من توافق البيانات مع متطلبات الهيئة</li>
                                        <li>رفع الملفات على منصة فاتورة</li>
                                        <li>الحصول على شهادة التوافق</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item bg-dark">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#qawaem">
                                    <i class="fas fa-check-circle text-success me-2"></i> 2. إعداد ملفات Qawaem
                                </button>
                            </h2>
                            <div id="qawaem" class="accordion-collapse collapse" data-bs-parent="#checklistAccordion">
                                <div class="accordion-body">
                                    <ul>
                                        <li>تصدير القوائم المالية بصيغة XBRL</li>
                                        <li>مراجعة البيانات المالية</li>
                                        <li>رفع الملفات على منصة قوائم</li>
                                        <li>التحقق من قبول الملفات</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item bg-dark">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#zakat">
                                    <i class="fas fa-check-circle text-success me-2"></i> 3. الإقرار الزكوي
                                </button>
                            </h2>
                            <div id="zakat" class="accordion-collapse collapse" data-bs-parent="#checklistAccordion">
                                <div class="accordion-body">
                                    <ul>
                                        <li>حساب الوعاء الزكوي</li>
                                        <li>إعداد الإقرار الزكوي</li>
                                        <li>تقديم الإقرار للهيئة</li>
                                        <li>سداد المبلغ المستحق</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item bg-dark">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#audit">
                                    <i class="fas fa-check-circle text-success me-2"></i> 4. المراجعة الخارجية
                                </button>
                            </h2>
                            <div id="audit" class="accordion-collapse collapse" data-bs-parent="#checklistAccordion">
                                <div class="accordion-body">
                                    <ul>
                                        <li>تجهيز المستندات للمراجع</li>
                                        <li>الرد على استفسارات المراجع</li>
                                        <li>الحصول على تقرير المراجع</li>
                                        <li>إجراء التعديلات المطلوبة</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item bg-dark">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#closing">
                                    <i class="fas fa-check-circle text-success me-2"></i> 5. قيود الإقفال
                                </button>
                            </h2>
                            <div id="closing" class="accordion-collapse collapse" data-bs-parent="#checklistAccordion">
                                <div class="accordion-body">
                                    <ul>
                                        <li>إقفال حسابات الإيرادات والمصروفات</li>
                                        <li>حساب صافي الربح أو الخسارة</li>
                                        <li>ترحيل النتيجة إلى حقوق الملكية</li>
                                        <li>إعداد ميزان المراجعة بعد الإقفال</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 p-3 bg-success bg-opacity-10 border border-success rounded">
                        <h5 class="text-success"><i class="fas fa-check-double"></i> الحالة العامة</h5>
                        <div class="progress mt-3" style="height: 30px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 85%">85% مكتمل</div>
                        </div>
                        <p class="mt-3 mb-0 small">تم إنجاز 17 من 20 مهمة. المتبقي: 3 مهام</p>
                    </div>
                </div>
            `;
        }

        function generateFinancialStatements(data) {
        const grossProfit = data.revenue - data.cogs;
const operatingProfit = grossProfit - data.operatingExpenses - (data.depreciationExpense || 0);
const netProfit = operatingProfit + (data.otherIncome || 0);

            const totalAssets = data.currentAssets + data.fixedAssets;
            const totalLiabilities = data.currentLiabilities + data.longTermLiabilities;
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-file-invoice"></i> القوائم المالية ${data.fiscalYear}</h4>
                    
                    <ul class="nav nav-tabs mb-4" id="fsTab" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#income">قائمة الدخل</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#balance">المركز المالي</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#cashflow">التدفقات النقدية</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#equity">التغيرات في حقوق الملكية</button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="income">
                            <h5 class="mb-3">قائمة الدخل الشامل</h5>
                            <table class="table table-striped">
                                <tbody>
                                    <tr>
                                        <td><strong>الإيرادات</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(data.revenue)}</strong></td>
                                    </tr>
                                    <tr>
                                        <td>تكلفة المبيعات</td>
                                        <td class="text-end text-danger">(${formatCurrency(data.cogs)})</td>
                                    </tr>
                                    <tr class="table-primary">
                                        <td><strong>مجمل الربح</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(grossProfit)}</strong></td>
                                    </tr>
                                    <tr>
                                        <td>المصروفات التشغيلية</td>
                                        <td class="text-end text-danger">(${formatCurrency(data.operatingExpenses)})</td>
                                    </tr>
<tr>
    <td>الإهلاك</td>
    <td class="text-end text-danger">(${formatCurrency(data.depreciationExpense || 0)})</td>
</tr>

                                    <tr class="table-info">
                                        <td><strong>الربح التشغيلي</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(operatingProfit)}</strong></td>
                                    </tr>
                                    <tr>
                                        <td>إيرادات أخرى</td>
                                        <td class="text-end text-success">${formatCurrency(data.otherIncome)}</td>
                                    </tr>
                                    <tr class="table-success">
                                        <td><strong>صافي الربح</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(netProfit)}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <div class="mt-4">
                                <canvas id="incomeChart" height="100"></canvas>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="balance">
                            <h5 class="mb-3">قائمة المركز المالي</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary">الأصول</h6>
                                    <table class="table table-sm">
                                        <tbody>
                                            <tr>
                                                <td>أصول متداولة</td>
                                                <td class="text-end">${formatCurrency(data.currentAssets)}</td>
                                            </tr>
                                            <tr>
                                                <td>أصول ثابتة</td>
                                                <td class="text-end">${formatCurrency(data.fixedAssets)}</td>
                                            </tr>
                                            <tr class="table-primary">
                                                <td><strong>إجمالي الأصول</strong></td>
                                                <td class="text-end"><strong>${formatCurrency(totalAssets)}</strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-danger">الخصوم وحقوق الملكية</h6>
                                    <table class="table table-sm">
                                        <tbody>
                                            <tr>
                                                <td>خصوم متداولة</td>
                                                <td class="text-end">${formatCurrency(data.currentLiabilities)}</td>
                                            </tr>
                                            <tr>
                                                <td>خصوم طويلة الأجل</td>
                                                <td class="text-end">${formatCurrency(data.longTermLiabilities)}</td>
                                            </tr>
                                            <tr>
                                                <td>حقوق الملكية</td>
                                                <td class="text-end">${formatCurrency(data.equity)}</td>
                                            </tr>
                                            <tr class="table-danger">
                                                <td><strong>إجمالي الخصوم وحقوق الملكية</strong></td>
                                                <td class="text-end"><strong>${formatCurrency(totalLiabilities + data.equity)}</strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <canvas id="balanceChart" height="80"></canvas>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="cashflow">
                            <h5 class="mb-3">قائمة التدفقات النقدية</h5>
                            <table class="table table-striped">
                                <tbody>
                                    <tr class="table-primary">
                                        <td><strong>التدفقات النقدية من الأنشطة التشغيلية</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(data.cashFlow)}</strong></td>
                                    </tr>
                                    <tr>
                                        <td>صافي الربح</td>
                                        <td class="text-end">${formatCurrency(netProfit)}</td>
                                    </tr>
                                    <tr>
                                        <td>تعديلات للبنود غير النقدية</td>
                                        <td class="text-end">${formatCurrency(data.cashFlow - netProfit)}</td>
                                    </tr>
                                    <tr class="table-info">
                                        <td><strong>التدفقات النقدية من الأنشطة الاستثمارية</strong></td>
                                        <td class="text-end text-danger"><strong>(${formatCurrency(data.cashFlow * 0.3)})</strong></td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td><strong>التدفقات النقدية من الأنشطة التمويلية</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(data.cashFlow * 0.2)}</strong></td>
                                    </tr>
                                    <tr class="table-success">
                                        <td><strong>صافي التغير في النقدية</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(data.cashFlow * 0.9)}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="tab-pane fade" id="equity">
                            <h5 class="mb-3">قائمة التغيرات في حقوق الملكية</h5>
                            <table class="table table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>البيان</th>
                                        <th class="text-end">رأس المال</th>
                                        <th class="text-end">الأرباح المحتجزة</th>
                                        <th class="text-end">الإجمالي</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>الرصيد في بداية العام</td>
                                        <td class="text-end">${formatCurrency(data.equity * 0.6)}</td>
                                        <td class="text-end">${formatCurrency(data.equity * 0.4 - netProfit)}</td>
                                        <td class="text-end">${formatCurrency(data.equity - netProfit)}</td>
                                    </tr>
                                    <tr>
                                        <td>صافي ربح العام</td>
                                        <td class="text-end">-</td>
                                        <td class="text-end text-success">${formatCurrency(netProfit)}</td>
                                        <td class="text-end text-success">${formatCurrency(netProfit)}</td>
                                    </tr>
                                    <tr>
                                        <td>توزيعات أرباح</td>
                                        <td class="text-end">-</td>
                                        <td class="text-end text-danger">(${formatCurrency(0)})</td>
                                        <td class="text-end text-danger">(${formatCurrency(0)})</td>
                                    </tr>
                                    <tr class="table-success">
                                        <td><strong>الرصيد في نهاية العام</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(data.equity * 0.6)}</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(data.equity * 0.4)}</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(data.equity)}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="alert alert-info mt-4">
                        <i class="fas fa-info-circle"></i> <strong>ملاحظة:</strong> القوائم المالية معدة وفقاً للمعايير الدولية للتقارير المالية (IFRS)
                    </div>
                </div>
            `;
        }

        function generateAuditReport(data) {
            return `
                <div class="p-4">
                    <h4 class="mb-4 text-center"><i class="fas fa-stamp"></i> تقرير المراجع المستقل</h4>
                    
                    <div class="border border-primary p-4 rounded">
                        <h5 class="text-primary mb-3">إلى السادة / مساهمي ${data.companyName}</h5>
                        
                        <h6 class="mt-4 mb-3">الرأي</h6>
                        <p>لقد راجعنا القوائم المالية المرفقة لـ ${data.companyName} ("الشركة")، والتي تشمل قائمة المركز المالي كما في 31 ديسمبر ${data.fiscalYear}، وقوائم الدخل الشامل والتغيرات في حقوق الملكية والتدفقات النقدية للسنة المنتهية في ذلك التاريخ، والإيضاحات المتممة للقوائم المالية بما في ذلك ملخص السياسات المحاسبية الهامة.</p>
                        
                        <div class="alert alert-success my-3">
                            <p class="mb-0"><strong>في رأينا، إن القوائم المالية المرفقة تعبر بعدالة، من جميع النواحي الجوهرية، عن المركز المالي للشركة كما في 31 ديسمبر ${data.fiscalYear}، وعن أدائها المالي وتدفقاتها النقدية للسنة المنتهية في ذلك التاريخ وفقاً للمعايير الدولية للتقارير المالية (IFRS).</strong></p>
                        </div>
                        
                        <h6 class="mt-4 mb-3">أساس الرأي</h6>
                        <p>لقد قمنا بمراجعتنا وفقاً للمعايير الدولية للمراجعة (ISA). إن مسؤولياتنا بموجب تلك المعايير موضحة بشكل أكبر في قسم "مسؤوليات المراجع" في تقريرنا. نحن مستقلون عن الشركة وفقاً لقواعد السلوك المهني للمحاسبين القانونيين ذات الصلة بمراجعتنا للقوائم المالية، وقد استوفينا مسؤولياتنا الأخلاقية الأخرى وفقاً لهذه المتطلبات.</p>
                        
                        <h6 class="mt-4 mb-3">أمور المراجعة الرئيسية</h6>
                        <table class="table table-bordered mt-3">
                            <thead class="table-dark">
                                <tr>
                                    <th>الأمر</th>
                                    <th>كيفية المعالجة</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>الاعتراف بالإيرادات</td>
                                    <td>قمنا بمراجعة السياسات المحاسبية للاعتراف بالإيرادات والتحقق من مطابقتها لمعيار IFRS 15</td>
                                </tr>
                                <tr>
                                    <td>تقييم المخزون</td>
                                    <td>حضرنا الجرد الفعلي وراجعنا طرق التقييم المستخدمة</td>
                                </tr>
                                <tr>
                                    <td>الانخفاض في قيمة الأصول</td>
                                    <td>راجعنا الافتراضات المستخدمة في اختبارات الانخفاض في القيمة</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <h6 class="mt-4 mb-3">معلومات أخرى</h6>
                        <p>إن الإدارة مسؤولة عن المعلومات الأخرى. تتضمن المعلومات الأخرى المعلومات الواردة في التقرير السنوي، ولكنها لا تتضمن القوائم المالية وتقرير المراجع حولها.</p>
                        
                        <div class="mt-5 text-end">
                            <p class="mb-1"><strong>مكتب المراجعة المعتمد</strong></p>
                            <p class="mb-1">رقم الترخيص: 12345</p>
                            <p class="mb-1">التاريخ: 15 مارس ${data.fiscalYear + 1}</p>
                            <p class="mb-0">المكان: الرياض، المملكة العربية السعودية</p>
                        </div>
                    </div>
                </div>
            `;
        }

   
     function generateBudgetVariance(data) {
   if (!data) {
        return `
            <div class="alert alert-warning text-center p-5">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <h4>لا توجد بيانات متاحة</h4>
                <p>الرجاء التأكد من تحميل البيانات المالية أولاً</p>
            </div>
        `;
    }
const actualRevenue = data.revenue || 0;
            const budgetRevenue = data.budget.revenue;
            const revenueVariance = actualRevenue - budgetRevenue;
            const revenueVariancePct = (revenueVariance / budgetRevenue * 100).toFixed(1);
            
            const actualExpenses = data.cogs + data.operatingExpenses;
            const budgetExpenses = data.budget.expenses;
            const expensesVariance = actualExpenses - budgetExpenses;
            const expensesVariancePct = (expensesVariance / budgetExpenses * 100).toFixed(1);
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-chart-line"></i> تحليل الانحرافات - الموازنة مقابل الفعلي</h4>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="stats-card ${revenueVariance >= 0 ? 'border-success' : 'border-danger'}">
                                <h6>انحراف الإيرادات</h6>
                                <h3 class="${revenueVariance >= 0 ? 'text-success' : 'text-danger'}">
                                    ${revenueVariance >= 0 ? '+' : ''}${formatCurrency(revenueVariance)}
                                </h3>
                                <p>${revenueVariance >= 0 ? '+' : ''}${revenueVariancePct}%</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stats-card ${expensesVariance <= 0 ? 'border-success' : 'border-danger'}">
                                <h6>انحراف المصروفات</h6>
                                <h3 class="${expensesVariance <= 0 ? 'text-success' : 'text-danger'}">
                                    ${expensesVariance >= 0 ? '+' : ''}${formatCurrency(expensesVariance)}
                                </h3>
                                <p>${expensesVariance >= 0 ? '+' : ''}${expensesVariancePct}%</p>
                            </div>
                        </div>
                    </div>

                    <table class="table table-striped table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>البيان</th>
                                <th class="text-end">الموازنة</th>
                                <th class="text-end">الفعلي</th>
                                <th class="text-end">الانحراف</th>
                                <th class="text-end">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>الإيرادات</strong></td>
                                <td class="text-end">${formatCurrency(budgetRevenue)}</td>
                                <td class="text-end">${formatCurrency(actualRevenue)}</td>
                                <td class="text-end ${revenueVariance >= 0 ? 'text-success' : 'text-danger'}">
                                    ${revenueVariance >= 0 ? '+' : ''}${formatCurrency(revenueVariance)}
                                </td>
                                <td class="text-end ${revenueVariance >= 0 ? 'text-success' : 'text-danger'}">
                                    ${revenueVariance >= 0 ? '+' : ''}${revenueVariancePct}%
                                </td>
                            </tr>
                            <tr>
                                <td><strong>المصروفات</strong></td>
                                <td class="text-end">${formatCurrency(budgetExpenses)}</td>
                                <td class="text-end">${formatCurrency(actualExpenses)}</td>
                                <td class="text-end ${expensesVariance <= 0 ? 'text-success' : 'text-danger'}">
                                    ${expensesVariance >= 0 ? '+' : ''}${formatCurrency(expensesVariance)}
                                </td>
                                <td class="text-end ${expensesVariance <= 0 ? 'text-success' : 'text-danger'}">
                                    ${expensesVariance >= 0 ? '+' : ''}${expensesVariancePct}%
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="mt-4">
                        <canvas id="budgetVarianceChart" height="100"></canvas>
                    </div>

                    <div class="alert ${revenueVariance >= 0 && expensesVariance <= 0 ? 'alert-success' : 'alert-warning'} mt-4">
                        <h6><i class="fas fa-lightbulb"></i> التوصيات</h6>
                        <ul class="mb-0">
                            ${revenueVariance >= 0 ? 
                                '<li>الإيرادات تجاوزت الموازنة - استمر في الاستراتيجيات الحالية</li>' : 
                                '<li>الإيرادات أقل من المتوقع - راجع استراتيجيات المبيعات والتسويق</li>'}
                            ${expensesVariance <= 0 ? 
                                '<li>المصروفات أقل من الموازنة - تحكم جيد في التكاليف</li>' : 
                                '<li>المصروفات تجاوزت الموازنة - راجع سياسات التحكم في التكاليف</li>'}
                        </ul>
                    </div>
                </div>
            `;
        }

        function generateProfitForecast(data) {
            const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
            const baseProfit = (data.revenue - data.cogs - data.operatingExpenses) / 12;
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-crystal-ball"></i> تنبؤ الأرباح - 12 شهر القادمة</h4>
                    
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="stats-card border-success">
                                <h6>السيناريو المتفائل</h6>
                                <h3 class="text-success">${formatCurrency(baseProfit * 12 * 1.2)}</h3>
                                <p>+20% نمو</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card border-primary">
                                <h6>السيناريو الأساسي</h6>
                                <h3 class="text-primary">${formatCurrency(baseProfit * 12)}</h3>
                                <p>نمو ثابت</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card border-warning">
                                <h6>السيناريو المتحفظ</h6>
                                <h3 class="text-warning">${formatCurrency(baseProfit * 12 * 0.8)}</h3>
                                <p>-20% تراجع</p>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="profitForecastChart"></canvas>
                    </div>

                    <table class="table table-striped mt-4">
                        <thead class="table-dark">
                            <tr>
                                <th>الشهر</th>
                                <th class="text-end">متحفظ</th>
                                <th class="text-end">أساسي</th>
                                <th class="text-end">متفائل</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${months.map((month, i) => `
                                <tr>
                                    <td>${month} ${data.fiscalYear + 1}</td>
                                    <td class="text-end">${formatCurrency(baseProfit * 0.8 * (1 + i * 0.01))}</td>
                                    <td class="text-end">${formatCurrency(baseProfit * (1 + i * 0.015))}</td>
                                    <td class="text-end">${formatCurrency(baseProfit * 1.2 * (1 + i * 0.02))}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="alert alert-info mt-4">
                        <i class="fas fa-info-circle"></i> <strong>ملاحظة:</strong> التوقعات مبنية على الأداء التاريخي والاتجاهات السوقية الحالية
                    </div>
                </div>
            `;
        }

        function generateCashForecast(data) {
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-water"></i> تدفق نقدي (Sankey Diagram)</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> يوضح هذا المخطط تدفق الأموال من المصادر إلى الاستخدامات
                    </div>

                    <div class="chart-container" style="height: 500px;">
                        <canvas id="sankeyChart"></canvas>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h6 class="text-success">مصادر النقد</h6>
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <td>التدفقات التشغيلية</td>
                                        <td class="text-end text-success">${formatCurrency(data.cashFlow)}</td>
                                    </tr>
                                    <tr>
                                        <td>قروض جديدة</td>
                                        <td class="text-end text-success">${formatCurrency(data.cashFlow * 0.3)}</td>
                                    </tr>
                                    <tr>
                                        <td>بيع أصول</td>
                                        <td class="text-end text-success">${formatCurrency(data.cashFlow * 0.1)}</td>
                                    </tr>
                                    <tr class="table-success">
                                        <td><strong>إجمالي المصادر</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(data.cashFlow * 1.4)}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-danger">استخدامات النقد</h6>
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <td>شراء أصول</td>
                                        <td class="text-end text-danger">${formatCurrency(data.cashFlow * 0.5)}</td>
                                    </tr>
                                    <tr>
                                        <td>سداد قروض</td>
                                        <td class="text-end text-danger">${formatCurrency(data.cashFlow * 0.3)}</td>
                                    </tr>
                                    <tr>
                                        <td>توزيعات أرباح</td>
                                        <td class="text-end text-danger">${formatCurrency(data.cashFlow * 0.2)}</td>
                                    </tr>
                                    <tr class="table-danger">
                                        <td><strong>إجمالي الاستخدامات</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(data.cashFlow * 1.0)}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="alert alert-success mt-4">
                        <i class="fas fa-check-circle"></i> <strong>صافي التغير في النقدية:</strong> ${formatCurrency(data.cashFlow * 0.4)}
                    </div>
                </div>
            `;
        }

        function generateLoanCapacity(data) {
            const ebitda = data.revenue - data.cogs - data.operatingExpenses + (data.fixedAssets * 0.1); // Adding back depreciation
            const debtService = data.longTermLiabilities * 0.15; // Assuming 15% annual debt service
            const dscr = ebitda / debtService;
            const maxLoan = ebitda / 0.15 * 0.8; // 80% of capacity at 15% debt service
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-hand-holding-usd"></i> تحليل سعة القروض (DSCR)</h4>
                    
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="stats-card ${dscr >= 1.5 ? 'border-success' : dscr >= 1.2 ? 'border-warning' : 'border-danger'}">
                                <h6>نسبة تغطية خدمة الدين</h6>
                                <h3 class="${dscr >= 1.5 ? 'text-success' : dscr >= 1.2 ? 'text-warning' : 'text-danger'}">
                                    ${dscr.toFixed(2)}x
                                </h3>
                                <p>${dscr >= 1.5 ? 'ممتاز' : dscr >= 1.2 ? 'مقبول' : 'ضعيف'}</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card border-primary">
                                <h6>EBITDA السنوي</h6>
                                <h3 class="text-primary">${formatCurrency(ebitda)}</h3>
                                <p>الأرباح قبل الفوائد والضرائب والإهلاك</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card border-info">
                                <h6>الحد الأقصى للقروض</h6>
                                <h3 class="text-info">${formatCurrency(maxLoan)}</h3>
                                <p>بناءً على DSCR 1.25</p>
                            </div>
                        </div>
                    </div>

                    <div class="alert ${dscr >= 1.5 ? 'alert-success' : dscr >= 1.2 ? 'alert-warning' : 'alert-danger'}">
                        <h6><i class="fas fa-info-circle"></i> التفسير</h6>
                        <p class="mb-0">
                            ${dscr >= 1.5 ? 
                                'الشركة لديها قدرة ممتازة على خدمة ديونها. يمكن التفكير في الحصول على تمويل إضافي للتوسع.' :
                                dscr >= 1.2 ?
                                'الشركة لديها قدرة مقبولة على خدمة ديونها. يُنصح بالحذر عند الحصول على قروض إضافية.' :
                                'الشركة تواجه صعوبة في خدمة ديونها الحالية. يُنصح بتحسين التدفقات النقدية قبل التفكير في قروض جديدة.'}
                        </p>
                    </div>

                    <table class="table table-bordered mt-4">
                        <thead class="table-dark">
                            <tr>
                                <th>البيان</th>
                                <th class="text-end">المبلغ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>EBITDA السنوي</td>
                                <td class="text-end">${formatCurrency(ebitda)}</td>
                            </tr>
                            <tr>
                                <td>خدمة الدين السنوية الحالية</td>
                                <td class="text-end">${formatCurrency(debtService)}</td>
                            </tr>
                            <tr class="table-primary">
                                <td><strong>DSCR</strong></td>
                                <td class="text-end"><strong>${dscr.toFixed(2)}x</strong></td>
                            </tr>
                            <tr>
                                <td>القروض الحالية</td>
                                <td class="text-end">${formatCurrency(data.longTermLiabilities)}</td>
                            </tr>
                            <tr>
                                <td>الحد الأقصى للقروض (DSCR 1.25)</td>
                                <td class="text-end">${formatCurrency(maxLoan)}</td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>السعة الإضافية المتاحة</strong></td>
                                <td class="text-end"><strong>${formatCurrency(Math.max(0, maxLoan - data.longTermLiabilities))}</strong></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="chart-container mt-4">
                        <canvas id="dscr Chart"></canvas>
                    </div>
                </div>
            `;
        }

        function generateMoneyFlow(data) {
            const totalSources = data.revenue + data.otherIncome + (data.longTermLiabilities * 0.1);
            const totalUses = data.cogs + data.operatingExpenses + (data.fixedAssets * 0.15);
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-exchange-alt"></i> مصادر واستخدامات الأموال</h4>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-success bg-opacity-10 border-success">
                                <div class="card-body">
                                    <h5 class="card-title text-success"><i class="fas fa-arrow-down"></i> مصادر الأموال</h5>
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="sourcesChart"></canvas>
                                    </div>
                                    <table class="table table-sm mt-3">
                                        <tbody>
                                            <tr>
                                                <td>الإيرادات التشغيلية</td>
                                                <td class="text-end">${formatCurrency(data.revenue)}</td>
                                                <td class="text-end">${((data.revenue / totalSources) * 100).toFixed(1)}%</td>
                                            </tr>
                                            <tr>
                                                <td>إيرادات أخرى</td>
                                                <td class="text-end">${formatCurrency(data.otherIncome)}</td>
                                                <td class="text-end">${((data.otherIncome / totalSources) * 100).toFixed(1)}%</td>
                                            </tr>
                                            <tr>
                                                <td>قروض جديدة</td>
                                                <td class="text-end">${formatCurrency(data.longTermLiabilities * 0.1)}</td>
                                                <td class="text-end">${((data.longTermLiabilities * 0.1 / totalSources) * 100).toFixed(1)}%</td>
                                            </tr>
                                            <tr class="table-success">
                                                <td><strong>الإجمالي</strong></td>
                                                <td class="text-end"><strong>${formatCurrency(totalSources)}</strong></td>
                                                <td class="text-end"><strong>100%</strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card bg-danger bg-opacity-10 border-danger">
                                <div class="card-body">
                                    <h5 class="card-title text-danger"><i class="fas fa-arrow-up"></i> استخدامات الأموال</h5>
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="usesChart"></canvas>
                                    </div>
                                    <table class="table table-sm mt-3">
                                        <tbody>
                                            <tr>
                                                <td>تكلفة المبيعات</td>
                                                <td class="text-end">${formatCurrency(data.cogs)}</td>
                                                <td class="text-end">${((data.cogs / totalUses) * 100).toFixed(1)}%</td>
                                            </tr>
                                            <tr>
                                                <td>مصروفات تشغيلية</td>
                                                <td class="text-end">${formatCurrency(data.operatingExpenses)}</td>
                                                <td class="text-end">${((data.operatingExpenses / totalUses) * 100).toFixed(1)}%</td>
                                            </tr>
                                            <tr>
                                                <td>استثمارات رأسمالية</td>
                                                <td class="text-end">${formatCurrency(data.fixedAssets * 0.15)}</td>
                                                <td class="text-end">${((data.fixedAssets * 0.15 / totalUses) * 100).toFixed(1)}%</td>
                                            </tr>
                                            <tr class="table-danger">
                                                <td><strong>الإجمالي</strong></td>
                                                <td class="text-end"><strong>${formatCurrency(totalUses)}</strong></td>
                                                <td class="text-end"><strong>100%</strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info mt-4">
                        <h6><i class="fas fa-balance-scale"></i> صافي التدفق</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-0">إجمالي المصادر: <strong>${formatCurrency(totalSources)}</strong></p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-0">إجمالي الاستخدامات: <strong>${formatCurrency(totalUses)}</strong></p>
                            </div>
                        </div>
                        <hr>
                        <p class="mb-0 text-center">
                            <strong>الفائض / (العجز):</strong> 
                            <span class="${totalSources - totalUses >= 0 ? 'text-success' : 'text-danger'}">
                                ${formatCurrency(totalSources - totalUses)}
                            </span>
                        </p>
                    </div>
                </div>
            `;
        }

        // ========== MANAGEMENT REPORTS ==========
        function generateKPIDashboard(data) {
            const netProfit = data.revenue - data.cogs - data.operatingExpenses + data.otherIncome;
            const profitMargin = (netProfit / data.revenue * 100).toFixed(1);
            const roe = (netProfit / data.equity * 100).toFixed(1);
            const roa = (netProfit / (data.currentAssets + data.fixedAssets) * 100).toFixed(1);
            const currentRatio = (data.currentAssets / data.currentLiabilities).toFixed(2);
            const debtRatio = ((data.currentLiabilities + data.longTermLiabilities) / (data.currentAssets + data.fixedAssets) * 100).toFixed(1);
            const assetTurnover = (data.revenue / (data.currentAssets + data.fixedAssets)).toFixed(2);
            
            // Cash Conversion Cycle (simplified)
            const dso = 45; // Days Sales Outstanding
            const dio = 60; // Days Inventory Outstanding
            const dpo = 30; // Days Payable Outstanding
            const ccc = dso + dio - dpo;
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-tachometer-alt"></i> لوحة مؤشرات الأداء الرئيسية (KPIs)</h4>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="stats-card ${profitMargin > 15 ? 'border-success' : profitMargin > 5 ? 'border-warning' : 'border-danger'}">
                                <h6>هامش صافي الربح</h6>
                                <h3 class="${profitMargin > 15 ? 'text-success' : profitMargin > 5 ? 'text-warning' : 'text-danger'}">
                                    ${profitMargin}%
                                </h3>
                                <p><i class="fas fa-${profitMargin > 10 ? 'arrow-up text-success' : 'arrow-down text-danger'}"></i> من الإيرادات</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card ${roe > 15 ? 'border-success' : roe > 10 ? 'border-warning' : 'border-danger'}">
                                <h6>العائد على حقوق الملكية</h6>
                                <h3 class="${roe > 15 ? 'text-success' : roe > 10 ? 'text-warning' : 'text-danger'}">
                                    ${roe}%
                                </h3>
                                <p>ROE</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card ${roa > 10 ? 'border-success' : roa > 5 ? 'border-warning' : 'border-danger'}">
                                <h6>العائد على الأصول</h6>
                                <h3 class="${roa > 10 ? 'text-success' : roa > 5 ? 'text-warning' : 'text-danger'}">
                                    ${roa}%
                                </h3>
                                <p>ROA</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card ${currentRatio > 2 ? 'border-success' : currentRatio > 1 ? 'border-warning' : 'border-danger'}">
                                <h6>النسبة الحالية</h6>
                                <h3 class="${currentRatio > 2 ? 'text-success' : currentRatio > 1 ? 'text-warning' : 'text-danger'}">
                                    ${currentRatio}
                                </h3>
                                <p>Current Ratio</p>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="stats-card ${debtRatio < 50 ? 'border-success' : debtRatio < 70 ? 'border-warning' : 'border-danger'}">
                                <h6>نسبة المديونية</h6>
                                <h3 class="${debtRatio < 50 ? 'text-success' : debtRatio < 70 ? 'text-warning' : 'text-danger'}">
                                    ${debtRatio}%
                                </h3>
                                <p>Debt Ratio</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-primary">
                                <h6>معدل دوران الأصول</h6>
                                <h3 class="text-primary">${assetTurnover}x</h3>
                                <p>Asset Turnover</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card ${ccc < 60 ? 'border-success' : ccc < 90 ? 'border-warning' : 'border-danger'}">
                                <h6>دورة التحويل النقدي</h6>
                                <h3 class="${ccc < 60 ? 'text-success' : ccc < 90 ? 'text-warning' : 'text-danger'}">
                                    ${ccc} يوم
                                </h3>
                                <p>CCC</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-info">
                                <h6>EBITDA Margin</h6>
                                <h3 class="text-info">${((netProfit + data.fixedAssets * 0.1) / data.revenue * 100).toFixed(1)}%</h3>
                                <p>هامش EBITDA</p>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-dark border-primary">
                                <div class="card-body">
                                    <h6 class="card-title">اتجاه الربحية</h6>
                                    <div class="chart-container" style="height: 250px;">
                                        <canvas id="profitTrendChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-dark border-primary">
                                <div class="card-body">
                                    <h6 class="card-title">توزيع المصروفات</h6>
                                    <div class="chart-container" style="height: 250px;">
                                        <canvas id="expenseDistChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info mt-4">
                        <h6><i class="fas fa-chart-line"></i> ملخص الأداء</h6>
                        <p class="mb-0">
                            الشركة تحقق أداءً ${profitMargin > 15 && roe > 15 ? 'ممتازاً' : profitMargin > 10 && roe > 10 ? 'جيداً' : 'متوسطاً'} 
                            مع هامش ربح صافي ${profitMargin}% وعائد على حقوق الملكية ${roe}%. 
                            ${currentRatio > 2 ? 'السيولة قوية' : currentRatio > 1 ? 'السيولة مقبولة' : 'السيولة تحتاج تحسين'} 
                            ${debtRatio < 50 ? 'ومستوى المديونية آمن' : 'ولكن المديونية مرتفعة نسبياً'}.
                        </p>
                    </div>
                </div>
            `;
        }

        function generateProfitabilityDim(data) {
            // Sample data for different dimensions
            const products = [
                { name: 'المنتج أ', revenue: data.revenue * 0.4, cost: data.cogs * 0.35, profit: data.revenue * 0.4 - data.cogs * 0.35 },
                { name: 'المنتج ب', revenue: data.revenue * 0.35, cost: data.cogs * 0.40, profit: data.revenue * 0.35 - data.cogs * 0.40 },
                { name: 'المنتج ج', revenue: data.revenue * 0.25, cost: data.cogs * 0.25, profit: data.revenue * 0.25 - data.cogs * 0.25 }
            ];
            
            const regions = [
                { name: 'الرياض', revenue: data.revenue * 0.45, profit: (data.revenue - data.cogs - data.operatingExpenses) * 0.50 },
                { name: 'جدة', revenue: data.revenue * 0.30, profit: (data.revenue - data.cogs - data.operatingExpenses) * 0.30 },
                { name: 'الدمام', revenue: data.revenue * 0.25, profit: (data.revenue - data.cogs - data.operatingExpenses) * 0.20 }
            ];
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-cube"></i> تحليل الربحية حسب الأبعاد</h4>
                    
                    <ul class="nav nav-pills mb-4" id="profitDimTab" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#byProduct">حسب المنتج</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#byRegion">حسب المنطقة</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#byCustomer">حسب العميل</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#byDepartment">حسب القسم</button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="byProduct">
                            <h5 class="mb-3">الربحية حسب المنتج</h5>
                            <table class="table table-striped table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>المنتج</th>
                                        <th class="text-end">الإيرادات</th>
                                        <th class="text-end">التكلفة</th>
                                        <th class="text-end">الربح</th>
                                        <th class="text-end">هامش الربح</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${products.map(p => `
                                        <tr>
                                            <td><strong>${p.name}</strong></td>
                                            <td class="text-end">${formatCurrency(p.revenue)}</td>
                                            <td class="text-end text-danger">${formatCurrency(p.cost)}</td>
                                            <td class="text-end ${p.profit > 0 ? 'text-success' : 'text-danger'}">
                                                ${formatCurrency(p.profit)}
                                            </td>
                                            <td class="text-end">${(p.profit / p.revenue * 100).toFixed(1)}%</td>
                                        </tr>
                                    `).join('')}
                                    <tr class="table-primary">
                                        <td><strong>الإجمالي</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(products.reduce((sum, p) => sum + p.revenue, 0))}</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(products.reduce((sum, p) => sum + p.cost, 0))}</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(products.reduce((sum, p) => sum + p.profit, 0))}</strong></td>
                                        <td class="text-end"><strong>${(products.reduce((sum, p) => sum + p.profit, 0) / products.reduce((sum, p) => sum + p.revenue, 0) * 100).toFixed(1)}%</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="chart-container mt-4">
                                <canvas id="productProfitChart"></canvas>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="byRegion">
                            <h5 class="mb-3">الربحية حسب المنطقة</h5>
                            <table class="table table-striped table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>المنطقة</th>
                                        <th class="text-end">الإيرادات</th>
                                        <th class="text-end">الربح</th>
                                        <th class="text-end">هامش الربح</th>
                                        <th class="text-end">المساهمة %</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${regions.map(r => `
                                        <tr>
                                            <td><strong>${r.name}</strong></td>
                                            <td class="text-end">${formatCurrency(r.revenue)}</td>
                                            <td class="text-end text-success">${formatCurrency(r.profit)}</td>
                                            <td class="text-end">${(r.profit / r.revenue * 100).toFixed(1)}%</td>
                                            <td class="text-end">${(r.revenue / data.revenue * 100).toFixed(1)}%</td>
                                        </tr>
                                    `).join('')}
                                    <tr class="table-primary">
                                        <td><strong>الإجمالي</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(regions.reduce((sum, r) => sum + r.revenue, 0))}</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(regions.reduce((sum, r) => sum + r.profit, 0))}</strong></td>
                                        <td class="text-end"><strong>${(regions.reduce((sum, r) => sum + r.profit, 0) / regions.reduce((sum, r) => sum + r.revenue, 0) * 100).toFixed(1)}%</strong></td>
                                        <td class="text-end"><strong>100%</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="chart-container mt-4">
                                <canvas id="regionProfitChart"></canvas>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="byCustomer">
                            <h5 class="mb-3">الربحية حسب العميل</h5>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> تحليل العملاء الأكثر ربحية (Pareto Analysis - 80/20)
                            </div>
                            <table class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>العميل</th>
                                        <th class="text-end">الإيرادات</th>
                                        <th class="text-end">الربح</th>
                                        <th class="text-end">المساهمة التراكمية</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>عميل كبير أ</td>
                                        <td class="text-end">${formatCurrency(data.revenue * 0.35)}</td>
                                        <td class="text-end">${formatCurrency((data.revenue - data.cogs - data.operatingExpenses) * 0.40)}</td>
                                        <td class="text-end">40%</td>
                                    </tr>
                                    <tr>
                                        <td>عميل كبير ب</td>
                                        <td class="text-end">${formatCurrency(data.revenue * 0.25)}</td>
                                        <td class="text-end">${formatCurrency((data.revenue - data.cogs - data.operatingExpenses) * 0.30)}</td>
                                        <td class="text-end">70%</td>
                                    </tr>
                                    <tr>
                                        <td>عملاء متوسطون (15 عميل)</td>
                                        <td class="text-end">${formatCurrency(data.revenue * 0.30)}</td>
                                        <td class="text-end">${formatCurrency((data.revenue - data.cogs - data.operatingExpenses) * 0.25)}</td>
                                        <td class="text-end">95%</td>
                                    </tr>
                                    <tr>
                                        <td>عملاء صغار (50 عميل)</td>
                                        <td class="text-end">${formatCurrency(data.revenue * 0.10)}</td>
                                        <td class="text-end">${formatCurrency((data.revenue - data.cogs - data.operatingExpenses) * 0.05)}</td>
                                        <td class="text-end">100%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="tab-pane fade" id="byDepartment">
                            <h5 class="mb-3">الربحية حسب القسم</h5>
                            <table class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>القسم</th>
                                        <th class="text-end">الإيرادات</th>
                                        <th class="text-end">المصروفات</th>
                                        <th class="text-end">الربح</th>
                                        <th class="text-end">هامش الربح</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>قسم المبيعات</td>
                                        <td class="text-end">${formatCurrency(data.revenue * 0.6)}</td>
                                        <td class="text-end">${formatCurrency(data.operatingExpenses * 0.3)}</td>
                                        <td class="text-end text-success">${formatCurrency(data.revenue * 0.6 - data.operatingExpenses * 0.3)}</td>
                                        <td class="text-end">${((data.revenue * 0.6 - data.operatingExpenses * 0.3) / (data.revenue * 0.6) * 100).toFixed(1)}%</td>
                                    </tr>
                                    <tr>
                                        <td>قسم الخدمات</td>
                                        <td class="text-end">${formatCurrency(data.revenue * 0.4)}</td>
                                        <td class="text-end">${formatCurrency(data.operatingExpenses * 0.25)}</td>
                                        <td class="text-end text-success">${formatCurrency(data.revenue * 0.4 - data.operatingExpenses * 0.25)}</td>
                                        <td class="text-end">${((data.revenue * 0.4 - data.operatingExpenses * 0.25) / (data.revenue * 0.4) * 100).toFixed(1)}%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }


        function generateWorkingCapital(data) {
            const workingCapital = data.currentAssets - data.currentLiabilities;
            const currentRatio = (data.currentAssets / data.currentLiabilities).toFixed(2);
            const quickRatio = ((data.currentAssets * 0.7) / data.currentLiabilities).toFixed(2);
            
            // Cash Conversion Cycle components
            const dso = 45; // Days Sales Outstanding
            const dio = 60; // Days Inventory Outstanding
            const dpo = 30; // Days Payable Outstanding
            const ccc = dso + dio - dpo;
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-cogs"></i> تحليل رأس المال العامل</h4>
                    
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stats-card ${workingCapital > 0 ? 'border-success' : 'border-danger'}">
                                <h6>رأس المال العامل</h6>
                                <h3 class="${workingCapital > 0 ? 'text-success' : 'text-danger'}">
                                    ${formatCurrency(workingCapital)}
                                </h3>
                                <p>${workingCapital > 0 ? 'إيجابي' : 'سلبي'}</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card ${currentRatio > 2 ? 'border-success' : currentRatio > 1 ? 'border-warning' : 'border-danger'}">
                                <h6>النسبة الحالية</h6>
                                <h3 class="${currentRatio > 2 ? 'text-success' : currentRatio > 1 ? 'text-warning' : 'text-danger'}">
                                    ${currentRatio}
                                </h3>
                                <p>Current Ratio</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card ${quickRatio > 1 ? 'border-success' : 'border-warning'}">
                                <h6>نسبة السيولة السريعة</h6>
                                <h3 class="${quickRatio > 1 ? 'text-success' : 'text-warning'}">
                                    ${quickRatio}
                                </h3>
                                <p>Quick Ratio</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card ${ccc < 60 ? 'border-success' : ccc < 90 ? 'border-warning' : 'border-danger'}">
                                <h6>دورة التحويل النقدي</h6>
                                <h3 class="${ccc < 60 ? 'text-success' : ccc < 90 ? 'text-warning' : 'text-danger'}">
                                    ${ccc} يوم
                                </h3>
                                <p>CCC</p>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-dark border-primary mb-4">
                        <div class="card-body">
                            <h6 class="card-title">مكونات دورة التحويل النقدي (CCC)</h6>
                            <div class="row text-center mt-3">
                                <div class="col-md-4">
                                    <div class="p-3 border border-info rounded">
                                        <h5 class="text-info">${dso} يوم</h5>
                                        <p class="mb-0 small">فترة تحصيل المبيعات (DSO)</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-3 border border-warning rounded">
                                        <h5 class="text-warning">${dio} يوم</h5>
                                        <p class="mb-0 small">فترة دوران المخزون (DIO)</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-3 border border-success rounded">
                                        <h5 class="text-success">${dpo} يوم</h5>
                                        <p class="mb-0 small">فترة سداد الموردين (DPO)</p>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <p class="mb-0"><strong>CCC = DSO + DIO - DPO = ${dso} + ${dio} - ${dpo} = ${ccc} يوم</strong></p>
                            </div>
                        </div>
                    </div>

                    <table class="table table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>المؤشر</th>
                                <th class="text-end">القيمة</th>
                                <th>التقييم</th>
                                <th>التوصية</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>رأس المال العامل</td>
                                <td class="text-end">${formatCurrency(workingCapital)}</td>
                                <td>${workingCapital > data.revenue * 0.1 ? '✅ ممتاز' : workingCapital > 0 ? '⚠️ مقبول' : '❌ ضعيف'}</td>
                                <td>${workingCapital > 0 ? 'الحفاظ على المستوى الحالي' : 'تحسين التحصيل وإدارة المخزون'}</td>
                            </tr>
                            <tr>
                                <td>النسبة الحالية</td>
                                <td class="text-end">${currentRatio}</td>
                                <td>${currentRatio > 2 ? '✅ ممتاز' : currentRatio > 1 ? '⚠️ مقبول' : '❌ ضعيف'}</td>
                                <td>${currentRatio > 1.5 ? 'وضع سيولة جيد' : 'تحسين الأصول المتداولة'}</td>
                            </tr>
                            <tr>
                                <td>نسبة السيولة السريعة</td>
                                <td class="text-end">${quickRatio}</td>
                                <td>${quickRatio > 1 ? '✅ ممتاز' : '⚠️ مقبول'}</td>
                                <td>${quickRatio > 1 ? 'قدرة قوية على السداد الفوري' : 'تقليل الاعتماد على المخزون'}</td>
                            </tr>
                            <tr>
                                <td>دورة التحويل النقدي</td>
                                <td class="text-end">${ccc} يوم</td>
                                <td>${ccc < 60 ? '✅ ممتاز' : ccc < 90 ? '⚠️ مقبول' : '❌ يحتاج تحسين'}</td>
                                <td>${ccc < 60 ? 'كفاءة عالية في إدارة النقد' : 'تسريع التحصيل وتقليل المخزون'}</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="chart-container mt-4">
                        <canvas id="workingCapitalChart"></canvas>
                    </div>
                </div>
            `;
        }

        function generateABCCosting(data) {
            const activities = [
                { name: 'الإنتاج', cost: data.cogs * 0.6, driver: 'ساعات الماكينة', volume: 10000 },
                { name: 'التخزين', cost: data.operatingExpenses * 0.2, driver: 'وحدات مخزنة', volume: 5000 },
                { name: 'التسليم', cost: data.operatingExpenses * 0.15, driver: 'عدد الشحنات', volume: 1000 },
                { name: 'خدمة العملاء', cost: data.operatingExpenses * 0.25, driver: 'عدد الطلبات', volume: 2000 },
                { name: 'الإدارة', cost: data.operatingExpenses * 0.4, driver: 'عدد الموظفين', volume: 50 }
            ];
            
            const totalCost = activities.reduce((sum, a) => sum + a.cost, 0);
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-layer-group"></i> تحليل التكاليف على أساس الأنشطة (ABC)</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Activity-Based Costing (ABC)</strong> - توزيع التكاليف بناءً على الأنشطة الفعلية التي تستهلك الموارد
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="stats-card border-primary">
                                <h6>إجمالي التكاليف</h6>
                                <h3 class="text-primary">${formatCurrency(totalCost)}</h3>
                                <p>موزعة على ${activities.length} أنشطة</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card border-warning">
                                <h6>أكبر نشاط تكلفة</h6>
                                <h3 class="text-warning">${activities.sort((a, b) => b.cost - a.cost)[0].name}</h3>
                                <p>${formatCurrency(activities[0].cost)}</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card border-success">
                                <h6>متوسط تكلفة النشاط</h6>
                                <h3 class="text-success">${formatCurrency(totalCost / activities.length)}</h3>
                                <p>لكل نشاط</p>
                            </div>
                        </div>
                    </div>

                    <table class="table table-striped table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>النشاط</th>
                                <th>محرك التكلفة</th>
                                <th class="text-end">الحجم</th>
                                <th class="text-end">التكلفة الإجمالية</th>
                                <th class="text-end">تكلفة الوحدة</th>
                                <th class="text-end">% من الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${activities.map(a => `
                                <tr>
                                    <td><strong>${a.name}</strong></td>
                                    <td>${a.driver}</td>
                                    <td class="text-end">${a.volume.toLocaleString('ar-SA')}</td>
                                    <td class="text-end">${formatCurrency(a.cost)}</td>
                                    <td class="text-end">${formatCurrency(a.cost / a.volume)}</td>
                                    <td class="text-end">${(a.cost / totalCost * 100).toFixed(1)}%</td>
                                </tr>
                            `).join('')}
                            <tr class="table-primary">
                                <td colspan="3"><strong>الإجمالي</strong></td>
                                <td class="text-end"><strong>${formatCurrency(totalCost)}</strong></td>
                                <td class="text-end">-</td>
                                <td class="text-end"><strong>100%</strong></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card bg-dark border-primary">
                                <div class="card-body">
                                    <h6 class="card-title">توزيع التكاليف حسب النشاط</h6>
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="abcCostChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-dark border-primary">
                                <div class="card-body">
                                    <h6 class="card-title">تكلفة الوحدة لكل نشاط</h6>
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="abcUnitCostChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-success mt-4">
                        <h6><i class="fas fa-lightbulb"></i> التوصيات</h6>
                        <ul class="mb-0">
                            <li>التركيز على تحسين كفاءة نشاط "${activities.sort((a, b) => b.cost - a.cost)[0].name}" لتقليل التكاليف</li>
                            <li>مراجعة محركات التكلفة لضمان دقة التوزيع</li>
                            <li>البحث عن فرص لدمج الأنشطة المتشابهة لتقليل التكاليف الإدارية</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // ========== STRATEGY REPORTS ==========
        function generateBreakevenAnalysis(data) {
            const fixedCosts = data.operatingExpenses;
            const variableCostPerUnit = data.cogs / 10000; // Assuming 10,000 units sold
            const pricePerUnit = data.revenue / 10000;
            const contributionMargin = pricePerUnit - variableCostPerUnit;
            const breakEvenUnits = Math.ceil(fixedCosts / contributionMargin);
            const breakEvenRevenue = breakEvenUnits * pricePerUnit;
            const currentUnits = 10000;
            const marginOfSafety = currentUnits - breakEvenUnits;
            const marginOfSafetyPct = (marginOfSafety / currentUnits * 100).toFixed(1);
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-balance-scale"></i> تحليل نقطة التعادل (Break-Even Analysis)</h4>
                    
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stats-card border-warning">
                                <h6>نقطة التعادل (وحدات)</h6>
                                <h3 class="text-warning">${breakEvenUnits.toLocaleString('ar-SA')}</h3>
                                <p>وحدة</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-warning">
                                <h6>نقطة التعادل (ريال)</h6>
                                <h3 class="text-warning">${formatCurrency(breakEvenRevenue)}</h3>
                                <p>إيرادات</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-success">
                                <h6>هامش الأمان (وحدات)</h6>
                                <h3 class="text-success">${marginOfSafety.toLocaleString('ar-SA')}</h3>
                                <p>وحدة</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-success">
                                <h6>هامش الأمان %</h6>
                                <h3 class="text-success">${marginOfSafetyPct}%</h3>
                                <p>من المبيعات الحالية</p>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-dark border-primary mb-4">
                        <div class="card-body">
                            <h6 class="card-title">معادلة نقطة التعادل</h6>
                            <div class="text-center p-3">
                                <p class="mb-2"><strong>نقطة التعادل (وحدات) = التكاليف الثابتة ÷ هامش المساهمة للوحدة</strong></p>
                                <p class="mb-0">${formatCurrency(fixedCosts)} ÷ ${formatCurrency(contributionMargin)} = ${breakEvenUnits.toLocaleString('ar-SA')} وحدة</p>
                            </div>
                        </div>
                    </div>

                    <table class="table table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>البيان</th>
                                <th class="text-end">للوحدة</th>
                                <th class="text-end">الإجمالي</th>
                                <th class="text-end">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>سعر البيع</td>
                                <td class="text-end">${formatCurrency(pricePerUnit)}</td>
                                <td class="text-end">${formatCurrency(data.revenue)}</td>
                                <td class="text-end">100%</td>
                            </tr>
                            <tr>
                                <td>التكلفة المتغيرة</td>
                                <td class="text-end text-danger">${formatCurrency(variableCostPerUnit)}</td>
                                <td class="text-end text-danger">${formatCurrency(data.cogs)}</td>
                                <td class="text-end">${(data.cogs / data.revenue * 100).toFixed(1)}%</td>
                            </tr>
                            <tr class="table-primary">
                                <td><strong>هامش المساهمة</strong></td>
                                <td class="text-end"><strong>${formatCurrency(contributionMargin)}</strong></td>
                                <td class="text-end"><strong>${formatCurrency(data.revenue - data.cogs)}</strong></td>
                                <td class="text-end"><strong>${((data.revenue - data.cogs) / data.revenue * 100).toFixed(1)}%</strong></td>
                            </tr>
                            <tr>
                                <td>التكاليف الثابتة</td>
                                <td class="text-end">-</td>
                                <td class="text-end text-danger">${formatCurrency(fixedCosts)}</td>
                                <td class="text-end">-</td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>صافي الربح</strong></td>
                                <td class="text-end">-</td>
                                <td class="text-end"><strong>${formatCurrency(data.revenue - data.cogs - fixedCosts)}</strong></td>
                                <td class="text-end"><strong>${((data.revenue - data.cogs - fixedCosts) / data.revenue * 100).toFixed(1)}%</strong></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="chart-container mt-4">
                        <canvas id="breakEvenChart"></canvas>
                    </div>

                    <div class="alert ${marginOfSafetyPct > 30 ? 'alert-success' : marginOfSafetyPct > 15 ? 'alert-warning' : 'alert-danger'} mt-4">
                        <h6><i class="fas fa-shield-alt"></i> تقييم هامش الأمان</h6>
                        <p class="mb-0">
                            ${marginOfSafetyPct > 30 ? 
                                'هامش الأمان ممتاز - الشركة لديها مرونة كبيرة لاستيعاب انخفاض المبيعات' :
                                marginOfSafetyPct > 15 ?
                                'هامش الأمان مقبول - يُنصح بمراقبة المبيعات والتكاليف عن كثب' :
                                'هامش الأمان منخفض - الشركة قريبة من نقطة التعادل، يجب اتخاذ إجراءات فورية'}
                        </p>
                    </div>
                </div>
            `;
        }

        function generateWhatIfScenarios(data) {
            const baseRevenue = data.revenue;
            const baseCosts = data.cogs + data.operatingExpenses;
            const baseProfit = baseRevenue - baseCosts;
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-question-circle"></i> تحليل ماذا لو (What-If Scenarios)</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> استخدم المنزلقات أدناه لمحاكاة تأثير التغيرات في الإيرادات والتكاليف على الأرباح
                    </div>

                    <div class="card bg-dark border-primary mb-4">
                        <div class="card-body">
                            <h6 class="card-title mb-4">السيناريو الأساسي</h6>
                            <table class="table table-borderless">
                                <tbody>
                                    <tr>
                                        <td>الإيرادات</td>
                                        <td class="text-end" id="base-revenue-val">${formatCurrency(baseRevenue)}</td>
                                    </tr>
                                    <tr>
                                        <td>التكاليف</td>
                                        <td class="text-end text-danger" id="base-costs-val">${formatCurrency(baseCosts)}</td>
                                    </tr>
                                    <tr class="table-primary">
                                        <td><strong>الربح</strong></td>
                                        <td class="text-end" id="base-profit-val"><strong>${formatCurrency(baseProfit)}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label">تغيير الإيرادات: <span id="revenue-label" class="text-primary">0%</span></label>
                            <input type="range" class="form-range" id="revenue-slider" min="-50" max="50" value="0" step="5">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">تغيير التكاليف: <span id="costs-label" class="text-danger">0%</span></label>
                            <input type="range" class="form-range" id="costs-slider" min="-50" max="50" value="0" step="5">
                        </div>
                    </div>

                    <div class="card bg-dark border-success">
                        <div class="card-body">
                            <h6 class="card-title mb-4">السيناريو المتوقع</h6>
                            <table class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>البيان</th>
                                        <th class="text-end">القيمة المتوقعة</th>
                                        <th class="text-end">التغيير</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>الإيرادات</td>
                                        <td class="text-end" id="projected-revenue">${formatCurrency(baseRevenue)}</td>
                                        <td class="text-end" id="revenue-change">-</td>
                                    </tr>
                                    <tr>
                                        <td>التكاليف</td>
                                        <td class="text-end text-danger" id="projected-costs">${formatCurrency(baseCosts)}</td>
                                        <td class="text-end" id="costs-change">-</td>
                                    </tr>
                                    <tr class="table-success">
                                        <td><strong>الربح</strong></td>
                                        <td class="text-end" id="projected-profit"><strong>${formatCurrency(baseProfit)}</strong></td>
                                        <td class="text-end" id="profit-change"><strong>-</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card bg-dark border-primary">
                                <div class="card-body">
                                    <h6 class="card-title">تحليل الحساسية</h6>
                                    <div class="chart-container">
                                        <canvas id="sensitivityChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-warning mt-4">
                        <h6><i class="fas fa-lightbulb"></i> سيناريوهات شائعة</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <button class="btn btn-sm btn-outline-warning w-100" onclick="applyScenario(10, -5)">
                                    نمو متفائل<br><small>+10% إيرادات، -5% تكاليف</small>
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-sm btn-outline-info w-100" onclick="applyScenario(5, 0)">
                                    نمو معتدل<br><small>+5% إيرادات، تكاليف ثابتة</small>
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-sm btn-outline-danger w-100" onclick="applyScenario(-10, 5)">
                                    ركود<br><small>-10% إيرادات، +5% تكاليف</small>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateIntegratedReport(data) {
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-project-diagram"></i> التقرير المتكامل (Integrated Report)</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> التقرير المتكامل يعرض كيفية خلق القيمة عبر 6 رؤوس أموال رأسمالية
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="stats-card border-primary">
                                <i class="fas fa-coins fa-2x text-primary mb-2"></i>
                                <h6>رأس المال المالي</h6>
                                <h5>${formatCurrency(data.equity)}</h5>
                                <p class="small mb-0">حقوق الملكية والموارد المالية</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card border-success">
                                <i class="fas fa-industry fa-2x text-success mb-2"></i>
                                <h6>رأس المال الصناعي</h6>
                                <h5>${formatCurrency(data.fixedAssets)}</h5>
                                <p class="small mb-0">الأصول الثابتة والبنية التحتية</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card border-info">
                                <i class="fas fa-brain fa-2x text-info mb-2"></i>
                                <h6>رأس المال الفكري</h6>
                                <h5>عالي</h5>
                                <p class="small mb-0">الملكية الفكرية والابتكار</p>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="stats-card border-warning">
                                <i class="fas fa-users fa-2x text-warning mb-2"></i>
                                <h6>رأس المال البشري</h6>
                                <h5>50 موظف</h5>
                                <p class="small mb-0">المهارات والخبرات والكفاءات</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card border-danger">
                                <i class="fas fa-handshake fa-2x text-danger mb-2"></i>
                                <h6>رأس المال الاجتماعي</h6>
                                <h5>ممتاز</h5>
                                <p class="small mb-0">العلاقات مع أصحاب المصلحة</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card border-success">
                                <i class="fas fa-leaf fa-2x text-success mb-2"></i>
                                <h6>رأس المال الطبيعي</h6>
                                <h5>مستدام</h5>
                                <p class="small mb-0">الموارد البيئية والاستدامة</p>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-dark border-primary mb-4">
                        <div class="card-body">
                            <h6 class="card-title">نموذج خلق القيمة</h6>
                            <div class="chart-container" style="height: 400px;">
                                <canvas id="integratedReportChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="accordion" id="capitalAccordion">
                        <div class="accordion-item bg-dark">
                            <h2 class="accordion-header">
                                <button class="accordion-button bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#financial">
                                    <i class="fas fa-coins text-primary me-2"></i> رأس المال المالي
                                </button>
                            </h2>
                            <div id="financial" class="accordion-collapse collapse show">
                                <div class="accordion-body">
                                    <p><strong>المدخلات:</strong> رأس المال ${formatCurrency(data.equity)}, قروض ${formatCurrency(data.longTermLiabilities)}</p>
                                    <p><strong>الأنشطة:</strong> الاستثمار في الأصول، التمويل التشغيلي، إدارة المخاطر المالية</p>
                                    <p><strong>المخرجات:</strong> إيرادات ${formatCurrency(data.revenue)}, ربح صافي ${formatCurrency(data.revenue - data.cogs - data.operatingExpenses)}</p>
                                    <p class="mb-0"><strong>النتائج:</strong> عائد على حقوق الملكية ${((data.revenue - data.cogs - data.operatingExpenses) / data.equity * 100).toFixed(1)}%</p>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item bg-dark">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#manufactured">
                                    <i class="fas fa-industry text-success me-2"></i> رأس المال الصناعي
                                </button>
                            </h2>
                            <div id="manufactured" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <p><strong>المدخلات:</strong> أصول ثابتة ${formatCurrency(data.fixedAssets)}, استثمارات رأسمالية</p>
                                    <p><strong>الأنشطة:</strong> الإنتاج، الصيانة، التطوير والتحديث</p>
                                    <p><strong>المخرجات:</strong> طاقة إنتاجية عالية، كفاءة تشغيلية</p>
                                    <p class="mb-0"><strong>النتائج:</strong> معدل دوران الأصول ${(data.revenue / (data.currentAssets + data.fixedAssets)).toFixed(2)}x</p>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item bg-dark">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#intellectual">
                                    <i class="fas fa-brain text-info me-2"></i> رأس المال الفكري
                                </button>
                            </h2>
                            <div id="intellectual" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <p><strong>المدخلات:</strong> البحث والتطوير، براءات الاختراع، العلامة التجارية</p>
                                    <p><strong>الأنشطة:</strong> الابتكار، تطوير المنتجات، حماية الملكية الفكرية</p>
                                    <p><strong>المخرجات:</strong> منتجات جديدة، ميزة تنافسية</p>
                                    <p class="mb-0"><strong>النتائج:</strong> حصة سوقية متنامية، ولاء العملاء</p>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item bg-dark">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#human">
                                    <i class="fas fa-users text-warning me-2"></i> رأس المال البشري
                                </button>
                            </h2>
                            <div id="human" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <p><strong>المدخلات:</strong> 50 موظف، برامج تدريب وتطوير</p>
                                    <p><strong>الأنشطة:</strong> التوظيف، التدريب، تطوير المهارات، الاحتفاظ بالمواهب</p>
                                    <p><strong>المخرجات:</strong> إنتاجية عالية، رضا الموظفين 85%</p>
                                    <p class="mb-0"><strong>النتائج:</strong> معدل دوران الموظفين منخفض، ثقافة مؤسسية قوية</p>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item bg-dark">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#social">
                                    <i class="fas fa-handshake text-danger me-2"></i> رأس المال الاجتماعي
                                </button>
                            </h2>
                            <div id="social" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <p><strong>المدخلات:</strong> علاقات مع العملاء، الموردين، المجتمع</p>
                                    <p><strong>الأنشطة:</strong> المسؤولية الاجتماعية، الشراكات، التواصل مع أصحاب المصلحة</p>
                                    <p><strong>المخرجات:</strong> سمعة قوية، ثقة العملاء</p>
                                    <p class="mb-0"><strong>النتائج:</strong> معدل احتفاظ بالعملاء 90%، رضا العملاء 88%</p>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item bg-dark">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#natural">
                                    <i class="fas fa-leaf text-success me-2"></i> رأس المال الطبيعي
                                </button>
                            </h2>
                            <div id="natural" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <p><strong>المدخلات:</strong> الموارد الطبيعية، الطاقة، المياه</p>
                                    <p><strong>الأنشطة:</strong> الإدارة البيئية، تقليل الانبعاثات، إعادة التدوير</p>
                                    <p><strong>المخرجات:</strong> انخفاض البصمة الكربونية بنسبة 15%</p>
                                    <p class="mb-0"><strong>النتائج:</strong> امتثال بيئي كامل، شهادات الاستدامة</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateDCFValuation(data) {
            const fcff = data.cashFlow;
            const wacc = 0.10; // 10% WACC
            const growthRate = 0.03; // 3% perpetual growth
            const projectionYears = 5;
            
            let npv = 0;
            let projections = [];
            
            for (let i = 1; i <= projectionYears; i++) {
                const fcf = fcff * Math.pow(1.05, i);
                const pv = fcf / Math.pow(1 + wacc, i);
                npv += pv;
                projections.push({ year: i, fcf, pv });
            }
            
            const terminalValue = (projections[projectionYears - 1].fcf * (1 + growthRate)) / (wacc - growthRate);
            const pvTerminal = terminalValue / Math.pow(1 + wacc, projectionYears);
            const enterpriseValue = npv + pvTerminal;
            const equityValue = enterpriseValue - data.longTermLiabilities + (data.currentAssets * 0.2);
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-calculator"></i> تقييم الشركة بطريقة DCF</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Discounted Cash Flow (DCF)</strong> - تقييم الشركة بناءً على القيمة الحالية للتدفقات النقدية المستقبلية
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="stats-card border-primary">
                                <h6>قيمة المنشأة</h6>
                                <h3 class="text-primary">${formatCurrency(enterpriseValue)}</h3>
                                <p>Enterprise Value</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card border-success">
                                <h6>قيمة حقوق الملكية</h6>
                                <h3 class="text-success">${formatCurrency(equityValue)}</h3>
                                <p>Equity Value</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card border-warning">
                                <h6>مضاعف القيمة الدفترية</h6>
                                <h3 class="text-warning">${(equityValue / data.equity).toFixed(2)}x</h3>
                                <p>P/B Ratio</p>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-dark border-primary mb-4">
                        <div class="card-body">
                            <h6 class="card-title">الافتراضات الرئيسية</h6>
                            <table class="table table-sm table-borderless">
                                <tbody>
                                    <tr>
                                        <td>المتوسط المرجح لتكلفة رأس المال (WACC)</td>
                                        <td class="text-end"><strong>${(wacc * 100).toFixed(1)}%</strong></td>
                                    </tr>
                                    <tr>
                                        <td>معدل النمو الدائم (Terminal Growth)</td>
                                        <td class="text-end"><strong>${(growthRate * 100).toFixed(1)}%</strong></td>
                                    </tr>
                                    <tr>
                                        <td>فترة التوقعات</td>
                                        <td class="text-end"><strong>${projectionYears} سنوات</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <table class="table table-striped table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>السنة</th>
                                <th class="text-end">التدفق النقدي الحر (FCFF)</th>
                                <th class="text-end">معامل الخصم</th>
                                <th class="text-end">القيمة الحالية (PV)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${projections.map(p => `
                                <tr>
                                    <td>السنة ${p.year}</td>
                                    <td class="text-end">${formatCurrency(p.fcf)}</td>
                                    <td class="text-end">${(1 / Math.pow(1 + wacc, p.year)).toFixed(4)}</td>
                                    <td class="text-end">${formatCurrency(p.pv)}</td>
                                </tr>
                            `).join('')}
                            <tr class="table-primary">
                                <td colspan="3"><strong>مجموع القيمة الحالية للتدفقات</strong></td>
                                <td class="text-end"><strong>${formatCurrency(npv)}</strong></td>
                            </tr>
                            <tr class="table-info">
                                <td colspan="3"><strong>القيمة النهائية (Terminal Value)</strong></td>
                                <td class="text-end"><strong>${formatCurrency(terminalValue)}</strong></td>
                            </tr>
                            <tr class="table-info">
                                <td colspan="3"><strong>القيمة الحالية للقيمة النهائية</strong></td>
                                <td class="text-end"><strong>${formatCurrency(pvTerminal)}</strong></td>
                            </tr>
                            <tr class="table-success">
                                <td colspan="3"><strong>قيمة المنشأة (Enterprise Value)</strong></td>
                                <td class="text-end"><strong>${formatCurrency(enterpriseValue)}</strong></td>
                            </tr>
                            <tr>
                                <td colspan="3">(-) صافي الدين</td>
                                <td class="text-end text-danger">(${formatCurrency(data.longTermLiabilities - data.currentAssets * 0.2)})</td>
                            </tr>
                            <tr class="table-success">
                                <td colspan="3"><strong>قيمة حقوق الملكية (Equity Value)</strong></td>
                                <td class="text-end"><strong>${formatCurrency(equityValue)}</strong></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="chart-container mt-4">
                        <canvas id="dcfChart"></canvas>
                    </div>

                    <div class="alert alert-success mt-4">
                        <h6><i class="fas fa-chart-line"></i> التفسير</h6>
                        <p class="mb-0">
                            بناءً على تحليل DCF، تبلغ القيمة العادلة لحقوق الملكية ${formatCurrency(equityValue)}، 
                            وهو ما يمثل ${(equityValue / data.equity).toFixed(2)} ضعف القيمة الدفترية الحالية.
                            ${equityValue > data.equity ? 
                                'هذا يشير إلى أن الشركة تخلق قيمة إضافية من خلال عملياتها.' :
                                'قد يشير هذا إلى الحاجة لمراجعة الافتراضات أو تحسين الأداء التشغيلي.'}
                        </p>
                    </div>
                </div>
            `;
        }


        function generateRIMValuation(data) {
            const bookValue = data.equity;
            const roe = (data.revenue - data.cogs - data.operatingExpenses) / data.equity;
            const costOfEquity = 0.12; // 12%
            const residualIncome = data.equity * (roe - costOfEquity);
            const pvResidualIncome = residualIncome / costOfEquity; // Simplified perpetuity
            const equityValue = bookValue + pvResidualIncome;
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-money-bill-wave"></i> نموذج الدخل المتبقي (RIM)</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Residual Income Model</strong> - التقييم بناءً على القيمة الدفترية مضافاً إليها القيمة الحالية للأرباح المتبقية
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="stats-card border-primary">
                                <h6>القيمة الدفترية</h6>
                                <h3 class="text-primary">${formatCurrency(bookValue)}</h3>
                                <p>Book Value</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card border-warning">
                                <h6>الدخل المتبقي السنوي</h6>
                                <h3 class="text-warning">${formatCurrency(residualIncome)}</h3>
                                <p>Residual Income</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card border-success">
                                <h6>قيمة حقوق الملكية</h6>
                                <h3 class="text-success">${formatCurrency(equityValue)}</h3>
                                <p>Equity Value</p>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-dark border-primary mb-4">
                        <div class="card-body">
                            <h6 class="card-title">معادلة RIM</h6>
                            <div class="text-center p-3">
                                <p class="mb-2"><strong>قيمة حقوق الملكية = القيمة الدفترية + القيمة الحالية للدخل المتبقي</strong></p>
                                <p class="mb-2"><strong>الدخل المتبقي = صافي الربح - (حقوق الملكية × تكلفة حقوق الملكية)</strong></p>
                                <p class="mb-0">${formatCurrency(bookValue)} + ${formatCurrency(pvResidualIncome)} = ${formatCurrency(equityValue)}</p>
                            </div>
                        </div>
                    </div>

                    <table class="table table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>البيان</th>
                                <th class="text-end">القيمة</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>القيمة الدفترية لحقوق الملكية</td>
                                <td class="text-end">${formatCurrency(bookValue)}</td>
                            </tr>
                            <tr>
                                <td>صافي الربح</td>
                                <td class="text-end">${formatCurrency(data.revenue - data.cogs - data.operatingExpenses)}</td>
                            </tr>
                            <tr>
                                <td>العائد على حقوق الملكية (ROE)</td>
                                <td class="text-end">${(roe * 100).toFixed(2)}%</td>
                            </tr>
                            <tr>
                                <td>تكلفة حقوق الملكية</td>
                                <td class="text-end">${(costOfEquity * 100).toFixed(1)}%</td>
                            </tr>
                            <tr class="table-primary">
                                <td><strong>الدخل المتبقي السنوي</strong></td>
                                <td class="text-end"><strong>${formatCurrency(residualIncome)}</strong></td>
                            </tr>
                            <tr>
                                <td>القيمة الحالية للدخل المتبقي (Perpetuity)</td>
                                <td class="text-end">${formatCurrency(pvResidualIncome)}</td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>قيمة حقوق الملكية (RIM)</strong></td>
                                <td class="text-end"><strong>${formatCurrency(equityValue)}</strong></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="alert ${residualIncome > 0 ? 'alert-success' : 'alert-warning'} mt-4">
                        <h6><i class="fas fa-info-circle"></i> التفسير</h6>
                        <p class="mb-0">
                            ${residualIncome > 0 ? 
                                `الشركة تحقق دخلاً متبقياً إيجابياً قدره ${formatCurrency(residualIncome)}، مما يعني أن العائد على حقوق الملكية (${(roe * 100).toFixed(2)}%) يفوق تكلفة حقوق الملكية (${(costOfEquity * 100).toFixed(1)}%). هذا يشير إلى خلق قيمة للمساهمين.` :
                                `الشركة لا تحقق دخلاً متبقياً إيجابياً، مما يعني أن العائد على حقوق الملكية أقل من تكلفة حقوق الملكية. يُنصح بتحسين الربحية.`}
                        </p>
                    </div>
                </div>
            `;
        }

        function generateDDMValuation(data) {
            const dividend = (data.revenue - data.cogs - data.operatingExpenses) * 0.4; // 40% payout ratio
            const growthRate = 0.05; // 5% growth
            const requiredReturn = 0.12; // 12%
            const equityValue = dividend * (1 + growthRate) / (requiredReturn - growthRate);
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-percentage"></i> نموذج خصم الأرباح (DDM)</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Dividend Discount Model</strong> - تقييم الشركة بناءً على القيمة الحالية لتوزيعات الأرباح المستقبلية
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stats-card border-primary">
                                <h6>التوزيعات الحالية</h6>
                                <h3 class="text-primary">${formatCurrency(dividend)}</h3>
                                <p>Dividend</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-info">
                                <h6>معدل النمو</h6>
                                <h3 class="text-info">${(growthRate * 100).toFixed(1)}%</h3>
                                <p>Growth Rate</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-warning">
                                <h6>العائد المطلوب</h6>
                                <h3 class="text-warning">${(requiredReturn * 100).toFixed(1)}%</h3>
                                <p>Required Return</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-success">
                                <h6>قيمة حقوق الملكية</h6>
                                <h3 class="text-success">${formatCurrency(equityValue)}</h3>
                                <p>Equity Value</p>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-dark border-primary mb-4">
                        <div class="card-body">
                            <h6 class="card-title">معادلة Gordon Growth Model</h6>
                            <div class="text-center p-3">
                                <p class="mb-2"><strong>القيمة = D₁ ÷ (r - g)</strong></p>
                                <p class="mb-2">حيث: D₁ = التوزيعات المتوقعة للسنة القادمة، r = العائد المطلوب، g = معدل النمو</p>
                                <p class="mb-0">${formatCurrency(dividend * (1 + growthRate))} ÷ (${(requiredReturn * 100).toFixed(1)}% - ${(growthRate * 100).toFixed(1)}%) = ${formatCurrency(equityValue)}</p>
                            </div>
                        </div>
                    </div>

                    <table class="table table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>السنة</th>
                                <th class="text-end">التوزيعات المتوقعة</th>
                                <th class="text-end">معامل الخصم</th>
                                <th class="text-end">القيمة الحالية</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${[1, 2, 3, 4, 5].map(year => {
                                const div = dividend * Math.pow(1 + growthRate, year);
                                const discountFactor = 1 / Math.pow(1 + requiredReturn, year);
                                const pv = div * discountFactor;
                                return `
                                    <tr>
                                        <td>السنة ${year}</td>
                                        <td class="text-end">${formatCurrency(div)}</td>
                                        <td class="text-end">${discountFactor.toFixed(4)}</td>
                                        <td class="text-end">${formatCurrency(pv)}</td>
                                    </tr>
                                `;
                            }).join('')}
                            <tr class="table-info">
                                <td colspan="3"><strong>القيمة النهائية (بعد السنة 5)</strong></td>
                                <td class="text-end"><strong>${formatCurrency(equityValue * 0.7)}</strong></td>
                            </tr>
                            <tr class="table-success">
                                <td colspan="3"><strong>إجمالي قيمة حقوق الملكية</strong></td>
                                <td class="text-end"><strong>${formatCurrency(equityValue)}</strong></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="chart-container mt-4">
                        <canvas id="ddmChart"></canvas>
                    </div>

                    <div class="alert alert-warning mt-4">
                        <h6><i class="fas fa-exclamation-triangle"></i> ملاحظات هامة</h6>
                        <ul class="mb-0">
                            <li>النموذج يفترض نمواً ثابتاً في التوزيعات</li>
                            <li>مناسب للشركات التي توزع أرباحاً بانتظام</li>
                            <li>حساس جداً للافتراضات (معدل النمو والعائد المطلوب)</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function generateDupontAnalysis(data) {
            const netProfit = data.revenue - data.cogs - data.operatingExpenses;
            const profitMargin = netProfit / data.revenue;
            const assetTurnover = data.revenue / (data.currentAssets + data.fixedAssets);
            const equityMultiplier = (data.currentAssets + data.fixedAssets) / data.equity;
            const roe = profitMargin * assetTurnover * equityMultiplier;
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-sitemap"></i> تحليل دوبونت (DuPont Analysis)</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> تحليل دوبونت يفكك العائد على حقوق الملكية (ROE) إلى ثلاثة مكونات رئيسية
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stats-card border-primary">
                                <h6>هامش الربح</h6>
                                <h3 class="text-primary">${(profitMargin * 100).toFixed(2)}%</h3>
                                <p>Profit Margin</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-info">
                                <h6>دوران الأصول</h6>
                                <h3 class="text-info">${assetTurnover.toFixed(2)}x</h3>
                                <p>Asset Turnover</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-warning">
                                <h6>مضاعف حقوق الملكية</h6>
                                <h3 class="text-warning">${equityMultiplier.toFixed(2)}x</h3>
                                <p>Equity Multiplier</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-success">
                                <h6>العائد على حقوق الملكية</h6>
                                <h3 class="text-success">${(roe * 100).toFixed(2)}%</h3>
                                <p>ROE</p>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-dark border-primary mb-4">
                        <div class="card-body">
                            <h6 class="card-title">معادلة دوبونت</h6>
                            <div class="text-center p-3">
                                <p class="mb-2"><strong>ROE = هامش الربح × دوران الأصول × مضاعف حقوق الملكية</strong></p>
                                <p class="mb-0">${(profitMargin * 100).toFixed(2)}% × ${assetTurnover.toFixed(2)} × ${equityMultiplier.toFixed(2)} = ${(roe * 100).toFixed(2)}%</p>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card bg-dark border-primary">
                                <div class="card-body">
                                    <h6 class="card-title text-primary"><i class="fas fa-percent"></i> هامش الربح</h6>
                                    <p class="small">يقيس كفاءة الشركة في تحويل المبيعات إلى أرباح</p>
                                    <table class="table table-sm table-borderless">
                                        <tbody>
                                            <tr>
                                                <td>صافي الربح</td>
                                                <td class="text-end">${formatCurrency(netProfit)}</td>
                                            </tr>
                                            <tr>
                                                <td>÷ الإيرادات</td>
                                                <td class="text-end">${formatCurrency(data.revenue)}</td>
                                            </tr>
                                            <tr class="table-primary">
                                                <td><strong>= هامش الربح</strong></td>
                                                <td class="text-end"><strong>${(profitMargin * 100).toFixed(2)}%</strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card bg-dark border-info">
                                <div class="card-body">
                                    <h6 class="card-title text-info"><i class="fas fa-sync"></i> دوران الأصول</h6>
                                    <p class="small">يقيس كفاءة الشركة في استخدام أصولها لتوليد الإيرادات</p>
                                    <table class="table table-sm table-borderless">
                                        <tbody>
                                            <tr>
                                                <td>الإيرادات</td>
                                                <td class="text-end">${formatCurrency(data.revenue)}</td>
                                            </tr>
                                            <tr>
                                                <td>÷ إجمالي الأصول</td>
                                                <td class="text-end">${formatCurrency(data.currentAssets + data.fixedAssets)}</td>
                                            </tr>
                                            <tr class="table-info">
                                                <td><strong>= دوران الأصول</strong></td>
                                                <td class="text-end"><strong>${assetTurnover.toFixed(2)}x</strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card bg-dark border-warning">
                                <div class="card-body">
                                    <h6 class="card-title text-warning"><i class="fas fa-layer-group"></i> مضاعف حقوق الملكية</h6>
                                    <p class="small">يقيس الرافعة المالية (استخدام الديون)</p>
                                    <table class="table table-sm table-borderless">
                                        <tbody>
                                            <tr>
                                                <td>إجمالي الأصول</td>
                                                <td class="text-end">${formatCurrency(data.currentAssets + data.fixedAssets)}</td>
                                            </tr>
                                            <tr>
                                                <td>÷ حقوق الملكية</td>
                                                <td class="text-end">${formatCurrency(data.equity)}</td>
                                            </tr>
                                            <tr class="table-warning">
                                                <td><strong>= المضاعف</strong></td>
                                                <td class="text-end"><strong>${equityMultiplier.toFixed(2)}x</strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="dupontChart"></canvas>
                    </div>

                    <div class="alert alert-success mt-4">
                        <h6><i class="fas fa-lightbulb"></i> التوصيات</h6>
                        <ul class="mb-0">
                            <li><strong>هامش الربح (${(profitMargin * 100).toFixed(2)}%):</strong> ${profitMargin > 0.15 ? 'ممتاز - استمر في التحكم بالتكاليف' : 'يحتاج تحسين - راجع هيكل التكاليف'}</li>
                            <li><strong>دوران الأصول (${assetTurnover.toFixed(2)}x):</strong> ${assetTurnover > 1 ? 'جيد - استخدام فعال للأصول' : 'منخفض - حسّن كفاءة استخدام الأصول'}</li>
                            <li><strong>مضاعف حقوق الملكية (${equityMultiplier.toFixed(2)}x):</strong> ${equityMultiplier < 3 ? 'رافعة مالية معتدلة' : 'رافعة مالية عالية - راقب المخاطر'}</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function generateEVAAnalysis(data) {
            const nopat = (data.revenue - data.cogs - data.operatingExpenses) * 0.75; // After tax
            const investedCapital = data.equity + data.longTermLiabilities;
            const wacc = 0.10; // 10%
            const eva = nopat - (investedCapital * wacc);
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-chart-area"></i> القيمة الاقتصادية المضافة (EVA)</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Economic Value Added</strong> - يقيس الربح الاقتصادي الحقيقي بعد خصم تكلفة رأس المال
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stats-card border-primary">
                                <h6>NOPAT</h6>
                                <h3 class="text-primary">${formatCurrency(nopat)}</h3>
                                <p>صافي الربح التشغيلي بعد الضريبة</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-info">
                                <h6>رأس المال المستثمر</h6>
                                <h3 class="text-info">${formatCurrency(investedCapital)}</h3>
                                <p>Invested Capital</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-warning">
                                <h6>WACC</h6>
                                <h3 class="text-warning">${(wacc * 100).toFixed(1)}%</h3>
                                <p>المتوسط المرجح لتكلفة رأس المال</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card ${eva > 0 ? 'border-success' : 'border-danger'}">
                                <h6>EVA</h6>
                                <h3 class="${eva > 0 ? 'text-success' : 'text-danger'}">${formatCurrency(eva)}</h3>
                                <p>${eva > 0 ? 'خلق قيمة ✓' : 'تدمير قيمة ✗'}</p>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-dark border-primary mb-4">
                        <div class="card-body">
                            <h6 class="card-title">معادلة EVA</h6>
                            <div class="text-center p-3">
                                <p class="mb-2"><strong>EVA = NOPAT - (رأس المال المستثمر × WACC)</strong></p>
                                <p class="mb-0">${formatCurrency(nopat)} - (${formatCurrency(investedCapital)} × ${(wacc * 100).toFixed(1)}%) = ${formatCurrency(eva)}</p>
                            </div>
                        </div>
                    </div>

                    <table class="table table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>البيان</th>
                                <th class="text-end">القيمة</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>الربح التشغيلي (EBIT)</td>
                                <td class="text-end">${formatCurrency(data.revenue - data.cogs - data.operatingExpenses)}</td>
                            </tr>
                            <tr>
                                <td>(-) الضرائب (25%)</td>
                                <td class="text-end text-danger">(${formatCurrency((data.revenue - data.cogs - data.operatingExpenses) * 0.25)})</td>
                            </tr>
                            <tr class="table-primary">
                                <td><strong>NOPAT</strong></td>
                                <td class="text-end"><strong>${formatCurrency(nopat)}</strong></td>
                            </tr>
                            <tr>
                                <td>حقوق الملكية</td>
                                <td class="text-end">${formatCurrency(data.equity)}</td>
                            </tr>
                            <tr>
                                <td>+ الديون طويلة الأجل</td>
                                <td class="text-end">${formatCurrency(data.longTermLiabilities)}</td>
                            </tr>
                            <tr class="table-info">
                                <td><strong>رأس المال المستثمر</strong></td>
                                <td class="text-end"><strong>${formatCurrency(investedCapital)}</strong></td>
                            </tr>
                            <tr>
                                <td>تكلفة رأس المال (WACC)</td>
                                <td class="text-end">${(wacc * 100).toFixed(1)}%</td>
                            </tr>
                            <tr>
                                <td>رسوم رأس المال</td>
                                <td class="text-end text-danger">(${formatCurrency(investedCapital * wacc)})</td>
                            </tr>
                            <tr class="${eva > 0 ? 'table-success' : 'table-danger'}">
                                <td><strong>EVA</strong></td>
                                <td class="text-end"><strong>${formatCurrency(eva)}</strong></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="chart-container mt-4">
                        <canvas id="evaChart"></canvas>
                    </div>

                    <div class="alert ${eva > 0 ? 'alert-success' : 'alert-danger'} mt-4">
                        <h6><i class="fas fa-${eva > 0 ? 'check-circle' : 'exclamation-triangle'}"></i> التفسير</h6>
                        <p class="mb-0">
                            ${eva > 0 ? 
                                `الشركة تخلق قيمة اقتصادية بمقدار ${formatCurrency(eva)} سنوياً. هذا يعني أن العائد على رأس المال المستثمر يفوق تكلفة رأس المال، مما يؤدي إلى زيادة ثروة المساهمين.` :
                                `الشركة تدمر قيمة اقتصادية بمقدار ${formatCurrency(Math.abs(eva))} سنوياً. العائد على رأس المال المستثمر أقل من تكلفة رأس المال. يجب تحسين الربحية أو تقليل رأس المال المستثمر.`}
                        </p>
                    </div>
                </div>
            `;
        }

        // ========== RISK REPORTS ==========
        function generateAltmanZScore(data) {
            const totalAssets = data.currentAssets + data.fixedAssets;
            const workingCapital = data.currentAssets - data.currentLiabilities;
            const retainedEarnings = data.equity * 0.4;
            const ebit = data.revenue - data.cogs - data.operatingExpenses;
            const marketValueEquity = data.equity * 1.5;
            const totalLiabilities = data.currentLiabilities + data.longTermLiabilities;
            const sales = data.revenue;
            
            const x1 = workingCapital / totalAssets;
            const x2 = retainedEarnings / totalAssets;
            const x3 = ebit / totalAssets;
            const x4 = marketValueEquity / totalLiabilities;
            const x5 = sales / totalAssets;
            
            const zScore = 1.2 * x1 + 1.4 * x2 + 3.3 * x3 + 0.6 * x4 + 1.0 * x5;
            
            let status, statusColor, statusIcon;
            if (zScore > 2.99) {
                status = 'آمن';
                statusColor = 'success';
                statusIcon = 'shield-alt';
            } else if (zScore > 1.81) {
                status = 'منطقة رمادية';
                statusColor = 'warning';
                statusIcon = 'exclamation-triangle';
            } else {
                status = 'خطر';
                statusColor = 'danger';
                statusIcon = 'skull-crossbones';
            }
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-shield-alt"></i> نموذج ألتمان للتنبؤ بالإفلاس (Z-Score)</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> نموذج ألتمان Z-Score هو أداة إحصائية للتنبؤ باحتمالية إفلاس الشركة
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="stats-card border-${statusColor}">
                                <div class="row align-items-center">
                                    <div class="col-md-4 text-center">
                                        <i class="fas fa-${statusIcon} fa-4x text-${statusColor}"></i>
                                    </div>
                                    <div class="col-md-8">
                                        <h6>Z-Score</h6>
                                        <h2 class="text-${statusColor}">${zScore.toFixed(2)}</h2>
                                        <h5 class="text-${statusColor}">${status}</h5>
                                        <p class="mb-0">
                                            ${zScore > 2.99 ? 'احتمالية الإفلاس منخفضة جداً' :
                                              zScore > 1.81 ? 'احتمالية الإفلاس متوسطة - يتطلب مراقبة' :
                                              'احتمالية الإفلاس عالية - يتطلب إجراءات فورية'}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-dark border-primary mb-4">
                        <div class="card-body">
                            <h6 class="card-title">معادلة Z-Score</h6>
                            <p class="text-center mb-2"><strong>Z = 1.2X₁ + 1.4X₂ + 3.3X₃ + 0.6X₄ + 1.0X₅</strong></p>
                            <p class="text-center small mb-0">
                                Z = 1.2(${x1.toFixed(3)}) + 1.4(${x2.toFixed(3)}) + 3.3(${x3.toFixed(3)}) + 0.6(${x4.toFixed(3)}) + 1.0(${x5.toFixed(3)}) = ${zScore.toFixed(2)}
                            </p>
                        </div>
                    </div>

                    <table class="table table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>المتغير</th>
                                <th>الوصف</th>
                                <th class="text-end">القيمة</th>
                                <th class="text-end">الوزن</th>
                                <th class="text-end">المساهمة</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>X₁</strong></td>
                                <td>رأس المال العامل / إجمالي الأصول</td>
                                <td class="text-end">${x1.toFixed(3)}</td>
                                <td class="text-end">1.2</td>
                                <td class="text-end">${(1.2 * x1).toFixed(3)}</td>
                            </tr>
                            <tr>
                                <td><strong>X₂</strong></td>
                                <td>الأرباح المحتجزة / إجمالي الأصول</td>
                                <td class="text-end">${x2.toFixed(3)}</td>
                                <td class="text-end">1.4</td>
                                <td class="text-end">${(1.4 * x2).toFixed(3)}</td>
                            </tr>
                            <tr>
                                <td><strong>X₃</strong></td>
                                <td>EBIT / إجمالي الأصول</td>
                                <td class="text-end">${x3.toFixed(3)}</td>
                                <td class="text-end">3.3</td>
                                <td class="text-end">${(3.3 * x3).toFixed(3)}</td>
                            </tr>
                            <tr>
                                <td><strong>X₄</strong></td>
                                <td>القيمة السوقية لحقوق الملكية / إجمالي الخصوم</td>
                                <td class="text-end">${x4.toFixed(3)}</td>
                                <td class="text-end">0.6</td>
                                <td class="text-end">${(0.6 * x4).toFixed(3)}</td>
                            </tr>
                            <tr>
                                <td><strong>X₅</strong></td>
                                <td>المبيعات / إجمالي الأصول</td>
                                <td class="text-end">${x5.toFixed(3)}</td>
                                <td class="text-end">1.0</td>
                                <td class="text-end">${(1.0 * x5).toFixed(3)}</td>
                            </tr>
                            <tr class="table-${statusColor}">
                                <td colspan="4"><strong>Z-Score</strong></td>
                                <td class="text-end"><strong>${zScore.toFixed(2)}</strong></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="card bg-dark border-info mb-4">
                        <div class="card-body">
                            <h6 class="card-title">مقياس التفسير</h6>
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <div class="p-3 border border-success rounded">
                                        <h5 class="text-success">Z > 2.99</h5>
                                        <p class="mb-0 small">منطقة آمنة<br>احتمالية إفلاس منخفضة</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-3 border border-warning rounded">
                                        <h5 class="text-warning">1.81 < Z < 2.99</h5>
                                        <p class="mb-0 small">منطقة رمادية<br>غير محدد - يتطلب مراقبة</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-3 border border-danger rounded">
                                        <h5 class="text-danger">Z < 1.81</h5>
                                        <p class="mb-0 small">منطقة خطر<br>احتمالية إفلاس عالية</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="zScoreChart"></canvas>
                    </div>

                    <div class="alert alert-${statusColor} mt-4">
                        <h6><i class="fas fa-lightbulb"></i> التوصيات</h6>
                        <ul class="mb-0">
                            ${zScore > 2.99 ? `
                                <li>الشركة في وضع مالي قوي</li>
                                <li>استمر في المحافظة على السيولة والربحية</li>
                                <li>يمكن النظر في فرص التوسع والنمو</li>
                            ` : zScore > 1.81 ? `
                                <li>راقب المؤشرات المالية عن كثب</li>
                                <li>حسّن السيولة وقلل المديونية</li>
                                <li>ركز على تحسين الربحية</li>
                            ` : `
                                <li>اتخذ إجراءات فورية لتحسين الوضع المالي</li>
                                <li>أعد هيكلة الديون إن أمكن</li>
                                <li>قلل التكاليف وحسّن التدفقات النقدية</li>
                                <li>استشر مستشاراً مالياً متخصصاً</li>
                            `}
                        </ul>
                    </div>
                </div>
            `;
        }

        function generateOhlsonOScore(data) {
            const totalAssets = data.currentAssets + data.fixedAssets;
            const totalLiabilities = data.currentLiabilities + data.longTermLiabilities;
            const netIncome = data.revenue - data.cogs - data.operatingExpenses;
            const workingCapital = data.currentAssets - data.currentLiabilities;
            
            // Simplified O-Score calculation
            const t1 = -1.32;
            const t2 = -0.407 * Math.log(totalAssets / 1000000);
            const t3 = 6.03 * (totalLiabilities / totalAssets);
            const t4 = -1.43 * (workingCapital / totalAssets);
            const t5 = 0.076 * (data.currentLiabilities / data.currentAssets);
            const t6 = -2.37 * (netIncome / totalAssets);
            const t7 = -1.83 * (data.cashFlow / totalLiabilities);
            const t8 = 0.285 * (netIncome < 0 && data.cashFlow - data.operatingExpenses < 0 ? 1 : 0);
            const t9 = -0.521 * ((netIncome - (data.revenue - data.cogs - data.operatingExpenses) * 0.9) / Math.abs(netIncome) + Math.abs((data.revenue - data.cogs - data.operatingExpenses) * 0.9));
            
            const oScore = t1 + t2 + t3 + t4 + t5 + t6 + t7 + t8 + t9;
            const probability = 1 / (1 + Math.exp(-oScore));
            const probabilityPct = (probability * 100).toFixed(1);
            
            let status, statusColor;
            if (probability < 0.25) {
                status = 'منخفض';
                statusColor = 'success';
            } else if (probability < 0.50) {
                status = 'متوسط';
                statusColor = 'warning';
            } else {
                status = 'مرتفع';
                statusColor = 'danger';
            }
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-chart-line"></i> نموذج أوهلسون (O-Score)</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> نموذج أوهلسون يستخدم الانحدار اللوجستي لتقدير احتمالية الإفلاس خلال سنتين
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="stats-card border-${statusColor}">
                                <h6>O-Score</h6>
                                <h3 class="text-${statusColor}">${oScore.toFixed(4)}</h3>
                                <p>النتيجة الخام</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stats-card border-${statusColor}">
                                <h6>احتمالية الإفلاس</h6>
                                <h3 class="text-${statusColor}">${probabilityPct}%</h3>
                                <p>خطر ${status}</p>
                            </div>
                        </div>
                    </div>

                    <div class="progress mb-4" style="height: 40px;">
                        <div class="progress-bar bg-${statusColor}" role="progressbar" style="width: ${probabilityPct}%">
                            ${probabilityPct}% احتمالية إفلاس
                        </div>
                    </div>

                    <div class="card bg-dark border-primary mb-4">
                        <div class="card-body">
                            <h6 class="card-title">معادلة O-Score</h6>
                            <p class="small mb-2">O = -1.32 - 0.407×log(TA) + 6.03×(TL/TA) - 1.43×(WC/TA) + 0.076×(CL/CA) - 2.37×(NI/TA) - 1.83×(FFO/TL) + 0.285×INTWO - 0.521×CHIN</p>
                            <p class="text-center mb-0"><strong>Probability = 1 / (1 + e^(-O))</strong></p>
                        </div>
                    </div>

                    <table class="table table-striped table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>المتغير</th>
                                <th>الوصف</th>
                                <th class="text-end">المساهمة</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>ثابت</td><td>Constant</td><td class="text-end">${t1.toFixed(4)}</td></tr>
                            <tr><td>SIZE</td><td>log(إجمالي الأصول)</td><td class="text-end">${t2.toFixed(4)}</td></tr>
                            <tr><td>TLTA</td><td>إجمالي الخصوم / إجمالي الأصول</td><td class="text-end">${t3.toFixed(4)}</td></tr>
                            <tr><td>WCTA</td><td>رأس المال العامل / إجمالي الأصول</td><td class="text-end">${t4.toFixed(4)}</td></tr>
                            <tr><td>CLCA</td><td>الخصوم المتداولة / الأصول المتداولة</td><td class="text-end">${t5.toFixed(4)}</td></tr>
                            <tr><td>NITA</td><td>صافي الدخل / إجمالي الأصول</td><td class="text-end">${t6.toFixed(4)}</td></tr>
                            <tr><td>FUTL</td><td>التدفق النقدي / إجمالي الخصوم</td><td class="text-end">${t7.toFixed(4)}</td></tr>
                            <tr><td>INTWO</td><td>صافي دخل سلبي لسنتين متتاليتين</td><td class="text-end">${t8.toFixed(4)}</td></tr>
                            <tr><td>CHIN</td><td>التغير في صافي الدخل</td><td class="text-end">${t9.toFixed(4)}</td></tr>
                            <tr class="table-primary">
                                <td colspan="2"><strong>O-Score</strong></td>
                                <td class="text-end"><strong>${oScore.toFixed(4)}</strong></td>
                            </tr>
                            <tr class="table-${statusColor}">
                                <td colspan="2"><strong>احتمالية الإفلاس</strong></td>
                                <td class="text-end"><strong>${probabilityPct}%</strong></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="alert alert-${statusColor} mt-4">
                        <h6><i class="fas fa-info-circle"></i> التفسير</h6>
                        <p class="mb-0">
                            ${probability < 0.25 ? 
                                'احتمالية الإفلاس منخفضة. الشركة في وضع مالي جيد.' :
                                probability < 0.50 ?
                                'احتمالية الإفلاس متوسطة. يُنصح بمراقبة المؤشرات المالية وتحسين الأداء.' :
                                'احتمالية الإفلاس مرتفعة. يتطلب اتخاذ إجراءات عاجلة لتحسين الوضع المالي.'}
                        </p>
                    </div>
                </div>
            `;
        }

        // Simplified versions of remaining risk models
        function generateZmijewskiXScore(data) {
            const netIncome = data.revenue - data.cogs - data.operatingExpenses;
            const totalAssets = data.currentAssets + data.fixedAssets;
            const totalLiabilities = data.currentLiabilities + data.longTermLiabilities;
            
            const x1 = netIncome / totalAssets;
            const x2 = totalLiabilities / totalAssets;
            const x3 = data.currentAssets / data.currentLiabilities;
            
            const xScore = -4.3 - 4.5 * x1 + 5.7 * x2 - 0.004 * x3;
            const probability = 1 / (1 + Math.exp(-xScore));
            
            return generateRiskModelTemplate('Zmijewski X-Score', xScore, probability, 'probit', 
                'نموذج قوي في الأسواق المضطربة، يركز على الربحية والرافعة المالية والسيولة');
        }

        function generateSherrodModel(data) {
            const cashFlow = data.cashFlow;
            const totalAssets = data.currentAssets + data.fixedAssets;
            const score = (cashFlow / totalAssets) * 100;
            const probability = score < 5 ? 0.8 : score < 10 ? 0.4 : 0.1;
            
            return generateRiskModelTemplate('Sherrod Model', score, probability, 'cash-flow',
                'يركز على التدفق النقدي كمؤشر رئيسي للصحة المالية');
        }

        function generateFulmerHScore(data) {
            // Simplified H-Score with 9 ratios
            const totalAssets = data.currentAssets + data.fixedAssets;
            const netIncome = data.revenue - data.cogs - data.operatingExpenses;
            
            const h1 = data.equity / totalAssets;
            const h2 = data.revenue / totalAssets;
            const h3 = netIncome / data.equity;
            const h4 = data.cashFlow / totalLiabilities;
            const h5 = totalLiabilities / totalAssets;
            const h6 = data.currentAssets / data.currentLiabilities;
            const h7 = Math.log(totalAssets);
            const h8 = (data.currentAssets - data.currentLiabilities) / totalAssets;
            const h9 = Math.log(netIncome / totalAssets + 1);
            
            const hScore = 5.528 * h1 + 0.212 * h2 + 0.073 * h3 + 1.270 * h4 - 0.120 * h5 + 2.335 * h6 + 0.575 * h7 + 1.083 * h8 + 0.894 * h9 - 3.075;
            const probability = hScore < 0 ? 0.7 : 0.2;
            
            return generateRiskModelTemplate('Fulmer H-Score', hScore, probability, '9-ratios',
                'يستخدم 9 نسب مالية لدقة أعلى في التنبؤ');
        }

        function generateSpringateSScore(data) {
            const totalAssets = data.currentAssets + data.fixedAssets;
            const workingCapital = data.currentAssets - data.currentLiabilities;
            const ebit = data.revenue - data.cogs - data.operatingExpenses;
            
            const s1 = workingCapital / totalAssets;
            const s2 = ebit / totalAssets;
            const s3 = ebit / data.currentLiabilities;
            const s4 = data.revenue / totalAssets;
            
            const sScore = 1.03 * s1 + 3.07 * s2 + 0.66 * s3 + 0.4 * s4;
            const probability = sScore < 0.862 ? 0.8 : 0.1;
            
            return generateRiskModelTemplate('Springate S-Score', sScore, probability, '4-ratios',
                'نموذج بسيط وفعّال يستخدم 4 نسب فقط');
        }

        function generateCAScoreAI(data) {
            // Simulated AI score
            const features = [
                data.revenue / (data.currentAssets + data.fixedAssets),
                (data.revenue - data.cogs - data.operatingExpenses) / data.revenue,
                data.currentAssets / data.currentLiabilities,
                data.equity / (data.currentAssets + data.fixedAssets)
            ];
            
            const aiScore = features.reduce((sum, f) => sum + f, 0) / features.length;
            const probability = aiScore < 0.5 ? 0.7 : aiScore < 1 ? 0.3 : 0.1;
            
            return generateRiskModelTemplate('CA-Score (AI)', aiScore, probability, 'neural-network',
                'يستخدم الشبكات العصبية والبيانات الضخمة للتنبؤ الدقيق');
        }

        function generateVaRRisk(data) {
            const portfolioValue = data.equity;
            const volatility = 0.15; // 15% annual volatility
            const confidenceLevel = 0.99; // 99%
            const zScore = 2.33; // Z-score for 99% confidence
            
            const var1Day = portfolioValue * volatility * zScore / Math.sqrt(252);
            const var10Day = portfolioValue * volatility * zScore / Math.sqrt(252 / 10);
            const var30Day = portfolioValue * volatility * zScore / Math.sqrt(252 / 30);
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-dice"></i> القيمة المعرضة للخطر (VaR)</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Value at Risk</strong> - أقصى خسارة محتملة عند مستوى ثقة معين
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="stats-card border-warning">
                                <h6>VaR يوم واحد</h6>
                                <h3 class="text-warning">${formatCurrency(var1Day)}</h3>
                                <p>99% ثقة</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card border-danger">
                                <h6>VaR 10 أيام</h6>
                                <h3 class="text-danger">${formatCurrency(var10Day)}</h3>
                                <p>99% ثقة</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card border-danger">
                                <h6>VaR 30 يوم</h6>
                                <h3 class="text-danger">${formatCurrency(var30Day)}</h3>
                                <p>99% ثقة</p>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-dark border-primary mb-4">
                        <div class="card-body">
                            <h6 class="card-title">الافتراضات</h6>
                            <table class="table table-sm table-borderless">
                                <tbody>
                                    <tr><td>قيمة المحفظة</td><td class="text-end">${formatCurrency(portfolioValue)}</td></tr>
                                    <tr><td>التقلب السنوي</td><td class="text-end">${(volatility * 100).toFixed(1)}%</td></tr>
                                    <tr><td>مستوى الثقة</td><td class="text-end">${(confidenceLevel * 100).toFixed(0)}%</td></tr>
                                    <tr><td>Z-Score</td><td class="text-end">${zScore}</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <h6><i class="fas fa-info-circle"></i> التفسير</h6>
                        <p class="mb-0">
                            بمستوى ثقة 99%، الحد الأقصى للخسارة المتوقعة خلال يوم واحد هو ${formatCurrency(var1Day)}،
                            وهو ما يمثل ${(var1Day / portfolioValue * 100).toFixed(2)}% من قيمة المحفظة.
                        </p>
                    </div>
                </div>
            `;
        }

        // Helper function for risk models
        function generateRiskModelTemplate(modelName, score, probability, type, description) {
            const probabilityPct = (probability * 100).toFixed(1);
            const statusColor = probability < 0.3 ? 'success' : probability < 0.6 ? 'warning' : 'danger';
            const status = probability < 0.3 ? 'منخفض' : probability < 0.6 ? 'متوسط' : 'مرتفع';
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-chart-line"></i> ${modelName}</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> ${description}
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="stats-card border-${statusColor}">
                                <h6>النتيجة</h6>
                                <h3 class="text-${statusColor}">${score.toFixed(4)}</h3>
                                <p>${type}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stats-card border-${statusColor}">
                                <h6>احتمالية الإفلاس</h6>
                                <h3 class="text-${statusColor}">${probabilityPct}%</h3>
                                <p>خطر ${status}</p>
                            </div>
                        </div>
                    </div>

                    <div class="progress mb-4" style="height: 40px;">
                        <div class="progress-bar bg-${statusColor}" role="progressbar" style="width: ${probabilityPct}%">
                            ${probabilityPct}% احتمالية إفلاس
                        </div>
                    </div>

                    <div class="alert alert-${statusColor}">
                        <h6><i class="fas fa-info-circle"></i> التقييم</h6>
                        <p class="mb-0">
                            ${probability < 0.3 ? 
                                'الشركة في وضع مالي جيد. احتمالية الإفلاس منخفضة.' :
                                probability < 0.6 ?
                                'الشركة في منطقة رمادية. يُنصح بمراقبة المؤشرات المالية.' :
                                'الشركة في وضع مالي صعب. يتطلب اتخاذ إجراءات فورية.'}
                        </p>
                    </div>
                </div>
            `;
        }

        // ========== INVESTMENT REPORTS ==========
        function generateCAPM(data) {
            const riskFreeRate = 0.05; // 5%
            const marketReturn = 0.12; // 12%
            const beta = 1.2;
            const expectedReturn = riskFreeRate + beta * (marketReturn - riskFreeRate);
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-chart-line"></i> نموذج تسعير الأصول الرأسمالية (CAPM)</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Capital Asset Pricing Model</strong> - يحدد العائد المطلوب على الاستثمار بناءً على المخاطرة
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stats-card border-primary">
                                <h6>معدل الخالي من المخاطر</h6>
                                <h3 class="text-primary">${(riskFreeRate * 100).toFixed(1)}%</h3>
                                <p>Rf</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-info">
                                <h6>عائد السوق</h6>
                                <h3 class="text-info">${(marketReturn * 100).toFixed(1)}%</h3>
                                <p>Rm</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-warning">
                                <h6>بيتا</h6>
                                <h3 class="text-warning">${beta.toFixed(2)}</h3>
                                <p>β</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-success">
                                <h6>العائد المطلوب</h6>
                                <h3 class="text-success">${(expectedReturn * 100).toFixed(2)}%</h3>
                                <p>E(R)</p>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-dark border-primary mb-4">
                        <div class="card-body">
                            <h6 class="card-title">معادلة CAPM</h6>
                            <div class="text-center p-3">
                                <p class="mb-2"><strong>E(R) = Rf + β × (Rm - Rf)</strong></p>
                                <p class="mb-0">${(riskFreeRate * 100).toFixed(1)}% + ${beta.toFixed(2)} × (${(marketReturn * 100).toFixed(1)}% - ${(riskFreeRate * 100).toFixed(1)}%) = ${(expectedReturn * 100).toFixed(2)}%</p>
                            </div>
                        </div>
                    </div>

                    <table class="table table-bordered">
                        <thead class="table-dark">
                            <tr><th>المكون</th><th class="text-end">القيمة</th><th>الوصف</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Rf</td>
                                <td class="text-end">${(riskFreeRate * 100).toFixed(1)}%</td>
                                <td>معدل العائد الخالي من المخاطر (سندات حكومية)</td>
                            </tr>
                            <tr>
                                <td>β</td>
                                <td class="text-end">${beta.toFixed(2)}</td>
                                <td>مقياس المخاطرة المنتظمة (تقلب السهم مقارنة بالسوق)</td>
                            </tr>
                            <tr>
                                <td>Rm</td>
                                <td class="text-end">${(marketReturn * 100).toFixed(1)}%</td>
                                <td>العائد المتوقع للسوق</td>
                            </tr>
                            <tr>
                                <td>Rm - Rf</td>
                                <td class="text-end">${((marketReturn - riskFreeRate) * 100).toFixed(1)}%</td>
                                <td>علاوة مخاطر السوق</td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>E(R)</strong></td>
                                <td class="text-end"><strong>${(expectedReturn * 100).toFixed(2)}%</strong></td>
                                <td><strong>العائد المطلوب على الاستثمار</strong></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="alert alert-info mt-4">
                        <h6><i class="fas fa-info-circle"></i> التفسير</h6>
                        <p class="mb-0">
                            بناءً على بيتا ${beta.toFixed(2)}، فإن السهم ${beta > 1 ? 'أكثر تقلباً' : 'أقل تقلباً'} من السوق.
                            العائد المطلوب هو ${(expectedReturn * 100).toFixed(2)}%، وهو ما يجب أن يحققه الاستثمار لتعويض المخاطرة.
                        </p>
                    </div>
                </div>
            `;
        }

        function generateFamaFrench(data) {
            const rf = 0.05;
            const rmrf = 0.07; // Market risk premium
            const smb = 0.03; // Small minus big
            const hml = 0.04; // High minus low
            const beta = 1.2;
            const sizeCoef = 0.5;
            const valueCoef = 0.3;
            
            const expectedReturn = rf + beta * rmrf + sizeCoef * smb + valueCoef * hml;
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-cubes"></i> نموذج فاما-فرنش ثلاثي العوامل</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Fama-French 3-Factor Model</strong> - يضيف عاملي الحجم والقيمة إلى CAPM
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stats-card border-primary">
                                <h6>علاوة السوق</h6>
                                <h3 class="text-primary">${(rmrf * 100).toFixed(1)}%</h3>
                                <p>Rm - Rf</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-info">
                                <h6>عامل الحجم</h6>
                                <h3 class="text-info">${(smb * 100).toFixed(1)}%</h3>
                                <p>SMB</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-warning">
                                <h6>عامل القيمة</h6>
                                <h3 class="text-warning">${(hml * 100).toFixed(1)}%</h3>
                                <p>HML</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-success">
                                <h6>العائد المتوقع</h6>
                                <h3 class="text-success">${(expectedReturn * 100).toFixed(2)}%</h3>
                                <p>E(R)</p>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-dark border-primary mb-4">
                        <div class="card-body">
                            <h6 class="card-title">معادلة Fama-French</h6>
                            <div class="text-center p-3">
                                <p class="mb-2"><strong>E(R) = Rf + β(Rm-Rf) + s(SMB) + h(HML)</strong></p>
                                <p class="mb-0">${(rf * 100).toFixed(1)}% + ${beta}×${(rmrf * 100).toFixed(1)}% + ${sizeCoef}×${(smb * 100).toFixed(1)}% + ${valueCoef}×${(hml * 100).toFixed(1)}% = ${(expectedReturn * 100).toFixed(2)}%</p>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-success">
                        <h6><i class="fas fa-info-circle"></i> التفسير</h6>
                        <p class="mb-0">
                            النموذج يأخذ في الاعتبار ثلاثة عوامل: مخاطر السوق، حجم الشركة، ونسبة القيمة الدفترية إلى السوقية.
                            العائد المتوقع ${(expectedReturn * 100).toFixed(2)}% يعكس هذه العوامل مجتمعة.
                        </p>
                    </div>
                </div>
            `;
        }

        function generateMPT(data) {
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-briefcase"></i> نظرية المحفظة الحديثة (MPT)</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Modern Portfolio Theory</strong> - تحسين المحفظة لتحقيق أعلى عائد عند مستوى مخاطرة معين
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="stats-card border-primary">
                                <h6>العائد المتوقع</h6>
                                <h3 class="text-primary">12.5%</h3>
                                <p>Expected Return</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card border-warning">
                                <h6>المخاطرة (الانحراف المعياري)</h6>
                                <h3 class="text-warning">15%</h3>
                                <p>Risk (σ)</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card border-success">
                                <h6>نسبة شارب</h6>
                                <h3 class="text-success">0.50</h3>
                                <p>Sharpe Ratio</p>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-dark border-primary mb-4">
                        <div class="card-body">
                            <h6 class="card-title">الحد الكفء (Efficient Frontier)</h6>
                            <div class="chart-container">
                                <canvas id="efficientFrontierChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-success">
                        <h6><i class="fas fa-lightbulb"></i> التوصيات</h6>
                        <ul class="mb-0">
                            <li>التنويع يقلل المخاطر غير المنتظمة</li>
                            <li>اختر المحفظة على الحد الكفء حسب رغبتك في المخاطرة</li>
                            <li>أعد توازن المحفظة دورياً</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function generateSharpeRatio(data) {
            const portfolioReturn = 0.15; // 15%
            const riskFreeRate = 0.05; // 5%
            const portfolioStdDev = 0.20; // 20%
            const sharpeRatio = (portfolioReturn - riskFreeRate) / portfolioStdDev;
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-divide"></i> نسبة شارب (Sharpe Ratio)</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Sharpe Ratio</strong> - يقيس العائد الزائد لكل وحدة مخاطرة
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stats-card border-primary">
                                <h6>عائد المحفظة</h6>
                                <h3 class="text-primary">${(portfolioReturn * 100).toFixed(1)}%</h3>
                                <p>Rp</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-info">
                                <h6>المعدل الخالي من المخاطر</h6>
                                <h3 class="text-info">${(riskFreeRate * 100).toFixed(1)}%</h3>
                                <p>Rf</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-warning">
                                <h6>الانحراف المعياري</h6>
                                <h3 class="text-warning">${(portfolioStdDev * 100).toFixed(1)}%</h3>
                                <p>σp</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card ${sharpeRatio > 1 ? 'border-success' : 'border-warning'}">
                                <h6>نسبة شارب</h6>
                                <h3 class="${sharpeRatio > 1 ? 'text-success' : 'text-warning'}">${sharpeRatio.toFixed(2)}</h3>
                                <p>${sharpeRatio > 1 ? 'ممتاز' : 'مقبول'}</p>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-dark border-primary mb-4">
                        <div class="card-body">
                            <h6 class="card-title">معادلة Sharpe Ratio</h6>
                            <div class="text-center p-3">
                                <p class="mb-2"><strong>Sharpe Ratio = (Rp - Rf) / σp</strong></p>
                                <p class="mb-0">(${(portfolioReturn * 100).toFixed(1)}% - ${(riskFreeRate * 100).toFixed(1)}%) / ${(portfolioStdDev * 100).toFixed(1)}% = ${sharpeRatio.toFixed(2)}</p>
                            </div>
                        </div>
                    </div>

                    <table class="table table-bordered">
                        <thead class="table-dark">
                            <tr><th>نسبة شارب</th><th>التقييم</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>> 3</td><td class="text-success">استثنائي</td></tr>
                            <tr><td>2 - 3</td><td class="text-success">ممتاز جداً</td></tr>
                            <tr><td>1 - 2</td><td class="text-success">جيد</td></tr>
                            <tr><td>0 - 1</td><td class="text-warning">مقبول</td></tr>
                            <tr><td>< 0</td><td class="text-danger">ضعيف</td></tr>
                        </tbody>
                    </table>

                    <div class="alert ${sharpeRatio > 1 ? 'alert-success' : 'alert-warning'}">
                        <h6><i class="fas fa-info-circle"></i> التفسير</h6>
                        <p class="mb-0">
                            نسبة شارب ${sharpeRatio.toFixed(2)} تعني أنك تحصل على ${sharpeRatio.toFixed(2)} وحدة من العائد الزائد
                            لكل وحدة من المخاطرة. ${sharpeRatio > 1 ? 'هذا يعتبر أداءً جيداً.' : 'قد تحتاج لتحسين العائد أو تقليل المخاطرة.'}
                        </p>
                    </div>
                </div>
            `;
        }

        // ========== QUALITY REPORTS ==========
        function generateBeneishMScore(data) {
            // Simplified M-Score calculation
            const dsri = 1.1; // Days Sales in Receivables Index
            const gmi = 0.9; // Gross Margin Index
            const aqi = 1.0; // Asset Quality Index
            const sgi = 1.15; // Sales Growth Index
            const depi = 1.0; // Depreciation Index
            const sgai = 1.05; // SG&A Index
            const lvgi = 1.1; // Leverage Index
            const tata = 0.05; // Total Accruals to Total Assets
            
            const mScore = -4.84 + 0.92 * dsri + 0.528 * gmi + 0.404 * aqi + 0.892 * sgi + 0.115 * depi - 0.172 * sgai + 4.679 * tata - 0.327 * lvgi;
            
            const isManipulator = mScore > -1.78;
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-search-dollar"></i> نموذج بينيش للكشف عن التلاعب (M-Score)</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Beneish M-Score</strong> - يكشف عن احتمالية التلاعب في الأرباح
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="stats-card ${isManipulator ? 'border-danger' : 'border-success'}">
                                <div class="row align-items-center">
                                    <div class="col-md-4 text-center">
                                        <i class="fas fa-${isManipulator ? 'exclamation-triangle' : 'check-circle'} fa-4x text-${isManipulator ? 'danger' : 'success'}"></i>
                                    </div>
                                    <div class="col-md-8">
                                        <h6>M-Score</h6>
                                        <h2 class="text-${isManipulator ? 'danger' : 'success'}">${mScore.toFixed(3)}</h2>
                                        <h5 class="text-${isManipulator ? 'danger' : 'success'}">
                                            ${isManipulator ? '⚠️ احتمالية تلاعب مرتفعة' : '✓ لا توجد مؤشرات تلاعب'}
                                        </h5>
                                        <p class="mb-0">الحد الفاصل: -1.78</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <table class="table table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>المؤشر</th>
                                <th>الوصف</th>
                                <th class="text-end">القيمة</th>
                                <th class="text-end">الوزن</th>
                                <th class="text-end">المساهمة</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>DSRI</td><td>مؤشر أيام المبيعات في الذمم</td><td class="text-end">${dsri.toFixed(3)}</td><td class="text-end">0.920</td><td class="text-end">${(0.92 * dsri).toFixed(3)}</td></tr>
                            <tr><td>GMI</td><td>مؤشر هامش الربح الإجمالي</td><td class="text-end">${gmi.toFixed(3)}</td><td class="text-end">0.528</td><td class="text-end">${(0.528 * gmi).toFixed(3)}</td></tr>
                            <tr><td>AQI</td><td>مؤشر جودة الأصول</td><td class="text-end">${aqi.toFixed(3)}</td><td class="text-end">0.404</td><td class="text-end">${(0.404 * aqi).toFixed(3)}</td></tr>
                            <tr><td>SGI</td><td>مؤشر نمو المبيعات</td><td class="text-end">${sgi.toFixed(3)}</td><td class="text-end">0.892</td><td class="text-end">${(0.892 * sgi).toFixed(3)}</td></tr>
                            <tr><td>DEPI</td><td>مؤشر الإهلاك</td><td class="text-end">${depi.toFixed(3)}</td><td class="text-end">0.115</td><td class="text-end">${(0.115 * depi).toFixed(3)}</td></tr>
                            <tr><td>SGAI</td><td>مؤشر المصروفات البيعية والإدارية</td><td class="text-end">${sgai.toFixed(3)}</td><td class="text-end">-0.172</td><td class="text-end">${(-0.172 * sgai).toFixed(3)}</td></tr>
                            <tr><td>TATA</td><td>إجمالي الاستحقاقات / إجمالي الأصول</td><td class="text-end">${tata.toFixed(3)}</td><td class="text-end">4.679</td><td class="text-end">${(4.679 * tata).toFixed(3)}</td></tr>
                            <tr><td>LVGI</td><td>مؤشر الرافعة المالية</td><td class="text-end">${lvgi.toFixed(3)}</td><td class="text-end">-0.327</td><td class="text-end">${(-0.327 * lvgi).toFixed(3)}</td></tr>
                            <tr class="${isManipulator ? 'table-danger' : 'table-success'}">
                                <td colspan="4"><strong>M-Score</strong></td>
                                <td class="text-end"><strong>${mScore.toFixed(3)}</strong></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="alert ${isManipulator ? 'alert-danger' : 'alert-success'}">
                        <h6><i class="fas fa-${isManipulator ? 'exclamation-triangle' : 'check-circle'}"></i> التفسير</h6>
                        <p class="mb-0">
                            ${isManipulator ? 
                                'M-Score أكبر من -1.78 يشير إلى احتمالية تلاعب في الأرباح. يُنصح بمراجعة دقيقة للقوائم المالية والسياسات المحاسبية.' :
                                'M-Score أقل من -1.78 يشير إلى عدم وجود مؤشرات قوية على التلاعب في الأرباح. القوائم المالية تبدو موثوقة.'}
                        </p>
                    </div>
                </div>
            `;
        }

        function generateSloanAccruals(data) {
            const netIncome = data.revenue - data.cogs - data.operatingExpenses;
            const operatingCashFlow = data.cashFlow;
            const totalAccruals = netIncome - operatingCashFlow;
            const totalAssets = data.currentAssets + data.fixedAssets;
            const accrualsRatio = totalAccruals / totalAssets;
            
            const qualityRating = accrualsRatio < 0.05 ? 'عالية' : accrualsRatio < 0.10 ? 'متوسطة' : 'منخفضة';
            const qualityColor = accrualsRatio < 0.05 ? 'success' : accrualsRatio < 0.10 ? 'warning' : 'danger';
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-file-contract"></i> نموذج سلون للاستحقاقات</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Sloan's Accruals</strong> - يقيس جودة الأرباح من خلال نسبة الاستحقاقات إلى النقد
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stats-card border-primary">
                                <h6>صافي الربح</h6>
                                <h3 class="text-primary">${formatCurrency(netIncome)}</h3>
                                <p>Net Income</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-info">
                                <h6>التدفق النقدي التشغيلي</h6>
                                <h3 class="text-info">${formatCurrency(operatingCashFlow)}</h3>
                                <p>Operating Cash Flow</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-warning">
                                <h6>إجمالي الاستحقاقات</h6>
                                <h3 class="text-warning">${formatCurrency(totalAccruals)}</h3>
                                <p>Total Accruals</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card border-${qualityColor}">
                                <h6>نسبة الاستحقاقات</h6>
                                <h3 class="text-${qualityColor}">${(accrualsRatio * 100).toFixed(2)}%</h3>
                                <p>جودة ${qualityRating}</p>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-dark border-primary mb-4">
                        <div class="card-body">
                            <h6 class="card-title">معادلة الاستحقاقات</h6>
                            <div class="text-center p-3">
                                <p class="mb-2"><strong>الاستحقاقات = صافي الربح - التدفق النقدي التشغيلي</strong></p>
                                <p class="mb-2"><strong>نسبة الاستحقاقات = الاستحقاقات / إجمالي الأصول</strong></p>
                                <p class="mb-0">${formatCurrency(totalAccruals)} / ${formatCurrency(totalAssets)} = ${(accrualsRatio * 100).toFixed(2)}%</p>
                            </div>
                        </div>
                    </div>

                    <table class="table table-bordered">
                        <thead class="table-dark">
                            <tr><th>البيان</th><th class="text-end">القيمة</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>صافي الربح</td><td class="text-end">${formatCurrency(netIncome)}</td></tr>
                            <tr><td>(-) التدفق النقدي التشغيلي</td><td class="text-end text-danger">(${formatCurrency(operatingCashFlow)})</td></tr>
                            <tr class="table-warning"><td><strong>إجمالي الاستحقاقات</strong></td><td class="text-end"><strong>${formatCurrency(totalAccruals)}</strong></td></tr>
                            <tr><td>إجمالي الأصول</td><td class="text-end">${formatCurrency(totalAssets)}</td></tr>
                            <tr class="table-${qualityColor}"><td><strong>نسبة الاستحقاقات</strong></td><td class="text-end"><strong>${(accrualsRatio * 100).toFixed(2)}%</strong></td></tr>
                        </tbody>
                    </table>

                    <div class="alert alert-${qualityColor}">
                        <h6><i class="fas fa-info-circle"></i> التفسير</h6>
                        <p class="mb-0">
                            ${accrualsRatio < 0.05 ? 
                                'نسبة استحقاقات منخفضة تشير إلى جودة أرباح عالية. معظم الأرباح مدعومة بتدفقات نقدية فعلية.' :
                                accrualsRatio < 0.10 ?
                                'نسبة استحقاقات متوسطة. جودة الأرباح مقبولة ولكن يُنصح بالمراقبة.' :
                                'نسبة استحقاقات مرتفعة تشير إلى جودة أرباح منخفضة. جزء كبير من الأرباح غير مدعوم بنقد فعلي، مما قد يشير إلى تلاعب محتمل.'}
                        </p>
                    </div>

                    <div class="card bg-dark border-info mt-4">
                        <div class="card-body">
                            <h6 class="card-title">مقياس جودة الأرباح</h6>
                            <table class="table table-sm table-borderless">
                                <tbody>
                                    <tr><td>< 5%</td><td class="text-success">جودة عالية جداً</td></tr>
                                    <tr><td>5% - 10%</td><td class="text-warning">جودة متوسطة</td></tr>
                                    <tr><td>> 10%</td><td class="text-danger">جودة منخفضة</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // ========== Export Functions ==========
        function exportCurrentReport() {
            const element = document.getElementById('reportModalBody');
            const opt = {
                margin: 10,
                filename: `${currentReportTitle}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        }

        function exportAllReports() {
            alert('جارٍ تصدير Board Pack الكامل (35 تقريرًا)...\nهذه الميزة قيد التطوير.');
        }

        // ========== What-If Listeners ==========
        function activateWhatIfListeners() {
            const revenueSlider = document.getElementById('revenue-slider');
            const costsSlider = document.getElementById('costs-slider');
            
            if (!revenueSlider || !costsSlider) return;

            const revenueLabel = document.getElementById('revenue-label');
            const costsLabel = document.getElementById('costs-label');
            
            const baseRevenueEl = document.getElementById('base-revenue-val');
            const baseCostsEl = document.getElementById('base-costs-val');
            const baseProfitEl = document.getElementById('base-profit-val');

            const baseRevenue = parseFloat(baseRevenueEl.textContent.replace(/[^\d.-]/g, ''));
            const baseCosts = parseFloat(baseCostsEl.textContent.replace(/[^\d.-]/g, ''));
            const baseProfit = parseFloat(baseProfitEl.textContent.replace(/[^\d.-]/g, ''));

            function updateProjections() {
                const revenueChange = parseInt(revenueSlider.value);
                const costsChange = parseInt(costsSlider.value);

                revenueLabel.textContent = revenueChange + '%';
                costsLabel.textContent = costsChange + '%';

                const projectedRevenue = baseRevenue * (1 + revenueChange / 100);
                const projectedCosts = baseCosts * (1 + costsChange / 100);
                const projectedProfit = projectedRevenue - projectedCosts;

                const profitChange = projectedProfit - baseProfit;
                const profitChangePercent = (baseProfit !== 0) ? (profitChange / Math.abs(baseProfit)) * 100 : (projectedProfit > 0 ? 100 : 0);

                document.getElementById('projected-revenue').textContent = formatCurrency(projectedRevenue);
                document.getElementById('projected-costs').textContent = '(' + formatCurrency(projectedCosts) + ')';
                document.getElementById('projected-profit').textContent = formatCurrency(projectedProfit);

                document.getElementById('revenue-change').innerHTML = `<span class="${(projectedRevenue >= baseRevenue ? 'text-success' : 'text-danger')}">${formatCurrency(projectedRevenue - baseRevenue)}</span>`;
                document.getElementById('costs-change').innerHTML = `<span class="${(projectedCosts >= baseCosts ? 'text-danger' : 'text-success')}">${formatCurrency(projectedCosts - baseCosts)}</span>`;
                document.getElementById('profit-change').innerHTML = `<span class="${(profitChange >= 0 ? 'text-success' : 'text-danger')}">${formatCurrency(profitChange)} (${profitChangePercent.toFixed(1)}%)</span>`;
            }

            revenueSlider.addEventListener('input', updateProjections);
            costsSlider.addEventListener('input', updateProjections);
            
            updateProjections();
        }

        // ========== Apply Scenario Function ==========
        function applyScenario(revChange, costChange) {
            const revenueSlider = document.getElementById('revenue-slider');
            const costsSlider = document.getElementById('costs-slider');
            if (revenueSlider && costsSlider) {
                revenueSlider.value = revChange;
                costsSlider.value = costChange;
                activateWhatIfListeners();
            }
        }
// ========== Export Functions ==========

function exportToPDF() {
    const reportTitle = currentReportTitle || 'تقرير مالي';
    const reportContent = document.getElementById('reportModalBody');
    
    if (!reportContent) {
        alert('لا يوجد محتوى للتصدير');
        return;
    }
    
    const opt = {
        margin: 1,
        filename: `${reportTitle}_${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, letterRendering: true },
        jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' }
    };
    
    // استخدام html2pdf
    html2pdf().set(opt).from(reportContent).save();
}

function exportToExcel() {
    const data = getData();
    
    if (!data) {
        alert('لا توجد بيانات للتصدير');
        return;
    }
    
    // إنشاء workbook جديد
    const wb = XLSX.utils.book_new();
    
    // ورقة 1: قائمة الدخل
    const incomeData = [
        ['قائمة الدخل الشامل'],
        [''],
        ['البيان', 'المبلغ'],
        ['الإيرادات', data.revenue],
        ['تكلفة المبيعات', -data.cogs],
        ['مجمل الربح', data.grossProfit],
        ['المصروفات التشغيلية', -data.operatingExpenses],
        ['الربح التشغيلي', data.operatingProfit],
        ['إيرادات أخرى', data.otherIncome],
        ['صافي الربح', data.netIncome]
    ];
    const wsIncome = XLSX.utils.aoa_to_sheet(incomeData);
    XLSX.utils.book_append_sheet(wb, wsIncome, 'قائمة الدخل');
    
    // ورقة 2: المركز المالي
    const balanceData = [
        ['قائمة المركز المالي'],
        [''],
        ['الأصول', 'المبلغ', '', 'الخصوم وحقوق الملكية', 'المبلغ'],
        ['أصول متداولة', data.currentAssets, '', 'خصوم متداولة', data.currentLiabilities],
        ['أصول ثابتة', data.fixedAssets, '', 'خصوم طويلة الأجل', data.longTermLiabilities],
        ['', '', '', 'حقوق الملكية', data.equity],
        ['إجمالي الأصول', data.assets, '', 'إجمالي الخصوم وحقوق الملكية', data.liabilities + data.equity]
    ];
    const wsBalance = XLSX.utils.aoa_to_sheet(balanceData);
    XLSX.utils.book_append_sheet(wb, wsBalance, 'المركز المالي');
    
    // ورقة 3: ميزان المراجعة
    if (data.trialBalance && data.trialBalance.length > 0) {
        const tbData = [
            ['ميزان المراجعة'],
            [''],
            ['رقم الحساب', 'اسم الحساب', 'مدين', 'دائن', 'الرصيد']
        ];
        
        data.trialBalance.forEach(acc => {
            tbData.push([
                acc.account_id || '',
                acc.name || '',
                acc.book_balance_debit || 0,
                acc.book_balance_credit || 0,
                acc.book_balance || acc.finalBalance || 0
            ]);
        });
        
        const wsTB = XLSX.utils.aoa_to_sheet(tbData);
        XLSX.utils.book_append_sheet(wb, wsTB, 'ميزان المراجعة');
    }
    
    // حفظ الملف
    const fileName = `Financial_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);
}
// ========== Export to Word ==========
function exportToWord() {
    const reportTitle = currentReportTitle || 'تقرير مالي';
    const reportContent = document.getElementById('reportModalBody');
    
    if (!reportContent) {
        alert('لا يوجد محتوى للتصدير');
        return;
    }
    
    // نسخ المحتوى
    const htmlContent = `
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <style>
                body { font-family: Arial; direction: rtl; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                th { background-color: #00BFFF; color: white; }
            </style>
        </head>
        <body>
            <h1>${reportTitle}</h1>
            ${reportContent.innerHTML}
        </body>
        </html>
    `;
    
    // تحويل لـ Blob
    const blob = new Blob(['\ufeff', htmlContent], {
        type: 'application/msword'
    });
    
    // تحميل
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${reportTitle}_${new Date().toISOString().split('T')[0]}.doc`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// ========== Export to Image ==========
function exportToImage() {
    const reportContent = document.getElementById('reportModalBody');
    
    if (!reportContent) {
        alert('لا يوجد محتوى للتصدير');
        return;
    }
    
    html2canvas(reportContent, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#0d1117',
        logging: false
    }).then(canvas => {
        canvas.toBlob(function(blob) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${currentReportTitle || 'تقرير'}_${new Date().toISOString().split('T')[0]}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }, 'image/png');
    }).catch(error => {
        console.error('خطأ في تصدير الصورة:', error);
        alert('حدث خطأ أثناء تصدير الصورة');
    });
}
// ========================================
// قسم الموازنة (Budget) - 4 تقارير
// ========================================

// 1️⃣ إعداد الموازنة السنوية
function generateBudgetPreparation(data) {
    if (!data) {
        return `<div class="alert alert-warning">لا توجد بيانات متاحة</div>`;
    }
    
    // إنشاء موازنة افتراضية بناءً على البيانات الفعلية
    const budget = {
        revenue: data.revenue * 1.1, // زيادة 10%
        cogs: data.cogs * 1.05, // زيادة 5%
        operatingExpenses: data.operatingExpenses * 1.03, // زيادة 3%
        depreciationExpense: data.depreciationExpense || 0,
        otherIncome: data.otherIncome * 1.2
    };
    
    budget.grossProfit = budget.revenue - budget.cogs;
    budget.operatingProfit = budget.grossProfit - budget.operatingExpenses - budget.depreciationExpense;
    budget.netIncome = budget.operatingProfit + budget.otherIncome;
    
    return `
        <div class="report-container">
            <h2 class="text-center mb-4"><i class="fas fa-calculator"></i> إعداد الموازنة السنوية</h2>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> <strong>ملاحظة:</strong> الموازنة التقديرية مبنية على البيانات الفعلية مع نسب نمو متوقعة
            </div>
            
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card bg-dark border-primary">
                        <div class="card-header bg-primary text-white">
                            <h5><i class="fas fa-chart-line"></i> الإيرادات المتوقعة</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-dark table-hover">
                                <tr>
                                    <td>الإيرادات الفعلية (السنة الحالية)</td>
                                    <td class="text-end">${formatCurrency(data.revenue)}</td>
                                </tr>
                                <tr>
                                    <td>نسبة النمو المتوقعة</td>
                                    <td class="text-end text-success">+10%</td>
                                </tr>
                                <tr class="table-primary">
                                    <td><strong>الإيرادات المقدرة</strong></td>
                                    <td class="text-end"><strong>${formatCurrency(budget.revenue)}</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card bg-dark border-danger">
                        <div class="card-header bg-danger text-white">
                            <h5><i class="fas fa-chart-line"></i> المصروفات المتوقعة</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-dark table-hover">
                                <tr>
                                    <td>تكلفة المبيعات المقدرة</td>
                                    <td class="text-end">${formatCurrency(budget.cogs)}</td>
                                </tr>
                                <tr>
                                    <td>المصروفات التشغيلية المقدرة</td>
                                    <td class="text-end">${formatCurrency(budget.operatingExpenses)}</td>
                                </tr>
                                <tr>
                                    <td>الإهلاك المقدر</td>
                                    <td class="text-end">${formatCurrency(budget.depreciationExpense)}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card bg-dark border-success">
                <div class="card-header bg-success text-white">
                    <h5><i class="fas fa-calculator"></i> ملخص الموازنة التقديرية</h5>
                </div>
                <div class="card-body">
                    <table class="table table-dark table-striped">
                        <thead>
                            <tr>
                                <th>البيان</th>
                                <th class="text-end">المبلغ المقدر</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>الإيرادات</td>
                                <td class="text-end text-success">${formatCurrency(budget.revenue)}</td>
                            </tr>
                            <tr>
                                <td>تكلفة المبيعات</td>
                                <td class="text-end text-danger">(${formatCurrency(budget.cogs)})</td>
                            </tr>
                            <tr class="table-info">
                                <td><strong>مجمل الربح المقدر</strong></td>
                                <td class="text-end"><strong>${formatCurrency(budget.grossProfit)}</strong></td>
                            </tr>
                            <tr>
                                <td>المصروفات التشغيلية</td>
                                <td class="text-end text-danger">(${formatCurrency(budget.operatingExpenses)})</td>
                            </tr>
                            <tr>
                                <td>الإهلاك</td>
                                <td class="text-end text-danger">(${formatCurrency(budget.depreciationExpense)})</td>
                            </tr>
                            <tr class="table-warning">
                                <td><strong>الربح التشغيلي المقدر</strong></td>
                                <td class="text-end"><strong>${formatCurrency(budget.operatingProfit)}</strong></td>
                            </tr>
                            <tr>
                                <td>إيرادات أخرى</td>
                                <td class="text-end text-success">${formatCurrency(budget.otherIncome)}</td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>صافي الربح المقدر</strong></td>
                                <td class="text-end"><strong>${formatCurrency(budget.netIncome)}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <canvas id="budgetChart" width="400" height="200" class="mt-4"></canvas>
        </div>
        
        <script>
            setTimeout(() => {
                const ctx = document.getElementById('budgetChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['الإيرادات', 'تكلفة المبيعات', 'المصروفات', 'صافي الربح'],
                            datasets: [{
                                label: 'الموازنة المقدرة',
                                data: [${budget.revenue}, ${budget.cogs}, ${budget.operatingExpenses}, ${budget.netIncome}],
                                backgroundColor: ['#28a745', '#dc3545', '#ffc107', '#007bff']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true, labels: { color: '#fff' } },
                                title: { display: true, text: 'الموازنة التقديرية', color: '#fff' }
                            },
                            scales: {
                                y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                                x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                            }
                        }
                    });
                }
            }, 500);
        <\/script>
    `;
}

// 2️⃣ مقارنة الموازنة بالفعلي
function generateBudgetComparison(data) {
    if (!data) {
        return `<div class="alert alert-warning">لا توجد بيانات متاحة</div>`;
    }
    
    // الموازنة المقدرة
    const budget = {
        revenue: data.revenue * 1.1,
        cogs: data.cogs * 1.05,
        operatingExpenses: data.operatingExpenses * 1.03,
        netIncome: (data.revenue * 1.1) - (data.cogs * 1.05) - (data.operatingExpenses * 1.03)
    };
    
    // الانحرافات
    const variance = {
        revenue: data.revenue - budget.revenue,
        cogs: data.cogs - budget.cogs,
        operatingExpenses: data.operatingExpenses - budget.operatingExpenses,
        netIncome: data.netIncome - budget.netIncome
    };
    
    // النسب المئوية
    const variancePercent = {
        revenue: (variance.revenue / budget.revenue * 100).toFixed(1),
        cogs: (variance.cogs / budget.cogs * 100).toFixed(1),
        operatingExpenses: (variance.operatingExpenses / budget.operatingExpenses * 100).toFixed(1),
        netIncome: (variance.netIncome / budget.netIncome * 100).toFixed(1)
    };
    
    return `
        <div class="report-container">
            <h2 class="text-center mb-4"><i class="fas fa-balance-scale"></i> مقارنة الموازنة بالفعلي</h2>
            
            <div class="card bg-dark border-primary mb-4">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-chart-bar"></i> تحليل الانحرافات</h5>
                </div>
                <div class="card-body">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>البيان</th>
                                <th class="text-end">المقدر</th>
                                <th class="text-end">الفعلي</th>
                                <th class="text-end">الانحراف</th>
                                <th class="text-end">النسبة %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><i class="fas fa-dollar-sign text-success"></i> الإيرادات</td>
                                <td class="text-end">${formatCurrency(budget.revenue)}</td>
                                <td class="text-end">${formatCurrency(data.revenue)}</td>
                                <td class="text-end ${variance.revenue >= 0 ? 'text-success' : 'text-danger'}">
                                    ${formatCurrency(Math.abs(variance.revenue))} ${variance.revenue >= 0 ? '↑' : '↓'}
                                </td>
                                <td class="text-end ${variancePercent.revenue >= 0 ? 'text-success' : 'text-danger'}">
                                    ${variancePercent.revenue}%
                                </td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-shopping-cart text-danger"></i> تكلفة المبيعات</td>
                                <td class="text-end">${formatCurrency(budget.cogs)}</td>
                                <td class="text-end">${formatCurrency(data.cogs)}</td>
                                <td class="text-end ${variance.cogs <= 0 ? 'text-success' : 'text-danger'}">
                                    ${formatCurrency(Math.abs(variance.cogs))} ${variance.cogs <= 0 ? '↓' : '↑'}
                                </td>
                                <td class="text-end ${variancePercent.cogs <= 0 ? 'text-success' : 'text-danger'}">
                                    ${variancePercent.cogs}%
                                </td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-file-invoice-dollar text-warning"></i> المصروفات التشغيلية</td>
                                <td class="text-end">${formatCurrency(budget.operatingExpenses)}</td>
                                <td class="text-end">${formatCurrency(data.operatingExpenses)}</td>
                                <td class="text-end ${variance.operatingExpenses <= 0 ? 'text-success' : 'text-danger'}">
                                    ${formatCurrency(Math.abs(variance.operatingExpenses))} ${variance.operatingExpenses <= 0 ? '↓' : '↑'}
                                </td>
                                <td class="text-end ${variancePercent.operatingExpenses <= 0 ? 'text-success' : 'text-danger'}">
                                    ${variancePercent.operatingExpenses}%
                                </td>
                            </tr>
                            <tr class="table-primary">
                                <td><strong><i class="fas fa-chart-line"></i> صافي الربح</strong></td>
                                <td class="text-end"><strong>${formatCurrency(budget.netIncome)}</strong></td>
                                <td class="text-end"><strong>${formatCurrency(data.netIncome)}</strong></td>
                                <td class="text-end ${variance.netIncome >= 0 ? 'text-success' : 'text-danger'}">
                                    <strong>${formatCurrency(Math.abs(variance.netIncome))} ${variance.netIncome >= 0 ? '↑' : '↓'}</strong>
                                </td>
                                <td class="text-end ${variancePercent.netIncome >= 0 ? 'text-success' : 'text-danger'}">
                                    <strong>${variancePercent.netIncome}%</strong>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <canvas id="varianceChart" width="400" height="300"></canvas>
                </div>
                <div class="col-md-6">
                    <div class="alert ${variance.netIncome >= 0 ? 'alert-success' : 'alert-danger'}">
                        <h5><i class="fas fa-info-circle"></i> التحليل</h5>
                        <p>${variance.netIncome >= 0 ? 
                            '✅ الأداء الفعلي أفضل من المقدر بنسبة ' + Math.abs(variancePercent.netIncome) + '%' :
                            '⚠️ الأداء الفعلي أقل من المقدر بنسبة ' + Math.abs(variancePercent.netIncome) + '%'
                        }</p>
                        <hr>
                        <p><strong>الإيرادات:</strong> ${variance.revenue >= 0 ? 'أعلى' : 'أقل'} من المقدر بمبلغ ${formatCurrency(Math.abs(variance.revenue))}</p>
                        <p><strong>المصروفات:</strong> ${variance.operatingExpenses <= 0 ? 'أقل' : 'أعلى'} من المقدر بمبلغ ${formatCurrency(Math.abs(variance.operatingExpenses))}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            setTimeout(() => {
                const ctx = document.getElementById('varianceChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['الإيرادات', 'تكلفة المبيعات', 'المصروفات', 'صافي الربح'],
                            datasets: [
                                {
                                    label: 'المقدر',
                                    data: [${budget.revenue}, ${budget.cogs}, ${budget.operatingExpenses}, ${budget.netIncome}],
                                    backgroundColor: 'rgba(0, 191, 255, 0.5)'
                                },
                                {
                                    label: 'الفعلي',
                                    data: [${data.revenue}, ${data.cogs}, ${data.operatingExpenses}, ${data.netIncome}],
                                    backgroundColor: 'rgba(40, 167, 69, 0.5)'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true, labels: { color: '#fff' } },
                                title: { display: true, text: 'مقارنة المقدر بالفعلي', color: '#fff' }
                            },
                            scales: {
                                y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                                x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                            }
                        }
                    });
                }
            }, 500);
        <\/script>
    `;
}

// 3️⃣ تحديث الموازنة
function generateBudgetUpdate(data) {
    return `
        <div class="report-container">
            <h2 class="text-center mb-4"><i class="fas fa-sync-alt"></i> تحديث الموازنة</h2>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> يمكنك تعديل الموازنة بناءً على المستجدات والتغيرات في السوق
            </div>
            
            <div class="card bg-dark border-primary">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-edit"></i> تعديل بنود الموازنة</h5>
                </div>
                <div class="card-body">
                    <form id="budgetUpdateForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">الإيرادات المقدرة</label>
                                <input type="number" class="form-control" value="${(data.revenue * 1.1).toFixed(2)}" id="budgetRevenue">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">تكلفة المبيعات المقدرة</label>
                                <input type="number" class="form-control" value="${(data.cogs * 1.05).toFixed(2)}" id="budgetCOGS">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">المصروفات التشغيلية المقدرة</label>
                                <input type="number" class="form-control" value="${(data.operatingExpenses * 1.03).toFixed(2)}" id="budgetOpex">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">الإهلاك المقدر</label>
                                <input type="number" class="form-control" value="${(data.depreciationExpense || 0).toFixed(2)}" id="budgetDepr">
                            </div>
                        </div>
                        <button type="button" class="btn btn-success" onclick="updateBudget()">
                            <i class="fas fa-save"></i> حفظ التحديثات
                        </button>
                    </form>
                </div>
            </div>
            
            <div class="card bg-dark border-success mt-4">
                <div class="card-header bg-success text-white">
                    <h5><i class="fas fa-history"></i> سجل التعديلات</h5>
                </div>
                <div class="card-body">
                    <table class="table table-dark table-striped">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>البند</th>
                                <th>القيمة القديمة</th>
                                <th>القيمة الجديدة</th>
                                <th>المستخدم</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${new Date().toLocaleDateString('ar-SA')}</td>
                                <td>الإيرادات</td>
                                <td>${formatCurrency(data.revenue)}</td>
                                <td>${formatCurrency(data.revenue * 1.1)}</td>
                                <td>المدير المالي</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <script>
            function updateBudget() {
                alert('تم حفظ التحديثات بنجاح!');
            }
        <\/script>
    `;
}

// 4️⃣ تحليل الموازنة
function generateBudgetAnalysis(data) {
    if (!data) {
        return `<div class="alert alert-warning">لا توجد بيانات متاحة</div>`;
    }
    
    const budget = {
        revenue: data.revenue * 1.1,
        cogs: data.cogs * 1.05,
        operatingExpenses: data.operatingExpenses * 1.03
    };
    
    const achievementRate = {
        revenue: (data.revenue / budget.revenue * 100).toFixed(1),
        cogs: (data.cogs / budget.cogs * 100).toFixed(1),
        operatingExpenses: (data.operatingExpenses / budget.operatingExpenses * 100).toFixed(1)
    };
    
    return `
        <div class="report-container">
            <h2 class="text-center mb-4"><i class="fas fa-chart-pie"></i> تحليل الموازنة</h2>
            
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card bg-dark border-success">
                        <div class="card-body text-center">
                            <h3 class="text-success">${achievementRate.revenue}%</h3>
                            <p>نسبة تحقيق الإيرادات</p>
                            <div class="progress">
                                <div class="progress-bar bg-success" style="width: ${achievementRate.revenue}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-dark border-warning">
                        <div class="card-body text-center">
                            <h3 class="text-warning">${achievementRate.cogs}%</h3>
                            <p>نسبة تكلفة المبيعات</p>
                            <div class="progress">
                                <div class="progress-bar bg-warning" style="width: ${achievementRate.cogs}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-dark border-danger">
                        <div class="card-body text-center">
                            <h3 class="text-danger">${achievementRate.operatingExpenses}%</h3>
                            <p>نسبة المصروفات</p>
                            <div class="progress">
                                <div class="progress-bar bg-danger" style="width: ${achievementRate.operatingExpenses}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <canvas id="budgetPieChart" width="400" height="400"></canvas>
                </div>
                <div class="col-md-6">
                    <canvas id="achievementChart" width="400" height="400"></canvas>
                </div>
            </div>
        </div>
        
        <script>
            setTimeout(() => {
                // Pie Chart
                const ctx1 = document.getElementById('budgetPieChart');
                if (ctx1) {
                    new Chart(ctx1, {
                        type: 'pie',
                        data: {
                            labels: ['الإيرادات', 'تكلفة المبيعات', 'المصروفات'],
                            datasets: [{
                                data: [${data.revenue}, ${data.cogs}, ${data.operatingExpenses}],
                                backgroundColor: ['#28a745', '#dc3545', '#ffc107']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true, labels: { color: '#fff' } },
                                title: { display: true, text: 'توزيع البنود', color: '#fff' }
                            }
                        }
                    });
                }
                
                // Achievement Chart
                const ctx2 = document.getElementById('achievementChart');
                if (ctx2) {
                    new Chart(ctx2, {
                        type: 'doughnut',
                        data: {
                            labels: ['المحقق', 'المتبقي'],
                            datasets: [{
                                data: [${achievementRate.revenue}, ${100 - achievementRate.revenue}],
                                backgroundColor: ['#28a745', '#6c757d']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true, labels: { color: '#fff' } },
                                title: { display: true, text: 'نسبة التحقيق', color: '#fff' }
                            }
                        }
                    });
                }
            }, 500);
        <\/script>
    `;
}

// ========================================
// قسم التنبؤات (Forecasting) - 4 تقارير
// ========================================

// 1️⃣ تنبؤ الإيرادات
function generateRevenueForecast(data) {
    if (!data) {
        return `<div class="alert alert-warning">لا توجد بيانات متاحة</div>`;
    }
    
    // توليد تنبؤات لـ 12 شهر
    const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 
                    'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
    
    const monthlyRevenue = data.revenue / 12;
    const forecast = {
        base: [],
        high: [],
        low: []
    };
    
    for (let i = 0; i < 12; i++) {
        const growth = (i + 1) * 0.02; // نمو 2% شهرياً
        forecast.base.push((monthlyRevenue * (1 + growth)).toFixed(2));
        forecast.high.push((monthlyRevenue * (1 + growth + 0.1)).toFixed(2));
        forecast.low.push((monthlyRevenue * (1 + growth - 0.1)).toFixed(2));
    }
    
    return `
        <div class="report-container">
            <h2 class="text-center mb-4"><i class="fas fa-chart-line"></i> تنبؤ الإيرادات (12 شهر)</h2>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> <strong>منهجية التنبؤ:</strong> تم استخدام نموذج النمو الخطي بمعدل 2% شهرياً
            </div>
            
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card bg-dark border-primary">
                        <div class="card-body text-center">
                            <h5 class="text-primary">السيناريو الأساسي</h5>
                            <h3>${formatCurrency(forecast.base.reduce((a, b) => parseFloat(a) + parseFloat(b), 0))}</h3>
                            <p class="text-muted">إجمالي متوقع</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-dark border-success">
                        <div class="card-body text-center">
                            <h5 class="text-success">السيناريو المتفائل</h5>
                            <h3>${formatCurrency(forecast.high.reduce((a, b) => parseFloat(a) + parseFloat(b), 0))}</h3>
                            <p class="text-muted">إجمالي متوقع</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-dark border-danger">
                        <div class="card-body text-center">
                            <h5 class="text-danger">السيناريو المتشائم</h5>
                            <h3>${formatCurrency(forecast.low.reduce((a, b) => parseFloat(a) + parseFloat(b), 0))}</h3>
                            <p class="text-muted">إجمالي متوقع</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <canvas id="forecastChart" width="400" height="200"></canvas>
            
            <div class="card bg-dark border-primary mt-4">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-table"></i> التنبؤات الشهرية</h5>
                </div>
                <div class="card-body">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>الشهر</th>
                                <th class="text-end">متشائم</th>
                                <th class="text-end">أساسي</th>
                                <th class="text-end">متفائل</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${months.map((month, i) => `
                                <tr>
                                    <td>${month}</td>
                                    <td class="text-end text-danger">${formatCurrency(forecast.low[i])}</td>
                                    <td class="text-end">${formatCurrency(forecast.base[i])}</td>
                                    <td class="text-end text-success">${formatCurrency(forecast.high[i])}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <script>
            setTimeout(() => {
                const ctx = document.getElementById('forecastChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ${JSON.stringify(months)},
                            datasets: [
                                {
                                    label: 'متشائم',
                                    data: ${JSON.stringify(forecast.low)},
                                    borderColor: '#dc3545',
                                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                    fill: true
                                },
                                {
                                    label: 'أساسي',
                                    data: ${JSON.stringify(forecast.base)},
                                    borderColor: '#007bff',
                                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                    fill: true
                                },
                                {
                                    label: 'متفائل',
                                    data: ${JSON.stringify(forecast.high)},
                                    borderColor: '#28a745',
                                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                    fill: true
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true, labels: { color: '#fff' } },
                                title: { display: true, text: 'تنبؤ الإيرادات الشهرية', color: '#fff' }
                            },
                            scales: {
                                y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                                x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                            }
                        }
                    });
                }
            }, 500);
        <\/script>
    `;
}

// 2️⃣ تنبؤ التدفقات النقدية
function generateCashFlowForecast(data) {
    if (!data) {
        return `<div class="alert alert-warning">لا توجد بيانات متاحة</div>`;
    }
    
    const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 
                    'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
    
    const monthlyCashFlow = data.cashFlow / 12;
    const cashFlowForecast = [];
    let cumulativeCash = data.currentAssets || 0;
    
    for (let i = 0; i < 12; i++) {
        const monthFlow = monthlyCashFlow * (1 + Math.random() * 0.2 - 0.1);
        cumulativeCash += monthFlow;
        cashFlowForecast.push({
            month: months[i],
            inflow: (data.revenue / 12 * (1 + i * 0.02)).toFixed(2),
            outflow: ((data.cogs + data.operatingExpenses) / 12 * (1 + i * 0.015)).toFixed(2),
            net: monthFlow.toFixed(2),
            cumulative: cumulativeCash.toFixed(2)
        });
    }
    
    return `
        <div class="report-container">
            <h2 class="text-center mb-4"><i class="fas fa-money-bill-wave"></i> تنبؤ التدفقات النقدية</h2>
            
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-dark border-success">
                        <div class="card-body text-center">
                            <h6 class="text-success">الرصيد الحالي</h6>
                            <h4>${formatCurrency(data.currentAssets || 0)}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-dark border-primary">
                        <div class="card-body text-center">
                            <h6 class="text-primary">المتوقع بعد 6 أشهر</h6>
                            <h4>${formatCurrency(cashFlowForecast[5].cumulative)}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-dark border-info">
                        <div class="card-body text-center">
                            <h6 class="text-info">المتوقع بعد 12 شهر</h6>
                            <h4>${formatCurrency(cashFlowForecast[11].cumulative)}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-dark border-warning">
                        <div class="card-body text-center">
                            <h6 class="text-warning">متوسط التدفق الشهري</h6>
                            <h4>${formatCurrency(monthlyCashFlow)}</h4>
                        </div>
                    </div>
                </div>
            </div>
            
            <canvas id="cashFlowChart" width="400" height="200"></canvas>
            
            <div class="card bg-dark border-primary mt-4">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-table"></i> التدفقات الشهرية المتوقعة</h5>
                </div>
                <div class="card-body">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>الشهر</th>
                                <th class="text-end">التدفقات الداخلة</th>
                                <th class="text-end">التدفقات الخارجة</th>
                                <th class="text-end">صافي التدفق</th>
                                <th class="text-end">الرصيد التراكمي</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${cashFlowForecast.map(cf => `
                                <tr>
                                    <td>${cf.month}</td>
                                    <td class="text-end text-success">${formatCurrency(cf.inflow)}</td>
                                    <td class="text-end text-danger">${formatCurrency(cf.outflow)}</td>
                                    <td class="text-end ${cf.net >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(cf.net)}</td>
                                    <td class="text-end text-info">${formatCurrency(cf.cumulative)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <script>
            setTimeout(() => {
                const ctx = document.getElementById('cashFlowChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ${JSON.stringify(months)},
                            datasets: [
                                {
                                    label: 'التدفقات الداخلة',
                                    data: ${JSON.stringify(cashFlowForecast.map(cf => cf.inflow))},
                                    borderColor: '#28a745',
                                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                    fill: true
                                },
                                {
                                    label: 'التدفقات الخارجة',
                                    data: ${JSON.stringify(cashFlowForecast.map(cf => cf.outflow))},
                                    borderColor: '#dc3545',
                                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                    fill: true
                                },
                                {
                                    label: 'الرصيد التراكمي',
                                    data: ${JSON.stringify(cashFlowForecast.map(cf => cf.cumulative))},
                                    borderColor: '#007bff',
                                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                    fill: true,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            interaction: { mode: 'index', intersect: false },
                            plugins: {
                                legend: { display: true, labels: { color: '#fff' } },
                                title: { display: true, text: 'تنبؤ التدفقات النقدية', color: '#fff' }
                            },
                            scales: {
                                y: { 
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    ticks: { color: '#fff' },
                                    grid: { color: 'rgba(255,255,255,0.1)' }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    ticks: { color: '#fff' },
                                    grid: { drawOnChartArea: false }
                                },
                                x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                            }
                        }
                    });
                }
            }, 500);
        <\/script>
    `;
}

// 3️⃣ سيناريوهات متعددة
function generateMultipleScenarios(data) {
    if (!data) {
        return `<div class="alert alert-warning">لا توجد بيانات متاحة</div>`;
    }
    
    const scenarios = {
        optimistic: {
            name: 'السيناريو المتفائل',
            revenue: data.revenue * 1.2,
            cogs: data.cogs * 1.05,
            operatingExpenses: data.operatingExpenses * 0.95,
            probability: 30
        },
        realistic: {
            name: 'السيناريو الواقعي',
            revenue: data.revenue * 1.05,
            cogs: data.cogs * 1.03,
            operatingExpenses: data.operatingExpenses * 1.02,
            probability: 50
        },
        pessimistic: {
            name: 'السيناريو المتشائم',
            revenue: data.revenue * 0.9,
            cogs: data.cogs * 1.1,
            operatingExpenses: data.operatingExpenses * 1.1,
            probability: 20
        }
    };
    
    // حساب صافي الربح لكل سيناريو
    Object.keys(scenarios).forEach(key => {
        const s = scenarios[key];
        s.netIncome = s.revenue - s.cogs - s.operatingExpenses;
    });
    
    return `
        <div class="report-container">
            <h2 class="text-center mb-4"><i class="fas fa-sitemap"></i> تحليل السيناريوهات المتعددة</h2>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> <strong>تحليل السيناريوهات:</strong> تقييم الأداء المالي تحت ظروف مختلفة
            </div>
            
            <div class="row mb-4">
                ${Object.keys(scenarios).map((key, index) => {
                    const s = scenarios[key];
                    const colors = ['success', 'primary', 'danger'];
                    const icons = ['fa-smile', 'fa-meh', 'fa-frown'];
                    return `
                        <div class="col-md-4">
                            <div class="card bg-dark border-${colors[index]}">
                                <div class="card-header bg-${colors[index]} text-white">
                                    <h5><i class="fas ${icons[index]}"></i> ${s.name}</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>احتمالية الحدوث:</strong> <span class="text-${colors[index]}">${s.probability}%</span></p>
                                    <hr>
                                    <table class="table table-sm table-dark">
                                        <tr>
                                            <td>الإيرادات</td>
                                            <td class="text-end">${formatCurrency(s.revenue)}</td>
                                        </tr>
                                        <tr>
                                            <td>تكلفة المبيعات</td>
                                            <td class="text-end">${formatCurrency(s.cogs)}</td>
                                        </tr>
                                        <tr>
                                            <td>المصروفات</td>
                                            <td class="text-end">${formatCurrency(s.operatingExpenses)}</td>
                                        </tr>
                                        <tr class="table-${colors[index]}">
                                            <td><strong>صافي الربح</strong></td>
                                            <td class="text-end"><strong>${formatCurrency(s.netIncome)}</strong></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <canvas id="scenarioComparisonChart" width="400" height="300"></canvas>
                </div>
                <div class="col-md-6">
                    <canvas id="probabilityChart" width="400" height="300"></canvas>
                </div>
            </div>
            
            <div class="card bg-dark border-warning mt-4">
                <div class="card-header bg-warning text-dark">
                    <h5><i class="fas fa-lightbulb"></i> التوصيات</h5>
                </div>
                <div class="card-body">
                    <ul>
                        <li><strong>السيناريو المتفائل:</strong> يتطلب زيادة الطاقة الإنتاجية والاستثمار في التسويق</li>
                        <li><strong>السيناريو الواقعي:</strong> الحفاظ على الأداء الحالي مع تحسينات تدريجية</li>
                        <li><strong>السيناريو المتشائم:</strong> وضع خطط طوارئ وتقليل المصروفات الثابتة</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <script>
            setTimeout(() => {
                // Comparison Chart
                const ctx1 = document.getElementById('scenarioComparisonChart');
                if (ctx1) {
                    new Chart(ctx1, {
                        type: 'bar',
                        data: {
                            labels: ['الإيرادات', 'تكلفة المبيعات', 'المصروفات', 'صافي الربح'],
                            datasets: [
                                {
                                    label: 'متفائل',
                                    data: [${scenarios.optimistic.revenue}, ${scenarios.optimistic.cogs}, ${scenarios.optimistic.operatingExpenses}, ${scenarios.optimistic.netIncome}],
                                    backgroundColor: 'rgba(40, 167, 69, 0.7)'
                                },
                                {
                                    label: 'واقعي',
                                    data: [${scenarios.realistic.revenue}, ${scenarios.realistic.cogs}, ${scenarios.realistic.operatingExpenses}, ${scenarios.realistic.netIncome}],
                                    backgroundColor: 'rgba(0, 123, 255, 0.7)'
                                },
                                {
                                    label: 'متشائم',
                                    data: [${scenarios.pessimistic.revenue}, ${scenarios.pessimistic.cogs}, ${scenarios.pessimistic.operatingExpenses}, ${scenarios.pessimistic.netIncome}],
                                    backgroundColor: 'rgba(220, 53, 69, 0.7)'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true, labels: { color: '#fff' } },
                                title: { display: true, text: 'مقارنة السيناريوهات', color: '#fff' }
                            },
                            scales: {
                                y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                                x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                            }
                        }
                    });
                }
                
                // Probability Chart
                const ctx2 = document.getElementById('probabilityChart');
                if (ctx2) {
                    new Chart(ctx2, {
                        type: 'doughnut',
                        data: {
                            labels: ['متفائل', 'واقعي', 'متشائم'],
                            datasets: [{
                                data: [30, 50, 20],
                                backgroundColor: ['#28a745', '#007bff', '#dc3545']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true, labels: { color: '#fff' } },
                                title: { display: true, text: 'احتمالية السيناريوهات', color: '#fff' }
                            }
                        }
                    });
                }
            }, 500);
        <\/script>
    `;
}

// 4️⃣ تنبؤ ذكي AI
function generateAIForecast(data) {
    if (!data) {
        return `<div class="alert alert-warning">لا توجد بيانات متاحة</div>`;
    }
    
    // محاكاة تنبؤات AI
    const aiPredictions = {
        nextQuarter: {
            revenue: data.revenue * 1.08,
            confidence: 85,
            factors: ['موسم الذروة', 'زيادة الطلب', 'توسع السوق']
        },
        nextYear: {
            revenue: data.revenue * 1.25,
            confidence: 72,
            factors: ['النمو الاقتصادي', 'دخول أسواق جديدة', 'إطلاق منتجات جديدة']
        },
        risks: [
            { name: 'تقلبات السوق', probability: 35, impact: 'متوسط' },
            { name: 'المنافسة', probability: 45, impact: 'عالي' },
            { name: 'تغيرات تنظيمية', probability: 20, impact: 'منخفض' }
        ]
    };
    
    return `
        <div class="report-container">
            <h2 class="text-center mb-4"><i class="fas fa-robot"></i> التنبؤ الذكي بالذكاء الاصطناعي</h2>
            
            <div class="alert alert-primary">
                <i class="fas fa-brain"></i> <strong>نموذج AI:</strong> تم استخدام خوارزميات التعلم الآلي لتحليل البيانات التاريخية والتنبؤ بالأداء المستقبلي
            </div>
            
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card bg-dark border-primary">
                        <div class="card-header bg-primary text-white">
                            <h5><i class="fas fa-calendar-alt"></i> تنبؤ الربع القادم</h5>
                        </div>
                        <div class="card-body">
                            <h3 class="text-center text-success">${formatCurrency(aiPredictions.nextQuarter.revenue)}</h3>
                            <div class="progress mb-3">
                                <div class="progress-bar bg-success" style="width: ${aiPredictions.nextQuarter.confidence}%">
                                    ${aiPredictions.nextQuarter.confidence}% ثقة
                                </div>
                            </div>
                            <p><strong>العوامل المؤثرة:</strong></p>
                            <ul>
                                ${aiPredictions.nextQuarter.factors.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card bg-dark border-info">
                        <div class="card-header bg-info text-white">
                            <h5><i class="fas fa-calendar-check"></i> تنبؤ السنة القادمة</h5>
                        </div>
                        <div class="card-body">
                            <h3 class="text-center text-success">${formatCurrency(aiPredictions.nextYear.revenue)}</h3>
                            <div class="progress mb-3">
                                <div class="progress-bar bg-info" style="width: ${aiPredictions.nextYear.confidence}%">
                                    ${aiPredictions.nextYear.confidence}% ثقة
                                </div>
                            </div>
                            <p><strong>العوامل المؤثرة:</strong></p>
                            <ul>
                                ${aiPredictions.nextYear.factors.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card bg-dark border-danger mb-4">
                <div class="card-header bg-danger text-white">
                    <h5><i class="fas fa-exclamation-triangle"></i> تحليل المخاطر</h5>
                </div>
                <div class="card-body">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>المخاطر</th>
                                <th class="text-center">الاحتمالية</th>
                                <th class="text-center">التأثير</th>
                                <th class="text-center">الإجراء</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${aiPredictions.risks.map(risk => `
                                <tr>
                                    <td>${risk.name}</td>
                                    <td class="text-center">
                                        <span class="badge ${risk.probability > 40 ? 'bg-danger' : risk.probability > 25 ? 'bg-warning' : 'bg-success'}">
                                            ${risk.probability}%
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge ${risk.impact === 'عالي' ? 'bg-danger' : risk.impact === 'متوسط' ? 'bg-warning' : 'bg-success'}">
                                            ${risk.impact}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-primary">عرض</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12">
                    <canvas id="aiTrendChart" width="400" height="150"></canvas>
                </div>
            </div>
            
            <div class="alert alert-success mt-4">
                <h5><i class="fas fa-check-circle"></i> التوصيات الذكية</h5>
                <ul>
                    <li>📈 <strong>زيادة الاستثمار في التسويق</strong> - متوقع عائد 15% خلال 6 أشهر</li>
                    <li>💰 <strong>تحسين إدارة المخزون</strong> - توفير محتمل 8% من التكاليف</li>
                    <li>🎯 <strong>التركيز على المنتجات عالية الهامش</strong> - زيادة الربحية 12%</li>
                </ul>
            </div>
        </div>
        
        <script>
            setTimeout(() => {
                const ctx = document.getElementById('aiTrendChart');
                if (ctx) {
                    const historicalData = [
                        ${data.revenue * 0.7}, ${data.revenue * 0.75}, ${data.revenue * 0.82}, 
                        ${data.revenue * 0.88}, ${data.revenue * 0.93}, ${data.revenue}
                    ];
                    const forecastData = [
                        ${data.revenue}, ${data.revenue * 1.03}, ${data.revenue * 1.06}, 
                        ${aiPredictions.nextQuarter.revenue}, ${data.revenue * 1.15}, ${aiPredictions.nextYear.revenue}
                    ];
                    
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['6 أشهر سابقة', '5 أشهر', '4 أشهر', '3 أشهر', '2 أشهر', 'الشهر الحالي', 
                                     'الشهر القادم', 'شهرين', '3 أشهر', 'الربع القادم', '6 أشهر', 'السنة القادمة'],
                            datasets: [
                                {
                                    label: 'البيانات التاريخية',
                                    data: [...historicalData, null, null, null, null, null, null],
                                    borderColor: '#007bff',
                                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                    fill: true
                                },
                                {
                                    label: 'التنبؤات AI',
                                    data: [null, null, null, null, null, ...forecastData],
                                    borderColor: '#28a745',
                                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                    borderDash: [5, 5],
                                    fill: true
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true, labels: { color: '#fff' } },
                                title: { display: true, text: 'الاتجاه التاريخي والتنبؤات المستقبلية', color: '#fff' }
                            },
                            scales: {
                                y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                                x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                            }
                        }
                    });
                }
            }, 500);
        <\/script>
    `;
}
// ========== Export All Reports (Board Pack) - محسّن ==========
function exportAllReports() {
    const data = getData();
    
    if (!data) {
        alert('لا توجد بيانات متاحة للتصدير');
        return;
    }
    
    // قائمة التقارير
    const reports = [
        { id: 'sovereign-fs', title: 'القوائم المالية الشاملة' },
        { id: 'budget-comparison', title: 'مقارنة الموازنة بالفعلي' },
        { id: 'revenue-forecast', title: 'تنبؤ الإيرادات' }
    ];
    
    // إنشاء نافذة جديدة
    const printWindow = window.open('', '_blank');
    
    let fullHTML = `
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <title>Board Pack</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                @media print {
                    body { background: white; color: black; }
                    .page-break { page-break-after: always; }
                    .no-print { display: none; }
                }
                body { 
                    font-family: Arial; 
                    direction: rtl; 
                    padding: 20px;
                    background: white;
                    color: black;
                }
                h1 { 
                    text-align: center; 
                    color: #00BFFF; 
                    border-bottom: 3px solid #00BFFF;
                    padding: 20px;
                }
                h2 { 
                    color: #333; 
                    border-bottom: 2px solid #00BFFF; 
                    padding: 10px 0;
                    margin-top: 30px;
                }
                table { 
                    width: 100%; 
                    margin: 20px 0;
                    border-collapse: collapse;
                }
                th, td { 
                    border: 1px solid #ddd; 
                    padding: 8px; 
                    text-align: right; 
                }
                th { 
                    background-color: #00BFFF !important; 
                    color: white !important; 
                }
                .bg-dark { background: #f5f5f5 !important; }
                .text-white { color: #000 !important; }
                .card { 
                    border: 1px solid #ddd; 
                    padding: 15px; 
                    margin: 10px 0;
                    background: white;
                }
            </style>
        </head>
        <body>
            <div class="no-print" style="text-align: center; margin-bottom: 20px;">
                <button onclick="window.print( )" class="btn btn-primary">
                    <i class="fas fa-print"></i> طباعة / حفظ PDF
                </button>
                <button onclick="window.close()" class="btn btn-secondary">
                    إغلاق
                </button>
            </div>
            
            <h1>📊 Board Pack - حزمة التقارير التنفيذية</h1>
            <p style="text-align: center; color: #666; margin-bottom: 40px;">
                <strong>التاريخ:</strong> ${new Date().toLocaleDateString('ar-SA')} | 
                <strong>الوقت:</strong> ${new Date().toLocaleTimeString('ar-SA')}
            </p>
    `;
    
    // إضافة كل تقرير
    reports.forEach((report, index) => {
        let content = generateReportContent(report.id, report.title);
        
        // تنظيف المحتوى
        content = content
            .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
            .replace(/<canvas[^>]*><\/canvas>/gi, '')
            .replace(/setTimeout\([^)]*\)/gi, '');
        
        fullHTML += `
            <div class="report-section">
                <h2>${index + 1}. ${report.title}</h2>
                ${content}
            </div>
            ${index < reports.length - 1 ? '<div class="page-break"></div>' : ''}
        `;
    });
    
    fullHTML += `
        </body>
        </html>
    `;
    
    printWindow.document.write(fullHTML);
    printWindow.document.close();
    
    // تشغيل الطباعة تلقائياً بعد التحميل
    printWindow.onload = function() {
        setTimeout(() => {
            printWindow.print();
        }, 1000);
    };
}

    </script>
</body>
</html>
