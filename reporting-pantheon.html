<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ديوان الحكمة المالية - Polaris 2025</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
<script src="dataPipeline.js"></script>
<!-- للتصدير PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- للتصدير Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <style>
/* ================================================================== */
/* ########## START: الكود النهائي لقسم STYLE ########## */
/* ================================================================== */

:root { 
    --font-family-main: 'Tajawal', sans-serif; 
    --font-family-display: 'Orbitron', sans-serif; 
    --color-primary-glow: #00BFFF; 
    --color-bg: #010409; 
    --color-surface: rgba(13, 17, 23, 0.8); 
    --color-border: rgba(56, 139, 253, 0.3); 
    --color-text-primary: #E6EDF3; 
    --color-text-secondary: #7D8590; 
    --color-finance: #007bff;
    --color-management: #28a745;
    --color-strategy: #ffc107;
    --color-risk: #dc3545;
    --color-investment: #6f42c1;
}
body { 
    font-family: var(--font-family-main); 
    direction: rtl; 
    background-color: var(--color-bg); 
    color: var(--color-text-primary); 
    display: flex; 
    margin: 0;
    overflow-x: hidden;
}
.grid-background { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background-image: linear-gradient(to right, rgba(56, 139, 253, 0.1) 1px, transparent 1px), 
                    linear-gradient(to bottom, rgba(56, 139, 253, 0.1) 1px, transparent 1px); 
    background-size: 40px 40px; z-index: -2; 
}
.glow-background { 
    position: fixed; top: 50%; left: 50%; width: 800px; height: 800px; 
    background: radial-gradient(circle, rgba(0, 191, 255, 0.1), transparent 60%); 
    transform: translate(-50%, -50%); 
    animation: pulse 10s infinite ease-in-out; z-index: -1; 
}
@keyframes pulse { 
    0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; } 
    50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.8; } 
}
.sidebar { 
    width: 80px; height: 100vh; background-color: var(--color-surface); 
    border-left: 1px solid var(--color-border); backdrop-filter: blur(10px); 
    display: flex; flex-direction: column; align-items: center; 
    padding: 1.5rem 0; flex-shrink: 0; position: sticky; top: 0; 
}
.app-logo { 
    color: var(--color-primary-glow); font-size: 2rem; 
    margin-bottom: 2.5rem; text-decoration: none; transition: all 0.3s ease;
}
.app-logo:hover { transform: rotate(180deg); color: #fff; }
.sidebar-icon {
    width: 50px; height: 50px; display: flex; align-items: center;
    justify-content: center; color: var(--color-text-secondary); font-size: 1.5rem;
    border-radius: 8px; margin-bottom: 1rem; transition: all 0.3s ease;
    text-decoration: none; position: relative;
}
.sidebar-icon:hover {
    background-color: rgba(0, 191, 255, 0.1); color: var(--color-primary-glow);
    transform: scale(1.1);
}
.sidebar-icon::after {
    content: attr(title); position: absolute; right: 60px;
    background-color: var(--color-surface); color: var(--color-text-primary);
    padding: 0.5rem 1rem; border-radius: 6px; white-space: nowrap;
    opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    border: 1px solid var(--color-border);
}
.sidebar-icon:hover::after { opacity: 1; }
.main-content { flex-grow: 1; padding: 2rem 3rem; overflow-y: auto; height: 100vh; }
.page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
.page-title { 
    font-family: var(--font-family-display); font-size: 2.5rem; margin: 0;
    background: linear-gradient(135deg, var(--color-primary-glow), #fff);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
.top-icons { display:flex; gap:.5rem; align-items:center; margin-top:.5rem; }
.top-icons a{ display:inline-flex; align-items:center; justify-content:center; width:34px; height:34px; border:1px solid #30363d; border-radius:8px; color:#c9d1d9; text-decoration:none }
.top-icons a:hover{ background:#1f2937 }
.pantheon-wing { 
    background-color: var(--color-surface); border: 1px solid var(--color-border); 
    border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; 
    backdrop-filter: blur(5px); transition: all 0.3s ease;
}
.pantheon-wing:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0, 191, 255, 0.2); }
.wing-header { 
    display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; 
    padding-bottom: 1rem; border-bottom: 1px solid var(--color-border); 
}
.wing-icon { font-size: 2rem; text-shadow: 0 0 10px currentColor; }
.wing-title { font-family: var(--font-family-display); font-size: 1.5rem; margin: 0; }
.wing-subtitle { color: var(--color-text-secondary); margin: 0; font-size: 0.9rem; }
.wing-badge {
    background-color: rgba(0, 191, 255, 0.2); color: var(--color-primary-glow);
    padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;
    font-weight: bold; margin-right: auto;
}
.report-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
.report-card { 
    background-color: rgba(0,0,0,0.2); border: 1px solid transparent; 
    padding: 1rem; border-radius: 8px; transition: all 0.3s ease; 
    cursor: pointer; position: relative;
}
.report-card:hover { 
    transform: translateY(-5px); border-color: var(--color-primary-glow); 
    background-color: rgba(0, 191, 255, 0.05); box-shadow: 0 5px 15px rgba(0, 191, 255, 0.3);
}
.report-card h6 { margin-bottom: 0.5rem; font-weight: 600; }
.report-card p { font-size: 0.85rem; color: var(--color-text-secondary); margin-bottom: 0; }
.report-status {
    position: absolute; top: 10px; left: 10px; font-size: 0.7rem;
    padding: 3px 8px; border-radius: 4px; font-weight: bold;
}
.status-ready { background-color: rgba(40, 167, 69, 0.3); color: #28a745; border: 1px solid #28a745; }
.status-dev { background-color: rgba(255, 193, 7, 0.3); color: #ffc107; border: 1px solid #ffc107; }
.modal-content { 
    background-color: var(--color-surface); border: 1px solid var(--color-border); 
    color: var(--color-text-primary); backdrop-filter: blur(15px); border-radius: 12px; 
}
.modal-header, .modal-footer { border-color: var(--color-border); }
.modal-header { background: linear-gradient(135deg, rgba(0, 191, 255, 0.1), transparent); }
.modal-title { font-family: var(--font-family-display); color: var(--color-primary-glow); }
.btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
.btn-primary {
    background-color: var(--color-primary-glow); border-color: var(--color-primary-glow);
    color: #000; font-weight: bold;
}
.btn-primary:hover { background-color: #0099cc; border-color: #0099cc; transform: scale(1.05); }
.stats-card {
    background: linear-gradient(135deg, rgba(0, 191, 255, 0.1), rgba(0, 191, 255, 0.05));
    border: 1px solid var(--color-border); border-radius: 8px;
    padding: 1.5rem; text-align: center; transition: all 0.3s ease;
}
.stats-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 191, 255, 0.2); }
.stats-card h3 { font-family: var(--font-family-display); font-size: 2rem; margin: 0; color: var(--color-primary-glow); }
.stats-card p { margin: 0; color: var(--color-text-secondary); font-size: 0.9rem; }
.search-box { position: relative; margin-bottom: 2rem; }
.search-box input {
    background-color: var(--color-surface); border: 1px solid var(--color-border);
    color: var(--color-text-primary); padding: 0.75rem 1rem 0.75rem 3rem;
    border-radius: 8px; width: 100%; transition: all 0.3s ease;
}
.search-box input:focus { outline: none; border-color: var(--color-primary-glow); box-shadow: 0 0 10px rgba(0, 191, 255, 0.3); }
.search-box i { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-secondary); }
.filter-buttons { display: flex; gap: 0.5rem; margin-bottom: 2rem; flex-wrap: wrap; }
.filter-btn {
    background-color: var(--color-surface); border: 1px solid var(--color-border);
    color: var(--color-text-primary); padding: 0.5rem 1rem;
    border-radius: 20px; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem;
}
.filter-btn:hover, .filter-btn.active {
    background-color: var(--color-primary-glow); color: #000;
    border-color: var(--color-primary-glow); transform: scale(1.05);
}
.table { color: var(--color-text-primary); }
.table-dark { background-color: rgba(0, 0, 0, 0.3); }
.table-striped tbody tr:nth-of-type(odd) { background-color: rgba(0, 191, 255, 0.05); }
.table-hover tbody tr:hover { background-color: rgba(0, 191, 255, 0.1); }
.chart-container { position: relative; height: 400px; margin: 2rem 0; }
.loading-spinner {
    display: inline-block; width: 40px; height: 40px;
    border: 4px solid rgba(0, 191, 255, 0.3); border-top-color: var(--color-primary-glow);
    border-radius: 50%; animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.alert { border-radius: 8px; border: 1px solid; }
.alert-info { background-color: rgba(0, 191, 255, 0.1); border-color: var(--color-primary-glow); color: var(--color-text-primary); }
.alert-success { background-color: rgba(40, 167, 69, 0.1); border-color: #28a745; color: var(--color-text-primary); }
.alert-warning { background-color: rgba(255, 193, 7, 0.1); border-color: #ffc107; color: var(--color-text-primary); }
.alert-danger { background-color: rgba(220, 53, 69, 0.1); border-color: #dc3545; color: var(--color-text-primary); }
::-webkit-scrollbar { width: 10px; }
::-webkit-scrollbar-track { background: var(--color-bg); }
::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 5px; }
::-webkit-scrollbar-thumb:hover { background: var(--color-primary-glow); }

/* ================================================================== */
/* --- START: أنماط العرض التقديمي الاحترافي (النهائي) --- */
/* ================================================================== */
#presentation-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: var(--color-bg); z-index: 2000;
    display: none; flex-direction: column; overflow: hidden;
}
#presentation-content {
    width: 100%; height: 100%; display: flex;
    transition: transform 0.4s ease-in-out;
}
.presentation-slide {
    min-width: 100%; height: 100%; overflow-y: auto;
    padding: 2rem 4rem; background-color: transparent;
}
.presentation-nav {
    position: absolute; top: 50%; transform: translateY(-50%);
    background-color: rgba(0, 170, 255, 0.4); color: white; border: none;
    border-radius: 50%; width: 50px; height: 50px; font-size: 1.5rem;
    cursor: pointer; z-index: 2001; opacity: 0; transition: opacity 0.3s;
}
#presentation-overlay:hover .presentation-nav { opacity: 0.7; }
.presentation-nav:hover { opacity: 1 !important; }
#pres-nav-next { right: 20px; }
#pres-nav-prev { left: 20px; }
#pres-exit-btn {
    position: absolute; top: 20px; right: 20px;
    background-color: rgba(220, 53, 69, 0.6); color: white; border: none;
    border-radius: 50%; width: 40px; height: 40px; font-size: 1.2rem;
    cursor: pointer; z-index: 2001; opacity: 0; transition: opacity 0.3s;
}
#presentation-overlay:hover #pres-exit-btn { opacity: 0.7; }
#pres-exit-btn:hover { opacity: 1 !important; }
#slide-counter {
    position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
    background-color: rgba(13, 17, 23, 0.8); color: var(--color-text-secondary);
    padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;
    z-index: 2001; border: 1px solid var(--color-border);
    opacity: 0; transition: opacity 0.3s;
}
#presentation-overlay:hover #slide-counter { opacity: 1; }
/* ... بعد كود .presentation-nav ... */
#pres-play-pause {
    left: 50%;
    transform: translate(-50%, -50%);
}

/* ================================================================== */
/* --- END: أنماط العرض التقديمي --- */
/* ================================================================== */
/* ======================================================= */
/* --- START: الإصلاح الجذري لوضوح النصوص (بناءً على طلبك) --- */
/* ======================================================= */

/* هذا الكود يستهدف أي نص داخل قسم التوصيات ويجعله أبيض */
.card-body p, .card-body li, .card-body h6 {
    color: var(--color-text-primary) !important;
}

/* هذا الكود يستهدف أي نص داخل القوائم التفاعلية (مثل قائمة الإغلاق) */
.accordion-body .form-check-label {
    color: var(--color-text-primary) !important;
    opacity: 1 !important; /* إزالة أي شفافية */
}

/* عند شطب النص، نجعله رماديًا فاتحًا بدلاً من باهت جدًا */
.accordion-body .form-check-label.text-muted {
    color: var(--color-text-secondary) !important;
}

/* ======================================================= */
/* --- END: الإصلاح الجذري --- */
/* ======================================================= */

    </style>
</head>
<body>

    <div class="grid-background"></div>
    <div class="glow-background"></div>

<main class="main-content">
        <div class="page-header">
            <div>
                <h1 class="page-title">ديوان الحكمة المالية</h1>
                <p class="text-secondary">44 تقريرًا استراتيجيًا موزعة على 7 أجنحة - نسخة 2025</p>
                <div class="top-icons">
                    <a id="top_home" href="index.html" class="sidebar-icon" title="الرئيسية"><i class="fas fa-home"></i></a>
                    <a id="top_mapping" href="account-mapping.html" class="sidebar-icon" title="الاستيعاب" onclick="goToAccountMapping(); return false;"><i class="fas fa-balance-scale"></i></a>
                    <a id="top_cockpit" href="consolidation-cockpit.html" class="sidebar-icon" title="القوائم المالية"><i class="fas fa-file-invoice"></i></a>
                    <a id="top_reports" href="reporting-pantheon.html" class="sidebar-icon" title="التقارير"><i class="fas fa-book-open"></i></a>
                </div>
            </div>
   <!-- ======================================================= -->
<!-- START: أزرار التحكم الجديدة (عرض + تحميل) -->
<!-- ======================================================= -->
<div class="btn-group" role="group">
    <button type="button" class="btn btn-success" onclick="openPresentationBuilder( )">
        <i class="fas fa-play-circle me-2"></i> بدء العرض
    </button>
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
            <i class="fas fa-download me-2"></i> تحميل التقارير
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="exportAllReports()"><i class="fas fa-file-pdf me-2"></i>حزمة PDF</a></li>
            <li><a class="dropdown-item" href="#" onclick="exportToPowerPoint()"><i class="fas fa-file-powerpoint me-2"></i>ملف PowerPoint</a></li>
        </ul>
    </div>
</div>
<!-- ======================================================= -->
<!-- END: أزرار التحكم الجديدة -->
<!-- ======================================================= -->



        </div>

        <!-- Statistics Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <h3>44</h3>
                    <p>إجمالي التقارير</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3>7</h3>
                    <p>الأجنحة الرئيسية</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3>100%</h3>
                    <p>جاهزة للعمل</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3>IFRS</h3>
                    <p>متوافق مع المعايير</p>
                </div>
            </div>
        </div>

        <!-- Search Box -->
 
        <!-- Filter Buttons -->
     <!-- Filter Buttons -->
<div class="filter-buttons">
    <button class="filter-btn active" onclick="filterWing('all', this)">الكل</button>
    <button class="filter-btn" onclick="filterWing('budget', this)">قسم الموازنة</button>
    <button class="filter-btn" onclick="filterWing('forecast', this)">قسم التنبؤات</button>
    <button class="filter-btn" onclick="filterWing('finance', this)">ديوان المالية</button>
    <button class="filter-btn" onclick="filterWing('management', this)">ديوان الإدارة</button>
    <button class="filter-btn" onclick="filterWing('strategy', this)">ديوان الاستراتيجية</button>
    <button class="filter-btn" onclick="filterWing('risk', this)">ديوان المخاطر</button>
    <button class="filter-btn" onclick="filterWing('investment', this)">ديوان الاستثمار</button>
</div>


     <!-- ======================================================= -->
<!-- START: الهيكل الصحيح والنهائي للأقسام المالية -->
<!-- ======================================================= -->

<!-- Budget Section (قسم الموازنة - مستقل) -->
<div class="pantheon-wing" data-wing="budget">
    <div class="wing-header">
        <i class="wing-icon fas fa-calculator" style="color: var(--color-finance);"></i>
        <div>
            <h3 class="wing-title">قسم الموازنة (Budget)</h3>
            <p class="wing-subtitle">إعداد ومتابعة الموازنات التقديرية</p>
        </div>
        <span class="wing-badge">4 تقارير</span>
    </div>
    <div class="report-grid">
        <div class="report-card" onclick="openReport('budget-preparation', 'إعداد الموازنة السنوية')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-chart-bar"></i> إعداد الموازنة السنوية</h6>
            <p>إدخال الموازنة التقديرية للإيرادات والمصروفات</p>
        </div>
        <div class="report-card" onclick="openReport('budget-comparison', 'مقارنة الموازنة بالفعلي')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-balance-scale"></i> مقارنة الموازنة بالفعلي</h6>
            <p>تحليل الانحرافات وتفسير الفروقات</p>
        </div>
        <div class="report-card" onclick="openReport('budget-update', 'تحديث الموازنة')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-sync-alt"></i> تحديث الموازنة</h6>
            <p>تعديل الموازنة بناءً على المستجدات</p>
        </div>
        <div class="report-card" onclick="openReport('budget-analysis', 'تحليل الموازنة')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-chart-pie"></i> تحليل الموازنة</h6>
            <p>رسوم بيانية ومؤشرات الأداء</p>
        </div>
    </div>
</div>

<!-- Forecasting Section (قسم التنبؤات - مستقل) -->
<div class="pantheon-wing" data-wing="forecast">
    <div class="wing-header">
        <i class="wing-icon fas fa-crystal-ball" style="color: var(--color-strategy);"></i>
        <div>
            <h3 class="wing-title">قسم التنبؤات المالية</h3>
            <p class="wing-subtitle">التوقعات والسيناريوهات المستقبلية</p>
        </div>
        <span class="wing-badge">4 تقارير</span>
    </div>
    <div class="report-grid">
        <div class="report-card" onclick="openReport('revenue-forecast', 'تنبؤ الإيرادات')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-chart-line"></i> تنبؤ الإيرادات</h6>
            <p>توقعات الإيرادات للـ 12 شهر القادمة</p>
        </div>
        <div class="report-card" onclick="openReport('cashflow-forecast', 'تنبؤ التدفقات النقدية')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-money-bill-wave"></i> تنبؤ التدفقات النقدية</h6>
            <p>توقعات السيولة والاحتياجات النقدية</p>
        </div>
        <div class="report-card" onclick="openReport('multiple-scenarios', 'سيناريوهات متعددة')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-sitemap"></i> سيناريوهات متعددة</h6>
            <p>سيناريو متفائل، واقعي، متشائم</p>
        </div>
        <div class="report-card" onclick="openReport('ai-forecast', 'تنبؤ ذكي AI')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-robot"></i> تنبؤ ذكي AI</h6>
            <p>استخدام الذكاء الاصطناعي للتنبؤ</p>
        </div>
    </div>
</div>     

<!-- Wing 1: Finance (ديوان المالية - مستقل) -->
<div class="pantheon-wing" data-wing="finance">
    <div class="wing-header">
        <i class="wing-icon fas fa-coins" style="color: var(--color-finance);"></i>
        <div>
            <h3 class="wing-title">ديوان المالية</h3>
            <p class="wing-subtitle">التقارير المالية الأساسية والالتزامات القانونية</p>
        </div>
        <span class="wing-badge">8 تقارير</span>
    </div>
    <div class="report-grid">
        <div class="report-card" onclick="openReport('yearend-checklist', 'إغلاق نهاية العام')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-tasks"></i> إغلاق نهاية العام</h6>
            <p>إعداد ملفات ZATCA، XML، Qawaem، زكاة</p>
        </div>
        <div class="report-card" onclick="openReport('sovereign-fs', 'قوائم مالية + 13 إيضاح')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-file-invoice"></i> قوائم مالية + 13 إيضاح</h6>
            <p>قائمة الدخل، المركز المالي، التدفقات، التغيرات في حقوق الملكية</p>
        </div>
        <div class="report-card" onclick="openReport('sovereign-audit', 'تقرير المراجعة')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-stamp"></i> تقرير المراجعة</h6>
            <p>رأي المراجع، ملاحظات، مطابقة IFRS</p>
        </div>
        <div class="report-card" onclick="openReport('budget-variance', 'Budget vs Actual')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-chart-line"></i> Budget vs Actual</h6>
            <p>مقارنة الإيرادات والمصروفات بالموازنة (رسم بياني)</p>
        </div>
        <div class="report-card" onclick="openReport('profit-forecast', 'تنبؤ ربح 12 شهر')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-crystal-ball"></i> تنبؤ ربح 12 شهر</h6>
            <p>توقعات شهرية (Base, High, Low) – خط بياني</p>
        </div>
        <div class="report-card" onclick="openReport('cash-forecast', 'تدفق نقدي Sankey')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-water"></i> تدفق نقدي (Sankey)</h6>
            <p>تدفقات نقدية من/إلى الأنشطة (مخطط Sankey)</p>
        </div>
        <div class="report-card" onclick="openReport('loan-capacity', 'سعة القروض DSCR')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-hand-holding-usd"></i> سعة القروض (DSCR)</h6>
            <p>نسبة تغطية الدين، الحد الأقصى للقروض</p>
        </div>
        <div class="report-card" onclick="openReport('money-flow', 'مصادر واستخدامات')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-exchange-alt"></i> مصادر واستخدامات</h6>
            <p>مصادر الأموال، استخداماتها (رسوم دائرية)</p>
        </div>
    </div>
</div>

<!-- ======================================================= -->
<!-- END: الهيكل الصحيح والنهائي للأقسام المالية -->
<!-- ======================================================= -->


        <!-- Wing 2: Management (4 Reports) -->
        <div class="pantheon-wing" data-wing="management">
            <div class="wing-header">
                <i class="wing-icon fas fa-chart-pie" style="color: var(--color-management);"></i>
                <div>
                    <h3 class="wing-title">ديوان الإدارة</h3>
                    <p class="wing-subtitle">مؤشرات الأداء والتحليلات التشغيلية</p>
                </div>
                <span class="wing-badge">4 تقارير</span>
            </div>
            <div class="report-grid">
                <div class="report-card" onclick="openReport('kpi-dashboard', 'KPIs Dashboard')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-tachometer-alt"></i> KPIs Dashboard</h6>
                    <p>هامش الربح، DSCR، ROE، CCC</p>
                </div>
                <div class="report-card" onclick="openReport('profitability-dim', 'ربحية حسب البعد')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-cube"></i> ربحية حسب البعد</h6>
                    <p>حسب المنتج، العميل، القسم، المنطقة</p>
                </div>
                <div class="report-card" onclick="openReport('working-capital', 'رأس المال العامل')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-cogs"></i> رأس المال العامل</h6>
                    <p>CCC، النسبة الحالية، السيولة</p>
                </div>
                <div class="report-card" onclick="openReport('abc-costing', 'تحليل التكاليف ABC')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-layer-group"></i> تحليل التكاليف (ABC)</h6>
                    <p>توزيع التكاليف حسب الأنشطة</p>
                </div>
            </div>
        </div>

        <!-- Wing 3: Strategy (8 Reports) -->
    <!-- ================================================================== -->
<!-- START: ديوان الاستراتيجية (V2 - مع إضافة BSC و SWOT) -->
<!-- ================================================================== -->
<div class="pantheon-wing" data-wing="strategy">
    <div class="wing-header">
        <i class="wing-icon fas fa-lightbulb" style="color: var(--color-strategy);"></i>
        <div>
            <h3 class="wing-title">ديوان الاستراتيجية</h3>
            <p class="wing-subtitle">أدوات التخطيط والتقييم الاستراتيجي الشامل</p>
        </div>
        <!-- تحديث عدد التقارير إلى 10 -->
        <span class="wing-badge">10 تقارير</span>
    </div>
    <div class="report-grid">
        <!-- *** التقرير الجديد الأول: بطاقة الأداء المتوازن *** -->
        <div class="report-card" onclick="openReport('balanced-scorecard', 'بطاقة الأداء المتوازن (BSC)')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-th"></i> بطاقة الأداء المتوازن (BSC)</h6>
            <p>ربط الرؤية بالأهداف عبر 4 أبعاد (مالي، عملاء، عمليات، تعلم)</p>
        </div>
        <!-- *** التقرير الجديد الثاني: تحليل SWOT *** -->
        <div class="report-card" onclick="openReport('swot-analysis', 'التحليل الاستراتيجي (SWOT)')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-search-plus"></i> التحليل الاستراتيجي (SWOT)</h6>
            <p>تحليل نقاط القوة والضعف والفرص والتهديدات</p>
        </div>

        <!-- التقارير القديمة تبقى كما هي -->
        <div class="report-card" onclick="openReport('breakeven-analysis', 'نقطة التعادل')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-balance-scale"></i> نقطة التعادل</h6>
            <p>BEP بالوحدات والريال، هامش الأمان</p>
        </div>
        <div class="report-card" onclick="openReport('whatif-scenarios', 'تحليل ماذا لو')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-question-circle"></i> تحليل ماذا لو</h6>
            <p>سيناريوهات تفاعلية (إيرادات، تكاليف)</p>
        </div>
        <div class="report-card" onclick="openReport('integrated-report', 'التقرير المتكامل')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-project-diagram"></i> التقرير المتكامل</h6>
            <p>6 رؤوس رأسمالية (مالي، صناعي، فكري، بشري، اجتماعي، طبيعي)</p>
        </div>
        <div class="report-card" onclick="openReport('dcf-valuation', 'DCF Valuation')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-calculator"></i> DCF Valuation</h6>
            <p>تقييم الشركة بـ DCF (FCFF + WACC)</p>
        </div>
        <div class="report-card" onclick="openReport('rim-valuation', 'Residual Income (RIM)')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-money-bill-wave"></i> Residual Income (RIM)</h6>
            <p>القيمة الدفترية + الأرباح المتبقية</p>
        </div>
        <div class="report-card" onclick="openReport('ddm-valuation', 'Dividend Discount (DDM)')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-percentage"></i> Dividend Discount (DDM)</h6>
            <p>تقييم بناءً على توزيعات الأرباح</p>
        </div>
        <div class="report-card" onclick="openReport('dupont-analysis', 'تحليل دوبونت')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-sitemap"></i> تحليل دوبونت</h6>
            <p>تفكيك ROE: هامش × دوران × رافعة</p>
        </div>
        <div class="report-card" onclick="openReport('eva-analysis', 'EVA (القيمة الاقتصادية المضافة)')">
            <span class="report-status status-ready">جاهز</span>
            <h6><i class="fas fa-chart-area"></i> EVA</h6>
            <p>NOPAT – (WACC × رأس المال)</p>
        </div>
    </div>
</div>
<!-- ================================================================== -->
<!-- END: ديوان الاستراتيجية (V2) -->
<!-- ================================================================== -->


        <!-- Wing 4: Risk (8 Reports) -->
        <div class="pantheon-wing" data-wing="risk">
            <div class="wing-header">
                <i class="wing-icon fas fa-exclamation-triangle" style="color: var(--color-risk);"></i>
                <div>
                    <h3 class="wing-title">ديوان المخاطر</h3>
                    <p class="wing-subtitle">نماذج التنبؤ بالإفلاس وإدارة المخاطر</p>
                </div>
                <span class="wing-badge">8 تقارير</span>
            </div>
            <div class="report-grid">
                <div class="report-card" onclick="openReport('altman-zscore', 'نموذج ألتمان Z-Score')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-shield-alt"></i> نموذج ألتمان (Z-Score)</h6>
                    <p>تنبؤ الإفلاس (آمن / رمادي / خطر)</p>
                </div>
                <div class="report-card" onclick="openReport('ohlson-oscore', 'نموذج أوهلسون O-Score')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-chart-line"></i> نموذج أوهلسون (O-Score)</h6>
                    <p>احتمالية الإفلاس (%) – Logistic</p>
                </div>
                <div class="report-card" onclick="openReport('zmijewski-xscore', 'نموذج زيميخوسكي X-Score')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-wave-square"></i> نموذج زيميخوسكي (X-Score)</h6>
                    <p>Probit – قوي في الأسواق المضطربة</p>
                </div>
                <div class="report-card" onclick="openReport('sherrod-model', 'نموذج شيرود')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-water"></i> نموذج شيرود (Cash Flow)</h6>
                    <p>التركيز على التدفق النقدي</p>
                </div>
                <div class="report-card" onclick="openReport('fulmer-hscore', 'نموذج فولمر H-Score')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-h-square"></i> نموذج فولمر (H-Score)</h6>
                    <p>9 نسب – أكثر دقة في بعض الحالات</p>
                </div>
                <div class="report-card" onclick="openReport('springate-sscore', 'نموذج سبرينجيت S-Score')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-s"></i> نموذج سبرينجيت (S-Score)</h6>
                    <p>4 نسب فقط – بسيط وفعّال</p>
                </div>
                <div class="report-card" onclick="openReport('ca-score-ai', 'CA-Score (AI)')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-robot"></i> CA-Score (AI)</h6>
                    <p>شبكات عصبية + بيانات ضخمة</p>
                </div>
                <div class="report-card" onclick="openReport('var-risk', 'Value at Risk (VaR)')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-dice"></i> Value at Risk (VaR)</h6>
                    <p>أقصى خسارة محتملة (99%)</p>
                </div>
            </div>
        </div>

        <!-- Wing 5: Investment (4 Reports) -->
        <div class="pantheon-wing" data-wing="investment">
            <div class="wing-header">
                <i class="wing-icon fas fa-chart-pie" style="color: var(--color-investment);"></i>
                <div>
                    <h3 class="wing-title">ديوان الاستثمار</h3>
                    <p class="wing-subtitle">نماذج التقييم وإدارة المحافظ الاستثمارية</p>
                </div>
                <span class="wing-badge">4 تقارير</span>
            </div>
            <div class="report-grid">
  
                <div class="report-card" onclick="openReport('famafrench-model', 'Fama-French 3-Factor')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-cubes"></i> Fama-French 3-Factor</h6>
                    <p>CAPM + حجم + قيمة</p>
                </div>
                <div class="report-card" onclick="openReport('mpt-portfolio', 'نظرية المحفظة الحديثة MPT')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-briefcase"></i> نظرية المحفظة الحديثة (MPT)</h6>
                    <p>الحد الأمثل للمخاطر والعائد</p>
                </div>
                <div class="report-card" onclick="openReport('sharpe-ratio', 'Sharpe Ratio')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-divide"></i> Sharpe Ratio</h6>
                    <p>العائد لكل وحدة مخاطرة</p>
                </div>
            </div>
        </div>

        <!-- Wing 6: Quality (2 Reports) -->
        <div class="pantheon-wing" data-wing="quality">
            <div class="wing-header">
                <i class="wing-icon fas fa-check-double" style="color: var(--color-primary-glow);"></i>
                <div>
                  <h3 class="wing-title">ديوان جودة الأرباح</h3>
                    <p class="wing-subtitle">الكشف عن التلاعب وجودة التقارير المالية</p>
                </div>
                <span class="wing-badge">2 تقارير</span>
            </div>
            <div class="report-grid">
               <!-- *** هذا هو التعديل الحاسم *** -->
<!-- الصقي هذا الكود مكانه -->
<div class="report-card" onclick="openReport('beneish-mscore', 'Beneish M-Score')">
    <span class="report-status status-ready">جاهز</span>
    <h6><i class="fas fa-search-dollar"></i> Beneish M-Score</h6>
    <p>الكشف عن التلاعب في الأرباح</p>
</div>

                <div class="report-card" onclick="openReport('sloan-accruals', 'Sloan\'s Accruals')">
                    <span class="report-status status-ready">جاهز</span>
                    <h6><i class="fas fa-file-contract"></i> Sloan's Accruals</h6>
                    <p>نسبة الاستحقاقات إلى النقد</p>
                </div>
            </div>
        </div>
<!-- ======================================================= -->
<!-- START: Scenario Builder Modal (ورشة العمل الاستراتيجية) -->
<!-- ======================================================= -->
<div class="modal fade" id="scenarioBuilderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scenarioBuilderModalLabel">إنشاء سيناريو استراتيجي جديد</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editingScenarioIndex" value="-1">
                <div class="mb-3">
                    <label for="scenarioNameInput" class="form-label">اسم السيناريو (مثال: حملة رمضان التسويقية)</label>
                    <input type="text" class="form-control" id="scenarioNameInput" placeholder="أدخل اسمًا وصفيًا للسيناريو">
                </div>
                <hr>
                <div id="scenarioInputs">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-info">محركات الإيرادات</h6>
                            <label class="form-label">تغير كمية البلوك (%): <span id="modal_blockQtyLabel" class="badge bg-primary">0%</span></label>
                            <input type="range" class="form-range" id="modal_blockQtyChange" value="0" min="-50" max="50" step="5">
                            
                            <label class="form-label mt-3">تغير سعر الخرسانة (ريال): <span id="modal_concretePriceLabel" class="badge bg-primary">+0 ريال</span></label>
                            <input type="range" class="form-range" id="modal_concretePriceChange" value="0" min="-50" max="50" step="5">
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-warning">محركات التكاليف</h6>
                            <label class="form-label">تغير تكلفة الوحدة المتغيرة (%): <span id="modal_vcUnitLabel" class="badge bg-warning">0%</span></label>
                            <input type="range" class="form-range" id="modal_vcUnitChange" value="0" min="-20" max="20" step="2">
                            
                            <label class="form-label mt-3">تغير التكاليف الثابتة (ريال): <span id="modal_fixedCostLabel" class="badge bg-warning">+0 ريال</span></label>
                            <input type="range" class="form-range" id="modal_fixedCostChange" value="0" min="-100000" max="100000" step="10000">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="saveScenario()">حفظ السيناريو</button>
            </div>
        </div>
    </div>
</div>
<!-- ======================================================= -->
<!-- END: Scenario Builder Modal -->
<!-- ======================================================= -->

    </main>
<!-- ======================================================= -->
<!-- START: Board Pack Builder Modal (منشئ حزمة التقارير) -->
<!-- ======================================================= -->
<div class="modal fade" id="boardPackModal" tabindex="-1" aria-labelledby="boardPackModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="boardPackModalLabel"><i class="fas fa-tools me-2"></i>منشئ حزمة التقارير التنفيذية</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">اختر التقارير التي ترغب في تضمينها في حزمة PDF النهائية.</div>
                
                <div class="row">
                    <!-- الجزء الأيمن: قائمة التقارير -->
                    <div class="col-md-8">
                        <div id="report-selection-list">
                            <!-- سيتم ملء هذه القائمة تلقائيًا بواسطة JavaScript -->
                        </div>
                    </div>

                    <!-- الجزء الأيسر: خيارات التخصيص -->
                    <div class="col-md-4">
                        <div class="card bg-dark border-primary">
                            <div class="card-header"><h5><i class="fas fa-cogs me-2"></i>خيارات التخصيص</h5></div>
                            <div class="card-body">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="includeCoverPage" checked>
                                    <label class="form-check-label" for="includeCoverPage">إضافة صفحة غلاف</label>
                                </div>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="includeTOC" checked>
                                    <label class="form-check-label" for="includeTOC">إضافة جدول محتويات</label>
                                </div>
                                <hr>
                                <div class="mb-3">
                                    <label for="executiveSummary" class="form-label">ملخص تنفيذي (اختياري)</label>
                                    <textarea class="form-control" id="executiveSummary" rows="5" placeholder="اكتب هنا ملخصًا أو ملاحظات ليتم إدراجها في بداية التقرير..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-success" onclick="generateAndExportPack()">
                    <i class="fas fa-cogs me-2"></i>إنشاء وتصدير الحزمة
                </button>
            </div>
        </div>
    </div>
</div>
<!-- ======================================================= -->
<!-- END: Board Pack Builder Modal -->
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- START: Presentation Builder Modal (منشئ العرض التقديمي) -->
<!-- ======================================================= -->
<div class="modal fade" id="presentationBuilderModal" tabindex="-1" aria-labelledby="presentationBuilderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="presentationBuilderModalLabel"><i class="fas fa-chalkboard-teacher me-2"></i>تجهيز العرض التقديمي</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">اختر التقارير التي ترغب في عرضها. سيتم عرضها بنفس الترتيب المحدد هنا.</div>
                
                <div id="presentation-selection-list">
                    <!-- سيتم ملء هذه القائمة تلقائيًا بواسطة JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-success" onclick="startCustomPresentation()">
                    <i class="fas fa-play-circle me-2"></i>بدء العرض المخصص
                </button>
            </div>
        </div>
    </div>
</div>
<!-- ======================================================= -->
<!-- END: Presentation Builder Modal -->
<!-- ======================================================= -->

    <!-- Report Modal -->
  <!-- ======================================================= -->
<!-- START: النافذة المنبثقة للتقارير (النسخة النهائية النظيفة) -->
<!-- ======================================================= -->
<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reportModalLabel">التقرير</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="reportModalBody">
                <!-- المحتوى سيتم تحميله هنا بواسطة JavaScript -->
                <div class="text-center p-5">
                    <div class="loading-spinner"></div>
                    <p class="mt-3">جارٍ تحميل التقرير...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                <button type="button" class="btn btn-info" onclick="exportToImage()">
                    <i class="fas fa-image me-1"></i> صورة
                </button>
                <button type="button" class="btn btn-success" onclick="exportToExcel()">
                    <i class="fas fa-file-excel me-1"></i> Excel
                </button>
                <button type="button" class="btn btn-primary" onclick="exportToWord()">
                    <i class="fas fa-file-word me-1"></i> Word
                </button>
                <button type="button" class="btn btn-danger" onclick="exportFinalPDF()">
                    <i class="fas fa-file-pdf me-1"></i> PDF
                </button>
            </div>
        </div>
    </div>
</div>
<!-- ======================================================= -->
<!-- END: النافذة المنبثقة للتقارير -->
<!-- ======================================================= -->


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // ==================================================================
// ==================================================================
// ########## المتغيرات العامة للنظام (النسخة النهائية) ##########
// ==================================================================
let reportModal, boardPackModal, presentationBuilderModal, scenarioBuilderModal;
let currentReportId = '', currentReportTitle = '';
let userScenarios = [];

// --- متغيرات العرض التقديمي ---
let presentationSlidesInfo = []; 
let currentSlideIndex = 0;
let autoplayInterval = null; // سيحتوي على المؤقت الخاص بالعرض التلقائي
const AUTOPLAY_DELAY = 10000; // 10 ثواني لكل شريحة
// ==================================================================
// ******** هذا هو الكود الذي يجب إضافته ********
const formatCurrency = (val) => new Intl.NumberFormat('ar-SA', { 
    style: 'currency', 
    currency: 'SAR', 
    minimumFractionDigits: 0, 
    maximumFractionDigits: 0 
}).format(val || 0);
// ***********************************************
function runInteractiveCode(isForExport, callback) {
    // هذا الكود لن يعمل إلا إذا كنا في وضع العرض العادي (وليس التصدير)
    if (!isForExport) {
        setTimeout(callback, 100);
    }
}
// ==================================================================
// --- END: دالة مساعدة للتحكم في التفاعل ---
// ==================================================================

    // ========== Global Variables ==========

    // ========== SUB_CATEGORY_MAPPING - خريطة ربط أرقام التصنيفات بالقيم الإنجليزية ==========
    const SUB_CATEGORY_MAPPING = {
        // ========== الأصول (Assets) ==========
        // 1110: النقد وما في حكمه
        '111001': 'cash', '111002': 'cash', '111003': 'cash', '111011': 'cash', '111012': 'cash', '111021': 'cash', '111031': 'cash',
        // 1120: استثمارات قصيرة الأجل
        '112001': 'short_term_investments', '112002': 'short_term_investments',
        // 1130: الذمم المدينة التجارية
        '113001': 'trade_receivables', '113002': 'trade_receivables', '113003': 'trade_receivables', '113004': 'trade_receivables', '113099': 'trade_receivables',
        // 1140: الذمم المدينة الأخرى
        '114001': 'other_receivables', '114002': 'other_receivables', '114003': 'other_receivables', '114004': 'other_receivables', '114005': 'other_receivables',
        // 1150: المصروفات المدفوعة مقدماً
        '115001': 'prepaid_expenses', '115002': 'prepaid_expenses', '115003': 'prepaid_expenses', '115099': 'prepaid_expenses',
        // 1160: المخزون
        '116001': 'inventory', '116002': 'inventory', '116003': 'inventory', '116004': 'inventory', '116005': 'inventory', '116006': 'inventory', '116099': 'inventory',
        // 1210: الأصول الثابتة
        '121001': 'fixed_assets', '121002': 'fixed_assets', '121003': 'fixed_assets', '121004': 'fixed_assets', '121005': 'fixed_assets', '121006': 'fixed_assets', '121007': 'fixed_assets',
        '121099': 'fixed_assets_accumulation',
        // 1220: استثمارات طويلة الأجل
        '122001': 'long_term_investments', '122002': 'long_term_investments', '122003': 'long_term_investments', '122004': 'long_term_investments',
        // 1230: أصول غير ملموسة
        '123001': 'intangible_assets', '123002': 'intangible_assets', '123003': 'intangible_assets', '123004': 'intangible_assets', '123099': 'intangible_assets',
        // 1240: أصول أخرى
        '124001': 'other_assets',

        // ========== الالتزامات (Liabilities) ==========
        // 2110: الموردون والأرصدة الدائنة
        '211001': 'trade_payables', '211002': 'trade_payables', '211003': 'trade_payables', '211004': 'trade_payables',
        // 2120: المصروفات المستحقة
        '212001': 'accrued_expenses', '212002': 'accrued_expenses', '212003': 'accrued_expenses', '212004': 'accrued_expenses', '212099': 'accrued_expenses',
        // 2130: مستحقات حكومية
        '213001': 'other_payables', '213002': 'zakat_tax_provision', '213003': 'other_payables', '213004': 'other_payables',
        // 2140: قروض ومخصصات متداولة
        '214001': 'other_payables', '214002': 'other_payables', '214003': 'other_payables',
        // 2210: قروض طويلة الأجل
        '221001': 'long_term_loans', '221002': 'long_term_loans',
        // 2220: مخصصات والتزامات أخرى
        '222001': 'end_of_service_benefit', '222002': 'other_payables', '222003': 'other_payables', '222004': 'other_payables',

        // ========== حقوق الملكية (Equity) ==========
        '310001': 'capital', '310002': 'capital',
        '320001': 'retained_earnings', '320002': 'retained_earnings', '320003': 'retained_earnings',
        '330001': 'retained_earnings', '330002': 'retained_earnings', '330003': 'retained_earnings', '330004': 'capital',

        // ========== الإيرادات (Revenue) ==========
        '410001': 'revenue', '410002': 'revenue', '410003': 'revenue', '410098': 'sales_returns', '410099': 'sales_discount',
        '420001': 'other_revenues', '420002': 'other_revenues', '420003': 'other_revenues', '420004': 'other_revenues', '420005': 'other_revenues',

        // ========== المصروفات (Expenses) ==========
        '510001': 'cogs', '510002': 'cogs', '510003': 'cogs', '510004': 'cogs',
        '610001': 'operating_expenses', '610002': 'operating_expenses', '610003': 'operating_expenses', '610004': 'operating_expenses',
        '620001': 'operating_expenses', '620002': 'operating_expenses', '620003': 'operating_expenses', '620004': 'operating_expenses',
        '620005': 'operating_expenses', '620006': 'operating_expenses', '620007': 'operating_expenses', '620008': 'operating_expenses',
        '620009': 'operating_expenses', '620010': 'operating_expenses', '620099': 'operating_expenses',
        '630001': 'depreciation', '630002': 'amortization',
        '710001': 'operating_expenses', '710002': 'operating_expenses', '710003': 'operating_expenses', '710004': 'operating_expenses',
        '720001': 'zakat_expense',

        // ========== حسابات وسيطة (Clearing) ==========
        '910001': 'clearing', '910002': 'clearing'
    };

// ========== Navigation Functions ==========
function goToFinancialStatements() {
    const activeClientId = localStorage.getItem('activeClientId');
    if (activeClientId) {
        window.location.href = `consolidation-cockpit.html?clientId=${activeClientId}`;
    } else {
        window.location.href = 'consolidation-cockpit.html';
    }
}

function goToAccountMapping() {
    const activeClientId = localStorage.getItem('activeClientId');
    if (activeClientId) {
        window.location.href = `account-mapping.html?clientId=${activeClientId}`;
    } else {
        window.location.href = 'account-mapping.html';
    }
}
        // ========== Initialize ==========
document.addEventListener('DOMContentLoaded', function() {
    reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
    const params = new URLSearchParams(window.location.search);
    const cid = params.get('clientId') || localStorage.getItem('activeClientId');
    const withCid = (url) => cid ? `${url}?clientId=${cid}` : url;
    ['top_home','top_mapping','top_cockpit','top_reports'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            const href = el.getAttribute('href');
            if (href) el.setAttribute('href', withCid(href));
        }
    });
});

        // ========== Sample Data Generator ==========
    

// ==================================================================
// ==================================================================
// --- START: دالة getData (V3 - النسخة المرنة والنهائية) ---
// ==================================================================
function getData() {
    try {
        const activeClientId = new URLSearchParams(window.location.search).get('clientId') || localStorage.getItem('activeClientId');
        if (!activeClientId) { console.error('❌ لا يوجد معرف عميل نشط'); return null; }
        localStorage.setItem('activeClientId', activeClientId);

        const finalJSON = localStorage.getItem(`finalAudit_${activeClientId}`);
        if (!finalJSON) { console.error('❌ لا توجد نسخة نهائية finalAudit للعميل'); return null; }
        const finalAudit = JSON.parse(finalJSON);
        const auditData = {
            clientInfo: finalAudit.clientInfo || {},
            trialBalance: finalAudit.trialBalance || [],
            adjustments: finalAudit.adjustments || []
        };
        
        // --- الخطوة 2: العزل التام للبيانات ---
        const isolatedTrialBalance = JSON.parse(JSON.stringify(auditData.trialBalance));
        
        isolatedTrialBalance.forEach(acc => {
            const ob_debit = parseFloat(acc.ob_debit) || 0;
            const ob_credit = parseFloat(acc.ob_credit) || 0;
            const move_debit = parseFloat(acc.move_debit) || 0;
            const move_credit = parseFloat(acc.move_credit) || 0;
            acc.book_balance = (ob_debit - ob_credit) + (move_debit - move_credit);
        });
        
        // --- الخطوة 3: تمرير النسخة المنعزلة إلى دوال المعالجة ---
        const processedData = processFinancialData(isolatedTrialBalance, auditData.adjustments);
        const categorizedData = categorizeAccounts(isolatedTrialBalance, auditData.adjustments);
        const incomeUnified = generateIncomeStatement(categorizedData);
        const balanceUnified = generateBalanceUnified(auditData, categorizedData, incomeUnified.netProfit);
        const cashUnified = generateCashFlowUnified(auditData, incomeUnified, balanceUnified);
        
        if (!processedData) { 
            console.error("فشلت معالجة البيانات المالية.");
            return null; 
        }

function loadReportData() {
    const urlParams = new URLSearchParams(window.location.search);
    const clientId = urlParams.get("clientId");

    // تحميل القوائم النهائية من النسخة النهائية
    const finalData = localStorage.getItem(`finalAudit_${clientId}`);
    if (!finalData) {
        console.error("❌ لا توجد نسخة نهائية finalAudit للعميل");
        return null;
    }

    const audit = JSON.parse(finalData);

    // ضمان وجود كل البيانات
    audit.trialBalance = audit.trialBalance || [];
    audit.adjustments = audit.adjustments || [];
    audit.mapping = audit.mapping || {};
    audit.clientInfo = audit.clientInfo || {};

    return audit;
}

// تحميل البيانات
const reportData = loadReportData();


        // =======================================================
        // *** الإصلاح الحاسم هنا (النسخة المرنة) ***
        // نجرب عدة أسماء محتملة لحقل اسم العميل لضمان العثور عليه
        // =======================================================
        const clientInfo = auditData.clientInfo || {};
        processedData.companyName = clientInfo.clientName || clientInfo.company_name || clientInfo.name || 'اسم العميل غير متوفر';
        processedData.fiscalYear = clientInfo.endDate ? new Date(clientInfo.endDate).getFullYear() : new Date().getFullYear();
        processedData.clientInfo = clientInfo;
        processedData.revenue = incomeUnified.totalRevenue;
        processedData.cogs = incomeUnified.totalCOGS;
        processedData.grossProfit = incomeUnified.grossProfit;
        processedData.operatingExpenses = incomeUnified.adminExpenses;
        processedData.depreciationExpense = incomeUnified.depreciationExpense;
        processedData.otherIncome = incomeUnified.otherRevenues;
        processedData.netIncome = incomeUnified.netProfit;
        processedData.currentAssets = balanceUnified.currentAssets;
        processedData.fixedAssets = balanceUnified.fixedAssets;
        processedData.assets = balanceUnified.totalAssets;
        processedData.currentLiabilities = balanceUnified.currentLiabilities;
        processedData.longTermLiabilities = balanceUnified.longTermLiabilities;
        processedData.liabilities = balanceUnified.totalLiabilities;
        processedData.equity = balanceUnified.totalEquity;
        processedData.categorized = categorizedData;
        processedData.openingEquity = balanceUnified.openingEquity;
        processedData.partnersCurrentChange = processedData.equity - processedData.openingEquity - processedData.netIncome;
        processedData.cashFlowOps = cashUnified.cashFlowFromOps;
        processedData.cashFlowInv = cashUnified.cashFlowFromInv;
        processedData.cashFlowFin = cashUnified.cashFlowFromFin;
        processedData.netCashChange = cashUnified.netCashChange;
        processedData.openingCash = cashUnified.openingCash;
        processedData.closingCash = cashUnified.closingCash;

        console.log(`🎉 نجحت معالجة البيانات بالكامل للعميل: ${processedData.companyName}`);
        return processedData;

    } catch (error) {
        console.error("❌ حدث خطأ كارثي أثناء الحصول على البيانات:", error);
        return null;
    }
}
// ==================================================================
// --- END: دالة getData (V3) ---
// ==================================================================
function calculateFinalBalance(account, adjustments = []) {
    if (!account) return 0;

    // **المنطق الجديد البسيط جدًا: الرصيد هو الرصيد النهائي المحسوب مسبقًا**
    // هذا الحقل (book_balance) قمنا بتجهيزه في دالة getData
    const finalBalance = account.book_balance || 0;

    // تطبيق قيود التسوية
    const adjustmentEffect = (adjustments || []).reduce((sum, adj) => {
        if (String(adj.debit_account) === String(account.account_id)) return sum + (parseFloat(adj.amount) || 0);
        if (String(adj.credit_account) === String(account.account_id)) return sum - (parseFloat(adj.amount) || 0);
        return sum;
    }, 0);

    return finalBalance + adjustmentEffect;
}
function generateBalanceUnified(auditData, categorizedData, netIncome) {
    const sum = (accounts) => (accounts || []).reduce((t, a) => t + (a.finalBalance || 0), 0);
    const safeSum = (filter) => (auditData.trialBalance || []).filter(filter).reduce((s, acc) => s + calculateFinalBalance(acc, auditData.adjustments), 0);
    const currentCash = safeSum(acc => (SUB_CATEGORY_MAPPING[acc.sub_category] || '') === 'cash');
    const currentReceivables = safeSum(acc => (SUB_CATEGORY_MAPPING[acc.sub_category] || '') === 'trade_receivables');
    const currentInventory = safeSum(acc => (SUB_CATEGORY_MAPPING[acc.sub_category] || '') === 'inventory');
    const currentOtherReceivables = safeSum(acc => {
        const k = SUB_CATEGORY_MAPPING[acc.sub_category] || '';
        const v = calculateFinalBalance(acc, auditData.adjustments);
        return (k === 'other_receivables' || k === 'prepaid_expenses') && v > 0;
    });
    const payablesReceivables = safeSum(acc => {
        const k = SUB_CATEGORY_MAPPING[acc.sub_category] || '';
        const v = calculateFinalBalance(acc, auditData.adjustments);
        return k === 'trade_payables' && v > 0;
    });
    const totalCurrentAssets = currentCash + currentReceivables + currentInventory + currentOtherReceivables + payablesReceivables;
    const currentFixedAssets = safeSum(acc => ['fixed_assets', 'fixed_assets_accumulation'].includes(SUB_CATEGORY_MAPPING[acc.sub_category] || ''));
    const totalAssets = totalCurrentAssets + currentFixedAssets;
    const currentPayables = Math.abs(safeSum(acc => {
        const k = SUB_CATEGORY_MAPPING[acc.sub_category] || '';
        const v = calculateFinalBalance(acc, auditData.adjustments);
        return k === 'trade_payables' && v < 0;
    }));
    const currentOtherPayables = Math.abs(safeSum(acc => {
        const k = SUB_CATEGORY_MAPPING[acc.sub_category] || '';
        const v = calculateFinalBalance(acc, auditData.adjustments);
        return k === 'other_payables' || k === 'accrued_expenses' || ((k === 'other_receivables' || k === 'prepaid_expenses') && v < 0);
    }));
    const currentZakat = Math.abs(safeSum(acc => (SUB_CATEGORY_MAPPING[acc.sub_category] || '') === 'zakat_tax_provision'));
    const totalCurrentLiabilities = currentPayables + currentOtherPayables + currentZakat;
    const longTermLiabilities = Math.abs(safeSum(acc => {
        const k = SUB_CATEGORY_MAPPING[acc.sub_category] || '';
        return k === 'long_term_loans' || k === 'end_of_service_benefit' || k.startsWith('long_term');
    }));
    const totalLiabilities = totalCurrentLiabilities + longTermLiabilities;
    const openingEquity = - (auditData.trialBalance || []).filter(acc => String(acc.category || '').toLowerCase() === 'equity').reduce((s, acc) => s + ((parseFloat(acc.ob_debit) || 0) - (parseFloat(acc.ob_credit) || 0)), 0);
    const calculatedEquity = totalAssets - totalLiabilities;
    return {
        currentAssets: totalCurrentAssets,
        fixedAssets: currentFixedAssets,
        totalAssets,
        currentLiabilities: totalCurrentLiabilities,
        longTermLiabilities,
        totalLiabilities,
        totalEquity: calculatedEquity,
        openingEquity
    };
}
function generateCashFlowUnified(auditData, incomeData, balanceData) {
    const getAccountValue = (filter) => (auditData.trialBalance || []).filter(filter).reduce((sum, acc) => sum + calculateFinalBalance(acc, auditData.adjustments), 0);
    const getOpeningBalance = (filter) => (auditData.trialBalance || []).filter(filter).reduce((sum, acc) => sum + ((parseFloat(acc.ob_debit) || 0) - (parseFloat(acc.ob_credit) || 0)), 0);
    const netIncome = incomeData.netProfit || 0;
    const depreciation = incomeData.depreciationExpense || 0;
    const changeInReceivables = getAccountValue(acc => ['trade_receivables','other_receivables'].includes(SUB_CATEGORY_MAPPING[acc.sub_category])) - getOpeningBalance(acc => ['trade_receivables','other_receivables'].includes(SUB_CATEGORY_MAPPING[acc.sub_category]));
    const changeInInventory = getAccountValue(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'inventory') - getOpeningBalance(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'inventory');
    const changeInPrepaidExpenses = getAccountValue(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'prepaid_expenses') - getOpeningBalance(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'prepaid_expenses');
    const changeInPayables = getAccountValue(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'trade_payables') - getOpeningBalance(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'trade_payables');
    const changeInOtherPayables = getAccountValue(acc => ['other_payables','accrued_expenses'].includes(SUB_CATEGORY_MAPPING[acc.sub_category])) - getOpeningBalance(acc => ['other_payables','accrued_expenses'].includes(SUB_CATEGORY_MAPPING[acc.sub_category]));
    const changeInZakat = getAccountValue(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'zakat_tax_provision') - getOpeningBalance(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'zakat_tax_provision');
    const cashFlowFromOps = netIncome + depreciation - changeInReceivables - changeInInventory - changeInPrepaidExpenses + changeInPayables + changeInOtherPayables + changeInZakat;
    const changeInFixedAssets = getAccountValue(acc => ['fixed_assets','fixed_assets_accumulation'].includes(SUB_CATEGORY_MAPPING[acc.sub_category] || '')) - getOpeningBalance(acc => ['fixed_assets','fixed_assets_accumulation'].includes(SUB_CATEGORY_MAPPING[acc.sub_category] || ''));
    const cashFlowFromInv = -changeInFixedAssets;
    const changeInLongTermLiabilities = getAccountValue(acc => (String(acc.sub_category || '')).startsWith('22')) - getOpeningBalance(acc => (String(acc.sub_category || '')).startsWith('22'));
    const openingEquity = -getOpeningBalance(acc => String(acc.category || '').toLowerCase() === 'equity');
    const closingEquity = balanceData.totalEquity || 0;
    const changeInEquity = (closingEquity - netIncome) - openingEquity;
    const cashFlowFromFin = changeInLongTermLiabilities + changeInEquity;
    const netCashChange = cashFlowFromOps + cashFlowFromInv + cashFlowFromFin;
    const openingCash = getOpeningBalance(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'cash');
    const closingCash = openingCash + netCashChange;
    return { netIncome, depreciation, changeInReceivables, changeInInventory, changeInPrepaidExpenses, changeInPayables, changeInOtherPayables, changeInZakat, cashFlowFromOps, changeInFixedAssets, cashFlowFromInv, changeInLongTermLiabilities, changeInEquity, cashFlowFromFin, netCashChange, openingCash, closingCash };
}
const categorizeAccounts = (function() {
    const cache = new Map();
    return function(trialBalance, adjustments = []) {
        const cacheKey = JSON.stringify({ tb: trialBalance?.length, adj: adjustments?.length });
        if (cache.has(cacheKey)) return cache.get(cacheKey);
        
        const accounts = trialBalance || [];
        
        const categorized = { 
            revenue: [], cogs: [], operatingExpenses: [], otherRevenues: [], 
            currentAssets: [], fixedAssets: [], currentLiabilities: [], longTermLiabilities: [], 
            equity: [], clearing: [],
            // ... باقي صناديق الإيضاحات
        };

        accounts.forEach(account => {
            if (!account || account.category === 'ignore') return;

            // **الإصلاح الحاسم هنا: نحسب الرصيد النهائي الصحيح مرة واحدة فقط**
            account.finalBalance = calculateFinalBalance(account, adjustments, false);
            
            const mainCategory = (account.category || '').toLowerCase();
            const subCategory = SUB_CATEGORY_MAPPING[account.sub_category] || (account.sub_category || '').toLowerCase();
            
            // توزيع الحساب على الصناديق الصحيحة
            switch (mainCategory) {
                case 'assets':
                    if (['fixed_assets', 'intangible_assets', 'long_term_investments', 'fixed_assets_accumulation'].includes(subCategory)) {
                        categorized.fixedAssets.push(account);
                    } else {
                        categorized.currentAssets.push(account);
                    }
                    break;
                case 'liabilities':
                    if (['long_term_loans', 'end_of_service_benefit'].includes(subCategory)) {
                        categorized.longTermLiabilities.push(account);
                    } else {
                        categorized.currentLiabilities.push(account);
                    }
                    break;
                case 'equity':
                    categorized.equity.push(account);
                    break;
                case 'revenue':
                    if (subCategory.includes('other') || subCategory.includes('gains')) {
                        categorized.otherRevenues.push(account);
                    } else {
                        categorized.revenue.push(account);
                    }
                    break;
                case 'expenses':
                    if (subCategory === 'cogs') {
                        categorized.cogs.push(account);
                    } else {
                        categorized.operatingExpenses.push(account);
                    }
                    break;
                case 'clearing':
                    categorized.clearing.push(account);
                    break;
            }
        });
        cache.set(cacheKey, categorized);
        return categorized;
    };
})();
// ==================================================================
// --- END: دالة التصنيف النهائية ---
// ==================================================================
// ==================================================================
// --- END: دالة التصنيف النهائية ---
// ==================================================================

// ==================================================================
// دالة توليد قائمة الدخل (منسوخة من consolidation-cockpit.html)
// ==================================================================
// ==================================================================
// --- START: دالة قائمة الدخل (النسخة النهائية الموحدة) ---
// ==================================================================
function generateIncomeStatement(categorizedData) {
    if (!categorizedData) return {}; // حماية من البيانات الفارغة

    const sum = (accounts) => (accounts || []).reduce((total, acc) => total + (acc.finalBalance || 0), 0);

    const revAccounts = categorizedData.revenue || [];
    const isMainRevenue = (acc) => {
        const n = String(acc?.name || '').toLowerCase();
        const id = String(acc?.account_id || '');
        if (id === '401010001' || id.startsWith('401') || id.startsWith('410')) return true;
        return n.includes('مبيعات') || n.includes('خرسانة') || n.includes('الخرسانة') || n.includes('بلوك') || n.includes('البلوك') || n.includes('كسارة') || n.includes('الكسارة');
    };
    const mainRevenueAccounts = revAccounts.filter(acc => isMainRevenue(acc));
    const otherRevenueFromRevenue = revAccounts.filter(acc => !isMainRevenue(acc));

    const totalRevenue = -sum(mainRevenueAccounts.length ? mainRevenueAccounts : revAccounts);
    const totalCOGS = sum(categorizedData.cogs);
    const grossProfit = totalRevenue - totalCOGS;

    const adminExpenses = sum(categorizedData.operatingExpenses.filter(acc => 
        !['depreciation', 'amortization', 'zakat_expense'].includes(SUB_CATEGORY_MAPPING[acc.sub_category])
    ));
    
    const depreciationExpense = sum(categorizedData.operatingExpenses.filter(acc => 
        SUB_CATEGORY_MAPPING[acc.sub_category] === 'depreciation'
    ));

    const amortizationExpense = sum(categorizedData.operatingExpenses.filter(acc => 
        SUB_CATEGORY_MAPPING[acc.sub_category] === 'amortization'
    ));

    const otherRevenuesRevenue = -sum(otherRevenueFromRevenue);
    const otherRevenuesOther = -sum(categorizedData.otherRevenues || []);
    const otherRevenues = otherRevenuesRevenue + otherRevenuesOther;
    const zakatExpense = sum(categorizedData.operatingExpenses.filter(acc => 
        SUB_CATEGORY_MAPPING[acc.sub_category] === 'zakat_expense'
    ));

    const netProfitBeforeZakat = grossProfit - adminExpenses - depreciationExpense - amortizationExpense + otherRevenues;
    const netProfit = netProfitBeforeZakat - zakatExpense;

    return {
        totalRevenue, totalCOGS, grossProfit, adminExpenses,
        depreciationExpense, amortizationExpense, otherRevenues,
        netProfitBeforeZakat, zakatExpense, netProfit,
        allAccounts: categorizedData
    };
}
// ==================================================================
// --- END: دالة قائمة الدخل ---
// ==================================================================

// ==================================================================
// دالة توليد قائمة المركز المالي (منسوخة من consolidation-cockpit.html)
// ==================================================================
// ==================================================================
// --- START: دالة المركز المالي (النسخة النهائية الموحدة) ---
// ==================================================================
function generateBalanceSheet(categorizedData, netProfit, isPriorYear = false) {
    if (!categorizedData) return {}; // حماية

    const sum = (accounts) => (accounts || []).reduce((total, acc) => total + (acc.finalBalance || 0), 0);

    const currentAssets = sum(categorizedData.currentAssets);
    const fixedAssets = sum(categorizedData.fixedAssets); // هذا هو الصافي مباشرة
    const totalAssets = currentAssets + fixedAssets;

    const currentLiabilities = sum(categorizedData.currentLiabilities);
    const longTermLiabilities = sum(categorizedData.longTermLiabilities);
    const totalLiabilities = currentLiabilities + longTermLiabilities;

    const equityOB = sum(categorizedData.equity);
    const totalEquity = isPriorYear ? equityOB : (equityOB + netProfit);

    const accountingEquationBalance = totalAssets + totalLiabilities + totalEquity;
    const isBalanced = Math.abs(accountingEquationBalance) < 100;

    return {
        currentAssets, fixedAssets, totalAssets,
        currentLiabilities: -currentLiabilities,
        longTermLiabilities: -longTermLiabilities,
        totalLiabilities: -totalLiabilities,
        totalEquity: -totalEquity,
        isBalanced, accountingEquationBalance,
        allAccounts: categorizedData
    };
}
// ==================================================================
// --- START: دالة معالجة البيانات (النسخة النهائية النظيفة) ---
// ==================================================================
function processFinancialData(trialBalance, adjustments = []) {
    if (!trialBalance || trialBalance.length === 0) {
        console.error('ميزان المراجعة فارغ في مرحلة المعالجة.');
        return null;
    }
    
    // تصنيف الحسابات
    const categorized = categorizeAccounts(trialBalance, adjustments);
    
    // توليد قائمة الدخل
    const incomeData = generateIncomeStatement(categorized);
    
    // توليد قائمة المركز المالي
    const balanceData = generateBalanceSheet(categorized, incomeData.netProfit, false);
    
    // تجميع كل البيانات في كائن واحد شامل
    return {
        // بيانات قائمة الدخل
        revenue: incomeData.totalRevenue,
        cogs: incomeData.totalCOGS,
        grossProfit: incomeData.grossProfit,
        operatingExpenses: incomeData.adminExpenses,
        depreciationExpense: incomeData.depreciationExpense,
        otherIncome: incomeData.otherRevenues,
        netProfitBeforeZakat: incomeData.netProfitBeforeZakat,
        zakatExpense: incomeData.zakatExpense,
        netIncome: incomeData.netProfit,
        
        // بيانات قائمة المركز المالي
        currentAssets: balanceData.currentAssets,
        fixedAssets: balanceData.fixedAssets,
        assets: balanceData.totalAssets,
        currentLiabilities: balanceData.currentLiabilities,
        longTermLiabilities: balanceData.longTermLiabilities,
        liabilities: balanceData.totalLiabilities,
        equity: balanceData.totalEquity,
        
        // بيانات إضافية مفيدة
        operatingProfit: incomeData.grossProfit - incomeData.adminExpenses,
        cashFlow: incomeData.netProfit + incomeData.depreciationExpense,
        
        // البيانات المصنفة الكاملة (للتقارير التفصيلية)
        categorized: categorized,
        trialBalance: trialBalance,
        
        // معلومات إضافية
        fiscalYear: new Date().getFullYear(), // سيتم تحديثها لاحقًا من بيانات العميل
        companyName: 'اسم العميل' // سيتم تحديثها لاحقًا
    };
}
// ==================================================================
// --- END: دالة معالجة البيانات ---
// ==================================================================

        // ========== Report Opening Function ==========
        function openReport(reportId, title) {
            currentReportId = reportId;
            currentReportTitle = title;
            
            document.getElementById('reportModalLabel').textContent = title;
            document.getElementById('reportModalBody').innerHTML = `
                <div class="text-center p-5">
                    <div class="loading-spinner"></div>
                    <p class="mt-3">جارٍ تحميل التقرير...</p>
                </div>
            `;
            
            reportModal.show();
            
            // Simulate loading delay
            setTimeout(() => {
                const content = generateReportContent(reportId, title);
                document.getElementById('reportModalBody').innerHTML = content;
            }, 500);
// ==================================================================
// --- START: إضافة منطق الرسم البياني لتقرير السيناريوهات ---
// ==================================================================
if (reportId === 'multiple-scenarios') {
    const data = getData();
    // نفس الحسابات الموجودة في الدالة الرئيسية
    const baseNetProfit = data.netIncome;
    const scenarios = {
        expansion: { name: "التوسع في السوق", blockQtyChange: 0.30, fixedCostChange: 50000, color: 'rgba(40, 167, 69, 0.7)' },
        priceWar: { name: "حرب الأسعار", blockPriceChange: -0.20, blockQtyChange: 0.15, color: 'rgba(255, 193, 7, 0.7)' },
        costIncrease: { name: "ارتفاع التكاليف", vcUnitChange: 0.20, color: 'rgba(220, 53, 69, 0.7)' }
    };
    const results = Object.values(scenarios).map(scenario => {
        const baseBlockRevenue = Math.abs(data.categorized.revenue.find(acc => acc.name.toLowerCase().includes("بلوك"))?.finalBalance || 0);
        const baseTotalRevenue = data.revenue;
        const baseTotalVC = data.cogs;
        const baseFixedCosts = data.operatingExpenses + data.depreciationExpense;
        const baseBlockPrice = 1.60;
        const baseBlockUnits = baseBlockPrice > 0 ? baseBlockRevenue / baseBlockPrice : 0;
        const baseVCUnit_Block = baseBlockUnits > 0 ? (baseTotalVC * (baseBlockRevenue / baseTotalRevenue)) / baseBlockUnits : 0;
        const newBlockUnits = baseBlockUnits * (1 + (scenario.blockQtyChange || 0));
        const newBlockPrice = baseBlockPrice + (scenario.blockPriceChange || 0);
        const newVCUnit_Block = baseVCUnit_Block * (1 + (scenario.vcUnitChange || 0));
        const newFixedCosts = baseFixedCosts + (scenario.fixedCostChange || 0);
        const newRevenue = (newBlockUnits * newBlockPrice) + (baseTotalRevenue - baseBlockRevenue);
        const newVC = (newBlockUnits * newVCUnit_Block) + (baseTotalVC * (1 - (baseBlockRevenue / baseTotalRevenue)));
        const newNetProfit = newRevenue - newVC - newFixedCosts;
        return { name: scenario.name, netProfit: newNetProfit, color: scenario.color };
    });

    const ctx = document.getElementById('scenarioComparisonChart')?.getContext('2d');
    if (ctx) {
        if(window.scenarioChartInstance) window.scenarioChartInstance.destroy();
        window.scenarioChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['الوضع الحالي', ...results.map(r => r.name)],
                datasets: [{
                    label: 'صافي الربح المتوقع',
                    data: [baseNetProfit, ...results.map(r => r.netProfit)],
                    backgroundColor: ['rgba(0, 123, 255, 0.7)', ...results.map(r => r.color)]
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { ticks: { color: 'var(--color-text-primary)', callback: value => formatCurrency(value) } },
                    x: { ticks: { color: 'var(--color-text-primary)' } }
                }
            }
        });
    }
}
        }

    // ========== Report Content Generator ==========
// ==================================================================
// ==================================================================
// --- START: دالة توليد محتوى التقرير (النسخة الكاملة والشاملة) ---
// ==================================================================
function generateReportContent(reportId, title, isForExport = false) {
    currentReportId = reportId;
    currentReportTitle = title;
    
    const data = getData();
    
    if (!data) {
        return `
            <div class="alert alert-danger text-center p-5">
                <i class="fas fa-database fa-3x mb-3"></i>
                <h4>خطأ في تحميل البيانات المالية</h4>
                <p>لم يتم العثور على بيانات معتمدة. يرجى العودة لصفحة المراجعة والضغط على 'اعتماد نهائي' مرة أخرى.</p>
                <a href="account-mapping.html" class="btn btn-primary mt-3" onclick="goToAccountMapping(); return false;">
                    <i class="fas fa-arrow-right"></i> العودة لصفحة المراجعة
                </a>
            </div>
        `;
    }
    
    // هذا الكود سيعيد كل التقارير للعمل
    switch(reportId) {
        // ========== FINANCE WING ==========
        case 'yearend-checklist': return generateYearEndChecklist(data);
        case 'sovereign-fs': return generateFinancialStatements(data);
        case 'sovereign-audit': return generateAuditReport(data);
        case 'budget-variance': return generateBudgetVariance(data);
        case 'profit-forecast': return generateProfitForecast(data);
        case 'cash-forecast': return generateCashForecast(data);
        case 'loan-capacity': return generateLoanCapacity(data);
        case 'money-flow': return generateMoneyFlow(data);
        
        // ========== BUDGET SECTION ==========
        case 'budget-preparation': return generateBudgetPreparation(data);
        case 'budget-comparison': return generateBudgetComparison(data);
        case 'budget-update': return generateBudgetUpdate(data);
        case 'budget-analysis': return generateBudgetAnalysis(data);
        
        // ========== FORECAST SECTION ==========
        case 'revenue-forecast': return generateRevenueForecast(data);
        case 'cashflow-forecast': return generateCashFlowForecast(data);
        case 'multiple-scenarios': return generateMultipleScenarios(data);
        case 'ai-forecast': return generateAIForecast(data);
        
        // ========== MANAGEMENT WING ==========
        case 'kpi-dashboard': return generateKPIDashboard(data);
        case 'profitability-dim': return generateProfitabilityDim(data);
        case 'working-capital': return generateWorkingCapital(data);
        case 'abc-costing': return generateABCCosting(data);
        
       
 // ========== STRATEGY WING ==========
case 'balanced-scorecard': 
    return generateBalancedScorecard(data);
case 'swot-analysis': 
    return generateSwotAnalysis(data);
        case 'breakeven-analysis': return generateBreakevenAnalysis(data);
        case 'whatif-scenarios': return generateWhatIfScenarios(data);
        case 'integrated-report': return generateIntegratedReport(data);
        case 'dcf-valuation': return generateDCFValuation(data);
        case 'rim-valuation': return generateRIMValuation(data);
        case 'ddm-valuation': return generateDDMValuation(data);
        case 'dupont-analysis': return generateDupontAnalysis(data);
        case 'eva-analysis': return generateEVAAnalysis(data);

        // ========== QUALITY WING ==========
        case 'beneish-mscore': return isForExport ? generateBeneishMScore(data) : generateBeneishMScore(data);
        case 'sloan-accruals': return generateSloanAccruals(data);
        
        // ========== RISK WING ==========
        case 'altman-zscore': return generateAltmanZScore(data);
        case 'ohlson-oscore': return generateOhlsonOScore(data);
        case 'zmijewski-xscore': return generateZmijewskiXScore(data);
        case 'sherrod-model': return generateSherrodModel(data);
        case 'fulmer-hscore': return generateFulmerHScore(data);
        case 'springate-sscore': return generateSpringateSScore(data);
        case 'ca-score-ai': return generateCAScoreAI(data);
        case 'var-risk': return generateVaRRisk(data);
        
       // ... داخل دالة generateReportContent ...
// ========== INVESTMENT WING ==========
case 'capm-model': return generateCAPM(data);
case 'famafrench-model': return generateFamaFrench(data);
case 'mpt-portfolio': return generateMPT(data);
case 'sharpe-ratio': return generateSharpeRatio(data);
// ...

        
        


        default:
            return `<div class="alert alert-info text-center p-5">
                <i class="fas fa-cogs fa-3x mb-3"></i>
                <h4>التقرير قيد التطوير</h4>
                <p>التقرير المطلوب (${title}) سيكون متاحاً قريباً.</p>
            </div>`;
    } // <-- هذا القوس يغلق جملة switch
} // <-- هذا القوس يغلق دالة generateReportContent

// ==================================================================
// --- END: الكود الصحيح والنهائي لهذا الجزء ---
// ==================================================================


  // ==================================================================
// ########## START: قائمة الإغلاق التفاعلية (النسخة النهائية) ##########
// ==================================================================
function generateYearEndChecklist(data) {
    // قائمة المهام مع معرف فريد لكل مهمة
    const tasks = [
        { id: 'zatca-xml', group: 'zatca', text: 'تجهيز الفواتير الإلكترونية بصيغة XML' },
        { id: 'zatca-compliance', group: 'zatca', text: 'التأكد من توافق البيانات مع متطلبات الهيئة' },
        { id: 'zatca-upload', group: 'zatca', text: 'رفع الملفات على منصة فاتورة' },
        { id: 'qawaem-xbrl', group: 'qawaem', text: 'تصدير القوائم المالية بصيغة XBRL' },
        { id: 'qawaem-review', group: 'qawaem', text: 'مراجعة البيانات المالية قبل الرفع' },
        { id: 'zakat-calc', group: 'zakat', text: 'حساب الوعاء الزكوي بدقة' },
        { id: 'zakat-submit', group: 'zakat', text: 'تقديم الإقرار الزكوي عبر منصة هيئة الزكاة' },
        { id: 'audit-docs', group: 'audit', text: 'تجهيز المستندات المطلوبة للمراجع الخارجي' },
        { id: 'audit-response', group: 'audit', text: 'الرد على استفسارات فريق المراجعة' },
        { id: 'closing-entries', group: 'closing', text: 'إعداد وتنفيذ قيود الإقفال النهائية' },
    ];

    // تحميل الحالات المحفوظة من الذاكرة المحلية
    const savedTasks = JSON.parse(localStorage.getItem(`yearEndChecklist_${data.fiscalYear}`)) || {};

    // بناء HTML التفاعلي
    const buildTaskItem = (task) => {
        const isChecked = savedTasks[task.id] || false;
        return `
            <div class="form-check form-switch my-2">
                <input class="form-check-input" type="checkbox" role="switch" id="${task.id}" 
                       onchange="updateChecklistStatus('${task.id}', this.checked, ${data.fiscalYear})" 
                       ${isChecked ? 'checked' : ''}>
                <label class="form-check-label ${isChecked ? 'text-decoration-line-through text-muted' : ''}" for="${task.id}">
                    ${task.text}
                </label>
            </div>
        `;
    };

    const totalTasks = tasks.length;
    const completedTasks = Object.values(savedTasks).filter(Boolean).length;
    const progress = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;

    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-tasks"></i> قائمة إغلاق نهاية العام ${data.fiscalYear} (تفاعلية)</h4>
            <div class="alert alert-info"><i class="fas fa-info-circle"></i> قم بالتأشير على المهام المنجزة. سيتم حفظ تقدمك تلقائيًا.</div>

            <div class="accordion" id="checklistAccordion">
                <!-- قسم ZATCA -->
                <div class="accordion-item bg-dark"><h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#zatca">1. إعداد ملفات ZATCA</button>
                </h2><div id="zatca" class="accordion-collapse collapse show"><div class="accordion-body">
                    ${tasks.filter(t => t.group === 'zatca').map(buildTaskItem).join('')}
                </div></div></div>

                <!-- قسم Qawaem -->
                <div class="accordion-item bg-dark"><h2 class="accordion-header">
                    <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#qawaem">2. إعداد ملفات Qawaem</button>
                </h2><div id="qawaem" class="accordion-collapse collapse"><div class="accordion-body">
                    ${tasks.filter(t => t.group === 'qawaem').map(buildTaskItem).join('')}
                </div></div></div>
                
                <!-- باقي الأقسام بنفس الطريقة -->
                <div class="accordion-item bg-dark"><h2 class="accordion-header">
                    <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#zakat">3. الإقرار الزكوي</button>
                </h2><div id="zakat" class="accordion-collapse collapse"><div class="accordion-body">
                    ${tasks.filter(t => t.group === 'zakat').map(buildTaskItem).join('')}
                </div></div></div>
                <div class="accordion-item bg-dark"><h2 class="accordion-header">
                    <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#audit">4. المراجعة الخارجية</button>
                </h2><div id="audit" class="accordion-collapse collapse"><div class="accordion-body">
                    ${tasks.filter(t => t.group === 'audit').map(buildTaskItem).join('')}
                </div></div></div>
                <div class="accordion-item bg-dark"><h2 class="accordion-header">
                    <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#closing">5. قيود الإقفال</button>
                </h2><div id="closing" class="accordion-collapse collapse"><div class="accordion-body">
                    ${tasks.filter(t => t.group === 'closing').map(buildTaskItem).join('')}
                </div></div></div>
            </div>

            <!-- شريط التقدم -->
            <div class="mt-4 p-3 bg-success bg-opacity-10 border border-success rounded">
                <h5 class="text-success"><i class="fas fa-check-double"></i> الحالة العامة للإغلاق</h5>
                <div class="progress mt-3" style="height: 30px;">
                    <div id="checklistProgressBar" class="progress-bar bg-success progress-bar-striped progress-bar-animated" role="progressbar" style="width: ${progress.toFixed(0)}%">${progress.toFixed(0)}% مكتمل</div>
                </div>
                <p id="checklistProgressText" class="mt-3 mb-0 small">تم إنجاز ${completedTasks} من ${totalTasks} مهمة.</p>
            </div>
        </div>
    `;
}

// --- دالة جديدة لحفظ الحالة وتحديث الواجهة ---
function updateChecklistStatus(taskId, isChecked, fiscalYear) {
    // 1. تحديث الحالة في الذاكرة
    const storageKey = `yearEndChecklist_${fiscalYear}`;
    const savedTasks = JSON.parse(localStorage.getItem(storageKey)) || {};
    savedTasks[taskId] = isChecked;
    localStorage.setItem(storageKey, JSON.stringify(savedTasks));

    // 2. تحديث شكل النص (شطب/إلغاء شطب)
    const label = document.querySelector(`label[for="${taskId}"]`);
    if (label) {
        label.classList.toggle('text-decoration-line-through', isChecked);
        label.classList.toggle('text-muted', isChecked);
    }

    // 3. إعادة حساب وتحديث شريط التقدم
    const totalTasks = 10; // العدد الإجمالي للمهام
    const completedTasks = Object.values(savedTasks).filter(Boolean).length;
    const progress = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
    
    const progressBar = document.getElementById('checklistProgressBar');
    const progressText = document.getElementById('checklistProgressText');

    if (progressBar) {
        progressBar.style.width = `${progress.toFixed(0)}%`;
        progressBar.textContent = `${progress.toFixed(0)}% مكتمل`;
    }
    if (progressText) {
        progressText.textContent = `تم إنجاز ${completedTasks} من ${totalTasks} مهمة.`;
    }
}
// ==================================================================
// ########## END: قائمة الإغلاق التفاعلية ##########
// ==================================================================


        function generateFinancialStatements(data) {
        const grossProfit = data.revenue - data.cogs;
const operatingProfit = grossProfit - data.operatingExpenses - (data.depreciationExpense || 0);
const netProfit = operatingProfit + (data.otherIncome || 0);

            const totalAssets = data.currentAssets + data.fixedAssets;
            const totalLiabilities = data.currentLiabilities + data.longTermLiabilities;
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-file-invoice"></i> القوائم المالية ${data.fiscalYear}</h4>
                    
                    <ul class="nav nav-tabs mb-4" id="fsTab" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#income">قائمة الدخل</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#balance">المركز المالي</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#cashflow">التدفقات النقدية</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#equity">التغيرات في حقوق الملكية</button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="income">
                            <h5 class="mb-3">قائمة الدخل الشامل</h5>
                            <table class="table table-striped">
                                <tbody>
                                    <tr>
                                        <td><strong>إيرادات النشاط الرئيسي</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(data.revenue)}</strong></td>
                                    </tr>
                                    <tr>
                                        <td>تكلفة المبيعات</td>
                                        <td class="text-end text-danger">(${formatCurrency(data.cogs)})</td>
                                    </tr>
                                    <tr class="table-primary">
                                        <td><strong>مجمل الربح</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(grossProfit)}</strong></td>
                                    </tr>
                                    <tr>
                                        <td>المصروفات التشغيلية</td>
                                        <td class="text-end text-danger">(${formatCurrency(data.operatingExpenses)})</td>
                                    </tr>
<tr>
    <td>الإهلاك</td>
    <td class="text-end text-danger">(${formatCurrency(data.depreciationExpense || 0)})</td>
</tr>

                                    <tr class="table-info">
                                        <td><strong>الربح التشغيلي</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(operatingProfit)}</strong></td>
                                    </tr>
                                    <tr>
                                        <td>إيرادات أخرى</td>
                                        <td class="text-end text-success">${formatCurrency(data.otherIncome)}</td>
                                    </tr>
                                    <tr class="table-success">
                                        <td><strong>صافي الربح</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(netProfit)}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                            
                        <div class="mt-4">
                            <h6 class="mb-2">تفصيلي حسب الحساب</h6>
                            <table class="table table-sm table-bordered">
                                <thead class="table-light"><tr><th>رقم الحساب</th><th>اسم الحساب</th><th class="text-end">المبلغ</th></tr></thead>
                                <tbody>
                                    <tr><td colspan="3" class="table-primary"><strong>الإيرادات الرئيسية</strong></td></tr>
                                    ${(() => {
                                        const rev = (data.categorized?.revenue || []).filter(acc => String(acc.account_id||'').startsWith('401') || String(acc.account_id||'').startsWith('410') || String(acc.account_id||'')==='401010001' || String(acc.name||'').includes('مبيعات') || String(acc.name||'').includes('خرسانة') || String(acc.name||'').includes('بلوك') || String(acc.name||'').includes('كسارة'));
                                        const rows = rev.map(acc => `<tr><td>${acc.account_id||'-'}</td><td>${acc.name}</td><td class="text-end">${formatCurrency(-(acc.finalBalance||0))}</td></tr>`).join('');
                                        const total = rev.reduce((s,a)=> s + (-(a.finalBalance||0)),0);
                                        return rows + `<tr class="table-primary"><td colspan="2"><strong>الإجمالي</strong></td><td class="text-end"><strong>${formatCurrency(total)}</strong></td></tr>`;
                                    })()}
                                    <tr><td colspan="3" class="table-secondary"><strong>تكلفة الإيرادات</strong></td></tr>
                                    ${(() => {
                                        const cogs = data.categorized?.cogs || [];
                                        const rows = cogs.map(acc => `<tr><td>${acc.account_id||'-'}</td><td>${acc.name}</td><td class="text-end text-danger">(${formatCurrency(acc.finalBalance||0)})</td></tr>`).join('');
                                        const total = cogs.reduce((s,a)=> s + (a.finalBalance||0),0);
                                        return rows + `<tr class="table-secondary"><td colspan="2"><strong>الإجمالي</strong></td><td class="text-end text-danger"><strong>(${formatCurrency(total)})</strong></td></tr>`;
                                    })()}
                                    <tr><td colspan="3" class="table-info"><strong>إيرادات أخرى</strong></td></tr>
                                    ${(() => {
                                        const otherRev = data.categorized?.otherRevenues || [];
                                        const rows = otherRev.map(acc => `<tr><td>${acc.account_id||'-'}</td><td>${acc.name}</td><td class="text-end">${formatCurrency(-(acc.finalBalance||0))}</td></tr>`).join('');
                                        const total = otherRev.reduce((s,a)=> s + (-(a.finalBalance||0)),0);
                                        return rows + `<tr class="table-info"><td colspan="2"><strong>الإجمالي</strong></td><td class="text-end"><strong>${formatCurrency(total)}</strong></td></tr>`;
                                    })()}
                                    <tr><td colspan="3" class="table-warning"><strong>المصروفات التشغيلية</strong></td></tr>
                                    ${(() => {
                                        const opex = (data.categorized?.operatingExpenses || []).filter(acc => !(String(SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='depreciation' || String(SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='amortization' || String(SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='zakat_expense'));
                                        const rows = opex.map(acc => `<tr><td>${acc.account_id||'-'}</td><td>${acc.name}</td><td class="text-end text-danger">(${formatCurrency(acc.finalBalance||0)})</td></tr>`).join('');
                                        const total = opex.reduce((s,a)=> s + (a.finalBalance||0),0);
                                        return rows + `<tr class="table-warning"><td colspan="2"><strong>الإجمالي</strong></td><td class="text-end text-danger"><strong>(${formatCurrency(total)})</strong></td></tr>`;
                                    })()}
                                    <tr><td colspan="3" class="table-light"><strong>الإهلاك</strong></td></tr>
                                    ${(() => {
                                        const dep = (data.categorized?.operatingExpenses || []).filter(acc => String(SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='depreciation');
                                        const rows = dep.map(acc => `<tr><td>${acc.account_id||'-'}</td><td>${acc.name}</td><td class="text-end text-danger">(${formatCurrency(acc.finalBalance||0)})</td></tr>`).join('');
                                        const total = dep.reduce((s,a)=> s + (a.finalBalance||0),0);
                                        return rows + `<tr class="table-light"><td colspan="2"><strong>الإجمالي</strong></td><td class="text-end text-danger"><strong>(${formatCurrency(total)})</strong></td></tr>`;
                                    })()}
                                    ${(() => {
                                        const mainRev = (data.categorized?.revenue || []).filter(acc => String(acc.account_id||'').startsWith('401') || String(acc.account_id||'').startsWith('410') || String(acc.account_id||'')==='401010001' || String(acc.name||'').includes('مبيعات') || String(acc.name||'').includes('خرسانة') || String(acc.name||'').includes('بلوك') || String(acc.name||'').includes('كسارة'));
                                        const otherRev = data.categorized?.otherRevenues || [];
                                        const cogs = data.categorized?.cogs || [];
                                        const opex = (data.categorized?.operatingExpenses || []).filter(acc => !(String(SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='depreciation' || String(SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='amortization' || String(SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='zakat_expense'));
                                        const dep = (data.categorized?.operatingExpenses || []).filter(acc => String(SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='depreciation');
                                        const totalMainRev = mainRev.reduce((s,a)=> s + (-(a.finalBalance||0)),0);
                                        const totalOtherRev = otherRev.reduce((s,a)=> s + (-(a.finalBalance||0)),0);
                                        const totalCogs = cogs.reduce((s,a)=> s + (a.finalBalance||0),0);
                                        const totalOpex = opex.reduce((s,a)=> s + (a.finalBalance||0),0);
                                        const totalDep = dep.reduce((s,a)=> s + (a.finalBalance||0),0);
                                        const gross = totalMainRev - totalCogs;
                                        const operating = gross - totalOpex - totalDep;
                                        const net = operating + totalOtherRev;
                                        return `
                                            <tr><td colspan="3" class="table-success"><strong>إجماليات التفصيل</strong></td></tr>
                                            <tr><td>مجمل الربح</td><td></td><td class="text-end"><strong>${formatCurrency(gross)}</strong></td></tr>
                                            <tr><td>الربح التشغيلي</td><td></td><td class="text-end"><strong>${formatCurrency(operating)}</strong></td></tr>
                                            <tr><td>صافي الربح</td><td></td><td class="text-end"><strong>${formatCurrency(net)}</strong></td></tr>
                                        `;
                                    })()}
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4">
                            <canvas id="incomeChart" height="100"></canvas>
                        </div>
                        </div>

                        <div class="tab-pane fade" id="balance">
                            <h5 class="mb-3">قائمة المركز المالي</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary">الأصول</h6>
                                    <table class="table table-sm">
                                        <tbody>
                                            <tr>
                                                <td>أصول متداولة</td>
                                                <td class="text-end">${formatCurrency(data.currentAssets)}</td>
                                            </tr>
                                            <tr>
                                                <td>أصول ثابتة</td>
                                                <td class="text-end">${formatCurrency(data.fixedAssets)}</td>
                                            </tr>
                                            <tr class="table-primary">
                                                <td><strong>إجمالي الأصول</strong></td>
                                                <td class="text-end"><strong>${formatCurrency(totalAssets)}</strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-danger">الخصوم وحقوق الملكية</h6>
                                    <table class="table table-sm">
                                        <tbody>
                                            <tr>
                                                <td>خصوم متداولة</td>
                                                <td class="text-end">${formatCurrency(data.currentLiabilities)}</td>
                                            </tr>
                                            <tr>
                                                <td>خصوم طويلة الأجل</td>
                                                <td class="text-end">${formatCurrency(data.longTermLiabilities)}</td>
                                            </tr>
                                            <tr>
                                                <td>حقوق الملكية</td>
                                                <td class="text-end">${formatCurrency(data.equity)}</td>
                                            </tr>
                                            <tr class="table-danger">
                                                <td><strong>إجمالي الخصوم وحقوق الملكية</strong></td>
                                                <td class="text-end"><strong>${formatCurrency(totalLiabilities + data.equity)}</strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <canvas id="balanceChart" height="80"></canvas>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="cashflow">
                            <h5 class="mb-3">قائمة التدفقات النقدية</h5>
                            <table class="table table-striped">
                                <tbody>
                                    <tr class="table-primary">
                                        <td><strong>التدفقات النقدية من الأنشطة التشغيلية</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(data.cashFlowOps)}</strong></td>
                                    </tr>
                                    <tr>
                                        <td>صافي الربح</td>
                                        <td class="text-end">${formatCurrency(netProfit)}</td>
                                    </tr>
                                    <tr>
                                        <td>مصروف الإهلاك</td>
                                        <td class="text-end">${formatCurrency(data.depreciationExpense || 0)}</td>
                                    </tr>
                                    <tr class="table-info">
                                        <td><strong>التدفقات النقدية من الأنشطة الاستثمارية</strong></td>
                                        <td class="text-end text-danger"><strong>${formatCurrency(data.cashFlowInv)}</strong></td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td><strong>التدفقات النقدية من الأنشطة التمويلية</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(data.cashFlowFin)}</strong></td>
                                    </tr>
                                    <tr>
                                        <td>النقدية في بداية الفترة</td>
                                        <td class="text-end">${formatCurrency(data.openingCash || 0)}</td>
                                    </tr>
                                    <tr class="table-success">
                                        <td><strong>صافي الزيادة (النقص) في النقدية</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(data.netCashChange)}</strong></td>
                                    </tr>
                                    <tr class="table-success">
                                        <td><strong>النقدية في نهاية الفترة</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(data.closingCash || 0)}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="mt-4">
                                <h6 class="mb-2">تفصيلي حسب الحساب</h6>
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light"><tr><th>رقم الحساب</th><th>اسم الحساب</th><th class="text-end">المبلغ</th></tr></thead>
                                    <tbody>
                                        <tr><td colspan="3" class="table-primary"><strong>الإيرادات الرئيسية</strong></td></tr>
                                        ${(() => {
                                            const rev = (data.categorized?.revenue || []).filter(acc => String(acc.account_id||'').startsWith('401') || String(acc.account_id||'').startsWith('410') || String(acc.account_id||'')==='401010001' || String(acc.name||'').includes('مبيعات') || String(acc.name||'').includes('خرسانة') || String(acc.name||'').includes('بلوك') || String(acc.name||'').includes('كسارة'));
                                            const rows = rev.map(acc => `<tr><td>${acc.account_id||'-'}</td><td>${acc.name}</td><td class="text-end">${formatCurrency(-(acc.finalBalance||0))}</td></tr>`).join('');
                                            const total = rev.reduce((s,a)=> s + (-(a.finalBalance||0)),0);
                                            return rows + `<tr class="table-primary"><td colspan="2"><strong>الإجمالي</strong></td><td class="text-end"><strong>${formatCurrency(total)}</strong></td></tr>`;
                                        })()}
                                        <tr><td colspan="3" class="table-secondary"><strong>تكلفة الإيرادات</strong></td></tr>
                                        ${(() => {
                                            const cogs = data.categorized?.cogs || [];
                                            const rows = cogs.map(acc => `<tr><td>${acc.account_id||'-'}</td><td>${acc.name}</td><td class="text-end text-danger">(${formatCurrency(acc.finalBalance||0)})</td></tr>`).join('');
                                            const total = cogs.reduce((s,a)=> s + (a.finalBalance||0),0);
                                            return rows + `<tr class="table-secondary"><td colspan="2"><strong>الإجمالي</strong></td><td class="text-end text-danger"><strong>(${formatCurrency(total)})</strong></td></tr>`;
                                        })()}
                                        <tr><td colspan="3" class="table-info"><strong>إيرادات أخرى</strong></td></tr>
                                        ${(() => {
                                            const otherRev = data.categorized?.otherRevenues || [];
                                            const rows = otherRev.map(acc => `<tr><td>${acc.account_id||'-'}</td><td>${acc.name}</td><td class="text-end">${formatCurrency(-(acc.finalBalance||0))}</td></tr>`).join('');
                                            const total = otherRev.reduce((s,a)=> s + (-(a.finalBalance||0)),0);
                                            return rows + `<tr class="table-info"><td colspan="2"><strong>الإجمالي</strong></td><td class="text-end"><strong>${formatCurrency(total)}</strong></td></tr>`;
                                        })()}
                                        <tr><td colspan="3" class="table-warning"><strong>المصروفات التشغيلية</strong></td></tr>
                                        ${(() => {
                                            const opex = (data.categorized?.operatingExpenses || []).filter(acc => !(String(SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='depreciation' || String(SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='amortization' || String(SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='zakat_expense'));
                                            const rows = opex.map(acc => `<tr><td>${acc.account_id||'-'}</td><td>${acc.name}</td><td class="text-end text-danger">(${formatCurrency(acc.finalBalance||0)})</td></tr>`).join('');
                                            const total = opex.reduce((s,a)=> s + (a.finalBalance||0),0);
                                            return rows + `<tr class="table-warning"><td colspan="2"><strong>الإجمالي</strong></td><td class="text-end text-danger"><strong>(${formatCurrency(total)})</strong></td></tr>`;
                                        })()}
                                        <tr><td colspan="3" class="table-light"><strong>الإهلاك</strong></td></tr>
                                        ${(() => {
                                            const dep = (data.categorized?.operatingExpenses || []).filter(acc => String(SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='depreciation');
                                            const rows = dep.map(acc => `<tr><td>${acc.account_id||'-'}</td><td>${acc.name}</td><td class="text-end text-danger">(${formatCurrency(acc.finalBalance||0)})</td></tr>`).join('');
                                            const total = dep.reduce((s,a)=> s + (a.finalBalance||0),0);
                                            return rows + `<tr class="table-light"><td colspan="2"><strong>الإجمالي</strong></td><td class="text-end text-danger"><strong>(${formatCurrency(total)})</strong></td></tr>`;
                                        })()}
                                        ${(() => {
                                            const mainRev = (data.categorized?.revenue || []).filter(acc => String(acc.account_id||'').startsWith('401') || String(acc.account_id||'').startsWith('410') || String(acc.account_id||'')==='401010001' || String(acc.name||'').includes('مبيعات') || String(acc.name||'').includes('خرسانة') || String(acc.name||'').includes('بلوك') || String(acc.name||'').includes('كسارة'));
                                            const otherRev = data.categorized?.otherRevenues || [];
                                            const cogs = data.categorized?.cogs || [];
                                            const opex = (data.categorized?.operatingExpenses || []).filter(acc => !(String(SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='depreciation' || String(SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='amortization' || String(SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='zakat_expense'));
                                            const dep = (data.categorized?.operatingExpenses || []).filter(acc => String(SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='depreciation');
                                            const totalMainRev = mainRev.reduce((s,a)=> s + (-(a.finalBalance||0)),0);
                                            const totalOtherRev = otherRev.reduce((s,a)=> s + (-(a.finalBalance||0)),0);
                                            const totalCogs = cogs.reduce((s,a)=> s + (a.finalBalance||0),0);
                                            const totalOpex = opex.reduce((s,a)=> s + (a.finalBalance||0),0);
                                            const totalDep = dep.reduce((s,a)=> s + (a.finalBalance||0),0);
                                            const gross = totalMainRev - totalCogs;
                                            const operating = gross - totalOpex - totalDep;
                                            const net = operating + totalOtherRev;
                                            return `
                                                <tr><td colspan="3" class="table-success"><strong>إجماليات التفصيل</strong></td></tr>
                                                <tr><td>مجمل الربح</td><td></td><td class="text-end"><strong>${formatCurrency(gross)}</strong></td></tr>
                                                <tr><td>الربح التشغيلي</td><td></td><td class="text-end"><strong>${formatCurrency(operating)}</strong></td></tr>
                                                <tr><td>صافي الربح</td><td></td><td class="text-end"><strong>${formatCurrency(net)}</strong></td></tr>
                                            `;
                                        })()}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="equity">
                            <h5 class="mb-3">قائمة التغيرات في حقوق الملكية</h5>
                            <table class="table table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>البند</th>
                                        <th class="text-end">${window._polaris_endDate ? `(${window._polaris_endDate})` : ''}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>رصيد حقوق الملكية في بداية الفترة</td>
                                        <td class="text-end">${formatCurrency(data.openingEquity || 0)}</td>
                                    </tr>
                                    <tr>
                                        <td>${netProfit >= 0 ? 'يضاف: صافي ربح الفترة' : 'يطرح: صافي خسارة الفترة'}</td>
                                        <td class="text-end ${netProfit >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(netProfit)}</td>
                                    </tr>
                                    <tr>
                                        <td>${(data.partnersCurrentChange || 0) >= 0 ? 'يضاف (يخصم): التغير في جاري الشركاء' : 'يطرح (يضاف): التغير في جاري الشركاء'}</td>
                                        <td class="text-end ${ (data.partnersCurrentChange || 0) >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(data.partnersCurrentChange || 0)}</td>
                                    </tr>
                                    <tr class="table-success">
                                        <td><strong>رصيد حقوق الملكية في نهاية الفترة</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(data.equity)}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="alert alert-info mt-4">
                        <i class="fas fa-info-circle"></i> <strong>ملاحظة:</strong> القوائم المالية معدة وفقاً للمعايير الدولية للتقارير المالية (IFRS)
                    </div>
                </div>
            `;
        }

        function generateAuditReport(data) {
            return `
                <div class="p-4">
                    <h4 class="mb-4 text-center"><i class="fas fa-stamp"></i> تقرير المراجع المستقل</h4>
                    
                    <div class="border border-primary p-4 rounded">
                        <h5 class="text-primary mb-3">إلى السادة / مساهمي ${data.companyName}</h5>
                        
                        <h6 class="mt-4 mb-3">الرأي</h6>
                        <p>لقد راجعنا القوائم المالية المرفقة لـ ${data.companyName} ("الشركة")، والتي تشمل قائمة المركز المالي كما في 31 ديسمبر ${data.fiscalYear}، وقوائم الدخل الشامل والتغيرات في حقوق الملكية والتدفقات النقدية للسنة المنتهية في ذلك التاريخ، والإيضاحات المتممة للقوائم المالية بما في ذلك ملخص السياسات المحاسبية الهامة.</p>
                        
                        <div class="alert alert-success my-3">
                            <p class="mb-0"><strong>في رأينا، إن القوائم المالية المرفقة تعبر بعدالة، من جميع النواحي الجوهرية، عن المركز المالي للشركة كما في 31 ديسمبر ${data.fiscalYear}، وعن أدائها المالي وتدفقاتها النقدية للسنة المنتهية في ذلك التاريخ وفقاً للمعايير الدولية للتقارير المالية (IFRS).</strong></p>
                        </div>
                        
                        <h6 class="mt-4 mb-3">أساس الرأي</h6>
                        <p>لقد قمنا بمراجعتنا وفقاً للمعايير الدولية للمراجعة (ISA). إن مسؤولياتنا بموجب تلك المعايير موضحة بشكل أكبر في قسم "مسؤوليات المراجع" في تقريرنا. نحن مستقلون عن الشركة وفقاً لقواعد السلوك المهني للمحاسبين القانونيين ذات الصلة بمراجعتنا للقوائم المالية، وقد استوفينا مسؤولياتنا الأخلاقية الأخرى وفقاً لهذه المتطلبات.</p>
                        
                        <h6 class="mt-4 mb-3">أمور المراجعة الرئيسية</h6>
                        <table class="table table-bordered mt-3">
                            <thead class="table-dark">
                                <tr>
                                    <th>الأمر</th>
                                    <th>كيفية المعالجة</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>الاعتراف بالإيرادات</td>
                                    <td>قمنا بمراجعة السياسات المحاسبية للاعتراف بالإيرادات والتحقق من مطابقتها لمعيار IFRS 15</td>
                                </tr>
                                <tr>
                                    <td>تقييم المخزون</td>
                                    <td>حضرنا الجرد الفعلي وراجعنا طرق التقييم المستخدمة</td>
                                </tr>
                                <tr>
                                    <td>الانخفاض في قيمة الأصول</td>
                                    <td>راجعنا الافتراضات المستخدمة في اختبارات الانخفاض في القيمة</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <h6 class="mt-4 mb-3">معلومات أخرى</h6>
                        <p>إن الإدارة مسؤولة عن المعلومات الأخرى. تتضمن المعلومات الأخرى المعلومات الواردة في التقرير السنوي، ولكنها لا تتضمن القوائم المالية وتقرير المراجع حولها.</p>
                        
                        <div class="mt-5 text-end">
                            <p class="mb-1"><strong>مكتب المراجعة المعتمد</strong></p>
                            <p class="mb-1">رقم الترخيص: 12345</p>
                            <p class="mb-1">التاريخ: 15 مارس ${data.fiscalYear + 1}</p>
                            <p class="mb-0">المكان: الرياض، المملكة العربية السعودية</p>
                        </div>
                    </div>
                </div>
            `;
        }

   
 // ==================================================================
// --- START: دالة مقارنة الموازنة (V2 - مع موازنة افتراضية) ---
// ==================================================================
// ==================================================================
// --- START: دالة مقارنة الموازنة (V2 - مع موازنة افتراضية) ---
// ==================================================================
function generateBudgetVariance(data) {
    // **الإصلاح الحاسم هنا: إنشاء كائن موازنة افتراضي إذا لم يكن موجودًا**
    const budget = data.budget || {
        revenue: data.revenue * 1.10, // افتراض نمو 10% في الإيرادات
        expenses: (data.cogs + data.operatingExpenses) * 1.05 // افتراض نمو 5% في التكاليف
    };

    const actualRevenue = data.revenue || 0;
    const budgetRevenue = budget.revenue;
    const revenueVariance = actualRevenue - budgetRevenue;
    const revenueVariancePct = budgetRevenue !== 0 ? (revenueVariance / Math.abs(budgetRevenue) * 100).toFixed(1) : 0;
    
    const actualExpenses = data.cogs + data.operatingExpenses;
    const budgetExpenses = budget.expenses;
    const expensesVariance = actualExpenses - budgetExpenses;
    const expensesVariancePct = budgetExpenses !== 0 ? (expensesVariance / Math.abs(budgetExpenses) * 100).toFixed(1) : 0;
    
    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-chart-line"></i> تحليل الانحرافات - الموازنة مقابل الفعلي</h4>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> <strong>ملاحظة:</strong> هذه مقارنة مع موازنة تقديرية افتراضية (نمو 10% في الإيرادات و 5% في التكاليف).
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="stats-card ${revenueVariance >= 0 ? 'border-success' : 'border-danger'}">
                        <h6>انحراف الإيرادات</h6>
                        <h3 class="${revenueVariance >= 0 ? 'text-success' : 'text-danger'}">
                            ${revenueVariance >= 0 ? '+' : ''}${formatCurrency(revenueVariance)}
                        </h3>
                        <p>${revenueVariance >= 0 ? '+' : ''}${revenueVariancePct}%</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stats-card ${expensesVariance <= 0 ? 'border-success' : 'border-danger'}">
                        <h6>انحراف المصروفات</h6>
                        <h3 class="${expensesVariance <= 0 ? 'text-success' : 'text-danger'}">
                            ${expensesVariance >= 0 ? '+' : ''}${formatCurrency(expensesVariance)}
                        </h3>
                        <p>${expensesVariance >= 0 ? '+' : ''}${expensesVariancePct}%</p>
                    </div>
                </div>
            </div>

            <table class="table table-striped table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>البيان</th>
                        <th class="text-end">الموازنة</th>
                        <th class="text-end">الفعلي</th>
                        <th class="text-end">الانحراف</th>
                        <th class="text-end">%</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>الإيرادات</strong></td>
                        <td class="text-end">${formatCurrency(budgetRevenue)}</td>
                        <td class="text-end">${formatCurrency(actualRevenue)}</td>
                        <td class="text-end ${revenueVariance >= 0 ? 'text-success' : 'text-danger'}">
                            ${revenueVariance >= 0 ? '+' : ''}${formatCurrency(revenueVariance)}
                        </td>
                        <td class="text-end ${revenueVariance >= 0 ? 'text-success' : 'text-danger'}">
                            ${revenueVariance >= 0 ? '+' : ''}${revenueVariancePct}%
                        </td>
                    </tr>
                    <tr>
                        <td><strong>المصروفات</strong></td>
                        <td class="text-end">${formatCurrency(budgetExpenses)}</td>
                        <td class="text-end">${formatCurrency(actualExpenses)}</td>
                        <td class="text-end ${expensesVariance <= 0 ? 'text-success' : 'text-danger'}">
                            ${expensesVariance >= 0 ? '+' : ''}${formatCurrency(expensesVariance)}
                        </td>
                        <td class="text-end ${expensesVariance <= 0 ? 'text-success' : 'text-danger'}">
                            ${expensesVariance >= 0 ? '+' : ''}${expensesVariancePct}%
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    `;
}
// ==================================================================
// --- END: دالة مقارنة الموازنة ---
// ==================================================================
// ==================================================================
// --- END: دالة مقارنة الموازنة ---
// ==================================================================


        function generateProfitForecast(data) {
            const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
            const baseProfit = (data.revenue - data.cogs - data.operatingExpenses) / 12;
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-crystal-ball"></i> تنبؤ الأرباح - 12 شهر القادمة</h4>
                    
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="stats-card border-success">
                                <h6>السيناريو المتفائل</h6>
                                <h3 class="text-success">${formatCurrency(baseProfit * 12 * 1.2)}</h3>
                                <p>+20% نمو</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card border-primary">
                                <h6>السيناريو الأساسي</h6>
                                <h3 class="text-primary">${formatCurrency(baseProfit * 12)}</h3>
                                <p>نمو ثابت</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card border-warning">
                                <h6>السيناريو المتحفظ</h6>
                                <h3 class="text-warning">${formatCurrency(baseProfit * 12 * 0.8)}</h3>
                                <p>-20% تراجع</p>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="profitForecastChart"></canvas>
                    </div>

                    <table class="table table-striped mt-4">
                        <thead class="table-dark">
                            <tr>
                                <th>الشهر</th>
                                <th class="text-end">متحفظ</th>
                                <th class="text-end">أساسي</th>
                                <th class="text-end">متفائل</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${months.map((month, i) => `
                                <tr>
                                    <td>${month} ${data.fiscalYear + 1}</td>
                                    <td class="text-end">${formatCurrency(baseProfit * 0.8 * (1 + i * 0.01))}</td>
                                    <td class="text-end">${formatCurrency(baseProfit * (1 + i * 0.015))}</td>
                                    <td class="text-end">${formatCurrency(baseProfit * 1.2 * (1 + i * 0.02))}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="alert alert-info mt-4">
                        <i class="fas fa-info-circle"></i> <strong>ملاحظة:</strong> التوقعات مبنية على الأداء التاريخي والاتجاهات السوقية الحالية
                    </div>
                </div>
            `;
        }

        function generateCashForecast(data) {
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-water"></i> تدفق نقدي (Sankey Diagram)</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> يوضح هذا المخطط تدفق الأموال من المصادر إلى الاستخدامات
                    </div>

                    <div class="chart-container" style="height: 500px;">
                        <canvas id="sankeyChart"></canvas>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h6 class="text-success">مصادر النقد</h6>
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <td>التدفقات التشغيلية</td>
                                        <td class="text-end text-success">${formatCurrency(data.cashFlow)}</td>
                                    </tr>
                                    <tr>
                                        <td>قروض جديدة</td>
                                        <td class="text-end text-success">${formatCurrency(data.cashFlow * 0.3)}</td>
                                    </tr>
                                    <tr>
                                        <td>بيع أصول</td>
                                        <td class="text-end text-success">${formatCurrency(data.cashFlow * 0.1)}</td>
                                    </tr>
                                    <tr class="table-success">
                                        <td><strong>إجمالي المصادر</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(data.cashFlow * 1.4)}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-danger">استخدامات النقد</h6>
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <td>شراء أصول</td>
                                        <td class="text-end text-danger">${formatCurrency(data.cashFlow * 0.5)}</td>
                                    </tr>
                                    <tr>
                                        <td>سداد قروض</td>
                                        <td class="text-end text-danger">${formatCurrency(data.cashFlow * 0.3)}</td>
                                    </tr>
                                    <tr>
                                        <td>توزيعات أرباح</td>
                                        <td class="text-end text-danger">${formatCurrency(data.cashFlow * 0.2)}</td>
                                    </tr>
                                    <tr class="table-danger">
                                        <td><strong>إجمالي الاستخدامات</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(data.cashFlow * 1.0)}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="alert alert-success mt-4">
                        <i class="fas fa-check-circle"></i> <strong>صافي التغير في النقدية:</strong> ${formatCurrency(data.cashFlow * 0.4)}
                    </div>
                </div>
            `;
        }

        function generateLoanCapacity(data) {
            const ebitda = data.revenue - data.cogs - data.operatingExpenses + (data.fixedAssets * 0.1); // Adding back depreciation
            const debtService = data.longTermLiabilities * 0.15; // Assuming 15% annual debt service
            const dscr = ebitda / debtService;
            const maxLoan = ebitda / 0.15 * 0.8; // 80% of capacity at 15% debt service
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-hand-holding-usd"></i> تحليل سعة القروض (DSCR)</h4>
                    
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="stats-card ${dscr >= 1.5 ? 'border-success' : dscr >= 1.2 ? 'border-warning' : 'border-danger'}">
                                <h6>نسبة تغطية خدمة الدين</h6>
                                <h3 class="${dscr >= 1.5 ? 'text-success' : dscr >= 1.2 ? 'text-warning' : 'text-danger'}">
                                    ${dscr.toFixed(2)}x
                                </h3>
                                <p>${dscr >= 1.5 ? 'ممتاز' : dscr >= 1.2 ? 'مقبول' : 'ضعيف'}</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card border-primary">
                                <h6>EBITDA السنوي</h6>
                                <h3 class="text-primary">${formatCurrency(ebitda)}</h3>
                                <p>الأرباح قبل الفوائد والضرائب والإهلاك</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card border-info">
                                <h6>الحد الأقصى للقروض</h6>
                                <h3 class="text-info">${formatCurrency(maxLoan)}</h3>
                                <p>بناءً على DSCR 1.25</p>
                            </div>
                        </div>
                    </div>

                    <div class="alert ${dscr >= 1.5 ? 'alert-success' : dscr >= 1.2 ? 'alert-warning' : 'alert-danger'}">
                        <h6><i class="fas fa-info-circle"></i> التفسير</h6>
                        <p class="mb-0">
                            ${dscr >= 1.5 ? 
                                'الشركة لديها قدرة ممتازة على خدمة ديونها. يمكن التفكير في الحصول على تمويل إضافي للتوسع.' :
                                dscr >= 1.2 ?
                                'الشركة لديها قدرة مقبولة على خدمة ديونها. يُنصح بالحذر عند الحصول على قروض إضافية.' :
                                'الشركة تواجه صعوبة في خدمة ديونها الحالية. يُنصح بتحسين التدفقات النقدية قبل التفكير في قروض جديدة.'}
                        </p>
                    </div>

                    <table class="table table-bordered mt-4">
                        <thead class="table-dark">
                            <tr>
                                <th>البيان</th>
                                <th class="text-end">المبلغ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>EBITDA السنوي</td>
                                <td class="text-end">${formatCurrency(ebitda)}</td>
                            </tr>
                            <tr>
                                <td>خدمة الدين السنوية الحالية</td>
                                <td class="text-end">${formatCurrency(debtService)}</td>
                            </tr>
                            <tr class="table-primary">
                                <td><strong>DSCR</strong></td>
                                <td class="text-end"><strong>${dscr.toFixed(2)}x</strong></td>
                            </tr>
                            <tr>
                                <td>القروض الحالية</td>
                                <td class="text-end">${formatCurrency(data.longTermLiabilities)}</td>
                            </tr>
                            <tr>
                                <td>الحد الأقصى للقروض (DSCR 1.25)</td>
                                <td class="text-end">${formatCurrency(maxLoan)}</td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>السعة الإضافية المتاحة</strong></td>
                                <td class="text-end"><strong>${formatCurrency(Math.max(0, maxLoan - data.longTermLiabilities))}</strong></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="chart-container mt-4">
                        <canvas id="dscr Chart"></canvas>
                    </div>
                </div>
            `;
        }

        function generateMoneyFlow(data) {
            const totalSources = data.revenue + data.otherIncome + (data.longTermLiabilities * 0.1);
            const totalUses = data.cogs + data.operatingExpenses + (data.fixedAssets * 0.15);
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-exchange-alt"></i> مصادر واستخدامات الأموال</h4>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-success bg-opacity-10 border-success">
<div class="p-3">
                                    <h5 class="card-title text-success"><i class="fas fa-arrow-down"></i> مصادر الأموال</h5>
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="sourcesChart"></canvas>
                                    </div>
                                    <table class="table table-sm mt-3">
                                        <tbody>
                                            <tr>
                                                <td>الإيرادات التشغيلية</td>
                                                <td class="text-end">${formatCurrency(data.revenue)}</td>
                                                <td class="text-end">${((data.revenue / totalSources) * 100).toFixed(1)}%</td>
                                            </tr>
                                            <tr>
                                                <td>إيرادات أخرى</td>
                                                <td class="text-end">${formatCurrency(data.otherIncome)}</td>
                                                <td class="text-end">${((data.otherIncome / totalSources) * 100).toFixed(1)}%</td>
                                            </tr>
                                            <tr>
                                                <td>قروض جديدة</td>
                                                <td class="text-end">${formatCurrency(data.longTermLiabilities * 0.1)}</td>
                                                <td class="text-end">${((data.longTermLiabilities * 0.1 / totalSources) * 100).toFixed(1)}%</td>
                                            </tr>
                                            <tr class="table-success">
                                                <td><strong>الإجمالي</strong></td>
                                                <td class="text-end"><strong>${formatCurrency(totalSources)}</strong></td>
                                                <td class="text-end"><strong>100%</strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card bg-danger bg-opacity-10 border-danger">
<div class="p-3">
                                    <h5 class="card-title text-danger"><i class="fas fa-arrow-up"></i> استخدامات الأموال</h5>
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="usesChart"></canvas>
                                    </div>
                                    <table class="table table-sm mt-3">
                                        <tbody>
                                            <tr>
                                                <td>تكلفة المبيعات</td>
                                                <td class="text-end">${formatCurrency(data.cogs)}</td>
                                                <td class="text-end">${((data.cogs / totalUses) * 100).toFixed(1)}%</td>
                                            </tr>
                                            <tr>
                                                <td>مصروفات تشغيلية</td>
                                                <td class="text-end">${formatCurrency(data.operatingExpenses)}</td>
                                                <td class="text-end">${((data.operatingExpenses / totalUses) * 100).toFixed(1)}%</td>
                                            </tr>
                                            <tr>
                                                <td>استثمارات رأسمالية</td>
                                                <td class="text-end">${formatCurrency(data.fixedAssets * 0.15)}</td>
                                                <td class="text-end">${((data.fixedAssets * 0.15 / totalUses) * 100).toFixed(1)}%</td>
                                            </tr>
                                            <tr class="table-danger">
                                                <td><strong>الإجمالي</strong></td>
                                                <td class="text-end"><strong>${formatCurrency(totalUses)}</strong></td>
                                                <td class="text-end"><strong>100%</strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info mt-4">
                        <h6><i class="fas fa-balance-scale"></i> صافي التدفق</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-0">إجمالي المصادر: <strong>${formatCurrency(totalSources)}</strong></p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-0">إجمالي الاستخدامات: <strong>${formatCurrency(totalUses)}</strong></p>
                            </div>
                        </div>
                        <hr>
                        <p class="mb-0 text-center">
                            <strong>الفائض / (العجز):</strong> 
                            <span class="${totalSources - totalUses >= 0 ? 'text-success' : 'text-danger'}">
                                ${formatCurrency(totalSources - totalUses)}
                            </span>
                        </p>
                    </div>
                </div>
            `;
        }

        // ========== MANAGEMENT REPORTS ==========
  // ==================================================================
// --- START: مركز قيادة دوبونت الاستراتيجي (V4) ---
// ==================================================================
// ==================================================================
// --- START: قمرة القيادة 360° (V-Manus-Standard) ---
// ==================================================================
function generateKPIDashboard(data) {
    // --- 1. تعريف الأهداف (يمكن تحميلها لاحقًا من إعدادات) ---
    const targets = {
        netProfitMargin: 15, // %
        currentRatio: 2.0,   // x
        debtToEquity: 0.8,   // x
        assetTurnover: 1.2   // x
    };

    // --- 2. حساب النسب الفعلية (الحالية) ---
    const actual = {
        netProfitMargin: data.revenue > 0 ? (data.netIncome / data.revenue) * 100 : 0,
        currentRatio: data.currentLiabilities > 0 ? data.currentAssets / data.currentLiabilities : 0,
        debtToEquity: data.equity > 0 ? data.liabilities / data.equity : 0,
        assetTurnover: data.assets > 0 ? data.revenue / data.assets : 0,
        operatingCashFlow: data.cashFlow,
        expenseRatio: data.revenue > 0 ? (data.cogs + data.operatingExpenses) / data.revenue * 100 : 0
    };

    // --- 3. دالة بناء بطاقة المؤشر الرئيسية ---
    const createCoreKpiCard = (title, value, icon, color) => `
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stats-card border-${color}">
                <i class="fas ${icon} fa-2x text-${color} mb-3"></i>
                <h3>${formatCurrency(value)}</h3>
                <p>${title}</p>
            </div>
        </div>
    `;

    // --- 4. دالة بناء بطاقة النسبة مع مؤشر الأداء ---
    const createRatioCard = (title, actualValue, targetValue, unit, isLowerBetter = false) => {
        const variance = actualValue - targetValue;
        const performance = isLowerBetter ? (variance <= 0 ? 'good' : 'bad') : (variance >= 0 ? 'good' : 'bad');
        const icon = performance === 'good' ? 'fa-check-circle' : 'fa-exclamation-triangle';
        const color = performance === 'good' ? 'success' : 'danger';

        return `
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="card bg-dark border-${color} h-100">
                    <div class="card-body text-center">
                        <h6 class="card-title" style="color: var(--color-text-primary) !important;">${title}</h6>
                        <h2 class="display-5 fw-bold text-${color}">${actualValue.toFixed(1)}${unit}</h2>
                        <p class="mb-0" style="color: var(--color-text-secondary) !important;">
                            الهدف: ${targetValue.toFixed(1)}${unit}
                            <span class="ms-2"><i class="fas ${icon} text-${color}"></i></span>
                        </p>
                    </div>
                </div>
            </div>
        `;
    };

    // --- 5. بناء الواجهة النهائية ---
    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-tachometer-alt-fast me-2"></i>قمرة القيادة 360°</h4>
            
            <!-- القسم الأول: المؤشرات الرئيسية -->
            <h5 class="text-primary border-bottom pb-2 mb-3">المؤشرات الرئيسية (Core KPIs)</h5>
            <div class="row">
                ${createCoreKpiCard('صافي الربح', data.netIncome, 'fa-chart-line', 'success')}
                ${createCoreKpiCard('الإيرادات الكلية', data.revenue, 'fa-dollar-sign', 'primary')}
                ${createCoreKpiCard('التدفق النقدي التشغيلي', data.operatingCashFlow, 'fa-money-bill-wave', 'info')}
                ${createCoreKpiCard('إجمالي المصروفات', data.cogs + data.operatingExpenses, 'fa-file-invoice-dollar', 'danger')}
            </div>

            <!-- القسم الثاني: مؤشرات الأداء التفصيلية -->
            <h5 class="text-primary border-bottom pb-2 mt-5 mb-3">مؤشرات الأداء التفصيلية</h5>
            <div class="row">
                ${createRatioCard('هامش صافي الربح', actual.netProfitMargin, targets.netProfitMargin, '%')}
                ${createRatioCard('نسبة السيولة', actual.currentRatio, targets.currentRatio, 'x')}
                ${createRatioCard('الديون إلى حقوق الملكية', actual.debtToEquity, targets.debtToEquity, 'x', true)}
                ${createRatioCard('معدل دوران الأصول', actual.assetTurnover, targets.assetTurnover, 'x')}
            </div>

            <!-- القسم الثالث: جدول الأهداف والانحرافات -->
            <h5 class="text-primary border-bottom pb-2 mt-5 mb-3">جدول الأهداف والانحرافات</h5>
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>المؤشر</th>
                        <th class="text-end">الهدف</th>
                        <th class="text-end">الفعلي</th>
                        <th class="text-end">الانحراف</th>
                        <th class="text-center">الحالة</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.keys(targets).map(key => {
                        const target = targets[key];
                        const actualVal = actual[key];
                        const variance = actualVal - target;
                        const variancePct = target !== 0 ? (variance / target) * 100 : 0;
                        const isGood = (key === 'debtToEquity') ? variance <= 0 : variance >= 0;
                        return `
                            <tr>
                                <td>${{'netProfitMargin': 'هامش صافي الربح (%)', 'currentRatio': 'نسبة السيولة (x)', 'debtToEquity': 'الديون/حقوق الملكية (x)', 'assetTurnover': 'دوران الأصول (x)'}[key]}</td>
                                <td class="text-end">${target.toFixed(1)}</td>
                                <td class="text-end">${actualVal.toFixed(1)}</td>
                                <td class="text-end fw-bold text-${isGood ? 'success' : 'danger'}">${variancePct.toFixed(1)}%</td>
                                <td class="text-center"><span class="badge bg-${isGood ? 'success' : 'danger'}">${isGood ? 'أداء جيد' : 'يحتاج مراجعة'}</span></td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}
// ==================================================================
// --- END: قمرة القيادة 360° (V-Manus-Standard) ---
// ==================================================================
// ==================================================================
// --- END: مركز قيادة دوبونت الاستراتيجي (V4) ---
// ==================================================================
// ==================================================================
// --- START: قمرة القيادة 360° (V-Manus-Standard) ---
// ==================================================================
function generateKPIDashboard(data) {
    // --- 1. تعريف الأهداف (يمكن تحميلها لاحقًا من إعدادات) ---
    const targets = {
        netProfitMargin: 15, // %
        currentRatio: 2.0,   // x
        debtToEquity: 0.8,   // x
        assetTurnover: 1.2   // x
    };

    // --- 2. حساب النسب الفعلية (الحالية) ---
    const actual = {
        netProfitMargin: data.revenue > 0 ? (data.netIncome / data.revenue) * 100 : 0,
        currentRatio: data.currentLiabilities > 0 ? data.currentAssets / data.currentLiabilities : 0,
        debtToEquity: data.equity > 0 ? data.liabilities / data.equity : 0,
        assetTurnover: data.assets > 0 ? data.revenue / data.assets : 0,
        operatingCashFlow: data.cashFlow,
        expenseRatio: data.revenue > 0 ? (data.cogs + data.operatingExpenses) / data.revenue * 100 : 0
    };

    // --- 3. دالة بناء بطاقة المؤشر الرئيسية ---
    const createCoreKpiCard = (title, value, icon, color) => `
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stats-card border-${color}">
                <i class="fas ${icon} fa-2x text-${color} mb-3"></i>
                <h3>${formatCurrency(value)}</h3>
                <p>${title}</p>
            </div>
        </div>
    `;

    // --- 4. دالة بناء بطاقة النسبة مع مؤشر الأداء ---
    const createRatioCard = (title, actualValue, targetValue, unit, isLowerBetter = false) => {
        const variance = actualValue - targetValue;
        const performance = isLowerBetter ? (variance <= 0 ? 'good' : 'bad') : (variance >= 0 ? 'good' : 'bad');
        const icon = performance === 'good' ? 'fa-check-circle' : 'fa-exclamation-triangle';
        const color = performance === 'good' ? 'success' : 'danger';

        return `
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="card bg-dark border-${color} h-100">
                    <div class="card-body text-center">
                        <h6 class="card-title" style="color: var(--color-text-primary) !important;">${title}</h6>
                        <h2 class="display-5 fw-bold text-${color}">${actualValue.toFixed(1)}${unit}</h2>
                        <p class="mb-0" style="color: var(--color-text-secondary) !important;">
                            الهدف: ${targetValue.toFixed(1)}${unit}
                            <span class="ms-2"><i class="fas ${icon} text-${color}"></i></span>
                        </p>
                    </div>
                </div>
            </div>
        `;
    };

    // --- 5. بناء الواجهة النهائية ---
    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-tachometer-alt-fast me-2"></i>قمرة القيادة 360°</h4>
            
            <!-- القسم الأول: المؤشرات الرئيسية -->
            <h5 class="text-primary border-bottom pb-2 mb-3">المؤشرات الرئيسية (Core KPIs)</h5>
            <div class="row">
                ${createCoreKpiCard('صافي الربح', data.netIncome, 'fa-chart-line', 'success')}
                ${createCoreKpiCard('الإيرادات الكلية', data.revenue, 'fa-dollar-sign', 'primary')}
                ${createCoreKpiCard('التدفق النقدي التشغيلي', data.operatingCashFlow, 'fa-money-bill-wave', 'info')}
                ${createCoreKpiCard('إجمالي المصروفات', data.cogs + data.operatingExpenses, 'fa-file-invoice-dollar', 'danger')}
            </div>

            <!-- القسم الثاني: مؤشرات الأداء التفصيلية -->
            <h5 class="text-primary border-bottom pb-2 mt-5 mb-3">مؤشرات الأداء التفصيلية</h5>
            <div class="row">
                ${createRatioCard('هامش صافي الربح', actual.netProfitMargin, targets.netProfitMargin, '%')}
                ${createRatioCard('نسبة السيولة', actual.currentRatio, targets.currentRatio, 'x')}
                ${createRatioCard('الديون إلى حقوق الملكية', actual.debtToEquity, targets.debtToEquity, 'x', true)}
                ${createRatioCard('معدل دوران الأصول', actual.assetTurnover, targets.assetTurnover, 'x')}
            </div>

            <!-- القسم الثالث: جدول الأهداف والانحرافات -->
            <h5 class="text-primary border-bottom pb-2 mt-5 mb-3">جدول الأهداف والانحرافات</h5>
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>المؤشر</th>
                        <th class="text-end">الهدف</th>
                        <th class="text-end">الفعلي</th>
                        <th class="text-end">الانحراف</th>
                        <th class="text-center">الحالة</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.keys(targets).map(key => {
                        const target = targets[key];
                        const actualVal = actual[key];
                        const variance = actualVal - target;
                        const variancePct = target !== 0 ? (variance / target) * 100 : 0;
                        const isGood = (key === 'debtToEquity') ? variance <= 0 : variance >= 0;
                        return `
                            <tr>
                                <td>${{'netProfitMargin': 'هامش صافي الربح (%)', 'currentRatio': 'نسبة السيولة (x)', 'debtToEquity': 'الديون/حقوق الملكية (x)', 'assetTurnover': 'دوران الأصول (x)'}[key]}</td>
                                <td class="text-end">${target.toFixed(1)}</td>
                                <td class="text-end">${actualVal.toFixed(1)}</td>
                                <td class="text-end fw-bold text-${isGood ? 'success' : 'danger'}">${variancePct.toFixed(1)}%</td>
                                <td class="text-center"><span class="badge bg-${isGood ? 'success' : 'danger'}">${isGood ? 'أداء جيد' : 'يحتاج مراجعة'}</span></td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}
// ==================================================================
// --- END: قمرة القيادة 360° (V-Manus-Standard) ---
// ==================================================================
// ==================================================================
// --- START: مختبر الربحية متعدد الأبعاد (V2.1 - النسخة الكاملة والمصححة) ---
// ==================================================================
function generateProfitabilityDim(data) {
    // --- 1. بناء الواجهة التفاعلية ---
    setTimeout(() => {
        document.getElementById('dimensionSelector').addEventListener('change', calculateProfitabilityByDimension);
        calculateProfitabilityByDimension(); // إجراء الحساب الأولي
    }, 100);

    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-cube me-2"></i>مختبر الربحية متعدد الأبعاد</h4>
            
            <div class="card bg-dark border-primary mb-4">
                <div class="card-body">
                    <label for="dimensionSelector" class="form-label">اختر بُعد التحليل:</label>
                    <select id="dimensionSelector" class="form-select">
                        <option value="product">الربحية حسب المنتج</option>
                    </select>
                </div>
            </div>

            <div id="profitabilityResults">
                <div class="text-center p-5">
                    <div class="loading-spinner"></div>
                    <p class="mt-3">جاري تحليل الأبعاد...</p>
                </div>
            </div>
        </div>
    `;
}

function calculateProfitabilityByDimension() {
    const resultsContainer = document.getElementById('profitabilityResults');
    const data = getData();

    const products = {
        block: { name: 'البلوك', revenue: 0, cogs: 0 },
        concrete: { name: 'الخرسانة', revenue: 0, cogs: 0 }
    };

    data.categorized.revenue.forEach(acc => {
        const name = acc.name.toLowerCase();
        const balance = Math.abs(acc.finalBalance);
        if (name.includes('بلوك')) products.block.revenue += balance;
        else if (name.includes('خرسانة')) products.concrete.revenue += balance;
    });

    data.categorized.cogs.forEach(acc => {
        const name = acc.name.toLowerCase();
        const balance = Math.abs(acc.finalBalance);
        if (name.includes('بلوك')) products.block.cogs += balance;
        else if (name.includes('خرسانة')) products.concrete.cogs += balance;
    });

    const totalRevenue = products.block.revenue + products.concrete.revenue;
    const fixedCosts = data.operatingExpenses + data.depreciationExpense;

    Object.values(products).forEach(p => {
        const revenueShare = totalRevenue > 0 ? p.revenue / totalRevenue : 0;
        p.fixedCostShare = fixedCosts * revenueShare;
        p.netProfit = p.revenue - p.cogs - p.fixedCostShare;
        p.profitMargin = p.revenue > 0 ? (p.netProfit / p.revenue) * 100 : 0;
    });

    resultsContainer.innerHTML = `
        <div class="row">
            <div class="col-md-7">
                <div class="card bg-dark border-secondary">
                    <div class="card-header"><h5><i class="fas fa-poll me-2"></i>نتائج تحليل الربحية</h5></div>
                    <div class="card-body p-0">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>المنتج</th>
                                    <th class="text-end">الإيرادات</th>
                                    <th class="text-end">التكاليف المتغيرة (COGS)</th>
                                    <th class="text-end">نصيب من التكاليف الثابتة</th>
                                    <th class="text-end">صافي الربح</th>
                                    <th class="text-end">هامش الربح</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.values(products).map(p => `
                                    <tr>
                                        <td>${p.name}</td>
                                        <td class="text-end">${formatCurrency(p.revenue)}</td>
                                        <td class="text-end text-danger">(${formatCurrency(p.cogs)})</td>
                                        <td class="text-end text-danger">(${formatCurrency(p.fixedCostShare)})</td>
                                        <td class="text-end fw-bold text-${p.netProfit >= 0 ? 'success' : 'danger'}">${formatCurrency(p.netProfit)}</td>
                                        <td class="text-end fw-bold text-${p.netProfit >= 0 ? 'success' : 'danger'}">${p.profitMargin.toFixed(1)}%</td>
                                    </tr>
                                `).join('')}
                                <tr class="table-primary">
                                    <td><strong>الإجمالي</strong></td>
                                    <td class="text-end"><strong>${formatCurrency(totalRevenue)}</strong></td>
                                    <td class="text-end"><strong>(${formatCurrency(data.cogs)})</strong></td>
                                    <td class="text-end"><strong>(${formatCurrency(fixedCosts)})</strong></td>
                                    <td class="text-end"><strong>${formatCurrency(data.netIncome)}</strong></td>
                                    <td class="text-end"><strong>${(data.netIncome / totalRevenue * 100).toFixed(1)}%</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-5">
                <div class="chart-container" style="height: 400px;">
                    <canvas id="profitabilityChart"></canvas>
                </div>
            </div>
        </div>
    `;

    const ctx = document.getElementById('profitabilityChart')?.getContext('2d');
    if (ctx) {
        if (window.profitabilityChartInstance) window.profitabilityChartInstance.destroy();
        window.profitabilityChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.values(products).map(p => p.name),
                datasets: [{
                    label: 'صافي الربح',
                    data: Object.values(products).map(p => p.netProfit),
                    backgroundColor: ['#17a2b8', '#28a745']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'مقارنة ربحية المنتجات', color: 'var(--color-text-primary)' }
                },
                scales: {
                    y: { ticks: { color: 'var(--color-text-secondary)' } },
                    x: { ticks: { color: 'var(--color-text-secondary)' } }
                }
            }
        });
    }
}
// ==================================================================
// --- END: مختبر الربحية متعدد الأبعاد (V2.1) ---
// ==================================================================


// ==================================================================
// --- START: لوحة قيادة السيولة ودورة النقد (V3 - مع حسابات CCC الصحيحة) ---
// ==================================================================
function generateWorkingCapital(data) {
    // --- 1. حساب المكونات الأساسية (لا تغيير هنا) ---
    const workingCapital = data.currentAssets - data.currentLiabilities;
    const currentRatio = data.currentLiabilities > 0 ? data.currentAssets / data.currentLiabilities : 0;
    
    // --- 2. حساب دورة التحويل النقدي (CCC) بدقة باستخدام sub_category ---
    
    // **الإصلاح الحاسم هنا**
    const inventory = Math.abs((data.categorized.trialBalance || data.trialBalance)
        .filter(acc => acc.sub_category && acc.sub_category.startsWith('116'))
        .reduce((sum, acc) => sum + acc.finalBalance, 0));

    const receivables = Math.abs((data.categorized.trialBalance || data.trialBalance)
        .filter(acc => acc.sub_category && acc.sub_category.startsWith('113'))
        .reduce((sum, acc) => sum + acc.finalBalance, 0));

    const payables = Math.abs((data.categorized.trialBalance || data.trialBalance)
        .filter(acc => acc.sub_category && acc.sub_category.startsWith('211'))
        .reduce((sum, acc) => sum + acc.finalBalance, 0));

    const quickRatio = data.currentLiabilities > 0 ? (data.currentAssets - inventory) / data.currentLiabilities : 0;

    const dso = data.revenue > 0 ? (receivables / (data.revenue / 365)) : 0;
    const dio = data.cogs > 0 ? (inventory / (data.cogs / 365)) : 0;
    const dpo = data.cogs > 0 ? (payables / (data.cogs / 365)) : 0;
    const ccc = dso + dio - dpo;

    // --- 3. دالة بناء بطاقة المؤشر (لا تغيير) ---
    const createWC_Card = (title, value, unit, target, isLowerBetter = false) => {
        const isGood = isLowerBetter ? value <= target : value >= target;
        return `
            <div class="col-md-3 mb-4">
                <div class="stats-card border-${isGood ? 'success' : 'danger'}">
                    <h6>${title}</h6>
                    <h3 class="text-${isGood ? 'success' : 'danger'}">${value.toFixed(1)} <small>${unit}</small></h3>
                    <p>الهدف: ${isLowerBetter ? '<' : '>'} ${target.toFixed(1)} ${unit}</p>
                </div>
            </div>
        `;
    };

    // --- 4. بناء الواجهة النهائية (لا تغيير) ---
    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-cogs me-2"></i>لوحة قيادة السيولة ودورة النقد</h4>
            
            <div class="row">
                ${createWC_Card('رأس المال العامل', workingCapital / 1000, 'ألف ريال', 0)}
                ${createWC_Card('النسبة الحالية', currentRatio, 'x', 1.5)}
                ${createWC_Card('نسبة السيولة السريعة', quickRatio, 'x', 1.0)}
                ${createWC_Card('دورة التحويل النقدي', ccc, 'يوم', 60, true)}
            </div>

            <div class="card bg-dark border-primary mt-4">
                <div class="card-header"><h5><i class="fas fa-sync-alt me-2"></i>تحليل دورة التحويل النقدي (CCC)</h5></div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="p-3 border border-info rounded">
                                <h5 class="text-info">${dso.toFixed(0)} يوم</h5>
                                <p class="mb-0 small">فترة تحصيل المبيعات (DSO)</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 border border-warning rounded">
                                <h5 class="text-warning">${dio.toFixed(0)} يوم</h5>
                                <p class="mb-0 small">فترة دوران المخزون (DIO)</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 border border-success rounded">
                                <h5 class="text-success">${dpo.toFixed(0)} يوم</h5>
                                <p class="mb-0 small">فترة سداد الموردين (DPO)</p>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-3 fs-5">
                        <strong class="text-info">${dso.toFixed(0)}</strong> + 
                        <strong class="text-warning">${dio.toFixed(0)}</strong> - 
                        <strong class="text-success">${dpo.toFixed(0)}</strong> = 
                        <strong class="text-primary">${ccc.toFixed(0)} يوم</strong>
                    </div>
                </div>
            </div>

            <div class="alert alert-info mt-4">
                <h5 class="alert-heading"><i class="fas fa-lightbulb me-2"></i>التشخيص الذكي</h5>
                <p style="color: var(--color-text-primary) !important;">
                    ${ccc < 45 ? 'كفاءة إدارة النقد ممتازة، حيث يتم تحويل الاستثمارات إلى نقد بسرعة.' : 
                       ccc < 75 ? 'كفاءة إدارة النقد جيدة. يمكن تحسينها عبر تقليل فترة المخزون أو تسريع التحصيل.' :
                       'هناك ضغط على السيولة بسبب طول دورة التحويل النقدي. يجب التركيز بشكل عاجل على تسريع تحصيل الديون من العملاء وتقليل فترة بقاء المخزون.'}
                </p>
            </div>
        </div>
    `;
}
// ==================================================================
// --- END: لوحة قيادة السيولة ودورة النقد (V3) ---
// ==================================================================
// ==================================================================
// --- END: لوحة قيادة السيولة ودورة النقد (V2) ---
// ==================================================================


   // ==================================================================
// --- START: دالة تحليل التكاليف ABC (V2 - مختبر توزيع التكاليف) ---
// ==================================================================
// --- START: مختبر توزيع التكاليف (V5 - الإصلاح الجذري والنهائي) ---
// ==================================================================
function generateABCCosting(data) {
    // --- 1. بناء هيكل HTML الأساسي ---
    const expenseAccounts = [...data.categorized.cogs, ...data.categorized.operatingExpenses];
    const accountOptions = expenseAccounts.map(acc => `<option value="${acc.account_id}">${acc.name}</option>`).join('');

    const initialHTML = `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-sitemap me-2"></i>مختبر توزيع التكاليف (ABC)</h4>
            <div class="card bg-dark border-primary mb-4">
                <div class="card-header"><h5><i class="fas fa-cogs me-2"></i>حدد محركات التكلفة لكل نشاط</h5></div>
                <div class="card-body">
                    <div class="row" id="abcInputs">
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold text-info">1. نشاط الإنتاج (التكاليف المباشرة)</label>
                            <select id="productionDrivers" class="form-select cost-driver-select" multiple size="8">${accountOptions}</select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold text-warning">2. نشاط الصيانة والتشغيل</label>
                            <select id="maintenanceDrivers" class="form-select cost-driver-select" multiple size="8">${accountOptions}</select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold text-danger">3. نشاط الإدارة والبيع</label>
                            <select id="adminDrivers" class="form-select cost-driver-select" multiple size="8">${accountOptions}</select>
                        </div>
                    </div>
                </div>
            </div>
            <div id="abcResults"><div class="text-center p-5"><div class="loading-spinner"></div><p class="mt-3">جاري التوزيع التلقائي...</p></div></div>
        </div>
    `;

    // --- 2. دالة الحساب والعرض (الآن هي دالة داخلية) ---
    const calculateAndRender = () => {
        const resultsContainer = document.getElementById('abcResults');
        
        const getSelectedCosts = (selectId) => {
            const selectedOptions = Array.from(document.getElementById(selectId).selectedOptions);
            return selectedOptions.reduce((sum, option) => {
                const account = data.trialBalance.find(acc => acc.account_id === option.value);
                return sum + (account ? Math.abs(account.finalBalance) : 0);
            }, 0);
        };

        const productionCost = getSelectedCosts('productionDrivers');
        const maintenanceCost = getSelectedCosts('maintenanceDrivers');
        const adminCost = getSelectedCosts('adminDrivers');
        const totalExpenses = data.cogs + data.operatingExpenses;
        const unassignedCost = totalExpenses - (productionCost + maintenanceCost + adminCost);

        resultsContainer.innerHTML = `
            <div class="row">
                <div class="col-md-7">
                    <div class="card bg-dark border-secondary">
                        <div class="card-header"><h5><i class="fas fa-calculator me-2"></i>نتائج التوزيع</h5></div>
                        <div class="card-body p-0">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>النشاط</th>
                                        <th class="text-end">التكلفة المخصصة</th>
                                        <th class="text-end">النسبة من الإجمالي</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><i class="fas fa-circle text-info me-2"></i>نشاط الإنتاج</td>
                                        <td class="text-end">${formatCurrency(productionCost)}</td>
                                        <td class="text-end">${totalExpenses > 0 ? (productionCost / totalExpenses * 100).toFixed(1) : 0}%</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-circle text-warning me-2"></i>نشاط الصيانة والتشغيل</td>
                                        <td class="text-end">${formatCurrency(maintenanceCost)}</td>
                                        <td class="text-end">${totalExpenses > 0 ? (maintenanceCost / totalExpenses * 100).toFixed(1) : 0}%</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-circle text-danger me-2"></i>نشاط الإدارة والبيع</td>
                                        <td class="text-end">${formatCurrency(adminCost)}</td>
                                        <td class="text-end">${totalExpenses > 0 ? (adminCost / totalExpenses * 100).toFixed(1) : 0}%</td>
                                    </tr>
                                    <tr class="table-secondary text-dark">
                                        <td><i class="fas fa-question-circle me-2"></i>تكاليف غير موزعة</td>
                                        <td class="text-end">${formatCurrency(unassignedCost)}</td>
                                        <td class="text-end">${totalExpenses > 0 ? (unassignedCost / totalExpenses * 100).toFixed(1) : 0}%</td>
                                    </tr>
                                    <tr class="table-primary">
                                        <td><strong>الإجمالي</strong></td>
                                        <td class="text-end"><strong>${formatCurrency(totalExpenses)}</strong></td>
                                        <td class="text-end"><strong>100%</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="abcChart"></canvas>
                    </div>
                </div>
            </div>
        `;

        const ctx = document.getElementById('abcChart')?.getContext('2d');
        if (ctx) {
            if (window.abcChartInstance) window.abcChartInstance.destroy();
            window.abcChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['الإنتاج', 'الصيانة', 'الإدارة', 'غير موزع'],
                    datasets: [{
                        data: [productionCost, maintenanceCost, adminCost, unassignedCost],
                        backgroundColor: ['#17a2b8', '#ffc107', '#dc3545', '#6c757d']
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: 'var(--color-text-primary)' } },
                        title: { display: true, text: 'توزيع التكاليف حسب الأنشطة', color: 'var(--color-text-primary)' }
                    }
                }
            });
        }
    };

    // --- 3. تشغيل كل شيء بالتسلسل الصحيح ---
    setTimeout(() => {
        const productionKeywords = ['تكلفة المبيعات', 'cogs', 'مواد مباشرة'];
        const maintenanceKeywords = ['صيانة', 'كهرباء', 'ديزل', 'وقود', 'زيوت', 'تشحيم', 'قطع غيار', 'فلاتر'];
        const adminKeywords = ['راتب', 'إداري', 'عمومي', 'تسويق', 'إيجار مكتب', 'أتعاب', 'بنكية'];

        expenseAccounts.forEach(acc => {
            const accName = acc.name.toLowerCase();
            let assigned = false;
            if (productionKeywords.some(kw => accName.includes(kw)) || acc.category === 'cogs') {
                document.querySelector(`#productionDrivers option[value="${acc.account_id}"]`).selected = true;
                assigned = true;
            }
            if (!assigned && maintenanceKeywords.some(kw => accName.includes(kw))) {
                document.querySelector(`#maintenanceDrivers option[value="${acc.account_id}"]`).selected = true;
                assigned = true;
            }
            if (!assigned && adminKeywords.some(kw => accName.includes(kw))) {
                document.querySelector(`#adminDrivers option[value="${acc.account_id}"]`).selected = true;
                assigned = true;
            }
        });

        document.querySelectorAll('.cost-driver-select').forEach(select => {
            select.addEventListener('change', calculateAndRender);
        });
        
        calculateAndRender(); // الحساب والعرض الأول
    }, 100);

    return initialHTML;
}
// ==================================================================
// --- END: مختبر توزيع التكاليف (V5) ---
// ==================================================================

// **الدالة الثانية: أصبحت الآن منفصلة ومستقلة**
function calculateABCCosting() {
    const resultsContainer = document.getElementById('abcResults');
    const data = getData();

    const getSelectedCosts = (selectId) => {
        const selectedOptions = Array.from(document.getElementById(selectId).selectedOptions);
        return selectedOptions.reduce((sum, option) => {
            const account = data.trialBalance.find(acc => acc.account_id === option.value);
            return sum + (account ? Math.abs(account.finalBalance) : 0);
        }, 0);
    };

    const productionCost = getSelectedCosts('productionDrivers');
    const maintenanceCost = getSelectedCosts('maintenanceDrivers');
    const adminCost = getSelectedCosts('adminDrivers');
    const totalAssignedCost = productionCost + maintenanceCost + adminCost;
    const totalExpenses = data.cogs + data.operatingExpenses;
    const unassignedCost = totalExpenses - totalAssignedCost;

    resultsContainer.innerHTML = `
        <div class="row">
            <div class="col-md-7">
                <div class="card bg-dark border-secondary">
                    <div class="card-header"><h5><i class="fas fa-calculator me-2"></i>نتائج التوزيع</h5></div>
                    <div class="card-body p-0">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>النشاط</th>
                                    <th class="text-end">التكلفة المخصصة</th>
                                    <th class="text-end">النسبة من الإجمالي</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><i class="fas fa-circle text-info me-2"></i>نشاط الإنتاج</td>
                                    <td class="text-end">${formatCurrency(productionCost)}</td>
                                    <td class="text-end">${totalExpenses > 0 ? (productionCost / totalExpenses * 100).toFixed(1) : 0}%</td>
                                </tr>
                                <tr>
                                    <td><i class="fas fa-circle text-warning me-2"></i>نشاط الصيانة والتشغيل</td>
                                    <td class="text-end">${formatCurrency(maintenanceCost)}</td>
                                    <td class="text-end">${totalExpenses > 0 ? (maintenanceCost / totalExpenses * 100).toFixed(1) : 0}%</td>
                                </tr>
                                <tr>
                                    <td><i class="fas fa-circle text-danger me-2"></i>نشاط الإدارة والبيع</td>
                                    <td class="text-end">${formatCurrency(adminCost)}</td>
                                    <td class="text-end">${totalExpenses > 0 ? (adminCost / totalExpenses * 100).toFixed(1) : 0}%</td>
                                </tr>
                                <tr class="table-secondary text-dark">
                                    <td><i class="fas fa-question-circle me-2"></i>تكاليف غير موزعة</td>
                                    <td class="text-end">${formatCurrency(unassignedCost)}</td>
                                    <td class="text-end">${totalExpenses > 0 ? (unassignedCost / totalExpenses * 100).toFixed(1) : 0}%</td>
                                </tr>
                                <tr class="table-primary">
                                    <td><strong>الإجمالي</strong></td>
                                    <td class="text-end"><strong>${formatCurrency(totalExpenses)}</strong></td>
                                    <td class="text-end"><strong>100%</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-5">
                <div class="chart-container" style="height: 400px;">
                    <canvas id="abcChart"></canvas>
                </div>
            </div>
        </div>
    `;

    const ctx = document.getElementById('abcChart')?.getContext('2d');
    if (ctx) {
        if (window.abcChartInstance) window.abcChartInstance.destroy();
        window.abcChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['الإنتاج', 'الصيانة', 'الإدارة', 'غير موزع'],
                datasets: [{
                    data: [productionCost, maintenanceCost, adminCost, unassignedCost],
                    backgroundColor: ['#17a2b8', '#ffc107', '#dc3545', '#6c757d']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top', labels: { color: 'var(--color-text-primary)' } },
                    title: { display: true, text: 'توزيع التكاليف حسب الأنشطة', color: 'var(--color-text-primary)' }
                }
            }
        });
    }
}
// ==================================================================
// --- END: مختبر توزيع التكاليف (ABC) (V4) ---
// ==================================================================
// ==================================================================
// --- END: دالة تحليل التكاليف ABC (V2) ---
// ==================================================================


        // ========== STRATEGY REPORTS ==========
// ==================================================================
// --- START: دالة تحليل نقطة التعادل (V3 - مختبر التسعير التفاعلي) ---
// ==================================================================
// ==================================================================
// --- START: الإصلاح النهائي لتقرير نقطة التعادل (V6.1) ---
// ==================================================================

// **الدالة الأولى: مسؤولة فقط عن بناء الواجهة**
function generateBreakevenAnalysis(data) {
    // هذا الكود يربط حقول الإدخال بالدالة الثانية
    setTimeout(() => {
        document.getElementById('blockPriceInput').addEventListener('input', calculateBreakEven);
        document.getElementById('concretePriceInput').addEventListener('input', calculateBreakEven);
        calculateBreakEven(); // الحساب الأولي
    }, 100);

    // هذا الكود يعرض الواجهة الفارغة في البداية
    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-flask"></i> مختبر التسعير ونقطة التعادل</h4>
            
            <div class="card bg-dark border-primary mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-tags me-2"></i>أدخل أسعار البيع المقترحة</h5>
                </div>
                <div class="p-3">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="blockPriceInput" class="form-label">سعر بيع البلوك (للوحدة)</label>
                            <input type="number" class="form-control" id="blockPriceInput" value="1.60" step="0.01">
                        </div>
                        <div class="col-md-6">
                            <label for="concretePriceInput" class="form-label">سعر بيع الخرسانة (للمتر المكعب)</label>
                            <input type="number" class="form-control" id="concretePriceInput" value="180" step="1">
                        </div>
                    </div>
                </div>
            </div>

            <div id="breakEvenResults">
                <div class="text-center p-5">
                    <div class="loading-spinner"></div>
                    <p class="mt-3">أدخل الأسعار لبدء التحليل...</p>
                </div>
            </div>
        </div>
    `;
}

// **الدالة الثانية: أصبحت الآن عامة ومنفصلة وتقوم بكل الحسابات**
function calculateBreakEven() {
    const resultsContainer = document.getElementById('breakEvenResults');
    const data = getData();

    // --- قراءة المدخلات ---
    const blockPrice = parseFloat(document.getElementById('blockPriceInput').value) || 0;
    const concretePrice = parseFloat(document.getElementById('concretePriceInput').value) || 0;

    // --- استخراج البيانات المالية ---
    const blockRevenue = Math.abs(data.categorized.revenue.find(acc => acc.name.toLowerCase().includes("بلوك"))?.finalBalance || 0);
    const concreteRevenue = Math.abs(data.categorized.revenue.find(acc => acc.name.toLowerCase().includes("خرسانة"))?.finalBalance || 0);
    const totalRevenue = blockRevenue + concreteRevenue;
    const fixedCosts = data.operatingExpenses + data.depreciationExpense;

    // --- فصل التكاليف المتغيرة ---
    const blockVariableCosts = data.categorized.cogs
        .filter(acc => acc.name.toLowerCase().includes('بلوك'))
        .reduce((sum, acc) => sum + acc.finalBalance, 0);
    const concreteVariableCosts = data.categorized.cogs
        .filter(acc => acc.name.toLowerCase().includes('خرسانة'))
        .reduce((sum, acc) => sum + acc.finalBalance, 0);
    const unassignedCogs = data.cogs - blockVariableCosts - concreteVariableCosts;
    const blockVariableCostsFinal = blockVariableCosts + (totalRevenue > 0 ? unassignedCogs * (blockRevenue / totalRevenue) : 0);
    const concreteVariableCostsFinal = concreteVariableCosts + (totalRevenue > 0 ? unassignedCogs * (concreteRevenue / totalRevenue) : 0);

    // --- حسابات البلوك ---
    const blockUnitsSold = blockPrice > 0 ? blockRevenue / blockPrice : 0;
    const blockVariableCostPerUnit = blockUnitsSold > 0 ? blockVariableCostsFinal / blockUnitsSold : 0;
    const blockContributionMarginPerUnit = blockPrice - blockVariableCostPerUnit;
    const blockFixedCostsShare = totalRevenue > 0 ? fixedCosts * (blockRevenue / totalRevenue) : 0;
    const blockBreakEvenUnits = blockContributionMarginPerUnit > 0 ? blockFixedCostsShare / blockContributionMarginPerUnit : 0;

    // --- حسابات الخرسانة ---
    const concreteUnitsSold = concretePrice > 0 ? concreteRevenue / concretePrice : 0;
    const concreteVariableCostPerUnit = concreteUnitsSold > 0 ? concreteVariableCostsFinal / concreteUnitsSold : 0;
    const concreteContributionMarginPerUnit = concretePrice - concreteVariableCostPerUnit;
    const concreteFixedCostsShare = totalRevenue > 0 ? fixedCosts * (concreteRevenue / totalRevenue) : 0;
    const concreteBreakEvenUnits = concreteContributionMarginPerUnit > 0 ? concreteFixedCostsShare / concreteContributionMarginPerUnit : 0;

    // --- بناء HTML التشخيصي ---
    resultsContainer.innerHTML = `
        <div class="row">
            <!-- لوحة التشخيص للبلوك -->
            <div class="col-md-6 mb-4">
                <div class="card bg-dark border-info h-100">
                    <div class="card-header"><h5><i class="fas fa-cubes me-2"></i>تشخيص البلوك</h5></div>
                    <div class="p-3">
                        <h6 class="text-info">1. المدخلات الأساسية</h6>
                        <table class="table table-sm table-borderless">
                            <tr><td>الإيرادات الفعلية</td><td class="text-end fw-bold">${formatCurrency(blockRevenue)}</td></tr>
                            <tr><td>التكاليف المتغيرة المخصصة</td><td class="text-end fw-bold">${formatCurrency(blockVariableCostsFinal)}</td></tr>
                            <tr><td>الكمية المباعة (محسوبة)</td><td class="text-end fw-bold">${Math.round(blockUnitsSold).toLocaleString('ar-SA')} وحدة</td></tr>
                        </table>
                        <hr>
                        <h6 class="text-info">2. الحسابات التحليلية</h6>
                        <table class="table table-sm table-borderless">
                            <tr><td>سعر البيع (المدخل)</td><td class="text-end fw-bold">${formatCurrency(blockPrice)}</td></tr>
                            <tr class="bg-danger bg-opacity-10"><td>التكلفة المتغيرة للوحدة (محسوبة)</td><td class="text-end fw-bold">${formatCurrency(blockVariableCostPerUnit)}</td></tr>
                            <tr class="table-primary"><td><strong>هامش المساهمة للوحدة</strong></td><td class="text-end fw-bold"><strong>${formatCurrency(blockContributionMarginPerUnit)}</strong></td></tr>
                        </table>
                        <hr>
                        <h6 class="text-info">3. نتيجة نقطة التعادل</h6>
                         <table class="table table-sm table-borderless">
                            <tr><td>نصيب المنتج من التكاليف الثابتة</td><td class="text-end fw-bold">${formatCurrency(blockFixedCostsShare)}</td></tr>
                            <tr class="table-warning"><td><strong>نقطة التعادل (وحدات)</strong></td><td class="text-end fw-bold"><strong>${Math.ceil(blockBreakEvenUnits).toLocaleString('ar-SA')} وحدة</strong></td></tr>
                        </table>
                    </div>
                </div>
            </div>

            <!-- لوحة التشخيص للخرسانة -->
            <div class="col-md-6 mb-4">
                <div class="card bg-dark border-secondary h-100">
                    <div class="card-header"><h5><i class="fas fa-truck-monster me-2"></i>تشخيص الخرسانة</h5></div>
                    <div class="p-3">
                        <h6 class="text-secondary">1. المدخلات الأساسية</h6>
                        <table class="table table-sm table-borderless">
                            <tr><td>الإيرادات الفعلية</td><td class="text-end fw-bold">${formatCurrency(concreteRevenue)}</td></tr>
                            <tr><td>التكاليف المتغيرة المخصصة</td><td class="text-end fw-bold">${formatCurrency(concreteVariableCostsFinal)}</td></tr>
                            <tr><td>الكمية المباعة (محسوبة)</td><td class="text-end fw-bold">${Math.round(concreteUnitsSold).toLocaleString('ar-SA')} م³</td></tr>
                        </table>
                        <hr>
                        <h6 class="text-secondary">2. الحسابات التحليلية</h6>
                        <table class="table table-sm table-borderless">
                            <tr><td>سعر البيع (المدخل)</td><td class="text-end fw-bold">${formatCurrency(concretePrice)}</td></tr>
                            <tr class="bg-danger bg-opacity-10"><td>التكلفة المتغيرة للوحدة (محسوبة)</td><td class="text-end fw-bold">${formatCurrency(concreteVariableCostPerUnit)}</td></tr>
                            <tr class="table-primary"><td><strong>هامش المساهمة للوحدة</strong></td><td class="text-end fw-bold"><strong>${formatCurrency(concreteContributionMarginPerUnit)}</strong></td></tr>
                        </table>
                        <hr>
                        <h6 class="text-secondary">3. نتيجة نقطة التعادل</h6>
                         <table class="table table-sm table-borderless">
                            <tr><td>نصيب المنتج من التكاليف الثابتة</td><td class="text-end fw-bold">${formatCurrency(concreteFixedCostsShare)}</td></tr>
                            <tr class="table-warning"><td><strong>نقطة التعادل (وحدات)</strong></td><td class="text-end fw-bold"><strong>${Math.ceil(concreteBreakEvenUnits).toLocaleString('ar-SA')} م³</strong></td></tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
}
// ==================================================================
// --- END: الإصلاح النهائي لتقرير نقطة التعادل ---
// ==================================================================

// ==================================================================
// --- START: دالة حساب نقطة التعادل (V7 - مع هدف المبيعات) ---
// ==================================================================
function calculateBreakEven() {
    const resultsContainer = document.getElementById('breakEvenResults');
    const data = getData();

    // --- قراءة المدخلات ---
    const blockPrice = parseFloat(document.getElementById('blockPriceInput').value) || 0;
    const concretePrice = parseFloat(document.getElementById('concretePriceInput').value) || 0;

    // --- استخراج البيانات المالية ---
    const blockRevenue = Math.abs(data.categorized.revenue.find(acc => acc.name.toLowerCase().includes("بلوك"))?.finalBalance || 0);
    const concreteRevenue = Math.abs(data.categorized.revenue.find(acc => acc.name.toLowerCase().includes("خرسانة"))?.finalBalance || 0);
    const totalRevenue = blockRevenue + concreteRevenue;
    const fixedCosts = data.operatingExpenses + data.depreciationExpense;

    // --- فصل التكاليف المتغيرة ---
    const blockVariableCosts = data.categorized.cogs
        .filter(acc => acc.name.toLowerCase().includes('بلوك'))
        .reduce((sum, acc) => sum + acc.finalBalance, 0);
    const concreteVariableCosts = data.categorized.cogs
        .filter(acc => acc.name.toLowerCase().includes('خرسانة'))
        .reduce((sum, acc) => sum + acc.finalBalance, 0);
    const unassignedCogs = data.cogs - blockVariableCosts - concreteVariableCosts;
    const blockVariableCostsFinal = blockVariableCosts + (totalRevenue > 0 ? unassignedCogs * (blockRevenue / totalRevenue) : 0);
    const concreteVariableCostsFinal = concreteVariableCosts + (totalRevenue > 0 ? unassignedCogs * (concreteRevenue / totalRevenue) : 0);

    // --- حسابات البلوك ---
    const blockUnitsSold = blockPrice > 0 ? blockRevenue / blockPrice : 0;
    const blockVariableCostPerUnit = blockUnitsSold > 0 ? blockVariableCostsFinal / blockUnitsSold : 0;
    const blockContributionMarginPerUnit = blockPrice - blockVariableCostPerUnit;
    const blockFixedCostsShare = totalRevenue > 0 ? fixedCosts * (blockRevenue / totalRevenue) : 0;
    const blockBreakEvenUnits = blockContributionMarginPerUnit > 0 ? blockFixedCostsShare / blockContributionMarginPerUnit : 0;
    const blockBreakEvenRevenue = blockBreakEvenUnits * blockPrice; // هدف المبيعات
    const blockSalesGap = blockBreakEvenRevenue - blockRevenue; // الفجوة

    // --- حسابات الخرسانة ---
    const concreteUnitsSold = concretePrice > 0 ? concreteRevenue / concretePrice : 0;
    const concreteVariableCostPerUnit = concreteUnitsSold > 0 ? concreteVariableCostsFinal / concreteUnitsSold : 0;
    const concreteContributionMarginPerUnit = concretePrice - concreteVariableCostPerUnit;
    const concreteFixedCostsShare = totalRevenue > 0 ? fixedCosts * (concreteRevenue / totalRevenue) : 0;
    const concreteBreakEvenUnits = concreteContributionMarginPerUnit > 0 ? concreteFixedCostsShare / concreteContributionMarginPerUnit : 0;
    const concreteBreakEvenRevenue = concreteBreakEvenUnits * concretePrice; // هدف المبيعات
    const concreteSalesGap = concreteBreakEvenRevenue - concreteRevenue; // الفجوة

    // --- الحسابات الإجمالية ---
    const totalContributionMargin = (blockContributionMarginPerUnit * blockUnitsSold) + (concreteContributionMarginPerUnit * concreteUnitsSold);
    const weightedAvgContributionMarginRatio = totalRevenue > 0 ? totalContributionMargin / totalRevenue : 0;
    const totalBreakEvenRevenue = weightedAvgContributionMarginRatio > 0 ? fixedCosts / weightedAvgContributionMarginRatio : 0;

    // --- بناء HTML التشخيصي الشفاف ---
    resultsContainer.innerHTML = `
        <div class="row">
            <!-- التحليل الإجمالي -->
            <div class="col-12 mb-4">
                <div class="card bg-dark border-success">
                    <div class="card-header"><h5><i class="fas fa-globe-americas me-2"></i>التحليل الإجمالي للشركة</h5></div>
                    <div class="p-3">
                        <div class="row">
                            <div class="col-md-4"><div class="stats-card"><h3>${formatCurrency(totalBreakEvenRevenue)}</h3><p>نقطة التعادل بالقيمة</p></div></div>
                            <div class="col-md-4"><div class="stats-card"><h3>${formatCurrency(totalRevenue - totalBreakEvenRevenue)}</h3><p>هامش الأمان بالقيمة</p></div></div>
                            <div class="col-md-4"><div class="stats-card"><h3>${(weightedAvgContributionMarginRatio * 100).toFixed(1)}%</h3><p>متوسط هامش المساهمة</p></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- تحليل البلوك -->
            <div class="col-md-6 mb-4">
                <div class="card bg-dark border-info h-100">
                    <div class="card-header"><h5><i class="fas fa-cubes me-2"></i>تشخيص البلوك</h5></div>
                    <div class="p-3">
                        <h6 class="text-info">1. المدخلات الأساسية</h6>
                        <table class="table table-sm table-borderless">
                            <tr><td>الإيرادات الفعلية</td><td class="text-end fw-bold">${formatCurrency(blockRevenue)}</td></tr>
                            <tr><td>التكاليف المتغيرة المخصصة</td><td class="text-end fw-bold">${formatCurrency(blockVariableCostsFinal)}</td></tr>
                        </table>
                        <hr>
                        <h6 class="text-info">2. الحسابات التحليلية</h6>
                        <table class="table table-sm table-borderless">
                            <tr><td>سعر البيع (المدخل)</td><td class="text-end fw-bold">${formatCurrency(blockPrice)}</td></tr>
                            <tr class="bg-danger bg-opacity-10"><td>التكلفة المتغيرة للوحدة (محسوبة)</td><td class="text-end fw-bold">${formatCurrency(blockVariableCostPerUnit)}</td></tr>
                            <tr class="table-primary"><td><strong>هامش المساهمة للوحدة</strong></td><td class="text-end fw-bold"><strong>${formatCurrency(blockContributionMarginPerUnit)}</strong></td></tr>
                        </table>
                        <hr>
                        <h6 class="text-info">3. نتيجة نقطة التعادل</h6>
                        <table class="table table-sm table-borderless">
                            <tr><td>نصيب المنتج من التكاليف الثابتة</td><td class="text-end fw-bold">${formatCurrency(blockFixedCostsShare)}</td></tr>
                            <tr class="table-warning"><td><strong>نقطة التعادل (وحدات)</strong></td><td class="text-end fw-bold"><strong>${Math.ceil(blockBreakEvenUnits).toLocaleString('ar-SA')} وحدة</strong></td></tr>
                        </table>
                        
                        <!-- **** الإضافة الجديدة هنا **** -->
                        <div class="alert alert-warning mt-3">
                            <h6 class="alert-heading"><i class="fas fa-bullseye me-2"></i>هدف المبيعات للتعادل</h6>
                            <p class="mb-1">للوصول لنقطة التعادل، تحتاج لتحقيق مبيعات بقيمة: <strong>${formatCurrency(blockBreakEvenRevenue)}</strong></p>
                            <hr>
                            <p class="mb-0">
                                ${blockSalesGap > 0 ? 
                                    `يتبقى لك تحقيق مبيعات إضافية بقيمة <strong>${formatCurrency(blockSalesGap)}</strong> للوصول للهدف.` :
                                    `لقد تجاوزت نقطة التعادل بمبلغ <strong>${formatCurrency(Math.abs(blockSalesGap))}</strong>. عمل رائع!`
                                }
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- تحليل الخرسانة -->
            <div class="col-md-6 mb-4">
                <div class="card bg-dark border-secondary h-100">
                    <div class="card-header"><h5><i class="fas fa-truck-monster me-2"></i>تشخيص الخرسانة</h5></div>
                    <div class="p-3">
                        <h6 class="text-secondary">1. المدخلات الأساسية</h6>
                        <table class="table table-sm table-borderless">
                            <tr><td>الإيرادات الفعلية</td><td class="text-end fw-bold">${formatCurrency(concreteRevenue)}</td></tr>
                            <tr><td>التكاليف المتغيرة المخصصة</td><td class="text-end fw-bold">${formatCurrency(concreteVariableCostsFinal)}</td></tr>
                        </table>
                        <hr>
                        <h6 class="text-secondary">2. الحسابات التحليلية</h6>
                        <table class="table table-sm table-borderless">
                            <tr><td>سعر البيع (المدخل)</td><td class="text-end fw-bold">${formatCurrency(concretePrice)}</td></tr>
                            <tr class="bg-danger bg-opacity-10"><td>التكلفة المتغيرة للوحدة (محسوبة)</td><td class="text-end fw-bold">${formatCurrency(concreteVariableCostPerUnit)}</td></tr>
                            <tr class="table-primary"><td><strong>هامش المساهمة للوحدة</strong></td><td class="text-end fw-bold"><strong>${formatCurrency(concreteContributionMarginPerUnit)}</strong></td></tr>
                        </table>
                        <hr>
                        <h6 class="text-secondary">3. نتيجة نقطة التعادل</h6>
                         <table class="table table-sm table-borderless">
                            <tr><td>نصيب المنتج من التكاليف الثابتة</td><td class="text-end fw-bold">${formatCurrency(concreteFixedCostsShare)}</td></tr>
                            <tr class="table-warning"><td><strong>نقطة التعادل (وحدات)</strong></td><td class="text-end fw-bold"><strong>${Math.ceil(concreteBreakEvenUnits).toLocaleString('ar-SA')} م³</strong></td></tr>
                        </table>

                        <!-- **** الإضافة الجديدة هنا **** -->
                        <div class="alert alert-warning mt-3">
                            <h6 class="alert-heading"><i class="fas fa-bullseye me-2"></i>هدف المبيعات للتعادل</h6>
                            <p class="mb-1">للوصول لنقطة التعادل، تحتاج لتحقيق مبيعات بقيمة: <strong>${formatCurrency(concreteBreakEvenRevenue)}</strong></p>
                            <hr>
                            <p class="mb-0">
                                ${concreteSalesGap > 0 ? 
                                    `يتبقى لك تحقيق مبيعات إضافية بقيمة <strong>${formatCurrency(concreteSalesGap)}</strong> للوصول للهدف.` :
                                    `لقد تجاوزت نقطة التعادل بمبلغ <strong>${formatCurrency(Math.abs(concreteSalesGap))}</strong>. عمل رائع!`
                                }
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}
// ==================================================================
// --- END: دالة حساب نقطة التعادل (V7) ---
// ==================================================================

/**
 * دالة فلترة التقارير حسب الجناح (ديوان المالية، الإدارة، إلخ)
 */
function filterWing(wingName, clickedButton) {
    const wings = document.querySelectorAll('.pantheon-wing');
    const filterBtns = document.querySelectorAll('.filter-btn');
    
    // تحديث الزر النشط
    filterBtns.forEach(btn => btn.classList.remove('active'));
    clickedButton.classList.add('active');
    
    // إظهار أو إخفاء الأجنحة بناءً على الاختيار
    wings.forEach(wing => {
        if (wingName === 'all' || wing.dataset.wing === wingName) {
            wing.style.display = 'block';
        } else {
            wing.style.display = 'none';
        }
    });
}

/**
 * دالة البحث في أسماء التقارير
 */
function searchReports() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const reportCards = document.querySelectorAll('.report-card');

    reportCards.forEach(card => {
        const reportTitle = card.querySelector('h6').textContent.toLowerCase();
        const reportDescription = card.querySelector('p').textContent.toLowerCase();

        if (reportTitle.includes(searchTerm) || reportDescription.includes(searchTerm)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

// ==================================================================
// --- END: دوال البحث والفلترة ---
// ==================================================================
// ==================================================================
// --- START: دالة تحليل ماذا لو (V2 - مختبر السيناريوهات التشغيلية) ---
// ==================================================================
function generateWhatIfScenarios(data) {
    // --- الخطوة 1: بناء الواجهة التفاعلية ---
    // نستخدم setTimeout لضمان أن الكود سيعمل بعد عرض الـ HTML
    setTimeout(() => {
        // ربط جميع حقول الإدخال بدالة إعادة الحساب
        document.querySelectorAll('#whatIfInputs input').forEach(input => {
            input.addEventListener('input', calculateWhatIfScenario);
        });
        // إجراء الحساب الأولي عند فتح التقرير
        calculateWhatIfScenario();
    }, 100);

    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-vial"></i> مختبر السيناريوهات التشغيلية</h4>
            
            <!-- 1. لوحة المدخلات التفاعلية -->
            <div id="whatIfInputs">
                <div class="row">
                    <!-- مدخلات الإيرادات -->
                    <div class="col-md-6 mb-4">
                        <div class="card bg-dark border-primary h-100">
                            <div class="card-header"><h5><i class="fas fa-dollar-sign me-2"></i>محركات الإيرادات</h5></div>
                            <div class="p-3">
                                <label class="form-label">تغيير الكمية المباعة للبلوك (%)</label>
                                <input type="range" class="form-range" id="blockQtyChange" value="0" min="-50" max="50" step="5">
                                <label class="form-label mt-3">تغيير سعر بيع الخرسانة (ريال)</label>
                                <input type="range" class="form-range" id="concretePriceChange" value="0" min="-50" max="50" step="5">
                            </div>
                        </div>
                    </div>
                    <!-- مدخلات التكاليف -->
                    <div class="col-md-6 mb-4">
                        <div class="card bg-dark border-danger h-100">
                            <div class="card-header"><h5><i class="fas fa-file-invoice-dollar me-2"></i>محركات التكاليف</h5></div>
                            <div class="p-3">
                                <label class="form-label">تغيير التكلفة المتغيرة للوحدة (%)</label>
                                <input type="range" class="form-range" id="vcUnitChange" value="0" min="-20" max="20" step="2">
                                <label class="form-label mt-3">تغيير التكاليف الثابتة الإجمالية (ريال)</label>
                                <input type="range" class="form-range" id="fixedCostChange" value="0" min="-100000" max="100000" step="10000">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. لوحة عرض النتائج (سيتم ملؤها بواسطة JavaScript) -->
            <div id="whatIfResults">
                <div class="text-center p-5">
                    <div class="loading-spinner"></div>
                    <p class="mt-3">حرّك المؤشرات لبدء محاكاة السيناريوهات...</p>
                </div>
            </div>
        </div>
    `;
}

/**
 * دالة ذكية: تقوم بإعادة حساب السيناريو بناءً على المدخلات الجديدة
 */
// ==================================================================
// --- START: دالة تحليل ماذا لو (V3 - لوحة المقارنة الاحترافية) ---
// ==================================================================
function calculateWhatIfScenario() {
    const resultsContainer = document.getElementById('whatIfResults');
    const data = getData();

    // --- 1. قراءة القيم الأساسية (الوضع الحالي) ---
    const baseBlockRevenue = Math.abs(data.categorized.revenue.find(acc => acc.name.toLowerCase().includes("بلوك"))?.finalBalance || 0);
    const baseConcreteRevenue = Math.abs(data.categorized.revenue.find(acc => acc.name.toLowerCase().includes("خرسانة"))?.finalBalance || 0);
    const baseTotalRevenue = baseBlockRevenue + baseConcreteRevenue;
    const baseTotalVC = data.cogs;
    const baseFixedCosts = data.operatingExpenses + data.depreciationExpense;
    const baseTotalCosts = baseTotalVC + baseFixedCosts;
    const baseNetProfit = baseTotalRevenue - baseTotalCosts;

    // --- 2. قراءة التغييرات من المؤشرات ---
    const blockQtyChange = parseFloat(document.getElementById('blockQtyChange').value) / 100;
    const concretePriceChange = parseFloat(document.getElementById('concretePriceChange').value);
    const vcUnitChange = parseFloat(document.getElementById('vcUnitChange').value) / 100;
    const fixedCostChange = parseFloat(document.getElementById('fixedCostChange').value);
    
    // تحديث العناوين بجانب المؤشرات
    document.getElementById('blockQtyLabel').textContent = `${(blockQtyChange * 100).toFixed(0)}%`;
    document.getElementById('concretePriceLabel').textContent = `${concretePriceChange >= 0 ? '+' : ''}${concretePriceChange} ريال`;
    document.getElementById('vcUnitLabel').textContent = `${(vcUnitChange * 100).toFixed(0)}%`;
    document.getElementById('fixedCostLabel').textContent = `${fixedCostChange >= 0 ? '+' : ''}${formatCurrency(fixedCostChange)}`;

    // --- 3. حساب القيم الجديدة للسيناريو ---
    const baseBlockPrice = 1.60;
    const baseConcretePrice = 180;
    const baseBlockUnits = baseBlockPrice > 0 ? baseBlockRevenue / baseBlockPrice : 0;
    const baseConcreteUnits = baseConcretePrice > 0 ? baseConcreteRevenue / baseConcretePrice : 0;
    const baseVCUnit_Block = baseBlockUnits > 0 ? (baseTotalVC * (baseBlockRevenue / baseTotalRevenue)) / baseBlockUnits : 0;
    const baseVCUnit_Concrete = baseConcreteUnits > 0 ? (baseTotalVC * (baseConcreteRevenue / baseTotalRevenue)) / baseConcreteUnits : 0;

    const newBlockUnits = baseBlockUnits * (1 + blockQtyChange);
    const newConcretePrice = baseConcretePrice + concretePriceChange;
    const newVCUnit_Block = baseVCUnit_Block * (1 + vcUnitChange);
    const newVCUnit_Concrete = baseVCUnit_Concrete * (1 + vcUnitChange);
    const newFixedCosts = baseFixedCosts + fixedCostChange;

    const newBlockRevenue = newBlockUnits * baseBlockPrice;
    const newConcreteRevenue = baseConcreteUnits * newConcretePrice;
    const newTotalRevenue = newBlockRevenue + newConcreteRevenue;
    const newTotalVC = (newBlockUnits * newVCUnit_Block) + (baseConcreteUnits * newVCUnit_Concrete);
    const newTotalCosts = newTotalVC + newFixedCosts;
    const newNetProfit = newTotalRevenue - newTotalCosts;

    // --- 4. بناء جدول المقارنة الاحترافي ---
    const createRow = (label, baseValue, newValue) => {
        const difference = newValue - baseValue;
        const percentage = baseValue !== 0 ? (difference / Math.abs(baseValue)) * 100 : (newValue !== 0 ? 100 : 0);
        const isGood = (label.includes('إيراد') || label.includes('ربح')) ? difference >= 0 : difference <= 0;
        const isBad = (label.includes('إيراد') || label.includes('ربح')) ? difference < 0 : difference > 0;
        
        return `
            <tr>
                <td>${label}</td>
                <td class="text-end">${formatCurrency(baseValue)}</td>
                <td class="text-end fw-bold">${formatCurrency(newValue)}</td>
                <td class="text-end ${isGood ? 'text-success' : isBad ? 'text-danger' : ''}">
                    ${difference >= 0 ? '+' : ''}${formatCurrency(difference)} 
                    <span class="small">(${(percentage).toFixed(1)}%)</span>
                </td>
            </tr>
        `;
    };

    resultsContainer.innerHTML = `
        <div class="card bg-dark border-primary">
            <div class="card-header"><h5><i class="fas fa-poll me-2"></i>نتائج السيناريو المقترح</h5></div>
            <div class="card-body p-0">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>البند</th>
                            <th class="text-end">الوضع الحالي</th>
                            <th class="text-end">السيناريو المقترح</th>
                            <th class="text-end">التأثير (التغير)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${createRow('إجمالي الإيرادات', baseTotalRevenue, newTotalRevenue)}
                        ${createRow('إجمالي التكاليف', baseTotalCosts, newTotalCosts)}
                        <tr class="table-primary">
                            ${createRow('<strong>صافي الربح</strong>', baseNetProfit, newNetProfit)}
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

// **الخطوة الثانية: تحديث دالة بناء الواجهة `generateWhatIfScenarios`**
// استبدل الدالة الحالية بهذه النسخة التي تضيف `<span>` لعرض القيم
function generateWhatIfScenarios(data) {
    setTimeout(() => {
        document.querySelectorAll('#whatIfInputs input').forEach(input => {
            input.addEventListener('input', calculateWhatIfScenario);
        });
        calculateWhatIfScenario();
    }, 100);

    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-vial"></i> مختبر السيناريوهات التشغيلية</h4>
            
            <div id="whatIfInputs">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card bg-dark border-primary h-100">
                            <div class="card-header"><h5><i class="fas fa-dollar-sign me-2"></i>محركات الإيرادات</h5></div>
                            <div class="p-3">
                                <label class="form-label">تغيير الكمية المباعة للبلوك: <span id="blockQtyLabel" class="badge bg-primary">0%</span></label>
                                <input type="range" class="form-range" id="blockQtyChange" value="0" min="-50" max="50" step="5">
                                
                                <label class="form-label mt-3">تغيير سعر بيع الخرسانة: <span id="concretePriceLabel" class="badge bg-primary">0 ريال</span></label>
                                <input type="range" class="form-range" id="concretePriceChange" value="0" min="-50" max="50" step="5">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card bg-dark border-danger h-100">
                            <div class="card-header"><h5><i class="fas fa-file-invoice-dollar me-2"></i>محركات التكاليف</h5></div>
                            <div class="p-3">
                                <label class="form-label">تغيير التكلفة المتغيرة للوحدة: <span id="vcUnitLabel" class="badge bg-danger">0%</span></label>
                                <input type="range" class="form-range" id="vcUnitChange" value="0" min="-20" max="20" step="2">
                                
                                <label class="form-label mt-3">تغيير التكاليف الثابتة الإجمالية: <span id="fixedCostLabel" class="badge bg-danger">0 ريال</span></label>
                                <input type="range" class="form-range" id="fixedCostChange" value="0" min="-100000" max="100000" step="10000">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="whatIfResults">
                <div class="text-center p-5">
                    <div class="loading-spinner"></div>
                    <p class="mt-3">حرّك المؤشرات لبدء محاكاة السيناريوهات...</p>
                </div>
            </div>
        </div>
    `;
}
// ==================================================================
// --- END: دالة تحليل ماذا لو (V3) ---
// ==================================================================
// ==================================================================
// --- END: دالة تحليل ماذا لو (V2) ---
// ==================================================================
// ==================================================================
// --- START: التقرير المتكامل (V4 - النسخة الكاملة والنظيفة) ---
// ==================================================================
function generateIntegratedReport(data) {
    // --- 1. حسابات مرتبطة بالبيانات الحقيقية ---
    const financialCapital = data.equity;
    const manufacturedCapital = data.fixedAssets;
    const salariesExpense = Math.abs(data.categorized.operatingExpenses
        .filter(acc => acc.name.toLowerCase().includes('راتب') || acc.name.toLowerCase().includes('أجور'))
        .reduce((sum, acc) => sum + acc.finalBalance, 0));
    const estimatedAvgSalary = 7000 * 12;
    const humanCapital = estimatedAvgSalary > 0 ? Math.round(salariesExpense / estimatedAvgSalary) : 0;
    const roe = data.equity > 0 ? (data.netIncome / data.equity * 100) : 0;
    const assetTurnover = data.assets > 0 ? (data.revenue / data.assets) : 0;

    // --- 2. بناء الواجهة بالبيانات الجديدة والكلاسات الصحيحة ---
    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-project-diagram me-2"></i>التقرير المتكامل (Integrated Report)</h4>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> التقرير المتكامل يعرض كيفية خلق القيمة عبر 6 رؤوس أموال رأسمالية.
            </div>

            <div class="row mb-4">
                <div class="col-md-4"><div class="stats-card border-primary"><i class="fas fa-coins fa-2x text-primary mb-2"></i><h6>رأس المال المالي</h6><h5>${formatCurrency(financialCapital)}</h5><p class="small mb-0">حقوق الملكية والموارد المالية</p></div></div>
                <div class="col-md-4"><div class="stats-card border-success"><i class="fas fa-industry fa-2x text-success mb-2"></i><h6>رأس المال الصناعي</h6><h5>${formatCurrency(manufacturedCapital)}</h5><p class="small mb-0">صافي الأصول الثابتة</p></div></div>
                <div class="col-md-4"><div class="stats-card border-info"><i class="fas fa-brain fa-2x text-info mb-2"></i><h6>رأس المال الفكري</h6><h5>(نوعي)</h5><p class="small mb-0">الابتكار والعلامة التجارية</p></div></div>
            </div>
            <div class="row mb-4">
                <div class="col-md-4"><div class="stats-card border-warning"><i class="fas fa-users fa-2x text-warning mb-2"></i><h6>رأس المال البشري</h6><h5>~${humanCapital} موظف</h5><p class="small mb-0">المهارات والخبرات (تقديري)</p></div></div>
                <div class="col-md-4"><div class="stats-card border-danger"><i class="fas fa-handshake fa-2x text-danger mb-2"></i><h6>رأس المال الاجتماعي</h6><h5>(نوعي)</h5><p class="small mb-0">العلاقات مع أصحاب المصلحة</p></div></div>
                <div class="col-md-4"><div class="stats-card border-success"><i class="fas fa-leaf fa-2x text-success mb-2"></i><h6>رأس المال الطبيعي</h6><h5>(نوعي)</h5><p class="small mb-0">الاستدامة والموارد البيئية</p></div></div>
            </div>

            <div class="accordion" id="capitalAccordion">
                <!-- رأس المال المالي -->
                <div class="accordion-item bg-dark">
                    <h2 class="accordion-header">
                        <button class="accordion-button bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#financial">
                            <i class="fas fa-coins text-primary me-2"></i> رأس المال المالي
                        </button>
                    </h2>
                    <div id="financial" class="accordion-collapse collapse show">
                        <div class="accordion-body">
                            <p class="text-light"><strong>المدخلات:</strong> حقوق الملكية ${formatCurrency(data.equity)}, قروض ${formatCurrency(data.liabilities)}</p>
                            <p class="text-light"><strong>الأنشطة:</strong> الاستثمار في الأصول، التمويل التشغيلي، إدارة المخاطر المالية.</p>
                            <p class="text-light"><strong>المخرجات:</strong> إيرادات ${formatCurrency(data.revenue)}, صافي ربح ${formatCurrency(data.netIncome)}.</p>
                            <p class="mb-0 text-light"><strong>النتائج (Outcome):</strong> عائد على حقوق الملكية (ROE) بنسبة <strong>${roe.toFixed(1)}%</strong>.</p>
                        </div>
                    </div>
                </div>
                <!-- رأس المال الصناعي -->
                <div class="accordion-item bg-dark">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#manufactured">
                            <i class="fas fa-industry text-success me-2"></i> رأس المال الصناعي
                        </button>
                    </h2>
                    <div id="manufactured" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <p class="text-light"><strong>المدخلات:</strong> أصول ثابتة ${formatCurrency(data.fixedAssets)}, استثمارات رأسمالية.</p>
                            <p class="text-light"><strong>الأنشطة:</strong> الإنتاج، الصيانة، التطوير والتحديث.</p>
                            <p class="text-light"><strong>المخرجات:</strong> طاقة إنتاجية عالية، كفاءة تشغيلية.</p>
                            <p class="mb-0 text-light"><strong>النتائج (Outcome):</strong> معدل دوران الأصول <strong>${assetTurnover.toFixed(2)}x</strong>.</p>
                        </div>
                    </div>
                </div>
                <!-- رأس المال الفكري -->
                <div class="accordion-item bg-dark">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#intellectual">
                            <i class="fas fa-brain text-info me-2"></i> رأس المال الفكري
                        </button>
                    </h2>
                    <div id="intellectual" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <p class="text-light"><strong>المدخلات:</strong> البحث والتطوير، براءات الاختراع، العلامة التجارية.</p>
                            <p class="text-light"><strong>الأنشطة:</strong> الابتكار، تطوير المنتجات، حماية الملكية الفكرية.</p>
                            <p class="text-light"><strong>المخرجات:</strong> منتجات جديدة، ميزة تنافسية.</p>
                            <p class="mb-0 text-light"><strong>النتائج (Outcome):</strong> حصة سوقية متنامية، ولاء العملاء.</p>
                        </div>
                    </div>
                </div>
                <!-- رأس المال البشري -->
                <div class="accordion-item bg-dark">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#human">
                            <i class="fas fa-users text-warning me-2"></i> رأس المال البشري
                        </button>
                    </h2>
                    <div id="human" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <p class="text-light"><strong>المدخلات:</strong> ~${humanCapital} موظف، برامج تدريب وتطوير.</p>
                            <p class="text-light"><strong>الأنشطة:</strong> التوظيف، التدريب، تطوير المهارات، الاحتفاظ بالمواهب.</p>
                            <p class="text-light"><strong>المخرجات:</strong> إنتاجية عالية، رضا الموظفين.</p>
                            <p class="mb-0 text-light"><strong>النتائج (Outcome):</strong> ثقافة مؤسسية قوية، معدل دوران منخفض.</p>
                        </div>
                    </div>
                </div>
                <!-- رأس المال الاجتماعي -->
                <div class="accordion-item bg-dark">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#social">
                            <i class="fas fa-handshake text-danger me-2"></i> رأس المال الاجتماعي
                        </button>
                    </h2>
                    <div id="social" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <p class="text-light"><strong>المدخلات:</strong> علاقات مع العملاء، الموردين، المجتمع.</p>
                            <p class="text-light"><strong>الأنشطة:</strong> المسؤولية الاجتماعية، الشراكات، التواصل.</p>
                            <p class="text-light"><strong>المخرجات:</strong> سمعة قوية، ثقة العملاء.</p>
                            <p class="mb-0 text-light"><strong>النتائج (Outcome):</strong> معدل احتفاظ بالعملاء مرتفع.</p>
                        </div>
                    </div>
                </div>
                <!-- رأس المال الطبيعي -->
                <div class="accordion-item bg-dark">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#natural">
                            <i class="fas fa-leaf text-success me-2"></i> رأس المال الطبيعي
                        </button>
                    </h2>
                    <div id="natural" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <p class="text-light"><strong>المدخلات:</strong> الموارد الطبيعية، الطاقة، المياه.</p>
                            <p class="text-light"><strong>الأنشطة:</strong> الإدارة البيئية، تقليل الانبعاثات، إعادة التدوير.</p>
                            <p class="text-light"><strong>المخرجات:</strong> انخفاض البصمة الكربونية.</p>
                            <p class="mb-0 text-light"><strong>النتائج (Outcome):</strong> امتثال بيئي كامل، شهادات الاستدامة.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}
// ==================================================================
// --- END: التقرير المتكامل (V4) ---
// ==================================================================

     // ==================================================================
// --- START: تقرير DCF (V2 - مختبر التقييم التفاعلي) ---
// ==================================================================
function generateDCFValuation(data) {
    // --- الخطوة 1: بناء الواجهة التفاعلية ---
    setTimeout(() => {
        document.querySelectorAll('#dcfInputs input').forEach(input => {
            input.addEventListener('input', calculateDCF);
        });
        calculateDCF(); // الحساب الأولي
    }, 100);

    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-calculator me-2"></i>مختبر تقييم التدفقات النقدية المخصومة (DCF)</h4>
            
            <!-- 1. لوحة المدخلات التفاعلية -->
            <div id="dcfInputs" class="card bg-dark border-primary mb-4">
                <div class="card-header"><h5><i class="fas fa-sliders-h me-2"></i>حدد افتراضات التقييم</h5></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">معدل نمو التدفقات (%): <span id="growthRateLabel" class="badge bg-primary">5%</span></label>
                            <input type="range" class="form-range" id="growthRateInput" value="5" min="0" max="15" step="0.5">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">تكلفة رأس المال (WACC %): <span id="waccLabel" class="badge bg-primary">10%</span></label>
                            <input type="range" class="form-range" id="waccInput" value="10" min="5" max="20" step="0.5">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">معدل النمو الدائم (%): <span id="terminalGrowthLabel" class="badge bg-primary">2%</span></label>
                            <input type="range" class="form-range" id="terminalGrowthInput" value="2" min="0" max="5" step="0.25">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. لوحة عرض النتائج -->
            <div id="dcfResults">
                <div class="text-center p-5"><div class="loading-spinner"></div><p class="mt-3">جاري حساب التقييم...</p></div>
            </div>
        </div>
    `;
}

/**
 * دالة ذكية: تقوم بإعادة حساب تقييم DCF بناءً على المدخلات الجديدة
 */
function calculateDCF() {
    const resultsContainer = document.getElementById('dcfResults');
    const data = getData();

    // --- 1. قراءة الافتراضات من المؤشرات ---
    const growthRate = parseFloat(document.getElementById('growthRateInput').value) / 100;
    const wacc = parseFloat(document.getElementById('waccInput').value) / 100;
    const terminalGrowthRate = parseFloat(document.getElementById('terminalGrowthInput').value) / 100;
    
    document.getElementById('growthRateLabel').textContent = `${(growthRate * 100).toFixed(1)}%`;
    document.getElementById('waccLabel').textContent = `${(wacc * 100).toFixed(1)}%`;
    document.getElementById('terminalGrowthLabel').textContent = `${(terminalGrowthRate * 100).toFixed(2)}%`;

    // --- 2. حسابات DCF ---
    const baseFcff = data.cashFlow; // التدفق النقدي الحر كنقطة انطلاق
    const projectionYears = 5;
    let presentValueSum = 0;
    let projections = [];

    for (let i = 1; i <= projectionYears; i++) {
        const fcf = baseFcff * Math.pow(1 + growthRate, i);
        const pv = fcf / Math.pow(1 + wacc, i);
        presentValueSum += pv;
        projections.push({ year: i, fcf, pv });
    }

    const lastYearFcf = projections[projectionYears - 1].fcf;
    const terminalValue = (lastYearFcf * (1 + terminalGrowthRate)) / (wacc - terminalGrowthRate);
    const pvTerminalValue = terminalValue / Math.pow(1 + wacc, projectionYears);
    
    const enterpriseValue = presentValueSum + pvTerminalValue;
    const netDebt = data.liabilities - (data.categorized.currentAssets.find(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'cash')?.finalBalance || 0);
    const equityValue = enterpriseValue - netDebt;

    // --- 3. بناء واجهة النتائج ---
    resultsContainer.innerHTML = `
        <div class="row">
            <div class="col-md-4"><div class="stats-card"><h3>${formatCurrency(enterpriseValue)}</h3><p>قيمة المنشأة (Enterprise Value)</p></div></div>
            <div class="col-md-4"><div class="stats-card"><h3>${formatCurrency(equityValue)}</h3><p>القيمة التقديرية لحقوق الملكية</p></div></div>
            <div class="col-md-4"><div class="stats-card"><h3>${(equityValue / data.equity).toFixed(2)}x</h3><p>مضاعف القيمة الدفترية (P/B)</p></div></div>
        </div>
        <div class="card bg-dark border-secondary mt-4">
            <div class="card-header"><h5><i class="fas fa-stream me-2"></i>تفاصيل التدفقات النقدية المتوقعة</h5></div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead class="table-dark">
                        <tr><th>السنة</th><th class="text-end">التدفق النقدي الحر (FCFF)</th><th class="text-end">القيمة الحالية (PV)</th></tr>
                    </thead>
                    <tbody>
                        ${projections.map(p => `<tr><td>السنة ${p.year}</td><td class="text-end">${formatCurrency(p.fcf)}</td><td class="text-end">${formatCurrency(p.pv)}</td></tr>`).join('')}
                        <tr class="table-info"><td><strong>القيمة النهائية (Terminal Value)</strong></td><td class="text-end">${formatCurrency(terminalValue)}</td><td class="text-end">${formatCurrency(pvTerminalValue)}</td></tr>
                        <tr class="table-primary"><td><strong>قيمة المنشأة الإجمالية</strong></td><td colspan="2" class="text-center fw-bold">${formatCurrency(enterpriseValue)}</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;
}
// ==================================================================
// --- END: تقرير DCF (V2) ---
// ==================================================================



  // ==================================================================
// --- START: تقرير RIM (V2 - مختبر التقييم التفاعلي) ---
// ==================================================================
function generateRIMValuation(data) {
    // --- الخطوة 1: بناء الواجهة التفاعلية ---
    setTimeout(() => {
        document.getElementById('costOfEquityInput').addEventListener('input', calculateRIM);
        calculateRIM(); // الحساب الأولي
    }, 100);

    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-money-bill-wave me-2"></i>مختبر تقييم الدخل المتبقي (RIM)</h4>
            
            <!-- 1. لوحة المدخلات التفاعلية -->
            <div id="rimInputs" class="card bg-dark border-primary mb-4">
                <div class="card-header"><h5><i class="fas fa-sliders-h me-2"></i>حدد افتراض التقييم</h5></div>
                <div class="card-body">
                    <label class="form-label">تكلفة حقوق الملكية (Cost of Equity %): <span id="costOfEquityLabel" class="badge bg-primary">12%</span></label>
                    <input type="range" class="form-range" id="costOfEquityInput" value="12" min="8" max="25" step="0.5">
                </div>
            </div>

            <!-- 2. لوحة عرض النتائج -->
            <div id="rimResults">
                <div class="text-center p-5"><div class="loading-spinner"></div><p class="mt-3">جاري حساب التقييم...</p></div>
            </div>
        </div>
    `;
}

/**
 * دالة ذكية: تقوم بإعادة حساب تقييم RIM بناءً على المدخلات الجديدة
 */
function calculateRIM() {
    const resultsContainer = document.getElementById('rimResults');
    const data = getData();

    // --- 1. قراءة الافتراضات من المؤشر ---
    const costOfEquity = parseFloat(document.getElementById('costOfEquityInput').value) / 100;
    document.getElementById('costOfEquityLabel').textContent = `${(costOfEquity * 100).toFixed(1)}%`;

    // --- 2. حسابات RIM بالبيانات الحقيقية ---
    const bookValue = data.equity;
    const netIncome = data.netIncome;
    const roe = bookValue > 0 ? (netIncome / bookValue) : 0;
    
    // الدخل المتبقي = صافي الربح - (حقوق الملكية * تكلفة حقوق الملكية)
    const residualIncome = netIncome - (bookValue * costOfEquity);
    
    // القيمة الحالية للدخل المتبقي (بافتراض استمراره للأبد)
    const pvResidualIncome = costOfEquity > 0 ? (residualIncome / costOfEquity) : 0;
    
    // قيمة حقوق الملكية = القيمة الدفترية + القيمة الحالية للدخل المتبقي
    const equityValue = bookValue + pvResidualIncome;

    // --- 3. بناء واجهة النتائج ---
    resultsContainer.innerHTML = `
        <div class="row">
            <div class="col-md-4"><div class="stats-card"><h3>${formatCurrency(bookValue)}</h3><p>القيمة الدفترية الحالية</p></div></div>
            <div class="col-md-4"><div class="stats-card"><h3>${formatCurrency(residualIncome)}</h3><p>الدخل المتبقي السنوي</p></div></div>
            <div class="col-md-4"><div class="stats-card"><h3>${formatCurrency(equityValue)}</h3><p>القيمة التقديرية لحقوق الملكية</p></div></div>
        </div>
        <div class="card bg-dark border-secondary mt-4">
            <div class="card-header"><h5><i class="fas fa-calculator me-2"></i>تفاصيل حساب التقييم</h5></div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead class="table-dark">
                        <tr><th>البيان</th><th class="text-end">القيمة</th><th>الوصف</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>القيمة الدفترية لحقوق الملكية (B₀)</td><td class="text-end">${formatCurrency(bookValue)}</td><td>القيمة الدفترية الحالية من المركز المالي.</td></tr>
                        <tr><td>العائد على حقوق الملكية (ROE)</td><td class="text-end">${(roe * 100).toFixed(1)}%</td><td>صافي الربح / حقوق الملكية.</td></tr>
                        <tr><td>تكلفة حقوق الملكية (r)</td><td class="text-end">${(costOfEquity * 100).toFixed(1)}%</td><td>العائد المطلوب من قبل المستثمرين (افتراض تفاعلي).</td></tr>
                        <tr class="table-info">
                            <td><strong>الدخل المتبقي (RI)</strong></td>
                            <td class="text-end"><strong>${formatCurrency(residualIncome)}</strong></td>
                            <td><strong>الربح الاقتصادي الذي يتجاوز توقعات المستثمرين.</strong></td>
                        </tr>
                        <tr class="table-primary">
                            <td><strong>القيمة التقديرية (V₀)</strong></td>
                            <td class="text-end"><strong>${formatCurrency(equityValue)}</strong></td>
                            <td><strong>القيمة الدفترية + القيمة الحالية للدخل المتبقي.</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;
}
// ==================================================================
// --- END: تقرير RIM (V2) ---
// ==================================================================


     // ==================================================================
// --- START: تقرير DDM (V2 - مختبر توزيعات الأرباح) ---
// ==================================================================
// ==================================================================
// --- START: تقرير DDM (V3 - مع إصلاح وضوح النصوص) ---
// ==================================================================
function generateDDMValuation(data) {
    // --- الخطوة 1: بناء الواجهة التفاعلية مع الكلاسات الصحيحة ---
    setTimeout(() => {
        document.querySelectorAll('#ddmInputs input').forEach(input => {
            input.addEventListener('input', calculateDDM);
        });
        calculateDDM(); // الحساب الأولي
    }, 100);

    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-percentage me-2"></i>مختبر نموذج خصم الأرباح (DDM)</h4>
            
            <div id="ddmInputs" class="card bg-dark border-primary mb-4">
                <div class="card-header"><h5><i class="fas fa-sliders-h me-2"></i>حدد افتراضات التقييم</h5></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <!-- *** الإصلاح هنا: إضافة كلاس form-label *** -->
                            <label class="form-label">نسبة توزيع الأرباح (%): <span id="payoutLabel" class="badge bg-primary">40%</span></label>
                            <input type="range" class="form-range" id="payoutInput" value="40" min="0" max="100" step="5">
                        </div>
                        <div class="col-md-4">
                            <!-- *** الإصلاح هنا: إضافة كلاس form-label *** -->
                            <label class="form-label">معدل نمو التوزيعات (%): <span id="growthRateDDMLabel" class="badge bg-primary">5%</span></label>
                            <input type="range" class="form-range" id="growthRateDDMInput" value="5" min="0" max="10" step="0.5">
                        </div>
                        <div class="col-md-4">
                            <!-- *** الإصلاح هنا: إضافة كلاس form-label *** -->
                            <label class="form-label">العائد المطلوب (%): <span id="requiredReturnLabel" class="badge bg-primary">12%</span></label>
                            <input type="range" class="form-range" id="requiredReturnInput" value="12" min="8" max="25" step="0.5">
                        </div>
                    </div>
                </div>
            </div>

            <div id="ddmResults">
                <div class="text-center p-5"><div class="loading-spinner"></div><p class="mt-3">جاري حساب التقييم...</p></div>
            </div>
        </div>
    `;
}

// دالة الحساب تبقى كما هي
function calculateDDM() {
    const resultsContainer = document.getElementById('ddmResults');
    const data = getData();

    const payoutRatio = parseFloat(document.getElementById('payoutInput').value) / 100;
    const growthRate = parseFloat(document.getElementById('growthRateDDMInput').value) / 100;
    const requiredReturn = parseFloat(document.getElementById('requiredReturnInput').value) / 100;
    
    document.getElementById('payoutLabel').textContent = `${(payoutRatio * 100).toFixed(0)}%`;
    document.getElementById('growthRateDDMLabel').textContent = `${(growthRate * 100).toFixed(1)}%`;
    document.getElementById('requiredReturnLabel').textContent = `${(requiredReturn * 100).toFixed(1)}%`;

    const netIncome = data.netIncome;
    const currentDividend = netIncome * payoutRatio;
    const nextYearDividend = currentDividend * (1 + growthRate);
    
    let equityValue = 0;
    let errorMessage = '';
    if (requiredReturn <= growthRate) {
        errorMessage = '<div class="alert alert-danger">خطأ: العائد المطلوب يجب أن يكون أكبر من معدل النمو.</div>';
    } else {
        equityValue = nextYearDividend / (requiredReturn - growthRate);
    }

    resultsContainer.innerHTML = `
        ${errorMessage}
        <div class="row">
            <div class="col-md-4"><div class="stats-card"><h3>${formatCurrency(currentDividend)}</h3><p>التوزيعات الحالية (D₀)</p></div></div>
            <div class="col-md-4"><div class="stats-card"><h3>${formatCurrency(nextYearDividend)}</h3><p>التوزيعات المتوقعة (D₁)</p></div></div>
            <div class="col-md-4"><div class="stats-card"><h3>${formatCurrency(equityValue)}</h3><p>القيمة التقديرية لحقوق الملكية</p></div></div>
        </div>
        <div class="card bg-dark border-secondary mt-4">
            <div class="card-header"><h5><i class="fas fa-calculator me-2"></i>تفاصيل حساب التقييم (نموذج Gordon للنمو)</h5></div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead class="table-dark">
                        <tr><th>البيان</th><th class="text-end">القيمة</th><th>الوصف</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>صافي الربح الحالي</td><td class="text-end">${formatCurrency(netIncome)}</td><td>من قائمة الدخل.</td></tr>
                        <tr><td>نسبة توزيع الأرباح</td><td class="text-end">${(payoutRatio * 100).toFixed(0)}%</td><td>النسبة المقترح توزيعها من الأرباح (افتراض تفاعلي).</td></tr>
                        <tr class="table-info"><td><strong>التوزيعات المتوقعة للسنة القادمة (D₁)</strong></td><td class="text-end"><strong>${formatCurrency(nextYearDividend)}</strong></td><td><strong>D₀ × (1 + g)</strong></td></tr>
                        <tr><td>العائد المطلوب (r)</td><td class="text-end">${(requiredReturn * 100).toFixed(1)}%</td><td>العائد الذي يتوقعه المستثمرون (افتراض تفاعلي).</td></tr>
                        <tr><td>معدل النمو (g)</td><td class="text-end">${(growthRate * 100).toFixed(1)}%</td><td>النمو المتوقع في التوزيعات (افتراض تفاعلي).</td></tr>
                        <tr class="table-primary"><td><strong>القيمة التقديرية (V₀)</strong></td><td class="text-end"><strong>${formatCurrency(equityValue)}</strong></td><td><strong>D₁ / (r - g)</strong></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;
}
// ==================================================================
// --- END: تقرير DDM (V3) ---
// ==================================================================

/**
 * دالة ذكية: تقوم بإعادة حساب تقييم DDM بناءً على المدخلات الجديدة
 */
function calculateDDM() {
    const resultsContainer = document.getElementById('ddmResults');
    const data = getData();

    // --- 1. قراءة الافتراضات من المؤشرات ---
    const payoutRatio = parseFloat(document.getElementById('payoutInput').value) / 100;
    const growthRate = parseFloat(document.getElementById('growthRateDDMInput').value) / 100;
    const requiredReturn = parseFloat(document.getElementById('requiredReturnInput').value) / 100;
    
    document.getElementById('payoutLabel').textContent = `${(payoutRatio * 100).toFixed(0)}%`;
    document.getElementById('growthRateDDMLabel').textContent = `${(growthRate * 100).toFixed(1)}%`;
    document.getElementById('requiredReturnLabel').textContent = `${(requiredReturn * 100).toFixed(1)}%`;

    // --- 2. حسابات DDM بالبيانات الحقيقية ---
    const netIncome = data.netIncome;
    const currentDividend = netIncome * payoutRatio;
    const nextYearDividend = currentDividend * (1 + growthRate);
    
    let equityValue = 0;
    let errorMessage = '';
    if (requiredReturn <= growthRate) {
        errorMessage = '<div class="alert alert-danger">خطأ: العائد المطلوب يجب أن يكون أكبر من معدل النمو.</div>';
    } else {
        equityValue = nextYearDividend / (requiredReturn - growthRate);
    }

    // --- 3. بناء واجهة النتائج ---
    resultsContainer.innerHTML = `
        ${errorMessage}
        <div class="row">
            <div class="col-md-4"><div class="stats-card"><h3>${formatCurrency(currentDividend)}</h3><p>التوزيعات الحالية (D₀)</p></div></div>
            <div class="col-md-4"><div class="stats-card"><h3>${formatCurrency(nextYearDividend)}</h3><p>التوزيعات المتوقعة (D₁)</p></div></div>
            <div class="col-md-4"><div class="stats-card"><h3>${formatCurrency(equityValue)}</h3><p>القيمة التقديرية لحقوق الملكية</p></div></div>
        </div>
        <div class="card bg-dark border-secondary mt-4">
            <div class="card-header"><h5><i class="fas fa-calculator me-2"></i>تفاصيل حساب التقييم (نموذج Gordon للنمو)</h5></div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead class="table-dark">
                        <tr><th>البيان</th><th class="text-end">القيمة</th><th>الوصف</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>صافي الربح الحالي</td><td class="text-end">${formatCurrency(netIncome)}</td><td>من قائمة الدخل.</td></tr>
                        <tr><td>نسبة توزيع الأرباح</td><td class="text-end">${(payoutRatio * 100).toFixed(0)}%</td><td>النسبة المقترح توزيعها من الأرباح (افتراض تفاعلي).</td></tr>
                        <tr class="table-info"><td><strong>التوزيعات المتوقعة للسنة القادمة (D₁)</strong></td><td class="text-end"><strong>${formatCurrency(nextYearDividend)}</strong></td><td><strong>D₀ × (1 + g)</strong></td></tr>
                        <tr><td>العائد المطلوب (r)</td><td class="text-end">${(requiredReturn * 100).toFixed(1)}%</td><td>العائد الذي يتوقعه المستثمرون (افتراض تفاعلي).</td></tr>
                        <tr><td>معدل النمو (g)</td><td class="text-end">${(growthRate * 100).toFixed(1)}%</td><td>النمو المتوقع في التوزيعات (افتراض تفاعلي).</td></tr>
                        <tr class="table-primary"><td><strong>القيمة التقديرية (V₀)</strong></td><td class="text-end"><strong>${formatCurrency(equityValue)}</strong></td><td><strong>D₁ / (r - g)</strong></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;
}
// ==================================================================
// --- END: تقرير DDM (V2) ---
// ==================================================================


// ==================================================================
// --- START: تقرير تحليل دوبونت (V2 - مركز القيادة التفاعلي) ---
// ==================================================================
// ==================================================================
// --- START: تقرير تحليل دوبونت (V3 - مع إصلاح وضوح الأرقام) ---
// ==================================================================
function generateDupontAnalysis(data) {
    // --- 1. حساب المكونات (لا تغيير هنا) ---
    const netIncome = data.netIncome;
    const revenue = data.revenue;
    const totalAssets = data.assets;
    const equity = data.equity;

    const profitMargin = revenue > 0 ? (netIncome / revenue) : 0;
    const assetTurnover = totalAssets > 0 ? (revenue / totalAssets) : 0;
    const equityMultiplier = equity > 0 ? (totalAssets / equity) : 0;
    const roe = profitMargin * assetTurnover * equityMultiplier;

    // --- 2. بناء الواجهة مع الكلاسات الصحيحة ---
    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-sitemap me-2"></i>مركز قيادة تحليل دوبونت (ROE)</h4>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> يقوم هذا التحليل بتفكيك <strong>العائد على حقوق الملكية (ROE)</strong> إلى محركاته الأساسية الثلاثة: الربحية، الكفاءة، والرافعة المالية.
            </div>

            <!-- بطاقة النتيجة النهائية -->
            <div class="row justify-content-center mb-4">
                <div class="col-md-6">
                    <div class="stats-card border-success">
                        <h6>العائد على حقوق الملكية (ROE)</h6>
                        <h2 class="text-success">${(roe * 100).toFixed(1)}%</h2>
                        <p>العائد الذي يحققه الملاك على كل ريال مستثمر</p>
                    </div>
                </div>
            </div>

            <!-- عرض المكونات الثلاثة مع إصلاح الألوان -->
            <div class="row text-center mb-3">
                <!-- الربحية -->
                <div class="col-md-4">
                    <div class="card bg-dark border-primary h-100">
                        <div class="card-body">
                            <h5 class="text-primary">الربحية</h5>
                            <!-- *** الإصلاح هنا: إضافة كلاس text-primary *** -->
                            <h3 class="display-6 fw-bold text-primary">${(profitMargin * 100).toFixed(1)}%</h3>
                            <p class="text-muted small">(هامش صافي الربح)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-center justify-content-center fs-2">×</div>
                <!-- الكفاءة -->
                <div class="col-md-4">
                    <div class="card bg-dark border-info h-100">
                        <div class="card-body">
                            <h5 class="text-info">الكفاءة</h5>
                            <!-- *** الإصلاح هنا: إضافة كلاس text-info *** -->
                            <h3 class="display-6 fw-bold text-info">${assetTurnover.toFixed(2)}x</h3>
                            <p class="text-muted small">(معدل دوران الأصول)</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row text-center mb-4">
                <div class="col-md-4 offset-md-4 d-flex align-items-center justify-content-center fs-2">×</div>
                <!-- الرافعة المالية -->
                <div class="col-md-4">
                    <div class="card bg-dark border-warning h-100">
                        <div class="card-body">
                            <h5 class="text-warning">الرافعة المالية</h5>
                            <!-- *** الإصلاح هنا: إضافة كلاس text-warning *** -->
                            <h3 class="display-6 fw-bold text-warning">${equityMultiplier.toFixed(2)}x</h3>
                            <p class="text-muted small">(مضاعف حقوق الملكية)</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- التحليل الذكي والتوصيات (لا تغيير هنا) -->
            <div class="card bg-dark border-secondary">
                <div class="card-header"><h5><i class="fas fa-lightbulb me-2"></i>التشخيص الذكي والتوصيات</h5></div>
                <div class="card-body">
                    <ul>
                        <li class="mb-2 text-light">
                            <strong>الربحية (${(profitMargin * 100).toFixed(1)}%):</strong> 
                            <span class="${profitMargin > 0.1 ? 'text-success' : 'text-danger'}">
                                ${profitMargin > 0.1 ? 'أداء جيد. يشير إلى تحكم فعال في التكاليف.' : 'أداء يحتاج تحسين. يجب مراجعة هيكل التسعير والتكاليف لزيادة الهوامش.'}
                            </span>
                        </li>
                        <li class="mb-2 text-light">
                            <strong>الكفاءة (${assetTurnover.toFixed(2)}x):</strong> 
                            <span class="${assetTurnover > 1 ? 'text-success' : 'text-danger'}">
                                ${assetTurnover > 1 ? 'كفاءة جيدة في استخدام الأصول لتوليد المبيعات.' : 'كفاءة منخفضة. يجب دراسة إمكانية التخلص من الأصول غير المنتجة أو زيادة المبيعات.'}
                            </span>
                        </li>
                        <li class="mb-2 text-light">
                            <strong>الرافعة المالية (${equityMultiplier.toFixed(2)}x):</strong> 
                            <span class="${equityMultiplier < 2.5 ? 'text-success' : 'text-warning'}">
                                ${equityMultiplier < 2.5 ? 'رافعة مالية معتدلة وآمنة.' : 'رافعة مالية مرتفعة. تزيد من العائد ولكنها تزيد من المخاطر المالية أيضًا.'}
                            </span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    `;
}
// ==================================================================
// --- END: تقرير تحليل دوبونت (V3) ---
// ==================================================================
// ==================================================================
// --- END: تقرير تحليل دوبونت (V2) ---
// ==================================================================

   // ==================================================================
// --- START: تقرير EVA (V3 - النسخة النهائية مع الشرح والتوضيح) ---
// ==================================================================
function generateEVAAnalysis(data) {
    // --- الخطوة 1: بناء الواجهة التفاعلية ---
    setTimeout(() => {
        document.getElementById('waccInput').addEventListener('input', calculateEVA);
        calculateEVA(); // الحساب الأولي
    }, 100);

    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-rocket me-2"></i>مختبر القيمة الاقتصادية المضافة (EVA)</h4>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>ما هي القيمة الاقتصادية المضافة (EVA)؟</strong> هي مقياس يقيس الربح الاقتصادي الحقيقي للشركة. إذا كانت النتيجة موجبة، فالشركة تخلق قيمة أعلى من تكلفة تمويلها. إذا كانت سالبة، فهي تدمر القيمة.
            </div>

            <!-- 1. لوحة المدخلات التفاعلية -->
            <div id="evaInputs" class="card bg-dark border-primary mb-4">
                <div class="card-header"><h5><i class="fas fa-sliders-h me-2"></i>حدد افتراض التقييم</h5></div>
                <div class="card-body">
                    <label class="form-label">المتوسط المرجح لتكلفة رأس المال (WACC %): <span id="waccLabel" class="badge bg-primary">10%</span></label>
                    <input type="range" class="form-range" id="waccInput" value="10" min="5" max="20" step="0.5">
                </div>
            </div>

            <!-- 2. لوحة عرض النتائج -->
            <div id="evaResults">
                <div class="text-center p-5"><div class="loading-spinner"></div><p class="mt-3">جاري حساب القيمة الاقتصادية...</p></div>
            </div>
        </div>
    `;
}

/**
 * دالة ذكية: تقوم بإعادة حساب EVA بناءً على المدخلات الجديدة
 */
function calculateEVA() {
    const resultsContainer = document.getElementById('evaResults');
    const data = getData();

    // --- 1. قراءة الافتراضات من المؤشر ---
    const wacc = parseFloat(document.getElementById('waccInput').value) / 100;
    document.getElementById('waccLabel').textContent = `${(wacc * 100).toFixed(1)}%`;

    // --- 2. حسابات EVA بالبيانات الحقيقية ---
    const operatingProfit = data.operatingProfit;
    const taxRate = 0.20; // نفترض ضريبة 20%
    const nopat = operatingProfit * (1 - taxRate);
    const investedCapital = data.equity + data.liabilities; // رأس المال المستثمر = إجمالي الأصول
    const capitalCharge = investedCapital * wacc;
    const eva = nopat - capitalCharge;

    // --- 3. بناء واجهة النتائج مع الشرح ---
    resultsContainer.innerHTML = `
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="stats-card">
                    <h3>${formatCurrency(nopat)}</h3>
                    <p>صافي الربح التشغيلي بعد الضريبة (NOPAT)</p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stats-card">
                    <h3>${formatCurrency(capitalCharge)}</h3>
                    <p>تكلفة رأس المال (Capital Charge)</p>
                </div>
            </div>
        </div>

        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header">
                <h5 class="mb-0">النتيجة النهائية: القيمة الاقتصادية المضافة (EVA)</h5>
            </div>
            <div class="card-body text-center">
                <h1 class="display-4 fw-bold ${eva >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(eva)}</h1>
                <p class="lead ${eva >= 0 ? 'text-success' : 'text-danger'}">
                    ${eva >= 0 ? 'الشركة تخلق قيمة للمساهمين' : 'الشركة تدمر القيمة للمساهمين'}
                </p>
            </div>
        </div>

        <div class="card bg-dark border-secondary">
            <div class="card-header"><h5><i class="fas fa-calculator me-2"></i>تفاصيل الحسابات</h5></div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead class="table-dark">
                        <tr><th>البيان</th><th class="text-end">القيمة</th><th>شرح المعادلة</th></tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>الربح التشغيلي (EBIT)</td>
                            <td class="text-end">${formatCurrency(operatingProfit)}</td>
                            <td>من قائمة الدخل (الإيرادات - تكلفة المبيعات - المصاريف التشغيلية)</td>
                        </tr>
                        <tr>
                            <td>صافي الربح التشغيلي بعد الضريبة (NOPAT)</td>
                            <td class="text-end">${formatCurrency(nopat)}</td>
                            <td>EBIT × (1 - معدل الضريبة)</td>
                        </tr>
                        <tr class="table-info">
                            <td><strong>رأس المال المستثمر</strong></td>
                            <td class="text-end"><strong>${formatCurrency(investedCapital)}</strong></td>
                            <td><strong>إجمالي الأصول (أو حقوق الملكية + إجمالي الالتزامات)</strong></td>
                        </tr>
                        <tr>
                            <td>تكلفة رأس المال (WACC)</td>
                            <td class="text-end">${(wacc * 100).toFixed(1)}%</td>
                            <td>العائد الذي يتوقعه الممولون (افتراض تفاعلي)</td>
                        </tr>
                        <tr class="table-danger">
                            <td><strong>(-) تكلفة رأس المال (Capital Charge)</strong></td>
                            <td class="text-end"><strong>(${formatCurrency(capitalCharge)})</strong></td>
                            <td><strong>رأس المال المستثمر × WACC</strong></td>
                        </tr>
                        <tr class="table-primary">
                            <td><strong>= القيمة الاقتصادية المضافة (EVA)</strong></td>
                            <td class="text-end"><strong>${formatCurrency(eva)}</strong></td>
                            <td><strong>NOPAT - Capital Charge</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;
}
// ==================================================================
// --- END: تقرير EVA (V3) ---
// ==================================================================

// ==================================================================
// --- START: ديوان الاستراتيجية (التقارير الجديدة) ---
// ==================================================================

/**
 * التقرير الاستراتيجي الأول: بطاقة الأداء المتوازن (BSC)
 * يربط الرؤية بالأهداف عبر 4 أبعاد رئيسية.
 */
function generateBalancedScorecard(data) {
    // بيانات افتراضية لبطاقة الأداء المتوازن
    const bscData = {
        financial: {
            title: 'البعد المالي',
            icon: 'fa-dollar-sign',
            color: 'success',
            objectives: [
                { name: 'زيادة الإيرادات بنسبة 15%', kpi: 'نمو الإيرادات', target: '15%', actual: '12%', status: 'warning' },
                { name: 'تحسين هامش الربح الصافي إلى 8%', kpi: 'هامش صافي الربح', target: '8%', actual: '5.5%', status: 'danger' }
            ]
        },
        customer: {
            title: 'بعد العملاء',
            icon: 'fa-users',
            color: 'primary',
            objectives: [
                { name: 'زيادة رضا العملاء إلى 90%', kpi: 'مؤشر رضا العملاء (CSAT)', target: '90%', actual: '92%', status: 'success' },
                { name: 'تقليل شكاوى العملاء بنسبة 20%', kpi: 'عدد الشكاوى الشهرية', target: '< 5', actual: '4', status: 'success' }
            ]
        },
        internal: {
            title: 'بعد العمليات الداخلية',
            icon: 'fa-cogs',
            color: 'info',
            objectives: [
                { name: 'تقليل وقت دورة الإنتاج إلى 3 أيام', kpi: 'متوسط وقت الدورة', target: '3 أيام', actual: '3.5 أيام', status: 'warning' },
                { name: 'أتمتة 50% من التقارير اليدوية', kpi: 'نسبة الأتمتة', target: '50%', actual: '25%', status: 'danger' }
            ]
        },
        learning: {
            title: 'بعد التعلم والنمو',
            icon: 'fa-graduation-cap',
            color: 'secondary',
            objectives: [
                { name: 'توفير 20 ساعة تدريبية لكل موظف سنويًا', kpi: 'متوسط ساعات التدريب', target: '20', actual: '22', status: 'success' },
                { name: 'زيادة نسبة الاحتفاظ بالموظفين إلى 95%', kpi: 'معدل الاحتفاظ بالموظفين', target: '95%', actual: '91%', status: 'warning' }
            ]
        }
    };

    let html = `<div class="p-4"><h4 class="mb-4"><i class="fas fa-th me-2"></i>بطاقة الأداء المتوازن (BSC)</h4>`;
    
    html += '<div class="row">';
    for (const perspective in bscData) {
        const pData = bscData[perspective];
        html += `
            <div class="col-lg-6 mb-4">
                <div class="card bg-dark border-${pData.color} h-100">
                    <div class="card-header bg-${pData.color} text-white">
                        <h5><i class="fas ${pData.icon} me-2"></i>${pData.title}</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm table-borderless">
                            <thead class="text-secondary"><tr><th>الهدف الاستراتيجي</th><th>المؤشر (KPI)</th><th>الهدف</th><th>الفعلي</th></tr></thead>
                            <tbody>
        `;
        pData.objectives.forEach(obj => {
            html += `
                <tr>
                    <td>${obj.name}</td>
                    <td>${obj.kpi}</td>
                    <td>${obj.target}</td>
                    <td><span class="badge bg-${obj.status}">${obj.actual}</span></td>
                </tr>
            `;
        });
        html += `</tbody></table></div></div></div>`;
    }
    html += '</div></div>';
    return html;
}

/**
 * التقرير الاستراتيجي الثاني: التحليل الرباعي (SWOT)
 * يحلل نقاط القوة والضعف والفرص والتهديدات.
 */
function generateSwotAnalysis(data) {
    const swotData = {
        strengths: ['سمعة جيدة في السوق المحلي', 'فريق عمل ذو خبرة', 'علاقات قوية مع الموردين'],
        weaknesses: ['الاعتماد على عدد قليل من العملاء الكبار', 'ضعف التواجد الرقمي والتسويق الإلكتروني', 'أنظمة يدوية في بعض الإدارات'],
        opportunities: ['إمكانية التوسع في مدن جديدة', 'زيادة الطلب على المنتجات الصديقة للبيئة', 'برامج الدعم الحكومي للمصانع'],
        threats: ['دخول منافسين جدد بأسعار أقل', 'ارتفاع أسعار المواد الخام عالميًا', 'تغيرات في قوانين العمل والعمالة']
    };

    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-search-plus me-2"></i>التحليل الاستراتيجي (SWOT)</h4>
            <div class="row">
                <!-- نقاط القوة -->
                <div class="col-md-6 mb-4">
                    <div class="card bg-dark border-success h-100">
                        <div class="card-header bg-success text-white"><h5><i class="fas fa-thumbs-up me-2"></i>نقاط القوة (Strengths)</h5></div>
                        <ul class="list-group list-group-flush">${swotData.strengths.map(item => `<li class="list-group-item bg-transparent text-light">${item}</li>`).join('')}</ul>
                    </div>
                </div>
                <!-- نقاط الضعف -->
                <div class="col-md-6 mb-4">
                    <div class="card bg-dark border-danger h-100">
                        <div class="card-header bg-danger text-white"><h5><i class="fas fa-thumbs-down me-2"></i>نقاط الضعف (Weaknesses)</h5></div>
                        <ul class="list-group list-group-flush">${swotData.weaknesses.map(item => `<li class="list-group-item bg-transparent text-light">${item}</li>`).join('')}</ul>
                    </div>
                </div>
                <!-- الفرص -->
                <div class="col-md-6 mb-4">
                    <div class="card bg-dark border-primary h-100">
                        <div class="card-header bg-primary text-white"><h5><i class="fas fa-lightbulb me-2"></i>الفرص (Opportunities)</h5></div>
                        <ul class="list-group list-group-flush">${swotData.opportunities.map(item => `<li class="list-group-item bg-transparent text-light">${item}</li>`).join('')}</ul>
                    </div>
                </div>
                <!-- التهديدات -->
                <div class="col-md-6 mb-4">
                    <div class="card bg-dark border-warning h-100">
                        <div class="card-header bg-warning text-dark"><h5><i class="fas fa-exclamation-triangle me-2"></i>التهديدات (Threats)</h5></div>
                        <ul class="list-group list-group-flush">${swotData.threats.map(item => `<li class="list-group-item bg-transparent text-light">${item}</li>`).join('')}</ul>
                    </div>
                </div>
            </div>
        </div>
    `;
}
// ==================================================================
// --- END: ديوان الاستراتيجية (التقارير الجديدة) ---
// ==================================================================


        // ========== RISK REPORTS ==========
  // ==================================================================
// --- START: تقرير Altman Z-Score (V2 - مرتبط بالبيانات الحقيقية) ---
// ==================================================================
// ==================================================================
// --- START: تقرير Altman Z-Score (V5 - غرفة العمليات الشفافة) ---
// ==================================================================
// ==================================================================
// --- START: تقرير Altman Z-Score (V6 - غرفة العمليات النهائية) ---
// ==================================================================
function generateAltmanZScore(data) {
    // --- الخطوة 1: بناء الواجهة التفاعلية أولاً ---
    setTimeout(() => {
        // ربط جميع حقول الإدخال بدالة إعادة الحساب
        document.querySelectorAll('#zScoreInputs input, #zScoreInputs select').forEach(input => {
            input.addEventListener('input', calculateZScore);
        });
        // إجراء الحساب الأولي عند فتح التقرير
        calculateZScore();
    }, 100);

    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-shield-alt me-2"></i>غرفة عمليات Z-Score</h4>
            
            <!-- 1. لوحة المدخلات التفاعلية -->
            <div id="zScoreInputs" class="card bg-dark border-primary mb-4">
                <div class="card-header"><h5><i class="fas fa-sliders-h me-2"></i>حدد افتراضات التقييم</h5></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">طريقة حساب القيمة السوقية:</label>
                            <select class="form-select" id="marketValueMethod">
                                <option value="dcf">تقييم DCF المبسط (الأكثر تحفظًا)</option>
                                <option value="pe" selected>مضاعف الربحية (P/E Ratio)</option>
                                <option value="pb">مضاعف القيمة الدفترية (P/B Ratio)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">أدخل المضاعف المستخدم:</label>
                            <input type="number" class="form-control" id="marketValueMultiplier" value="10" step="0.5">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. لوحة عرض النتائج -->
            <div id="zScoreResults">
                <div class="text-center p-5"><div class="loading-spinner"></div><p class="mt-3">جاري حساب Z-Score...</p></div>
            </div>
        </div>
    `;
}

/**
 * دالة ذكية: تقوم بإعادة حساب Z-Score بناءً على المدخلات الجديدة
 */
// ==================================================================
// --- START: دالة حساب Z-Score (V6.1 - مع معالجة الخسائر المتراكمة) ---
// ==================================================================
function calculateZScore() {
    const resultsContainer = document.getElementById('zScoreResults');
    const data = getData();

    // --- 1. قراءة الافتراضات من حقول الإدخال ---
    const marketValueMethod = document.getElementById('marketValueMethod').value;
    const multiplier = parseFloat(document.getElementById('marketValueMultiplier').value) || 1.0;

    // --- 2. حساب المتغيرات الأساسية ---
    const totalAssets = data.assets;
    const workingCapital = data.currentAssets - data.currentLiabilities;
    
    // **القراءة المباشرة من الحسابات المصنفة**
    const retainedEarningsValue = data.categorized.equity.find(acc => acc.sub_category === '330001')?.finalBalance || 0;
    
    const ebit = data.operatingProfit;
    
    // حساب القيمة السوقية بالطريقة المختارة
    let marketValueEquity = 0;
    if (marketValueMethod === 'pe') {
        marketValueEquity = data.netIncome * multiplier;
    } else if (marketValueMethod === 'pb') {
        marketValueEquity = data.equity * multiplier;
    } else { // dcf
        const fcff = data.cashFlow;
        const wacc = 0.12;
        const growthRate = 0.03;
        if (wacc > growthRate) {
            const terminalValue = (fcff * (1 + growthRate)) / (wacc - growthRate);
            marketValueEquity = terminalValue - data.liabilities;
        }
    }
    if (marketValueEquity <= 0) marketValueEquity = data.equity;

    const totalLiabilities = data.liabilities;
    const sales = data.revenue;
    
    // --- 3. حساب مكونات Z-Score مع المنطق الجديد ---
    const x1 = totalAssets > 0 ? workingCapital / totalAssets : 0;
    
    // **** الإصلاح الحاسم هنا ****
    // إذا كانت الأرباح المحتجزة سالبة، فإن مساهمتها صفر.
    const x2 = (totalAssets > 0 && retainedEarningsValue > 0) ? retainedEarningsValue / totalAssets : 0;
    
    const x3 = totalAssets > 0 ? ebit / totalAssets : 0;
    const x4 = totalLiabilities > 0 ? marketValueEquity / totalLiabilities : 0;
    const x5 = totalAssets > 0 ? sales / totalAssets : 0;
    
    const zScore = 1.2 * x1 + 1.4 * x2 + 3.3 * x3 + 0.6 * x4 + 1.0 * x5;
    
    // --- 4. تحديد الحالة والتوصيات (لا تغيير) ---
    let status, statusColor, statusIcon, recommendation;
    if (zScore > 2.99) {
        status = 'منطقة آمنة'; statusColor = 'success'; statusIcon = 'fa-shield-alt';
        recommendation = 'الشركة في وضع مالي قوي. استمر في المحافظة على السيولة والربحية.';
    } else if (zScore > 1.81) {
        status = 'منطقة رمادية'; statusColor = 'warning'; statusIcon = 'fa-exclamation-triangle';
        recommendation = 'الوضع يتطلب مراقبة. ركز على تحسين الربحية وإدارة رأس المال العامل.';
    } else {
        status = 'منطقة خطر'; statusColor = 'danger'; statusIcon = 'fa-skull-crossbones';
        recommendation = 'احتمالية التعثر مرتفعة. يجب اتخاذ إجراءات فورية.';
    }
    
    // --- 5. بناء الواجهة الشفافة (لا تغيير) ---
    resultsContainer.innerHTML = `
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="stats-card border-${statusColor}">
                    <div class="row align-items-center">
                        <div class="col-md-4 text-center"><i class="fas ${statusIcon} fa-4x text-${statusColor}"></i></div>
                        <div class="col-md-8">
                            <h6 class="text-light">Z-Score</h6>
                            <h2 class="text-${statusColor}">${zScore.toFixed(2)}</h2>
                            <h5 class="text-${statusColor}">${status}</h5>
                            <p class="mb-0 text-light">${recommendation}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header"><h5><i class="fas fa-database me-2"></i>البيانات الفعلية المستخدمة</h5></div>
            <div class="card-body p-0">
                <table class="table table-sm table-hover mb-0">
                    <thead class="table-dark"><tr><th>البيان</th><th class="text-end">القيمة</th></tr></thead>
                    <tbody>
                        <tr><td>رأس المال العامل</td><td class="text-end">${formatCurrency(workingCapital)}</td></tr>
                        <tr><td>إجمالي الأصول</td><td class="text-end">${formatCurrency(totalAssets)}</td></tr>
                        <tr><td>الأرباح المحتجزة</td><td class="text-end">${formatCurrency(retainedEarningsValue)}</td></tr>
                        <tr><td>الربح التشغيلي (EBIT)</td><td class="text-end">${formatCurrency(ebit)}</td></tr>
                        <tr><td>القيمة السوقية لحقوق الملكية (محسوبة)</td><td class="text-end">${formatCurrency(marketValueEquity)}</td></tr>
                        <tr><td>إجمالي الالتزامات</td><td class="text-end">${formatCurrency(totalLiabilities)}</td></tr>
                        <tr><td>المبيعات</td><td class="text-end">${formatCurrency(sales)}</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card bg-dark border-secondary">
            <div class="card-header"><h5><i class="fas fa-calculator me-2"></i>تفاصيل معادلة Z-Score</h5></div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead class="table-dark"><tr><th>المتغير</th><th>المعادلة</th><th class="text-end">النتيجة</th><th class="text-end">الوزن</th><th class="text-end">المساهمة</th></tr></thead>
                    <tbody>
                        <tr><td><strong>X₁</strong></td><td>رأس المال العامل / إجمالي الأصول</td><td class="text-end">${x1.toFixed(3)}</td><td class="text-end">1.2</td><td class="text-end">${(1.2 * x1).toFixed(3)}</td></tr>
                        <tr><td><strong>X₂</strong></td><td>الأرباح المحتجزة / إجمالي الأصول</td><td class="text-end">${x2.toFixed(3)}</td><td class="text-end">1.4</td><td class="text-end">${(1.4 * x2).toFixed(3)}</td></tr>
                        <tr><td><strong>X₃</strong></td><td>EBIT / إجمالي الأصول</td><td class="text-end">${x3.toFixed(3)}</td><td class="text-end">3.3</td><td class="text-end">${(3.3 * x3).toFixed(3)}</td></tr>
                        <tr><td><strong>X₄</strong></td><td>القيمة السوقية / إجمالي الخصوم</td><td class="text-end">${x4.toFixed(3)}</td><td class="text-end">0.6</td><td class="text-end">${(0.6 * x4).toFixed(3)}</td></tr>
                        <tr><td><strong>X₅</strong></td><td>المبيعات / إجمالي الأصول</td><td class="text-end">${x5.toFixed(3)}</td><td class="text-end">1.0</td><td class="text-end">${(1.0 * x5).toFixed(3)}</td></tr>
                        <tr class="table-primary">
                            <td colspan="4"><strong>النتيجة النهائية (Z-Score)</strong></td>
                            <td class="text-end"><strong>${zScore.toFixed(2)}</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;
}
// ==================================================================
// --- END: دالة حساب Z-Score (V6.1) ---
// ==================================================================
// ==================================================================
// --- END: تقرير Altman Z-Score (V6) ---
// ==================================================================
// ==================================================================
// --- START: الدالة المساعدة المفقودة لحساب DCF ---
// ==================================================================
function calculateDCFValue(data) {
    try {
        const fcff = data.cashFlow;
        const wacc = 0.12; // متوسط تكلفة رأس المال
        const growthRate = 0.03; // معدل نمو دائم

        // التحقق من أن المقام لن يكون صفرًا أو سالبًا
        if (wacc <= growthRate) {
            console.warn("DCF calculation skipped: WACC is not greater than growth rate.");
            return 0;
        }

        const terminalValue = (fcff * (1 + growthRate)) / (wacc - growthRate);
        
        // القيمة السوقية لحقوق الملكية = قيمة الشركة - إجمالي الديون
        const equityValue = terminalValue - data.liabilities;
        
        return equityValue;

    } catch (error) {
        console.error("Error in calculateDCFValue:", error);
        return 0; // إرجاع صفر في حالة حدوث أي خطأ
    }
}
// ==================================================================
// --- END: الدالة المساعدة المفقودة ---
// ==================================================================

// ==================================================================
// --- END: تقرير Altman Z-Score (V5) ---
// ==================================================================
// ==================================================================
// --- END: تقرير Altman Z-Score (V2) ---
// ==================================================================

// ==================================================================
// --- START: تقرير Ohlson O-Score (V2 - غرفة العمليات الشفافة) ---
// ==================================================================
// ==================================================================
// --- START: تقرير Ohlson O-Score (V3.1 - مع الشرح والتقييم) ---
// ==================================================================
function generateOhlsonOScore(data) {
    // --- 1. حساب المتغيرات الأساسية (لا تغيير) ---
    const totalAssets = data.assets;
    const totalLiabilities = data.liabilities;
    const netIncome = data.netIncome;
    const workingCapital = data.currentAssets - data.currentLiabilities;
    const currentAssets = data.currentAssets;
    const currentLiabilities = data.currentLiabilities;
    const cashFlowFromOps = data.cashFlow;
    const priorNetIncome = data.priorNetIncome || 0;

    // --- 2. حساب مكونات O-Score (لا تغيير) ---
    const SIZE = Math.log(totalAssets / 1000000);
    const TLTA = totalAssets > 0 ? totalLiabilities / totalAssets : 0;
    const WCTA = totalAssets > 0 ? workingCapital / totalAssets : 0;
    const CLCA = currentAssets > 0 ? currentLiabilities / currentAssets : 0;
    const NITA = totalAssets > 0 ? netIncome / totalAssets : 0;
    const FUTL = totalLiabilities > 0 ? cashFlowFromOps / totalLiabilities : 0;
    const INTWO = (netIncome < 0 && priorNetIncome < 0) ? 1 : 0;
    const CHIN = (netIncome - priorNetIncome) / (Math.abs(netIncome) + Math.abs(priorNetIncome) || 1);

    const oScore = -1.32 - (0.407 * SIZE) + (6.03 * TLTA) - (1.43 * WCTA) + (0.076 * CLCA) - (1.72 * INTWO) - (2.37 * NITA) - (1.83 * FUTL) + (0.285 * CHIN) - 0.521;
    const probability = 1 / (1 + Math.exp(-oScore));
    const probabilityPct = (probability * 100).toFixed(1);

    // --- 3. تحديد الحالة والتوصيات (لا تغيير) ---
    let status, statusColor, recommendation;
    if (probability < 30) {
        status = 'خطر منخفض'; statusColor = 'success';
        recommendation = 'احتمالية التعثر منخفضة بناءً على هذا النموذج. الوضع المالي يبدو مستقرًا.';
    } else if (probability < 60) {
        status = 'خطر متوسط'; statusColor = 'warning';
        recommendation = 'هناك بعض المؤشرات التي تتطلب الانتباه. يُنصح بمراقبة السيولة والربحية.';
    } else {
        status = 'خطر مرتفع'; statusColor = 'danger';
        recommendation = 'النموذج يشير إلى احتمالية تعثر مرتفعة. يجب مراجعة هيكل الديون والتدفقات النقدية بشكل عاجل.';
    }

    // --- 4. بناء الواجهة التفاعلية مع الشروحات ---
    const createRow = (variable, description, value, interpretation) => {
        return `
            <tr>
                <td>${variable}</td>
                <td>
                    ${description}
                    <i class="fas fa-info-circle text-secondary ms-2" data-bs-toggle="tooltip" title="${interpretation.tooltip}"></i>
                </td>
                <td class="text-end">${value.toFixed(3)}</td>
                <td class="text-center"><span class="badge bg-${interpretation.color}">${interpretation.text}</span></td>
            </tr>
        `;
    };

    const interpretations = {
        SIZE: { tooltip: 'يقيس حجم الشركة. الشركات الأكبر أكثر استقرارًا.', color: 'info', text: 'معلومة' },
        TLTA: { tooltip: 'نسبة المديونية. كلما انخفضت، كان أفضل.', ...(TLTA < 0.4 ? {color: 'success', text: 'ممتاز'} : TLTA < 0.7 ? {color: 'warning', text: 'مقبول'} : {color: 'danger', text: 'مرتفع'}) },
        WCTA: { tooltip: 'كفاءة السيولة. كلما ارتفعت، كان أفضل.', ...(WCTA > 0.2 ? {color: 'success', text: 'ممتاز'} : WCTA > 0 ? {color: 'warning', text: 'مقبول'} : {color: 'danger', text: 'سلبي'}) },
        CLCA: { tooltip: 'ضغط السيولة الفوري. كلما انخفضت، كان أفضل.', ...(CLCA < 1 ? {color: 'success', text: 'ممتاز'} : {color: 'danger', text: 'مرتفع'}) },
        NITA: { tooltip: 'ربحية الأصول. كلما ارتفعت، كان أفضل.', ...(NITA > 0.05 ? {color: 'success', text: 'جيد'} : NITA > 0 ? {color: 'warning', text: 'ضعيف'} : {color: 'danger', text: 'سلبي'}) },
        FUTL: { tooltip: 'قوة التدفق النقدي. كلما ارتفعت، كان أفضل.', ...(FUTL > 0.5 ? {color: 'success', text: 'قوي'} : FUTL > 0 ? {color: 'warning', text: 'مقبول'} : {color: 'danger', text: 'سلبي'}) },
        INTWO: { tooltip: 'استمرارية الخسائر. القيمة 0 هي الأفضل.', ...(INTWO === 0 ? {color: 'success', text: 'جيد'} : {color: 'danger', text: 'خطر'}) },
        CHIN: { tooltip: 'صدمة الأرباح. القيمة الموجبة أفضل.', ...(CHIN > 0 ? {color: 'success', text: 'تحسن'} : {color: 'danger', text: 'تدهور'}) }
    };

    // --- 5. بناء HTML النهائي ---
    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-chart-line me-2"></i>غرفة عمليات O-Score</h4>
            
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="stats-card border-${statusColor}">
                        <h6>O-Score</h6>
                        <h3 class="text-${statusColor}">${oScore.toFixed(3)}</h3>
                        <p>النتيجة الخام للنموذج</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stats-card border-${statusColor}">
                        <h6>احتمالية التعثر</h6>
                        <h3 class="text-${statusColor}">${probabilityPct}%</h3>
                        <p>${status}</p>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-${statusColor}"><p class="mb-0">${recommendation}</p></div>

            <div class="card bg-dark border-secondary mt-4">
                <div class="card-header"><h5><i class="fas fa-calculator me-2"></i>تفاصيل حساب O-Score</h5></div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr><th>المتغير</th><th>الوصف</th><th class="text-end">القيمة</th><th class="text-center">التقييم</th></tr>
                        </thead>
                        <tbody>
                            ${createRow('SIZE', 'حجم الشركة', SIZE, interpretations.SIZE)}
                            ${createRow('TLTA', 'نسبة المديونية', TLTA, interpretations.TLTA)}
                            ${createRow('WCTA', 'كفاءة السيولة', WCTA, interpretations.WCTA)}
                            ${createRow('CLCA', 'ضغط السيولة الفوري', CLCA, interpretations.CLCA)}
                            ${createRow('NITA', 'ربحية الأصول', NITA, interpretations.NITA)}
                            ${createRow('FUTL', 'قوة التدفق النقدي', FUTL, interpretations.FUTL)}
                            ${createRow('INTWO', 'استمرارية الخسائر', INTWO, interpretations.INTWO)}
                            ${createRow('CHIN', 'صدمة الأرباح', CHIN, interpretations.CHIN)}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}
// ==================================================================
// --- END: تقرير Ohlson O-Score (V3.1) ---
// ==================================================================
// ==================================================================
// --- END: تقرير Ohlson O-Score (V2) ---
// ==================================================================

        // Simplified versions of remaining risk models
     // ==================================================================
// --- START: تقرير Zmijewski X-Score (النسخة المطورة) ---
// ==================================================================
function generateZmijewskiXScore(data) {
    // --- 1. استخراج البيانات الأساسية ---
    const netIncome = data.netIncome;
    const totalAssets = data.assets;
    const totalLiabilities = data.liabilities;
    const currentAssets = data.currentAssets;
    const currentLiabilities = data.currentLiabilities;

    // --- 2. حساب متغيرات النموذج (X1, X2, X3) ---
    // X1: العائد على الأصول (مؤشر الربحية)
    const x1_ROA = totalAssets > 0 ? netIncome / totalAssets : 0;
    // X2: الرافعة المالية (مؤشر المديونية)
    const x2_Leverage = totalAssets > 0 ? totalLiabilities / totalAssets : 0;
    // X3: النسبة الحالية (مؤشر السيولة)
    const x3_CurrentRatio = currentLiabilities > 0 ? currentAssets / currentLiabilities : 0;

    // --- 3. حساب النتيجة النهائية (X-Score) والاحتمالية ---
    const xScore = -4.336 + (4.513 * x1_ROA) - (5.679 * x2_Leverage) + (0.004 * x3_CurrentRatio);
    // ملاحظة: لقد قمت بتصحيح إشارات المعادلة بناءً على الورقة البحثية الأصلية لزيميخوسكي
    // الربحية (x1) تقلل الخطر (إشارة موجبة)، والمديونية (x2) تزيد الخطر (إشارة سالبة).
    // الكود الأصلي كان يحتوي على إشارات معكوسة.
    
    const probability = 1 / (1 + Math.exp(-xScore));
    const probabilityPct = (probability * 100).toFixed(1);

    // --- 4. تحديد الحالة والتوصية ---
    let status, statusColor, recommendation;
    // نموذج زيميخوسكي يعتبر أن أي احتمالية فوق 50% هي علامة خطر
    if (probability < 0.5) {
        status = 'خطر منخفض'; statusColor = 'success';
        recommendation = 'الشركة في وضع مالي مستقر وفقًا لهذا النموذج. هيكل الربحية والسيولة والديون يبدو متوازنًا.';
    } else {
        status = 'خطر مرتفع'; statusColor = 'danger';
        recommendation = 'النموذج يشير إلى وجود ضغط مالي. يجب مراجعة هيكل الديون والربحية بشكل فوري.';
    }

    // --- 5. بناء الواجهة الاحترافية ---
    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-x-ray me-2"></i>غرفة عمليات X-Score (زيميخوسكي)</h4>
            <div class="alert alert-info">نموذج Probit قوي، يركز على 3 عوامل رئيسية: الربحية (ROA)، الرافعة المالية (Leverage)، والسيولة (Current Ratio).</div>
            
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="stats-card border-${statusColor}">
                        <h6>X-Score</h6>
                        <h3 class="text-${statusColor}">${xScore.toFixed(3)}</h3>
                        <p>النتيجة الخام للنموذج</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stats-card border-${statusColor}">
                        <h6>احتمالية التعثر</h6>
                        <h3 class="text-${statusColor}">${probabilityPct}%</h3>
                        <p>${status}</p>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-${statusColor}">
                <h6 class="alert-heading">التشخيص والتوصية</h6>
                <p class="mb-0">${recommendation}</p>
            </div>

            <div class="card bg-dark border-secondary mt-4">
                <div class="card-header"><h5><i class="fas fa-calculator me-2"></i>تفاصيل حساب المتغيرات</h5></div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr><th>المتغير</th><th>الوصف</th><th>المعادلة</th><th class="text-end">النتيجة</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>X1</strong></td>
                                <td>الربحية</td>
                                <td>صافي الربح / إجمالي الأصول</td>
                                <td class="text-end">${x1_ROA.toFixed(3)}</td>
                            </tr>
                            <tr>
                                <td><strong>X2</strong></td>
                                <td>المديونية</td>
                                <td>إجمالي الالتزامات / إجمالي الأصول</td>
                                <td class="text-end">${x2_Leverage.toFixed(3)}</td>
                            </tr>
                            <tr>
                                <td><strong>X3</strong></td>
                                <td>السيولة</td>
                                <td>الأصول المتداولة / الالتزامات المتداولة</td>
                                <td class="text-end">${x3_CurrentRatio.toFixed(3)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}
// ==================================================================
// --- END: تقرير Zmijewski X-Score (النسخة المطورة) ---
// ==================================================================


       // ==================================================================
// --- START: تقرير Sherrod Model (النسخة المطورة) ---
// ==================================================================
// ==================================================================
// --- START: تقرير Sherrod Model (النسخة المحدثة والمضمونة) ---
// ==================================================================
// ==================================================================
// --- START: تقرير Sherrod Model (مع إصلاح لون النص) ---
// ==================================================================
function generateSherrodModel(data) {
    // --- 1. استخراج البيانات الأساسية ---
    const cashFlowFromOps = data.cashFlow;
    const totalAssets = data.assets;

    // --- 2. حساب مؤشر شيرود ---
    const sherrodScore = totalAssets > 0 ? (cashFlowFromOps / totalAssets) * 100 : 0;

    // --- 3. تحديد الحالة والتوصية ---
    let status, statusColor, recommendation;
    if (sherrodScore > 10) {
        status = 'قوي جدًا'; statusColor = 'success';
        recommendation = 'الشركة لديها قدرة ممتازة على توليد النقد من أصولها. هذا مؤشر قوي على الكفاءة التشغيلية والصحة المالية.';
    } else if (sherrodScore > 5) {
        status = 'مقبول'; statusColor = 'warning';
        recommendation = 'قدرة الشركة على توليد النقد من أصولها مقبولة، ولكن هناك فرصة للتحسين.';
    } else {
        status = 'ضعيف'; statusColor = 'danger';
        recommendation = 'التدفقات النقدية ضعيفة مقارنة بحجم الأصول. هذا قد يشير إلى مشاكل في السيولة.';
    }

    // --- 4. بناء الواجهة الاحترافية ---
    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-faucet-drip me-2"></i>غرفة عمليات نموذج شيرود (قوة التدفق النقدي)</h4>
            <div class="alert alert-info">نموذج بسيط ومباشر، يركز حصريًا على قدرة أصول الشركة على توليد النقد.</div>
            
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="stats-card border-${statusColor}">
                        <h6>مؤشر قوة التدفق النقدي</h6>
                        <h3 class="text-${statusColor}">${sherrodScore.toFixed(2)}%</h3>
                        <p>يعني أن كل 100 ريال من الأصول تولد ${sherrodScore.toFixed(2)} ريال نقدًا من العمليات</p>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-${statusColor}">
                <h6 class="alert-heading">التشخيص والتوصية</h6>
                <p class="mb-0">${recommendation}</p>
            </div>

            <div class="card bg-dark border-secondary mt-4">
                <div class="card-header"><h5><i class="fas fa-calculator me-2"></i>تفاصيل الحساب</h5></div>
                <div class="card-body">
                    <dl class="row mb-0">
                     <div class="card-body text-light">
    <dl class="row mb-0">
        <dt class="col-sm-4">التدفق النقدي من العمليات</dt>
        <dd class="col-sm-8 text-end">${cashFlowFromOps.toLocaleString('ar-SA', { style: 'currency', currency: 'SAR', minimumFractionDigits: 0, maximumFractionDigits: 0 })}</dd>
        
        <dt class="col-sm-4">إجمالي الأصول</dt>
        <dd class="col-sm-8 text-end">${totalAssets.toLocaleString('ar-SA', { style: 'currency', currency: 'SAR', minimumFractionDigits: 0, maximumFractionDigits: 0 })}</dd>
        
        <hr class="my-2 border-secondary">

        <dt class="col-sm-4">المعادلة</dt>
        <dd class="col-sm-8 text-end">(التدفق النقدي / إجمالي الأصول) * 100</dd>
    </dl>
</div>

            </div>
        </div>
    `;
}
// ==================================================================
// --- END: تقرير Sherrod Model (مع إصلاح لون النص) ---
// ==================================================================
// ==================================================================
// --- END: تقرير Sherrod Model (النسخة المحدثة والمضمونة) ---
// ==================================================================
// ==================================================================
// --- END: تقرير Sherrod Model (النسخة المطورة) ---
// ==================================================================


      // ==================================================================
// --- START: تقرير Fulmer H-Score (النسخة المطورة) ---
// ==================================================================
// ==================================================================
// --- START: تقرير Fulmer H-Score (V2 - مع التشخيص الذكي) ---
// ==================================================================
function generateFulmerHScore(data) {
    // --- 1. استخراج البيانات الأساسية والتأكد من وجودها ---
    const retainedEarnings = data.retainedEarnings || 0;
    const totalAssets = data.assets || 1; // تجنب القسمة على صفر
    const sales = data.revenue || 0;
    const operatingProfit = data.operatingProfit || 0;
    const cashFlowFromOps = data.cashFlow || 0;
    const totalLiabilities = data.liabilities || 1;
    const currentAssets = data.currentAssets || 0;
    const currentLiabilities = data.currentLiabilities || 1;
    const workingCapital = currentAssets - currentLiabilities;
    const fixedAssets = data.fixedAssets || 1;
    const interestExpense = data.interestExpense || 0;
    const ebit = operatingProfit; // EBIT هو الربح التشغيلي

    // --- 2. حساب متغيرات النموذج التسعة (مع معالجة الأخطاء) ---
    const h1 = retainedEarnings / totalAssets;
    const h2 = sales / totalAssets;
    const h3 = ebit / totalAssets;
    const h4 = cashFlowFromOps / totalLiabilities;
    const h5 = data.longTermLiabilities / totalLiabilities;
    const h6 = workingCapital / currentLiabilities;
    const h7 = Math.log(fixedAssets > 0 ? fixedAssets : 1); // تجنب لوغاريتم الصفر
    const h8 = workingCapital / totalAssets;
    const h9 = Math.log(Math.abs(ebit) + 1); // تجنب لوغاريتم السالب أو الصفر

    // --- 3. حساب النتيجة النهائية (H-Score) ---
    const hScore = 5.528 * h1 + 0.212 * h2 + 0.073 * h3 + 1.270 * h4 - 0.120 * h5 + 2.335 * h6 + 0.575 * h7 + 1.083 * h8 + 0.894 * h9 - 6.075;

    // --- 4. تحديد الحالة والتوصية ---
    let status, statusColor, recommendation;
    if (hScore > 0) {
        status = 'منطقة آمنة'; statusColor = 'success';
        recommendation = 'الشركة في وضع مالي آمن وفقًا لهذا النموذج متعدد الأبعاد. المؤشرات المالية تبدو قوية عبر مختلف الجوانب.';
    } else {
        status = 'منطقة خطر'; statusColor = 'danger';
        recommendation = 'النموذج يشير إلى احتمالية وجود ضائقة مالية. يُنصح بمراجعة شاملة للمؤشرات أدناه التي تم تقييمها كـ "ضعف" لتحديد نقاط الخلل.';
    }

    // --- 5. بناء الواجهة الاحترافية مع عمود التقييم ---
    const createRow = (variable, description, value, isGood) => {
        const ratingColor = isGood ? 'success' : 'danger';
        const ratingText = isGood ? 'قوة' : 'ضعف';
        return `
            <tr>
                <td><strong>${variable}</strong></td>
                <td>${description}</td>
                <td class="text-end">${value.toFixed(3)}</td>
                <td class="text-center"><span class="badge bg-${ratingColor}">${ratingText}</span></td>
            </tr>
        `;
    };

    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-h-square me-2"></i>غرفة عمليات H-Score (فولمر)</h4>
            <div class="alert alert-info">نموذج تنبؤي قوي، يستخدم 9 نسب مالية مختلفة لتوفير تشخيص شامل ودقيق للصحة المالية للشركة.</div>
            
            <div class="stats-card border-${statusColor} mb-4">
                <h6>H-Score</h6>
                <h3 class="text-${statusColor}">${hScore.toFixed(3)}</h3>
                <p>النتيجة النهائية للنموذج (الحد الفاصل: 0)</p>
            </div>
            
            <div class="alert alert-${statusColor}">
                <h6 class="alert-heading">التشخيص والتوصية</h6>
                <p class="mb-0">${recommendation}</p>
            </div>

            <div class="card bg-dark border-secondary mt-4">
                <div class="card-header"><h5><i class="fas fa-microscope me-2"></i>تشريح المتغيرات التسعة مع التقييم</h5></div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr><th>المتغير</th><th>الوصف</th><th class="text-end">النتيجة</th><th class="text-center">التقييم</th></tr>
                        </thead>
                        <tbody>
                            ${createRow('H1', 'الأرباح المبقاة / إجمالي الأصول', h1, h1 > 0)}
                            ${createRow('H2', 'المبيعات / إجمالي الأصول', h2, h2 > 1)}
                            ${createRow('H3', 'الربح التشغيلي / إجمالي الأصول', h3, h3 > 0.05)}
                            ${createRow('H4', 'التدفق النقدي / إجمالي الالتزامات', h4, h4 > 0.1)}
                            ${createRow('H5', 'الدين طويل الأجل / إجمالي الالتزامات', h5, h5 < 0.5)}
                            ${createRow('H6', 'رأس المال العامل / الالتزامات المتداولة', h6, h6 > 1)}
                            ${createRow('H7', 'لوغاريتم الأصول الثابتة', h7, true)}
                            ${createRow('H8', 'رأس المال العامل / إجمالي الأصول', h8, h8 > 0)}
                            ${createRow('H9', 'لوغاريتم الأرباح قبل الفوائد', h9, ebit > 0)}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}
// ==================================================================
// --- END: تقرير Fulmer H-Score (V2) ---
// ==================================================================
// ==================================================================
// --- END: تقرير Fulmer H-Score (النسخة المطورة) ---
// ==================================================================


       // ==================================================================
// --- START: تقرير Springate S-Score (V2 - مع التشخيص الذكي) ---
// ==================================================================
function generateSpringateSScore(data) {
    // --- 1. استخراج البيانات الأساسية والتأكد من وجودها ---
    const workingCapital = data.currentAssets - data.currentLiabilities;
    const totalAssets = data.assets || 1; // تجنب القسمة على صفر
    const ebit = data.operatingProfit || 0;
    const retainedEarnings = data.retainedEarnings || 0; // إصلاح خطأ NaN
    const sales = data.revenue || 0;

    // --- 2. حساب متغيرات النموذج الأربعة (S1 to S4) ---
    const s1 = totalAssets > 0 ? workingCapital / totalAssets : 0;
    const s2 = totalAssets > 0 ? retainedEarnings / totalAssets : 0;
    const s3 = totalAssets > 0 ? ebit / totalAssets : 0;
    const s4 = totalAssets > 0 ? sales / totalAssets : 0;

    // --- 3. حساب النتيجة النهائية (S-Score) ---
    const sScore = (1.03 * s1) + (3.07 * s2) + (0.66 * s3) + (0.4 * s4);

    // --- 4. تحديد الحالة والتوصية ---
    const isDistressed = sScore < 0.862;
    let status, statusColor, recommendation;
    if (!isDistressed) {
        status = 'منطقة آمنة'; statusColor = 'success';
        recommendation = 'الشركة في وضع مالي آمن وفقًا لنموذج سبرينجيت. المؤشرات الأربعة للربحية والسيولة والكفاءة تبدو قوية.';
    } else {
        status = 'منطقة خطر'; statusColor = 'danger';
        recommendation = 'النموذج يشير إلى احتمالية وجود ضائقة مالية. يُنصح بمراجعة المتغيرات التي تم تقييمها كـ "ضعف" لتحديد نقاط الخلل.';
    }

    // --- 5. بناء الواجهة الاحترافية مع عمود التقييم ---
    const createRow = (variable, description, value, isGood) => {
        const ratingColor = isGood ? 'success' : 'danger';
        const ratingText = isGood ? 'قوة' : 'ضعف';
        return `
            <tr>
                <td><strong>${variable}</strong></td>
                <td>${description}</td>
                <td class="text-end">${value.toFixed(3)}</td>
                <td class="text-center"><span class="badge bg-${ratingColor}">${ratingText}</span></td>
            </tr>
        `;
    };

    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-leaf me-2"></i>غرفة عمليات S-Score (سبرينجيت)</h4>
            <div class="alert alert-info">نموذج كندي كلاسيكي، يعتمد على 4 نسب مالية أساسية لتقييم الصحة المالية للشركة.</div>
            
            <div class="stats-card border-${statusColor} mb-4">
                <h6>S-Score</h6>
                <h3 class="text-${statusColor}">${sScore.toFixed(3)}</h3>
                <p>النتيجة النهائية للنموذج (الحد الفاصل: 0.862)</p>
            </div>
            
            <div class="alert alert-${statusColor}">
                <h6 class="alert-heading">التشخيص والتوصية</h6>
                <p class="mb-0">${recommendation}</p>
            </div>

            <div class="card bg-dark border-secondary mt-4">
                <div class="card-header"><h5><i class="fas fa-list-ol me-2"></i>تشريح المتغيرات الأربعة مع التقييم</h5></div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr><th>المتغير</th><th>الوصف</th><th class="text-end">النتيجة</th><th class="text-center">التقييم</th></tr>
                        </thead>
                        <tbody>
                            ${createRow('S1', 'رأس المال العامل / إجمالي الأصول', s1, s1 > 0.1)}
                            ${createRow('S2', 'الأرباح المبقاة / إجمالي الأصول', s2, s2 > 0)}
                            ${createRow('S3', 'الربح التشغيلي / إجمالي الأصول', s3, s3 > 0.05)}
                            ${createRow('S4', 'المبيعات / إجمالي الأصول', s4, s4 > 1)}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}
// ==================================================================
// --- END: تقرير Springate S-Score (V2) ---
// ==================================================================


        // ==================================================================
// --- START: تقرير CA-Score (AI) (V2 - مع إصلاح المنطق) ---
// ==================================================================
function generateCAScoreAI(data) {
    // --- 1. محاكاة تحليل الذكاء الاصطناعي ---
    const accruals = (data.currentAssets - (data.cashAndEquivalents || 0)) - (data.currentLiabilities - (data.shortTermDebt || 0));
    const accrualsToAssets = data.assets > 0 ? accruals / data.assets : 0;
    const leverage = data.assets > 0 ? data.liabilities / data.assets : 0;

    let probability = 0.1;
    if (accrualsToAssets > 0.1) probability += 0.25;
    if (leverage > 0.7) probability += 0.3;
    if (data.cashFlow < 0) probability += 0.2;

    probability = Math.min(probability, 0.95);
    const probabilityPct = (probability * 100).toFixed(1);
    const confidenceScore = 1 - Math.abs(probability - 0.5) * 0.4;

    // --- 2. تحديد الحالة والتوصية ---
    let status, statusColor, recommendation;
    if (probability < 0.3) {
        status = 'خطر منخفض'; statusColor = 'success';
        recommendation = 'تحليل الذكاء الاصطناعي يشير إلى أن جودة أرباح الشركة مرتفعة وأن هيكلها المالي متحفظ وآمن.';
    } else if (probability < 0.6) {
        status = 'خطر متوسط'; statusColor = 'warning';
        recommendation = 'النموذج يكتشف بعض الأعلام الصفراء المتعلقة بجودة الأرباح أو السيولة. يُنصح بمراقبة هذه الجوانب.';
    } else {
        status = 'خطر مرتفع'; statusColor = 'danger';
        recommendation = 'النموذج يكتشف علامات خطر واضحة في القوائم المالية، قد تتعلق بالاعتماد المفرط على الاستحقاقات المحاسبية أو ضعف السيولة.';
    }

    // --- 3. بناء الواجهة الاحترافية مع المنطق المصحح ---
    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-robot me-2"></i>غرفة عمليات CA-Score (تحليل الذكاء الاصطناعي)</h4>
            <div class="alert alert-info">
                <h6 class="alert-heading">ما هو هذا النموذج؟</h6>
                <p class="mb-0">هذا النموذج يحاكي كيف يمكن للذكاء الاصطناعي تحليل "جودة الأرباح" في الشركة. بدلاً من النظر إلى صافي الربح فقط، هو يبحث عن مدى اعتماد الشركة على "الاستحقاقات المحاسبية" (Accruals) مقابل النقد الحقيقي، وهو مؤشر قوي على الصحة المالية المستقبلية.</p>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-7">
                    <div class="stats-card border-${statusColor}">
                        <h6>تقدير احتمالية التعثر (AI)</h6>
                        <h3 class="text-${statusColor}">${probabilityPct}%</h3>
                        <p>${status}</p>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="stats-card border-secondary">
                        <h6>مستوى الثقة بالتقدير</h6>
                        <h3 class="text-info">${(confidenceScore * 100).toFixed(0)}%</h3>
                        <p>مدى تأكد النموذج من نتيجته</p>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-${statusColor}">
                <h6 class="alert-heading">تشخيص الذكاء الاصطناعي</h6>
                <p class="mb-0">${recommendation}</p>
            </div>

            <div class="card bg-dark border-secondary mt-4">
                <div class="card-header"><h5><i class="fas fa-brain me-2"></i>أهم العوامل التي أثرت على القرار</h5></div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        جودة الأرباح (نسبة الاستحقاقات)
                        <span class="badge bg-${accrualsToAssets <= 0.1 ? 'success' : 'danger'}">${accrualsToAssets <= 0.1 ? 'تأثير إيجابي' : 'تأثير سلبي'}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        الرافعة المالية
                        <span class="badge bg-${leverage <= 0.7 ? 'success' : 'danger'}">${leverage <= 0.7 ? 'تأثير إيجابي' : 'تأثير سلبي'}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        قوة التدفق النقدي التشغيلي
                        <span class="badge bg-${data.cashFlow >= 0 ? 'success' : 'danger'}">${data.cashFlow >= 0 ? 'تأثير إيجابي' : 'تأثير سلبي'}</span>
                    </li>
                </ul>
            </div>
        </div>
    `;
}
// ==================================================================
// --- END: تقرير CA-Score (AI) (V2) ---
// ==================================================================


     // ==================================================================
// --- START: تقرير القيمة المعرضة للخطر (VaR) (النسخة المطورة) ---
// ==================================================================
function generateVaRRisk(data) {
    // --- 1. تحديد مدخلات النموذج ---
    // قيمة المحفظة (Portfolio Value): سنستخدم إجمالي الأصول كتقدير لقيمة الشركة الإجمالية.
    const portfolioValue = data.assets;
    
    // التقلب السنوي (Annual Volatility): هذا الرقم عادةً ما يتم حسابه من بيانات السوق التاريخية.
    // سنستخدم قيمة تقديرية شائعة للشركات غير المالية (15%).
    const annualVolatility = 0.15; // 15%
    
    // مستوى الثقة (Confidence Level): سنستخدم مستوى ثقة 99%، وهو معيار شائع.
    // القيمة المقابلة له في جدول التوزيع الطبيعي (Z-Score) هي 2.326.
    const zScore = 2.326;

    // --- 2. حساب VaR لفترات مختلفة ---
    // VaR ليوم واحد
    const var1Day = portfolioValue * annualVolatility * zScore / Math.sqrt(252); // 252 هو عدد أيام التداول في السنة
    
    // VaR لـ 10 أيام (معيار بازل)
    const var10Day = var1Day * Math.sqrt(10);

    // --- 3. بناء الواجهة الاحترافية ---
    const formatVaRCurrency = (value) => {
        // دالة تنسيق مخصصة لإظهار الخسارة بوضوح
        return `( ${value.toLocaleString('ar-SA', { style: 'currency', currency: 'SAR', minimumFractionDigits: 0, maximumFractionDigits: 0 })} )`;
    };

    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-shield-virus me-2"></i>غرفة عمليات VaR (القيمة المعرضة للخطر)</h4>
            <div class="alert alert-info">
                <h6 class="alert-heading">ما هو هذا النموذج؟</h6>
                <p class="mb-0">القيمة المعرضة للخطر (VaR) هي أداة لقياس المخاطر السوقية. هي تجيب على سؤال: "ما هو أقصى مبلغ يمكن أن نخسره من قيمة أصولنا خلال فترة معينة، عند مستوى ثقة محدد (99%)؟". إنها تساعد الإدارة على فهم أسوأ سيناريو محتمل في الظروف العادية للسوق.</p>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="stats-card border-warning">
                        <h6>VaR (يوم واحد)</h6>
                        <h3 class="text-warning">${formatVaRCurrency(var1Day)}</h3>
                        <p>أقصى خسارة متوقعة في يوم تداول واحد</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stats-card border-danger">
                        <h6>VaR (10 أيام)</h6>
                        <h3 class="text-danger">${formatVaRCurrency(var10Day)}</h3>
                        <p>أقصى خسارة متوقعة خلال أسبوعي تداول</p>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-secondary">
                <h6 class="alert-heading">تفسير النتائج</h6>
                <p>هذا يعني أننا واثقون بنسبة 99% بأن خسائرنا لن تتجاوز <strong>${var1Day.toLocaleString('ar-SA', { style: 'currency', currency: 'SAR', minimumFractionDigits: 0 })}</strong> في اليوم التالي، أو <strong>${var10Day.toLocaleString('ar-SA', { style: 'currency', currency: 'SAR', minimumFractionDigits: 0 })}</strong> خلال الأيام العشرة القادمة، في ظل ظروف السوق العادية.</p>
            </div>

            <div class="card bg-dark border-secondary mt-4">
                <div class="card-header"><h5><i class="fas fa-cogs me-2"></i>مدخلات حساب النموذج</h5></div>
                <div class="card-body text-light">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">قيمة المحفظة (إجمالي الأصول)</dt>
                        <dd class="col-sm-7 text-end">${portfolioValue.toLocaleString('ar-SA', { style: 'currency', currency: 'SAR' })}</dd>
                        
                        <dt class="col-sm-5">التقلب السنوي (تقديري)</dt>
                        <dd class="col-sm-7 text-end">${(annualVolatility * 100).toFixed(1)}%</dd>
                        
                        <dt class="col-sm-5">مستوى الثقة</dt>
                        <dd class="col-sm-7 text-end">99% (Z-Score: ${zScore})</dd>
                    </dl>
                </div>
            </div>
        </div>
    `;
}


// ==================================================================
// ########## START: INVESTMENT WING (ديوان الاستثمار) ##########
// ==================================================================

// --- 1. نموذج خصم التدفقات النقدية (DCF) ---
function generateDCFModel(data) {
    // --- 1. تحديد الافتراضات الأساسية للتقييم ---
    const assumptions = {
        growthRate: 0.05,   // 5% معدل نمو سنوي للإيرادات للسنوات الخمس القادمة
        fcfMargin: 0.07,    // 7% هامش التدفق النقدي الحر من الإيرادات
        wacc: 0.09,         // 9% المتوسط المرجح لتكلفة رأس المال (معدل الخصم)
        perpetualGrowth: 0.02, // 2% معدل النمو الدائم بعد السنة الخامسة
        sharesOutstanding: 1000000 // عدد الأسهم القائمة (مليون سهم)
    };

    // --- 2. حساب التدفقات النقدية الحرة المستقبلية وخصمها ---
    let futureFCF = [];
    let lastRevenue = data.revenue;
    let sumOfDiscountedFCF = 0;

    for (let i = 1; i <= 5; i++) {
        const futureRevenue = lastRevenue * (1 + assumptions.growthRate);
        const fcf = futureRevenue * assumptions.fcfMargin;
        const discountFactor = 1 / Math.pow(1 + assumptions.wacc, i);
        const discountedFCF = fcf * discountFactor;
        sumOfDiscountedFCF += discountedFCF;
        
        futureFCF.push({ year: i, fcf, discountedFCF });
        lastRevenue = futureRevenue;
    }

    // --- 3. حساب القيمة النهائية (Terminal Value) وخصمها ---
    const lastFCF = futureFCF[futureFCF.length - 1].fcf;
    const terminalValue = lastFCF * (1 + assumptions.perpetualGrowth) / (assumptions.wacc - assumptions.perpetualGrowth);
    const discountedTerminalValue = terminalValue / Math.pow(1 + assumptions.wacc, 5);

    // --- 4. حساب القيمة الإجمالية للشركة وقيمة السهم ---
    const enterpriseValue = sumOfDiscountedFCF + discountedTerminalValue;
    const equityValue = enterpriseValue - data.longTermLiabilities + data.cashAndEquivalents;
    const valuePerShare = equityValue / assumptions.sharesOutstanding;

    // --- 5. بناء الواجهة الاحترافية ---
    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-calculator-alt me-2"></i>غرفة عمليات تقييم الشركة (DCF)</h4>
            <div class="alert alert-info">
                <h6 class="alert-heading">ما هو هذا النموذج؟</h6>
                <p class="mb-0">نموذج خصم التدفقات النقدية (DCF) هو الطريقة الأساسية لتقدير القيمة الحقيقية للشركة. الفكرة هي أن قيمة الشركة اليوم تساوي كل الأرباح النقدية الحرة التي ستولدها في المستقبل، بعد خصمها إلى قيمتها الحالية باستخدام "معدل الخصم" الذي يعكس مخاطر الاستثمار في الشركة.</p>
            </div>

            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="stats-card border-primary">
                        <h6>القيمة التقديرية للسهم الواحد</h6>
                        <h3 class="text-primary">${valuePerShare.toLocaleString('ar-SA', { style: 'currency', currency: 'SAR' })}</h3>
                        <p>بناءً على الافتراضات الحالية</p>
                    </div>
                </div>
            </div>

            <div class="card bg-dark border-secondary mt-4">
                <div class="card-header"><h5><i class="fas fa-cogs me-2"></i>الافتراضات الرئيسية للتقييم</h5></div>
                <div class="card-body text-light">
                    <dl class="row mb-0">
                        <dt class="col-sm-6">معدل نمو الإيرادات (5 سنوات)</dt>
                        <dd class="col-sm-6 text-end">${(assumptions.growthRate * 100).toFixed(1)}%</dd>
                        <dt class="col-sm-6">هامش التدفق النقدي الحر</dt>
                        <dd class="col-sm-6 text-end">${(assumptions.fcfMargin * 100).toFixed(1)}%</dd>
                        <dt class="col-sm-6">معدل الخصم (WACC)</dt>
                        <dd class="col-sm-6 text-end">${(assumptions.wacc * 100).toFixed(1)}%</dd>
                        <dt class="col-sm-6">معدل النمو الدائم</dt>
                        <dd class="col-sm-6 text-end">${(assumptions.perpetualGrowth * 100).toFixed(1)}%</dd>
                    </dl>
                </div>
            </div>

            <div class="card bg-dark border-secondary mt-4">
                <div class="card-header"><h5><i class="fas fa-chart-line me-2"></i>توقعات التدفقات النقدية المخصومة</h5></div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr><th>السنة</th><th class="text-end">التدفق النقدي الحر</th><th class="text-end">القيمة الحالية</th></tr>
                        </thead>
                        <tbody>
                            ${futureFCF.map(item => `
                                <tr>
                                    <td>السنة ${item.year}</td>
                                    <td class="text-end">${item.fcf.toLocaleString('ar-SA', { style: 'currency', currency: 'SAR' })}</td>
                                    <td class="text-end">${item.discountedFCF.toLocaleString('ar-SA', { style: 'currency', currency: 'SAR' })}</td>
                                </tr>
                            `).join('')}
                            <tr class="table-active">
                                <td colspan="2"><strong>القيمة النهائية المخصومة (بعد السنة 5)</strong></td>
                                <td class="text-end"><strong>${discountedTerminalValue.toLocaleString('ar-SA', { style: 'currency', currency: 'SAR' })}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

// --- 2. تحليل القيمة الاقتصادية المضافة (EVA) ---
// (سيتم إضافته لاحقًا)
function generateEVAAnalysis(data) {
    return `<div class="p-4"><h4>تقرير تحليل القيمة الاقتصادية المضافة (EVA) - قيد التطوير</h4></div>`;
}
// ==================================================================
// ########## END: INVESTMENT WING ##########
// ==================================================================

// ==================================================================
// --- END: تقرير القيمة المعرضة للخطر (VaR) ---
// ==================================================================


        // Helper function for risk models
        function generateRiskModelTemplate(modelName, score, probability, type, description) {
            const probabilityPct = (probability * 100).toFixed(1);
            const statusColor = probability < 0.3 ? 'success' : probability < 0.6 ? 'warning' : 'danger';
            const status = probability < 0.3 ? 'منخفض' : probability < 0.6 ? 'متوسط' : 'مرتفع';
            
            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-chart-line"></i> ${modelName}</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> ${description}
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="stats-card border-${statusColor}">
                                <h6>النتيجة</h6>
                                <h3 class="text-${statusColor}">${score.toFixed(4)}</h3>
                                <p>${type}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stats-card border-${statusColor}">
                                <h6>احتمالية الإفلاس</h6>
                                <h3 class="text-${statusColor}">${probabilityPct}%</h3>
                                <p>خطر ${status}</p>
                            </div>
                        </div>
                    </div>

                    <div class="progress mb-4" style="height: 40px;">
                        <div class="progress-bar bg-${statusColor}" role="progressbar" style="width: ${probabilityPct}%">
                            ${probabilityPct}% احتمالية إفلاس
                        </div>
                    </div>

                    <div class="alert alert-${statusColor}">
                        <h6><i class="fas fa-info-circle"></i> التقييم</h6>
                        <p class="mb-0">
                            ${probability < 0.3 ? 
                                'الشركة في وضع مالي جيد. احتمالية الإفلاس منخفضة.' :
                                probability < 0.6 ?
                                'الشركة في منطقة رمادية. يُنصح بمراقبة المؤشرات المالية.' :
                                'الشركة في وضع مالي صعب. يتطلب اتخاذ إجراءات فورية.'}
                        </p>
                    </div>
                </div>
            `;
        }

        // ========== INVESTMENT REPORTS ==========
    // --- 1. نموذج تسعير الأصول الرأسمالية (CAPM) ---
function generateCAPM(data) {
    // --- 1. تحديد الافتراضات الأساسية للنموذج ---
    // هذه الأرقام عادة ما يتم الحصول عليها من مصادر بيانات السوق المالية
    const assumptions = {
        riskFreeRate: 0.045, // 4.5% - عائد السندات الحكومية طويلة الأجل (تقديري)
        marketReturn: 0.10,  // 10% - متوسط العائد التاريخي للسوق (تقديري)
        beta: 1.2           // 1.2 - معامل بيتا للشركة (أكثر تقلبًا من السوق)
    };
    
    // علاوة مخاطر السوق = عائد السوق - المعدل الخالي من المخاطر
    const marketRiskPremium = assumptions.marketReturn - assumptions.riskFreeRate;

    // --- 2. حساب العائد المتوقع (تكلفة حقوق الملكية) ---
    // Cost of Equity = Risk-Free Rate + Beta * (Market Risk Premium)
    const expectedReturn = assumptions.riskFreeRate + (assumptions.beta * marketRiskPremium);

    // --- 3. بناء الواجهة الاحترافية ---
    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-chart-pie me-2"></i>غرفة عمليات CAPM (تكلفة حقوق الملكية)</h4>
            <div class="alert alert-info">
                <h6 class="alert-heading">ما هو هذا النموذج؟</h6>
                <p class="mb-0">نموذج تسعير الأصول الرأسمالية (CAPM) هو أداة أساسية لتحديد العائد المتوقع على الاستثمار في سهم الشركة، والذي يمثل "تكلفة حقوق الملكية". هذا الرقم هو الحد الأدنى للعائد الذي يجب أن تحققه المشاريع الجديدة لتكون مربحة للمساهمين.</p>
            </div>

            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="stats-card border-primary">
                        <h6>العائد المتوقع / تكلفة حقوق الملكية</h6>
                        <h3 class="text-primary">${(expectedReturn * 100).toFixed(2)}%</h3>
                        <p>بناءً على مخاطر الشركة مقارنة بالسوق</p>
                    </div>
                </div>
            </div>

            <div class="alert alert-secondary">
                <h6 class="alert-heading">تفسير النتيجة</h6>
                <p>هذا يعني أنه لكي يكون الاستثمار في الشركة مجديًا، يجب أن يتوقع المستثمرون تحقيق عائد لا يقل عن <strong>${(expectedReturn * 100).toFixed(2)}%</strong> لتعويضهم عن المخاطر التي يتحملونها. كما يجب على الشركة أن لا تقبل بأي مشروع استثماري لا يحقق عائدًا أعلى من هذه النسبة.</p>
            </div>

            <div class="card bg-dark border-secondary mt-4">
                <div class="card-header"><h5><i class="fas fa-cogs me-2"></i>مدخلات حساب النموذج</h5></div>
                <div class="card-body text-light">
                    <dl class="row mb-0">
                        <dt class="col-sm-6">المعدل الخالي من المخاطر (Rf)</dt>
                        <dd class="col-sm-6 text-end">${(assumptions.riskFreeRate * 100).toFixed(1)}%</dd>
                        
                        <dt class="col-sm-6">عائد السوق المتوقع (Rm)</dt>
                        <dd class="col-sm-6 text-end">${(assumptions.marketReturn * 100).toFixed(1)}%</dd>

                        <dt class="col-sm-6">علاوة مخاطر السوق (Rm - Rf)</dt>
                        <dd class="col-sm-6 text-end">${(marketRiskPremium * 100).toFixed(1)}%</dd>
                        
                        <dt class="col-sm-6">معامل بيتا (β)</dt>
                        <dd class="col-sm-6 text-end">${assumptions.beta.toFixed(2)}</dd>
                    </dl>
                </div>
            </div>
        </div>
    `;
}


        // ==================================================================
// --- 2. نموذج فاما-فرنش ثلاثي العوامل ---
// ==================================================================
function generateFamaFrench(data) {
    // --- 1. تحديد الافتراضات الأساسية للنموذج ---
    // هذه الأرقام عادة ما يتم الحصول عليها من مصادر بيانات السوق المالية وأبحاث الانحدار
    const assumptions = {
        riskFreeRate: 0.05,  // 5.0% - المعدل الخالي من المخاطر
        marketRiskPremium: 0.07, // 7.0% - علاوة مخاطر السوق (Rm-Rf)
        smbPremium: 0.03,    // 3.0% - علاوة عامل الحجم (Small Minus Big)
        hmlPremium: 0.04,    // 4.0% - علاوة عامل القيمة (High Minus Low)
        beta: 1.2,           // معامل انحدار الشركة على عامل السوق
        sizeFactor: 0.5,     // معامل انحدار الشركة على عامل الحجم (s)
        valueFactor: 0.3     // معامل انحدار الشركة على عامل القيمة (h)
    };

    // --- 2. حساب مكونات العائد المتوقع ---
    const marketComponent = assumptions.beta * assumptions.marketRiskPremium;
    const sizeComponent = assumptions.sizeFactor * assumptions.smbPremium;
    const valueComponent = assumptions.valueFactor * assumptions.hmlPremium;

    // --- 3. حساب العائد المتوقع الإجمالي ---
    // E(R) = Rf + β(Rm-Rf) + s(SMB) + h(HML)
    const expectedReturn = assumptions.riskFreeRate + marketComponent + sizeComponent + valueComponent;

    // --- 4. بناء الواجهة الاحترافية ---
    const toPercent = (val) => `${(val * 100).toFixed(2)}%`;

    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-cubes me-2"></i>غرفة عمليات فاما-فرنش (ثلاثي العوامل)</h4>
            <div class="alert alert-info">
                <h6 class="alert-heading">ما هو هذا النموذج؟</h6>
                <p class="mb-0">نموذج فاما-فرنش هو تطوير لنموذج CAPM. هو يضيف عاملين إضافيين لتفسير عوائد الأسهم: <strong>عامل الحجم</strong> (الشركات الصغيرة تميل لتحقيق عوائد أعلى) و<strong>عامل القيمة</strong> (شركات القيمة تميل لتحقيق عوائد أعلى). هذا يوفر رؤية أكثر دقة للعائد المتوقع.</p>
            </div>

            <div class="stats-card border-primary mb-4">
                <h6>العائد المتوقع (حسب نموذج فاما-فرنش)</h6>
                <h3 class="text-primary">${toPercent(expectedReturn)}</h3>
                <p>يأخذ في الاعتبار مخاطر السوق، الحجم، والقيمة</p>
            </div>

            <div class="card bg-dark border-secondary mt-4">
                <div class="card-header"><h5><i class="fas fa-atom me-2"></i>تشريح مكونات العائد المتوقع</h5></div>
                <div class="card-body text-light">
                    <dl class="row mb-0">
                        <dt class="col-sm-8">العائد الأساسي (خالي من المخاطر)</dt>
                        <dd class="col-sm-4 text-end">${toPercent(assumptions.riskFreeRate)}</dd>
                        <hr class="my-2 border-secondary">
                        <dt class="col-sm-8">العائد من التعرض لمخاطر السوق (β)</dt>
                        <dd class="col-sm-4 text-end">+ ${toPercent(marketComponent)}</dd>
                        <dt class="col-sm-8">العائد من التعرض لعامل الحجم (s)</dt>
                        <dd class="col-sm-4 text-end">+ ${toPercent(sizeComponent)}</dd>
                        <dt class="col-sm-8">العائد من التعرض لعامل القيمة (h)</dt>
                        <dd class="col-sm-4 text-end">+ ${toPercent(valueComponent)}</dd>
                        <hr class="my-2 border-secondary">
                        <dt class="col-sm-8"><strong>الإجمالي (العائد المتوقع)</strong></dt>
                        <dd class="col-sm-4 text-end"><strong>= ${toPercent(expectedReturn)}</strong></dd>
                    </dl>
                </div>
            </div>

            <div class="card bg-dark border-secondary mt-4">
                <div class="card-header"><h5><i class="fas fa-cogs me-2"></i>المدخلات والافتراضات</h5></div>
                <div class="card-body p-0">
                    <table class="table table-sm table-borderless text-light mb-0">
                        <tbody>
                            <tr><td>المعدل الخالي من المخاطر (Rf)</td><td class="text-end">${toPercent(assumptions.riskFreeRate)}</td></tr>
                            <tr><td>علاوة مخاطر السوق (Rm-Rf)</td><td class="text-end">${toPercent(assumptions.marketRiskPremium)}</td></tr>
                            <tr><td>علاوة عامل الحجم (SMB)</td><td class="text-end">${toPercent(assumptions.smbPremium)}</td></tr>
                            <tr><td>علاوة عامل القيمة (HML)</td><td class="text-end">${toPercent(assumptions.hmlPremium)}</td></tr>
                            <tr><td>معامل بيتا (β)</td><td class="text-end">${assumptions.beta.toFixed(2)}</td></tr>
                            <tr><td>معامل الحجم (s)</td><td class="text-end">${assumptions.sizeFactor.toFixed(2)}</td></tr>
                            <tr><td>معامل القيمة (h)</td><td class="text-end">${assumptions.valueFactor.toFixed(2)}</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}


       // ==================================================================
// --- 3. نظرية المحفظة الحديثة (MPT) ---
// ==================================================================
function generateMPT(data) {
    // --- 1. محاكاة محفظة استثمارية بسيطة (3 أصول) ---
    const portfolio = {
        assets: [
            { name: 'أسهم محلية', weight: 0.50, expectedReturn: 0.12, volatility: 0.18 },
            { name: 'سندات حكومية', weight: 0.30, expectedReturn: 0.05, volatility: 0.06 },
            { name: 'أسهم عالمية', weight: 0.20, expectedReturn: 0.10, volatility: 0.22 }
        ],
        // مصفوفة الارتباط بين الأصول (أسهم محلية، سندات، أسهم عالمية)
        correlationMatrix: [
            [1.0, 0.2, 0.6], // الارتباط مع النفس، مع السندات، مع الأسهم العالمية
            [0.2, 1.0, 0.1], // الارتباط مع الأسهم المحلية، مع النفس، مع الأسهم العالمية
            [0.1, 0.6, 1.0]  // الارتباط مع الأسهم المحلية، مع السندات، مع النفس
        ]
    };

    // --- 2. حساب العائد المتوقع للمحفظة ---
    // هو المتوسط المرجح لعوائد الأصول
    let portfolioReturn = 0;
    portfolio.assets.forEach(asset => {
        portfolioReturn += asset.weight * asset.expectedReturn;
    });

    // --- 3. حساب المخاطرة (الانحراف المعياري) للمحفظة ---
    // المعادلة تأخذ في الاعتبار أوزان ومخاطر وارتباطات كل الأصول
    let portfolioVariance = 0;
    for (let i = 0; i < portfolio.assets.length; i++) {
        for (let j = 0; j < portfolio.assets.length; j++) {
            portfolioVariance += portfolio.assets[i].weight * portfolio.assets[j].weight * 
                                 portfolio.assets[i].volatility * portfolio.assets[j].volatility * 
                                 portfolio.correlationMatrix[i][j];
        }
    }
    const portfolioVolatility = Math.sqrt(portfolioVariance);

    // --- 4. بناء الواجهة الاحترافية ---
    const toPercent = (val) => `${(val * 100).toFixed(1)}%`;

    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-sitemap me-2"></i>غرفة عمليات MPT (تحسين المحفظة)</h4>
            <div class="alert alert-info">
                <h6 class="alert-heading">ما هي هذه النظرية؟</h6>
                <p class="mb-0">نظرية المحفظة الحديثة (MPT) هي إطار عمل لبناء محافظ استثمارية تهدف إلى تعظيم العائد لمستوى معين من المخاطرة. جوهرها هو <strong>التنويع</strong>: من خلال الجمع بين أصول غير مترابطة تمامًا، يمكن تقليل مخاطر المحفظة الكلية بشكل كبير.</p>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="stats-card border-primary">
                        <h6>العائد المتوقع للمحفظة</h6>
                        <h3 class="text-primary">${toPercent(portfolioReturn)}</h3>
                        <p>المتوسط المرجح لعوائد الأصول</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stats-card border-warning">
                        <h6>المخاطرة الكلية للمحفظة</h6>
                        <h3 class="text-warning">${toPercent(portfolioVolatility)}</h3>
                        <p>الانحراف المعياري للمحفظة</p>
                    </div>
                </div>
            </div>

            <div class="alert alert-success">
                <h6 class="alert-heading">سحر التنويع في العمل</h6>
                <p>لاحظ أن المخاطرة الإجمالية للمحفظة (${toPercent(portfolioVolatility)}) هي <strong>أقل</strong> من المتوسط المرجح لمخاطر الأصول الفردية. هذا الانخفاض في المخاطر هو الفائدة المباشرة للتنويع وعدم وجود ارتباط مثالي بين الأصول.</p>
            </div>

            <div class="card bg-dark border-secondary mt-4">
                <div class="card-header"><h5><i class="fas fa-cubes me-2"></i>مكونات المحفظة الافتراضية</h5></div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr><th>الأصل</th><th class="text-end">الوزن</th><th class="text-end">العائد المتوقع</th><th class="text-end">المخاطرة</th></tr>
                        </thead>
                        <tbody>
                            ${portfolio.assets.map(asset => `
                                <tr>
                                    <td>${asset.name}</td>
                                    <td class="text-end">${toPercent(asset.weight)}</td>
                                    <td class="text-end">${toPercent(asset.expectedReturn)}</td>
                                    <td class="text-end">${toPercent(asset.volatility)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}


      // ==================================================================
// --- 4. نسبة شارب (Sharpe Ratio) ---
// ==================================================================
function generateSharpeRatio(data) {
    // --- 1. تحديد الافتراضات الأساسية للنموذج ---
    // سنستخدم نفس أرقام المحفظة من تقرير MPT السابق للاتساق
    const assumptions = {
        portfolioReturn: 0.097, // 9.7% - العائد المحسوب للمحفظة في تقرير MPT
        portfolioVolatility: 0.12, // 12.0% - المخاطرة المحسوبة للمحفظة في تقرير MPT
        riskFreeRate: 0.045   // 4.5% - المعدل الخالي من المخاطر
    };

    // --- 2. حساب نسبة شارب ---
    // Sharpe Ratio = (Portfolio Return - Risk-Free Rate) / Portfolio Volatility
    const sharpeRatio = (assumptions.portfolioReturn - assumptions.riskFreeRate) / assumptions.portfolioVolatility;

    // --- 3. تحديد تقييم الأداء بناءً على النسبة ---
    let performance, performanceColor, recommendation;
    if (sharpeRatio < 1) {
        performance = 'غير جيد'; performanceColor = 'danger';
        recommendation = 'العائد المحقق لا يبرر حجم المخاطرة التي تم تحملها. يجب مراجعة استراتيجية المحفظة.';
    } else if (sharpeRatio < 2) {
        performance = 'جيد'; performanceColor = 'success';
        recommendation = 'المحفظة تحقق عائدًا جيدًا مقارنة بمستوى المخاطرة. الأداء يعتبر مقبولًا.';
    } else if (sharpeRatio < 3) {
        performance = 'ممتاز'; performanceColor = 'primary';
        recommendation = 'المحفظة تحقق عائدًا ممتازًا ومعدلاً حسب المخاطر. أداء قوي جدًا.';
    } else {
        performance = 'استثنائي'; performanceColor = 'info';
        recommendation = 'أداء استثنائي بكل المقاييس. المحفظة تحقق عوائد عالية جدًا مقارنة بمخاطرها المنخفضة نسبيًا.';
    }

    // --- 4. بناء الواجهة الاحترافية ---
    const toPercent = (val) => `${(val * 100).toFixed(1)}%`;

    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-balance-scale-right me-2"></i>غرفة عمليات نسبة شارب (تقييم الأداء)</h4>
            <div class="alert alert-info">
                <h6 class="alert-heading">ما هي هذه النسبة؟</h6>
                <p class="mb-0">نسبة شارب هي المقياس الذهبي لتقييم أداء الاستثمار "المعدل حسب المخاطر". هي تجيب على سؤال: "كم من العائد الزائد حققت مقابل كل وحدة مخاطرة تحملتها؟". كلما ارتفعت النسبة، كان أداء الاستثمار أفضل.</p>
            </div>

            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="stats-card border-${performanceColor}">
                        <h6>نسبة شارب</h6>
                        <h3 class="text-${performanceColor}">${sharpeRatio.toFixed(2)}</h3>
                        <p>تقييم الأداء: ${performance}</p>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-${performanceColor}">
                <h6 class="alert-heading">التشخيص والتوصية</h6>
                <p class="mb-0">${recommendation}</p>
            </div>

            <div class="card bg-dark border-secondary mt-4">
                <div class="card-header"><h5><i class="fas fa-cogs me-2"></i>مدخلات حساب النسبة</h5></div>
                <div class="card-body text-light">
                    <dl class="row mb-0">
                        <dt class="col-sm-6">عائد المحفظة (Rp)</dt>
                        <dd class="col-sm-6 text-end">${toPercent(assumptions.portfolioReturn)}</dd>
                        
                        <dt class="col-sm-6">المعدل الخالي من المخاطر (Rf)</dt>
                        <dd class="col-sm-6 text-end">${toPercent(assumptions.riskFreeRate)}</dd>
                        
                        <dt class="col-sm-6">مخاطرة المحفظة (σp)</dt>
                        <dd class="col-sm-6 text-end">${toPercent(assumptions.portfolioVolatility)}</dd>
                    </dl>
                </div>
            </div>
        </div>
    `;
}


        // ========== QUALITY REPORTS ==========
        function generateBeneishMScore(data) {
            let lab = null;
            try { const j = localStorage.getItem('mScoreLab_currentData'); if (j) lab = JSON.parse(j); } catch {}
            const src = lab || data || {};

            const salesCurr = Math.abs(src.revenue ?? data?.revenue ?? 0);
            const receivablesCurr = Math.abs(src.receivables ?? ((data.categorized?.currentAssets||[]).filter(acc => (SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='trade_receivables').reduce((s,a)=> s + Math.abs(a.finalBalance||0),0)) );
            const assetsCurr = Math.abs(src.assets ?? ((data?.assets) ?? ((data?.currentAssets || 0) + (data?.fixedAssets || 0))));
            const fixedAssetsCurr = Math.abs(src.fixedAssets ?? (data?.fixedAssets || 0));
            const depExpCurr = Math.abs(src.depreciation ?? (data?.depreciationExpense || 0));
            const sgaCurr = Math.abs(src.sga ?? ((data.categorized?.operatingExpenses||[]).filter(acc => (SUB_CATEGORY_MAPPING[acc.sub_category]||'')!=='depreciation' && (SUB_CATEGORY_MAPPING[acc.sub_category]||'')!=='amortization' && (SUB_CATEGORY_MAPPING[acc.sub_category]||'')!=='zakat_expense').reduce((s,a)=> s + Math.abs(a.finalBalance||0),0)) );
            const liabilitiesCurr = Math.abs(src.liabilities ?? (data?.liabilities || 0));
            const netIncomeCurr = Math.abs(src.netIncome ?? (data?.netIncome || 0));
            const cashFlowOpsCurr = Math.abs(src.cashFlow ?? (data?.cashFlowOps || data?.cashFlow || 0));

            let salesPrior=0, receivablesPrior=0, assetsPrior=0, fixedAssetsPrior=0, depExpPrior=0, sgaPrior=0, liabilitiesPrior=0;
            const pj = localStorage.getItem('priorYearDataLoaded');
            if (pj) {
                try {
                    const prior = JSON.parse(pj);
                    const tb = Array.isArray(prior.trialBalance) ? prior.trialBalance : [];
                    const sumPrior = (filter) => tb.filter(filter).reduce((s, acc) => s + ( (parseFloat(acc.ob_debit)||0) - (parseFloat(acc.ob_credit)||0) ), 0);
                    salesPrior = Math.abs(sumPrior(acc => String(acc.category||'').toLowerCase()==='revenue')) || salesCurr || 1;
                    receivablesPrior = Math.abs(sumPrior(acc => (SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='trade_receivables')) || receivablesCurr || 1;
                    assetsPrior = Math.abs(sumPrior(acc => String(acc.category||'').toLowerCase()==='assets')) || assetsCurr || 1;
                    fixedAssetsPrior = Math.abs(sumPrior(acc => ['fixed_assets','fixed_assets_accumulation'].includes(SUB_CATEGORY_MAPPING[acc.sub_category]||''))) || fixedAssetsCurr || 1;
                    depExpPrior = Math.abs(sumPrior(acc => (SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='depreciation')) || depExpCurr || 1;
                    sgaPrior = Math.abs(sumPrior(acc => (SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='operating_expenses')) || sgaCurr || 1;
                    liabilitiesPrior = Math.abs(sumPrior(acc => String(acc.category||'').toLowerCase()==='liabilities')) || liabilitiesCurr || 1;
                } catch {}
            } else {
                // fallback: استخدم أرصدة أول المدة في نفس الميزان كمؤشر للسنة السابقة
                const tb = data.rawTrialBalance || [];
                const sumOB = (filter) => tb.filter(filter).reduce((s, acc) => s + ( (parseFloat(acc.ob_debit)||0) - (parseFloat(acc.ob_credit)||0) ), 0);
                salesPrior = Math.abs(sumOB(acc => String(acc.category||'').toLowerCase()==='revenue')) || salesCurr || 1;
                receivablesPrior = Math.abs(sumOB(acc => (SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='trade_receivables')) || receivablesCurr || 1;
                assetsPrior = Math.abs(sumOB(acc => String(acc.category||'').toLowerCase()==='assets')) || assetsCurr || 1;
                fixedAssetsPrior = Math.abs(sumOB(acc => ['fixed_assets','fixed_assets_accumulation'].includes(SUB_CATEGORY_MAPPING[acc.sub_category]||''))) || fixedAssetsCurr || 1;
                depExpPrior = Math.abs(sumOB(acc => (SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='depreciation')) || depExpCurr || 1;
                sgaPrior = Math.abs(sumOB(acc => (SUB_CATEGORY_MAPPING[acc.sub_category]||'')==='operating_expenses')) || sgaCurr || 1;
                liabilitiesPrior = Math.abs(sumOB(acc => String(acc.category||'').toLowerCase()==='liabilities')) || liabilitiesCurr || 1;
            }

            const cogsCurr = Math.abs(src.cogs ?? (data?.cogs || 0));
            const grossMarginCurr = (salesCurr>0) ? ( (salesCurr - cogsCurr) / salesCurr ) : 0;
            const cogsPrior = Math.abs( (pj ? 0 : 0) ); // إن لم تتوفر بيانات دقيقة، نحسب GMI باستخدام الهوامش الفعلية المجمعة
            const grossMarginPrior = (salesPrior>0) ? ( (salesPrior - cogsPrior) / salesPrior ) : (grossMarginCurr||0.0001);

            const otherAssetsCurr = Math.max(assetsCurr - Math.abs(data?.currentAssets||0) - fixedAssetsCurr, 0);
            const otherAssetsPrior = Math.max(assetsPrior - Math.abs(0) - fixedAssetsPrior, 0);

            const dsri = ( (receivablesCurr/Math.max(salesCurr,1)) ) / ( (receivablesPrior/Math.max(salesPrior,1)) );
            const gmi = (grossMarginPrior<=0 ? 1 : (grossMarginPrior/Math.max(grossMarginCurr,0.0001)) );
            const aqi = (assetsPrior>0 && assetsCurr>0) ? ( ( (otherAssetsCurr/Math.max(assetsCurr,1)) ) / ( (otherAssetsPrior/Math.max(assetsPrior,1)) ) ) : 1;
            const sgi = salesCurr/Math.max(salesPrior,1);
            const depi = ( (depExpPrior/Math.max(depExpPrior + fixedAssetsPrior,1)) ) / ( (depExpCurr/Math.max(depExpCurr + fixedAssetsCurr,1)) );
            const sgai = ( (sgaCurr/Math.max(salesCurr,1)) ) / ( (sgaPrior/Math.max(salesPrior,1)) );
            const lvgi = ( (liabilitiesCurr/Math.max(assetsCurr,1)) ) / ( (liabilitiesPrior/Math.max(assetsPrior,1)) );
            const tata = assetsCurr>0 ? ( (netIncomeCurr - cashFlowOpsCurr) / assetsCurr ) : 0;

            const mScore = -4.84 + 0.92*dsri + 0.528*gmi + 0.404*aqi + 0.892*sgi + 0.115*depi - 0.172*sgai + 4.679*tata - 0.327*lvgi;
            const isManipulator = mScore > -1.78;

            return `
                <div class="p-4">
                    <h4 class="mb-4"><i class="fas fa-search-dollar"></i> نموذج بينيش للكشف عن التلاعب (M-Score)</h4>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Beneish M-Score</strong> - يكشف عن احتمالية التلاعب في الأرباح
                    </div>
                    <div class="mb-3 d-flex gap-2 flex-wrap">
                        <button class="btn btn-success btn-sm" onclick="beneishPullCurrentFromReport()"><i class="fas fa-download me-1"></i>سحب البيانات الفعلية</button>
                        <label class="btn btn-outline-secondary btn-sm mb-0">رفع البيانات السابقة<input id="beneish_prior_file" type="file" accept=".json,application/json" style="display:none" onchange="beneishUploadPrior(this)"></label>
                        <button class="btn btn-outline-primary btn-sm" onclick="beneishOpenLab()"><i class="fas fa-flask me-1"></i>الدخول للمختبر</button>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="stats-card ${isManipulator ? 'border-danger' : 'border-success'}">
                                <div class="row align-items-center">
                                    <div class="col-md-4 text-center">
                                        <i class="fas fa-${isManipulator ? 'exclamation-triangle' : 'check-circle'} fa-4x text-${isManipulator ? 'danger' : 'success'}"></i>
                                    </div>
                                    <div class="col-md-8">
                                        <h6>M-Score</h6>
                                        <h2 class="text-${isManipulator ? 'danger' : 'success'}">${mScore.toFixed(3)}</h2>
                                        <h5 class="text-${isManipulator ? 'danger' : 'success'}">
                                            ${isManipulator ? '⚠️ احتمالية تلاعب مرتفعة' : '✓ لا توجد مؤشرات تلاعب'}
                                        </h5>
                                        <p class="mb-0">الحد الفاصل: -1.78</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <table class="table table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>المؤشر</th>
                                <th>الوصف</th>
                                <th class="text-end">القيمة</th>
                                <th class="text-end">الوزن</th>
                                <th class="text-end">المساهمة</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>DSRI</td><td>مؤشر أيام المبيعات في الذمم</td><td class="text-end">${dsri.toFixed(3)}</td><td class="text-end">0.920</td><td class="text-end">${(0.92 * dsri).toFixed(3)}</td></tr>
                            <tr><td>GMI</td><td>مؤشر هامش الربح الإجمالي</td><td class="text-end">${gmi.toFixed(3)}</td><td class="text-end">0.528</td><td class="text-end">${(0.528 * gmi).toFixed(3)}</td></tr>
                            <tr><td>AQI</td><td>مؤشر جودة الأصول</td><td class="text-end">${aqi.toFixed(3)}</td><td class="text-end">0.404</td><td class="text-end">${(0.404 * aqi).toFixed(3)}</td></tr>
                            <tr><td>SGI</td><td>مؤشر نمو المبيعات</td><td class="text-end">${sgi.toFixed(3)}</td><td class="text-end">0.892</td><td class="text-end">${(0.892 * sgi).toFixed(3)}</td></tr>
                            <tr><td>DEPI</td><td>مؤشر الإهلاك</td><td class="text-end">${depi.toFixed(3)}</td><td class="text-end">0.115</td><td class="text-end">${(0.115 * depi).toFixed(3)}</td></tr>
                            <tr><td>SGAI</td><td>مؤشر المصروفات البيعية والإدارية</td><td class="text-end">${sgai.toFixed(3)}</td><td class="text-end">-0.172</td><td class="text-end">${(-0.172 * sgai).toFixed(3)}</td></tr>
                            <tr><td>TATA</td><td>إجمالي الاستحقاقات / إجمالي الأصول</td><td class="text-end">${tata.toFixed(3)}</td><td class="text-end">4.679</td><td class="text-end">${(4.679 * tata).toFixed(3)}</td></tr>
                            <tr><td>LVGI</td><td>مؤشر الرافعة المالية</td><td class="text-end">${lvgi.toFixed(3)}</td><td class="text-end">-0.327</td><td class="text-end">${(-0.327 * lvgi).toFixed(3)}</td></tr>
                            <tr class="${isManipulator ? 'table-danger' : 'table-success'}">
                                <td colspan="4"><strong>M-Score</strong></td>
                                <td class="text-end"><strong>${mScore.toFixed(3)}</strong></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="alert ${isManipulator ? 'alert-danger' : 'alert-success'}">
                        <h6><i class="fas fa-${isManipulator ? 'exclamation-triangle' : 'check-circle'}"></i> التفسير</h6>
                        <p class="mb-0">
                            ${isManipulator ? 
                                'M-Score أكبر من -1.78 يشير إلى احتمالية تلاعب في الأرباح. يُنصح بمراجعة دقيقة للقوائم المالية والسياسات المحاسبية.' :
                                'M-Score أقل من -1.78 يشير إلى عدم وجود مؤشرات قوية على التلاعب في الأرباح. القوائم المالية تبدو موثوقة.'}
                        </p>
                    </div>
                </div>
            `;
        }

        function beneishPullCurrentFromReport(){ try{ const d=getData(); if(!d){ alert('لا توجد بيانات'); return; } localStorage.setItem('mScoreLab_currentData', JSON.stringify(d)); alert('تم سحب البيانات الفعلية.'); }catch(e){ alert('تعذر سحب البيانات'); } }
        function beneishUploadPrior(input){ const f=input && input.files && input.files[0]; if(!f){ return; } const r=new FileReader(); r.onload=function(ev){ try{ localStorage.setItem('priorYearDataLoaded', ev.target.result); alert('تم رفع بيانات السنة السابقة.'); }catch(e){ alert('ملف غير صالح'); } }; r.readAsText(f); }
        function beneishOpenLab(){ var cid=new URLSearchParams(window.location.search).get('clientId')||localStorage.getItem('activeClientId'); var url=cid?('m_score_lab.html?clientId='+cid):'m_score_lab.html'; window.open(url,'_blank'); }

       // ==================================================================
// --- 2. نموذج استحقاقات سلون (النسخة المطورة) ---
// ==================================================================
function generateSloanAccruals(data) {
    // --- 1. استخراج البيانات الأساسية ---
    const netIncome = data.netIncome;
    const cashFlowFromOps = data.cashFlow;
    const totalAssets = data.assets;

    // --- 2. حساب المكونات الرئيسية ---
    // الاستحقاقات هي الجزء "الورقي" من الأرباح الذي لم يتحول إلى نقد بعد
    const totalAccruals = netIncome - cashFlowFromOps;
    
    // نسبة الاستحقاقات تقيس حجم هذا المكون الورقي مقارنة بحجم الشركة
    const accrualsRatio = totalAssets > 0 ? (totalAccruals / totalAssets) * 100 : 0;

    // --- 3. تحديد جودة الأرباح بناءً على النسبة ---
    let quality, qualityColor, recommendation;
    if (accrualsRatio < 5) {
        quality = 'جودة عالية'; qualityColor = 'success';
        recommendation = 'نسبة الاستحقاقات منخفضة جدًا، مما يشير إلى أن معظم الأرباح مدعومة بتدفقات نقدية حقيقية. هذا مؤشر قوي على جودة واستدامة الأرباح.';
    } else if (accrualsRatio < 10) {
        quality = 'جودة متوسطة'; qualityColor = 'warning';
        recommendation = 'جودة الأرباح مقبولة، ولكن هناك جزء ملحوظ من الأرباح يعتمد على الاستحقاقات. يُنصح بمراقبة هذا المكون في الفترات القادمة.';
    } else {
        quality = 'جودة منخفضة'; qualityColor = 'danger';
        recommendation = 'نسبة الاستحقاقات مرتفعة. هذا يعني أن جزءًا كبيرًا من الأرباح هو "أرباح ورقية" غير مدعومة بنقد، مما قد يكون علامة خطر على الأداء المستقبلي.';
    }

    // --- 4. بناء الواجهة الاحترافية ---
    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-file-signature me-2"></i>غرفة عمليات استحقاقات سلون (جودة الأرباح)</h4>
            <div class="alert alert-info">
                <h6 class="alert-heading">ما هو هذا النموذج؟</h6>
                <p class="mb-0">نموذج سلون هو أداة بسيطة وقوية لقياس "جودة الأرباح". هو يفصل الأرباح إلى مكونها النقدي ومكونها "الورقي" (الاستحقاقات). كلما انخفضت نسبة الاستحقاقات، كانت جودة الأرباح أعلى وأكثر استدامة.</p>
            </div>

            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="stats-card border-${qualityColor}">
                        <h6>نسبة الاستحقاقات إلى الأصول</h6>
                        <h3 class="text-${qualityColor}">${accrualsRatio.toFixed(2)}%</h3>
                        <p>تقييم جودة الأرباح: ${quality}</p>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-${qualityColor}">
                <h6 class="alert-heading">التشخيص والتوصية</h6>
                <p class="mb-0">${recommendation}</p>
            </div>

            <div class="card bg-dark border-secondary mt-4">
                <div class="card-header"><h5><i class="fas fa-calculator me-2"></i>تفاصيل حساب النسبة</h5></div>
                <div class="card-body text-light">
                    <dl class="row mb-0">
                        <dt class="col-sm-6">صافي الربح</dt>
                        <dd class="col-sm-6 text-end">${formatCurrency(netIncome)}</dd>
                        
                        <dt class="col-sm-6">(-) التدفق النقدي التشغيلي</dt>
                        <dd class="col-sm-6 text-end text-danger">(${formatCurrency(cashFlowFromOps)})</dd>
                        
                        <hr class="my-2 border-secondary">
                        
                        <dt class="col-sm-6"><strong>= إجمالي الاستحقاقات</strong></dt>
                        <dd class="col-sm-6 text-end"><strong>${formatCurrency(totalAccruals)}</strong></dd>
                        
                        <dt class="col-sm-6">(/) إجمالي الأصول</dt>
                        <dd class="col-sm-6 text-end">${formatCurrency(totalAssets)}</dd>
                        
                        <hr class="my-2 border-secondary">

                        <dt class="col-sm-6"><strong>= نسبة الاستحقاقات</strong></dt>
                        <dd class="col-sm-6 text-end"><strong>${accrualsRatio.toFixed(2)}%</strong></dd>
                    </dl>
                </div>
            </div>
        </div>
    `;
}


        // ========== Export Functions ==========
        function exportCurrentReport() {
            const element = document.getElementById('reportModalBody');
            const opt = {
                margin: 10,
                filename: `${currentReportTitle}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        }

     

        // ========== What-If Listeners ==========
        function activateWhatIfListeners() {
            const revenueSlider = document.getElementById('revenue-slider');
            const costsSlider = document.getElementById('costs-slider');
            
            if (!revenueSlider || !costsSlider) return;

            const revenueLabel = document.getElementById('revenue-label');
            const costsLabel = document.getElementById('costs-label');
            
            const baseRevenueEl = document.getElementById('base-revenue-val');
            const baseCostsEl = document.getElementById('base-costs-val');
            const baseProfitEl = document.getElementById('base-profit-val');

            const baseRevenue = parseFloat(baseRevenueEl.textContent.replace(/[^\d.-]/g, ''));
            const baseCosts = parseFloat(baseCostsEl.textContent.replace(/[^\d.-]/g, ''));
            const baseProfit = parseFloat(baseProfitEl.textContent.replace(/[^\d.-]/g, ''));

            function updateProjections() {
                const revenueChange = parseInt(revenueSlider.value);
                const costsChange = parseInt(costsSlider.value);

                revenueLabel.textContent = revenueChange + '%';
                costsLabel.textContent = costsChange + '%';

                const projectedRevenue = baseRevenue * (1 + revenueChange / 100);
                const projectedCosts = baseCosts * (1 + costsChange / 100);
                const projectedProfit = projectedRevenue - projectedCosts;

                const profitChange = projectedProfit - baseProfit;
                const profitChangePercent = (baseProfit !== 0) ? (profitChange / Math.abs(baseProfit)) * 100 : (projectedProfit > 0 ? 100 : 0);

                document.getElementById('projected-revenue').textContent = formatCurrency(projectedRevenue);
                document.getElementById('projected-costs').textContent = '(' + formatCurrency(projectedCosts) + ')';
                document.getElementById('projected-profit').textContent = formatCurrency(projectedProfit);

                document.getElementById('revenue-change').innerHTML = `<span class="${(projectedRevenue >= baseRevenue ? 'text-success' : 'text-danger')}">${formatCurrency(projectedRevenue - baseRevenue)}</span>`;
                document.getElementById('costs-change').innerHTML = `<span class="${(projectedCosts >= baseCosts ? 'text-danger' : 'text-success')}">${formatCurrency(projectedCosts - baseCosts)}</span>`;
                document.getElementById('profit-change').innerHTML = `<span class="${(profitChange >= 0 ? 'text-success' : 'text-danger')}">${formatCurrency(profitChange)} (${profitChangePercent.toFixed(1)}%)</span>`;
            }

            revenueSlider.addEventListener('input', updateProjections);
            costsSlider.addEventListener('input', updateProjections);
            
            updateProjections();
        }

        // ========== Apply Scenario Function ==========
        function applyScenario(revChange, costChange) {
            const revenueSlider = document.getElementById('revenue-slider');
            const costsSlider = document.getElementById('costs-slider');
            if (revenueSlider && costsSlider) {
                revenueSlider.value = revChange;
                costsSlider.value = costChange;
                activateWhatIfListeners();
            }
        }
// ========== Export Functions ==========

function exportToPDF() {
    const reportTitle = currentReportTitle || 'تقرير مالي';
    const reportContent = document.getElementById('reportModalBody');
    
    if (!reportContent) {
        alert('لا يوجد محتوى للتصدير');
        return;
    }
    
    const opt = {
        margin: 1,
        filename: `${reportTitle}_${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, letterRendering: true },
        jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' }
    };
    
    // استخدام html2pdf
    html2pdf().set(opt).from(reportContent).save();
}

function exportToExcel() {
    const data = getData();
    
    if (!data) {
        alert('لا توجد بيانات للتصدير');
        return;
    }
    
    // إنشاء workbook جديد
    const wb = XLSX.utils.book_new();
    
    // ورقة 1: قائمة الدخل
    const incomeData = [
        ['قائمة الدخل الشامل'],
        [''],
        ['البيان', 'المبلغ'],
        ['الإيرادات', data.revenue],
        ['تكلفة المبيعات', -data.cogs],
        ['مجمل الربح', data.grossProfit],
        ['المصروفات التشغيلية', -data.operatingExpenses],
        ['الربح التشغيلي', data.operatingProfit],
        ['إيرادات أخرى', data.otherIncome],
        ['صافي الربح', data.netIncome]
    ];
    const wsIncome = XLSX.utils.aoa_to_sheet(incomeData);
    XLSX.utils.book_append_sheet(wb, wsIncome, 'قائمة الدخل');
    
    // ورقة 2: المركز المالي
    const balanceData = [
        ['قائمة المركز المالي'],
        [''],
        ['الأصول', 'المبلغ', '', 'الخصوم وحقوق الملكية', 'المبلغ'],
        ['أصول متداولة', data.currentAssets, '', 'خصوم متداولة', data.currentLiabilities],
        ['أصول ثابتة', data.fixedAssets, '', 'خصوم طويلة الأجل', data.longTermLiabilities],
        ['', '', '', 'حقوق الملكية', data.equity],
        ['إجمالي الأصول', data.assets, '', 'إجمالي الخصوم وحقوق الملكية', data.liabilities + data.equity]
    ];
    const wsBalance = XLSX.utils.aoa_to_sheet(balanceData);
    XLSX.utils.book_append_sheet(wb, wsBalance, 'المركز المالي');
    
    // ورقة 3: ميزان المراجعة
    if (data.trialBalance && data.trialBalance.length > 0) {
        const tbData = [
            ['ميزان المراجعة'],
            [''],
            ['رقم الحساب', 'اسم الحساب', 'مدين', 'دائن', 'الرصيد']
        ];
        
        data.trialBalance.forEach(acc => {
            tbData.push([
                acc.account_id || '',
                acc.name || '',
                acc.book_balance_debit || 0,
                acc.book_balance_credit || 0,
                acc.book_balance || acc.finalBalance || 0
            ]);
        });
        
        const wsTB = XLSX.utils.aoa_to_sheet(tbData);
        XLSX.utils.book_append_sheet(wb, wsTB, 'ميزان المراجعة');
    }
    
    // حفظ الملف
    const fileName = `Financial_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);
}
// ========== Export to Word ==========
function exportToWord() {
    const reportTitle = currentReportTitle || 'تقرير مالي';
    const reportContent = document.getElementById('reportModalBody');
    
    if (!reportContent) {
        alert('لا يوجد محتوى للتصدير');
        return;
    }
    
    // نسخ المحتوى
    const htmlContent = `
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <style>
                body { font-family: Arial; direction: rtl; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                th { background-color: #00BFFF; color: white; }
            </style>
        </head>
        <body>
            <h1>${reportTitle}</h1>
            ${reportContent.innerHTML}
        </body>
        </html>
    `;
    
    // تحويل لـ Blob
    const blob = new Blob(['\ufeff', htmlContent], {
        type: 'application/msword'
    });
    
    // تحميل
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${reportTitle}_${new Date().toISOString().split('T')[0]}.doc`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// ========== Export to Image ==========
function exportToImage() {
    const reportContent = document.getElementById('reportModalBody');
    
    if (!reportContent) {
        alert('لا يوجد محتوى للتصدير');
        return;
    }
    
    html2canvas(reportContent, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#0d1117',
        logging: false
    }).then(canvas => {
        canvas.toBlob(function(blob) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${currentReportTitle || 'تقرير'}_${new Date().toISOString().split('T')[0]}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }, 'image/png');
    }).catch(error => {
        console.error('خطأ في تصدير الصورة:', error);
        alert('حدث خطأ أثناء تصدير الصورة');
    });
}
// ========================================
// قسم الموازنة (Budget) - 4 تقارير
// ========================================

// 1️⃣ إعداد الموازنة السنوية
// ==================================================================
// --- START: تقرير إعداد الموازنة (V2 - تقدير تلقائي) ---
// ==================================================================
// ==================================================================
// --- START: مختبر الموازنة التفاعلي (V3) ---
// ==================================================================
// ==================================================================
// --- START: تقرير إعداد الموازنة (V-Export-Safe) ---
// ==================================================================
function generateBudgetPreparation(data, isForExport = false) {
    // الجزء الأول: بناء الـ HTML (هذا لا يتغير)
    const html = `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-flask me-2"></i>مختبر الموازنة التفاعلي</h4>
            
            <div class="row" id="budgetLabInputs">
                <!-- لوحة التحكم (المدخلات) -->
                <div class="col-lg-5 mb-4">
                    <div class="card bg-dark border-primary h-100">
                        <div class="card-header"><h5><i class="fas fa-sliders-h me-2"></i>لوحة التحكم بالافتراضات</h5></div>
                        <div class="p-3">
                            <h6 class="text-info">1. محركات الإيرادات</h6>
                            <label class="form-label">نمو كمية البلوك (%): <span id="blockQtyLabel" class="badge bg-primary">10%</span></label>
                            <input type="range" class="form-range" id="blockQtyGrowth" value="10" min="-20" max="50" step="5">
                            
                            <label class="form-label mt-2">نمو كمية الخرسانة (%): <span id="concreteQtyLabel" class="badge bg-primary">10%</span></label>
                            <input type="range" class="form-range" id="concreteQtyGrowth" value="10" min="-20" max="50" step="5">

                            <hr>
                            <h6 class="text-warning">2. محركات التكاليف</h6>
                            <label class="form-label">تضخم أسعار المواد الخام (%): <span id="cogsInflationLabel" class="badge bg-warning">8%</span></label>
                            <input type="range" class="form-range" id="cogsInflation" value="8" min="0" max="25" step="1">

                            <label class="form-label mt-2">نمو المصاريف الثابتة (%): <span id="fixedCostGrowthLabel" class="badge bg-warning">5%</span></label>
                            <input type="range" class="form-range" id="fixedCostGrowth" value="5" min="0" max="25" step="1">
                        </div>
                    </div>
                </div>

                <!-- لوحة النتائج (المخرجات) -->
                <div class="col-lg-7 mb-4">
                    <div class="card bg-dark border-success h-100">
                        <div class="card-header"><h5><i class="fas fa-poll me-2"></i>الموازنة المقترحة (النتائج)</h5></div>
                        <div class="card-body p-0">
                            <div id="budgetLabResults">
                                <div class="text-center p-5"><div class="loading-spinner"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    // الجزء الثاني: تشغيل الكود التفاعلي (فقط إذا لم نكن في وضع التصدير)
    runInteractiveCode(isForExport, () => {
        document.querySelectorAll('#budgetLabInputs input').forEach(input => {
            input.addEventListener('input', calculateBudgetScenario);
        });
        calculateBudgetScenario(); // الحساب الأولي
    });

    // الجزء الثالث: إرجاع الـ HTML
    return html;
}
// ==================================================================
// --- END: تقرير إعداد الموازنة (V-Export-Safe) ---
// ==================================================================

/**
 * دالة ذكية: تقوم بإعادة حساب سيناريو الموازنة بناءً على المدخلات الجديدة
 */
function calculateBudgetScenario() {
    const resultsContainer = document.getElementById('budgetLabResults');
    const data = getData();

    // --- 1. قراءة الافتراضات من المؤشرات ---
    const blockQtyGrowth = parseFloat(document.getElementById('blockQtyGrowth').value) / 100;
    const concreteQtyGrowth = parseFloat(document.getElementById('concreteQtyGrowth').value) / 100;
    const cogsInflation = parseFloat(document.getElementById('cogsInflation').value) / 100;
    const fixedCostGrowth = parseFloat(document.getElementById('fixedCostGrowth').value) / 100;

    // تحديث العناوين بجانب المؤشرات
    document.getElementById('blockQtyLabel').textContent = `${(blockQtyGrowth * 100).toFixed(0)}%`;
    document.getElementById('concreteQtyLabel').textContent = `${(concreteQtyGrowth * 100).toFixed(0)}%`;
    document.getElementById('cogsInflationLabel').textContent = `${(cogsInflation * 100).toFixed(0)}%`;
    document.getElementById('fixedCostGrowthLabel').textContent = `${(fixedCostGrowth * 100).toFixed(0)}%`;

    // --- 2. حساب القيم الأساسية من بيانات العام الحالي ---
    const baseBlockRevenue = Math.abs(data.categorized.revenue.find(acc => acc.name.toLowerCase().includes("بلوك"))?.finalBalance || 0);
    const baseConcreteRevenue = Math.abs(data.categorized.revenue.find(acc => acc.name.toLowerCase().includes("خرسانة"))?.finalBalance || 0);
    const baseTotalRevenue = baseBlockRevenue + baseConcreteRevenue;
    const baseCogs = data.cogs;
    const baseFixedCosts = data.operatingExpenses + data.depreciationExpense;

    // --- 3. حساب قيم الموازنة الجديدة ---
    const newBlockRevenue = baseBlockRevenue * (1 + blockQtyGrowth);
    const newConcreteRevenue = baseConcreteRevenue * (1 + concreteQtyGrowth);
    const newTotalRevenue = newBlockRevenue + newConcreteRevenue;
    const newCogs = baseCogs * (1 + cogsInflation);
    const newFixedCosts = baseFixedCosts * (1 + fixedCostGrowth);
    const newGrossProfit = newTotalRevenue - newCogs;
    const newNetProfit = newGrossProfit - newFixedCosts + data.otherIncome;

    // --- 4. بناء جدول النتائج ---
    resultsContainer.innerHTML = `
        <table class="table table-striped table-hover mb-0">
            <thead class="table-dark">
                <tr>
                    <th>البند</th>
                    <th class="text-end">الأداء الفعلي الحالي</th>
                    <th class="text-end">الموازنة المقترحة</th>
                    <th class="text-end">التغير %</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>الإيرادات</td>
                    <td class="text-end">${formatCurrency(baseTotalRevenue)}</td>
                    <td class="text-end fw-bold">${formatCurrency(newTotalRevenue)}</td>
                    <td class="text-end text-success">+${((newTotalRevenue / baseTotalRevenue - 1) * 100).toFixed(1)}%</td>
                </tr>
                <tr>
                    <td>تكلفة المبيعات</td>
                    <td class="text-end">${formatCurrency(baseCogs)}</td>
                    <td class="text-end fw-bold">${formatCurrency(newCogs)}</td>
                    <td class="text-end text-danger">+${((newCogs / baseCogs - 1) * 100).toFixed(1)}%</td>
                </tr>
                <tr class="table-primary">
                    <td><strong>مجمل الربح</strong></td>
                    <td class="text-end"><strong>${formatCurrency(data.grossProfit)}</strong></td>
                    <td class="text-end fw-bold"><strong>${formatCurrency(newGrossProfit)}</strong></td>
                    <td class="text-end ${newGrossProfit > data.grossProfit ? 'text-success' : 'text-danger'}">${((newGrossProfit / data.grossProfit - 1) * 100).toFixed(1)}%</td>
                </tr>
                <tr>
                    <td>المصروفات الثابتة</td>
                    <td class="text-end">${formatCurrency(baseFixedCosts)}</td>
                    <td class="text-end fw-bold">${formatCurrency(newFixedCosts)}</td>
                    <td class="text-end text-danger">+${((newFixedCosts / baseFixedCosts - 1) * 100).toFixed(1)}%</td>
                </tr>
                <tr class="table-success">
                    <td><strong>صافي الربح المتوقع</strong></td>
                    <td class="text-end"><strong>${formatCurrency(data.netIncome)}</strong></td>
                    <td class="text-end fw-bold"><strong>${formatCurrency(newNetProfit)}</strong></td>
                    <td class="text-end ${newNetProfit > data.netIncome ? 'text-success' : 'text-danger'}">${((newNetProfit / data.netIncome - 1) * 100).toFixed(1)}%</td>
                </tr>
            </tbody>
        </table>
    `;
}
// ==================================================================
// --- END: مختبر الموازنة التفاعلي (V3) ---
// ==================================================================
// ==================================================================
// --- END: تقرير إعداد الموازنة (V2) ---
// ==================================================================

// 2️⃣ مقارنة الموازنة بالفعلي
// ==================================================================
// --- START: لوحة مراقبة الأداء المالي (V3) ---
// ==================================================================
function generateBudgetComparison(data) {
    // --- 1. إعداد البيانات ---
    // الموازنة الافتراضية
    const budget = {
        revenue: data.revenue * 1.10,
        cogs: data.cogs * 1.08,
        operatingExpenses: data.operatingExpenses * 1.05,
        netIncome: (data.revenue * 1.10) - (data.cogs * 1.08) - (data.operatingExpenses * 1.05)
    };

    // بيانات العام السابق (من أرصدة أول المدة للحسابات الحالية)
    const priorYear = {
        revenue: Math.abs(data.categorized.revenue.reduce((sum, acc) => sum + ((acc.ob_debit || 0) - (acc.ob_credit || 0)), 0)),
        cogs: data.categorized.cogs.reduce((sum, acc) => sum + ((acc.ob_debit || 0) - (acc.ob_credit || 0)), 0),
        operatingExpenses: data.categorized.operatingExpenses.reduce((sum, acc) => sum + ((acc.ob_debit || 0) - (acc.ob_credit || 0)), 0),
    };
    priorYear.netIncome = priorYear.revenue - priorYear.cogs - priorYear.operatingExpenses;

    // --- 2. دالة مساعدة لإنشاء صف في الجدول ---
    const createRow = (label, actual, budget, prior) => {
        const varianceVsBudget = actual - budget;
        const varianceVsPrior = actual - prior;
        const pctVsBudget = budget !== 0 ? (varianceVsBudget / Math.abs(budget) * 100) : 0;
        const pctVsPrior = prior !== 0 ? (varianceVsPrior / Math.abs(prior) * 100) : 0;

        // تحديد إذا كان الانحراف إيجابيًا أم سلبيًا (للألوان)
        const isGoodVsBudget = label.includes('إيراد') || label.includes('ربح') ? varianceVsBudget >= 0 : varianceVsBudget <= 0;
        const isGoodVsPrior = label.includes('إيراد') || label.includes('ربح') ? varianceVsPrior >= 0 : varianceVsPrior <= 0;

        return `
            <tr>
                <td><strong>${label}</strong></td>
                <td class="text-end fw-bold">${formatCurrency(actual)}</td>
                <td class="text-end">${formatCurrency(budget)}</td>
                <td class="text-end ${isGoodVsBudget ? 'text-success' : 'text-danger'}">
                    ${formatCurrency(varianceVsBudget)} (${pctVsBudget.toFixed(1)}%)
                </td>
                <td class="text-end">${formatCurrency(prior)}</td>
                <td class="text-end ${isGoodVsPrior ? 'text-success' : 'text-danger'}">
                    ${formatCurrency(varianceVsPrior)} (${pctVsPrior.toFixed(1)}%)
                </td>
            </tr>
        `;
    };

    // --- 3. بناء واجهة العرض ---
    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-tachometer-alt me-2"></i>لوحة مراقبة الأداء المالي</h4>
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                تقارن هذه اللوحة أداءك الفعلي مع الموازنة التقديرية وأداء العام السابق لتمنحك رؤية شاملة.
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th rowspan="2" class="align-middle">البند</th>
                            <th colspan="3" class="text-center">مقارنة مع الموازنة</th>
                            <th colspan="2" class="text-center">مقارنة مع العام السابق</th>
                        </tr>
                        <tr>
                            <th class="text-end">الفعلي</th>
                            <th class="text-end">الموازنة</th>
                            <th class="text-end">الانحراف</th>
                            <th class="text-end">العام السابق</th>
                            <th class="text-end">الانحراف (النمو)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${createRow('الإيرادات', data.revenue, budget.revenue, priorYear.revenue)}
                        ${createRow('تكلفة المبيعات', data.cogs, budget.cogs, priorYear.cogs)}
                        <tr class="table-primary">${createRow('<strong>مجمل الربح</strong>', data.grossProfit, budget.revenue - budget.cogs, priorYear.revenue - priorYear.cogs)}</tr>
                        ${createRow('المصروفات التشغيلية', data.operatingExpenses, budget.operatingExpenses, priorYear.operatingExpenses)}
                        <tr class="table-success">${createRow('<strong>صافي الربح</strong>', data.netIncome, budget.netIncome, priorYear.netIncome)}</tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;
}
// ==================================================================
// --- END: لوحة مراقبة الأداء المالي (V3) ---
// ==================================================================

// 3️⃣ تحديث الموازنة
function generateBudgetUpdate(data) {
    return `
        <div class="report-container">
            <h2 class="text-center mb-4"><i class="fas fa-sync-alt"></i> تحديث الموازنة</h2>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> يمكنك تعديل الموازنة بناءً على المستجدات والتغيرات في السوق
            </div>
            
            <div class="card bg-dark border-primary">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-edit"></i> تعديل بنود الموازنة</h5>
                </div>
                <div class="p-3">
                    <form id="budgetUpdateForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">الإيرادات المقدرة</label>
                                <input type="number" class="form-control" value="${(data.revenue * 1.1).toFixed(2)}" id="budgetRevenue">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">تكلفة المبيعات المقدرة</label>
                                <input type="number" class="form-control" value="${(data.cogs * 1.05).toFixed(2)}" id="budgetCOGS">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">المصروفات التشغيلية المقدرة</label>
                                <input type="number" class="form-control" value="${(data.operatingExpenses * 1.03).toFixed(2)}" id="budgetOpex">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">الإهلاك المقدر</label>
                                <input type="number" class="form-control" value="${(data.depreciationExpense || 0).toFixed(2)}" id="budgetDepr">
                            </div>
                        </div>
                        <button type="button" class="btn btn-success" onclick="updateBudget()">
                            <i class="fas fa-save"></i> حفظ التحديثات
                        </button>
                    </form>
                </div>
            </div>
            
            <div class="card bg-dark border-success mt-4">
                <div class="card-header bg-success text-white">
                    <h5><i class="fas fa-history"></i> سجل التعديلات</h5>
                </div>
                <div class="p-3">
                    <table class="table table-dark table-striped">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>البند</th>
                                <th>القيمة القديمة</th>
                                <th>القيمة الجديدة</th>
                                <th>المستخدم</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${new Date().toLocaleDateString('ar-SA')}</td>
                                <td>الإيرادات</td>
                                <td>${formatCurrency(data.revenue)}</td>
                                <td>${formatCurrency(data.revenue * 1.1)}</td>
                                <td>المدير المالي</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <script>
            function updateBudget() {
                alert('تم حفظ التحديثات بنجاح!');
            }
        <\/script>
    `;
}

// 4️⃣ تحليل الموازنة
// ==================================================================
// --- START: محلل هيكل التكاليف (V3 - نسخة واقعية) ---
// ==================================================================
function generateBudgetAnalysis(data) {
    // --- 1. حساب النسب الحقيقية من البيانات المتاحة ---
    const totalRevenue = data.revenue;
    const cogsRatio = totalRevenue > 0 ? (data.cogs / totalRevenue) * 100 : 0;
    
    // فصل الرواتب عن باقي المصاريف للتحليل
    const salaries = data.categorized.operatingExpenses
        .filter(acc => acc.name.toLowerCase().includes('راتب') || acc.name.toLowerCase().includes('اجور'))
        .reduce((sum, acc) => sum + Math.abs(acc.finalBalance), 0);
    
    const otherOperatingExpenses = data.operatingExpenses - salaries;
    
    const salariesRatio = totalRevenue > 0 ? (salaries / totalRevenue) * 100 : 0;
    const opexRatio = totalRevenue > 0 ? (otherOperatingExpenses / totalRevenue) * 100 : 0;
    const netProfitRatio = totalRevenue > 0 ? (data.netIncome / totalRevenue) * 100 : 0;

    // --- 2. بناء واجهة العرض التحليلية ---
    const finalHTML = `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-search-dollar me-2"></i>محلل هيكل التكاليف والربحية</h4>
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                هذا التقرير يحلل أين يذهب كل ريال من إيراداتك، ويساعدك على فهم هيكل التكاليف الحالي.
            </div>

            <div class="row">
                <!-- جدول التحليل -->
                <div class="col-md-7 mb-4">
                    <div class="card bg-dark border-primary h-100">
                        <div class="card-header"><h5><i class="fas fa-percentage me-2"></i>تحليل الإيرادات (لكل 100 ريال)</h5></div>
                        <div class="p-3">
                            <table class="table table-sm table-borderless">
                                <tr><td>إجمالي الإيرادات</td><td class="text-end fw-bold">${formatCurrency(100)}</td></tr>
                                <tr class="text-danger"><td>(-) تكلفة المبيعات (COGS)</td><td class="text-end">(${formatCurrency(cogsRatio)})</td></tr>
                                <tr class="table-primary"><td><strong>= هامش الربح الإجمالي</strong></td><td class="text-end"><strong>${formatCurrency(100 - cogsRatio)}</strong></td></tr>
                                <tr class="text-danger"><td>(-) الرواتب والأجور</td><td class="text-end">(${formatCurrency(salariesRatio)})</td></tr>
                                <tr class="text-danger"><td>(-) باقي المصاريف التشغيلية</td><td class="text-end">(${formatCurrency(opexRatio)})</td></tr>
                                <tr class="table-success"><td><strong>= صافي هامش الربح</strong></td><td class="text-end"><strong>${formatCurrency(netProfitRatio)}</strong></td></tr>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- الرسم البياني -->
                <div class="col-md-5 mb-4">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="costStructureChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-success">
                <h5 class="alert-heading"><i class="fas fa-lightbulb me-2"></i>توصيات ذكية بناءً على هيكلك الحالي:</h5>
                <ul>
                    <li>مقابل كل 100 ريال من المبيعات، يتبقى لك <strong>${formatCurrency(100 - cogsRatio)}</strong> كهامش ربح إجمالي لتغطية باقي مصاريفك.</li>
                    <li>تكلفة المبيعات هي أكبر مستهلك لإيراداتك بنسبة <strong>${cogsRatio.toFixed(1)}%</strong>. أي تحسين في هذه النسبة (عبر التفاوض مع الموردين أو تقليل الهدر) سينعكس مباشرة على صافي الربح.</li>
                    <li>بعد تغطية كل التكاليف، يتبقى لك <strong>${formatCurrency(netProfitRatio)}</strong> كصافي ربح من كل 100 ريال مبيعات.</li>
                </ul>
            </div>
        </div>
    `;

    // --- 3. تشغيل كود الرسم البياني ---
    setTimeout(() => {
        const ctx = document.getElementById('costStructureChart')?.getContext('2d');
        if (ctx) {
            if (window.costStructureChartInstance) window.costStructureChartInstance.destroy();
            window.costStructureChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['تكلفة المبيعات', 'الرواتب', 'مصاريف تشغيلية أخرى', 'صافي الربح'],
                    datasets: [{
                        data: [data.cogs, salaries, otherOperatingExpenses, data.netIncome > 0 ? data.netIncome : 0],
                        backgroundColor: ['#dc3545', '#007bff', '#ffc107', '#28a745']
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: true, position: 'top', labels: { color: 'var(--color-text-primary)' } },
                        title: { display: true, text: 'أين يذهب كل ريال من الإيرادات؟', color: 'var(--color-text-primary)' }
                    }
                }
            });
        }
    }, 100);

    return finalHTML;
}
// ==================================================================
// --- END: محلل هيكل التكاليف (V3) ---
// ==================================================================

// ========================================
// قسم التنبؤات (Forecasting) - 4 تقارير
// ========================================

// 1️⃣ تنبؤ الإيرادات
// ==================================================================
// --- START: تقرير تنبؤ الإيرادات (V2 - مختبر التوقعات) ---
// ==================================================================
function generateRevenueForecast(data) {
    // ربط المؤشرات بدالة إعادة الحساب
    setTimeout(() => {
        document.getElementById('growthRateInput').addEventListener('input', calculateRevenueForecast);
        document.getElementById('seasonalityFactorInput').addEventListener('input', calculateRevenueForecast);
        calculateRevenueForecast(); // الحساب الأولي
    }, 100);

    // بناء الواجهة التفاعلية
    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-chart-line me-2"></i>مختبر توقعات الإيرادات (12 شهرًا)</h4>
            
            <div class="card bg-dark border-primary mb-4">
                <div class="card-header"><h5><i class="fas fa-sliders-h me-2"></i>لوحة التحكم بالافتراضات</h5></div>
                <div class="p-3">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">متوسط معدل النمو الشهري (%): <span id="growthRateLabel" class="badge bg-primary">2%</span></label>
                            <input type="range" class="form-range" id="growthRateInput" value="2" min="-5" max="15" step="0.5">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">عامل التقلب الموسمي (%): <span id="seasonalityLabel" class="badge bg-primary">10%</span></label>
                            <input type="range" class="form-range" id="seasonalityFactorInput" value="10" min="0" max="50" step="5">
                        </div>
                    </div>
                </div>
            </div>

            <div id="forecastResults">
                <div class="text-center p-5"><div class="loading-spinner"></div></div>
            </div>
        </div>
    `;
}

/**
 * دالة ذكية: تعيد حساب توقعات الإيرادات بناءً على مدخلات المستخدم
 */
function calculateRevenueForecast() {
    const resultsContainer = document.getElementById('forecastResults');
    const data = getData();

    // 1. قراءة الافتراضات من المؤشرات
    const growthRate = parseFloat(document.getElementById('growthRateInput').value) / 100;
    const seasonalityFactor = parseFloat(document.getElementById('seasonalityFactorInput').value) / 100;
    document.getElementById('growthRateLabel').textContent = `${(growthRate * 100).toFixed(1)}%`;
    document.getElementById('seasonalityLabel').textContent = `${(seasonalityFactor * 100).toFixed(0)}%`;

    // 2. حساب التوقعات
    const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
    const baseMonthlyRevenue = data.revenue / 12;
    const forecast = { base: [], high: [], low: [] };

    for (let i = 0; i < 12; i++) {
        const trendValue = baseMonthlyRevenue * Math.pow(1 + growthRate, i + 1);
        forecast.base.push(trendValue);
        forecast.high.push(trendValue * (1 + seasonalityFactor));
        forecast.low.push(trendValue * (1 - seasonalityFactor));
    }

    const totalBase = forecast.base.reduce((a, b) => a + b, 0);
    const totalHigh = forecast.high.reduce((a, b) => a + b, 0);
    const totalLow = forecast.low.reduce((a, b) => a + b, 0);

    // 3. بناء واجهة النتائج
    resultsContainer.innerHTML = `
        <div class="row mb-4">
            <div class="col-md-4"><div class="stats-card border-danger"><h6>السيناريو المتحفظ</h6><h3 class="text-danger">${formatCurrency(totalLow)}</h3></div></div>
            <div class="col-md-4"><div class="stats-card border-primary"><h6>السيناريو الأساسي</h6><h3 class="text-primary">${formatCurrency(totalBase)}</h3></div></div>
            <div class="col-md-4"><div class="stats-card border-success"><h6>السيناريو المتفائل</h6><h3 class="text-success">${formatCurrency(totalHigh)}</h3></div></div>
        </div>
        <div class="chart-container" style="height: 300px;">
            <canvas id="revenueForecastChart"></canvas>
        </div>
    `;

    // 4. رسم المخطط البياني
    const ctx = document.getElementById('revenueForecastChart')?.getContext('2d');
    if (ctx) {
        if (window.revenueForecastChartInstance) window.revenueForecastChartInstance.destroy();
        window.revenueForecastChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [
                    { label: 'السيناريو المتفائل', data: forecast.high, borderColor: 'rgba(40, 167, 69, 0.8)', tension: 0.3 },
                    { label: 'السيناريو الأساسي', data: forecast.base, borderColor: 'rgba(0, 170, 255, 1)', tension: 0.3, borderWidth: 3 },
                    { label: 'السيناريو المتحفظ', data: forecast.low, borderColor: 'rgba(220, 53, 69, 0.8)', tension: 0.3 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: 'var(--color-text-primary)' } } } }
        });
    }
}
// ==================================================================
// --- END: تقرير تنبؤ الإيرادات (V2) ---
// ==================================================================

// 2️⃣ تنبؤ التدفقات النقدية
// ==================================================================
// --- START: مختبر السيولة التفاعلي (V2) ---
// ==================================================================
function generateCashFlowForecast(data) {
    // --- الخطوة 1: بناء الواجهة التفاعلية ---
    setTimeout(() => {
        document.getElementById('collectionPeriodInput').addEventListener('input', calculateCashFlowForecast);
        document.getElementById('paymentPeriodInput').addEventListener('input', calculateCashFlowForecast);
        document.getElementById('minCashBalanceInput').addEventListener('input', calculateCashFlowForecast);
        calculateCashFlowForecast(); // الحساب الأولي
    }, 100);

    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-water me-2"></i>مختبر توقعات السيولة (12 شهرًا)</h4>
            
            <div class="card bg-dark border-primary mb-4">
                <div class="card-header"><h5><i class="fas fa-sliders-h me-2"></i>لوحة التحكم بالدورة النقدية</h5></div>
                <div class="p-3">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">متوسط فترة التحصيل (يوم): <span id="collectionLabel" class="badge bg-primary">45</span></label>
                            <input type="range" class="form-range" id="collectionPeriodInput" value="45" min="15" max="120" step="5">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">متوسط فترة السداد (يوم): <span id="paymentLabel" class="badge bg-primary">30</span></label>
                            <input type="range" class="form-range" id="paymentPeriodInput" value="30" min="10" max="90" step="5">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">رصيد النقد الأدنى المطلوب: <span id="minCashLabel" class="badge bg-danger">0</span></label>
                            <input type="range" class="form-range" id="minCashBalanceInput" value="0" min="0" max="1000000" step="50000">
                        </div>
                    </div>
                </div>
            </div>

            <div id="cashFlowResults">
                <div class="text-center p-5"><div class="loading-spinner"></div></div>
            </div>
        </div>
    `;
}

/**
 * دالة ذكية: تعيد حساب توقعات التدفق النقدي بناءً على المدخلات
 */
function calculateCashFlowForecast() {
    const resultsContainer = document.getElementById('cashFlowResults');
    const data = getData();

    // 1. قراءة الافتراضات من المؤشرات
    const collectionPeriod = parseInt(document.getElementById('collectionPeriodInput').value);
    const paymentPeriod = parseInt(document.getElementById('paymentPeriodInput').value);
    const minCashBalance = parseInt(document.getElementById('minCashBalanceInput').value);
    document.getElementById('collectionLabel').textContent = collectionPeriod;
    document.getElementById('paymentLabel').textContent = paymentPeriod;
    document.getElementById('minCashLabel').textContent = formatCurrency(minCashBalance);

    // 2. حساب التدفقات الشهرية
    const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
    const monthlyRevenue = data.revenue / 12;
    const monthlyCosts = (data.cogs + data.operatingExpenses) / 12;
    
    let cashBalance = data.categorized.currentAssets.find(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'cash')?.finalBalance || 0;
    let forecast = [];
    let lowestBalance = cashBalance;
    let deficitMonths = [];

    for (let i = 0; i < 12; i++) {
        // التدفقات الداخلة (نفترض تحصيل مبيعات الشهر السابق)
        const cashIn = (i === 0) ? monthlyRevenue : monthlyRevenue * (30 / collectionPeriod);
        // التدفقات الخارجة (نفترض دفع تكاليف الشهر السابق)
        const cashOut = (i === 0) ? monthlyCosts : monthlyCosts * (30 / paymentPeriod);
        
        const netCashFlow = cashIn - cashOut;
        cashBalance += netCashFlow;
        
        if (cashBalance < lowestBalance) lowestBalance = cashBalance;
        if (cashBalance < minCashBalance) deficitMonths.push(months[i]);

        forecast.push({
            month: months[i],
            opening: cashBalance - netCashFlow,
            inflow: cashIn,
            outflow: cashOut,
            net: netCashFlow,
            closing: cashBalance
        });
    }

    // 3. بناء واجهة النتائج
    resultsContainer.innerHTML = `
        <div class="row mb-4">
            <div class="col-md-4"><div class="stats-card"><p>الرصيد النقدي الحالي</p><h3>${formatCurrency(forecast[0].opening)}</h3></div></div>
            <div class="col-md-4"><div class="stats-card ${lowestBalance < minCashBalance ? 'border-danger' : 'border-warning'}"><p>أدنى رصيد متوقع</p><h3 class="${lowestBalance < minCashBalance ? 'text-danger' : 'text-warning'}">${formatCurrency(lowestBalance)}</h3></div></div>
            <div class="col-md-4"><div class="stats-card"><p>الرصيد المتوقع نهاية العام</p><h3>${formatCurrency(forecast[11].closing)}</h3></div></div>
        </div>
        
        ${deficitMonths.length > 0 ? `<div class="alert alert-danger"><strong>تحذير سيولة!</strong> من المتوقع أن ينخفض رصيدك عن الحد الأدنى المطلوب في أشهر: ${deficitMonths.join(', ')}.</div>` : '<div class="alert alert-success"><strong>وضع السيولة آمن.</strong> لا يوجد عجز متوقع في السيولة خلال الـ 12 شهرًا القادمة بناءً على هذه الافتراضات.</div>'}

        <div class="chart-container" style="height: 350px;">
            <canvas id="cashFlowForecastChart"></canvas>
        </div>
    `;

    // 4. رسم المخطط البياني
    const ctx = document.getElementById('cashFlowForecastChart')?.getContext('2d');
    if (ctx) {
        if (window.cashFlowChartInstance) window.cashFlowChartInstance.destroy();
        window.cashFlowChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'الرصيد النقدي المتوقع',
                    data: forecast.map(f => f.closing),
                    borderColor: 'rgba(0, 170, 255, 1)',
                    backgroundColor: 'rgba(0, 170, 255, 0.2)',
                    fill: true,
                    tension: 0.3
                }, {
                    label: 'الحد الأدنى المطلوب',
                    data: Array(12).fill(minCashBalance),
                    borderColor: 'rgba(220, 53, 69, 1)',
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: 'var(--color-text-primary)' } } } }
        });
    }
}
// ==================================================================
// --- END: مختبر السيولة التفاعلي (V2) ---
// ==================================================================

// 3️⃣ سيناريوهات متعددة
// ==================================================================
// --- START: مولّد السيناريوهات الاستراتيجية (V2) ---
// ==================================================================
// ==================================================================
// --- START: ورشة العمل الاستراتيجية (V3 - تفاعلية بالكامل) ---
// ==================================================================


// الدالة الرئيسية التي تبني الواجهة
function generateMultipleScenarios(data) {
    // تهيئة النافذة المنبثقة لأول مرة
    setTimeout(() => {
        if (!scenarioBuilderModal) {
            scenarioBuilderModal = new bootstrap.Modal(document.getElementById('scenarioBuilderModal'));
        }
        // ربط المؤشرات في النافذة بتحديث العناوين
        document.querySelectorAll('#scenarioInputs input[type="range"]').forEach(input => {
            input.addEventListener('input', updateModalLabels);
        });
        // عرض السيناريوهات الحالية
        renderScenarioResults();
    }, 100);

    // بناء الواجهة الأساسية للتقرير
    return `
        <div class="p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0"><i class="fas fa-sitemap me-2"></i>ورشة العمل الاستراتيجية</h4>
                <button class="btn btn-success" onclick="openScenarioBuilder()"><i class="fas fa-plus me-2"></i>إنشاء سيناريو جديد</button>
            </div>
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                قم ببناء سيناريوهات متعددة (توسع، تخفيضات، ارتفاع تكاليف...) وقارن تأثيرها المالي على صافي الربح.
            </div>

            <div id="scenarioResultsContainer">
                <!-- سيتم ملء النتائج هنا بواسطة JavaScript -->
            </div>
        </div>
    `;
}

// دالة لفتح نافذة بناء السيناريو
function openScenarioBuilder(index = -1) {
    const modalLabel = document.getElementById('scenarioBuilderModalLabel');
    document.getElementById('editingScenarioIndex').value = index;
    
    if (index > -1) { // وضع التعديل
        modalLabel.textContent = 'تعديل السيناريو الاستراتيجي';
        const scenario = userScenarios[index];
        document.getElementById('scenarioNameInput').value = scenario.name;
        document.getElementById('modal_blockQtyChange').value = scenario.assumptions.blockQtyChange * 100;
        document.getElementById('modal_concretePriceChange').value = scenario.assumptions.concretePriceChange;
        document.getElementById('modal_vcUnitChange').value = scenario.assumptions.vcUnitChange * 100;
        document.getElementById('modal_fixedCostChange').value = scenario.assumptions.fixedCostChange;
    } else { // وضع الإنشاء
        modalLabel.textContent = 'إنشاء سيناريو استراتيجي جديد';
        document.getElementById('scenarioNameInput').value = '';
        document.getElementById('scenarioBuilderModal').querySelector('form')?.reset(); // إعادة تعيين النموذج
    }
    updateModalLabels();
    scenarioBuilderModal.show();
}

// دالة لحفظ السيناريو (جديد أو معدل)
function saveScenario() {
    const name = document.getElementById('scenarioNameInput').value.trim();
    if (!name) {
        alert('الرجاء إدخال اسم للسيناريو.');
        return;
    }

    const assumptions = {
        blockQtyChange: parseFloat(document.getElementById('modal_blockQtyChange').value) / 100,
        concretePriceChange: parseFloat(document.getElementById('modal_concretePriceChange').value),
        vcUnitChange: parseFloat(document.getElementById('modal_vcUnitChange').value) / 100,
        fixedCostChange: parseFloat(document.getElementById('modal_fixedCostChange').value)
    };

    const index = parseInt(document.getElementById('editingScenarioIndex').value);
    if (index > -1) { // تحديث سيناريو موجود
        userScenarios[index].name = name;
        userScenarios[index].assumptions = assumptions;
    } else { // إضافة سيناريو جديد
        userScenarios.push({ name, assumptions });
    }

    renderScenarioResults();
    scenarioBuilderModal.hide();
}

// دالة لحذف سيناريو
function deleteScenario(index) {
    if (confirm(`هل أنت متأكد من حذف سيناريو "${userScenarios[index].name}"؟`)) {
        userScenarios.splice(index, 1);
        renderScenarioResults();
    }
}

// دالة تحديث العناوين داخل النافذة
function updateModalLabels() {
    document.getElementById('modal_blockQtyLabel').textContent = `${document.getElementById('modal_blockQtyChange').value}%`;
    document.getElementById('modal_concretePriceLabel').textContent = `${document.getElementById('modal_concretePriceChange').value >= 0 ? '+' : ''}${document.getElementById('modal_concretePriceChange').value} ريال`;
    document.getElementById('modal_vcUnitLabel').textContent = `${document.getElementById('modal_vcUnitChange').value}%`;
    document.getElementById('modal_fixedCostLabel').textContent = `${document.getElementById('modal_fixedCostChange').value >= 0 ? '+' : ''}${formatCurrency(document.getElementById('modal_fixedCostChange').value)}`;
}

// الدالة المركزية التي تعيد حساب كل شيء وتعرضه
function renderScenarioResults() {
    const resultsContainer = document.getElementById('scenarioResultsContainer');
    const data = getData();
    const baseNetProfit = data.netIncome;

    const results = userScenarios.map(scenario => {
        const assumptions = scenario.assumptions;
        // نفس منطق الحساب من تقرير "ماذا لو"
        const baseBlockRevenue = Math.abs(data.categorized.revenue.find(acc => acc.name.toLowerCase().includes("بلوك"))?.finalBalance || 0);
        const baseTotalRevenue = data.revenue;
        const baseTotalVC = data.cogs;
        const baseFixedCosts = data.operatingExpenses + data.depreciationExpense;
        const baseBlockPrice = 1.60;
        const baseConcretePrice = 180;
        const baseBlockUnits = baseBlockPrice > 0 ? baseBlockRevenue / baseBlockPrice : 0;
        const baseConcreteUnits = baseConcretePrice > 0 ? (baseTotalRevenue - baseBlockRevenue) / baseConcretePrice : 0;
        const baseVCUnit_Block = baseBlockUnits > 0 ? (baseTotalVC * (baseBlockRevenue / baseTotalRevenue)) / baseBlockUnits : 0;
        const baseVCUnit_Concrete = baseConcreteUnits > 0 ? (baseTotalVC * (1 - (baseBlockRevenue / baseTotalRevenue))) / baseConcreteUnits : 0;

        const newBlockUnits = baseBlockUnits * (1 + assumptions.blockQtyChange);
        const newConcretePrice = baseConcretePrice + assumptions.concretePriceChange;
        const newVCUnit_Block = baseVCUnit_Block * (1 + assumptions.vcUnitChange);
        const newVCUnit_Concrete = baseVCUnit_Concrete * (1 + assumptions.vcUnitChange);
        const newFixedCosts = baseFixedCosts + assumptions.fixedCostChange;

        const newBlockRevenue = newBlockUnits * baseBlockPrice;
        const newConcreteRevenue = baseConcreteUnits * newConcretePrice;
        const newTotalRevenue = newBlockRevenue + newConcreteRevenue;
        const newTotalVC = (newBlockUnits * newVCUnit_Block) + (baseConcreteUnits * newVCUnit_Concrete);
        const newNetProfit = newTotalRevenue - newTotalVC - newFixedCosts;
        
        return { name: scenario.name, netProfit: newNetProfit };
    });

    let tableHTML = `
        <div class="card bg-dark border-primary">
            <div class="card-header"><h5><i class="fas fa-poll me-2"></i>مقارنة صافي الربح المتوقع</h5></div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>السيناريو</th>
                            <th class="text-end">صافي الربح المتوقع</th>
                            <th class="text-end">التأثير على الربح</th>
                            <th class="text-end">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="table-secondary">
                            <td><strong>الوضع الحالي (الأساس)</strong></td>
                            <td class="text-end"><strong>${formatCurrency(baseNetProfit)}</strong></td>
                            <td class="text-end">--</td>
                            <td class="text-end">--</td>
                        </tr>
                        ${results.map((res, index) => {
                            const impact = res.netProfit - baseNetProfit;
                            return `
                                <tr>
                                    <td><i class="fas fa-circle me-2" style="color:hsl(${index * 60}, 70%, 50%);"></i>${res.name}</td>
                                    <td class="text-end">${formatCurrency(res.netProfit)}</td>
                                    <td class="text-end ${impact >= 0 ? 'text-success' : 'text-danger'}">${impact >= 0 ? '+' : ''}${formatCurrency(impact)}</td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-outline-warning" onclick="openScenarioBuilder(${index})"><i class="fas fa-edit"></i></button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteScenario(${index})"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="chart-container mt-4"><canvas id="scenarioComparisonChart"></canvas></div>
    `;
    resultsContainer.innerHTML = tableHTML;

    // رسم المخطط البياني
    const ctx = document.getElementById('scenarioComparisonChart')?.getContext('2d');
    if (ctx) {
        if (window.scenarioChartInstance) window.scenarioChartInstance.destroy();
        window.scenarioChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['الوضع الحالي', ...results.map(r => r.name)],
                datasets: [{
                    label: 'صافي الربح المتوقع',
                    data: [baseNetProfit, ...results.map(r => r.netProfit)],
                    backgroundColor: ['rgba(0, 123, 255, 0.7)', ...results.map((r, i) => `hsla(${i * 60}, 70%, 50%, 0.7)`)]
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }
}
// ==================================================================
// --- END: ورشة العمل الاستراتيجية (V3) ---
// ==================================================================
// ==================================================================
// --- END: مولّد السيناريوهات الاستراتيجية (V2) ---
// ==================================================================

// 4️⃣ تنبؤ ذكي AI
// ==================================================================
// --- START: لوحة التشخيص المالي 360 درجة (V3.1 - مصقولة) ---
// ==================================================================
// ==================================================================
// --- START: لوحة التشخيص المالي التعليمية (V5 - النسخة النهائية) ---
// ==================================================================
function generateAIForecast(data) {
    // --- 1. حساب النسب الرئيسية (لا تغيير) ---
    const netProfitMargin = data.revenue > 0 ? (data.netIncome / data.revenue) * 100 : 0;
    const currentRatio = data.currentLiabilities > 0 ? data.currentAssets / data.currentLiabilities : 0;
    const debtToEquity = data.equity > 0 ? data.liabilities / data.equity : 0;
    const assetTurnover = data.assets > 0 ? data.revenue / data.assets : 0;

    // --- 2. دالة التقييم الموحدة (لا تغيير) ---
    const getRating = (value, thresholds, isLowerBetter = false) => {
        if (isLowerBetter) {
            if (value <= thresholds.good) return { label: "ممتاز", color: "success", icon: "fa-check-circle" };
            if (value <= thresholds.warn) return { label: "جيد", color: "info", icon: "fa-thumbs-up" };
            return { label: "يحتاج تحسين", color: "danger", icon: "fa-exclamation-triangle" };
        } else {
            if (value >= thresholds.good) return { label: "ممتاز", color: "success", icon: "fa-check-circle" };
            if (value >= thresholds.warn) return { label: "جيد", color: "info", icon: "fa-thumbs-up" };
            return { label: "يحتاج تحسين", color: "danger", icon: "fa-exclamation-triangle" };
        }
    };

    // --- 3. تقييم كل محور (لا تغيير) ---
    const ratings = {
        profitability: getRating(netProfitMargin, { good: 15, warn: 5 }),
        liquidity: getRating(currentRatio, { good: 2, warn: 1.2 }),
        leverage: getRating(debtToEquity, { good: 0.8, warn: 1.5 }, true),
        efficiency: getRating(assetTurnover, { good: 1.5, warn: 0.8 })
    };

    // --- 4. دالة بناء بطاقة التشخيص (مع إضافة الشرح) ---
    const createDiagnosticCard = (title, value, unit, rating, explanation) => {
        const formattedValue = value < 0 ? `(${(Math.abs(value)).toFixed(1)})` : value.toFixed(1);
        return `
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card bg-dark border-${rating.color} h-100">
                <div class="card-body text-center d-flex flex-column">
                    <i class="fas ${rating.icon} fa-3x text-${rating.color} mb-3"></i>
                    <h6 class="card-title" style="color: var(--color-text-primary) !important;">${title}</h6>
<h3 class="display-6 fw-bold text-${rating.color}">${formattedValue}${unit}</h3>
                    <p class="text-${rating.color} fw-bold mb-2">${rating.label}</p>
                    <!-- *** الإضافة الجديدة هنا *** -->
                    <p class="text-muted small mt-auto">${explanation}</p>
                </div>
            </div>
        </div>
    `;
    };

    // --- 5. تجميع التوصيات (لا تغيير) ---
    let recommendations = [];
    if (ratings.profitability.label === 'يحتاج تحسين') recommendations.push("مراجعة هيكل التسعير والتكاليف لزيادة هوامش الربح.");
    if (ratings.liquidity.label === 'يحتاج تحسين') recommendations.push("تسريع دورة تحصيل الذمم المدينة وإعادة جدولة الدفعات للموردين.");
    if (ratings.leverage.label === 'يحتاج تحسين') recommendations.push("وضع خطة لخفض الديون عبر زيادة الأرباح المحتجزة أو البحث عن تمويل بالأسهم.");
    if (ratings.efficiency.label === 'يحتاج تحسين') recommendations.push("دراسة إمكانية التخلص من الأصول غير المنتجة لتحسين معدل دوران الأصول.");
    if (recommendations.length === 0) recommendations.push("الأداء العام قوي. التركيز الحالي يجب أن يكون على الحفاظ على هذه المعدلات والبحث عن فرص نمو مستدامة.");

    // --- 6. بناء الواجهة النهائية ---
    return `
        <div class="p-4">
            <h4 class="mb-4"><i class="fas fa-robot me-2"></i>لوحة التشخيص المالي 360°</h4>
            <div class="alert alert-primary">
                <i class="fas fa-brain me-2"></i>
                يقوم هذا التقرير بفحص بياناتك المالية تلقائيًا وتقديم تشخيص شامل لأدائك.
            </div>

            <div class="row">
                ${createDiagnosticCard('هامش صافي الربح', netProfitMargin, '%', ratings.profitability, 'يقيس الربح المتبقي من كل ريال مبيعات بعد خصم جميع التكاليف.')}
                ${createDiagnosticCard('نسبة السيولة', currentRatio, 'x', ratings.liquidity, 'تقيس قدرة الشركة على سداد التزاماتها قصيرة الأجل باستخدام أصولها المتداولة.')}
                ${createDiagnosticCard('الديون إلى حقوق الملكية', debtToEquity, 'x', ratings.leverage, 'تقيس مدى اعتماد الشركة على الديون في تمويل عملياتها مقارنة بحقوق الملاك.')}
                ${createDiagnosticCard('معدل دوران الأصول', assetTurnover, 'x', ratings.efficiency, 'يقيس مدى كفاءة الشركة في استخدام أصولها لتوليد الإيرادات.')}
            </div>

            <div class="card bg-dark border-info mt-4">
                <div class="card-header"><h5 style="color: var(--color-text-primary) !important;"><i class="fas fa-tasks me-2"></i>خلاصة التشخيص والتوصيات</h5></div>
                <div class="p-3">
                    <h6 class="text-info">ملخص الوضع:</h6>
                    <p style="color: var(--color-text-primary) !important;">بناءً على تحليل النسب المالية الرئيسية، يظهر أن الشركة تتمتع بـ <strong>${ratings.profitability.label} في الربحية</strong>، ووضع <strong>${ratings.liquidity.label} في السيولة</strong>. هيكل المديونية يعتبر <strong>${ratings.leverage.label}</strong>، بينما كفاءة استخدام الأصول في توليد المبيعات هي <strong>${ratings.efficiency.label}</strong>.</p>
                    <hr>
                    <h6 class="text-info">التوصيات المقترحة:</h6>
                    <ol style="color: var(--color-text-primary) !important;">
                        ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ol>
                </div>
            </div>
        </div>
    `;
}
// ==================================================================
// --- END: لوحة التشخيص المالي التعليمية (V5) ---
// ==================================================================
// ==================================================================
// --- END: لوحة التشخيص المالي 360 درجة (V3.1) ---
// ==================================================================
// ========== Export All Reports (Board Pack) - محسّن ==========
// ==================================================================
// --- START: دوال حزمة التقارير (Board Pack) - النسخة النهائية ---
// ==================================================================

// ==================================================================
// --- START: دالة فتح منشئ التقارير (V3 - مع التحكم بالأقسام) ---
// ==================================================================
function exportAllReports() {
    if (!boardPackModal) {
        boardPackModal = new bootstrap.Modal(document.getElementById('boardPackModal'));
    }

    const reportListContainer = document.getElementById('report-selection-list');
    let reportListHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">قائمة التقارير المتاحة</h5>
            <div>
                <button class="btn btn-sm btn-outline-success" onclick="toggleAllReports(true)">تحديد الكل</button>
                <button class="btn btn-sm btn-outline-danger" onclick="toggleAllReports(false)">إلغاء تحديد الكل</button>
            </div>
        </div>
    `;
    
   document.querySelectorAll('.pantheon-wing').forEach(wing => {
    const wingTitle = wing.querySelector('.wing-title')?.textContent;
    const wingId = wing.dataset.wing;
    
    // هذا هو السطر المعدل. فقط أضفنا الشرط الأخير
    if (!wingTitle || !wingId || wingId === 'quality') return; 

        // *** الإضافة الجديدة: رأس القسم مع زر التحكم ***
        reportListHTML += `
            <div class="d-flex justify-content-between align-items-center bg-dark p-2 rounded mt-3">
                <h6 class="text-primary mb-0">${wingTitle}</h6>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="switch-${wingId}" onchange="toggleWingReports('${wingId}', this.checked)" checked>
                    <label class="form-check-label" for="switch-${wingId}">تحديد القسم</label>
                </div>
            </div>
        `;
        
        wing.querySelectorAll('.report-card').forEach(card => {
            const onclickAttr = card.getAttribute('onclick');
            if (!onclickAttr) return;

            const match = onclickAttr.match(/'([^']+)'/g);
            if (!match || match.length < 2) return;

            const reportId = match[0].replace(/'/g, '');
            const reportTitle = match[1].replace(/'/g, '');
            
            // *** الإضافة الجديدة: إضافة data-wing لكل مربع اختيار ***
            reportListHTML += `
                <div class="form-check ms-3 mt-1">
                    <input class="form-check-input report-checkbox" type="checkbox" value="${reportId}" id="chk-${reportId}" data-title="${reportTitle}" data-wing="${wingId}" checked>
                    <label class="form-check-label" for="chk-${reportId}">
                        ${card.querySelector('h6').innerText}
                    </label>
                </div>
            `;
        });
    });

    reportListContainer.innerHTML = reportListHTML;
    boardPackModal.show();
}
// ==================================================================
// ==================================================================
// --- START: دوال التحكم في اختيار التقارير ---
// ==================================================================
function toggleAllReports(checked) {
    document.querySelectorAll('.report-checkbox').forEach(checkbox => checkbox.checked = checked);
    document.querySelectorAll('[id^="switch-"]').forEach(sw => sw.checked = checked);
}

function toggleWingReports(wingId, checked) {
    document.querySelectorAll(`.report-checkbox[data-wing="${wingId}"]`).forEach(checkbox => checkbox.checked = checked);
}
// ==================================================================
// --- END: دوال التحكم في اختيار التقارير ---
// ==================================================================
// ==================================================================

// المحرك الفعلي الذي يقوم بتجميع وتصدير الحزمة
// ==================================================================
// --- START: المحرك الآمن لتصدير حزمة التقارير (V2) ---
// ==================================================================
// ==================================================================
// --- START: المحرك النهائي والمضمون لتصدير حزمة التقارير (V4) ---
// ==================================================================
// ==================================================================
// --- START: المحرك النهائي والمضمون لتصدير حزمة التقارير (V5) ---
// ==================================================================
// ==================================================================
// --- START: المحرك النهائي لتصدير حزمة التقارير (V7 - عرض التاريخ الخام) ---
// ==================================================================
async function generateAndExportPack() {
    // الخطوات 1 و 2 (لا تغيير هنا)
    if (boardPackModal) {
        boardPackModal.hide();
    }
    document.getElementById('reportModalLabel').textContent = 'حزمة التقارير التنفيذية';
    document.getElementById('reportModalBody').innerHTML = '<div class="text-center p-5"><div class="loading-spinner"></div><p class="mt-3">جاري تجميع التقارير...</p></div>';
    reportModal.show();
    await new Promise(resolve => setTimeout(resolve, 500));

    const selectedReports = [];
    document.querySelectorAll('.report-checkbox:checked').forEach(checkbox => {
        selectedReports.push({
            id: checkbox.value,
            title: checkbox.getAttribute('data-title')
        });
    });

    // الخطوة 3: بناء المحتوى الكامل للتصدير
    let fullHTML = `<div id="board-pack-content">`;
    const data = getData();

    // =======================================================
    // *** الإصلاح الحاسم هنا: عرض التاريخ كما هو بدون تنسيق ***
    // =======================================================
    if (document.getElementById('includeCoverPage').checked) {
        // نقرأ التواريخ مباشرة كنص
        const startDate = data.clientInfo?.startDate;
        const endDate = data.clientInfo?.endDate;

        // نبني النص بناءً على وجود التواريخ
        const periodText = (startDate && endDate) 
            ? `للفترة المالية من ${startDate} إلى ${endDate}`
            : `للفترة المنتهية في 31 ديسمبر ${data.fiscalYear}`;

        fullHTML += `
            <div class="text-center p-5 border-bottom mb-4" style="page-break-after: always;">
                <h1 class="display-4 text-primary">${data.companyName || 'اسم الشركة'}</h1>
                <h2 class="display-5">حزمة التقارير التنفيذية</h2>
                
                <!-- عرض النص النهائي بخط كبير وواضح -->
                <p class="lead mt-3" style="font-size: 1.5rem; color: var(--color-text-primary);">
                    ${periodText}
                </p>
            </div>
        `;
    }
    // =======================================================
    // *** نهاية الإصلاح ***
    // =======================================================

    // باقي الدالة (لا تغيير هنا)
    const summary = document.getElementById('executiveSummary').value;
    if (summary.trim() !== '') {
        fullHTML += `
            <div class="p-3 border-bottom mb-4" style="page-break-after: always;">
                <h4 class="text-primary">ملخص تنفيذي</h4>
                <p style="white-space: pre-wrap;">${summary}</p>
            </div>
        `;
    }

    for (const report of selectedReports) {
        const reportContent = generateReportContent(report.id, report.title, true);
        fullHTML += `
            <div class="p-3 border-bottom mb-4" style="page-break-after: always;">
                <h4 class="text-primary mb-3">${report.title}</h4>
                ${reportContent}
            </div>
        `;
    }

    fullHTML += `</div>`;
    
    document.getElementById('reportModalBody').innerHTML = fullHTML;
}
// ==================================================================
// --- END: المحرك النهائي لتصدير حزمة التقارير (V7) ---
// ==================================================================
// ==================================================================
// --- END: المحرك النهائي والمضمون ---
// ==================================================================
// ==================================================================
// --- END: المحرك النهائي والمضمون ---
// ==================================================================
// ==================================================================
// --- END: المحرك الآمن لتصدير حزمة التقارير ---
// ==================================================================

// ==================================================================
// --- END: دوال حزمة التقارير (Board Pack) ---
// ==================================================================
// ==================================================================
// --- دالة فتح مختبر M-Score الذكي ---
// ==================================================================
// ==================================================================
// --- دالة فتح مختبر M-Score (النسخة النهائية الصحيحة) ---
// ==================================================================
function openMScoreLab() {
    // *** هذا هو الإصلاح الحاسم ***
    // لا نستدعي getData()، بل نستخدم البيانات المحملة مسبقًا في الذاكرة
    const financialData = window.financialData;

    // نتأكد من أن البيانات موجودة بالفعل
    if (!financialData || !financialData.current) {
        alert('خطأ: لا يمكن فتح المختبر. يرجى التأكد من تحميل بيانات العميل أولاً.');
        return;
    }

    // 2. نقوم بتخزين البيانات الحالية في الذاكرة المحلية للمتصفح
    localStorage.setItem('mScoreLab_currentData', JSON.stringify(financialData.current));

    // 3. نفتح صفحة المختبر في نافذة جديدة
    window.open('m_score_lab.html', '_blank');
}
function exportFinalPDF() {
    const element = document.getElementById('board-pack-content') || document.getElementById('reportModalBody');
    const opt = {
        margin: 1,
        filename: `Board_Pack.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, letterRendering: true },
        jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(element).save();
}
// ==================================================================
// --- START: الدالة المفقودة لتشغيل الكود التفاعلي للشريحة ---
// ==================================================================
// ==================================================================
// --- END: الدالة المفقودة ---
// ==================================================================
// ==================================================================
// --- START: دالة التنقل بين الشرائح (النسخة الأصلية البسيطة) ---
// ==================================================================
// ==================================================================



// ==================================================================
// ==================================================================
// ########## START: نظام العرض والتصدير الاحترافي (النهائي) ##########
// ==================================================================

// --- دوال منشئ العرض التقديمي ---
function openPresentationBuilder() {
    if (!presentationBuilderModal) {
        presentationBuilderModal = new bootstrap.Modal(document.getElementById('presentationBuilderModal'));
    }
    const listContainer = document.getElementById('presentation-selection-list');
    let html = `<div class="d-flex justify-content-between align-items-center mb-3"><h5>اختر التقارير للعرض</h5><div><button class="btn btn-sm btn-outline-success" onclick="toggleAllPresentationReports(true)">تحديد الكل</button> <button class="btn btn-sm btn-outline-danger" onclick="toggleAllPresentationReports(false)">إلغاء الكل</button></div></div>`;
    document.querySelectorAll('.pantheon-wing').forEach(wing => {
        const wingTitle = wing.querySelector('.wing-title')?.textContent;
        const wingId = wing.dataset.wing;
        if (!wingTitle || !wingId || wingId === 'quality') return;
        html += `<div class="d-flex justify-content-between align-items-center bg-dark p-2 rounded mt-3"><h6 class="text-primary mb-0">${wingTitle}</h6><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" id="pres-switch-${wingId}" onchange="toggleWingPresentationReports('${wingId}', this.checked)" checked><label class="form-check-label" for="pres-switch-${wingId}">تحديد</label></div></div>`;
        wing.querySelectorAll('.report-card').forEach(card => {
            const onclickAttr = card.getAttribute('onclick');
            if (!onclickAttr) return;
            const match = onclickAttr.match(/'([^']+)'/g);
            if (!match || match.length < 2) return;
            const reportId = match[0].replace(/'/g, '');
            const reportTitle = match[1].replace(/'/g, '');
            html += `<div class="form-check ms-3 mt-1"><input class="form-check-input presentation-checkbox" type="checkbox" value="${reportId}" id="pres-chk-${reportId}" data-title="${reportTitle}" data-wing="${wingId}" checked><label class="form-check-label" for="pres-chk-${reportId}">${card.querySelector('h6').innerText}</label></div>`;
        });
    });
    listContainer.innerHTML = html;
    presentationBuilderModal.show();
}

function toggleAllPresentationReports(checked) {
    document.querySelectorAll('.presentation-checkbox').forEach(c => c.checked = checked);
    document.querySelectorAll('[id^="pres-switch-"]').forEach(s => s.checked = checked);
}

function toggleWingPresentationReports(wingId, checked) {
    document.querySelectorAll(`.presentation-checkbox[data-wing="${wingId}"]`).forEach(c => c.checked = checked);
}

// --- دوال محرك العرض السينمائي ---
function startCustomPresentation() {
    if (presentationBuilderModal) presentationBuilderModal.hide();
    const selectedReports = Array.from(document.querySelectorAll('.presentation-checkbox:checked')).map(cb => ({ id: cb.value, title: cb.dataset.title }));
    if (selectedReports.length === 0) { alert('الرجاء اختيار تقرير واحد على الأقل.'); return; }
    const data = getData();
    if (!data) { alert('لا يمكن بدء العرض.'); return; }

    presentationSlidesInfo = [];
    const periodText = (data.clientInfo?.startDate && data.clientInfo?.endDate) ? `للفترة من ${data.clientInfo.startDate} إلى ${data.clientInfo.endDate}` : `للسنة المالية ${data.fiscalYear}`;
    presentationSlidesInfo.push({ type: 'title', title: 'صفحة العنوان', companyName: data.companyName, periodText: periodText });
    selectedReports.forEach(report => presentationSlidesInfo.push({ type: 'report', id: report.id, title: report.title }));

    currentSlideIndex = 0;
    document.getElementById('presentation-overlay').style.display = 'flex';
    renderSlide(currentSlideIndex);
    startAutoplay();
    document.addEventListener('keydown', handlePresentationKeys);
}

function renderSlide(index) {
    const content = document.getElementById('presentation-content');
    const counter = document.getElementById('slide-counter');
    if (!content || !presentationSlidesInfo[index]) return;
    content.innerHTML = '<div class="d-flex justify-content-center align-items-center w-100 h-100"><div class="loading-spinner"></div></div>';
    counter.textContent = `${index + 1} / ${presentationSlidesInfo.length}`;
    const slideInfo = presentationSlidesInfo[index];
    setTimeout(() => {
        let slideHTML = '';
        if (slideInfo.type === 'title') {
            slideHTML = `<div class="presentation-slide d-flex flex-column justify-content-center align-items-center text-center"><h1 class="display-3 text-primary">${slideInfo.companyName}</h1><h2 class="display-5">عرض التقارير التنفيذية</h2><p class="lead mt-3" style="font-size: 1.5rem;">${slideInfo.periodText}</p></div>`;
        } else if (slideInfo.type === 'report') {
            const reportContent = generateReportContent(slideInfo.id, slideInfo.title, false);
            slideHTML = `<div class="presentation-slide"><h2 style="color: var(--color-primary-glow); border-bottom: 2px solid var(--color-border); padding-bottom: 1rem; margin-bottom: 2rem;">${slideInfo.title}</h2>${reportContent}</div>`;
        }
        content.innerHTML = slideHTML;
    }, 100);
}

function navigateSlides(direction) {
    stopAutoplay();
    currentSlideIndex = (currentSlideIndex + direction + presentationSlidesInfo.length) % presentationSlidesInfo.length;
    renderSlide(currentSlideIndex);
}

function exitPresentationMode() {
    stopAutoplay();
    document.removeEventListener('keydown', handlePresentationKeys);
    document.getElementById('presentation-overlay').style.display = 'none';
    document.getElementById('presentation-content').innerHTML = '';
    presentationSlidesInfo = [];
}

function startAutoplay() {
    stopAutoplay();
    const buttonIcon = document.querySelector('#pres-play-pause i');
    if (buttonIcon) buttonIcon.className = 'fas fa-pause';
    autoplayInterval = setInterval(() => {
        currentSlideIndex = (currentSlideIndex + 1) % presentationSlidesInfo.length;
        renderSlide(currentSlideIndex);
    }, AUTOPLAY_DELAY);
}

function stopAutoplay() {
    clearInterval(autoplayInterval);
    autoplayInterval = null;
    const buttonIcon = document.querySelector('#pres-play-pause i');
    if (buttonIcon) buttonIcon.className = 'fas fa-play';
}

function toggleAutoplay() {
    if (autoplayInterval) {
        stopAutoplay();
    } else {
        startAutoplay();
    }
}

function handlePresentationKeys(event) {
    if (event.code === 'ArrowRight') navigateSlides(1);
    else if (event.code === 'ArrowLeft') navigateSlides(-1);
    else if (event.code === 'Space') { event.preventDefault(); toggleAutoplay(); }
    else if (event.code === 'Escape') exitPresentationMode();
}

// --- دالة تصدير PowerPoint ---
async function exportToPowerPoint() {
    alert('جاري تحضير ملف PowerPoint. قد تستغرق هذه العملية بعض الوقت...');
    const pptx = new PptxGenJS();
    const data = getData();
    pptx.addSlide().addText(data.companyName, { x: 0.5, y: 2.5, w: 9, h: 1, fontSize: 36, bold: true, color: '00BFFF', align: 'center' })
                   .addText('حزمة التقارير التنفيذية', { x: 0.5, y: 3.5, w: 9, h: 1, fontSize: 24, color: 'E6EDF3', align: 'center' });
    const reportCards = document.querySelectorAll('.report-card');
    for (const card of reportCards) {
        const onclickAttr = card.getAttribute('onclick');
        if (!onclickAttr) continue;
        const match = onclickAttr.match(/'([^']+)'/g);
        if (!match || match.length < 2) continue;
        const reportId = match[0].replace(/'/g, '');
        const reportTitle = match[1].replace(/'/g, '');
        const tempDiv = document.createElement('div');
        tempDiv.style.width = '960px'; tempDiv.style.padding = '20px'; tempDiv.style.backgroundColor = '#010409';
        tempDiv.innerHTML = generateReportContent(reportId, reportTitle, false);
        document.body.appendChild(tempDiv);
        await new Promise(resolve => setTimeout(resolve, 500));
        const canvas = await html2canvas(tempDiv, { scale: 2, backgroundColor: '#010409', useCORS: true });
        const image_data = canvas.toDataURL('image/png');
        const slide = pptx.addSlide();
        slide.addText(reportTitle, { x: 0.5, y: 0.2, w: 9, h: 0.5, fontSize: 24, bold: true, color: '00BFFF' });
        slide.addImage({ data: image_data, x: 0.5, y: 0.8, w: 9, h: 5.06 });
        document.body.removeChild(tempDiv);
    }
    pptx.writeFile({ fileName: `Polaris_Presentation_${data.companyName}.pptx` });
}
// ==================================================================
// ########## END: نظام العرض والتصدير الاحترافي ##########
// ==================================================================

  </script>
<!-- ======================================================= -->
<!-- START: هيكل العرض التقديمي الاحترافي (النهائي) -->
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- START: هيكل العرض التقديمي الاحترافي (النهائي) -->
<!-- ======================================================= -->
<div id="presentation-overlay">
    <div id="presentation-content"></div>
    <button id="pres-nav-prev" class="presentation-nav" onclick="navigateSlides(-1)">&#10094;</button>
    
    <!-- *** الزر الجديد هنا *** -->
    <button id="pres-play-pause" class="presentation-nav" onclick="toggleAutoplay()">
        <i class="fas fa-pause"></i>
    </button>

    <button id="pres-nav-next" class="presentation-nav" onclick="navigateSlides(1)">&#10095;</button>
    <button id="pres-exit-btn" onclick="exitPresentationMode()"><i class="fas fa-times"></i></button>
    <div id="slide-counter"></div>
</div>
<!-- ======================================================= -->
<!-- END: هيكل العرض التقديمي -->
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- END: هيكل العرض التقديمي -->
<!-- ======================================================= -->
  <!-- ======================================================= -->
  <!-- END: هيكل وضع العرض التقديمي -->
  <!-- ======================================================= -->

</body>
</html>
