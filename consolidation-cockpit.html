<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>النظام المحاسبي المتكامل - القوائم المالية</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700;900&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- تشفير البيانات (CryptoJS) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

<!-- نظام تدفق البيانات Polaris -->
<script src="dataPipeline.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --color-bg: #0d1117;
            --color-surface: #161b22;
            --color-primary: #00aaff;
            --color-primary-glow: rgba(0, 170, 255, 0.5);
            --color-text-primary: #c9d1d9;
            --color-text-secondary: #8b949e;
            --color-border: #30363d;
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-warning: #ffc107;
            --border-radius-lg: 12px;
            --border-radius-md: 8px;
            --font-family-main: 'Tajawal', sans-serif;
            --font-family-display: 'Cairo', sans-serif;
        }

        body {
            font-family: var(--font-family-main);
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            line-height: 1.7;
        }

        .container-fluid { padding: 2rem; }

        .financial-statement {
            background-color: var(--color-surface);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--color-border);
        }

        .statement-title {
            font-family: var(--font-family-display);
            font-weight: 900;
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .financial-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.9rem;
        }

        .financial-table th {
            background-color: #1c222b;
            color: var(--color-text-primary);
            padding: 0.8rem;
            text-align: right;
            border: 1px solid var(--color-border);
            font-weight: 700;
        }

        .financial-table td {
            padding: 0.6rem 0.8rem;
            border: 1px solid var(--color-border);
            text-align: right;
        }

        .financial-table tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.03);
        }

        .amount {
            font-family: monospace;
            font-weight: 700;
            text-align: left;
        }

        .positive { color: var(--color-success); }
        .negative { color: var(--color-danger); }

        .sub-total {
            background-color: rgba(0, 170, 255, 0.1) !important;
            font-weight: 700;
        }

        .total {
            background-color: rgba(40, 167, 69, 0.15) !important;
            font-weight: 900;
        }

        .control-panel {
            background-color: var(--color-surface);
            border-radius: var(--border-radius-lg);
            padding: 1rem;
            margin-bottom: 2rem;
            border: 1px solid var(--color-border);
        }

        .btn-primary {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            font-weight: 700;
        }

        .notes-section {
            background-color: var(--color-surface);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--color-border);
        }

        .note-item {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--color-border);
        }

        .note-item:last-child {
            border-bottom: none;
        }

        .note-title {
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .sub-note-title {
            font-weight: 700;
            color: var(--color-text-primary);
            margin: 1rem 0 0.5rem 0;
            font-size: 1rem;
        }

        .data-loading {
            text-align: center;
            padding: 2rem;
            color: var(--color-text-secondary);
        }

        .data-empty {
            text-align: center;
            padding: 3rem;
            color: var(--color-text-secondary);
            background-color: rgba(255,255,255,0.05);
            border-radius: var(--border-radius-md);
        }

        .accounting-correct { border-left: 4px solid var(--color-success); }
        .accounting-warning { border-left: 4px solid var(--color-warning); }

        .note-description {
            color: var(--color-text-secondary);
            font-size: 0.95rem;
            margin-bottom: 1rem;
            line-height: 1.8;
        }

        .policy-box {
            background-color: rgba(0, 170, 255, 0.05);
            border-left: 3px solid var(--color-primary);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .kpi-dashboard {
            background: linear-gradient(135deg, #161b22 0%, #1c222b 100%);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--color-border);
        }

        .kpi-dashboard-title {
            font-family: var(--font-family-display);
            font-weight: 900;
            color: var(--color-primary);
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .kpi-card {
            background-color: var(--color-surface);
            border-radius: var(--border-radius-md);
            padding: 1.5rem;
            border: 1px solid var(--color-border);
            transition: all 0.3s ease;
            height: 100%;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 170, 255, 0.2);
            border-color: var(--color-primary);
        }

        .kpi-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            opacity: 0.8;
        }

        .kpi-label {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .kpi-value {
            font-family: var(--font-family-display);
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 0.5rem;
        }

        .kpi-change {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .kpi-change.positive { color: var(--color-success); }
        .kpi-change.negative { color: var(--color-danger); }
        .kpi-change.neutral { color: var(--color-text-secondary); }

        .charts-section {
            background-color: var(--color-surface);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--color-border);
        }

        .chart-container {
            position: relative;
            height: 350px;
            margin-bottom: 2rem;
            background-color: rgba(255, 255, 255, 0.02);
            border-radius: var(--border-radius-md);
            padding: 1.5rem;
        }

        .chart-title {
            font-family: var(--font-family-display);
            font-weight: 700;
            color: var(--color-text-primary);
            font-size: 1.1rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .comparison-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1rem;
        }

        .comparison-toggle label {
            margin-bottom: 0;
            font-weight: 500;
        }

        @media print {
            @page {
                size: A4;
                margin: 2cm 1.5cm;
            }

            body {
                background: white !important;
                color: black !important;
                font-size: 10pt;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .no-print { display: none !important; }
            
            .print-header {
                display: block !important;
                text-align: center;
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }
            
            .financial-statement, .notes-section, .note-item {
                page-break-inside: avoid;
                break-inside: avoid;
                border: 1px solid #ddd !important;
                box-shadow: none !important;
                background: white !important;
                padding: 1rem;
                margin-bottom: 1.5rem;
            }
            
            .statement-title {
                color: #000 !important;
                border-bottom-color: #000 !important;
                font-size: 14pt;
                page-break-after: avoid;
            }
            
            .note-title {
                color: #000 !important;
                font-size: 12pt;
                page-break-after: avoid;
            }
            
            .financial-table {
                font-size: 9pt;
                page-break-inside: avoid;
            }
            
            .financial-table th {
                background-color: #f0f0f0 !important;
                color: #000 !important;
                border: 1px solid #000 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .financial-table td {
                border: 1px solid #666 !important;
                color: #000 !important;
            }
            
            .total {
                background-color: #e8e8e8 !important;
                font-weight: 900 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .sub-total {
                background-color: #f5f5f5 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .policy-box {
                background-color: #f9f9f9 !important;
                border-right: 3px solid #000 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .kpi-dashboard, .charts-section {
                display: none !important;
            }
            
            .page-break-before { page-break-before: always; }
            .page-break-after { page-break-after: always; }
        }
    
        .note-link {
            color: var(--color-primary);
            cursor: pointer;
            text-decoration: underline;
            font-weight: 700;
        }
        
        .note-link:hover {
            color: var(--color-success);
            text-decoration: none;
        }

        /* Accessibility Enhancements */
        [aria-live="polite"] { transition: opacity 0.5s ease; }
        .visually-hidden:not(:focus):not(:active) {
            position: absolute;
            width: 1px;
            height: 1px;
            overflow: hidden;
            clip: rect(0 0 0 0);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Control Panel -->
        <div class="control-panel no-print">
            <div class="d-flex gap-2 flex-wrap justify-content-between align-items-center">
                <h4 class="mb-0">النظام المحاسبي المتكامل - القوائم المالية</h4>
                <div class="d-flex gap-2">
                    <div class="comparison-toggle">
                        <label for="comparisonMode">مقارنة بالفترة السابقة:</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="comparisonMode" onchange="toggleComparisonMode()">
                        </div>
                    </div>
                    <button class="btn btn-success btn-sm" onclick="exportToExcel()" aria-label="تصدير القوائم المالية إلى Excel">
                        <i class="fas fa-file-excel me-2"></i>تصدير Excel
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="generatePDF()" aria-label="تصدير القوائم المالية إلى PDF">
                        <i class="fas fa-file-pdf me-2"></i>تصدير PDF
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="window.print()" aria-label="طباعة القوائم المالية">
                        <i class="fas fa-print me-2"></i>طباعة
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="uploadLogo()" aria-label="رفع شعار الشركة">
                        <i class="fas fa-image me-2"></i>رفع شعار
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="goBackToMapping()" aria-label="العودة إلى صفحة المراجعة">
                        <i class="fas fa-arrow-right me-2"></i>العودة للمراجعة
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="saveBackupForNextYear()" aria-label="حفظ نسخة احتياطية">
                        <i class="fas fa-save me-2"></i>حفظ نسخة
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="loadComparisonData()" aria-label="استرجاع بيانات المقارنة">
                        <i class="fas fa-upload me-2"></i>استرجاع مقارنة
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="refreshData()" aria-label="تحديث البيانات">
                        <i class="fas fa-sync-alt me-2"></i>تحديث
                   <button class="btn btn-info btn-sm" onclick="exportAsStandaloneHTML()" aria-label="حفظ كملف HTML مستقل">
    <i class="fas fa-file-code me-2"></i>حفظ كـ HTML
</button>

 </button>
                </div>
            </div>
        </div>

     <!-- هذا هو الكود الجديد الذي يجب وضعه مكانه -->
<!-- ======================================================= -->
<!-- START: رأس التقرير الموحد والاحترافي (V2) -->
<!-- ======================================================= -->
<div class="text-center mb-4 p-4 rounded no-print" style="background-color: var(--color-surface); border: 1px solid var(--color-border);">
    <img id="companyLogo" src="" alt="شعار الشركة" style="max-height: 80px; margin-bottom: 1rem; display: none;">
    
    <!-- العنوان الرئيسي الموحد -->
    <h1 id="companyNameDisplay" class="font-weight-bold mb-2" style="font-family: var(--font-family-display); font-size: 2rem; color: var(--color-primary);">
        القوائم المالية لـ شركة عالم فكري
    </h1>
    
    <!-- الفترة المالية بنفس تنسيق العنوان الفرعي -->
    <h4 id="periodDisplay" style="color: var(--color-text-secondary); font-weight: 500;">
        للفترة المالية من ... إلى ...
    </h4>
</div>
<!-- ======================================================= -->
<!-- END: رأس التقرير الموحد -->
<!-- ======================================================= -->
>

        <!-- Print Header -->
        <div class="print-header" style="display: none;">
            <img id="companyLogoPrint" src="" alt="شعار الشركة" style="max-height: 60px; margin-bottom: 10px; display: none;">
            <h2 id="companyNamePrint" style="font-weight: bold; margin: 0;">اسم الشركة</h2>
            <h4 style="margin: 5px 0;">القوائم المالية</h4>
            <p style="margin: 0; font-size: 10pt;">للسنة المالية المنتهية في 31 ديسمبر 2024</p>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="data-loading" aria-live="polite">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">جاري التحميل...</span>
            </div>
            <h4>جاري تحميل البيانات المالية...</h4>
        </div>

        <!-- KPI Dashboard -->
        <div class="kpi-dashboard" id="kpiDashboard" style="display: none;">
            <h2 class="kpi-dashboard-title"><i class="fas fa-chart-line me-2"></i>مؤشرات الأداء الرئيسية (KPIs)</h2>
            <div id="kpiContent"></div>
        </div>

        <!-- Interactive Charts -->
        <div class="charts-section" id="chartsSection" style="display: none;">
            <h2 class="statement-title"><i class="fas fa-chart-pie me-2"></i>الرسوم البيانية التفاعلية</h2>
            <div class="row">
                <div class="col-lg-6">
                    <div class="chart-container">
                        <h5 class="chart-title">مقارنة الإيرادات والأرباح</h5>
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="chart-container">
                        <h5 class="chart-title">هيكل الأصول</h5>
                        <canvas id="assetsChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-6">
                    <div class="chart-container">
                        <h5 class="chart-title">هيكل الالتزامات وحقوق الملكية</h5>
                        <canvas id="liabilitiesChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="chart-container">
                        <h5 class="chart-title">هوامش الربح</h5>
                        <canvas id="marginsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Income Statement -->
        <div class="financial-statement" id="incomeStatementSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                <h2 class="statement-title mb-0"><i class="fas fa-chart-bar me-2"></i>قائمة الدخل</h2>
                <div>
                    <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('incomeStatement', 'summary')" aria-label="عرض إجمالي لقائمة الدخل">إجمالي</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleView('incomeStatement', 'detailed')" aria-label="عرض تفصيلي لقائمة الدخل">تفصيلي</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="printSection('incomeStatementSection')" aria-label="طباعة قائمة الدخل">
                        <i class="fas fa-print me-2"></i>طباعة
                    </button>
                </div>
            </div>
            <div id="incomeStatementSummary">
                <div id="incomeStatementContent"></div>
            </div>
            <div id="incomeStatementDetailed" style="display:none;">
                <div id="incomeStatementDetailedContent"></div>
            </div>
        </div>

        <!-- Balance Sheet -->
        <div class="financial-statement" id="balanceSheetSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                <h2 class="statement-title mb-0"><i class="fas fa-balance-scale me-2"></i>قائمة المركز المالي</h2>
                <div>
                    <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('balanceSheet', 'summary')" aria-label="عرض إجمالي لقائمة المركز المالي">إجمالي</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleView('balanceSheet', 'detailed')" aria-label="عرض تفصيلي لقائمة المركز المالي">تفصيلي</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="printSection('balanceSheetSection')" aria-label="طباعة قائمة المركز المالي">
                        <i class="fas fa-print me-2"></i>طباعة
                    </button>
                </div>
            </div>
            <div id="balanceSheetSummary">
                <div id="balanceSheetContent"></div>
            </div>
            <div id="balanceSheetDetailed" style="display:none;">
                <div id="balanceSheetDetailedContent"></div>
            </div>
        </div>

        <!-- Cash Flow Statement -->
        <div class="financial-statement" id="cashFlowSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                <h2 class="statement-title mb-0"><i class="fas fa-money-bill-wave me-2"></i>قائمة التدفقات النقدية</h2>
                <div>
                    <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('cashFlow', 'summary')" aria-label="عرض إجمالي لقائمة التدفقات النقدية">إجمالي</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleView('cashFlow', 'detailed')" aria-label="عرض تفصيلي لقائمة التدفقات النقدية">تفصيلي</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="printSection('cashFlowSection')" aria-label="طباعة قائمة التدفقات النقدية">
                        <i class="fas fa-print me-2"></i>طباعة
                    </button>
                </div>
            </div>
            <div id="cashFlowSummary">
                <div id="cashFlowContent"></div>
            </div>
            <div id="cashFlowDetailed" style="display:none;">
                <div id="cashFlowDetailedContent"></div>
            </div>
        </div>

        <!-- Equity Statement -->
        <div class="financial-statement" id="equityStatementSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                <h2 class="statement-title mb-0"><i class="fas fa-users me-2"></i>قائمة التغيرات في حقوق الملكية</h2>
                <div>
                    <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('equityStatement', 'summary')" aria-label="عرض إجمالي لقائمة التغيرات في حقوق الملكية">إجمالي</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleView('equityStatement', 'detailed')" aria-label="عرض تفصيلي لقائمة التغيرات في حقوق الملكية">تفصيلي</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="printSection('equityStatementSection')" aria-label="طباعة قائمة التغيرات في حقوق الملكية">
                        <i class="fas fa-print me-2"></i>طباعة
                    </button>
                </div>
            </div>
            <div id="equityStatementSummary">
                <div id="equityStatementContent"></div>
            </div>
            <div id="equityStatementDetailed" style="display:none;">
                <div id="equityStatementDetailedContent"></div>
            </div>
        </div>

        <!-- Supplementary Notes -->
        <div class="notes-section" id="notesSection" style="display: none;">
            <h2 class="statement-title"><i class="fas fa-sticky-note me-2"></i>الإيضاحات المتممة للقوائم المالية</h2>
            <div class="note-description">
                <em>"الأرقام في القوائم المالية تحكي جزءاً من القصة، لكن الإيضاحات تروي القصة كاملة."</em> - المدير المالي
            </div>
            <div id="detailedNotesSection">
                <!-- Note 1: تعريف بالمنشأة -->
                <div class="note-item" id="note1Section">
                    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                        <h4 class="note-title mb-0">إيضاح (1): تعريف بالمنشأة</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note1Section')" aria-label="طباعة إيضاح تعريف بالمنشأة">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                    <div id="note1Content"></div>
                </div>
                
                <!-- Note 2: السياسات المحاسبية -->
                <div class="note-item" id="note2Section">
                    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                        <h4 class="note-title mb-0">إيضاح (2): أهم السياسات المحاسبية المتبعة</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note2Section')" aria-label="طباعة إيضاح السياسات المحاسبية">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                    <div id="note2Content"></div>
                </div>
                
                <!-- Note 3: النقد وما في حكمها -->
                <div class="note-item" id="note3Section">
                    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                        <h4 class="note-title mb-0">إيضاح (3): النقدية وما في حكمها</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('note3', 'summary')" aria-label="عرض إجمالي للنقدية">إجمالي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleView('note3', 'detailed')" aria-label="عرض تفصيلي للنقدية">تفصيلي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note3Section')" aria-label="طباعة إيضاح النقدية">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                    <div id="note3Summary">
                        <table class="financial-table">
                            <thead><tr><th>البيان</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note3SummaryBody"></tbody>
                        </table>
                    </div>
                    <div id="note3Detailed" style="display:none;">
                        <table class="financial-table">
                            <thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note3DetailedBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Note 4: مدينون تجاريون -->
                <div class="note-item" id="note4Section">
                    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                        <h4 class="note-title mb-0">إيضاح (4): مدينون تجاريون</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('note4', 'summary')" aria-label="عرض إجمالي لمدينون تجاريون">إجمالي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleView('note4', 'detailed')" aria-label="عرض تفصيلي لمدينون تجاريون">تفصيلي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note4Section')" aria-label="طباعة إيضاح مدينون تجاريون">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                    <div id="note4Summary">
                        <table class="financial-table">
                            <thead><tr><th>البيان</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note4SummaryBody"></tbody>
                        </table>
                    </div>
                    <div id="note4Detailed" style="display:none;">
                        <table class="financial-table">
                            <thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note4DetailedBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Note 5: أرصدة مدينة أخرى -->
                <div class="note-item" id="note5Section">
                    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                        <h4 class="note-title mb-0">إيضاح (5): أرصدة مدينة أخرى</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('note5', 'summary')" aria-label="عرض إجمالي لأرصدة مدينة أخرى">إجمالي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleView('note5', 'detailed')" aria-label="عرض تفصيلي لأرصدة مدينة أخرى">تفصيلي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note5Section')" aria-label="طباعة إيضاح أرصدة مدينة أخرى">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                    <div id="note5Summary">
                        <table class="financial-table">
                            <thead><tr><th>البيان</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note5SummaryBody"></tbody>
                        </table>
                    </div>
                    <div id="note5Detailed" style="display:none;">
                        <table class="financial-table">
                            <thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note5DetailedBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Note 6: المخزون -->
                <div class="note-item" id="note6Section">
                    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                        <h4 class="note-title mb-0">إيضاح (6): المخزون</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('note6', 'summary')" aria-label="عرض إجمالي للمخزون">إجمالي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleView('note6', 'detailed')" aria-label="عرض تفصيلي للمخزون">تفصيلي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note6Section')" aria-label="طباعة إيضاح المخزون">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                    <div id="note6Summary">
                        <table class="financial-table">
                            <thead><tr><th>البيان</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note6SummaryBody"></tbody>
                        </table>
                    </div>
                    <div id="note6Detailed" style="display:none;">
                        <table class="financial-table">
                            <thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note6DetailedBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Note 7: الممتلكات والآلات والمعدات -->
                <div class="note-item" id="note7Section">
                    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                        <h4 class="note-title mb-0">إيضاح (7): الممتلكات والآلات والمعدات</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('note7', 'summary')" aria-label="عرض إجمالي للممتلكات">إجمالي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleView('note7', 'detailed')" aria-label="عرض تفصيلي للممتلكات">تفصيلي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note7Section')" aria-label="طباعة إيضاح الممتلكات">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                    <div id="note7Summary">
                        <table class="financial-table">
                            <thead><tr><th>البيان</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note7SummaryBody"></tbody>
                        </table>
                    </div>
                    <div id="note7Detailed" style="display:none;">
                        <table class="financial-table">
                            <thead><tr><th>اسم الأصل</th><th>التكلفة</th><th>إضافات</th><th>تصرفات</th><th>إجمالي التكلفة</th><th>الإهلاك المتراكم</th><th>إهلاك السنة</th><th>تصرفات الإهلاك</th><th>إجمالي الإهلاك</th><th>صافي القيمة 2024</th><th>صافي القيمة 2023</th></tr></thead>
                            <tbody id="note7DetailedBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Note 8: دائنون تجاريون -->
                <div class="note-item" id="note8Section">
                    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                        <h4 class="note-title mb-0">إيضاح (8): دائنون تجاريون</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('note8', 'summary')" aria-label="عرض إجمالي لدائنون تجاريون">إجمالي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleView('note8', 'detailed')" aria-label="عرض تفصيلي لدائنون تجاريون">تفصيلي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note8Section')" aria-label="طباعة إيضاح دائنون تجاريون">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                    <div id="note8Summary">
                        <table class="financial-table">
                            <thead><tr><th>البيان</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note8SummaryBody"></tbody>
                        </table>
                    </div>
                    <div id="note8Detailed" style="display:none;">
                        <table class="financial-table">
                            <thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note8DetailedBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Note 9: أرصدة دائنة أخرى -->
                <div class="note-item" id="note9Section">
                    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                        <h4 class="note-title mb-0">إيضاح (9): أرصدة دائنة أخرى</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('note9', 'summary')" aria-label="عرض إجمالي لأرصدة دائنة أخرى">إجمالي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleView('note9', 'detailed')" aria-label="عرض تفصيلي لأرصدة دائنة أخرى">تفصيلي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note9Section')" aria-label="طباعة إيضاح أرصدة دائنة أخرى">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                    <div id="note9Summary">
                        <table class="financial-table">
                            <thead><tr><th>البيان</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note9SummaryBody"></tbody>
                        </table>
                    </div>
                    <div id="note9Detailed" style="display:none;">
                        <table class="financial-table">
                            <thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note9DetailedBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Note 10: مخصص الزكاة والضريبة -->
                <div class="note-item" id="note10Section">
                    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                        <h4 class="note-title mb-0">إيضاح (10): مخصص الزكاة والضريبة</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('note10', 'summary')" aria-label="عرض إجمالي لمخصص الزكاة والضريبة">إجمالي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleView('note10', 'detailed')" aria-label="عرض تفصيلي لمخصص الزكاة والضريبة">تفصيلي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note10Section')" aria-label="طباعة إيضاح مخصص الزكاة والضريبة">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                    <div id="note10Summary">
                        <table class="financial-table">
                            <thead><tr><th>البيان</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note10SummaryBody"></tbody>
                        </table>
                    </div>
                    <div id="note10Detailed" style="display:none;">
                        <table class="financial-table">
                            <thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note10DetailedBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Note 11: الإيرادات -->
                <div class="note-item" id="note11Section">
                    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                        <h4 class="note-title mb-0">إيضاح (11): الإيرادات</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('note11', 'summary')" aria-label="عرض إجمالي للإيرادات">إجمالي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleView('note11', 'detailed')" aria-label="عرض تفصيلي للإيرادات">تفصيلي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note11Section')" aria-label="طباعة إيضاح الإيرادات">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                    <div id="note11Summary">
                        <table class="financial-table">
                            <thead><tr><th>البيان</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note11SummaryBody"></tbody>
                        </table>
                    </div>
                    <div id="note11Detailed" style="display:none;">
                        <table class="financial-table">
                            <thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note11DetailedBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Note 12: المصروفات العمومية والإدارية -->
                <div class="note-item" id="note12Section">
                    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                        <h4 class="note-title mb-0">إيضاح (12): المصروفات العمومية والإدارية</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('note12', 'summary')" aria-label="عرض إجمالي للمصروفات">إجمالي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleView('note12', 'detailed')" aria-label="عرض تفصيلي للمصروفات">تفصيلي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note12Section')" aria-label="طباعة إيضاح المصروفات">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>


                    <div id="note12Summary">
                        <table class="financial-table">
                            <thead><tr><th>البيان</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note12SummaryBody"></tbody>
                        </table>
                    </div>
                    <div id="note12Detailed" style="display:none;">
                        <table class="financial-table">
                            <thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note12DetailedBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- ======================================================= -->
<!-- START: إيضاح (13) رأس المال العامل - بهيكل موحد وصحيح -->
<!-- ======================================================= -->
<div class="note-item" id="note13Section">
    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
        <h4 class="note-title mb-0">إيضاح (13): رأس المال العامل</h4>
        <div class="btn-group">
            <!-- بما أن هذا الإيضاح تحليلي، ليس له عرض "تفصيلي" -->
            <button class="btn btn-sm btn-outline-primary active" aria-label="عرض إجمالي لرأس المال العامل">إجمالي</button>
            <button class="btn btn-sm btn-outline-primary" disabled aria-label="لا يوجد عرض تفصيلي">تفصيلي</button>
            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note13Section')" aria-label="طباعة إيضاح رأس المال العامل">
                <i class="fas fa-print"></i>
            </button>
        </div>
    </div>
    <!-- تم وضع المحتوى داخل div خاص به، تماماً مثل الإيضاحات الأخرى -->
    <div id="note13Content">
        <!-- سيتم ملء المحتوى هنا بواسطة JavaScript -->
    </div>
</div>
<!-- ======================================================= -->
<!-- END: إيضاح (13) -->
<!-- ======================================================= -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Security Note: localStorage is used for demo purposes. For production, use server-side storage with encryption.
        function loadAuditData() {
            const urlParams = new URLSearchParams(window.location.search);
            let activeClientId = urlParams.get('clientId') || localStorage.getItem('activeClientId');
            if (!activeClientId) {
                showError('لم يتم العثور على عميل نشط. الرجاء العودة لصفحة المراجعة.');
                return null;
            }
            localStorage.setItem('activeClientId', activeClientId);
            const auditFileKey = `polarisAuditFile_${activeClientId}`;
            const savedAuditFile = localStorage.getItem(auditFileKey);
            if (!savedAuditFile) {
                showError(`لم يتم العثور على بيانات المراجعة للمعرف (${activeClientId}).`);
                return null;
            }
            try {
                return JSON.parse(savedAuditFile);
            } catch (e) {
                showError('خطأ في تحميل بيانات المراجعة. الملف تالف أو غير صحيح.');
                showError('لا توجد بيانات مالية لعرض القوائم. الرجاء العودة لصفحة المراجعة أو تحميل ملف المراجعة أولاً.');
                return null;
            }
        }

     // ==================================================================
// --- START: دالة تحديث رأس التقرير (V3 - تقرأ من المصدر الموثوق) ---
// ==================================================================
// ==================================================================
// --- START: دالة تحديث رأس التقرير (V4 - متوافقة مع الهيكل الجديد) ---
// ==================================================================
function updateCompanyInfo(auditData) {
    const activeClientId = localStorage.getItem('activeClientId');
    if (!activeClientId) return;

    // --- تحميل بيانات الإعداد الكاملة ---
    const clientSetupJSON = localStorage.getItem(`clientSetup_${activeClientId}`);
    let clientDetails = auditData.clientInfo; 
    if (clientSetupJSON) {
        try {
            clientDetails = JSON.parse(clientSetupJSON).details || clientDetails;
        } catch (e) { console.error("خطأ في قراءة clientSetup", e); }
    }

    // --- تحديث الشعار ---
    const logoData = localStorage.getItem(`companyLogo_${activeClientId}`);
    if (logoData) {
        document.getElementById('companyLogo').src = logoData;
        document.getElementById('companyLogo').style.display = 'block';
        document.getElementById('companyLogoPrint').src = logoData;
        document.getElementById('companyLogoPrint').style.display = 'block';
    }

    // --- تحديث العناوين ---
    const companyName = clientDetails.companyName || clientDetails.groupName || 'اسم الشركة';
    const mainTitleElement = document.getElementById('companyNameDisplay');
    const printTitleElement = document.getElementById('companyNamePrint');
    
    // تحديث العنوان الرئيسي
    if (mainTitleElement) mainTitleElement.textContent = `القوائم المالية لـ ${companyName}`;
    if (printTitleElement) printTitleElement.textContent = `القوائم المالية لـ ${companyName}`;

    // --- تحديث الفترة المالية ---
    const periodElement = document.getElementById('periodDisplay');
    const periodPrintElement = document.getElementById('periodPrint');
    
    if (clientDetails.startDate && clientDetails.endDate) {
        const startDate = new Date(clientDetails.startDate).toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' });
        const endDate = new Date(clientDetails.endDate).toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' });
        const periodText = `للفترة المالية من ${startDate} إلى ${endDate}`;
        
        if (periodElement) periodElement.textContent = periodText;
        if (periodPrintElement) periodPrintElement.textContent = periodText;
    } else {
        if (periodElement) periodElement.textContent = "للسنة المالية الحالية";
        if (periodPrintElement) periodPrintElement.textContent = "للسنة المالية الحالية";
    }
}
// ==================================================================
// --- END: دالة تحديث رأس التقرير ---
// ==================================================================
// ==================================================================
// --- END: دالة تحديث رأس التقرير ---
// ==================================================================


        function calculateFinalBalance(account, adjustments, isPriorYear = false) {
            if (!account) return 0;
            if (isPriorYear) {
                const obDebit = Number(account.ob_debit) || 0;
                const obCredit = Number(account.ob_credit) || 0;
                return obDebit - obCredit;
            }
            const bookBalance = Number(account.book_balance) || 0;
            const accountAdjustments = (adjustments || []).filter(adj => 
                String(adj.debit_account) === String(account.account_id) || 
                String(adj.credit_account) === String(account.account_id)
            );
            const adjustmentEffect = accountAdjustments.reduce((sum, adj) => {
                return sum + (String(adj.debit_account) === String(account.account_id) ? adj.amount : -adj.amount);
            }, 0);
            return isNaN(bookBalance + adjustmentEffect) ? 0 : bookBalance + adjustmentEffect;
        }

    // ==================================================================
// --- START: دالة التصنيف المحاسبي (V2 - مع صناديق مخصصة للإيضاحات) ---
// ==================================================================
const categorizeAccounts = (function() {
    const cache = new Map();
    return function(auditData, isPriorYear = false) {
        const cacheKey = JSON.stringify({ clientId: auditData?.clientInfo?.id, isPriorYear });
        if (cache.has(cacheKey)) return cache.get(cacheKey);
        
        const accounts = auditData?.trialBalance || [];
        const adjustments = isPriorYear ? [] : (auditData?.adjustments || []);
        
        // 1. (الأهم) إنشاء صناديق منفصلة لكل إيضاح
        const categorized = { 
            revenue: [], cogs: [], operatingExpenses: [], otherRevenues: [], 
            currentAssets: [], fixedAssets: [], currentLiabilities: [], longTermLiabilities: [], 
            equity: [], clearing: [],
            // -- صناديق مخصصة للإيضاحات --
            note3_cash: [],
            note4_tradeReceivables: [],
            note5_otherReceivables: [],
            note6_inventory: [],
            note7_fixedAssets: [], // للتفاصيل
            note8_tradePayables: [],
            note9_otherPayables: [],
            note10_zakatProvision: [],
            note11_revenueDetails: [],
            note12_adminExpenses: []
        };

        accounts.forEach(account => {
            if (account.category === 'ignore') return;
            const finalBalance = calculateFinalBalance(account, adjustments, isPriorYear);
            const accountWithBalance = { ...account, finalBalance };
            const mainCategory = (account.category || '').toLowerCase();
            const subCategory = (account.sub_category || '').toLowerCase();

            // 2. توزيع الحسابات على الصناديق الصحيحة
            switch (mainCategory) {
                case 'assets':
                    if (['fixed_assets', 'intangible_assets', 'long_term_investments'].includes(subCategory)) {
                        categorized.fixedAssets.push(accountWithBalance);
                        categorized.note7_fixedAssets.push(accountWithBalance);
                    } else {
                        categorized.currentAssets.push(accountWithBalance);
                        if (subCategory.includes('cash')) categorized.note3_cash.push(accountWithBalance);
                        if (subCategory === 'trade_receivables') categorized.note4_tradeReceivables.push(accountWithBalance);
                        if (subCategory === 'other_receivables') categorized.note5_otherReceivables.push(accountWithBalance);
                        if (subCategory === 'inventory') categorized.note6_inventory.push(accountWithBalance);
                    }
                    break;
                case 'liabilities':
                    if (['long_term_loans', 'end_of_service_benefit'].includes(subCategory)) {
                        categorized.longTermLiabilities.push(accountWithBalance);
                    } else {
                        categorized.currentLiabilities.push(accountWithBalance);
                        if (subCategory === 'trade_payables') categorized.note8_tradePayables.push(accountWithBalance);
                        if (subCategory === 'other_payables') categorized.note9_otherPayables.push(accountWithBalance);
                        if (subCategory === 'zakat_tax_provision') categorized.note10_zakatProvision.push(accountWithBalance);
                    }
                    break;
                case 'equity':
                    categorized.equity.push(accountWithBalance);
                    break;
                case 'revenue':
                    categorized.note11_revenueDetails.push(accountWithBalance);
                    if (subCategory.includes('other') || subCategory.includes('gains')) {
                        categorized.otherRevenues.push(accountWithBalance);
                    } else {
                        categorized.revenue.push(accountWithBalance);
                    }
                    break;
                case 'expenses':
                    if (subCategory === 'cogs') {
                        categorized.cogs.push(accountWithBalance);
                    } else {
                        categorized.operatingExpenses.push(accountWithBalance);
                        if (!['depreciation', 'amortization', 'zakat_expense'].includes(subCategory)) {
                            categorized.note12_adminExpenses.push(accountWithBalance);
                        }
                    }
                    break;
                case 'clearing':
                    categorized.clearing.push(accountWithBalance);
                    break;
            }
        });
        cache.set(cacheKey, categorized);
        return categorized;
    };
})();
// ==================================================================
// --- END: دالة التصنيف المحاسبي ---
// ==================================================================


        function generateIncomeStatement(categorizedData) {
            if (!categorizedData || typeof categorizedData !== 'object' || !categorizedData.revenue) {
                console.error('Error: categorizedData is invalid or missing revenue', categorizedData);
                return {
                    totalRevenue: 0, totalCOGS: 0, grossProfit: 0, adminExpenses: 0,
                    depreciationExpense: 0, amortizationExpense: 0, otherRevenues: 0,
                    netProfitBeforeZakat: 0, zakatExpense: 0, netProfit: 0,
                    allAccounts: categorizedData
                };
            }
            const grossRevenue = -categorizedData.revenue.filter(acc => acc.sub_category !== 'sales_discount').reduce((sum, acc) => sum + acc.finalBalance, 0);
            const salesDiscounts = categorizedData.revenue.filter(acc => acc.sub_category === 'sales_discount').reduce((sum, acc) => sum + acc.finalBalance, 0);
            const netRevenue = grossRevenue - salesDiscounts;
            const totalCOGS = categorizedData.cogs.reduce((sum, acc) => sum + acc.finalBalance, 0);
            const grossProfit = netRevenue - totalCOGS;
            const depreciationExpense = categorizedData.operatingExpenses.find(acc => acc.sub_category === 'depreciation')?.finalBalance || 0;
            const amortizationExpense = categorizedData.operatingExpenses.find(acc => acc.sub_category === 'amortization')?.finalBalance || 0;
            const adminExpenses = categorizedData.operatingExpenses.filter(acc => !['depreciation', 'amortization', 'zakat_expense'].includes(acc.sub_category)).reduce((sum, acc) => sum + acc.finalBalance, 0);
            const otherRevenues = -categorizedData.otherRevenues.reduce((sum, acc) => sum + acc.finalBalance, 0);
            const zakatExpense = categorizedData.operatingExpenses.find(acc => acc.sub_category === 'zakat_expense')?.finalBalance || 0;
            const netProfitBeforeZakat = grossProfit + otherRevenues - (adminExpenses + depreciationExpense + amortizationExpense);
            const netProfit = netProfitBeforeZakat - zakatExpense;
            return { 
                totalRevenue: netRevenue, totalCOGS, grossProfit, adminExpenses, 
                depreciationExpense, amortizationExpense, otherRevenues, netProfitBeforeZakat, 
                zakatExpense, netProfit, allAccounts: categorizedData 
            };
        }

        function generateBalanceSheet(categorizedData, netProfit, isPriorYear = false) {
            const currentAssets = categorizedData.currentAssets.reduce((sum, acc) => sum + acc.finalBalance, 0);
            const fixedAssets = categorizedData.fixedAssets.reduce((sum, acc) => sum + acc.finalBalance, 0);
            const totalAssets = currentAssets + fixedAssets;
            const currentLiabilities = categorizedData.currentLiabilities.reduce((sum, acc) => sum + acc.finalBalance, 0);
            const longTermLiabilities = categorizedData.longTermLiabilities.reduce((sum, acc) => sum + acc.finalBalance, 0);
            const totalLiabilities = currentLiabilities + longTermLiabilities;
            const equityAccountsBalance = categorizedData.equity.reduce((sum, acc) => sum + acc.finalBalance, 0);
            const totalEquity = isPriorYear ? equityAccountsBalance : (equityAccountsBalance - netProfit);
            const accountingEquationBalance = totalAssets + totalLiabilities + totalEquity;
            const isBalanced = Math.abs(accountingEquationBalance) < 2;
            return {
                currentAssets, fixedAssets, totalAssets,
                currentLiabilities: -currentLiabilities,
                longTermLiabilities: -longTermLiabilities,
                totalLiabilities: -totalLiabilities,
                totalEquity: -totalEquity,
                isBalanced, accountingEquationBalance,
                allAccounts: categorizedData
            };
        }

        function generateEquityStatement(categorizedData, netProfit, categorizedDataPrior) {
            const openingCapital = -(categorizedDataPrior.equity.find(acc => acc.sub_category === 'capital')?.finalBalance || 0);
            const openingRetained = -(categorizedDataPrior.equity.find(acc => acc.sub_category === 'retained_earnings')?.finalBalance || 0);
            const openingBalance = openingCapital + openingRetained;
            const capitalAdditions = (categorizedData.equity.find(acc => acc.sub_category === 'capital')?.finalBalance || 0) - 
                                     (categorizedDataPrior.equity.find(acc => acc.sub_category === 'capital')?.finalBalance || 0);
            const closingBalance = openingBalance - capitalAdditions + netProfit;
            return { 
                openingBalance, capitalAdditions, netProfit, closingBalance,
                allAccounts: categorizedData
            };
        }

        function generateCashFlowStatement(incomeData, currentBalance, priorBalance) {
            const netProfitBeforeZakat = incomeData.netProfitBeforeZakat;
            const depreciation = incomeData.depreciationExpense;
            const changeInReceivables = currentBalance.currentAssets - priorBalance.currentAssets;
            const changeInPayables = currentBalance.currentLiabilities - priorBalance.currentLiabilities;
            const cashFlowFromOps = netProfitBeforeZakat + depreciation - changeInReceivables + changeInPayables;
            const cashFlowFromInv = 0;
            const cashFlowFromFin = 0;
            const netCashChange = cashFlowFromOps + cashFlowFromInv + cashFlowFromFin;
            const openingCash = (currentBalance.currentAssets - netCashChange);
            const closingCash = openingCash + netCashChange;
            return { 
                netProfitBeforeZakat, depreciation, changeInReceivables, changeInPayables, 
                cashFlowFromOps, cashFlowFromInv, cashFlowFromFin, netCashChange, openingCash, closingCash 
            };
        }

 // --- دالة تنسيق العملة المطورة (V2) ---
function formatCurrency(value, useParenthesesForNegative = true) {
    if (value === null || value === undefined || isNaN(value)) return '-';
    
    const num = Math.abs(value);
    const formattedNum = new Intl.NumberFormat('ar-SA', { 
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(num);

    if (value < 0 && useParenthesesForNegative) {
        return `(${formattedNum})`;
    }
    return formattedNum;
}

        function showError(message) {
            const container = document.getElementById('loadingIndicator');
            container.innerHTML = `
                <div class="alert alert-danger text-center" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                </div>`;
        }

        function scrollToNote(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                document.getElementById('notesSection').style.display = 'block';
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                element.style.backgroundColor = 'rgba(0, 170, 255, 0.1)';
                setTimeout(() => {
                    element.style.backgroundColor = '';
                }, 2000);
            }
        }

        function toggleView(elementId, viewType) {
            const summaryDiv = document.getElementById(`${elementId}Summary`);
            const detailedDiv = document.getElementById(`${elementId}Detailed`);
            
            // Update button states
            const buttons = document.querySelectorAll(`#${elementId}Section .btn-group button, #${elementId.replace('Section', '')}Section .btn-group button`);
            buttons.forEach(btn => btn.classList.remove('active'));
            
            if (viewType === 'summary') {
                if (summaryDiv) summaryDiv.style.display = 'block';
                if (detailedDiv) detailedDiv.style.display = 'none';
                buttons[0].classList.add('active');
            } else {
                if (summaryDiv) summaryDiv.style.display = 'none';
                if (detailedDiv) detailedDiv.style.display = 'block';
                buttons[1].classList.add('active');
            }
        }

        function toggleComparisonMode() {
            const comparisonMode = document.getElementById('comparisonMode').checked;
            localStorage.setItem('comparisonMode', comparisonMode);
            initializeDashboard();
        }

        function displayIncomeStatement(fullIncomeData, comparisonMode) {
            const container = document.getElementById('incomeStatementContent');
            const detailedContainer = document.getElementById('incomeStatementDetailedContent');
            const current = fullIncomeData.current;
            const prior = fullIncomeData.prior;
            
            if (current.totalRevenue === 0 && current.adminExpenses === 0) {
                container.innerHTML = `<div class="data-empty">لا توجد بيانات كافية لعرض قائمة الدخل.</div>`;
                detailedContainer.innerHTML = `<div class="data-empty">لا توجد بيانات كافية لعرض قائمة الدخل التفصيلية.</div>`;
                return;
            }
            
            // Summary View
            let html = `<table class="financial-table"><thead><tr><th width="50%">البند</th><th>إيضاح</th><th>السنة الحالية</th>${comparisonMode ? '<th>السنة السابقة</th>' : ''}</tr></thead><tbody>`;
            html += `<tr><td>صافي الإيرادات</td><td><span class="note-link" onclick="scrollToNote('note11Section')" aria-label="انتقل إلى إيضاح الإيرادات">11</span></td><td class="amount">${formatCurrency(current.totalRevenue)}</td>${comparisonMode ? `<td class="amount">${formatCurrency(prior.totalRevenue)}</td>` : ''}</tr>`;
            html += `<tr><td>يخصم: تكلفة الإيرادات</td><td></td><td class="amount negative">(${formatCurrency(current.totalCOGS)})</td>${comparisonMode ? `<td class="amount negative">(${formatCurrency(prior.totalCOGS)})</td>` : ''}</tr>`;
            html += `<tr class="sub-total"><td><strong>مجمل الدخل</strong></td><td></td><td class="amount"><strong>${formatCurrency(current.grossProfit)}</strong></td>${comparisonMode ? `<td class="amount"><strong>${formatCurrency(prior.grossProfit)}</strong></td>` : ''}</tr>`;
            html += `<tr><td>يضاف: الإيرادات الأخرى</td><td></td><td class="amount">${formatCurrency(current.otherRevenues)}</td>${comparisonMode ? `<td class="amount">${formatCurrency(prior.otherRevenues)}</td>` : ''}</tr>`;
            html += `<tr><td>يخصم: مصروفات عمومية وإدارية</td><td><span class="note-link" onclick="scrollToNote('note12Section')" aria-label="انتقل إلى إيضاح المصروفات">12</span></td><td class="amount negative">(${formatCurrency(current.adminExpenses)})</td>${comparisonMode ? `<td class="amount negative">(${formatCurrency(prior.adminExpenses)})</td>` : ''}</tr>`;
            html += `<tr><td>يخصم: اهلاك للممتلكات والمعدات</td><td><span class="note-link" onclick="scrollToNote('note7Section')" aria-label="انتقل إلى إيضاح الممتلكات">7</span></td><td class="amount negative">(${formatCurrency(current.depreciationExpense)})</td>${comparisonMode ? `<td class="amount negative">(${formatCurrency(prior.depreciationExpense)})</td>` : ''}</tr>`;
            html += `<tr class="sub-total"><td><strong>صافي الدخل قبل خصم الزكاة</strong></td><td></td><td class="amount"><strong>${formatCurrency(current.netProfitBeforeZakat)}</strong></td>${comparisonMode ? `<td class="amount"><strong>${formatCurrency(prior.netProfitBeforeZakat)}</strong></td>` : ''}</tr>`;
            html += `<tr><td>يخصم: الزكاة الشرعية</td><td><span class="note-link" onclick="scrollToNote('note10Section')" aria-label="انتقل إلى إيضاح مخصص الزكاة والضريبة">10</span></td><td class="amount negative">(${formatCurrency(current.zakatExpense)})</td>${comparisonMode ? `<td class="amount negative">(${formatCurrency(prior.zakatExpense)})</td>` : ''}</tr>`;
const netProfitLabel = current.netProfit >= 0 ? 'صافي الدخل' : 'صافي الخسارة';
html += `<tr class="total"><td><strong>${netProfitLabel}</strong></td><td></td><td class="amount ${current.netProfit < 0 ? 'negative' : ''}"><strong>${formatCurrency(current.netProfit)}</strong></td>${comparisonMode ? `<td class="amount ${prior.netProfit < 0 ? 'negative' : ''}"><strong>${formatCurrency(prior.netProfit)}</strong></td>` : ''}</tr>`;
            html += `</tbody></table>`;
            container.innerHTML = html;
            
            // Detailed View
            let detailedHtml = `<table class="financial-table"><thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>السنة الحالية</th>${comparisonMode ? '<th>السنة السابقة</th>' : ''}</tr></thead><tbody>`;
            
            // Add revenue accounts
            current.allAccounts.revenue.forEach(acc => {
                const priorAcc = prior.allAccounts.revenue.find(a => a.account_id === acc.account_id);
                detailedHtml += `<tr>
                    <td>${acc.account_id || '-'}</td>
                    <td>${acc.name}</td>
                    <td class="amount">${formatCurrency(Math.abs(acc.finalBalance))}</td>
                    ${comparisonMode ? `<td class="amount">${formatCurrency(Math.abs(priorAcc?.finalBalance || 0))}</td>` : ''}
                </tr>`;
            });
            
            // Add COGS accounts
            current.allAccounts.cogs.forEach(acc => {
                const priorAcc = prior.allAccounts.cogs.find(a => a.account_id === acc.account_id);
                detailedHtml += `<tr>
                    <td>${acc.account_id || '-'}</td>
                    <td>${acc.name}</td>
                    <td class="amount negative">(${formatCurrency(Math.abs(acc.finalBalance))})</td>
                    ${comparisonMode ? `<td class="amount negative">(${formatCurrency(Math.abs(priorAcc?.finalBalance || 0))})</td>` : ''}
                </tr>`;
            });
            
            // Add expense accounts
            current.allAccounts.operatingExpenses.forEach(acc => {
                const priorAcc = prior.allAccounts.operatingExpenses.find(a => a.account_id === acc.account_id);
                detailedHtml += `<tr>
                    <td>${acc.account_id || '-'}</td>
                    <td>${acc.name}</td>
                    <td class="amount negative">(${formatCurrency(Math.abs(acc.finalBalance))})</td>
                    ${comparisonMode ? `<td class="amount negative">(${formatCurrency(Math.abs(priorAcc?.finalBalance || 0))})</td>` : ''}
                </tr>`;
            });
            
            detailedHtml += `</tbody></table>`;
            detailedContainer.innerHTML = detailedHtml;
        }

        function displayBalanceSheet(balanceData, auditData, comparisonMode) {
            const container = document.getElementById('balanceSheetContent');
            const detailedContainer = document.getElementById('balanceSheetDetailedContent');
            
            // Check if balanceData is valid
            if (!balanceData || !balanceData.current || balanceData.current.totalAssets === 0) {
                container.innerHTML = `<div class="data-empty">لا توجد بيانات كافية لعرض قائمة المركز المالي.</div>`;
                detailedContainer.innerHTML = `<div class="data-empty">لا توجد بيانات كافية لعرض قائمة المركز المالي التفصيلية.</div>`;
                return;
            }
            
            const balanceClass = balanceData.current.isBalanced ? 'accounting-correct' : 'accounting-warning';
            
            // Summary View
            let html = `<div class="row"><div class="col-md-6"><h5 class="text-primary mb-3">الأصول</h5><table class="financial-table"><tbody>`;
            html += `<tr><td>النقد وما في حكمه</td><td><span class="note-link" onclick="scrollToNote('note3Section')" aria-label="انتقل إلى إيضاح النقدية">3</span></td><td class="amount">${formatCurrency(balanceData.current.currentAssets)}</td></tr>`;
            html += `<tr><td>مدينون تجاريون</td><td><span class="note-link" onclick="scrollToNote('note4Section')" aria-label="انتقل إلى إيضاح المدينون التجاريون">4</span></td><td class="amount">${formatCurrency(balanceData.current.currentAssets)}</td></tr>`;
            html += `<tr><td>أرصدة مدينة أخرى</td><td><span class="note-link" onclick="scrollToNote('note5Section')" aria-label="انتقل إلى إيضاح أرصدة مدينة أخرى">5</span></td><td class="amount">${formatCurrency(balanceData.current.currentAssets)}</td></tr>`;
            html += `<tr><td>المخزون</td><td><span class="note-link" onclick="scrollToNote('note6Section')" aria-label="انتقل إلى إيضاح المخزون">6</span></td><td class="amount">${formatCurrency(balanceData.current.currentAssets)}</td></tr>`;
            html += `<tr><td><strong>مجموع الأصول المتداولة</strong></td><td></td><td class="amount"><strong>${formatCurrency(balanceData.current.currentAssets)}</strong></td></tr>`;
            html += `<tr><td>الممتلكات والآلات والمعدات، بالصافي</td><td><span class="note-link" onclick="scrollToNote('note7Section')" aria-label="انتقل إلى إيضاح الممتلكات">7</span></td><td class="amount">${formatCurrency(balanceData.current.fixedAssets)}</td></tr>`;
            html += `<tr><td><strong>مجموع الأصول غير المتداولة</strong></td><td></td><td class="amount"><strong>${formatCurrency(balanceData.current.fixedAssets)}</strong></td></tr>`;
            html += `<tr class="total"><td><strong>إجمالي الأصول</strong></td><td></td><td class="amount"><strong>${formatCurrency(balanceData.current.totalAssets)}</strong></td></tr>`;
            html += `</tbody></table></div><div class="col-md-6"><h5 class="text-primary mb-3">الالتزامات وحقوق الملكية</h5><table class="financial-table"><tbody>`;
            html += `<tr><td>دائنون تجاريون</td><td><span class="note-link" onclick="scrollToNote('note8Section')" aria-label="انتقل إلى إيضاح الدائنون التجاريون">8</span></td><td class="amount">${formatCurrency(balanceData.current.currentLiabilities)}</td></tr>`;
            html += `<tr><td>أرصدة دائنة أخرى</td><td><span class="note-link" onclick="scrollToNote('note9Section')" aria-label="انتقل إلى إيضاح أرصدة دائنة أخرى">9</span></td><td class="amount">${formatCurrency(balanceData.current.currentLiabilities)}</td></tr>`;
            html += `<tr><td>مخصص الزكاة والضريبة</td><td><span class="note-link" onclick="scrollToNote('note10Section')" aria-label="انتقل إلى إيضاح مخصص الزكاة والضريبة">10</span></td><td class="amount">${formatCurrency(balanceData.current.currentLiabilities)}</td></tr>`;
            html += `<tr><td><strong>مجموع الالتزامات المتداولة</strong></td><td></td><td class="amount"><strong>${formatCurrency(balanceData.current.currentLiabilities)}</strong></td></tr>`;
            html += `<tr><td>قروض وتمويل طويلة الأجل</td><td></td><td class="amount">${formatCurrency(balanceData.current.longTermLiabilities)}</td></tr>`;
            html += `<tr><td><strong>مجموع الالتزامات غير المتداولة</strong></td><td></td><td class="amount"><strong>${formatCurrency(balanceData.current.longTermLiabilities)}</strong></td></tr>`;
            html += `<tr class="sub-total"><td><strong>مجموع الالتزامات</strong></td><td></td><td class="amount"><strong>${formatCurrency(balanceData.current.totalLiabilities)}</strong></td></tr>`;
            html += `<tr><td>حقوق الملكية</td><td></td><td class="amount">${formatCurrency(balanceData.current.totalEquity)}</td></tr>`;
            html += `<tr class="total"><td><strong>إجمالي الالتزامات وحقوق الملكية</strong></td><td></td><td class="amount"><strong>${formatCurrency(balanceData.current.totalLiabilities + balanceData.current.totalEquity)}</strong></td></tr>`;
            html += `</tbody></table></div></div>`;
            
            if (!balanceData.current.isBalanced) {
                html += `<div class="alert alert-danger mt-3 no-print"><i class="fas fa-exclamation-triangle me-2"></i><strong>المعادلة غير متوازنة.</strong> الفرق: ${formatCurrency(balanceData.current.accountingEquationBalance)}</div>`;
            } else {
                html += `<div class="alert alert-success mt-3 no-print"><i class="fas fa-check-circle me-2"></i><strong>المعادلة المحاسبية متوازنة.</strong></div>`;
            }
            
            const clearingAccounts = (auditData.trialBalance || []).filter(acc => acc.category === 'clearing' && Math.abs(calculateFinalBalance(acc, auditData.adjustments)) > 1);
            if (clearingAccounts.length > 0) {
                html += `<div class="alert alert-info mt-3 no-print"><i class="fas fa-bell me-2"></i><strong>تنبيه تسوية:</strong> تم العثور على حسابات رقابية ذات رصيد. يجب تسويتها وإقفالها.<ul>`;
                clearingAccounts.forEach(acc => {
                    html += `<li>${acc.name}: ${formatCurrency(acc.finalBalance)}</li>`;
                });
                html += `</ul></div>`;
            }
            
            container.innerHTML = html;
            container.closest('.financial-statement').className = `financial-statement ${balanceClass}`;
            
            // Detailed View
            let detailedHtml = `<div class="row"><div class="col-md-6"><h5 class="text-primary mb-3">الأصول</h5><table class="financial-table"><thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>السنة الحالية</th>${comparisonMode ? '<th>السنة السابقة</th>' : ''}</tr></thead><tbody>`;
            
            // Add current assets
            balanceData.current.allAccounts.currentAssets.forEach(acc => {
                const priorAcc = balanceData.prior.allAccounts.currentAssets.find(a => a.account_id === acc.account_id);
                detailedHtml += `<tr>
                    <td>${acc.account_id || '-'}</td>
                    <td>${acc.name}</td>
                    <td class="amount">${formatCurrency(Math.abs(acc.finalBalance))}</td>
                    ${comparisonMode ? `<td class="amount">${formatCurrency(Math.abs(priorAcc?.finalBalance || 0))}</td>` : ''}
                </tr>`;
            });
            
            detailedHtml += `<tr class="sub-total"><td colspan="2"><strong>مجموع الأصول المتداولة</strong></td><td class="amount"><strong>${formatCurrency(balanceData.current.currentAssets)}</strong></td>${comparisonMode ? `<td class="amount"><strong>${formatCurrency(balanceData.prior.currentAssets)}</strong></td>` : ''}</tr>`;
            
            // Add fixed assets
            balanceData.current.allAccounts.fixedAssets.forEach(acc => {
                const priorAcc = balanceData.prior.allAccounts.fixedAssets.find(a => a.account_id === acc.account_id);
                detailedHtml += `<tr>
                    <td>${acc.account_id || '-'}</td>
                    <td>${acc.name}</td>
                    <td class="amount">${formatCurrency(Math.abs(acc.finalBalance))}</td>
                    ${comparisonMode ? `<td class="amount">${formatCurrency(Math.abs(priorAcc?.finalBalance || 0))}</td>` : ''}
                </tr>`;
            });
            
            detailedHtml += `<tr class="sub-total"><td colspan="2"><strong>مجموع الأصول غير المتداولة</strong></td><td class="amount"><strong>${formatCurrency(balanceData.current.fixedAssets)}</strong></td>${comparisonMode ? `<td class="amount"><strong>${formatCurrency(balanceData.prior.fixedAssets)}</strong></td>` : ''}</tr>`;
            detailedHtml += `<tr class="total"><td colspan="2"><strong>إجمالي الأصول</strong></td><td class="amount"><strong>${formatCurrency(balanceData.current.totalAssets)}</strong></td>${comparisonMode ? `<td class="amount"><strong>${formatCurrency(balanceData.prior.totalAssets)}</strong></td>` : ''}</tr>`;
            detailedHtml += `</tbody></table></div><div class="col-md-6"><h5 class="text-primary mb-3">الالتزامات وحقوق الملكية</h5><table class="financial-table"><thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>السنة الحالية</th>${comparisonMode ? '<th>السنة السابقة</th>' : ''}</tr></thead><tbody>`;
            
            // Add current liabilities
            balanceData.current.allAccounts.currentLiabilities.forEach(acc => {
                const priorAcc = balanceData.prior.allAccounts.currentLiabilities.find(a => a.account_id === acc.account_id);
                detailedHtml += `<tr>
                    <td>${acc.account_id || '-'}</td>
                    <td>${acc.name}</td>
                    <td class="amount">${formatCurrency(Math.abs(acc.finalBalance))}</td>
                    ${comparisonMode ? `<td class="amount">${formatCurrency(Math.abs(priorAcc?.finalBalance || 0))}</td>` : ''}
                </tr>`;
            });
            
            detailedHtml += `<tr class="sub-total"><td colspan="2"><strong>مجموع الالتزامات المتداولة</strong></td><td class="amount"><strong>${formatCurrency(Math.abs(balanceData.current.currentLiabilities))}</strong></td>${comparisonMode ? `<td class="amount"><strong>${formatCurrency(Math.abs(balanceData.prior.currentLiabilities))}</strong></td>` : ''}</tr>`;
            
            // Add long-term liabilities
            balanceData.current.allAccounts.longTermLiabilities.forEach(acc => {
                const priorAcc = balanceData.prior.allAccounts.longTermLiabilities.find(a => a.account_id === acc.account_id);
                detailedHtml += `<tr>
                    <td>${acc.account_id || '-'}</td>
                    <td>${acc.name}</td>
                    <td class="amount">${formatCurrency(Math.abs(acc.finalBalance))}</td>
                    ${comparisonMode ? `<td class="amount">${formatCurrency(Math.abs(priorAcc?.finalBalance || 0))}</td>` : ''}
                </tr>`;
            });
            
            detailedHtml += `<tr class="sub-total"><td colspan="2"><strong>مجموع الالتزامات غير المتداولة</strong></td><td class="amount"><strong>${formatCurrency(Math.abs(balanceData.current.longTermLiabilities))}</strong></td>${comparisonMode ? `<td class="amount"><strong>${formatCurrency(Math.abs(balanceData.prior.longTermLiabilities))}</strong></td>` : ''}</tr>`;
            detailedHtml += `<tr class="total"><td colspan="2"><strong>مجموع الالتزامات</strong></td><td class="amount"><strong>${formatCurrency(Math.abs(balanceData.current.totalLiabilities))}</strong></td>${comparisonMode ? `<td class="amount"><strong>${formatCurrency(Math.abs(balanceData.prior.totalLiabilities))}</strong></td>` : ''}</tr>`;
            
            // Add equity
            balanceData.current.allAccounts.equity.forEach(acc => {
                const priorAcc = balanceData.prior.allAccounts.equity.find(a => a.account_id === acc.account_id);
                detailedHtml += `<tr>
                    <td>${acc.account_id || '-'}</td>
                    <td>${acc.name}</td>
                    <td class="amount">${formatCurrency(Math.abs(acc.finalBalance))}</td>
                    ${comparisonMode ? `<td class="amount">${formatCurrency(Math.abs(priorAcc?.finalBalance || 0))}</td>` : ''}
                </tr>`;
            });
            
            detailedHtml += `<tr class="total"><td colspan="2"><strong>إجمالي الالتزامات وحقوق الملكية</strong></td><td class="amount"><strong>${formatCurrency(Math.abs(balanceData.current.totalLiabilities + balanceData.current.totalEquity))}</strong></td>${comparisonMode ? `<td class="amount"><strong>${formatCurrency(Math.abs(balanceData.prior.totalLiabilities + balanceData.prior.totalEquity))}</strong></td>` : ''}</tr>`;
            detailedHtml += `</tbody></table></div></div>`;
            
            detailedContainer.innerHTML = detailedHtml;
        }

        function displayEquityStatement(equityData, comparisonMode) {
            const container = document.getElementById('equityStatementContent');
            const detailedContainer = document.getElementById('equityStatementDetailedContent');
            
            if (!equityData || equityData.current.openingBalance === 0 && equityData.current.netProfit === 0) {
                container.innerHTML = `<div class="data-empty"><i class="fas fa-users fa-3x mb-3 text-muted"></i><h5 class="text-muted">لا توجد بيانات كافية لحقوق الملكية.</h5></div>`;
                detailedContainer.innerHTML = `<div class="data-empty"><i class="fas fa-users fa-3x mb-3 text-muted"></i><h5 class="text-muted">لا توجد بيانات كافية لحقوق الملكية.</h5></div>`;
                return;
            }
            
            // Summary View
            let html = `<table class="financial-table"><thead><tr><th>البيان</th><th>رأس المال</th><th>أرباح مبقاة</th><th>الإجمالي</th></tr></thead><tbody>`;
            html += `<tr><td>الرصيد في بداية الفترة</td><td class="amount">${formatCurrency(equityData.current.openingBalance)}</td><td class="amount">0</td><td class="amount">${formatCurrency(equityData.current.openingBalance)}</td></tr>`;
            html += `<tr><td>زيادة رأس المال</td><td class="amount">${formatCurrency(equityData.current.capitalAdditions)}</td><td class="amount"></td><td class="amount">${formatCurrency(equityData.current.capitalAdditions)}</td></tr>`;
            html += `<tr><td>صافي دخل السنة</td><td class="amount"></td><td class="amount ${equityData.current.netProfit >= 0 ? 'positive' : 'negative'}">${formatCurrency(equityData.current.netProfit)}</td><td class="amount">${formatCurrency(equityData.current.netProfit)}</td></tr>`;
            html += `<tr class="total"><td><strong>الرصيد في نهاية الفترة</strong></td><td class="amount"><strong>${formatCurrency(equityData.current.openingBalance + equityData.current.capitalAdditions)}</strong></td><td class="amount"><strong>${formatCurrency(equityData.current.netProfit)}</strong></td><td class="amount"><strong>${formatCurrency(equityData.current.closingBalance)}</strong></td></tr>`;
            html += `</tbody></table>`;
            container.innerHTML = html;
            
            // Detailed View
            let detailedHtml = `<table class="financial-table"><thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>السنة الحالية</th>${comparisonMode ? '<th>السنة السابقة</th>' : ''}</tr></thead><tbody>`;
            
            // Add equity accounts
            equityData.current.allAccounts.equity.forEach(acc => {
                const priorAcc = equityData.prior.allAccounts.equity.find(a => a.account_id === acc.account_id);
                detailedHtml += `<tr>
                    <td>${acc.account_id || '-'}</td>
                    <td>${acc.name}</td>
                    <td class="amount">${formatCurrency(Math.abs(acc.finalBalance))}</td>
                    ${comparisonMode ? `<td class="amount">${formatCurrency(Math.abs(priorAcc?.finalBalance || 0))}</td>` : ''}
                </tr>`;
            });
            
            detailedHtml += `</tbody></table>`;
            detailedContainer.innerHTML = detailedHtml;
        }

        function displayCashFlowStatement(cashFlowData, comparisonMode) {
            const container = document.getElementById('cashFlowContent');
            const detailedContainer = document.getElementById('cashFlowDetailedContent');
            
            let html = `<table class="financial-table"><tbody>`;
            html += `<tr><td colspan="2"><strong>التدفقات النقدية من الأنشطة التشغيلية:</strong></td></tr>`;
            html += `<tr><td>صافي الدخل قبل الزكاة</td><td class="amount">${formatCurrency(cashFlowData.current.netProfitBeforeZakat)}</td></tr>`;
            html += `<tr><td>تعديلات لتسوية الدخل إلى صافي التدفقات النقدية:</td><td></td></tr>`;
            html += `<tr><td>&nbsp;&nbsp;إهلاك</td><td class="amount positive">${formatCurrency(cashFlowData.current.depreciation)}</td></tr>`;
            html += `<tr><td>&nbsp;&nbsp;التغير في الذمم المدينة</td><td class="amount negative">(${formatCurrency(cashFlowData.current.changeInReceivables)})</td></tr>`;
            html += `<tr><td>&nbsp;&nbsp;التغير في الذمم الدائنة</td><td class="amount positive">${formatCurrency(cashFlowData.current.changeInPayables)}</td></tr>`;
            html += `<tr class="sub-total"><td><strong>صافي التدفقات النقدية من الأنشطة التشغيلية</strong></td><td class="amount"><strong>${formatCurrency(cashFlowData.current.cashFlowFromOps)}</strong></td></tr>`;
            html += `<tr class="total"><td><strong>صافي التغير في النقد</strong></td><td class="amount"><strong>${formatCurrency(cashFlowData.current.netCashChange)}</strong></td></tr>`;
            html += `<tr><td><strong>رصيد النقد في بداية السنة</strong></td><td class="amount">${formatCurrency(cashFlowData.current.openingCash)}</td></tr>`;
            html += `<tr class="total"><td><strong>رصيد النقد في نهاية السنة</strong></td><td class="amount"><strong>${formatCurrency(cashFlowData.current.closingCash)}</strong></td></tr>`;
            html += `</tbody></table>`;
            container.innerHTML = html;
            
            // Detailed view would show the detailed breakdown of cash flow components
            detailedContainer.innerHTML = `<div class="alert alert-info">الرؤية التفصيلية لقائمة التدفقات النقدية قيد التطوير.</div>`;
        }

        function displayKPIDashboard(incomeData, balanceData) {
            const container = document.getElementById('kpiContent');
            
            // Check if data is available
            if (!incomeData || !balanceData || !incomeData.current || !balanceData.current) {
                container.innerHTML = `<div class="data-empty">لا توجد بيانات كافية لعرض مؤشرات الأداء.</div>`;
                return;
            }
            
            const netProfitMargin = incomeData.current.totalRevenue > 0 ? ((incomeData.current.netProfit / incomeData.current.totalRevenue) * 100) : 0;
            const grossProfitMargin = incomeData.current.totalRevenue > 0 ? ((incomeData.current.grossProfit / incomeData.current.totalRevenue) * 100) : 0;
            const currentRatio = balanceData.current.currentLiabilities > 0 ? (balanceData.current.currentAssets / balanceData.current.currentLiabilities) : 0;
            const debtRatio = balanceData.current.totalAssets > 0 ? ((balanceData.current.totalLiabilities / balanceData.current.totalAssets) * 100) : 0;
            const roe = balanceData.current.totalEquity > 0 ? ((incomeData.current.netProfit / balanceData.current.totalEquity) * 100) : 0;
            
            let html = `<div class="row g-3">`;
            html += `
                <div class="col-md-4 col-lg-3">
                    <div class="kpi-card">
                        <div class="kpi-icon" style="color: var(--color-primary);"><i class="fas fa-dollar-sign"></i></div>
                        <div class="kpi-label">صافي الإيرادات</div>
                        <div class="kpi-value" style="color: var(--color-primary);">${formatCurrency(incomeData.current.totalRevenue)}</div>
                        <div class="kpi-change positive"><i class="fas fa-arrow-up me-1"></i>10% مقارنة بالعام السابق</div>
                    </div>
                </div>
                <div class="col-md-4 col-lg-3">
                    <div class="kpi-card">
                        <div class="kpi-icon" style="color: ${incomeData.current.netProfit >= 0 ? 'var(--color-success)' : 'var(--color-danger)'};"><i class="fas fa-${incomeData.current.netProfit >= 0 ? 'chart-line' : 'chart-line-down'}"></i></div>
                        <div class="kpi-label">صافي الربح</div>
                        <div class="kpi-value ${incomeData.current.netProfit >= 0 ? 'positive' : 'negative'}">${formatCurrency(incomeData.current.netProfit)}</div>
                        <div class="kpi-change ${incomeData.current.netProfit >= 0 ? 'positive' : 'negative'}"><i class="fas fa-arrow-${incomeData.current.netProfit >= 0 ? 'up' : 'down'} me-1"></i>${Math.abs(incomeData.current.netProfit >= 0 ? 15 : -10)}% مقارنة بالعام السابق</div>
                    </div>
                </div>
                <div class="col-md-4 col-lg-3">
                    <div class="kpi-card">
                        <div class="kpi-icon" style="color: var(--color-warning);"><i class="fas fa-percentage"></i></div>
                        <div class="kpi-label">هامش الربح الصافي</div>
                        <div class="kpi-value" style="color: var(--color-warning);">${netProfitMargin.toFixed(1)}%</div>
                        <div class="kpi-change neutral">من إجمالي الإيرادات</div>
                    </div>
                </div>
                <div class="col-md-4 col-lg-3">
                    <div class="kpi-card">
                        <div class="kpi-icon" style="color: #6f42c1;"><i class="fas fa-building"></i></div>
                        <div class="kpi-label">إجمالي الأصول</div>
                        <div class="kpi-value" style="color: #6f42c1;">${formatCurrency(balanceData.current.totalAssets)}</div>
                        <div class="kpi-change positive"><i class="fas fa-arrow-up me-1"></i>5% مقارنة بالعام السابق</div>
                    </div>
                </div>
                <div class="col-md-4 col-lg-3">
                    <div class="kpi-card">
                        <div class="kpi-icon" style="color: #17a2b8;"><i class="fas fa-chart-pie"></i></div>
                        <div class="kpi-label">هامش الربح الإجمالي</div>
                        <div class="kpi-value" style="color: #17a2b8;">${grossProfitMargin.toFixed(1)}%</div>
                        <div class="kpi-change neutral">من إجمالي الإيرادات</div>
                    </div>
                </div>
                <div class="col-md-4 col-lg-3">
                    <div class="kpi-card">
                        <div class="kpi-icon" style="color: #dc3545;"><i class="fas fa-balance-scale"></i></div>
                        <div class="kpi-label">نسبة السيولة</div>
                        <div class="kpi-value" style="color: #dc3545;">${currentRatio.toFixed(2)}</div>
                        <div class="kpi-change neutral">الأصول المتداولة / الالتزامات المتداولة</div>
                    </div>
                </div>
                <div class="col-md-4 col-lg-3">
                    <div class="kpi-card">
                        <div class="kpi-icon" style="color: #ffc107;"><i class="fas fa-hand-holding-usd"></i></div>
                        <div class="kpi-label">نسبة الدين</div>
                        <div class="kpi-value" style="color: #ffc107;">${debtRatio.toFixed(1)}%</div>
                        <div class="kpi-change neutral">الالتزامات / الأصول</div>
                    </div>
                </div>
                <div class="col-md-4 col-lg-3">
                    <div class="kpi-card">
                        <div class="kpi-icon" style="color: #28a745;"><i class="fas fa-chart-bar"></i></div>
                        <div class="kpi-label">العائد على حقوق الملكية</div>
                        <div class="kpi-value" style="color: #28a745;">${roe.toFixed(1)}%</div>
                        <div class="kpi-change neutral">صافي الربح / حقوق الملكية</div>
                    </div>
                </div>
            </div>`;
            container.innerHTML = html;
            document.getElementById('kpiDashboard').style.display = 'block';
        }

        function renderNote1(auditData) {
            const container = document.getElementById('note1Content');
            const clientInfo = auditData.clientInfo || {};
            
            let html = `<div class="note-description">
                <p>${clientInfo.name || 'الشركة'} هي منشأة ${clientInfo.type || 'تجارية'} مسجلة في ${clientInfo.location || 'المملكة العربية السعودية'} تحت السجل التجاري رقم ${clientInfo.registrationNumber || 'غير محدد'}.</p>
                <p>النشاط الرئيسي: ${clientInfo.activity || 'غير محدد'}.</p>
                <p>العنوان: ${clientInfo.address || 'غير محدد'}.</p>
            </div>`;
            
            container.innerHTML = html;
        }

        function renderNote2(auditData) {
            const container = document.getElementById('note2Content');
            
            let html = `<div class="note-description">
                <p>تم إعداد القوائم المالية وفقاً لأساس الاستحقاق المحاسبي وبالاستناد إلى المعايير المحاسبية السعودية.</p>
                
                <div class="policy-box">
                    <h6 class="sub-note-title">أساس القياس:</h6>
                    <p>تم إعداد القوائم المالية بالتكلفة التاريخية مع الأخذ في الاعتبار إعادة التقييم لبعض بنود الممتلكات والآلات والمعدات.</p>
                </div>
                
                <div class="policy-box">
                    <h6 class="sub-note-title">الاستهلاك:</h6>
                    <p>يتم احتساب استهلاك الممتلكات والآلات والمعدات بطريقة القسط الثابت على مدى العمر الإنتاجي المقدر للأصل.</p>
                </div>
                
                <div class="policy-box">
                    <h6 class="sub-note-title">تقييم المخزون:</h6>
                    <p>يتم تقييم المخزون بالتكلفة أو صافي القيمة البيعية أيهما أقل.</p>
                </div>
                
                <div class="policy-box">
                    <h6 class="sub-note-title">الإيرادات:</h6>
                    <p>يتم الاعتراف بالإيرادات عند نقل ملكية البضائع أو تقديم الخدمات للعملاء.</p>
                </div>
                
                <div class="policy-box">
                    <h6 class="sub-note-title">الزكاة والضريبة:</h6>
                    <p>يتم احتساب الزكاة وفقاً لأحكام نظام الزكاة في المملكة العربية السعودية.</p>
                </div>
            </div>`;
            
            container.innerHTML = html;
        }

        function renderNote3(auditData) {
// السطر الجديد الصحيح والآمن
const cashAccounts = (auditData.trialBalance || []).filter(acc => 
    acc.category === 'assets' && 
    acc.sub_category && // <-- هذا هو الشرط الذي يمنع الخطأ
    acc.sub_category.includes('cash')
);
            let summaryHTML = '';
            let detailedHTML = '';
            let totalCurrent = 0;
            let totalPrior = 0;
            
            if (cashAccounts.length === 0) {
                summaryHTML = `<tr><td colspan="3" class="text-center">لا توجد حسابات نقدية</td></tr>`;
                detailedHTML = `<tr><td colspan="4" class="text-center">لا توجد حسابات نقدية</td></tr>`;
            } else {
                cashAccounts.forEach(acc => {
                    const balanceCurrent = calculateFinalBalance(acc, auditData.adjustments, false);
                    const balancePrior = calculateFinalBalance(acc, auditData.adjustments, true);
                    totalCurrent += Math.abs(balanceCurrent);
                    totalPrior += Math.abs(balancePrior);
                    detailedHTML += `<tr>
                        <td>${acc.account_id || '-'}</td>
                        <td>${acc.name}</td>
                        <td class="amount">${formatCurrency(Math.abs(balanceCurrent))}</td>
                        <td class="amount">${formatCurrency(Math.abs(balancePrior))}</td>
                    </tr>`;
                });
                
                summaryHTML = `<tr>
                    <td>النقدية وما في حكمها</td>
                    <td class="amount">${formatCurrency(totalCurrent)}</td>
                    <td class="amount">${formatCurrency(totalPrior)}</td>
                </tr>
                <tr class="total">
                    <td><strong>الإجمالي</strong></td>
                    <td class="amount"><strong>${formatCurrency(totalCurrent)}</strong></td>
                    <td class="amount"><strong>${formatCurrency(totalPrior)}</strong></td>
                </tr>`;
            }
            
            document.getElementById('note3SummaryBody').innerHTML = summaryHTML;
            document.getElementById('note3DetailedBody').innerHTML = detailedHTML;
        }

        function renderNote4(auditData) {
            const receivablesAccounts = (auditData.trialBalance || []).filter(acc => acc.category === 'assets' && acc.sub_category === 'trade_receivables');
            let summaryHTML = '';
            let detailedHTML = '';
            let totalCurrent = 0;
            let totalPrior = 0;
            
            if (receivablesAccounts.length === 0) {
                summaryHTML = `<tr><td colspan="3" class="text-center">لا توجد حسابات مدينون تجاريون</td></tr>`;
                detailedHTML = `<tr><td colspan="4" class="text-center">لا توجد حسابات مدينون تجاريون</td></tr>`;
            } else {
                receivablesAccounts.forEach(acc => {
                    const balanceCurrent = calculateFinalBalance(acc, auditData.adjustments, false);
                    const balancePrior = calculateFinalBalance(acc, auditData.adjustments, true);
                    totalCurrent += Math.abs(balanceCurrent);
                    totalPrior += Math.abs(balancePrior);
                    detailedHTML += `<tr>
                        <td>${acc.account_id || '-'}</td>
                        <td>${acc.name}</td>
                        <td class="amount">${formatCurrency(Math.abs(balanceCurrent))}</td>
                        <td class="amount">${formatCurrency(Math.abs(balancePrior))}</td>
                    </tr>`;
                });
                
                summaryHTML = `<tr>
                    <td>مدينون تجاريون</td>
                    <td class="amount">${formatCurrency(totalCurrent)}</td>
                    <td class="amount">${formatCurrency(totalPrior)}</td>
                </tr>
                <tr class="total">
                    <td><strong>الإجمالي</strong></td>
                    <td class="amount"><strong>${formatCurrency(totalCurrent)}</strong></td>
                    <td class="amount"><strong>${formatCurrency(totalPrior)}</strong></td>
                </tr>`;
            }
            
            document.getElementById('note4SummaryBody').innerHTML = summaryHTML;
            document.getElementById('note4DetailedBody').innerHTML = detailedHTML;
        }

        function renderNote5(auditData) {
            const otherReceivablesAccounts = (auditData.trialBalance || []).filter(acc => acc.category === 'assets' && acc.sub_category === 'other_receivables');
            let summaryHTML = '';
            let detailedHTML = '';
            let totalCurrent = 0;
            let totalPrior = 0;
            
            if (otherReceivablesAccounts.length === 0) {
                summaryHTML = `<tr><td colspan="3" class="text-center">لا توجد حسابات أرصدة مدينة أخرى</td></tr>`;
                detailedHTML = `<tr><td colspan="4" class="text-center">لا توجد حسابات أرصدة مدينة أخرى</td></tr>`;
            } else {
                otherReceivablesAccounts.forEach(acc => {
                    const balanceCurrent = calculateFinalBalance(acc, auditData.adjustments, false);
                    const balancePrior = calculateFinalBalance(acc, auditData.adjustments, true);
                    totalCurrent += Math.abs(balanceCurrent);
                    totalPrior += Math.abs(balancePrior);
                    detailedHTML += `<tr>
                        <td>${acc.account_id || '-'}</td>
                        <td>${acc.name}</td>
                        <td class="amount">${formatCurrency(Math.abs(balanceCurrent))}</td>
                        <td class="amount">${formatCurrency(Math.abs(balancePrior))}</td>
                    </tr>`;
                });
                
                summaryHTML = `<tr>
                    <td>أرصدة مدينة أخرى</td>
                    <td class="amount">${formatCurrency(totalCurrent)}</td>
                    <td class="amount">${formatCurrency(totalPrior)}</td>
                </tr>
                <tr class="total">
                    <td><strong>الإجمالي</strong></td>
                    <td class="amount"><strong>${formatCurrency(totalCurrent)}</strong></td>
                    <td class="amount"><strong>${formatCurrency(totalPrior)}</strong></td>
                </tr>`;
            }
            
            document.getElementById('note5SummaryBody').innerHTML = summaryHTML;
            document.getElementById('note5DetailedBody').innerHTML = detailedHTML;
        }

        function renderNote6(auditData) {
            const inventoryAccounts = (auditData.trialBalance || []).filter(acc => acc.category === 'assets' && acc.sub_category === 'inventory');
            let summaryHTML = '';
            let detailedHTML = '';
            let totalCurrent = 0;
            let totalPrior = 0;
            
            if (inventoryAccounts.length === 0) {
                summaryHTML = `<tr><td colspan="3" class="text-center">لا توجد حسابات مخزون</td></tr>`;
                detailedHTML = `<tr><td colspan="4" class="text-center">لا توجد حسابات مخزون</td></tr>`;
            } else {
                inventoryAccounts.forEach(acc => {
                    const balanceCurrent = calculateFinalBalance(acc, auditData.adjustments, false);
                    const balancePrior = calculateFinalBalance(acc, auditData.adjustments, true);
                    totalCurrent += Math.abs(balanceCurrent);
                    totalPrior += Math.abs(balancePrior);
                    detailedHTML += `<tr>
                        <td>${acc.account_id || '-'}</td>
                        <td>${acc.name}</td>
                        <td class="amount">${formatCurrency(Math.abs(balanceCurrent))}</td>
                        <td class="amount">${formatCurrency(Math.abs(balancePrior))}</td>
                    </tr>`;
                });
                
                summaryHTML = `<tr>
                    <td>المخزون</td>
                    <td class="amount">${formatCurrency(totalCurrent)}</td>
                    <td class="amount">${formatCurrency(totalPrior)}</td>
                </tr>
                <tr class="total">
                    <td><strong>الإجمالي</strong></td>
                    <td class="amount"><strong>${formatCurrency(totalCurrent)}</strong></td>
                    <td class="amount"><strong>${formatCurrency(totalPrior)}</strong></td>
                </tr>`;
            }
            
            document.getElementById('note6SummaryBody').innerHTML = summaryHTML;
            document.getElementById('note6DetailedBody').innerHTML = detailedHTML;
        }

        function renderNote7(auditData) {
            const fixedAssets = (auditData.trialBalance || []).filter(acc => acc.category === 'assets' && acc.sub_category === 'fixed_assets');
            let summaryHTML = '';
            let detailedHTML = '';
            let totalCurrentNet = 0;
            let totalPriorNet = 0;
            
            if (fixedAssets.length === 0) {
                summaryHTML = `<tr><td colspan="3" class="text-center">لا توجد حسابات أصول ثابتة</td></tr>`;
                detailedHTML = `<tr><td colspan="11" class="text-center">لا توجد حسابات أصول ثابتة</td></tr>`;
            } else {
                fixedAssets.forEach(acc => {
                    const balanceCurrent = calculateFinalBalance(acc, auditData.adjustments, false);
                    const balancePrior = calculateFinalBalance(acc, auditData.adjustments, true);
                    const cost = balanceCurrent > 0 ? balanceCurrent : 0;
                    const accumDep = balanceCurrent < 0 ? Math.abs(balanceCurrent) : 0;
                    const priorCost = balancePrior > 0 ? balancePrior : 0;
                    const priorAccumDep = balancePrior < 0 ? Math.abs(balancePrior) : 0;
                    const netValueCurrent = cost - accumDep;
                    const netValuePrior = priorCost - priorAccumDep;
                    totalCurrentNet += netValueCurrent;
                    totalPriorNet += netValuePrior;
                    
                    detailedHTML += `<tr>
                        <td>${acc.name}</td>
                        <td class="amount">${formatCurrency(cost)}</td>
                        <td class="amount">0</td>
                        <td class="amount">0</td>
                        <td class="amount">${formatCurrency(cost)}</td>
                        <td class="amount">${formatCurrency(accumDep)}</td>
                        <td class="amount">0</td>
                        <td class="amount">0</td>
                        <td class="amount">${formatCurrency(accumDep)}</td>
                        <td class="amount">${formatCurrency(netValueCurrent)}</td>
                        <td class="amount">${formatCurrency(netValuePrior)}</td>
                    </tr>`;
                });
                
                summaryHTML = `<tr>
                    <td>الممتلكات والآلات والمعدات</td>
                    <td class="amount">${formatCurrency(totalCurrentNet)}</td>
                    <td class="amount">${formatCurrency(totalPriorNet)}</td>
                </tr>
                <tr class="total">
                    <td><strong>الإجمالي</strong></td>
                    <td class="amount"><strong>${formatCurrency(totalCurrentNet)}</strong></td>
                    <td class="amount"><strong>${formatCurrency(totalPriorNet)}</strong></td>
                </tr>`;
            }
            
            document.getElementById('note7SummaryBody').innerHTML = summaryHTML;
            document.getElementById('note7DetailedBody').innerHTML = detailedHTML;
        }

        function renderNote8(auditData) {
            const payablesAccounts = (auditData.trialBalance || []).filter(acc => acc.category === 'liabilities' && acc.sub_category === 'trade_payables');
            let summaryHTML = '';
            let detailedHTML = '';
            let totalCurrent = 0;
            let totalPrior = 0;
            
            if (payablesAccounts.length === 0) {
                summaryHTML = `<tr><td colspan="3" class="text-center">لا توجد حسابات دائنون تجاريون</td></tr>`;
                detailedHTML = `<tr><td colspan="4" class="text-center">لا توجد حسابات دائنون تجاريون</td></tr>`;
            } else {
                payablesAccounts.forEach(acc => {
                    const balanceCurrent = calculateFinalBalance(acc, auditData.adjustments, false);
                    const balancePrior = calculateFinalBalance(acc, auditData.adjustments, true);
                    totalCurrent += Math.abs(balanceCurrent);
                    totalPrior += Math.abs(balancePrior);
                    detailedHTML += `<tr>
                        <td>${acc.account_id || '-'}</td>
                        <td>${acc.name}</td>
                        <td class="amount">${formatCurrency(Math.abs(balanceCurrent))}</td>
                        <td class="amount">${formatCurrency(Math.abs(balancePrior))}</td>
                    </tr>`;
                });
                
                summaryHTML = `<tr>
                    <td>دائنون تجاريون</td>
                    <td class="amount">${formatCurrency(totalCurrent)}</td>
                    <td class="amount">${formatCurrency(totalPrior)}</td>
                </tr>
                <tr class="total">
                    <td><strong>الإجمالي</strong></td>
                    <td class="amount"><strong>${formatCurrency(totalCurrent)}</strong></td>
                    <td class="amount"><strong>${formatCurrency(totalPrior)}</strong></td>
                </tr>`;
            }
            
            document.getElementById('note8SummaryBody').innerHTML = summaryHTML;
            document.getElementById('note8DetailedBody').innerHTML = detailedHTML;
        }

        function renderNote9(auditData) {
            const otherPayablesAccounts = (auditData.trialBalance || []).filter(acc => acc.category === 'liabilities' && acc.sub_category === 'other_payables');
            let summaryHTML = '';
            let detailedHTML = '';
            let totalCurrent = 0;
            let totalPrior = 0;
            
            if (otherPayablesAccounts.length === 0) {
                summaryHTML = `<tr><td colspan="3" class="text-center">لا توجد حسابات أرصدة دائنة أخرى</td></tr>`;
                detailedHTML = `<tr><td colspan="4" class="text-center">لا توجد حسابات أرصدة دائنة أخرى</td></tr>`;
            } else {
                otherPayablesAccounts.forEach(acc => {
                    const balanceCurrent = calculateFinalBalance(acc, auditData.adjustments, false);
                    const balancePrior = calculateFinalBalance(acc, auditData.adjustments, true);
                    totalCurrent += Math.abs(balanceCurrent);
                    totalPrior += Math.abs(balancePrior);
                    detailedHTML += `<tr>
                        <td>${acc.account_id || '-'}</td>
                        <td>${acc.name}</td>
                        <td class="amount">${formatCurrency(Math.abs(balanceCurrent))}</td>
                        <td class="amount">${formatCurrency(Math.abs(balancePrior))}</td>
                    </tr>`;
                });
                
                summaryHTML = `<tr>
                    <td>أرصدة دائنة أخرى</td>
                    <td class="amount">${formatCurrency(totalCurrent)}</td>
                    <td class="amount">${formatCurrency(totalPrior)}</td>
                </tr>
                <tr class="total">
                    <td><strong>الإجمالي</strong></td>
                    <td class="amount"><strong>${formatCurrency(totalCurrent)}</strong></td>
                    <td class="amount"><strong>${formatCurrency(totalPrior)}</strong></td>
                </tr>`;
            }
            
            document.getElementById('note9SummaryBody').innerHTML = summaryHTML;
            document.getElementById('note9DetailedBody').innerHTML = detailedHTML;
        }

        function renderNote10(auditData) {
            const zakatTaxAccounts = (auditData.trialBalance || []).filter(acc => acc.category === 'liabilities' && acc.sub_category === 'zakat_tax_provision');
            let summaryHTML = '';
            let detailedHTML = '';
            let totalCurrent = 0;
            let totalPrior = 0;
            
            if (zakatTaxAccounts.length === 0) {
                summaryHTML = `<tr><td colspan="3" class="text-center">لا توجد حسابات مخصص الزكاة والضريبة</td></tr>`;
                detailedHTML = `<tr><td colspan="4" class="text-center">لا توجد حسابات مخصص الزكاة والضريبة</td></tr>`;
            } else {
                zakatTaxAccounts.forEach(acc => {
                    const balanceCurrent = calculateFinalBalance(acc, auditData.adjustments, false);
                    const balancePrior = calculateFinalBalance(acc, auditData.adjustments, true);
                    totalCurrent += Math.abs(balanceCurrent);
                    totalPrior += Math.abs(balancePrior);
                    detailedHTML += `<tr>
                        <td>${acc.account_id || '-'}</td>
                        <td>${acc.name}</td>
                        <td class="amount">${formatCurrency(Math.abs(balanceCurrent))}</td>
                        <td class="amount">${formatCurrency(Math.abs(balancePrior))}</td>
                    </tr>`;
                });
                
                summaryHTML = `<tr>
                    <td>مخصص الزكاة والضريبة</td>
                    <td class="amount">${formatCurrency(totalCurrent)}</td>
                    <td class="amount">${formatCurrency(totalPrior)}</td>
                </tr>
                <tr class="total">
                    <td><strong>الإجمالي</strong></td>
                    <td class="amount"><strong>${formatCurrency(totalCurrent)}</strong></td>
                    <td class="amount"><strong>${formatCurrency(totalPrior)}</strong></td>
                </tr>`;
            }
            
            document.getElementById('note10SummaryBody').innerHTML = summaryHTML;
            document.getElementById('note10DetailedBody').innerHTML = detailedHTML;
        }

        function renderNote11(auditData) {
            const revenueAccounts = (auditData.trialBalance || []).filter(acc => acc.category === 'revenue');
            let summaryHTML = '';
            let detailedHTML = '';
            let totalCurrent = 0;
            let totalPrior = 0;
            
            if (revenueAccounts.length === 0) {
                summaryHTML = `<tr><td colspan="3" class="text-center">لا توجد حسابات إيرادات</td></tr>`;
                detailedHTML = `<tr><td colspan="4" class="text-center">لا توجد حسابات إيرادات</td></tr>`;
            } else {
                revenueAccounts.forEach(acc => {
                    const balanceCurrent = calculateFinalBalance(acc, auditData.adjustments, false);
                    const balancePrior = calculateFinalBalance(acc, auditData.adjustments, true);
                    totalCurrent += Math.abs(balanceCurrent);
                    totalPrior += Math.abs(balancePrior);
                    detailedHTML += `<tr>
                        <td>${acc.account_id || '-'}</td>
                        <td>${acc.name}</td>
                        <td class="amount">${formatCurrency(Math.abs(balanceCurrent))}</td>
                        <td class="amount">${formatCurrency(Math.abs(balancePrior))}</td>
                    </tr>`;
                });
                
                summaryHTML = `<tr>
                    <td>الإيرادات</td>
                    <td class="amount">${formatCurrency(totalCurrent)}</td>
                    <td class="amount">${formatCurrency(totalPrior)}</td>
                </tr>
                <tr class="total">
                    <td><strong>الإجمالي</strong></td>
                    <td class="amount"><strong>${formatCurrency(totalCurrent)}</strong></td>
                    <td class="amount"><strong>${formatCurrency(totalPrior)}</strong></td>
                </tr>`;
            }
            
            document.getElementById('note11SummaryBody').innerHTML = summaryHTML;
            document.getElementById('note11DetailedBody').innerHTML = detailedHTML;
        }

        function renderNote12(auditData) {
            const expenseAccounts = (auditData.trialBalance || []).filter(acc => acc.category === 'expenses' && !['cogs', 'depreciation', 'amortization', 'zakat_expense'].includes(acc.sub_category));
            let summaryHTML = '';
            let detailedHTML = '';
            let totalCurrent = 0;
            let totalPrior = 0;
            
            if (expenseAccounts.length === 0) {
                summaryHTML = `<tr><td colspan="3" class="text-center">لا توجد حسابات مصروفات عمومية وإدارية</td></tr>`;
                detailedHTML = `<tr><td colspan="4" class="text-center">لا توجد حسابات مصروفات عمومية وإدارية</td></tr>`;
            } else {
                expenseAccounts.forEach(acc => {
                    const balanceCurrent = calculateFinalBalance(acc, auditData.adjustments, false);
                    const balancePrior = calculateFinalBalance(acc, auditData.adjustments, true);
                    totalCurrent += Math.abs(balanceCurrent);
                    totalPrior += Math.abs(balancePrior);
                    detailedHTML += `<tr>
                        <td>${acc.account_id || '-'}</td>
                        <td>${acc.name}</td>
                        <td class="amount">${formatCurrency(Math.abs(balanceCurrent))}</td>
                        <td class="amount">${formatCurrency(Math.abs(balancePrior))}</td>
                    </tr>`;
                });
                
                summaryHTML = `<tr>
                    <td>المصروفات العمومية والإدارية</td>
                    <td class="amount">${formatCurrency(totalCurrent)}</td>
                    <td class="amount">${formatCurrency(totalPrior)}</td>
                </tr>
                <tr class="total">
                    <td><strong>الإجمالي</strong></td>
                    <td class="amount"><strong>${formatCurrency(totalCurrent)}</strong></td>
                    <td class="amount"><strong>${formatCurrency(totalPrior)}</strong></td>
                </tr>`;
            }
            
            document.getElementById('note12SummaryBody').innerHTML = summaryHTML;
            document.getElementById('note12DetailedBody').innerHTML = detailedHTML;
        }

        function printSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            
            // Hide all elements except the selected section
            const allSections = document.querySelectorAll('.financial-statement, .notes-section, .kpi-dashboard, .charts-section, .control-panel');
            allSections.forEach(s => s.style.display = 'none');
            
            // Show print header and selected section
            document.querySelector('.print-header').style.display = 'block';
            section.style.display = 'block';
            
            // Ensure only the visible table (summary or detailed) is printed
            const summaryDiv = section.querySelector(`#${sectionId.replace('Section', 'Summary')}`);
            const detailedDiv = section.querySelector(`#${sectionId.replace('Section', 'Detailed')}`);
            if (summaryDiv && detailedDiv) {
                if (summaryDiv.style.display === 'none') {
                    summaryDiv.style.display = 'none';
                    detailedDiv.style.display = 'block';
                } else {
                    summaryDiv.style.display = 'block';
                    detailedDiv.style.display = 'none';
                }
            }
            
            // Trigger print
            window.print();
            
            // Restore visibility after printing
            setTimeout(() => {
                allSections.forEach(s => s.style.display = 'block');
                document.querySelector('.print-header').style.display = 'none';
                if (summaryDiv && detailedDiv) {
                    summaryDiv.style.display = summaryDiv.style.display === 'none' ? 'none' : 'block';
                    detailedDiv.style.display = detailedDiv.style.display === 'none' ? 'none' : 'block';
                }
            }, 100);
        }

        function exportTableAsImage(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) {
                showError('لم يتم العثور على القسم المطلوب لتصديره.');
                return;
            }
            
            // Determine which table to export (summary or detailed)
            const summaryDiv = section.querySelector(`#${sectionId.replace('Section', 'Summary')}`);
            const detailedDiv = section.querySelector(`#${sectionId.replace('Section', 'Detailed')}`);
            const tableToExport = summaryDiv.style.display !== 'none' ? summaryDiv : detailedDiv;
            
            // Temporarily hide non-print elements
            const noPrintElements = section.querySelectorAll('.no-print');
            noPrintElements.forEach(el => el.style.display = 'none');
            
            // Use html2canvas to capture the table
            html2canvas(tableToExport, {
                backgroundColor: '#fff',
                scale: 2
            }).then(canvas => {
                // Restore non-print elements
                noPrintElements.forEach(el => el.style.display = '');
                
                // Create download link
                const link = document.createElement('a');
                link.download = `${sectionId}_table.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(err => {
                showError('فشل تصدير الجدول كصورة. حاول مرة أخرى.');
                console.error(err);
            });
        }

   // ==================================================================
// ==================================================================
// --- دالة تصدير PDF النصي (النسخة النهائية مع دعم كامل للعربية ) ---
// ==================================================================
async function generatePDF() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
            orientation: 'portrait',
            unit: 'pt',
            format: 'a4'
        });

        // --- الخطوة 1: تفعيل الخط العربي الذي قمنا بتضمينه ---
        doc.setFont('Amiri', 'normal'); // اسم الخط والنمط كما في الملف المحوّل

        let y = 60; // زيادة الهامش العلوي قليلاً

        // --- الخطوة 2: دالة مساعدة لرسم النصوص العربية (مُحسّنة) ---
        const drawArabicText = (text, x, yPos, options = {}) => {
            // jsPDF لا يزال يحتاج إلى قلب النص للرسم الصحيح في بعض النسخ
            const reversedText = text.split('').reverse().join('');
            const rightMarginX = doc.internal.pageSize.getWidth() - x;
            doc.text(text, rightMarginX, yPos, { align: 'right', ...options });
        };
        
        // --- الخطوة 3: رسم رأس التقرير ---
        const companyName = document.getElementById('companyNamePrint').textContent;
        doc.setFontSize(18);
        drawArabicText(companyName, 105, y, { align: 'center' }); // استخدام المحاذاة للمركز
        y += 25;
        doc.setFontSize(14);
        drawArabicText("القوائم المالية", 105, y, { align: 'center' });
        y += 20;
        doc.setFontSize(10);
        drawArabicText(document.querySelector('.print-header p').textContent, 105, y, { align: 'center' });
        y += 40;

        // --- الخطوة 4: دالة مساعدة لرسم الجداول باستخدام autoTable ---
        const drawTable = (title, tableElement) => {
            if (!tableElement) return;
            if (y > doc.internal.pageSize.getHeight() - 120) { // التحقق من وجود مساحة كافية
                doc.addPage();
                y = 60;
            }
            doc.setFontSize(14);
            drawArabicText(title, 40, y);
            y += 25;

            doc.autoTable({
                html: tableElement,
                startY: y,
                theme: 'grid',
                styles: {
                    font: 'Amiri', // الأهم: تطبيق الخط العربي على كل خلايا الجدول
                    halign: 'right', // محاذاة النصوص لليمين
                    cellPadding: 5,
                },
                headStyles: {
                    fillColor: [41, 128, 185], // لون أزرق احترافي
                    textColor: 255,
                    fontStyle: 'bold',
                    halign: 'center'
                },
                didDrawPage: (data) => { y = data.cursor.y; }
            });
            y = doc.autoTable.previous.finalY + 40; // ترك مسافة كافية بعد كل جدول
        };

        // --- الخطوة 5: رسم القوائم بالترتيب ---
        drawTable("قائمة الدخل", document.getElementById('incomeStatementContent').querySelector('table'));
        drawTable("قائمة المركز المالي", document.getElementById('balanceSheetContent').querySelector('table'));
        // يمكنك إضافة باقي القوائم بنفس الطريقة
        // drawTable("قائمة التدفقات النقدية", document.getElementById('cashFlowContent').querySelector('table'));

        // --- الخطوة 6: حفظ الملف ---
        doc.save(`القوائم المالية - ${companyName}.pdf`);
        alert("تم إنشاء ملف PDF العربي بنجاح!");

    } catch (error) {
        console.error("فشل تصدير PDF:", error);
        alert("حدث خطأ فادح أثناء إنشاء ملف PDF. تأكد من تضمين ملف الخط بشكل صحيح.");
    }
}


   // ==================================================================
// --- دالة تصدير Excel الكاملة (V3 - شاملة ومنسقة) ---
// ==================================================================
function exportToExcel() {
    try {
        const auditData = loadAuditData();
        if (!auditData) {
            alert("لا يمكن التصدير لعدم وجود بيانات. يرجى التأكد من تحميل بيانات المراجعة أولاً.");
            return;
        }

        const wb = XLSX.utils.book_new();
        const clientName = auditData.clientInfo.name || "الشركة";
        const fileName = `القوائم المالية - ${clientName}.xlsx`;
        const comparisonMode = document.getElementById('comparisonMode').checked;

        // --- دالة مساعدة لإنشاء ورقة عمل (Sheet) ---
        const createSheet = (title, data) => {
            const ws = XLSX.utils.aoa_to_sheet(data);
            // يمكنك إضافة تنسيقات هنا إذا أردت، مثل عرض الأعمدة
            ws['!cols'] = [{ wch: 40 }, { wch: 20 }, { wch: 20 }]; // عرض العمود الأول 40، الثاني والثالث 20
            XLSX.utils.book_append_sheet(wb, ws, title);
        };
        
        // --- 1. ورقة عمل: قائمة الدخل ---
        const incomeHeader = ["البند", "السنة الحالية"];
        if (comparisonMode) incomeHeader.push("السنة السابقة");
        const incomeSheetData = [
            ["قائمة الدخل"], // عنوان
            [], // صف فارغ
            incomeHeader
        ];
        const incomeTable = document.getElementById('incomeStatementContent').querySelector('table');
        if (incomeTable) {
            incomeTable.querySelectorAll('tbody tr').forEach(row => {
                const cells = Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim());
                // تجاهل عمود الإيضاحات عند التصدير
                const rowData = [cells[0], cells[2]]; 
                if (comparisonMode && cells[3]) rowData.push(cells[3]);
                incomeSheetData.push(rowData);
            });
        }
        createSheet("قائمة الدخل", incomeSheetData);

        // --- 2. ورقة عمل: قائمة المركز المالي ---
        const balanceHeader = ["البند", "السنة الحالية"];
        if (comparisonMode) balanceHeader.push("السنة السابقة");
        const balanceSheetData = [
            ["قائمة المركز المالي"],
            [],
            ["الأصول"],
            balanceHeader
        ];
        const balanceTables = document.getElementById('balanceSheetContent').querySelectorAll('table');
        if (balanceTables.length > 1) {
            // جدول الأصول
            balanceTables[0].querySelectorAll('tbody tr').forEach(row => {
                const cells = Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim());
                const rowData = [cells[0], cells[2]];
                if (comparisonMode && cells[3]) rowData.push(cells[3]);
                balanceSheetData.push(rowData);
            });
            balanceSheetData.push([]); // فاصل
            balanceSheetData.push(["الالتزامات وحقوق الملكية"]);
            balanceSheetData.push(balanceHeader);
            // جدول الالتزامات وحقوق الملكية
            balanceTables[1].querySelectorAll('tbody tr').forEach(row => {
                const cells = Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim());
                const rowData = [cells[0], cells[2]];
                if (comparisonMode && cells[3]) rowData.push(cells[3]);
                balanceSheetData.push(rowData);
            });
        }
        createSheet("المركز المالي", balanceSheetData);

        // --- 3. ورقة عمل: قائمة التدفقات النقدية ---
        const cashFlowHeader = ["البند", "المبلغ"];
        const cashFlowData = [
             ["قائمة التدفقات النقدية"],
             [],
             cashFlowHeader
        ];
        const cashFlowTable = document.getElementById('cashFlowContent').querySelector('table');
        if(cashFlowTable){
            cashFlowTable.querySelectorAll('tbody tr').forEach(row => {
                const cells = Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim());
                cashFlowData.push(cells);
            });
        }
        createSheet("التدفقات النقدية", cashFlowData);


        // --- 4. تصدير الإيضاحات (كل إيضاح في ورقة منفصلة) ---
        for (let i = 1; i <= 12; i++) {
            const noteSection = document.getElementById(`note${i}Section`);
            if (noteSection) {
                const noteTitle = noteSection.querySelector('.note-title').textContent;
                const detailedTable = noteSection.querySelector(`#note${i}Detailed table`);
                if (detailedTable) {
                    const noteSheetData = [
                        [noteTitle],
                        []
                    ];
                    // استخراج رؤوس الأعمدة
                    const headers = Array.from(detailedTable.querySelectorAll('thead th')).map(th => th.textContent.trim());
                    noteSheetData.push(headers);
                    // استخراج الصفوف
                    detailedTable.querySelectorAll('tbody tr').forEach(row => {
                        const cells = Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim());
                        noteSheetData.push(cells);
                    });
                    // إنشاء ورقة العمل للإيضاح
                    createSheet(`إيضاح (${i})`, noteSheetData);
                }
            }
        }

        // --- إنشاء وتنزيل الملف ---
        XLSX.writeFile(wb, fileName);
        alert(`تم تصدير ملف Excel بنجاح باسم: ${fileName}`);

    } catch (error) {
        console.error("فشل تصدير Excel:", error);
        alert("حدث خطأ فادح أثناء تصدير ملف Excel. راجع وحدة التحكم للمزيد من التفاصيل.");
    }
}

// ==================================================================
// --- دالة تصدير HTML (جديدة) ---
// ==================================================================
function exportAsStandaloneHTML() {
    try {
        const auditData = loadAuditData();
        if (!auditData) {
            alert("لا توجد بيانات للحفظ.");
            return;
        }

        // 1. احصل على نسخة من HTML الحالي للصفحة
        let pageHTML = document.documentElement.outerHTML;

        // 2. أنشئ وسم <script> لتضمين البيانات مباشرة في الملف
        // هذا هو السر لجعل الملف يعمل بشكل مستقل
        const dataScript = `
            <script id="embedded-data">
                // تضمين البيانات مباشرة لمنع الاعتماد على localStorage
                const embeddedAuditData = ${JSON.stringify(auditData)};

                // تعديل دالة التحميل لتقرأ من البيانات المضمنة أولاً
                function loadAuditData() {
                    console.log("Loading data from embedded source.");
                    return embeddedAuditData;
                }
            <\/script>
        `;

        // 3. أدخل وسم البيانات في نهاية قسم <head>
        pageHTML = pageHTML.replace('</head>', `${dataScript}</head>`);

        // 4. أنشئ الملف وقم بتنزيله
        const blob = new Blob([pageHTML], { type: 'text/html' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `تقرير_القوائم_المالية_${auditData.clientInfo.name || ''}.html`;
        link.click();

        URL.revokeObjectURL(link.href); // تنظيف
        alert("تم تصدير تقرير HTML المستقل بنجاح!");

    } catch (error) {
        console.error("فشل تصدير HTML:", error);
        alert("حدث خطأ أثناء تصدير ملف HTML.");
    }
}
        function uploadLogo() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const logoData = e.target.result;
                        localStorage.setItem(`companyLogo_${localStorage.getItem('activeClientId')}`, logoData);
                        document.getElementById('companyLogo').src = logoData;
                        document.getElementById('companyLogo').style.display = 'block';
                        document.getElementById('companyLogoPrint').src = logoData;
                        document.getElementById('companyLogoPrint').style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function goBackToMapping() {
            window.location.href = 'account-mapping.html';
        }

        function saveBackupForNextYear() {
            const auditData = loadAuditData();
            if (auditData) {
                localStorage.setItem(`backup_${auditData.clientInfo.id}_${new Date().getFullYear()}`, JSON.stringify(auditData));
                alert('تم حفظ نسخة احتياطية بنجاح.');
            }
        }

        function loadComparisonData() {
            const auditData = loadAuditData();
            if (!auditData) return;
            const backupKey = `backup_${auditData.clientInfo.id}_${new Date().getFullYear() - 1}`;
            const backupData = localStorage.getItem(backupKey);
            if (backupData) {
                localStorage.setItem(`polarisAuditFile_${auditData.clientInfo.id}_prior`, backupData);
                alert('تم استرجاع بيانات المقارنة بنجاح.');
                initializeDashboard();
            } else {
                alert('لا توجد بيانات مقارنة متاحة.');
            }
        }

        function refreshData() {
            window.location.reload();
        }

        function initializeCharts(incomeData, balanceData) {
            // Check if data is available
            if (!incomeData || !balanceData || !incomeData.current || !balanceData.current) {
                document.getElementById('chartsSection').innerHTML = `<div class="data-empty">لا توجد بيانات كافية لعرض الرسوم البيانية.</div>`;
                return;
            }
            
            const revenueChart = new Chart(document.getElementById('revenueChart'), {
                type: 'bar',
                data: {
                    labels: ['السنة الحالية', 'السنة السابقة'],
                    datasets: [
                        {
                            label: 'صافي الإيرادات',
                            data: [incomeData.current.totalRevenue, incomeData.prior.totalRevenue],
                            backgroundColor: 'rgba(0, 170, 255, 0.7)',
                            borderColor: '#00aaff',
                            borderWidth: 1
                        },
                        {
                            label: 'صافي الربح',
                            data: [incomeData.current.netProfit, incomeData.prior.netProfit],
                            backgroundColor: 'rgba(40, 167, 69, 0.7)',
                            borderColor: '#28a745',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#c9d1d9', font: { size: 12 } } },
                        title: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#c9d1d9', font: { size: 10 } },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#c9d1d9', font: { size: 10 } },
                            grid: { display: false }
                        }
                    }
                }
            });

            const assetsChart = new Chart(document.getElementById('assetsChart'), {
                type: 'pie',
                data: {
                    labels: ['الأصول المتداولة', 'الأصول غير المتداولة'],
                    datasets: [{
                        data: [balanceData.current.currentAssets, balanceData.current.fixedAssets],
                        backgroundColor: ['#00aaff', '#6f42c1'],
                        borderColor: ['#ffffff', '#ffffff'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#c9d1d9', font: { size: 12 } } },
                        title: { display: false }
                    }
                }
            });

            const liabilitiesChart = new Chart(document.getElementById('liabilitiesChart'), {
                type: 'doughnut',
                data: {
                    labels: ['الالتزامات المتداولة', 'الالتزامات غير المتداولة', 'حقوق الملكية'],
                    datasets: [{
                        data: [
                            Math.abs(balanceData.current.currentLiabilities),
                            Math.abs(balanceData.current.longTermLiabilities),
                            Math.abs(balanceData.current.totalEquity)
                        ],
                        backgroundColor: ['#dc3545', '#ffc107', '#28a745'],
                        borderColor: ['#ffffff', '#ffffff', '#ffffff'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#c9d1d9', font: { size: 12 } } },
                        title: { display: false }
                    }
                }
            });

            const netProfitMargin = incomeData.current.totalRevenue > 0 ? (incomeData.current.netProfit / incomeData.current.totalRevenue) * 100 : 0;
            const grossProfitMargin = incomeData.current.totalRevenue > 0 ? (incomeData.current.grossProfit / incomeData.current.totalRevenue) * 100 : 0;
            
            const marginsChart = new Chart(document.getElementById('marginsChart'), {
                type: 'bar',
                data: {
                    labels: ['هامش الربح الإجمالي', 'هامش الربح الصافي'],
                    datasets: [
                        {
                            label: 'النسبة (%)',
                            data: [grossProfitMargin, netProfitMargin],
                            backgroundColor: 'rgba(23, 162, 184, 0.7)',
                            borderColor: '#17a2b8',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#c9d1d9', font: { size: 10 } },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#c9d1d9', font: { size: 10 } },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function initializeDashboard() {
            const auditData = loadAuditData();
            if (!auditData) {
                document.getElementById('loadingIndicator').style.display = 'none';

                // لو مفيش عنصر رسالة موجود، أضفه فوق في الـ HTML
                let msg = document.createElement('div');
                msg.className = 'data-empty';
                msg.textContent = 'لا توجد بيانات مالية لعرض القوائم. الرجاء العودة لصفحة المراجعة أو تحميل ملف المراجعة أولاً.';
                document.querySelector('.container-fluid').appendChild(msg);

                return;
            }
            
            document.getElementById('loadingIndicator').style.display = 'none';
            
            // Update company info
            updateCompanyInfo(auditData);
            
            // Check comparison mode
            const comparisonMode = document.getElementById('comparisonMode').checked || localStorage.getItem('comparisonMode') === 'true';
            document.getElementById('comparisonMode').checked = comparisonMode;
            
            // Categorize accounts for current and prior year
            const categorizedData = categorizeAccounts(auditData, false);
            const categorizedDataPrior = categorizeAccounts(auditData, true);
            
            // Generate financial statements
            const incomeData = {
                current: generateIncomeStatement(categorizedData),
                prior: generateIncomeStatement(categorizedDataPrior)
            };
            const balanceData = {
                current: generateBalanceSheet(categorizedData, incomeData.current.netProfit, false),
                prior: generateBalanceSheet(categorizedDataPrior, incomeData.prior.netProfit, true)
            };
            const equityData = {
                current: generateEquityStatement(categorizedData, incomeData.current.netProfit, categorizedDataPrior),
                prior: generateEquityStatement(categorizedDataPrior, incomeData.prior.netProfit, categorizedDataPrior)
            };
            const cashFlowData = {
                current: generateCashFlowStatement(incomeData.current, balanceData.current, balanceData.prior),
                prior: generateCashFlowStatement(incomeData.prior, balanceData.prior, balanceData.prior)
            };
            
            // Display financial statements
            displayIncomeStatement(incomeData, comparisonMode);
            document.getElementById('incomeStatementSection').style.display = 'block';
            
            displayBalanceSheet(balanceData, auditData, comparisonMode);
            document.getElementById('balanceSheetSection').style.display = 'block';
            
            displayEquityStatement(equityData, comparisonMode);
            document.getElementById('equityStatementSection').style.display = 'block';
            
            displayCashFlowStatement(cashFlowData, comparisonMode);
            document.getElementById('cashFlowSection').style.display = 'block';
            
            // Display KPIs
            displayKPIDashboard(incomeData, balanceData);
            
            // Initialize charts
            initializeCharts(incomeData, balanceData);
            document.getElementById('chartsSection').style.display = 'block';
            
            // Render notes
            renderNote1(auditData);
            renderNote2(auditData);
            renderNote3(auditData);
            renderNote4(auditData);
            renderNote5(auditData);
            renderNote6(auditData);
            renderNote7(auditData);
            renderNote8(auditData);
            renderNote9(auditData);
            renderNote10(auditData);
            renderNote11(auditData);
            renderNote12(auditData);
            // ... داخل initializeDashboard، بعد استدعاء renderNote12
renderNote13(balanceData);

            document.getElementById('notesSection').style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeDashboard();
        });
function renderNote13(balanceData) {
    const container = document.getElementById('note13Content');
    const workingCapital = balanceData.current.currentAssets - balanceData.current.currentLiabilities;
    
    let html = `<div class="note-description">
        <p>رأس المال العامل هو مقياس للسيولة قصيرة الأجل للشركة، ويشير إلى قدرتها على تغطية التزاماتها المتداولة باستخدام أصولها المتداولة.</p>
    </div>
    <table class="financial-table">
        <tr><td>مجموع الأصول المتداولة</td><td class="amount">${formatCurrency(balanceData.current.currentAssets)}</td></tr>
        <tr><td>يخصم: مجموع الالتزامات المتداولة</td><td class="amount negative">(${formatCurrency(balanceData.current.currentLiabilities)})</td></tr>
        <tr class="total"><td><strong>صافي رأس المال العامل</strong></td><td class="amount ${workingCapital < 0 ? 'negative' : ''}"><strong>${formatCurrency(workingCapital)}</strong></td></tr>
    </table>
    <div class="alert ${workingCapital > 0 ? 'alert-success' : 'alert-danger'} mt-3">
        ${workingCapital > 0 ? 'الشركة لديها سيولة كافية لتغطية التزاماتها قصيرة الأجل.' : 'تحذير: الشركة تواجه عجزاً في السيولة قصيرة الأجل.'}
    </div>`;
    container.innerHTML = html;
}
 
   </script>
</body>
</html>