<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>النظام المحاسبي المتكامل - القوائم المالية</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700;900&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- تشفير البيانات (CryptoJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <!-- نظام تدفق البيانات Polaris -->
    <script src="dataPipeline.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --color-bg: #0d1117;
            --color-surface: #161b22;
            --color-primary: #00aaff;
            --color-primary-glow: rgba(0, 170, 255, 0.5);
            --color-text-primary: #c9d1d9;
            --color-text-secondary: #8b949e;
            --color-border: #30363d;
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-warning: #ffc107;
            --color-info: #17a2b8;
            --border-radius-lg: 12px;
            --border-radius-md: 8px;
            --font-family-main: 'Tajawal', sans-serif;
            --font-family-display: 'Cairo', sans-serif;
        }
        body {
            font-family: var(--font-family-main);
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            line-height: 1.7;
        }
        .container-fluid { padding: 2rem; }
        .financial-statement {
            background-color: var(--color-surface);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--color-border);
        }
        .statement-title {
            font-family: var(--font-family-display);
            font-weight: 900;
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }
        .financial-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        .financial-table th {
            background-color: #1c222b;
            color: var(--color-text-primary);
            padding: 0.8rem;
            text-align: right;
            border: 1px solid var(--color-border);
            font-weight: 700;
        }
        .financial-table td {
            padding: 0.6rem 0.8rem;
            border: 1px solid var(--color-border);
            text-align: right;
        }
        .financial-table tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.03);
        }
        .amount {
            font-family: monospace;
            font-weight: 700;
            text-align: left;
        }
        .positive { color: var(--color-success); }
        .negative { color: var(--color-danger); }
        .sub-total {
            background-color: rgba(0, 170, 255, 0.1) !important;
            font-weight: 700;
        }
        .total {
            background-color: rgba(40, 167, 69, 0.15) !important;
            font-weight: 900;
        }
        /* *** NEW: Professional Table Styling for Comparison *** */
        .comparison-table th:nth-child(odd), .comparison-table td:nth-child(odd) {
            background-color: rgba(255, 255, 255, 0.02);
        }
        .comparison-table th:nth-child(even), .comparison-table td:nth-child(even) {
            background-color: rgba(0, 170, 255, 0.05);
            border-left: 1px solid var(--color-primary);
        }
        .comparison-table .total td {
            background-color: rgba(40, 167, 69, 0.15) !important;
        }
        .comparison-table .total td:nth-child(even) {
            background-color: rgba(40, 167, 69, 0.25) !important;
        }

        .control-panel {
            background-color: var(--color-surface);
            border-radius: var(--border-radius-lg);
            padding: 1rem;
            margin-bottom: 2rem;
            border: 1px solid var(--color-border);
        }
        .btn {
            border-radius: 999px;
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            transition: transform 120ms ease, box-shadow 120ms ease, background-color 120ms ease, color 120ms ease;
            font-weight: 600;
        }
        .btn-sm { padding: 0.35rem 0.75rem; font-size: 0.85rem; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.2), 0 0 0 3px rgba(0, 170, 255, 0.06); }
        .btn:active { transform: translateY(0); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .btn:focus-visible { outline: none; box-shadow: 0 0 0 3px var(--color-primary-glow); }
        .btn-primary {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            font-weight: 700;
            color: #ffffff;
            background-image: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(0,0,0,0.08));
        }
        .btn-primary:hover { filter: brightness(1.05); }
        .btn-success { background-color: var(--color-success); border-color: var(--color-success); color: #ffffff; }
        .btn-warning { background-color: var(--color-warning); border-color: var(--color-warning); color: #0d1117; }
        .btn-info { background-color: var(--color-info); border-color: var(--color-info); color: #ffffff; }
        .btn-secondary { background-color: var(--color-text-secondary); border-color: var(--color-text-secondary); color: #0d1117; }
        .btn-outline-primary { color: var(--color-primary); border-color: var(--color-primary); background-color: transparent; }
        .btn-outline-primary:hover, .btn-outline-primary.active { background-color: var(--color-primary); color: #ffffff; }
        .btn-outline-success { color: var(--color-success); border-color: var(--color-success); background-color: transparent; }
        .btn-outline-success:hover { background-color: var(--color-success); color: #ffffff; }
        .btn-outline-warning { color: var(--color-warning); border-color: var(--color-warning); background-color: transparent; }
        .btn-outline-warning:hover { background-color: var(--color-warning); color: #0d1117; }
        .btn-outline-info { color: var(--color-info); border-color: var(--color-info); background-color: transparent; }
        .btn-outline-info:hover { background-color: var(--color-info); color: #ffffff; }
        .btn-outline-secondary { color: var(--color-text-secondary); border-color: var(--color-border); background-color: transparent; }
        .btn-outline-secondary:hover { background-color: var(--color-text-secondary); color: #0d1117; }
        .btn i { margin-left: 0.4rem; }
        .btn[disabled], .btn.disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(0.2); }
        }
        .notes-section {
            background-color: var(--color-surface);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--color-border);
        }
        .note-item {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--color-border);
        }
        .note-item:last-child {
            border-bottom: none;
        }
        .note-title {
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        .sub-note-title {
            font-weight: 700;
            color: var(--color-text-primary);
            margin: 1rem 0 0.5rem 0;
            font-size: 1rem;
        }
        .data-loading {
            text-align: center;
            padding: 2rem;
            color: var(--color-text-secondary);
        }
        .data-empty {
            text-align: center;
            padding: 3rem;
            color: var(--color-text-secondary);
            background-color: rgba(255,255,255,0.05);
            border-radius: var(--border-radius-md);
        }
        .accounting-correct { border-left: 4px solid var(--color-success); }
        .accounting-warning { border-left: 4px solid var(--color-warning); }
        .note-description {
            color: var(--color-text-secondary);
            font-size: 0.95rem;
            margin-bottom: 1rem;
            line-height: 1.8;
        }
        .policy-box {
            background-color: rgba(0, 170, 255, 0.05);
            border-left: 3px solid var(--color-primary);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        .kpi-dashboard {
            background: linear-gradient(135deg, #161b22 0%, #1c222b 100%);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--color-border);
        }
        .kpi-dashboard-title {
            font-family: var(--font-family-display);
            font-weight: 900;
            color: var(--color-primary);
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .kpi-card {
            background-color: var(--color-surface);
            border-radius: var(--border-radius-md);
            padding: 1.5rem;
            border: 1px solid var(--color-border);
            transition: all 0.3s ease;
            height: 100%;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 170, 255, 0.2);
            border-color: var(--color-primary);
        }
        .kpi-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            opacity: 0.8;
        }
        .kpi-label {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .kpi-value {
            font-family: var(--font-family-display);
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 0.5rem;
        }
        .kpi-change {
            font-size: 0.85rem;
            font-weight: 600;
        }
        .kpi-change.positive { color: var(--color-success); }
        .kpi-change.negative { color: var(--color-danger); }
        .kpi-change.neutral { color: var(--color-text-secondary); }
        .charts-section {
            background-color: var(--color-surface);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--color-border);
        }
        .chart-container {
            position: relative;
            height: 350px;
            margin-bottom: 2rem;
            background-color: rgba(255, 255, 255, 0.02);
            border-radius: var(--border-radius-md);
            padding: 1.5rem;
        }
        .chart-title {
            font-family: var(--font-family-display);
            font-weight: 700;
            color: var(--color-text-primary);
            font-size: 1.1rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .comparison-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1rem;
        }
        .comparison-toggle label {
            margin-bottom: 0;
            font-weight: 500;
        }
        @media print {
            @page {
                size: A4;
                margin: 2cm 1.5cm;
            }
            body {
                background: white !important;
                color: black !important;
                font-size: 10pt;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .no-print { display: none !important; }
            .print-header {
                display: block !important;
                text-align: center;
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }
            .financial-statement, .notes-section, .note-item {
                page-break-inside: avoid;
                break-inside: avoid;
                border: 1px solid #ddd !important;
                box-shadow: none !important;
                background: white !important;
                padding: 1rem;
                margin-bottom: 1.5rem;
            }
            .statement-title {
                color: #000 !important;
                border-bottom-color: #000 !important;
                font-size: 14pt;
                page-break-after: avoid;
            }
            .note-title {
                color: #000 !important;
                font-size: 12pt;
                page-break-after: avoid;
            }
            .financial-table {
                font-size: 9pt;
                page-break-inside: avoid;
            }
            .financial-table th {
                background-color: #f0f0f0 !important;
                color: #000 !important;
                border: 1px solid #000 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .financial-table td {
                border: 1px solid #666 !important;
                color: #000 !important;
            }
            .total {
                background-color: #e8e8e8 !important;
                font-weight: 900 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .sub-total {
                background-color: #f5f5f5 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .policy-box {
                background-color: #f9f9f9 !important;
                border-right: 3px solid #000 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .kpi-dashboard, .charts-section {
                display: none !important;
            }
            .page-break-before { page-break-before: always; }
            .page-break-after { page-break-after: always; }
        }
        .note-link {
            color: var(--color-primary);
            cursor: pointer;
            text-decoration: underline;
            font-weight: 700;
        }
        .note-link:hover {
            color: var(--color-success);
            text-decoration: none;
        }
        /* Accessibility Enhancements */
        [aria-live="polite"] { transition: opacity 0.5s ease; }
        .visually-hidden:not(:focus):not(:active) {
            position: absolute;
            width: 1px;
            height: 1px;
            overflow: hidden;
            clip: rect(0 0 0 0);
        }
    </style>
</head>
<body>
    <style>
        .top-icons { display:flex; gap:.4rem; align-items:center; margin-top:.5rem; flex-wrap:nowrap; white-space:nowrap; overflow-x:auto; }
        .top-icons .sidebar-icon { width:34px; height:34px; display:flex; align-items:center; justify-content:center; color:var(--color-text-secondary); font-size:1rem; border:1px solid var(--color-border); border-radius:8px; text-decoration:none; }
        .top-icons .sidebar-icon:hover { background-color: rgba(0,191,255,0.1); color: var(--color-primary); }
    </style>
    <div class="container-fluid" style="padding-top:.5rem;">
        <div class="top-icons">
            <a id="top_home" href="index.html" class="sidebar-icon" title="الرئيسية"><i class="fas fa-home"></i></a>
            <a id="top_mapping" href="account-mapping.html" class="sidebar-icon" title="الاستيعاب"><i class="fas fa-balance-scale"></i></a>
            <a id="top_cockpit" href="consolidation-cockpit.html" class="sidebar-icon" title="القوائم المالية"><i class="fas fa-file-invoice"></i></a>
            <a id="top_reports" href="reporting-pantheon.html" class="sidebar-icon" title="التقارير"><i class="fas fa-book-open"></i></a>
            <a id="top_vat" href="vat-center.html" class="sidebar-icon" title="القيمة المضافة"><i class="fas fa-percentage"></i></a>
        </div>
    </div>
    <div class="container-fluid">
        <!-- Control Panel -->
        <div class="control-panel no-print">
            <div class="d-flex gap-2 flex-wrap justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <h4 class="mb-0">النظام المحاسبي المتكامل - القوائم المالية</h4>
                    <div class="compact-controls">
                        <span class="label">مقارنة بالفترة السابقة:</span>
                        <div class="form-check form-switch m-0 p-0">
                            <input class="form-check-input" type="checkbox" id="comparisonMode" onchange="toggleComparisonMode()">
                        </div>
                        <span id="comparisonBadge" class="badge bg-secondary">بدون مقارنة</span>
                        <label class="form-check form-check-inline align-middle m-0">
                            <input class="form-check-input" type="checkbox" id="exportDetailedToggle">
                            <span class="form-check-label">تصدير تفصيلي</span>
                        </label>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-success btn-sm" onclick="exportToExcel()" aria-label="تصدير القوائم المالية إلى Excel">
                        <i class="fas fa-file-excel me-2"></i>تصدير Excel
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="generatePDF()" aria-label="تصدير القوائم المالية إلى PDF">
                        <i class="fas fa-file-pdf me-2"></i>تصدير PDF
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="window.print()" aria-label="طباعة القوائم المالية">
                        <i class="fas fa-print me-2"></i>طباعة
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="uploadLogo()" aria-label="رفع شعار الشركة">
                        <i class="fas fa-image me-2"></i>رفع شعار
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="goBackToMapping()" aria-label="العودة إلى صفحة المراجعة">
                        <i class="fas fa-arrow-right me-2"></i>العودة للمراجعة
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="saveBackupForNextYear()" aria-label="حفظ نسخة احتياطية">
                        <i class="fas fa-save me-2"></i>حفظ نسخة
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="uploadPriorYearFile()" aria-label="رفع ملف السنة السابقة">
                        <i class="fas fa-upload me-2"></i>رفع بيانات السنة السابقة
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="refreshData()" aria-label="تحديث البيانات">
                        <i class="fas fa-sync-alt me-2"></i>تحديث
                    </button>
                    <button class="btn btn-info btn-sm" onclick="exportAsStandaloneHTML()" aria-label="حفظ كملف HTML مستقل">
                        <i class="fas fa-file-code me-2"></i>حفظ كـ HTML
                    </button>
                </div>
            </div>
        </div>

        <!-- رأس التقرير الموحد -->
        <div class="text-center mb-4 p-4 rounded no-print" style="background-color: var(--color-surface); border: 1px solid var(--color-border);">
            <img id="companyLogo" src="" alt="شعار الشركة" style="max-height: 80px; margin-bottom: 1rem; display: none;">
            <h1 id="companyNameDisplay" class="font-weight-bold mb-2" style="font-family: var(--font-family-display); font-size: 2rem; color: var(--color-primary);">
                القوائم المالية
            </h1>
            <h4 id="periodDisplay" style="color: var(--color-text-secondary); font-weight: 500;">
                للفترة المالية
            </h4>
        </div>

        <!-- Print Header -->
        <div class="print-header" style="display: none;">
            <img id="companyLogoPrint" src="" alt="شعار الشركة" style="max-height: 60px; margin-bottom: 10px; display: none;">
            <h2 id="companyNamePrint" style="font-weight: bold; margin: 0;">اسم الشركة</h2>
            <h4 style="margin: 5px 0;">القوائم المالية</h4>
            <p style="margin: 0; font-size: 10pt;">للسنة المالية المنتهية</p>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="data-loading" aria-live="polite">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">جاري التحميل...</span>
            </div>
            <h4>جاري تحميل البيانات المالية...</h4>
        </div>

        <!-- KPI Dashboard -->
        <div class="kpi-dashboard" id="kpiDashboard" style="display: none;">
            <h2 class="kpi-dashboard-title"><i class="fas fa-chart-line me-2"></i>مؤشرات الأداء الرئيسية (KPIs)</h2>
            <div id="kpiContent"></div>
        </div>

        <!-- Interactive Charts -->
        <div class="charts-section" id="chartsSection" style="display: none;">
            <h2 class="statement-title"><i class="fas fa-chart-pie me-2"></i>الرسوم البيانية التفاعلية</h2>
            <div class="row">
                <div class="col-lg-6">
                    <div class="chart-container">
                        <h5 class="chart-title">مقارنة الإيرادات والأرباح</h5>
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="chart-container">
                        <h5 class="chart-title">هيكل الأصول</h5>
                        <canvas id="assetsChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-6">
                    <div class="chart-container">
                        <h5 class="chart-title">هيكل الالتزامات وحقوق الملكية</h5>
                        <canvas id="liabilitiesChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="chart-container">
                        <h5 class="chart-title">هوامش الربح</h5>
                        <canvas id="marginsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- *** NEW: Pre-Approval Data Section *** -->
        <div class="financial-statement" id="preApprovalSection" style="display: none;">
            <h2 class="statement-title"><i class="fas fa-history me-2"></i>بيانات الحساب والرصيد (قبل الموافقة)</h2>
            <div id="preApprovalContent"></div>
        </div>

        <!-- Income Statement -->
        <div class="financial-statement" id="incomeStatementSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                <h2 class="statement-title mb-0"><i class="fas fa-chart-bar me-2"></i>قائمة الدخل</h2>
                <div>
                    <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('incomeStatement', 'summary')" aria-label="عرض إجمالي لقائمة الدخل">إجمالي</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleView('incomeStatement', 'detailed')" aria-label="عرض تفصيلي لقائمة الدخل">تفصيلي</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="printSection('incomeStatementSection')" aria-label="طباعة قائمة الدخل">
                        <i class="fas fa-print me-2"></i>طباعة
                    </button>
                </div>
            </div>
            <div id="incomeStatementSummary">
                <div id="incomeStatementContent"></div>
            </div>
            <div id="incomeStatementDetailed" style="display:none;">
                <div id="incomeStatementDetailedContent"></div>
            </div>
        </div>

        <!-- Balance Sheet -->
        <div class="financial-statement" id="balanceSheetSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                <h2 class="statement-title mb-0"><i class="fas fa-balance-scale me-2"></i>قائمة المركز المالي</h2>
                <div>
                    <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('balanceSheet', 'summary')" aria-label="عرض إجمالي لقائمة المركز المالي">إجمالي</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleView('balanceSheet', 'detailed')" aria-label="عرض تفصيلي لقائمة المركز المالي">تفصيلي</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="printSection('balanceSheetSection')" aria-label="طباعة قائمة المركز المالي">
                        <i class="fas fa-print me-2"></i>طباعة
                    </button>
                </div>
            </div>
            <div id="balanceSheetSummary">
                <div id="balanceSheetContent"></div>
            </div>
            <div id="balanceSheetDetailed" style="display:none;">
                <div id="balanceSheetDetailedContent"></div>
            </div>
        </div>

        <!-- Cash Flow Statement -->
        <div class="financial-statement" id="cashFlowSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                <h2 class="statement-title mb-0"><i class="fas fa-money-bill-wave me-2"></i>قائمة التدفقات النقدية</h2>
                <div>
                    <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('cashFlow', 'summary')" aria-label="عرض إجمالي لقائمة التدفقات النقدية">إجمالي</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleView('cashFlow', 'detailed')" aria-label="عرض تفصيلي لقائمة التدفقات النقدية">تفصيلي</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="printSection('cashFlowSection')" aria-label="طباعة قائمة التدفقات النقدية">
                        <i class="fas fa-print me-2"></i>طباعة
                    </button>
                </div>
            </div>
            <div id="cashFlowSummary">
                <div id="cashFlowContent"></div>
            </div>
            <div id="cashFlowDetailed" style="display:none;">
                <div id="cashFlowDetailedContent"></div>
            </div>
        </div>

        <!-- Equity Statement -->
        <div class="financial-statement" id="equityStatementSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                <h2 class="statement-title mb-0"><i class="fas fa-users me-2"></i>قائمة التغيرات في حقوق الملكية</h2>
                <div>
                    <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('equityStatement', 'summary')" aria-label="عرض إجمالي لقائمة التغيرات في حقوق الملكية">إجمالي</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleView('equityStatement', 'detailed')" aria-label="عرض تفصيلي لقائمة التغيرات في حقوق الملكية">تفصيلي</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="printSection('equityStatementSection')" aria-label="طباعة قائمة التغيرات في حقوق الملكية">
                        <i class="fas fa-print me-2"></i>طباعة
                    </button>
                </div>
            </div>
            <div id="equityStatementSummary">
                <div id="equityStatementContent"></div>
            </div>
            <div id="equityStatementDetailed" style="display:none;">
                <div id="equityStatementDetailedContent"></div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="notes-section" id="notesSection" style="display: none;">
            <h2 class="statement-title"><i class="fas fa-sticky-note me-2"></i>الإيضاحات المتممة للقوائم المالية</h2>
            <div class="note-description">
                <em>"الأرقام في القوائم المالية تحكي جزءاً من القصة، لكن الإيضاحات تروي القصة كاملة."</em> - المدير المالي
            </div>
            <div id="detailedNotesSection">
                <!-- Note 1: تعريف بالمنشأة -->
                <div class="note-item" id="note1Section">
                    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                        <h4 class="note-title mb-0">إيضاح (1): تعريف بالمنشأة</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note1Section')" aria-label="طباعة إيضاح تعريف بالمنشأة">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                    <div id="note1Content"></div>
                </div>
                
                <!-- Note 2: السياسات المحاسبية -->
                <div class="note-item" id="note2Section">
                    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                        <h4 class="note-title mb-0">إيضاح (2): أهم السياسات المحاسبية المتبعة</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note2Section')" aria-label="طباعة إيضاح السياسات المحاسبية">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                    <div id="note2Content"></div>
                </div>
                
                <!-- Note 3: النقد وما في حكمها -->
                <div class="note-item" id="note3Section">
                    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                        <h4 class="note-title mb-0">إيضاح (3): النقدية وما في حكمها</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('note3', 'summary')" aria-label="عرض إجمالي للنقدية">إجمالي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleView('note3', 'detailed')" aria-label="عرض تفصيلي للنقدية">تفصيلي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note3Section')" aria-label="طباعة إيضاح النقدية">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                    <div id="note3Summary">
                        <table class="financial-table">
                            <thead><tr><th>البيان</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note3SummaryBody"></tbody>
                        </table>
                    </div>
                    <div id="note3Detailed" style="display:none;">
                        <table class="financial-table">
                            <thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note3DetailedBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Note 4: مدينون تجاريون -->
                <div class="note-item" id="note4Section">
                    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                        <h4 class="note-title mb-0">إيضاح (4): مدينون تجاريون</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('note4', 'summary')" aria-label="عرض إجمالي لمدينون تجاريون">إجمالي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleView('note4', 'detailed')" aria-label="عرض تفصيلي لمدينون تجاريون">تفصيلي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note4Section')" aria-label="طباعة إيضاح مدينون تجاريون">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                    <div id="note4Summary">
                        <table class="financial-table">
                            <thead><tr><th>البيان</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note4SummaryBody"></tbody>
                        </table>
                    </div>
                    <div id="note4Detailed" style="display:none;">
                        <table class="financial-table">
                            <thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note4DetailedBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Note 5: أرصدة مدينة أخرى -->
                <div class="note-item" id="note5Section">
                    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                        <h4 class="note-title mb-0">إيضاح (5): أرصدة مدينة أخرى</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('note5', 'summary')" aria-label="عرض إجمالي لأرصدة مدينة أخرى">إجمالي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleView('note5', 'detailed')" aria-label="عرض تفصيلي لأرصدة مدينة أخرى">تفصيلي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note5Section')" aria-label="طباعة إيضاح أرصدة مدينة أخرى">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                    <div id="note5Summary">
                        <table class="financial-table">
                            <thead><tr><th>البيان</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note5SummaryBody"></tbody>
                        </table>
                    </div>
                    <div id="note5Detailed" style="display:none;">
                        <table class="financial-table">
                            <thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note5DetailedBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Note 6: المخزون -->
                <div class="note-item" id="note6Section">
                    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                        <h4 class="note-title mb-0">إيضاح (6): المخزون</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('note6', 'summary')" aria-label="عرض إجمالي للمخزون">إجمالي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleView('note6', 'detailed')" aria-label="عرض تفصيلي للمخزون">تفصيلي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note6Section')" aria-label="طباعة إيضاح المخزون">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                    <div id="note6Summary">
                        <table class="financial-table">
                            <thead><tr><th>البيان</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note6SummaryBody"></tbody>
                        </table>
                    </div>
                    <div id="note6Detailed" style="display:none;">
                        <table class="financial-table">
                            <thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note6DetailedBody"></tbody>
                        </table>
                    </div>
                </div>
                
                            <!-- Note 7: الممتلكات والآلات والمعدات -->
                <div class="note-item" id="note7Section">
                    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                        <h4 class="note-title mb-0">إيضاح (7): الممتلكات والآلات والمعدات</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('note7', 'summary')" aria-label="عرض إجمالي للممتلكات">إجمالي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleView('note7', 'detailed')" aria-label="عرض تفصيلي للممتلكات">تفصيلي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note7Section')" aria-label="طباعة إيضاح الممتلكات">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                    <div id="note7Summary">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>البيان</th>
                                    <th>2024م</th>
                                    <th>2023م</th>
                                </tr>
                            </thead>
                            <tbody id="note7SummaryBody"></tbody>
                        </table>
                    </div>
                    <div id="note7Detailed" style="display:none;">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>اسم الأصل</th>
                                    <th>التكلفة</th>
                                    <th>إضافات</th>
                                    <th>تصرفات</th>
                                    <th>إجمالي التكلفة</th>
                                    <th>الإهلاك المتراكم</th>
                                    <th>إهلاك السنة</th>
                                    <th>تصرفات الإهلاك</th>
                                    <th>إجمالي الإهلاك</th>
                                    <th>صافي القيمة 2024</th>
                                    <th>صافي القيمة 2023</th>
                                </tr>
                            </thead>
                            <tbody id="note7DetailedBody"></tbody>
                        </table>
                    </div>
                </div>

                
                <!-- Note 8: دائنون تجاريون -->
                <div class="note-item" id="note8Section">
                    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                        <h4 class="note-title mb-0">إيضاح (8): دائنون تجاريون</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('note8', 'summary')" aria-label="عرض إجمالي لدائنون تجاريون">إجمالي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleView('note8', 'detailed')" aria-label="عرض تفصيلي لدائنون تجاريون">تفصيلي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note8Section')" aria-label="طباعة إيضاح دائنون تجاريون">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                    <div id="note8Summary">
                        <table class="financial-table">
                            <thead><tr><th>البيان</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note8SummaryBody"></tbody>
                        </table>
                    </div>
                    <div id="note8Detailed" style="display:none;">
                        <table class="financial-table">
                            <thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note8DetailedBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Note 9: أرصدة دائنة أخرى -->
                <div class="note-item" id="note9Section">
                    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                        <h4 class="note-title mb-0">إيضاح (9): أرصدة دائنة أخرى</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('note9', 'summary')" aria-label="عرض إجمالي لأرصدة دائنة أخرى">إجمالي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleView('note9', 'detailed')" aria-label="عرض تفصيلي لأرصدة دائنة أخرى">تفصيلي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note9Section')" aria-label="طباعة إيضاح أرصدة دائنة أخرى">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                    <div id="note9Summary">
                        <table class="financial-table">
                            <thead><tr><th>البيان</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note9SummaryBody"></tbody>
                        </table>
                    </div>
                    <div id="note9Detailed" style="display:none;">
                        <table class="financial-table">
                            <thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note9DetailedBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Note 10: مخصص الزكاة والضريبة -->
                <div class="note-item" id="note10Section">
                    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
                        <h4 class="note-title mb-0">إيضاح (10): مخصص الزكاة والضريبة</h4>
                        <div>
                            <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('note10', 'summary')" aria-label="عرض إجمالي لمخصص الزكاة والضريبة">إجمالي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleView('note10', 'detailed')" aria-label="عرض تفصيلي لمخصص الزكاة والضريبة">تفصيلي</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note10Section')" aria-label="طباعة إيضاح مخصص الزكاة والضريبة">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                    <div id="note10Summary">
                        <table class="financial-table">
                            <thead><tr><th>البيان</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note10SummaryBody"></tbody>
                        </table>
                    </div>
                    <div id="note10Detailed" style="display:none;">
                        <table class="financial-table">
                            <thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>2024م</th><th>2023م</th></tr></thead>
                            <tbody id="note10DetailedBody"></tbody>
                        </table>
                    </div>
                </div>
                
             
<!-- START: إيضاحات قائمة الدخل (V51 - تصميم احترافي) -->
<!-- ================================================== -->

<!-- Note 11: تفاصيل الإيرادات -->
<div class="note-item" id="note11Section">
    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
        <h4 class="note-title mb-0">إيضاح (11): تفاصيل الإيرادات</h4>
        <div>
            <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('note11', 'summary')">إجمالي</button>
            <button class="btn btn-sm btn-outline-primary" onclick="toggleView('note11', 'detailed')">تفصيلي</button>
        </div>
    </div>
    <div id="note11Summary">
        <table class="financial-table"><tbody id="note11SummaryBody"></tbody></table>
    </div>
    <div id="note11Detailed" style="display:none;">
        <table class="financial-table"><tbody id="note11DetailedBody"></tbody></table>
    </div>
</div>

<!-- Note 12: تفاصيل المصروفات الإدارية -->
<div class="note-item" id="note12Section">
    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
        <h4 class="note-title mb-0">إيضاح (12): تفاصيل المصروفات العمومية والإدارية</h4>
        <div>
            <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('note12', 'summary')">إجمالي</button>
            <button class="btn btn-sm btn-outline-primary" onclick="toggleView('note12', 'detailed')">تفصيلي</button>
        </div>
    </div>
    <div id="note12Summary">
        <table class="financial-table"><tbody id="note12SummaryBody"></tbody></table>
    </div>
    <div id="note12Detailed" style="display:none;">
        <table class="financial-table"><tbody id="note12DetailedBody"></tbody></table>
    </div>
</div>

<!-- Note 13: تفاصيل مصروفات التشغيل -->
<div class="note-item" id="note13Section">
     <div class="d-flex justify-content-between align-items-center mb-2 no-print">
        <h4 class="note-title mb-0">إيضاح (13): تفاصيل مصروفات التشغيل</h4>
        <div>
            <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('note13', 'summary')">إجمالي</button>
            <button class="btn btn-sm btn-outline-primary" onclick="toggleView('note13', 'detailed')">تفصيلي</button>
        </div>
    </div>
    <div id="note13Summary">
        <table class="financial-table"><tbody id="note13SummaryBody"></tbody></table>
    </div>
    <div id="note13Detailed" style="display:none;">
        <table class="financial-table"><tbody id="note13DetailedBody"></tbody></table>
    </div>
</div>

<!-- Note 14: تفاصيل تكلفة الإيرادات -->
<div class="note-item" id="note14Section">
     <div class="d-flex justify-content-between align-items-center mb-2 no-print">
        <h4 class="note-title mb-0">إيضاح (14): تفاصيل تكلفة الإيرادات</h4>
        <div>
            <button class="btn btn-sm btn-outline-primary active" onclick="toggleView('note14', 'summary')">إجمالي</button>
            <button class="btn btn-sm btn-outline-primary" onclick="toggleView('note14', 'detailed')">تفصيلي</button>
        </div>
    </div>
    <div id="note14Summary">
        <table class="financial-table"><tbody id="note14SummaryBody"></tbody></table>
    </div>
    <div id="note14Detailed" style="display:none;">
        <table class="financial-table"><tbody id="note14DetailedBody"></tbody></table>
    </div>
</div>

<!-- ================================================== -->
<!-- END: إيضاحات قائمة الدخل (V51) -->
<!-- ================================================== -->
<!-- ================================================== -->
<!-- START: إيضاح رأس المال العامل (V54 - مصحح بالكامل) -->
<!-- ================================================== -->
<div class="note-item" id="note15Section">
    <div class="d-flex justify-content-between align-items-center mb-2 no-print">
        <h4 class="note-title mb-0">إيضاح (15): رأس المال العامل</h4>
        <div>
            <button class="btn btn-sm btn-outline-primary" onclick="printSection('note15Section')" aria-label="طباعة إيضاح رأس المال العامل">
                <i class="fas fa-print"></i>
            </button>
        </div>
    </div>
    <div id="note15Content"></div>
</div>
<!-- ================================================== -->
<!-- END: إيضاح رأس المال العامل (V54) -->
<!-- ================================================== -->

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>

        // *** UPDATED: Global variables for comparison data ***
        let priorYearData = null;
        let comparisonMode = false;

        // الكود الكامل هنا (منظف ومصلح)
        // خريطة التوافق بين أرقام التصنيفات الفرعية والقيم الإنجليزية
        const SUB_CATEGORY_MAPPING = {
            // ========== الأصول (Assets) ==========
            // 1110: النقد وما في حكمه
            '111001': 'cash', '111002': 'cash', '111003': 'cash', '111011': 'cash', '111012': 'cash', '111021': 'cash', '111031': 'cash',
            // 1120: استثمارات قصيرة الأجل
            '112001': 'short_term_investments', '112002': 'short_term_investments',
            // 1130: الذمم المدينة التجارية
            '113001': 'trade_receivables', '113002': 'trade_receivables', '113003': 'trade_receivables', '113004': 'trade_receivables', '113099': 'trade_receivables',
            // 1140: الذمم المدينة الأخرى
            '114001': 'other_receivables', '114002': 'other_receivables', '114003': 'other_receivables', '114004': 'other_receivables', '114005': 'other_receivables',
            // 1150: المصروفات المدفوعة مقدماً
            '115001': 'prepaid_expenses', '115002': 'prepaid_expenses', '115003': 'prepaid_expenses', '115099': 'prepaid_expenses',
        // 1160: المخزون
'116001': 'inventory', '116002': 'inventory', '116003': 'inventory', '116004': 'inventory', '116005': 'inventory', '116006': 'inventory', '116099': 'inventory', '101080004': 'inventory',

            // 1210: الأصول الثابتة
            '121001': 'fixed_assets', '121002': 'fixed_assets', '121003': 'fixed_assets', '121004': 'fixed_assets', '121005': 'fixed_assets', '121006': 'fixed_assets', '121007': 'fixed_assets',
            '121099': 'fixed_assets_accumulation',
            // 1220: استثمارات طويلة الأجل
            '122001': 'long_term_investments', '122002': 'long_term_investments', '122003': 'long_term_investments', '122004': 'long_term_investments',
            // 1230: أصول غير ملموسة
            '123001': 'intangible_assets', '123002': 'intangible_assets', '123003': 'intangible_assets', '123004': 'intangible_assets', '123099': 'intangible_assets',
            // 1240: أصول أخرى
            '124001': 'other_assets',
            // ========== الالتزامات (Liabilities) ==========
            // 2110: الموردون والأرصدة الدائنة
            '211001': 'trade_payables', '211002': 'trade_payables', '211003': 'trade_payables', '211004': 'trade_payables',
            // 2120: المصروفات المستحقة
            '212001': 'accrued_expenses', '212002': 'accrued_expenses', '212003': 'accrued_expenses', '212004': 'accrued_expenses', '212099': 'accrued_expenses',
            // 2130: مستحقات حكومية
            '213001': 'other_payables', '213002': 'zakat_tax_provision', '213003': 'other_payables', '213004': 'other_payables',
            // 2140: قروض ومخصصات متداولة
            '214001': 'other_payables', '214002': 'other_payables', '214003': 'other_payables',
            // 2210: قروض طويلة الأجل
            '221001': 'long_term_loans', '221002': 'long_term_loans',
            // 2220: مخصصات والتزامات أخرى
            '222001': 'end_of_service_benefit', '222002': 'other_payables', '222003': 'other_payables', '222004': 'other_payables',
            // ========== حقوق الملكية (Equity) ==========
            '310001': 'capital', '310002': 'capital',
            '320001': 'retained_earnings', '320002': 'retained_earnings', '320003': 'retained_earnings',
            '330001': 'retained_earnings', '330002': 'retained_earnings', '330003': 'retained_earnings', '330004': 'capital',
            // ========== الإيرادات (Revenue) ==========
            '410001': 'revenue', '410002': 'revenue', '410003': 'revenue', '410098': 'sales_returns', '410099': 'sales_discount',
            '420001': 'other_revenues', '420002': 'other_revenues', '420003': 'other_revenues', '420004': 'other_revenues', '420005': 'other_revenues',
            // ========== المصروفات (Expenses) ==========
            '510001': 'cogs', '510002': 'cogs', '510003': 'cogs', '510004': 'cogs',
            '610001': 'operating_expenses', '610002': 'operating_expenses', '610003': 'operating_expenses', '610004': 'operating_expenses',
            '620001': 'operating_expenses', '620002': 'operating_expenses', '620003': 'operating_expenses', '620004': 'operating_expenses',
            '620005': 'operating_expenses', '620006': 'operating_expenses', '620007': 'operating_expenses', '620008': 'operating_expenses',
            '620009': 'operating_expenses', '620010': 'operating_expenses', '620099': 'operating_expenses',
            '630001': 'depreciation', '630002': 'amortization',
            '710001': 'operating_expenses', '710002': 'operating_expenses', '710003': 'operating_expenses', '710004': 'operating_expenses',
            '720001': 'zakat_expense',
            // ========== حسابات وسيطة (Clearing) ==========
            '910001': 'clearing', '910002': 'clearing'
        };
        // Security Note: localStorage is used for demo purposes. For production, use server-side storage with encryption.
        function updateCompanyInfo(clientInfo) {
            const companyName = clientInfo.name || null;
            const startDate = clientInfo.startDate ? formatDateLong(new Date(clientInfo.startDate)) : null;
            const endDate = clientInfo.endDate ? formatDateLong(new Date(clientInfo.endDate)) : null;

            if (!companyName || !startDate || !endDate) {
                showError('<h4>خطأ: بيانات الشركة غير كاملة.</h4><p>الاسم أو التواريخ مفقودة. الرجاء التأكد من البيانات في ميزان المراجعة.</p>');
                return;
            }

            document.getElementById('companyNameDisplay').textContent = `القوائم المالية لـ ${companyName}`;
            document.getElementById('periodDisplay').textContent = `للفترة المالية من ${startDate} إلى ${endDate}`;
            document.getElementById('companyNamePrint').textContent = companyName;
            document.querySelector('.print-header p').textContent = `للسنة المالية المنتهية في ${endDate}`;
        }
     // ==================================================================
// ==================================================================
// ==================================================================
function calculateFinalBalance(account, adjustments = [], isPriorYear = false) {
    if (!account) return 0;

    // **المنطق الصحيح والأصلي هنا**
    // حساب الرصيد من الحركات وأرصدة أول المدة
    const ob_debit = parseFloat(account.ob_debit) || 0;
    const ob_credit = parseFloat(account.ob_credit) || 0;
    const move_debit = parseFloat(account.move_debit) || 0;
    const move_credit = parseFloat(account.move_credit) || 0;

    // إذا كنا نحسب رصيد السنة السابقة، نستخدم فقط رصيد أول المدة
    if (isPriorYear) {
        return ob_debit - ob_credit;
    }

    // الرصيد النهائي للسنة الحالية
    const finalBalance = (ob_debit - ob_credit) + (move_debit - move_credit);

    // تطبيق قيود التسوية (لا تغيير هنا)
    const adjustmentEffect = (adjustments || []).reduce((sum, adj) => {
        if (String(adj.debit_account) === String(account.account_id)) return sum + (parseFloat(adj.amount) || 0);
        if (String(adj.credit_account) === String(account.account_id)) return sum - (parseFloat(adj.amount) || 0);
        return sum;
    }, 0);

    return finalBalance + adjustmentEffect;
}
// ==================================================================
// ==================================================================
// --- START: دالة التصنيف النهائية (V28 - مع دعم المصروف المقدم) ---
// ==================================================================
// ==================================================================
// --- START: دالة التصنيف (V48 - النسخة النهائية المكتملة) ---
// ==================================================================
const categorizeAccounts = (function() {
    const cache = new Map();
    
    return function(trialBalance, adjustments = []) { 
        const cacheKey = JSON.stringify({ tb_length: trialBalance?.length, adj_length: adjustments?.length });
        if (cache.has(cacheKey)) {
            return cache.get(cacheKey);
        }

        const accounts = trialBalance || [];
        
        // ✨✨✨ التأكد من وجود كل الفئات المطلوبة ✨✨✨
        const categorized = { 
            revenue: [], 
            cogs: [], // <-- كان مفقوداً
            operatingExpenses: [], // <-- كان مفقوداً
            currentAssets: [], 
            fixedAssets: [], 
            currentLiabilities: [], 
            longTermLiabilities: [], 
            equity: [],
            // ... (بقية الفئات للإيضاحات)
            note3_cash: [], note4_tradeReceivables: [], note5_otherReceivables: [],
            note6_inventory: [], note_prepaid_expenses: []
        };

        accounts.forEach(account => {
            if (!account || !account.category) return;

            const finalBalance = calculateFinalBalance(account, adjustments, false);
            const accountWithBalance = { ...account, finalBalance };
            
            const mainCategory = String(account.category || '').toLowerCase();

            // ✨✨✨ منطق التصنيف الصحيح هنا ✨✨✨
            switch (mainCategory) {
           // ==================================================================
// --- START: التعديل الوحيد والدقيق (V87) ---
// ==================================================================
// ==================================================================
// --- START: التعديل الجذري والدقيق (V95) ---
// ==================================================================
case 'assets':
    const englishSubCategoryForAssets = SUB_CATEGORY_MAPPING[account.sub_category] || 'unknown';
    
    if (['fixed_assets', 'fixed_assets_accumulation'].includes(englishSubCategoryForAssets)) {
        categorized.fixedAssets.push(accountWithBalance);
    } 
    // هذا هو التصنيف الصحيح للأصول المتداولة
    else if (['cash', 'trade_receivables', 'other_receivables', 'prepaid_expenses', 'inventory'].includes(englishSubCategoryForAssets)) {
        categorized.currentAssets.push(accountWithBalance);
    }
    // يمكنك إضافة else هنا للتعامل مع أي أصول غير مصنفة إذا أردت
    
    break;
// ==================================================================
// --- END: التعديل الجذري والدقيق (V95) ---
// ==================================================================
// ==================================================================
// --- END: التعديل الوحيد والدقيق (V87) ---
// ==================================================================

                case 'liabilities':
                    if ((String(account.sub_category || '')).startsWith('22')) {
                        categorized.longTermLiabilities.push(accountWithBalance);
                    } else {
                        categorized.currentLiabilities.push(accountWithBalance);
                    }
                    break;
                case 'equity':
                    categorized.equity.push(accountWithBalance);
                    break;
                case 'revenue':
                    categorized.revenue.push(accountWithBalance);
                    break;
                case 'expenses':
                    // هذا هو التقسيم الحاسم للمصروفات
                    if (account.account_id && account.account_id.startsWith('303')) {
                        categorized.cogs.push(accountWithBalance);
                    } else {
                        categorized.operatingExpenses.push(accountWithBalance);
                    }
                    break;
            }
        });

        cache.set(cacheKey, categorized);
        return categorized;
    };
})();
// ==================================================================
// --- END: دالة التصنيف (V48) ---
// ==================================================================
// ==================================================================
// --- START: دالة قائمة الدخل (V47 - النسخة النهائية القاطعة) ---
// ==================================================================
function generateIncomeStatement(categorizedData) {
    if (!categorizedData) return { /* ... قيم صفرية ... */ };

    const isMainRevenue = (acc) => {
        const n = String(acc?.name || '').toLowerCase();
        const id = String(acc?.account_id || '');
        return id.startsWith('401') || id.startsWith('410') || n.includes('مبيعات') || n.includes('خرسانة') || n.includes('الخرسانة') || n.includes('بلوك') || n.includes('البلوك') || n.includes('كسارة') || n.includes('الكسارة');
    };
    const revAccounts = categorizedData.revenue || [];
    const mainRevenueAccounts = revAccounts.filter(isMainRevenue);
    const otherRevenueAccounts = revAccounts.filter(acc => !isMainRevenue(acc));
    const totalRevenue = -mainRevenueAccounts.reduce((sum, acc) => sum + (acc.finalBalance || 0), 0);
    const otherRevenuesFromRevenue = -otherRevenueAccounts.reduce((sum, acc) => sum + (acc.finalBalance || 0), 0);
    const otherRevenues = otherRevenuesFromRevenue;

    // 2. التقسيم النهائي والصحيح للمصروفات بناءً على رقم الحساب
    const totalCOGS = categorizedData.cogs.reduce((sum, acc) => sum + acc.finalBalance, 0);
    const grossProfit = totalRevenue - totalCOGS;

    const operatingExpenses = categorizedData.operatingExpenses
        .filter(acc => acc.account_id && acc.account_id.startsWith('60101') && !acc.account_id.startsWith('601010003'))
        .reduce((sum, acc) => sum + acc.finalBalance, 0);

    const adminExpenses = categorizedData.operatingExpenses
        .filter(acc => acc.account_id && acc.account_id.startsWith('60102'))
        .reduce((sum, acc) => sum + acc.finalBalance, 0);

    const depreciationExpense = categorizedData.operatingExpenses
        .filter(acc => acc.account_id && acc.account_id.startsWith('601010003'))
        .reduce((sum, acc) => sum + acc.finalBalance, 0);
        
    const zakatExpense = categorizedData.operatingExpenses
        .filter(acc => acc.account_id && acc.account_id.startsWith('72'))
        .reduce((sum, acc) => sum + acc.finalBalance, 0);

    // 3. حساب صافي الدخل بالترتيب الصحيح
    const totalExpenses = operatingExpenses + adminExpenses + depreciationExpense;
    const netIncomeBeforeZakat = grossProfit + otherRevenues - totalExpenses;
    const finalNetIncome = netIncomeBeforeZakat - zakatExpense;

    return { 
        totalRevenue, totalCOGS, grossProfit,
        operatingExpenses, adminExpenses, depreciationExpense, totalExpenses,
        otherRevenues, netIncomeBeforeZakat, zakatExpense, finalNetIncome,
        allAccounts: categorizedData 
    };
}
// ==================================================================
// --- END: دالة قائمة الدخل (V47) ---
// ==================================================================


// --- START: دالة توليد قائمة المركز المالي (النسخة النهائية الآمنة) ---
// ==================================================================
// ==================================================================
// --- START: دالة المركز المالي (V5 - مع منطق حساب الصافي الصحيح) ---
// ==================================================================
function generateBalanceSheet(categorizedData, netProfit, isPriorYear = false) {
    if (!categorizedData) {
        return { /* ... قيم صفرية ... */ allAccounts: {} };
    }

    const sum = (accounts) => (accounts || []).reduce((total, acc) => total + (acc.finalBalance || 0), 0);

    const currentAssets = sum(categorizedData.currentAssets);
    
    // **الإصلاح الحاسم هنا: حساب صافي الأصول الثابتة**
    // صافي الأصول الثابتة = مجموع أرصدة كل الحسابات في مجموعة fixedAssets
    // (بما في ذلك الأصول ومجمعاتها، حيث أن المجمعات أرصدتها سالبة)
    const fixedAssets = sum(categorizedData.fixedAssets); 
    
    const totalAssets = currentAssets + fixedAssets;

    const currentLiabilities = sum(categorizedData.currentLiabilities);
    const longTermLiabilities = sum(categorizedData.longTermLiabilities);
    const totalLiabilities = currentLiabilities + longTermLiabilities;

    // استخدام المعادلة المحاسبية لضمان التوازن
    const totalEquity = -(totalAssets + totalLiabilities); 
    
    const accountingEquationBalance = totalAssets + totalLiabilities + totalEquity;
    const isBalanced = Math.abs(accountingEquationBalance) < 1;

    return {
        currentAssets,
        fixedAssets, // <-- هذا الرقم الآن هو الصافي الصحيح
        totalAssets,
        currentLiabilities: -currentLiabilities,
        longTermLiabilities: -longTermLiabilities,
        totalLiabilities: -totalLiabilities,
        totalEquity: -totalEquity,
        isBalanced,
        accountingEquationBalance,
        allAccounts: categorizedData
    };
}
// ==================================================================
// --- END: دالة المركز المالي ---
// ==================================================================
// ==================================================================
// --- END: دالة توليد قائمة المركز المالي (النسخة النهائية الآمنة) ---
// ==================================================================

      
      

// ==================================================================
// --- START: إضافة دالة الرسوم البيانية المفقودة ---
// ==================================================================

function initializeCharts(incomeData, balanceData) {
    // تدمير الرسوم البيانية القديمة إذا كانت موجودة لمنع التداخل
    Object.values(chartInstances).forEach(chart => chart.destroy());

    const currentIncome = incomeData.current;
    const priorIncome = incomeData.prior;
    const currentBalance = balanceData.current;

    // 1. Revenue Chart
    const revenueCtx = document.getElementById('revenueChart')?.getContext('2d');
    if (revenueCtx) {
        chartInstances.revenueChart = new Chart(revenueCtx, {
            type: 'bar',
            data: {
                labels: ['السنة الحالية', 'السنة السابقة'],
                datasets: [{
                    label: 'صافي الإيرادات',
                    data: [currentIncome.totalRevenue, priorIncome.totalRevenue],
                    backgroundColor: 'rgba(0, 170, 255, 0.6)',
                    borderColor: 'rgba(0, 170, 255, 1)',
                    borderWidth: 1
                }, {
                    label: 'صافي الربح',
                    data: [currentIncome.netProfit, priorIncome.netProfit],
                    backgroundColor: 'rgba(40, 167, 69, 0.6)',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    // 2. Assets Chart
    const assetsCtx = document.getElementById('assetsChart')?.getContext('2d');
    if (assetsCtx) {
        chartInstances.assetsChart = new Chart(assetsCtx, {
            type: 'doughnut',
            data: {
                labels: ['أصول متداولة', 'أصول ثابتة'],
                datasets: [{
                    data: [currentBalance.currentAssets, currentBalance.fixedAssets],
                    backgroundColor: ['rgba(0, 170, 255, 0.7)', 'rgba(0, 100, 150, 0.7)'],
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    // 3. Liabilities Chart
    const liabilitiesCtx = document.getElementById('liabilitiesChart')?.getContext('2d');
    if (liabilitiesCtx) {
        chartInstances.liabilitiesChart = new Chart(liabilitiesCtx, {
            type: 'pie',
            data: {
                labels: ['التزامات متداولة', 'التزامات طويلة الأجل', 'حقوق الملكية'],
                datasets: [{
                    data: [currentBalance.currentLiabilities, currentBalance.longTermLiabilities, currentBalance.totalEquity],
                    backgroundColor: ['rgba(255, 193, 7, 0.7)', 'rgba(220, 53, 69, 0.7)', 'rgba(40, 167, 69, 0.7)'],
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    // 4. Margins Chart
    const marginsCtx = document.getElementById('marginsChart')?.getContext('2d');
    if (marginsCtx) {
        const grossMargin = currentIncome.totalRevenue > 0 ? (currentIncome.grossProfit / currentIncome.totalRevenue) * 100 : 0;
        const netMargin = currentIncome.totalRevenue > 0 ? (currentIncome.netProfit / currentIncome.totalRevenue) * 100 : 0;
        chartInstances.marginsChart = new Chart(marginsCtx, {
            type: 'bar',
            data: {
                labels: ['هامش الربح الإجمالي', 'هامش الربح الصافي'],
                datasets: [{
                    label: 'هوامش الربح (%)',
                    data: [grossMargin, netMargin],
                    backgroundColor: ['rgba(23, 162, 184, 0.6)', 'rgba(40, 167, 69, 0.6)'],
                    borderColor: ['rgba(23, 162, 184, 1)', 'rgba(40, 167, 69, 1)'],
                    borderWidth: 1
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { callback: value => value + '%' } } }
            }
        });
    }
}

// ==================================================================
// --- END: إضافة دالة الرسوم البيانية المفقودة ---
// ==================================================================

function formatCurrency(value, useParenthesesForNegative = true) {
    if (value === null || value === undefined || isNaN(value)) return '-';
    const num = Math.abs(value);
    const formattedNum = new Intl.NumberFormat('ar-SA', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num);
    if (value < 0 && useParenthesesForNegative) return `(${formattedNum})`;
    return formattedNum;
}
function formatDateLong(dateObj) {
    const d = new Date(dateObj);
    const dd = d.toLocaleString('en-GB', { day: '2-digit' });
    const monthName = d.toLocaleString('ar-EG', { month: 'long' });
    const yyyy = d.toLocaleString('en-GB', { year: 'numeric' });
    return `${dd} ${monthName} ${yyyy}`;
}
function formatDateDMY(dateObj) {
    const d = new Date(dateObj);
    try {
        return new Intl.DateTimeFormat('ar-EG', { day: '2-digit', month: '2-digit', year: 'numeric' }).format(d);
    } catch {
        const dd = String(d.getDate()).padStart(2, '0');
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const yyyy = String(d.getFullYear());
        return `${dd}/${mm}/${yyyy}`;
    }
}
function formatYear(year) {
    const y = parseInt(year);
    return isNaN(y) ? '-' : String(y);
}
        function showError(message) {
            const container = document.getElementById('loadingIndicator');
            container.innerHTML = `
                <div class="alert alert-danger text-center" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                </div>`;
        }
        function scrollToNote(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                document.getElementById('notesSection').style.display = 'block';
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                element.style.backgroundColor = 'rgba(0, 170, 255, 0.1)';
                setTimeout(() => element.style.backgroundColor = '', 2000);
            }
        }
        function toggleView(elementId, viewType) {
            const summaryDiv = document.getElementById(`${elementId}Summary`);
            const detailedDiv = document.getElementById(`${elementId}Detailed`);
            if (!summaryDiv) {
                console.warn(`Warning: Could not find summary div for elementId: ${elementId}`);
                return;
            }
            const section = summaryDiv.closest('.financial-statement, .note-item');
            if (section) {
                const buttons = section.querySelectorAll('.btn-group button, div > button.btn');
                buttons.forEach(btn => btn.classList.remove('active'));
                const summaryButton = Array.from(buttons).find(btn => btn.textContent.includes('إجمالي'));
                const detailedButton = Array.from(buttons).find(btn => btn.textContent.includes('تفصيلي'));
                if (viewType === 'summary' && summaryButton) summaryButton.classList.add('active');
                else if (viewType === 'detailed' && detailedButton) detailedButton.classList.add('active');
            }
            summaryDiv.style.display = (viewType === 'summary') ? 'block' : 'none';
            if (detailedDiv) detailedDiv.style.display = (viewType === 'detailed') ? 'block' : 'none';
        }
  // *** UPDATED: Toggle Comparison Mode ***
  function toggleComparisonMode() {
    comparisonMode = document.getElementById('comparisonMode').checked;
    localStorage.setItem('comparisonMode', comparisonMode);
    
    // إعادة بناء الصفحة بالكامل لتعكس التغيير
    initializeDashboard(); 
}

// ==================================================================
// --- START: دالة عرض قائمة الدخل (V43 - مع التقسيم الرباعي) ---
// ==================================================================
// ==================================================================
// --- START: دالة عرض قائمة الدخل (V50 - كاملة وتفاعلية) ---
// ==================================================================
// *** UPDATED: displayIncomeStatement to handle comparison ***
function displayIncomeStatement(fullIncomeData, comparisonMode, currentYear, priorYear) {
    const summaryContainer = document.getElementById('incomeStatementContent');
    const detailedContainer = document.getElementById('incomeStatementDetailedContent');
    const current = fullIncomeData.current;
    const prior = fullIncomeData.prior;

    if (!current || !summaryContainer || !detailedContainer) {
        if(summaryContainer) summaryContainer.innerHTML = `<div class="data-empty">لا توجد بيانات.</div>`;
        if(detailedContainer) detailedContainer.innerHTML = `<div class="data-empty">لا توجد بيانات.</div>`;
        return;
    }

    // --- 1. بناء العرض الإجمالي التفاعلي (Summary View) ---
    const currentLabelIS = window._polaris_endDate ? `(${window._polaris_endDate})` : '-';
    const priorLabelIS = window._polaris_priorEndDate ? `(${window._polaris_priorEndDate})` : '-';
    let summaryHtml = `<table class="financial-table ${comparisonMode ? 'comparison-table' : ''}"><thead><tr><th width="50%">البند</th><th>إيضاح</th><th>${currentLabelIS}</th>${comparisonMode ? `<th>${priorLabelIS}</th>` : ''}</tr></thead>
        <tbody>
            <tr><td>صافي الإيرادات</td><td><span class="note-link" onclick="scrollToNote('note11Section')">11</span></td><td class="amount">${formatCurrency(current.totalRevenue)}</td>${comparisonMode ? `<td class="amount">${formatCurrency(prior.totalRevenue)}</td>` : ''}</tr>
            <tr><td>يخصم: تكلفة الإيرادات</td><td><span class="note-link" onclick="scrollToNote('note14Section')">14</span></td><td class="amount negative">(${formatCurrency(current.totalCOGS)})</td>${comparisonMode ? `<td class="amount negative">(${formatCurrency(prior.totalCOGS)})</td>` : ''}</tr>
            <tr class="sub-total"><td><strong>مجمل الربح</strong></td><td></td><td class="amount"><strong>${formatCurrency(current.grossProfit)}</strong></td>${comparisonMode ? `<td class="amount"><strong>${formatCurrency(prior.grossProfit)}</strong></td>` : ''}</tr>
            <tr><td colspan="3" style="height:10px;"></td>${comparisonMode ? '<td></td>' : ''}</tr>
            <tr><td>يضاف: إيرادات أخرى</td><td><span class="note-link" onclick="scrollToNote('note11Section')">11</span></td><td class="amount">${formatCurrency(current.otherRevenues)}</td>${comparisonMode ? `<td class="amount">${formatCurrency(prior.otherRevenues)}</td>` : ''}</tr>
            <tr><td>يخصم: مصروفات التشغيل</td><td><span class="note-link" onclick="scrollToNote('note13Section')">13</span></td><td class="amount negative">(${formatCurrency(current.operatingExpenses)})</td>${comparisonMode ? `<td class="amount negative">(${formatCurrency(prior.operatingExpenses)})</td>` : ''}</tr>
            <tr><td>يخصم: مصروفات عمومية وإدارية</td><td><span class="note-link" onclick="scrollToNote('note12Section')">12</span></td><td class="amount negative">(${formatCurrency(current.adminExpenses)})</td>${comparisonMode ? `<td class="amount negative">(${formatCurrency(prior.adminExpenses)})</td>` : ''}</tr>
            <tr><td>يخصم: اهلاك للممتلكات والمعدات</td><td><span class="note-link" onclick="scrollToNote('note7Section')">7</span></td><td class="amount negative">(${formatCurrency(current.depreciationExpense)})</td>${comparisonMode ? `<td class="amount negative">(${formatCurrency(prior.depreciationExpense)})</td>` : ''}</tr>
            <tr class="sub-total"><td><strong>صافي الدخل قبل خصم الزكاة</strong></td><td></td><td class="amount ${current.netIncomeBeforeZakat < 0 ? 'negative' : ''}"><strong>${formatCurrency(current.netIncomeBeforeZakat)}</strong></td>${comparisonMode ? `<td class="amount ${prior.netIncomeBeforeZakat < 0 ? 'negative' : ''}"><strong>${formatCurrency(prior.netIncomeBeforeZakat)}</strong></td>` : ''}</tr>
            <tr><td>يخصم: الزكاة الشرعية</td><td><span class="note-link" onclick="scrollToNote('note10Section')">10</span></td><td class="amount negative">(${formatCurrency(current.zakatExpense)})</td>${comparisonMode ? `<td class="amount negative">(${formatCurrency(prior.zakatExpense)})</td>` : ''}</tr>
            <tr class="total"><td><strong>صافي الخسارة النهائية</strong></td><td></td><td class="amount ${current.finalNetIncome < 0 ? 'negative' : ''}"><strong>${formatCurrency(current.finalNetIncome)}</strong></td>${comparisonMode ? `<td class="amount ${prior.finalNetIncome < 0 ? 'negative' : ''}"><strong>${formatCurrency(prior.finalNetIncome)}</strong></td>` : ''}</tr>
        </tbody>
    </table>`;
    summaryContainer.innerHTML = summaryHtml;

    // --- 2. بناء العرض التفصيلي (Detailed View) ---
    let detailedHtml = `<table class="financial-table">
        <thead>
            <tr>
                <th>رقم الحساب</th>
                <th>اسم الحساب</th>
                <th class="text-end">المبلغ</th>
            </tr>
        </thead>
        <tbody>`;

    // دالة مساعدة لإنشاء الصفوف التفصيلية
    const createDetailedRows = (accounts, isNegative = false) => {
        if (!accounts || accounts.length === 0) return `<tr><td colspan="3" class="text-center text-muted">-- لا توجد حسابات --</td></tr>`;
        return accounts.map(acc => `
            <tr>
                <td>${acc.account_id || '-'}</td>
                <td>${acc.name}</td>
                <td class="amount ${isNegative ? 'negative' : ''}">${formatCurrency(acc.finalBalance)}</td>
            </tr>
        `).join('');
    };

    // بناء كل قسم بالتفصيل
    detailedHtml += `<tr><td colspan="3" class="sub-total"><strong>الإيرادات الرئيسية</strong></td></tr>`;
    const isMainRevenue = (acc) => {
        const n = String(acc?.name || '').toLowerCase();
        const id = String(acc?.account_id || '');
        return id.startsWith('401') || id.startsWith('410') || n.includes('مبيعات') || n.includes('خرسانة') || n.includes('الخرسانة') || n.includes('بلوك') || n.includes('البلوك') || n.includes('كسارة') || n.includes('الكسارة');
    };
    const mainRevAccounts = current.allAccounts.revenue.filter(isMainRevenue);
    detailedHtml += createDetailedRows(mainRevAccounts, true); // الإيرادات دائنة (سالبة)
    const mainRevTotal = -mainRevAccounts.reduce((s,a)=> s + (a.finalBalance || 0), 0);
    detailedHtml += `<tr class="sub-total"><td colspan="2"><strong>الإجمالي</strong></td><td class="amount"><strong>${formatCurrency(mainRevTotal)}</strong></td></tr>`;

    detailedHtml += `<tr><td colspan="3" class="sub-total"><strong>الإيرادات الأخرى</strong></td></tr>`;
    const otherRevAccounts = current.allAccounts.revenue.filter(acc => !isMainRevenue(acc));
    detailedHtml += createDetailedRows(otherRevAccounts, true);
    const otherRevTotal = -otherRevAccounts.reduce((s,a)=> s + (a.finalBalance || 0), 0);
    detailedHtml += `<tr class="sub-total"><td colspan="2"><strong>الإجمالي</strong></td><td class="amount"><strong>${formatCurrency(otherRevTotal)}</strong></td></tr>`;

    detailedHtml += `<tr><td colspan="3" class="sub-total"><strong>تكلفة الإيرادات (COGS)</strong></td></tr>`;
    const cogsAccounts = current.allAccounts.cogs;
    detailedHtml += createDetailedRows(cogsAccounts, false);
    const cogsTotal = cogsAccounts.reduce((s,a)=> s + (a.finalBalance || 0), 0);
    detailedHtml += `<tr class="sub-total"><td colspan="2"><strong>الإجمالي</strong></td><td class="amount negative"><strong>(${formatCurrency(cogsTotal)})</strong></td></tr>`;

    detailedHtml += `<tr><td colspan="3" class="sub-total"><strong>مصروفات التشغيل</strong></td></tr>`;
    const opexAccounts = current.allAccounts.operatingExpenses.filter(acc => acc.account_id && acc.account_id.startsWith('60101') && !acc.account_id.startsWith('601010003'));
    detailedHtml += createDetailedRows(opexAccounts, false);
    const opexTotal = opexAccounts.reduce((s,a)=> s + (a.finalBalance || 0), 0);
    detailedHtml += `<tr class="sub-total"><td colspan="2"><strong>الإجمالي</strong></td><td class="amount negative"><strong>(${formatCurrency(opexTotal)})</strong></td></tr>`;

    detailedHtml += `<tr><td colspan="3" class="sub-total"><strong>المصروفات العمومية والإدارية</strong></td></tr>`;
    const adminAccounts = current.allAccounts.operatingExpenses.filter(acc => acc.account_id && acc.account_id.startsWith('60102'));
    detailedHtml += createDetailedRows(adminAccounts, false);
    const adminTotal = adminAccounts.reduce((s,a)=> s + (a.finalBalance || 0), 0);
    detailedHtml += `<tr class="sub-total"><td colspan="2"><strong>الإجمالي</strong></td><td class="amount negative"><strong>(${formatCurrency(adminTotal)})</strong></td></tr>`;

    detailedHtml += `<tr><td colspan="3" class="sub-total"><strong>مصروفات الإهلاك</strong></td></tr>`;
    const depAccounts = current.allAccounts.operatingExpenses.filter(acc => acc.account_id && acc.account_id.startsWith('601010003'));
    detailedHtml += createDetailedRows(depAccounts, false);
    const depTotal = depAccounts.reduce((s,a)=> s + (a.finalBalance || 0), 0);
    detailedHtml += `<tr class="sub-total"><td colspan="2"><strong>الإجمالي</strong></td><td class="amount negative"><strong>(${formatCurrency(depTotal)})</strong></td></tr>`;

    detailedHtml += `<tr class="total"><td colspan="2"><strong>صافي الربح (الخسارة)</strong></td><td class="amount ${current.finalNetIncome < 0 ? 'negative' : ''}"><strong>${formatCurrency(current.finalNetIncome)}</strong></td></tr>`;

    // إضافة إجماليات واضحة داخل التفصيل
    detailedHtml += `
        <tr><td colspan="3" class="sub-total"><strong>إجماليات التفصيل</strong></td></tr>
        <tr><td>إجمالي الإيرادات الرئيسية</td><td></td><td class="amount"><strong>${formatCurrency(current.totalRevenue)}</strong></td></tr>
        <tr><td>إجمالي تكلفة الإيرادات</td><td></td><td class="amount negative"><strong>(${formatCurrency(current.totalCOGS)})</strong></td></tr>
        <tr class="sub-total"><td><strong>مجمل الربح</strong></td><td></td><td class="amount"><strong>${formatCurrency(current.grossProfit)}</strong></td></tr>
        <tr><td>إجمالي الإيرادات الأخرى</td><td></td><td class="amount"><strong>${formatCurrency(current.otherRevenues)}</strong></td></tr>
        <tr><td>إجمالي مصروفات التشغيل</td><td></td><td class="amount negative"><strong>(${formatCurrency(current.operatingExpenses)})</strong></td></tr>
        <tr><td>إجمالي المصروفات العمومية والإدارية</td><td></td><td class="amount negative"><strong>(${formatCurrency(current.adminExpenses)})</strong></td></tr>
        <tr><td>إجمالي الإهلاك</td><td></td><td class="amount negative"><strong>(${formatCurrency(current.depreciationExpense)})</strong></td></tr>
        <tr class="sub-total"><td><strong>صافي الدخل قبل خصم الزكاة</strong></td><td></td><td class="amount ${current.netIncomeBeforeZakat < 0 ? 'negative' : ''}"><strong>${formatCurrency(current.netIncomeBeforeZakat)}</strong></td></tr>
        <tr><td>الزكاة الشرعية</td><td></td><td class="amount negative"><strong>(${formatCurrency(current.zakatExpense)})</strong></td></tr>
        <tr class="total"><td><strong>صافي الربح (الخسارة) النهائي</strong></td><td></td><td class="amount ${current.finalNetIncome < 0 ? 'negative' : ''}"><strong>${formatCurrency(current.finalNetIncome)}</strong></td></tr>
    `;

    detailedHtml += `</tbody></table>`;
    detailedContainer.innerHTML = detailedHtml;
}
// ==================================================================
// ==================================================================
// ==================================================================
// --- START: دوال إيضاحات قائمة الدخل (V51 - كاملة) ---
// ==================================================================

/**
 * دالة مساعدة عامة وقوية لإنشاء إيضاح كامل (إجمالي وتفصيلي)
 * @param {string} noteId - رقم الإيضاح (مثل '11')
 * @param {string} noteTitle - عنوان البند (مثل 'صافي الإيرادات')
 * @param {Array} accounts - مصفوفة الحسابات الخاصة بهذا البند
 */
function renderFullNote(noteId, noteTitle, accounts, comparisonMode, currentYear, priorYear) {
    const summaryBody = document.getElementById(`note${noteId}SummaryBody`);
    const detailedBody = document.getElementById(`note${noteId}DetailedBody`);
    if (!summaryBody || !detailedBody) return;

    let totalAmount = 0;
    const currentLabel = window._polaris_endDate ? `(${window._polaris_endDate})` : '-';
    let detailedHTML = `<thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th class="text-end">${currentLabel}</th></tr></thead><tbody>`;

    if (!accounts || accounts.length === 0) {
        detailedHTML += `<tr><td colspan="3" class="text-center text-muted">-- لا توجد حسابات --</td></tr>`;
    } else {
        accounts.forEach(acc => {
            const balance = acc.finalBalance;
            totalAmount += balance;
            detailedHTML += `<tr>
                <td>${acc.account_id || '-'}</td>
                <td>${acc.name}</td>
                <td class="amount">${formatCurrency(balance)}</td>
            </tr>`;
        });
    }
    detailedHTML += '</tbody>';
    detailedBody.parentElement.innerHTML = detailedHTML;

    // بناء العرض الإجمالي
    let summaryHTML = `<thead><tr><th>البيان</th><th class="text-end">${currentLabel}</th></tr></thead>
                       <tbody>
                           <tr>
                               <td>${noteTitle}</td>
                               <td class="amount">${formatCurrency(totalAmount)}</td>
                           </tr>
                           <tr class="total">
                               <td><strong>الإجمالي</strong></td>
                               <td class="amount"><strong>${formatCurrency(totalAmount)}</strong></td>
                           </tr>
                       </tbody>`;
    summaryBody.parentElement.innerHTML = summaryHTML;
}

/**
 * دالة رئيسية لتشغيل بناء جميع إيضاحات قائمة الدخل
 */
function renderIncomeStatementNotes(categorizedData, comparisonMode, currentYear, priorYear) {
    // إيضاح 11: الإيرادات (الرئيسية والأخرى)
    renderFullNote('11', 'إجمالي الإيرادات', categorizedData.revenue, comparisonMode, currentYear, priorYear);

    // إيضاح 12: المصروفات الإدارية
    const adminAccounts = categorizedData.operatingExpenses.filter(acc => acc.account_id && acc.account_id.startsWith('60102'));
    renderFullNote('12', 'إجمالي المصروفات العمومية والإدارية', adminAccounts, comparisonMode, currentYear, priorYear);

    // إيضاح 13: مصروفات التشغيل
    const operatingAccounts = categorizedData.operatingExpenses.filter(acc => acc.account_id && acc.account_id.startsWith('60101') && !acc.account_id.startsWith('601010003'));
    renderFullNote('13', 'إجمالي مصروفات التشغيل', operatingAccounts, comparisonMode, currentYear, priorYear);

    // إيضاح 14: تكلفة الإيرادات
    renderFullNote('14', 'إجمالي تكلفة الإيرادات', categorizedData.cogs, comparisonMode, currentYear, priorYear);
}
// ==================================================================
// --- END: دوال إيضاحات قائمة الدخل (V51) ---
// ==================================================================
// --- END: دالة عرض قائمة الدخل (V43) ---
// ==================================================================

// ==================================================================
// ==================================================================
// --- START: دالة عرض المركز المالي (النسخة النهائية الشاملة) ---
// ==================================================================
// *** UPDATED: displayBalanceSheet to handle comparison ***
function displayBalanceSheet(balanceData, auditData, comparisonMode, currentYear, priorYear, netIncome) {
    const container = document.getElementById('balanceSheetContent');
    const detailedContainer = document.getElementById('balanceSheetDetailedContent');

    if (!auditData || !auditData.trialBalance) {
        container.innerHTML = `<div class="data-empty">لا توجد بيانات كافية لعرض الميزانية.</div>`;
        return;
    }

    // ✨✨✨ --- الجزء الأول: حساب كل قيمة بشكل مباشر ودقيق --- ✨✨✨
    
    // دالة مساعدة للحساب الآمن
    const safeSum = (accounts) => (accounts || []).reduce((sum, acc) => sum + calculateFinalBalance(acc, auditData.adjustments), 0);
    // دالة مساعدة للحصول على القيمة الموجبة لكل التزام
    const getLiabilityValue = (accounts) => -safeSum(accounts);

    // --- حساب الأصول المتداولة ---
    const currentCash = safeSum(auditData.trialBalance.filter(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'cash'));
    const currentReceivables = safeSum(auditData.trialBalance.filter(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'trade_receivables'));
    const currentInventory = safeSum(auditData.trialBalance.filter(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'inventory'));
    
    // الأرصدة المدينة الأخرى (فقط الموجبة)
    const currentOtherReceivables = safeSum(auditData.trialBalance.filter(acc => {
        const subCat = SUB_CATEGORY_MAPPING[acc.sub_category];
        const balance = calculateFinalBalance(acc, auditData.adjustments);
        return ['other_receivables', 'prepaid_expenses'].includes(subCat) && balance > 0;
    }));

    // ✨✨✨ --- إضافة "الأرصدة المدينة لدى الموردين" إلى الأصول --- ✨✨✨
    const payablesReceivables = safeSum(auditData.trialBalance.filter(acc => {
        const subCat = SUB_CATEGORY_MAPPING[acc.sub_category];
        const balance = calculateFinalBalance(acc, auditData.adjustments);
        // نجمع الموردين الذين رصيدهم موجب (لديك فلوس عندهم)
        return subCat === 'trade_payables' && balance > 0;
    }));

    const totalCurrentAssets = currentCash + currentReceivables + currentInventory + currentOtherReceivables + payablesReceivables;

    // --- حساب الأصول الثابتة ---
    const currentFixedAssets = safeSum(auditData.trialBalance.filter(acc => ['fixed_assets', 'fixed_assets_accumulation'].includes(SUB_CATEGORY_MAPPING[acc.sub_category])));

    const totalAssets = totalCurrentAssets + currentFixedAssets;

    // --- حساب الالتزامات المتداولة (مع استبعاد الأرصدة المدينة) ---
    const currentPayables = getLiabilityValue(auditData.trialBalance.filter(acc => {
        const subCat = SUB_CATEGORY_MAPPING[acc.sub_category];
        const balance = calculateFinalBalance(acc, auditData.adjustments);
        // نعتبر المورد التزاماً فقط إذا كان رصيده سالباً (أنت مدين له)
        return subCat === 'trade_payables' && balance < 0;
    }));
    
    // الأرصدة الدائنة الأخرى (تشمل الدائنة بطبيعتها والمدينة التي أصبحت سالبة والمصروفات المستحقة)
    const currentOtherPayables = getLiabilityValue(auditData.trialBalance.filter(acc => {
        const subCat = SUB_CATEGORY_MAPPING[acc.sub_category];
        const balance = calculateFinalBalance(acc, auditData.adjustments);
        return subCat === 'other_payables' || subCat === 'accrued_expenses' || (['other_receivables', 'prepaid_expenses'].includes(subCat) && balance < 0);
    }));
    
    const currentZakat = getLiabilityValue(auditData.trialBalance.filter(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'zakat_tax_provision'));

    const totalCurrentLiabilities = currentPayables + currentOtherPayables + currentZakat;

    // --- حساب الالتزامات طويلة الأجل ---
    const longTermLiabilities = getLiabilityValue(auditData.trialBalance.filter(acc => {
        const subCat = SUB_CATEGORY_MAPPING[acc.sub_category] || '';
        return subCat === 'long_term_loans' || subCat === 'end_of_service_benefit' || subCat.startsWith('long_term');
    }));
    const totalLiabilities = totalCurrentLiabilities + longTermLiabilities;

    // ✨✨✨ --- الجزء الثاني: حساب حقوق الملكية بشكل مفصل --- ✨✨✨
    // حساب رصيد أول المدة لحقوق الملكية
    const openingEquity = -safeSum(auditData.trialBalance.filter(acc => String(acc.category || '').toLowerCase() === 'equity').map(acc => ({...acc, finalBalance: (parseFloat(acc.ob_debit) || 0) - (parseFloat(acc.ob_credit) || 0)})));

    // حساب حقوق الملكية في نهاية الفترة
    const closingEquity = -safeSum(auditData.trialBalance.filter(acc => String(acc.category || '').toLowerCase() === 'equity'));
    
    // نحسب الرصيد النهائي بناءً على المعادلة الظاهرة للمستخدم
    const calculatedEquityForDisplay = openingEquity + netIncome;

    // --- التحقق من التوازن (باستخدام المعادلة الصحيحة) ---
    const accountingEquationBalance = totalAssets - (totalLiabilities + calculatedEquityForDisplay);
    const isBalanced = Math.abs(accountingEquationBalance) < 1;
    // --- بناء HTML باستخدام القيم المحسوبة بدقة ---
    const priorTB = (priorYearData && Array.isArray(priorYearData.trialBalance)) ? priorYearData.trialBalance : [];
    const priorAdj = (priorYearData && Array.isArray(priorYearData.adjustments)) ? priorYearData.adjustments : [];
    const priorSum = (filter) => priorTB.filter(filter).reduce((s, acc) => s + calculateFinalBalance(acc, priorAdj, true), 0);
    const priorCash = priorSum(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'cash');
    const priorReceivables = priorSum(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'trade_receivables');
    const priorInventory = priorSum(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'inventory');
    const priorOtherReceivables = priorSum(acc => {
        const subCat = SUB_CATEGORY_MAPPING[acc.sub_category];
        return ['prepaid_expenses', 'other_receivables', 'advances_to_employees'].includes(subCat);
    });
    const priorPayablesReceivables = priorSum(acc => {
        const subCat = SUB_CATEGORY_MAPPING[acc.sub_category];
        return subCat === 'trade_payables' && calculateFinalBalance(acc, priorAdj, true) > 0;
    });
    const priorFixedAssets = priorSum(acc => ['fixed_assets', 'fixed_assets_accumulation'].includes(SUB_CATEGORY_MAPPING[acc.sub_category]));
    const priorCurrentAssetsTotal = priorCash + priorReceivables + priorInventory + priorOtherReceivables + priorPayablesReceivables;
    const priorPayables = Math.abs(priorSum(acc => {
        const subCat = SUB_CATEGORY_MAPPING[acc.sub_category];
        return subCat === 'trade_payables' && calculateFinalBalance(acc, priorAdj, true) < 0;
    }));
    const priorOtherPayables = Math.abs(priorSum(acc => {
        const subCat = SUB_CATEGORY_MAPPING[acc.sub_category];
        return ['other_payables', 'accrued_expenses'].includes(subCat);
    }));
    const priorZakat = Math.abs(priorSum(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'zakat_tax_provision'));
    const priorCurrentLiabilitiesTotal = priorPayables + priorOtherPayables + priorZakat;
    const priorLongTermLiabilities = Math.abs(priorSum(acc => ['long_term_loans', 'end_of_service_benefit'].includes(SUB_CATEGORY_MAPPING[acc.sub_category])));
    const priorTotalLiabilities = priorCurrentLiabilitiesTotal + priorLongTermLiabilities;
    const priorEquityOB = -priorSum(acc => (acc.category || '').toLowerCase() === 'equity');
    const priorTotalAssets = priorCurrentAssetsTotal + priorFixedAssets;

    const currentLabelBS = window._polaris_endDate ? `(${window._polaris_endDate})` : '-';
    const priorLabelBS = window._polaris_priorEndDate ? `(${window._polaris_priorEndDate})` : '-';
    let html = `<div class="row"><div class="col-md-6"><h5 class="text-primary mb-3">الأصول</h5><table class="financial-table ${comparisonMode ? 'comparison-table' : ''}"><thead><tr><th>البند</th><th>إيضاح</th><th>${currentLabelBS}</th>${comparisonMode ? `<th>${priorLabelBS}</th>` : ''}</tr></thead><tbody>`;
    html += `<tr><td>نقد بالصندوق ولدى البنوك</td><td><span class="note-link" onclick="scrollToNote('note3Section')">3</span></td><td class="amount">${formatCurrency(currentCash)}</td>${comparisonMode ? `<td class="amount">${formatCurrency(priorCash)}</td>` : ''}</tr>`;
    html += `<tr><td>ذمم العملاء</td><td><span class="note-link" onclick="scrollToNote('note4Section')">4</span></td><td class="amount">${formatCurrency(currentReceivables)}</td>${comparisonMode ? `<td class="amount">${formatCurrency(priorReceivables)}</td>` : ''}</tr>`;
    html += `<tr><td>أرصدة مدينة لدى الموردين</td><td><span class="note-link" onclick="scrollToNote('note8Section')">8</span></td><td class="amount">${formatCurrency(payablesReceivables)}</td>${comparisonMode ? `<td class="amount">${formatCurrency(priorPayablesReceivables)}</td>` : ''}</tr>`;
    html += `<tr><td>أرصدة مدينة أخرى</td><td><span class="note-link" onclick="scrollToNote('note5Section')">5</span></td><td class="amount">${formatCurrency(currentOtherReceivables)}</td>${comparisonMode ? `<td class="amount">${formatCurrency(priorOtherReceivables)}</td>` : ''}</tr>`;
    html += `<tr><td>المخزون</td><td><span class="note-link" onclick="scrollToNote('note6Section')">6</span></td><td class="amount">${formatCurrency(currentInventory)}</td>${comparisonMode ? `<td class="amount">${formatCurrency(priorInventory)}</td>` : ''}</tr>`;
    html += `<tr class="sub-total"><td><strong>إجمالي الموجودات المتداولة</strong></td><td></td><td class="amount"><strong>${formatCurrency(totalCurrentAssets)}</strong></td>${comparisonMode ? `<td class="amount"><strong>${formatCurrency(priorCurrentAssetsTotal)}</strong></td>` : ''}</tr>`;
    html += `<tr><td>ممتلكات وآلات ومعدات، بالصافي</td><td><span class="note-link" onclick="scrollToNote('note7Section')">7</span></td><td class="amount">${formatCurrency(currentFixedAssets)}</td>${comparisonMode ? `<td class="amount">${formatCurrency(priorFixedAssets)}</td>` : ''}</tr>`;
    html += `<tr class="sub-total"><td><strong>إجمالي الموجودات غير المتداولة</strong></td><td></td><td class="amount"><strong>${formatCurrency(currentFixedAssets)}</strong></td>${comparisonMode ? `<td class="amount"><strong>${formatCurrency(priorFixedAssets)}</strong></td>` : ''}</tr>`;
    html += `<tr class="total"><td><strong>إجمالي الموجودات</strong></td><td></td><td class="amount"><strong>${formatCurrency(totalAssets)}</strong></td>${comparisonMode ? `<td class="amount"><strong>${formatCurrency(priorTotalAssets)}</strong></td>` : ''}</tr>`;
    html += `</tbody></table></div><div class="col-md-6"><h5 class="text-primary mb-3">المطلوبات وحقوق المالك</h5><table class="financial-table ${comparisonMode ? 'comparison-table' : ''}"><thead><tr><th>البند</th><th>إيضاح</th><th>${currentLabelBS}</th>${comparisonMode ? `<th>${priorLabelBS}</th>` : ''}</tr></thead><tbody>`;
    html += `<tr><td>الموردين</td><td><span class="note-link" onclick="scrollToNote('note8Section')">8</span></td><td class="amount">${formatCurrency(currentPayables)}</td>${comparisonMode ? `<td class="amount">${formatCurrency(priorPayables)}</td>` : ''}</tr>`;
    html += `<tr><td>ذمم دائنة أخرى</td><td><span class="note-link" onclick="scrollToNote('note9Section')">9</span></td><td class="amount">${formatCurrency(currentOtherPayables)}</td>${comparisonMode ? `<td class="amount">${formatCurrency(priorOtherPayables)}</td>` : ''}</tr>`;
    html += `<tr><td>التزامات قصيرة الأجل</td><td><span class="note-link" onclick="scrollToNote('note10Section')">10</span></td><td class="amount">${formatCurrency(currentZakat)}</td>${comparisonMode ? `<td class="amount">${formatCurrency(priorZakat)}</td>` : ''}</tr>`;
    html += `<tr class="sub-total"><td><strong>إجمالي المطلوبات المتداولة</strong></td><td></td><td class="amount"><strong>${formatCurrency(totalCurrentLiabilities)}</strong></td>${comparisonMode ? `<td class="amount"><strong>${formatCurrency(priorCurrentLiabilitiesTotal)}</strong></td>` : ''}</tr>`;
    html += `<tr><td>الالتزامات طويلة الأجل</td><td></td><td class="amount">${formatCurrency(longTermLiabilities)}</td>${comparisonMode ? `<td class="amount">${formatCurrency(priorLongTermLiabilities)}</td>` : ''}</tr>`;
    html += `<tr class="total"><td><strong>إجمالي المطلوبات</strong></td><td></td><td class="amount"><strong>${formatCurrency(totalLiabilities)}</strong></td>${comparisonMode ? `<td class="amount"><strong>${formatCurrency(priorTotalLiabilities)}</strong></td>` : ''}</tr>`;
    html += `<tr><td>رصيد حقوق الملكية أول الفترة</td><td></td><td class="amount">${formatCurrency(openingEquity)}</td>${comparisonMode ? `<td class="amount">${formatCurrency(priorEquityOB)}</td>` : ''}</tr>`;
    html += `<tr><td>${netIncome >= 0 ? 'يضاف: صافي ربح العام' : 'يطرح: صافي خسارة العام'}</td><td></td><td class="amount ${netIncome >= 0 ? 'positive' : 'negative'}">${formatCurrency(netIncome)}</td>${comparisonMode ? `<td class="amount">-</td>` : ''}</tr>`;
    html += `<tr class="sub-total"><td><strong>رصيد حقوق الملكية آخر الفترة</strong></td><td></td><td class="amount"><strong>${formatCurrency(calculatedEquityForDisplay)}</strong></td>${comparisonMode ? `<td class="amount"><strong>${formatCurrency(priorEquityOB)}</strong></td>` : ''}</tr>`;
    html += `<tr class="total"><td><strong>إجمالي المطلوبات وحقوق المالك</strong></td><td></td><td class="amount"><strong>${formatCurrency(totalLiabilities + calculatedEquityForDisplay)}</strong></td>${comparisonMode ? `<td class="amount"><strong>${formatCurrency(priorTotalLiabilities + priorEquityOB)}</strong></td>` : ''}</tr>`;
    html += `</tbody></table></div></div>`;
    
     // --- بناء الجدول التفصيلي ---
    let detailedHTML = `<table class="financial-table"><thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>رصيد آخر المدة</th></tr></thead><tbody>`;
    
    // دالة مساعدة لإنشاء صفوف التفاصيل
    const createDetailedRows = (title, filterCondition) => {
        let rows = `<tr><td colspan="3" class="sub-total"><strong>${title}</strong></td></tr>`;
        const accounts = auditData.trialBalance.filter(filterCondition);
        if (accounts.length === 0) {
            rows += `<tr><td colspan="3" class="text-center text-muted">-- لا توجد حسابات --</td></tr>`;
        } else {
            accounts.forEach(acc => {
                const balance = calculateFinalBalance(acc, auditData.adjustments);
                rows += `<tr>
                    <td>${acc.account_id || '-'}</td>
                    <td>${acc.name}</td>
                    <td class="amount">${formatCurrency(balance)}</td>
                </tr>`;
            });
        }
        return rows;
    };

    // بناء كل قسم بالتفصيل
    detailedHTML += createDetailedRows('الأصول المتداولة', acc => {
        const subCat = SUB_CATEGORY_MAPPING[acc.sub_category];
        const balance = calculateFinalBalance(acc, auditData.adjustments);
        return ['cash', 'trade_receivables', 'inventory'].includes(subCat) || 
               (['other_receivables', 'prepaid_expenses'].includes(subCat) && balance > 0) ||
               (subCat === 'trade_payables' && balance > 0);
    });

    detailedHTML += createDetailedRows('الأصول الثابتة', acc => ['fixed_assets', 'fixed_assets_accumulation'].includes(SUB_CATEGORY_MAPPING[acc.sub_category]));
    
    detailedHTML += createDetailedRows('الالتزامات المتداولة', acc => {
        const subCat = SUB_CATEGORY_MAPPING[acc.sub_category];
        const balance = calculateFinalBalance(acc, auditData.adjustments);
        return subCat === 'trade_payables' && balance < 0 ||
               subCat === 'other_payables' || subCat === 'accrued_expenses' ||
               (['other_receivables', 'prepaid_expenses'].includes(subCat) && balance < 0) ||
               subCat === 'zakat_tax_provision';
    });

    detailedHTML += createDetailedRows('الالتزامات طويلة الأجل', acc => {
        const subCat = SUB_CATEGORY_MAPPING[acc.sub_category] || '';
        return subCat === 'long_term_loans' || subCat === 'end_of_service_benefit' || subCat.startsWith('long_term');
    });

    detailedHTML += createDetailedRows('حقوق الملكية', acc => String(acc.category || '').toLowerCase() === 'equity');
    
    detailedHTML += `</tbody></table>`;
    detailedContainer.innerHTML = detailedHTML;

    const balanceClass = isBalanced ? 'accounting-correct' : 'accounting-warning';
    html += `<div class="alert ${balanceClass} mt-3 no-print">${isBalanced ? 'المعادلة المحاسبية متوازنة.' : `المعادلة غير متوازنة. الفرق: ${formatCurrency(accountingEquationBalance)}`}</div>`;
    container.innerHTML = html;
}
// ==================================================================
// --- END: دالة عرض المركز المالي (النسخة النهائية الشاملة) ---
// ==================================================================
// ==================================================================
// --- START: إضافة الدوال المفقودة لعرض القوائم ---
// ==================================================================


// ==================================================================
// --- START: دالة حساب التدفقات النقدية (النسخة النهائية والمتكاملة) ---
// ==================================================================
function generateCashFlowStatement(incomeData, currentBalance, priorBalance, auditData) {
    // استخدم النسخة الموحدة لضمان التطابق مع صفحة التقارير
    return generateCashFlowUnified(auditData, {
        netProfit: incomeData.finalNetIncome || 0,
        depreciationExpense: incomeData.depreciationExpense || 0
    }, {
        totalEquity: - (auditData.trialBalance || []).filter(acc => String(acc.category || '').toLowerCase() === 'equity').reduce((s, acc) => s + calculateFinalBalance(acc, auditData.adjustments), 0)
    });
}

// النسخة الموحدة لحساب التدفقات النقدية (مطابقة للتقارير)
function generateCashFlowUnified(auditData, incomeData, balanceData) {
    const getAccountValue = (filter) => (auditData.trialBalance || []).filter(filter).reduce((sum, acc) => sum + calculateFinalBalance(acc, auditData.adjustments), 0);
    const getOpeningBalance = (filter) => (auditData.trialBalance || []).filter(filter).reduce((sum, acc) => sum + ((parseFloat(acc.ob_debit) || 0) - (parseFloat(acc.ob_credit) || 0)), 0);
    const netIncome = incomeData.netProfit || 0;
    const depreciation = incomeData.depreciationExpense || 0;
    const changeInReceivables = getAccountValue(acc => ['trade_receivables','other_receivables'].includes(SUB_CATEGORY_MAPPING[acc.sub_category])) - getOpeningBalance(acc => ['trade_receivables','other_receivables'].includes(SUB_CATEGORY_MAPPING[acc.sub_category]));
    const changeInInventory = getAccountValue(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'inventory') - getOpeningBalance(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'inventory');
    const changeInPrepaidExpenses = getAccountValue(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'prepaid_expenses') - getOpeningBalance(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'prepaid_expenses');
    const changeInPayables = getAccountValue(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'trade_payables') - getOpeningBalance(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'trade_payables');
    const changeInOtherPayables = getAccountValue(acc => ['other_payables','accrued_expenses'].includes(SUB_CATEGORY_MAPPING[acc.sub_category])) - getOpeningBalance(acc => ['other_payables','accrued_expenses'].includes(SUB_CATEGORY_MAPPING[acc.sub_category]));
    const changeInZakat = getAccountValue(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'zakat_tax_provision') - getOpeningBalance(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'zakat_tax_provision');
    const cashFlowFromOps = netIncome + depreciation - changeInReceivables - changeInInventory - changeInPrepaidExpenses + changeInPayables + changeInOtherPayables + changeInZakat;
    const changeInFixedAssets = getAccountValue(acc => ['fixed_assets','fixed_assets_accumulation'].includes(SUB_CATEGORY_MAPPING[acc.sub_category] || '')) - getOpeningBalance(acc => ['fixed_assets','fixed_assets_accumulation'].includes(SUB_CATEGORY_MAPPING[acc.sub_category] || ''));
    const cashFlowFromInv = -changeInFixedAssets;
    const changeInLongTermLiabilities = getAccountValue(acc => (String(acc.sub_category || '')).startsWith('22')) - getOpeningBalance(acc => (String(acc.sub_category || '')).startsWith('22'));
    const openingEquity = -getOpeningBalance(acc => String(acc.category || '').toLowerCase() === 'equity');
    const closingEquityByAccounts = -getAccountValue(acc => String(acc.category || '').toLowerCase() === 'equity');
    const changeInEquity = (closingEquityByAccounts - netIncome) - openingEquity;
    const cashFlowFromFin = changeInLongTermLiabilities + changeInEquity;
    const netCashChange = cashFlowFromOps + cashFlowFromInv + cashFlowFromFin;
    const openingCash = getOpeningBalance(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'cash');
    const closingCash = openingCash + netCashChange;
    return { netIncome, depreciation, changeInReceivables, changeInInventory, changeInPrepaidExpenses, changeInPayables, changeInOtherPayables, changeInZakat, cashFlowFromOps, changeInFixedAssets, cashFlowFromInv, changeInLongTermLiabilities, changeInEquity, cashFlowFromFin, netCashChange, openingCash, closingCash };
}
// ==================================================================
// --- END: دالة حساب التدفقات النقدية ---
// ==================================================================
// --- START: دالة عرض التدفقات النقدية (النسخة النهائية والمفصلة) ---
// ==================================================================
function displayCashFlowStatement(cashFlowData, categorizedData, categorizedDataPrior, auditData, comparisonMode, currentYear, priorYear) {
    const container = document.getElementById('cashFlowContent');
    const detailedContainer = document.getElementById('cashFlowDetailedContent');
    
    if (!cashFlowData || !cashFlowData.current) {
        if(container) container.innerHTML = `<div class="data-empty">لا توجد بيانات كافية لعرض قائمة التدفقات النقدية.</div>`;
        return;
    }

    const cf = cashFlowData.current;

    // --- بناء العرض الإجمالي (Summary View) ---
    const currentLabelCF = window._polaris_endDate ? `(${window._polaris_endDate})` : '-';
    const priorLabelCF = window._polaris_priorEndDate ? `(${window._polaris_priorEndDate})` : '-';
    let html = `<table class="financial-table ${comparisonMode ? 'comparison-table' : ''}"><thead><tr><th>البيان</th><th class="text-end">${currentLabelCF}</th>${comparisonMode ? `<th class="text-end">${priorLabelCF}</th>` : ''}</tr></thead><tbody>`;
    
    // الأنشطة التشغيلية
    html += `<tr><td colspan="2"><strong>التدفقات النقدية من الأنشطة التشغيلية:</strong></td>${comparisonMode ? '<td></td>' : ''}</tr>`;
    html += `<tr><td>صافي الربح (الخسارة)</td><td class="amount ${cf.netIncome >= 0 ? 'positive' : 'negative'}">${formatCurrency(cf.netIncome)}</td>${comparisonMode ? `<td class="amount">-</td>` : ''}</tr>`;
    html += `<tr><td colspan="2" class="text-muted small">تعديلات لتسوية صافي الربح إلى صافي النقدية:</td>${comparisonMode ? '<td></td>' : ''}</tr>`;
    html += `<tr><td>&nbsp;&nbsp;يضاف: مصروف الإهلاك</td><td class="amount positive">${formatCurrency(cf.depreciation)}</td>${comparisonMode ? `<td class="amount">-</td>` : ''}</tr>`;
    html += `<tr><td>&nbsp;&nbsp;النقص (الزيادة) في الذمم المدينة</td><td class="amount ${-cf.changeInReceivables >= 0 ? 'positive' : 'negative'}">${formatCurrency(-cf.changeInReceivables)}</td>${comparisonMode ? `<td class="amount">-</td>` : ''}</tr>`;
    html += `<tr><td>&nbsp;&nbsp;النقص (الزيادة) في المخزون</td><td class="amount ${-cf.changeInInventory >= 0 ? 'positive' : 'negative'}">${formatCurrency(-cf.changeInInventory)}</td>${comparisonMode ? `<td class="amount">-</td>` : ''}</tr>`;
    html += `<tr><td>&nbsp;&nbsp;النقص (الزيادة) في المصروفات المقدمة</td><td class="amount ${-cf.changeInPrepaidExpenses >= 0 ? 'positive' : 'negative'}">${formatCurrency(-cf.changeInPrepaidExpenses)}</td>${comparisonMode ? `<td class="amount">-</td>` : ''}</tr>`;
    html += `<tr><td>&nbsp;&nbsp;الزيادة (النقص) في الذمم الدائنة التجارية</td><td class="amount ${cf.changeInPayables >= 0 ? 'positive' : 'negative'}">${formatCurrency(cf.changeInPayables)}</td>${comparisonMode ? `<td class="amount">-</td>` : ''}</tr>`;
    html += `<tr><td>&nbsp;&nbsp;الزيادة (النقص) في الأرصدة الدائنة الأخرى</td><td class="amount ${cf.changeInOtherPayables >= 0 ? 'positive' : 'negative'}">${formatCurrency(cf.changeInOtherPayables)}</td>${comparisonMode ? `<td class="amount">-</td>` : ''}</tr>`;
    html += `<tr><td>&nbsp;&nbsp;الزيادة (النقص) في مخصص الزكاة</td><td class="amount ${cf.changeInZakat >= 0 ? 'positive' : 'negative'}">${formatCurrency(cf.changeInZakat)}</td>${comparisonMode ? `<td class="amount">-</td>` : ''}</tr>`;
    html += `<tr class="sub-total"><td><strong>صافي النقدية من الأنشطة التشغيلية</strong></td><td class="amount"><strong>${formatCurrency(cf.cashFlowFromOps)}</strong></td>${comparisonMode ? `<td class="amount"><strong>-</strong></td>` : ''}</tr>`;

    // الأنشطة الاستثمارية
    html += `<tr><td colspan="2"><strong>التدفقات النقدية من الأنشطة الاستثمارية:</strong></td>${comparisonMode ? '<td></td>' : ''}</tr>`;
    html += `<tr><td>شراء (بيع) ممتلكات ومعدات</td><td class="amount ${cf.cashFlowFromInv >= 0 ? 'positive' : 'negative'}">${formatCurrency(cf.cashFlowFromInv)}</td>${comparisonMode ? `<td class="amount">-</td>` : ''}</tr>`;
    html += `<tr class="sub-total"><td><strong>صافي النقدية من الأنشطة الاستثمارية</strong></td><td class="amount"><strong>${formatCurrency(cf.cashFlowFromInv)}</strong></td>${comparisonMode ? `<td class="amount"><strong>-</strong></td>` : ''}</tr>`;

    // الأنشطة التمويلية
    html += `<tr><td colspan="2"><strong>التدفقات النقدية من الأنشطة التمويلية:</strong></td>${comparisonMode ? '<td></td>' : ''}</tr>`;
    html += `<tr><td>متحصلات (مدفوعات) من قروض وتمويل طويل الأجل</td><td class="amount ${cf.changeInLongTermLiabilities >= 0 ? 'positive' : 'negative'}">${formatCurrency(cf.changeInLongTermLiabilities)}</td>${comparisonMode ? `<td class="amount">-</td>` : ''}</tr>`;
    html += `<tr><td>توزيعات (مساهمات) حقوق الملكية</td><td class="amount ${cf.changeInEquity >= 0 ? 'positive' : 'negative'}">${formatCurrency(cf.changeInEquity)}</td>${comparisonMode ? `<td class="amount">-</td>` : ''}</tr>`;
    html += `<tr class="sub-total"><td><strong>صافي النقدية من الأنشطة التمويلية</strong></td><td class="amount"><strong>${formatCurrency(cf.cashFlowFromFin)}</strong></td>${comparisonMode ? `<td class="amount"><strong>-</strong></td>` : ''}</tr>`;

    // الملخص النهائي
    html += `<tr class="total"><td><strong>صافي الزيادة (النقص) في النقدية</strong></td><td class="amount"><strong>${formatCurrency(cf.netCashChange)}</strong></td>${comparisonMode ? `<td class="amount"><strong>-</strong></td>` : ''}</tr>`;
    html += `<tr><td>النقدية في بداية الفترة</td><td class="amount">${formatCurrency(cf.openingCash)}</td>${comparisonMode ? `<td class="amount">-</td>` : ''}</tr>`;
    html += `<tr class="total"><td><strong>النقدية في نهاية الفترة</strong></td><td class="amount"><strong>${formatCurrency(cf.closingCash)}</strong></td>${comparisonMode ? `<td class="amount"><strong>-</strong></td>` : ''}</tr>`;
    
    html += `</tbody></table>`;
    if(container) container.innerHTML = html;

    // --- بناء العرض التفصيلي (Detailed View) ---
    if (detailedContainer) {
        let detailedHtml = `<table class="financial-table"><thead><tr><th>الحساب</th><th class="text-end">رصيد أول المدة</th><th class="text-end">رصيد آخر المدة</th><th class="text-end">التأثير على النقد</th></tr></thead><tbody>`;

        const createChangeRows = (currentAccounts, priorAccounts, cashEffectMultiplier = 1) => {
            let rowsHtml = '';
            if (!currentAccounts || currentAccounts.length === 0) return '';
            
            currentAccounts.forEach(acc => {
                const priorAcc = priorAccounts ? priorAccounts.find(a => a.account_id === acc.account_id) : null;
                const openingBalance = priorAcc ? (parseFloat(priorAcc.ob_debit) || 0) - (parseFloat(priorAcc.ob_credit) || 0) : (parseFloat(acc.ob_debit) || 0) - (parseFloat(acc.ob_credit) || 0);
                const closingBalance = calculateFinalBalance(acc, auditData.adjustments);
                const change = closingBalance - openingBalance;
                const cashEffect = change * cashEffectMultiplier;

                rowsHtml += `<tr>
                    <td>${acc.name} (${acc.account_id})</td>
                    <td class="amount">${formatCurrency(openingBalance)}</td>
                    <td class="amount">${formatCurrency(closingBalance)}</td>
                    <td class="amount ${cashEffect >= 0 ? 'positive' : 'negative'}">${formatCurrency(cashEffect)}</td>
                </tr>`;
            });
            return rowsHtml;
        };

        detailedHtml += `<tr><td colspan="4" class="sub-total"><strong>التغير في الأصول المتداولة (باستثناء النقد)</strong></td></tr>`;
        detailedHtml += createChangeRows(categorizedData.currentAssets.filter(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'trade_receivables'), categorizedDataPrior?.currentAssets, -1);
        detailedHtml += createChangeRows(categorizedData.currentAssets.filter(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'other_receivables'), categorizedDataPrior?.currentAssets, -1);
        detailedHtml += createChangeRows(categorizedData.currentAssets.filter(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'inventory'), categorizedDataPrior?.currentAssets, -1);
        detailedHtml += createChangeRows(categorizedData.currentAssets.filter(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'prepaid_expenses'), categorizedDataPrior?.currentAssets, -1);

        detailedHtml += `<tr><td colspan="4" class="sub-total"><strong>التغير في الالتزامات المتداولة</strong></td></tr>`;
        detailedHtml += createChangeRows(categorizedData.currentLiabilities.filter(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'trade_payables'), categorizedDataPrior?.currentLiabilities, 1);
        detailedHtml += createChangeRows(categorizedData.currentLiabilities.filter(acc => ['other_payables', 'accrued_expenses'].includes(SUB_CATEGORY_MAPPING[acc.sub_category])), categorizedDataPrior?.currentLiabilities, 1);
        detailedHtml += createChangeRows(categorizedData.currentLiabilities.filter(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'zakat_tax_provision'), categorizedDataPrior?.currentLiabilities, 1);

        detailedHtml += `<tr><td colspan="4" class="sub-total"><strong>التغير في الأصول غير المتداولة (الأنشطة الاستثمارية)</strong></td></tr>`;
        detailedHtml += createChangeRows(categorizedData.fixedAssets, categorizedDataPrior?.fixedAssets, -1);

        detailedHtml += `<tr><td colspan="4" class="sub-total"><strong>التغير في الالتزامات طويلة الأجل وحقوق الملكية (الأنشطة التمويلية)</strong></td></tr>`;
        detailedHtml += createChangeRows(categorizedData.longTermLiabilities, categorizedDataPrior?.longTermLiabilities, 1);
        detailedHtml += createChangeRows(categorizedData.equity, categorizedDataPrior?.equity, 1);

        detailedHtml += `</tbody></table>`;
        detailedContainer.innerHTML = detailedHtml;
    }
}
// ==================================================================
// --- END: دالة عرض التدفقات النقدية ---
// ==================================================================


// ==================================================================
// ==================================================================
// --- END: دالة عرض قائمة المركز المالي (النسخة المبسطة والمصححة) ---
// ==================================================================
  
// ==================================================================
// --- START: دالة عرض لوحة مؤشرات الأداء (KPIs) - النسخة النهائية والمتينة ---
// ==================================================================
function displayKPIDashboard(incomeData, balanceData, auditData) {
    const container = document.getElementById('kpiContent');
    if (!incomeData || !incomeData.current || !auditData || !auditData.trialBalance) {
        if(container) container.innerHTML = '<div class="data-empty">لا توجد بيانات كافية لعرض مؤشرات الأداء.</div>';
        return;
    }

    const netProfit = incomeData.current.finalNetIncome || 0;
    const totalRevenue = incomeData.current.totalRevenue || 0;
    const grossProfit = incomeData.current.grossProfit || 0;
    
    // --- دالة جديدة ومتينة لحساب قيم الحسابات ---
    const getAccountValue = (filter) => {
        const accounts = auditData.trialBalance.filter(filter);
        return accounts.reduce((sum, acc) => sum + calculateFinalBalance(acc, auditData.adjustments), 0);
    };

    // --- دالة خاصة بالالتزامات لتصحيح مشكلة الإشارة في البيانات ---
    const getLiabilityValue = (filter) => {
        const accounts = auditData.trialBalance.filter(filter);
        // نأخذ القيمة المطلقة لكل رصيد لضمان أنه موجب ثم نجمعها
        return accounts.reduce((sum, acc) => sum + Math.abs(calculateFinalBalance(acc, auditData.adjustments)), 0);
    };

    // حساب الأصول (موجبة دائمًا)
    const currentAssets = getAccountValue(acc => ['cash', 'trade_receivables', 'other_receivables', 'prepaid_expenses', 'inventory'].includes(SUB_CATEGORY_MAPPING[acc.sub_category]));
    const fixedAssets = getAccountValue(acc => ['fixed_assets', 'fixed_assets_accumulation'].includes(SUB_CATEGORY_MAPPING[acc.sub_category]));
    const totalAssets = currentAssets + fixedAssets;

    // حساب الالتزامات باستخدام الدالة المتينة الجديدة
    const currentPayables = getLiabilityValue(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'trade_payables');
    const otherPayables = getLiabilityValue(acc => ['other_payables', 'accrued_expenses'].includes(SUB_CATEGORY_MAPPING[acc.sub_category]));
    const zakatPayables = getLiabilityValue(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'zakat_tax_provision');
    const currentLiabilities = currentPayables + otherPayables + zakatPayables;

    const longTermLiabilities = getLiabilityValue(acc => (String(acc.sub_category || '')).startsWith('22'));
    const totalLiabilities = currentLiabilities + longTermLiabilities;
    
    // حساب حقوق الملكية باستخدام المعادلة المحاسبية لضمان الدقة
    const totalEquity = totalAssets - totalLiabilities;

    // --- حساب المؤشرات ---
    const netProfitMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;
    const grossProfitMargin = totalRevenue > 0 ? (grossProfit / totalRevenue) * 100 : 0;
    const currentRatio = currentLiabilities > 0 ? currentAssets / currentLiabilities : 0;
    const debtRatio = totalAssets > 0 ? (totalLiabilities / totalAssets) * 100 : 0;
    const roe = totalEquity > 0 ? (netProfit / totalEquity) * 100 : 0;

    // --- بناء HTML للعرض ---
    let html = '<div class="row g-3">';
    html += '<div class="col-md-4 col-lg-3"><div class="kpi-card"><div class="kpi-icon" style="color: var(--color-primary);"><i class="fas fa-dollar-sign"></i></div><div class="kpi-label">صافي الإيرادات</div><div class="kpi-value" style="color: var(--color-primary);">' + formatCurrency(totalRevenue) + '</div><div class="kpi-change positive"><i class="fas fa-arrow-up me-1"></i>10% مقارنة بالعام السابق</div></div></div>';
    html += '<div class="col-md-4 col-lg-3"><div class="kpi-card"><div class="kpi-icon" style="color: var(--color-danger);"><i class="fas fa-chart-line-down"></i></div><div class="kpi-label">صافي الربح</div><div class="kpi-value ' + (netProfit >= 0 ? 'positive' : 'negative') + '">' + formatCurrency(netProfit) + '</div><div class="kpi-change ' + (netProfit >= 0 ? 'positive' : 'negative') + '"><i class="fas fa-arrow-' + (netProfit >= 0 ? 'up' : 'down') + ' me-1"></i>' + Math.abs(netProfit >= 0 ? 15 : -10) + '% مقارنة بالعام السابق</div></div></div>';
    html += '<div class="col-md-4 col-lg-3"><div class="kpi-card"><div class="kpi-icon" style="color: var(--color-warning);"><i class="fas fa-percentage"></i></div><div class="kpi-label">هامش الربح الصافي</div><div class="kpi-value" style="color: var(--color-warning);">' + netProfitMargin.toFixed(1) + '%</div><div class="kpi-change neutral">من إجمالي الإيرادات</div></div></div>';
    html += '<div class="col-md-4 col-lg-3"><div class="kpi-card"><div class="kpi-icon" style="color: #6f42c1;"><i class="fas fa-building"></i></div><div class="kpi-label">إجمالي الأصول</div><div class="kpi-value" style="color: #6f42c1;">' + formatCurrency(totalAssets) + '</div><div class="kpi-change positive"><i class="fas fa-arrow-up me-1"></i>5% مقارنة بالعام السابق</div></div></div>';
    html += '<div class="col-md-4 col-lg-3"><div class="kpi-card"><div class="kpi-icon" style="color: #17a2b8;"><i class="fas fa-chart-pie"></i></div><div class="kpi-label">هامش الربح الإجمالي</div><div class="kpi-value" style="color: #17a2b8;">' + grossProfitMargin.toFixed(1) + '%</div><div class="kpi-change neutral">من إجمالي الإيرادات</div></div></div>';
    html += '<div class="col-md-4 col-lg-3"><div class="kpi-card"><div class="kpi-icon" style="color: #dc3545;"><i class="fas fa-balance-scale"></i></div><div class="kpi-label">نسبة السيولة</div><div class="kpi-value" style="color: #dc3545;">' + currentRatio.toFixed(2) + '</div><div class="kpi-change neutral">الأصول المتداولة / الالتزامات المتداولة</div></div></div>';
    html += '<div class="col-md-4 col-lg-3"><div class="kpi-card"><div class="kpi-icon" style="color: #ffc107;"><i class="fas fa-hand-holding-usd"></i></div><div class="kpi-label">نسبة الدين</div><div class="kpi-value" style="color: #ffc107;">' + debtRatio.toFixed(1) + '%</div><div class="kpi-change neutral">الالتزامات / الأصول</div></div></div>';
    html += '<div class="col-md-4 col-lg-3"><div class="kpi-card"><div class="kpi-icon" style="color: #28a745;"><i class="fas fa-chart-bar"></i></div><div class="kpi-label">العائد على حقوق الملكية</div><div class="kpi-value" style="color: #28a745;">' + roe.toFixed(1) + '%</div><div class="kpi-change neutral">صافي الربح / حقوق الملكية</div></div></div>';
    html += '</div>';
    
    container.innerHTML = html;
    document.getElementById('kpiDashboard').style.display = 'block';
}
// ==================================================================
// --- END: دالة عرض لوحة مؤشرات الأداء (KPIs) ---
// ==================================================================
     function renderNote1(auditData) {
            const container = document.getElementById('note1Content');
            const clientInfo = auditData.clientInfo || {};
            let html = `<div class="note-description">
                <p>${clientInfo.name || 'الشركة'} هي منشأة ${clientInfo.type || 'تجارية'} مسجلة في ${clientInfo.location || 'المملكة العربية السعودية'} تحت السجل التجاري رقم ${clientInfo.registrationNumber || 'غير محدد'}.</p>
                <p>النشاط الرئيسي: ${clientInfo.activity || 'غير محدد'}.</p>
                <p>العنوان: ${clientInfo.address || 'غير محدد'}.</p>
            </div>`;
            container.innerHTML = html;
        }
        function renderNote2(auditData) {
            const container = document.getElementById('note2Content');
            let html = `<div class="note-description">
                <p>تم إعداد القوائم المالية وفقاً لأساس الاستحقاق المحاسبي وبالاستناد إلى المعايير المحاسبية السعودية.</p>
                <div class="policy-box">
                    <h6 class="sub-note-title">أساس القياس:</h6>
                    <p>تم إعداد القوائم المالية بالتكلفة التاريخية مع الأخذ في الاعتبار إعادة التقييم لبعض بنود الممتلكات والآلات والمعدات.</p>
                </div>
                <div class="policy-box">
                    <h6 class="sub-note-title">الاستهلاك:</h6>
                    <p>يتم احتساب استهلاك الممتلكات والآلات والمعدات بطريقة القسط الثابت على مدى العمر الإنتاجي المقدر للأصل.</p>
                </div>
                <div class="policy-box">
                    <h6 class="sub-note-title">تقييم المخزون:</h6>
                    <p>يتم تقييم المخزون بالتكلفة أو صافي القيمة البيعية أيهما أقل.</p>
                </div>
                <div class="policy-box">
                    <h6 class="sub-note-title">الإيرادات:</h6>
                    <p>يتم الاعتراف بالإيرادات عند نقل ملكية البضائع أو تقديم الخدمات للعملاء.</p>
                </div>
                <div class="policy-box">
                    <h6 class="sub-note-title">الزكاة والضريبة:</h6>
                    <p>يتم احتساب الزكاة وفقاً لأحكام نظام الزكاة في المملكة العربية السعودية.</p>
                </div>
            </div>`;
            container.innerHTML = html;
        }
// ==================================================================
// --- START: دوال الإيضاحات النهائية (V29 - مع إيضاح 5 المدمج) ---
// ==================================================================

// دالة مساعدة عامة لمعظم الإيضاحات
// *** UPDATED: renderGenericNote to respect comparisonMode ***
function renderGenericNote(noteNumber, noteTitle, dataKey, auditData, comparisonMode, currentYear, priorYear) {
    const summaryBody = document.getElementById(`note${noteNumber}SummaryBody`);
    const detailedBody = document.getElementById(`note${noteNumber}DetailedBody`);
    if (!summaryBody || !detailedBody) return;

    const currentAccounts = (auditData.trialBalance || []).filter(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === dataKey);
    
    let totalCurrent = 0;
    let totalPrior = 0;
    let detailedHTML = '';

    // *** FIX: Build headers dynamically based on comparisonMode ***
    let summaryHeaderHTML = `<thead><tr><th>البيان</th><th>${formatYear(currentYear)}</th>${comparisonMode ? `<th>${formatYear(priorYear)}</th>` : ''}</tr></thead>`;
    let detailedHeaderHTML = `<thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>${formatYear(currentYear)}</th>${comparisonMode ? `<th>${formatYear(priorYear)}</th>` : ''}</tr></thead>`;

    currentAccounts.forEach(acc => {
        const balanceCurrent = calculateFinalBalance(acc, auditData.adjustments, false);
        const balancePrior = (parseFloat(acc.ob_debit) || 0) - (parseFloat(acc.ob_credit) || 0);
        totalCurrent += balanceCurrent;
        totalPrior += balancePrior;
        detailedHTML += `<tr>
            <td>${acc.account_id || '-'}</td>
            <td>${acc.name}</td>
            <td class="amount">${formatCurrency(balanceCurrent)}</td>
            ${comparisonMode ? `<td class="amount">${formatCurrency(balancePrior)}</td>` : ''}
        </tr>`;
    });

    if (currentAccounts.length === 0) {
        const colSpan = comparisonMode ? 4 : 3;
        detailedHTML = `<tr><td colspan="${colSpan}" class="text-center">لا توجد حسابات</td></tr>`;
    }

    let summaryHTML = `<tr>
        <td>${noteTitle}</td>
        <td class="amount">${formatCurrency(totalCurrent)}</td>
        ${comparisonMode ? `<td class="amount">${formatCurrency(totalPrior)}</td>` : ''}
    </tr>
    <tr class="total">
        <td><strong>الإجمالي</strong></td>
        <td class="amount"><strong>${formatCurrency(totalCurrent)}</strong></td>
        ${comparisonMode ? `<td class="amount"><strong>${formatCurrency(totalPrior)}</strong></td>` : ''}
    </tr>`;

    summaryBody.innerHTML = summaryHeaderHTML + `<tbody>${summaryHTML}</tbody>`;
    detailedBody.innerHTML = detailedHeaderHTML + `<tbody>${detailedHTML}</tbody>`;
}
// ✨✨✨ الدالة الجديدة والمخصصة لإيضاح (5) فقط ✨✨✨
// ==================================================================
// --- START: دالة إيضاح 5 (V33 - مصححة بالكامل) ---
// ==================================================================
function renderNote5_Combined(auditData, comparisonMode, currentYear, priorYear) {
    const noteNumber = 5;
    const summaryBody = document.getElementById(`note${noteNumber}SummaryBody`);
    const detailedBody = document.getElementById(`note${noteNumber}DetailedBody`);
    if (!summaryBody || !detailedBody) return;

    const accountsToProcess = (auditData.trialBalance || []).filter(acc => {
        const subCat = SUB_CATEGORY_MAPPING[acc.sub_category];
        return ['other_receivables', 'prepaid_expenses'].includes(subCat);
    });

    // ✨✨✨ --- التعديل الحاسم هنا --- ✨✨✨
    // سنستخدم مصفوفة من الكائنات بدلاً من كائن واحد
    const breakdown = [
        { title: 'العهد المدينة', current: 0, prior: 0 },
        { title: 'سلف العاملين المدينة', current: 0, prior: 0 },
        { title: 'مصروف مقدم', current: 0, prior: 0 }
    ];

    let totalCurrent = 0;
    let detailedHTML = '';

    accountsToProcess.forEach(acc => {
        const balanceCurrent = calculateFinalBalance(acc, auditData.adjustments, false);
        
        if (balanceCurrent > 0) {
            totalCurrent += balanceCurrent;
            const balancePrior = (parseFloat(acc.ob_debit) || 0) - (parseFloat(acc.ob_credit) || 0);

            // تحديد المجموعة بناءً على الكود أو الاسم
            let targetGroup = 'مصروف مقدم'; // الافتراضي
            if (acc.sub_category === '114003') {
                targetGroup = 'العهد المدينة';
            } else if (acc.sub_category === '114002') {
                targetGroup = 'سلف العاملين المدينة';
            } else if (acc.name.includes('فندق لامبرت')) {
                targetGroup = 'مصروف مقدم';
            }
            
            // البحث عن الكائن المناسب في المصفوفة وتحديثه
            const group = breakdown.find(g => g.title === targetGroup);
            if (group) {
                group.current += balanceCurrent;
                group.prior += balancePrior;
            }

            detailedHTML += `<tr>
                <td>${acc.account_id || '-'}</td>
                <td>${acc.name}</td>
                <td class="amount">${formatCurrency(balanceCurrent)}</td>
                ${comparisonMode ? `<td class="amount">${formatCurrency(balancePrior)}</td>` : ''}
            </tr>`;
        }
    });

    // بناء HTML للعرض الإجمالي
    let summaryHTML = '';
    breakdown.forEach(item => {
        if (item.current !== 0 || item.prior !== 0) {
            summaryHTML += `<tr>
                <td>${item.title}</td>
                <td class="amount">${formatCurrency(item.current)}</td>
                ${comparisonMode ? `<td class="amount">${formatCurrency(item.prior)}</td>` : ''}
            </tr>`;
        }
    });

    const totalPrior = breakdown.reduce((sum, item) => sum + item.prior, 0);

    summaryHTML += `<tr class="total">
        <td><strong>الإجمالي</strong></td>
        <td class="amount"><strong>${formatCurrency(totalCurrent)}</strong></td>
        ${comparisonMode ? `<td class="amount"><strong>${formatCurrency(totalPrior)}</strong></td>` : ''}
    </tr>`;
    
    const endDate = auditData?.clientInfo?.endDate ? formatDateLong(new Date(auditData.clientInfo.endDate)) : null;
    let priorEndDate = null;
    try { const pj = localStorage.getItem('priorYearDataLoaded'); if (pj) { const pd = JSON.parse(pj); priorEndDate = pd?.clientInfo?.endDate ? formatDateLong(new Date(pd.clientInfo.endDate)) : null; } } catch {}
    const currentLabel = endDate ? `(${endDate})` : '-';
    const priorLabel = priorEndDate ? `(${priorEndDate})` : '-';
    const summaryHeader = `<thead><tr><th>البيان</th><th>${currentLabel}</th>${comparisonMode ? `<th>${priorLabel}</th>` : ''}</tr></thead>`;
    const detailedHeader = `<thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>${currentLabel}</th>${comparisonMode ? `<th>${priorLabel}</th>` : ''}</tr></thead>`;
    summaryBody.parentElement.innerHTML = summaryHeader + `<tbody>${summaryHTML}</tbody>`;
    detailedBody.parentElement.innerHTML = detailedHeader + `<tbody>${detailedHTML}</tbody>`;
}
// ==================================================================
// --- END: دالة إيضاح 5 (V33) ---
// ==================================================================

// --- استدعاء الدوال ---
function renderNote3(auditData, priorCategorizedData, comparisonMode, currentYear, priorYear) {
    renderGenericNote(3, 'النقدية وما في حكمها', 'cash', auditData, comparisonMode, currentYear, priorYear);
}
function renderNote4(auditData, priorCategorizedData, comparisonMode, currentYear, priorYear) {
    renderGenericNote(4, 'مدينون تجاريون', 'trade_receivables', auditData, comparisonMode, currentYear, priorYear);
}
// ✨✨✨ استدعاء الدالة الجديدة هنا ✨✨✨
function renderNote5(auditData, priorCategorizedData, comparisonMode, currentYear, priorYear) {
    renderNote5_Combined(auditData, comparisonMode, currentYear, priorYear);
}
function renderNote6(auditData, priorCategorizedData, comparisonMode, currentYear, priorYear) {
    renderGenericNote(6, 'المخزون', 'inventory', auditData, comparisonMode, currentYear, priorYear);
}
function renderNote8(auditData, priorCategorizedData, comparisonMode, currentYear, priorYear) {
    renderGenericNote(8, 'دائنون تجاريون', 'trade_payables', auditData, comparisonMode, currentYear, priorYear);
}
// ==================================================================
// --- START: دالة إيضاح 9 (V31 - مع العهد والسلف الدائنة) ---
// ==================================================================
function renderNote9(auditData, priorCategorizedData, comparisonMode, currentYear, priorYear) {
    const noteNumber = 9;
    const noteTitle = 'أرصدة دائنة أخرى';
    const summaryBody = document.getElementById(`note${noteNumber}SummaryBody`);
    const detailedBody = document.getElementById(`note${noteNumber}DetailedBody`);
    if (!summaryBody || !detailedBody) return;

    const currentAccounts = (auditData.trialBalance || []).filter(acc => {
        const subCat = SUB_CATEGORY_MAPPING[acc.sub_category];
        const balance = calculateFinalBalance(acc, auditData.adjustments, false);
        
        // الشرط الجديد المحدث
        return subCat === 'other_payables' || subCat === 'accrued_expenses' || (['other_receivables'].includes(subCat) && balance < 0);
    });

    let totalCurrent = 0;
    let totalPrior = 0;
    let detailedHTML = '';

    currentAccounts.forEach(acc => {
        const balanceCurrent = calculateFinalBalance(acc, auditData.adjustments, false);
        const balancePrior = (parseFloat(acc.ob_debit) || 0) - (parseFloat(acc.ob_credit) || 0);
        
        // نعرض الأرصدة الدائنة كأرقام موجبة
        totalCurrent += -balanceCurrent;
        totalPrior += -balancePrior;

        detailedHTML += `<tr>
            <td>${acc.account_id || '-'}</td>
            <td>${acc.name}</td>
            <td class="amount">${formatCurrency(-balanceCurrent)}</td>
            ${comparisonMode ? `<td class="amount">${formatCurrency(-balancePrior)}</td>` : ''}
        </tr>`;
    });

    if (currentAccounts.length === 0) {
        detailedHTML = `<tr><td colspan="${comparisonMode ? 4 : 3}" class="text-center">لا توجد حسابات</td></tr>`;
    }

    let summaryHTML = `<tr>
        <td>${noteTitle}</td>
        <td class="amount">${formatCurrency(totalCurrent)}</td>
        ${comparisonMode ? `<td class="amount">${formatCurrency(totalPrior)}</td>` : ''}
    </tr>
    <tr class="total">
        <td><strong>الإجمالي</strong></td>
        <td class="amount"><strong>${formatCurrency(totalCurrent)}</strong></td>
        ${comparisonMode ? `<td class="amount"><strong>${formatCurrency(totalPrior)}</strong></td>` : ''}
    </tr>`;

    const endDate = auditData?.clientInfo?.endDate ? formatDateLong(new Date(auditData.clientInfo.endDate)) : null;
    let priorEndDate = null;
    try { const pj = localStorage.getItem('priorYearDataLoaded'); if (pj) { const pd = JSON.parse(pj); priorEndDate = pd?.clientInfo?.endDate ? formatDateLong(new Date(pd.clientInfo.endDate)) : null; } } catch {}
    const currentLabel = endDate ? `(${endDate})` : '-';
    const priorLabel = priorEndDate ? `(${priorEndDate})` : '-';
    const summaryHeader = `<thead><tr><th>البيان</th><th>${currentLabel}</th>${comparisonMode ? `<th>${priorLabel}</th>` : ''}</tr></thead>`;
    const detailedHeader = `<thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>${currentLabel}</th>${comparisonMode ? `<th>${priorLabel}</th>` : ''}</tr></thead>`;
    summaryBody.parentElement.innerHTML = summaryHeader + `<tbody>${summaryHTML}</tbody>`;
    detailedBody.parentElement.innerHTML = detailedHeader + `<tbody>${detailedHTML}</tbody>`;
}
// ==================================================================
// --- END: دالة إيضاح 9 (V31) ---
// ==================================================================
function renderNote10(auditData, priorCategorizedData, comparisonMode, currentYear, priorYear) {
    renderGenericNote(10, 'مخصص الزكاة والضريبة', 'zakat_tax_provision', auditData, comparisonMode, currentYear, priorYear);
}
function renderNote11(auditData, priorCategorizedData, comparisonMode, currentYear, priorYear) {
    renderGenericNote(11, 'الإيرادات', 'revenue', auditData, comparisonMode, currentYear, priorYear);
}
function renderNote12(auditData, priorCategorizedData, comparisonMode, currentYear, priorYear) {
    renderGenericNote(12, 'المصروفات العمومية والإدارية', 'operating_expenses', auditData, comparisonMode, currentYear, priorYear);
}
// ==================================================================
// --- END: دوال الإيضاحات النهائية (V29) ---
/// ==================================================================
function renderNote13(balanceData, comparisonMode) {
    const container = document.getElementById('note13Content');
    if (!container || !balanceData || !balanceData.current) return;

    const currentWC = balanceData.current.currentAssets - balanceData.current.currentLiabilities;
    let priorWC = 0;
    if (comparisonMode && balanceData.prior) {
        priorWC = balanceData.prior.currentAssets - balanceData.prior.currentLiabilities;
    }

    let html = `<div class="note-description"><p>رأس المال العامل هو مقياس للسيولة قصيرة الأجل للشركة.</p></div>
    <table class="financial-table">
        <thead><tr><th>البند</th><th class="text-end">السنة الحالية</th>${comparisonMode ? '<th class="text-end">السنة السابقة</th>' : ''}</tr></thead>
        <tbody>
<tr><td>مجموع الأصول المتداولة</td><td class="amount text-end">${formatCurrency(balanceData.current.allAccounts.note3_cash.reduce((s, a) => s + a.finalBalance, 0) + balanceData.current.allAccounts.note4_tradeReceivables.reduce((s, a) => s + a.finalBalance, 0) + balanceData.current.allAccounts.note5_otherReceivables.reduce((s, a) => s + a.finalBalance, 0) + balanceData.current.allAccounts.note6_inventory.reduce((s, a) => s + a.finalBalance, 0) + balanceData.current.allAccounts.note_prepaid_expenses.reduce((s, a) => s + a.finalBalance, 0))}</td>${comparisonMode ? `<td class="amount text-end">${formatCurrency(balanceData.prior.currentAssets)}</td>` : ''}</tr>
            <tr><td>يخصم: مجموع الالتزامات المتداولة</td><td class="amount text-end negative">(${formatCurrency(balanceData.current.currentLiabilities)})</td>${comparisonMode ? `<td class="amount text-end negative">(${formatCurrency(balanceData.prior.currentLiabilities)})</td>` : ''}</tr>
            <tr class="total">
                <td><strong>صافي رأس المال العامل</strong></td>
                <td class="amount text-end ${currentWC < 0 ? 'negative' : ''}"><strong>${formatCurrency(currentWC)}</strong></td>
                ${comparisonMode ? `<td class="amount text-end ${priorWC < 0 ? 'negative' : ''}"><strong>${formatCurrency(priorWC)}</strong></td>` : ''}
            </tr>
        </tbody>
    </table>
    <div class="alert ${currentWC > 0 ? 'alert-success' : 'alert-danger'} mt-3">${currentWC > 0 ? 'الشركة لديها سيولة كافية لتغطية التزاماتها قصيرة الأجل.' : 'تحذير: الشركة تواجه عجزاً في السيولة قصيرة الأجل.'}</div>`;
    container.innerHTML = html;
}

// ==================================================================
// --- END: دوال الإيضاحات المطورة ---
// ==================================================================
        function printSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            const allSections = document.querySelectorAll('.financial-statement, .notes-section, .kpi-dashboard, .charts-section, .control-panel');
            allSections.forEach(s => s.style.display = 'none');
            document.querySelector('.print-header').style.display = 'block';
            section.style.display = 'block';
            const summaryDiv = section.querySelector(`#${sectionId.replace('Section', 'Summary')}`);
            const detailedDiv = section.querySelector(`#${sectionId.replace('Section', 'Detailed')}`);
            if (summaryDiv && detailedDiv) {
                if (summaryDiv.style.display === 'none') {
                    summaryDiv.style.display = 'none';
                    detailedDiv.style.display = 'block';
                } else {
                    summaryDiv.style.display = 'block';
                    detailedDiv.style.display = 'none';
                }
            }
            window.print();
            setTimeout(() => {
                allSections.forEach(s => s.style.display = 'block');
                document.querySelector('.print-header').style.display = 'none';
                if (summaryDiv && detailedDiv) {
                    summaryDiv.style.display = summaryDiv.style.display === 'none' ? 'none' : 'block';
                    detailedDiv.style.display = detailedDiv.style.display === 'none' ? 'none' : 'block';
                }
            }, 100);
        }
        async function generatePDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'pt',
                    format: 'a4'
                });
                async function loadArabicFont() {
                    try {
                        const fontCandidates = [
                            { key: 'pdfFont_Amiri_v23', url: 'https://fonts.gstatic.com/s/amiri/v23/Amiri-Regular.ttf', name: 'Amiri-Regular.ttf', family: 'Amiri' },
                            { key: 'pdfFont_NotoNaskh_v32', url: 'https://fonts.gstatic.com/s/notonaskharabic/v32/oY2J6ez5HfmgFDKkG4hvQ2K1KU5uDQ.woff2', name: 'NotoNaskhArabic-Regular.woff2', family: 'NotoNaskhArabic' }
                        ];
                        for (const font of fontCandidates) {
                            try {
                                let base64 = localStorage.getItem(font.key);
                                if (!base64) {
                                    const res = await fetch(font.url, { mode: 'cors' });
                                    const buf = await res.arrayBuffer();
                                    const bytes = new Uint8Array(buf);
                                    let binary = '';
                                    for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
                                    base64 = btoa(binary);
                                    localStorage.setItem(font.key, base64);
                                }
                                doc.addFileToVFS(font.name, base64);
                                doc.addFont(font.name, font.family, 'normal');
                                doc.setFont(font.family, 'normal');
                                return true;
                            } catch {}
                        }
                        return false;
                    } catch (e) { return false; }
                }
                const fontLoaded = await loadArabicFont();
                let y = 60;

                const pageW = doc.internal.pageSize.getWidth();
                const drawTextRTL = (text, yPos, options = {}) => {
                    doc.text(text, pageW - 40, yPos, { align: 'right', ...options });
                };

                const companyName = (document.getElementById('companyNamePrint')?.textContent || '').trim();
                const endLabel = window._polaris_endDate ? `نهاية الفترة: (${window._polaris_endDate})` : '';
                const logoEl = document.getElementById('companyLogoPrint');
                const logoSrc = logoEl && logoEl.style.display !== 'none' ? logoEl.src : null;

                // Cover header
                if (logoSrc) {
                    try { doc.addImage(logoSrc, 'PNG', pageW - 140, 30, 80, 80); } catch {}
                }
                doc.setFontSize(18);
                drawTextRTL(companyName || 'القوائم المالية', y);
                y += 25;
                doc.setFontSize(14);
                drawTextRTL('القوائم المالية', y);
                y += 18;
                if (endLabel) { doc.setFontSize(11); drawTextRTL(endLabel, y); y += 22; }

                async function snapshotElement(el) {
                    const margin = 30;
                    const pageW = doc.internal.pageSize.getWidth();
                    const pageH = doc.internal.pageSize.getHeight();
                    const canvas = await html2canvas(el, { scale: 2, backgroundColor: '#ffffff' });
                    const imgData = canvas.toDataURL('image/png');
                    const renderW = pageW - margin * 2;
                    const renderH = canvas.height * (renderW / canvas.width);
                    if (y + renderH > pageH - margin) { doc.addPage(); y = margin; }
                    doc.addImage(imgData, 'PNG', margin, y, renderW, renderH);
                    y += renderH + 20;
                }
                async function drawSectionById(id) {
                    const el = document.getElementById(id);
                    if (!el) return;
                    const prev = el.style.display;
                    el.style.display = 'block';
                    await snapshotElement(el);
                    el.style.display = prev;
                }

                const exportDetailed = document.getElementById('exportDetailedToggle')?.checked;
                const printHeader = document.querySelector('.print-header');
                if (printHeader) {
                    const prevPH = printHeader.style.display;
                    printHeader.style.display = 'block';
                    await snapshotElement(printHeader);
                    printHeader.style.display = prevPH;
                    doc.addPage();
                    y = 30;
                }
                await drawSectionById(exportDetailed ? 'incomeStatementDetailed' : 'incomeStatementContent');
                await drawSectionById(exportDetailed ? 'balanceSheetDetailed' : 'balanceSheetContent');
                await drawSectionById(exportDetailed ? 'cashFlowDetailed' : 'cashFlowContent');
                await drawSectionById(exportDetailed ? 'equityStatementDetailed' : 'equityStatementContent');

                const addNote = async (num) => {
                    await drawSectionById(exportDetailed ? `note${num}Detailed` : `note${num}Summary`);
                };
                await addNote(3);
                await addNote(4);
                await addNote(5);
                await addNote(6);
                await addNote(7);
                await addNote(8);
                await addNote(9);
                await addNote(10);
                await addNote(11);
                await addNote(12);
                await addNote(13);
                await addNote(14);
                await addNote(15);

                const safeName = companyName || 'company';
                doc.save(`القوائم المالية - ${safeName}.pdf`);
            } catch (error) {
                console.error("فشل تصدير PDF:", error);
                try {
                    window.print();
                    alert("تعذر إنشاء PDF داخليًا. تم استخدام طباعة المتصفح كبديل.");
                } catch {}
            }
        }
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([["Hello", "World"]]);
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, 'export.xlsx');
        }
        function exportAsStandaloneHTML() {
            const html = document.documentElement.outerHTML;
            const blob = new Blob([html], {type: 'text/html'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'standalone.html';
            a.click();
        }
        function uploadPriorYearFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,application/json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            priorYearData = JSON.parse(event.target.result);
                            
                            // التحقق من صحة البيانات
                            if (!priorYearData.clientInfo || !priorYearData.trialBalance) {
                                alert('خطأ: الملف لا يحتوي على بيانات صحيحة.');
                                return;
                            }
                            const company = priorYearData.clientInfo.name || priorYearData.clientInfo.company_name || 'اسم غير متوفر';
                            const yr = priorYearData.year || (priorYearData.clientInfo.endDate ? new Date(priorYearData.clientInfo.endDate).getFullYear() : 'السابقة');
                            const accountsCount = Array.isArray(priorYearData.trialBalance) ? priorYearData.trialBalance.length : 0;
                            const summary = `سيتم استخدام الملف التالي للمقارنة:\n\n` +
                                `• الشركة: ${company}\n` +
                                `• سنة المقارنة: ${yr}\n` +
                                `• عدد الحسابات: ${accountsCount}\n\n` +
                                `هل ترغب في إدراج هذه البيانات في المقارنة؟`;
                            if (confirm(summary)) {
                                localStorage.setItem('priorYearDataLoaded', JSON.stringify(priorYearData));
                                document.getElementById('comparisonMode').checked = true;
                                comparisonMode = true;
                                localStorage.setItem('comparisonMode', 'true');
                                initializeDashboard();
                            } else {
                                priorYearData = null;
                            }
                        } catch (error) {
                            console.error('خطأ في قراءة ملف JSON:', error);
                            alert('خطأ: لم يتمكن من قراءة الملف. تأكد من أنه ملف JSON صحيح.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        function uploadLogo() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const logoData = e.target.result;
                        localStorage.setItem(`companyLogo_${localStorage.getItem('activeClientId')}`, logoData);
                        document.getElementById('companyLogo').src = logoData;
                        document.getElementById('companyLogo').style.display = 'block';
                        document.getElementById('companyLogoPrint').src = logoData;
                        document.getElementById('companyLogoPrint').style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }
function goBackToMapping() {
    const cid = localStorage.getItem('activeClientId');
    if (cid) {
        window.location.href = `account-mapping.html?clientId=${cid}`;
    } else {
        window.location.href = 'account-mapping.html';
    }
}
function saveBackupForNextYear() {
    const auditData = loadFinalAuditData();
    if (!auditData || !auditData.clientInfo || !auditData.clientInfo.endDate) {
        alert('خطأ: لا يمكن إنشاء ملف النسخة الاحتياطية. بيانات الشركة أو تاريخ نهاية الفترة غير مكتمل.');
        return;
    }

    try {
        const currentYear = new Date(auditData.clientInfo.endDate).getFullYear();
        const companyName = auditData.clientInfo.name || 'company';
        
        // إنشاء اسم ملف واضح ومميز
        const fileName = `Backup_${companyName.replace(/ /g, '_')}_${currentYear}.json`;

        // 1. إنشاء حزمة بيانات كاملة تحتوي على كل ما هو ضروري للمقارنة
        const backupData = {
            clientInfo: auditData.clientInfo,
            trialBalance: auditData.trialBalance,
            adjustments: auditData.adjustments || [],
            settings: auditData.settings || {},
            year: currentYear,
            savedDate: new Date().toISOString()
        };

        // 2. تحويل البيانات إلى سلسلة نصية JSON منسقة لسهولة القراءة
        const fileContent = JSON.stringify(backupData, null, 4); // null, 4 للتنسيق الجميل

        // 3. إنشاء كائن "Blob" وهو يمثل الملف في الذاكرة
        const blob = new Blob([fileContent], { type: 'application/json' });

        // 4. إنشاء رابط وهمي في الذاكرة لتنزيل الملف
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;

        // 5. إضافة الرابط إلى الصفحة، الضغط عليه برمجياً، ثم إزالته
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        console.log(`✅ تم إنشاء وتنزيل ملف النسخة الاحتياطية بنجاح: ${fileName}`);
        alert(`تم تنزيل ملف النسخة الاحتياطية للسنة ${currentYear} بنجاح.\nاحتفظ بهذا الملف لاستخدامه في المقارنة السنة القادمة.`);

    } catch (error) {
        console.error("فشل إنشاء ملف النسخة الاحتياطية:", error);
        alert("حدث خطأ غير متوقع أثناء محاولة إنشاء ملف النسخة الاحتياطية.");
    }
}
        function loadComparisonData() {
            const auditData = loadFinalAuditData();
            if (!auditData || !auditData.clientInfo) {
                alert('خطأ: لم يتم العثور على بيانات السنة الحالية.');
                return;
            }
            
            const currentYear = new Date(auditData.clientInfo.endDate).getFullYear();
            const priorYear = currentYear - 1;
            const backupKey = `priorYearData_${auditData.clientInfo.id}_${priorYear}`;
            
            const backupDataJSON = localStorage.getItem(backupKey);
            if (backupDataJSON) {
                try {
                    const priorData = JSON.parse(backupDataJSON);
                    // حفظ البيانات في مفتاح خاص للسنة السابقة
                    localStorage.setItem('priorYearDataLoaded', backupDataJSON);
                    console.log(`✅ تم استرجاع بيانات السنة ${priorYear}`);
                    alert(`تم استرجاع بيانات السنة ${priorYear} بنجاح.\nفعّل خيار "مقارنة بالفترة السابقة" لعرض المقارنة.`);
                    
                    // تفعيل وضع المقارنة تلقائياً
                    document.getElementById('comparisonMode').checked = true;
                    localStorage.setItem('comparisonMode', 'true');
                    
                    // إعادة تحميل القوائم
                    initializeDashboard();
                } catch (error) {
                    console.error('خطأ في قراءة بيانات المقارنة:', error);
                    alert('خطأ في قراءة بيانات المقارنة.');
                }
            } else {
                alert(`لا توجد بيانات محفوظة للسنة ${priorYear}.\nاستخدم زر "حفظ نسخة" لحفظ بيانات السنة الحالية أولاً.`);
            }
        }
        function refreshData() {
            window.location.reload();
        }
        let chartInstances = {};
let balanceData = {}; // <--- === أضف هذا السطر هنا ===

  // ==================================================================
// --- START: الكود الجديد والكامل لملف القوائم المالية ---
// ==================================================================

/**
 * دالة تحميل بيانات المراجعة النهائية من نظام تدفق البيانات.
 * @returns {object|null} - كائن بيانات المراجعة أو null في حالة الفشل.
 */
// ==================================================================
// --- START: دالة التحميل النهائية (V5 - مع نقل كل البيانات) ---
// ==================================================================
function loadFinalAuditData() {
    const activeClientId = localStorage.getItem('activeClientId');
    if (!activeClientId) {
        showError("<h4>خطأ فادح</h4><p>لم يتم العثور على معرّف العميل النشط.</p>");
        return null;
    }
    // تفضيل النسخة النهائية إن وجدت
    const finalJSON = localStorage.getItem(`finalAudit_${activeClientId}`);
    let finalData = null;
    if (finalJSON) {
        try { finalData = JSON.parse(finalJSON); } catch { finalData = null; }
    }
    if (!finalData) {
        const dataKey = `accountMappingData_${activeClientId}`;
        const savedDataJSON = localStorage.getItem(dataKey);
        if (!savedDataJSON) {
            showError("<h4>البيانات غير متاحة</h4><p>لم يتم العثور على بيانات مراجعة معتمدة. يرجى العودة لصفحة المراجعة والضغط على 'اعتماد نهائي' مرة أخرى.</p>");
            return null;
        }
        finalData = JSON.parse(savedDataJSON);
    }

    // **هنا التعديل الجوهري: سنقوم بتمرير البيانات كما هي تقريباً**
    // ونقوم فقط بتغيير أسماء الحقول لتناسب الدوال الحالية.
    let trialBalanceArr = [];
    if (Array.isArray(finalData.accounts)) {
        trialBalanceArr = finalData.accounts.map(acc => ({
            account_id: acc.accountNumber,
            name: acc.accountName,
            category: acc.category,
            sub_category: acc.subCategory,
            ob_debit: acc.openingBalance > 0 ? acc.openingBalance : 0,
            ob_credit: acc.openingBalance < 0 ? Math.abs(acc.openingBalance) : 0,
            move_debit: acc.movementBalance > 0 ? acc.movementBalance : 0,
            move_credit: acc.movementBalance < 0 ? Math.abs(acc.movementBalance) : 0,
            book_balance: acc.finalBalance,
            finalBalance: acc.finalBalance
        }));
    } else if (Array.isArray(finalData.trialBalance)) {
        trialBalanceArr = finalData.trialBalance.map(acc => ({
            account_id: acc.account_id,
            name: acc.name,
            category: acc.category,
            sub_category: acc.sub_category,
            ob_debit: acc.ob_debit,
            ob_credit: acc.ob_credit,
            move_debit: acc.move_debit,
            move_credit: acc.move_credit,
            book_balance: acc.book_balance,
            finalBalance: acc.finalBalance
        }));
    } else {
        console.warn('⚠️ لا توجد مصفوفة حسابات معروفة في finalData');
        trialBalanceArr = [];
    }

    const auditData = {
        clientInfo: finalData.clientInfo || {},
        trialBalance: trialBalanceArr,
        adjustments: finalData.adjustments || [],
        settings: finalData.settings || {}
    };

    console.log("✅ تم تحميل حقيبة المراجعة النهائية الكاملة.", auditData);
    
    return auditData;
}
// ==================================================================
// --- END: دالة التحميل النهائية ---
// ==================================================================

// ==================================================================
// --- START: دالة إيضاح 7 (النسخة النهائية v12 - مع عمود السنة السابقة) ---
// ==================================================================
function renderNote7(auditData, balanceData, categorizedDataPrior, comparisonMode, currentYear, priorYear) {
    console.log("--- بدء تشغيل إيضاح 7 (النسخة النهائية v12 - مع عمود السنة السابقة) ---");
    const summaryBody = document.getElementById('note7SummaryBody');
    const detailedBody = document.getElementById('note7DetailedBody');
    if (!summaryBody || !detailedBody) {
        console.error("خطأ فادح: لم يتم العثور على عناصر HTML لإيضاح 7.");
        return;
    }
    if (!auditData || !auditData.trialBalance) {
        detailedBody.innerHTML = '<tr><td colspan="12" class="text-center text-danger">بيانات المراجعة غير متوفرة.</td></tr>';
        return;
    }

    const allAccounts = auditData.trialBalance;

    // خريطة الربط النهائية والدقيقة
    const ASSET_MAPPING = [
        { assetName: 'برامج حاسب الى', accumName: 'مجمع اهلاك برامج', expenseName: null, isDisposed: true }, 
        { assetName: '(مبنى الإدارة)', accumName: 'مجمع اهلاك مبنى الإدارة', expenseName: 'مصاريف استهلاك مباني وهناجر' },
        { assetName: 'السيارات', accumName: 'مجمع اهلاك  سيارات', expenseName: 'مصاريف استهلاك وسائل نقل وانتقال - سيارات' },
        { assetName: 'الات و معدات', accumName: 'مجمع اهلاك  الات و معدات', expenseName: 'مصاريف استهلاك الات ومعدات' },
        { assetName: 'شاحنات', accumName: 'مجمع اهلاك  شاحنات', expenseName: 'مصاريف استهلاك شاحنات' },
        { assetName: 'أجهزة حاسب الى', accumName: 'مجمع اهلاك  أجهزة حاسب الى', expenseName: 'مصاريف استهلاك حاسبات' },
        { assetName: 'أصول شركات شقيقه (ما يخص الكسارة)', accumName: 'مجمع اهلاك الكسارة', expenseName: 'مصاريف استهلاك اصول شركات تابعة (الكسارة)' },
        { assetName: 'مصاريف تاسيس النشاط', accumName: 'مجمع اهلاك مصاريف التاسيس', expenseAccountId: '60101000309' },
        { assetName: 'اصول اخري كهربائية', accumName: 'مجمع اهلاك  اجهزة كهربائية', expenseAccountId: '60101000308' }
    ];

    const assetAccounts = allAccounts.filter(acc => ['fixed_assets', 'intangible_assets'].includes(SUB_CATEGORY_MAPPING[acc.sub_category]));

    const movementData = assetAccounts.map(asset => {
        const mapping = ASSET_MAPPING.find(m => m.assetName.trim() === asset.name.trim());

        if (!mapping) {
            console.warn(`لم يتم العثور على خريطة ربط للأصل: ${asset.name}`);
            return null;
        }

        const accum = allAccounts.find(acc => acc.name.trim() === mapping.accumName.trim());
        
        const expense = mapping.expenseName 
            ? allAccounts.find(acc => acc.name.trim() === mapping.expenseName.trim())
            : allAccounts.find(acc => acc.account_id === mapping.expenseAccountId);

        const cost_ob = (parseFloat(asset.ob_debit) || 0) - (parseFloat(asset.ob_credit) || 0);
        const cost_additions = mapping.isDisposed ? 0 : (parseFloat(asset.move_debit) || 0) - (parseFloat(asset.move_credit) || 0);
        const cost_disposals = mapping.isDisposed ? cost_ob : 0;
        const cost_cb = cost_ob + cost_additions - cost_disposals;

        const accum_ob = accum ? (parseFloat(accum.ob_debit) || 0) - (parseFloat(accum.ob_credit) || 0) : 0;
        const dep_expense = expense ? calculateFinalBalance(expense, auditData.adjustments) : 0;
        const accum_disposals = mapping.isDisposed ? accum_ob : 0;
        
        const accum_cb = accum_ob - dep_expense + accum_disposals;

        const net_value_cb = cost_cb + accum_cb;
        const net_value_ob = cost_ob + accum_ob; // <-- هذه هي القيمة المطلوبة

        return {
            name: asset.name,
            cost_ob, cost_additions, cost_disposals, cost_cb,
            accum_ob, dep_expense, accum_disposals, accum_cb,
            net_value_cb, net_value_ob
        };
    }).filter(item => item !== null);

    const totals = movementData.reduce((acc, item) => {
        Object.keys(item).forEach(key => {
            if (key !== 'name') acc[key] = (acc[key] || 0) + item[key];
        });
        return acc;
    }, {});

    const endDate = auditData?.clientInfo?.endDate ? formatDateLong(new Date(auditData.clientInfo.endDate)) : null;
    let priorEndDate = null;
    try { const pj = localStorage.getItem('priorYearDataLoaded'); if (pj) { const pd = JSON.parse(pj); priorEndDate = pd?.clientInfo?.endDate ? formatDateLong(new Date(pd.clientInfo.endDate)) : null; } } catch {}
    const currentLabel = endDate ? `(${endDate})` : '-';
    const priorLabel = priorEndDate ? `(${priorEndDate})` : '-';
    const detailedHeader = `
        <thead>
            <tr>
                <th rowspan="2" class="align-middle">البيان</th>
                <th colspan="4" class="text-center">التكلفة</th>
                <th colspan="4" class="text-center">الاستهلاكات</th>
                <th colspan="${comparisonMode ? 2 : 1}" class="text-center">صافي القيمة الدفترية</th>
            </tr>
            <tr>
                <th>أول العام</th><th>إضافات</th><th>استبعادات</th><th>آخر العام</th>
                <th>مجمع أول العام</th><th>إهلاك العام</th><th>استبعادات</th><th>مجمع آخر العام</th>
                <th>${currentLabel}</th>
                ${comparisonMode ? `<th>${priorLabel}</th>` : ''}
            </tr>
        </thead>`;
    let detailedHTML = '';
    movementData.forEach(item => {
        detailedHTML += `
            <tr>
                <td>${item.name}</td>
                <td class="amount">${formatCurrency(item.cost_ob)}</td>
                <td class="amount">${formatCurrency(item.cost_additions)}</td>
                <td class="amount negative">(${formatCurrency(item.cost_disposals)})</td>
                <td class="amount"><strong>${formatCurrency(item.cost_cb)}</strong></td>
                <td class="amount negative">(${formatCurrency(Math.abs(item.accum_ob))})</td>
                <td class="amount negative">(${formatCurrency(item.dep_expense)})</td>
                <td class="amount">(${formatCurrency(Math.abs(item.accum_disposals))})</td>
                <td class="amount negative"><strong>(${formatCurrency(Math.abs(item.accum_cb))})</strong></td>
                <td class="amount"><strong>${formatCurrency(item.net_value_cb)}</strong></td>
                ${comparisonMode ? `<td class="amount">${formatCurrency(item.net_value_ob)}</td>` : ''}
            </tr>
        `;
    });
    if (Object.keys(totals).length > 0) {
        detailedHTML += `
            <tr class="total">
                <td><strong>الإجمالي</strong></td>
                <td class="amount"><strong>${formatCurrency(totals.cost_ob)}</strong></td>
                <td class="amount"><strong>${formatCurrency(totals.cost_additions)}</strong></td>
                <td class="amount negative"><strong>(${formatCurrency(totals.cost_disposals)})</strong></td>
                <td class="amount"><strong>${formatCurrency(totals.cost_cb)}</strong></td>
                <td class="amount negative"><strong>(${formatCurrency(Math.abs(totals.accum_ob))})</strong></td>
                <td class="amount negative"><strong>(${formatCurrency(totals.dep_expense)})</strong></td>
                <td class="amount"><strong>(${formatCurrency(Math.abs(totals.accum_disposals))})</strong></td>
                <td class="amount negative"><strong>(${formatCurrency(Math.abs(totals.accum_cb))})</strong></td>
                <td class="amount"><strong>${formatCurrency(totals.net_value_cb)}</strong></td>
                ${comparisonMode ? `<td class="amount"><strong>${formatCurrency(totals.net_value_ob)}</strong></td>` : ''}
            </tr>
        `;
    }
    detailedBody.parentElement.innerHTML = detailedHeader + `<tbody>${detailedHTML}</tbody>`;

    const summaryHeader = `<thead><tr><th>البيان</th><th>${currentLabel}</th>${comparisonMode ? `<th>${priorLabel}</th>` : ''}</tr></thead>`;
    let summaryHTML = `
        <tr>
            <td>التكلفة التاريخية</td>
            <td class="amount">${formatCurrency(totals.cost_cb)}</td>
            ${comparisonMode ? `<td class="amount">${formatCurrency(totals.cost_ob)}</td>` : ''}
        </tr>
        <tr>
            <td>(-) مجمع الإهلاك</td>
            <td class="amount negative">(${formatCurrency(Math.abs(totals.accum_cb))})</td>
            ${comparisonMode ? `<td class="amount negative">(${formatCurrency(Math.abs(totals.accum_ob))})</td>` : ''}
        </tr>
        <tr class="total">
            <td><strong>صافي القيمة الدفترية</strong></td>
            <td class="amount"><strong>${formatCurrency(totals.net_value_cb)}</strong></td>
            ${comparisonMode ? `<td class="amount"><strong>${formatCurrency(totals.net_value_ob)}</strong></td>` : ''}
        </tr>
    `;
    summaryBody.parentElement.innerHTML = summaryHeader + `<tbody>${summaryHTML}</tbody>`;
    console.log("--- انتهى تشغيل إيضاح 7 بنجاح ---");
}
// ==================================================================
// --- END: دالة إيضاح 7 (النسخة النهائية v12) ---
// ==================================================================
// ==================================================================
// --- START: دالة إيضاحات المركز المالي (V68 - النسخة الكاملة) ---
// ==================================================================
function renderBalanceSheetNotes(auditData, balanceData, comparisonMode, currentYear, priorYear) {

    // --- Note 1 & 2: تعريف بالمنشأة والسياسات ---
    const note1Container = document.getElementById('note1Content');
    if (note1Container) {
        const clientInfo = auditData.clientInfo || {};
        note1Container.innerHTML = `<div class="note-description">
            <p>${clientInfo.name || 'الشركة'} هي منشأة ${clientInfo.type || 'تجارية'} مسجلة في ${clientInfo.location || 'المملكة العربية السعودية'}.</p>
            <p>النشاط الرئيسي: ${clientInfo.activity || 'غير محدد'}.</p>
        </div>`;
    }
    const note2Container = document.getElementById('note2Content');
    if (note2Container) {
        note2Container.innerHTML = `<div class="note-description">
            <p>تم إعداد القوائم المالية وفقاً لأساس الاستحقاق المحاسبي.</p>
            <div class="policy-box"><h6 class="sub-note-title">أساس القياس:</h6><p>تم إعداد القوائم المالية بالتكلفة التاريخية.</p></div>
            <div class="policy-box"><h6 class="sub-note-title">الاستهلاك:</h6><p>يتم احتساب استهلاك الممتلكات والآلات والمعدات بطريقة القسط الثابت.</p></div>
        </div>`;
    }

    const endDate = auditData?.clientInfo?.endDate ? formatDateLong(new Date(auditData.clientInfo.endDate)) : null;
    let priorEndDate = null;
    try {
        const priorJSON = localStorage.getItem('priorYearDataLoaded');
        if (priorJSON) {
            const priorData = JSON.parse(priorJSON);
            if (priorData?.clientInfo?.endDate) priorEndDate = formatDateLong(new Date(priorData.clientInfo.endDate));
        }
    } catch {}
    const currentLabel = endDate ? `(${endDate})` : '-';
    const priorLabel = priorEndDate ? `(${priorEndDate})` : '-';

    // --- دالة مساعدة عامة للإيضاحات البسيطة (3, 4, 6, 8, 10) ---
    function renderSimpleNote(noteId, noteTitle, dataKey) {
        const summaryBody = document.getElementById(`note${noteId}SummaryBody`);
        const detailedBody = document.getElementById(`note${noteId}DetailedBody`);
        if (!summaryBody || !detailedBody) return;

const accounts = (auditData.trialBalance || []).filter(acc => {
            const subCat = SUB_CATEGORY_MAPPING[acc.sub_category] || '';
            if (dataKey === 'inventory') {
                return subCat === 'inventory';
            }
            return subCat === dataKey;
        });
        
        let totalCurrent = 0;
        let totalPrior = 0;
        let detailedHTML = `<thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>${currentLabel}</th>${comparisonMode ? `<th>${priorLabel}</th>` : ''}</tr></thead><tbody>`;

        accounts.forEach(acc => {
            const balanceCurrent = calculateFinalBalance(acc, auditData.adjustments);
            const balancePrior = (parseFloat(acc.ob_debit) || 0) - (parseFloat(acc.ob_credit) || 0);
            totalCurrent += balanceCurrent;
            totalPrior += balancePrior;
            detailedHTML += `<tr><td>${acc.account_id || '-'}</td><td>${acc.name}</td><td class="amount">${formatCurrency(balanceCurrent)}</td>${comparisonMode ? `<td class="amount">${formatCurrency(balancePrior)}</td>` : ''}</tr>`;
        });
        detailedHTML += `</tbody>`;
        detailedBody.parentElement.innerHTML = detailedHTML;

        let summaryHTML = `<thead><tr><th>البيان</th><th>${currentLabel}</th>${comparisonMode ? `<th>${priorLabel}</th>` : ''}</tr></thead><tbody>
                           <tr><td>${noteTitle}</td><td class="amount">${formatCurrency(totalCurrent)}</td>${comparisonMode ? `<td class="amount">${formatCurrency(totalPrior)}</td>` : ''}</tr>
                           <tr class="total"><td><strong>الإجمالي</strong></td><td class="amount"><strong>${formatCurrency(totalCurrent)}</strong></td>${comparisonMode ? `<td class="amount"><strong>${formatCurrency(totalPrior)}</strong></td>` : ''}</tr>
                       </tbody>`;
        summaryBody.parentElement.innerHTML = summaryHTML;
    }

    // --- إيضاح (5) و (9) - حالات خاصة ---
    function renderComplexNotes() {
        renderNote5(auditData, null, comparisonMode, currentYear, priorYear);
        renderNote9(auditData, null, comparisonMode, currentYear, priorYear);
    }

    // --- استدعاء دوال العرض لكل إيضاح ---
    renderSimpleNote('3', 'النقدية وما في حكمها', 'cash');
    renderSimpleNote('4', 'مدينون تجاريون', 'trade_receivables');
    renderSimpleNote('6', 'المخزون', 'inventory');
    renderSimpleNote('8', 'دائنون تجاريون', 'trade_payables');
    renderSimpleNote('10', 'مخصص الزكاة والضريبة', 'zakat_tax_provision');
    
    renderComplexNotes(); // Handles notes 5 and 9

    // --- Note 7: تم إزالة Placeholder القديم - الآن يستخدم renderNote7 الكاملة ---
    
  // ==================================================================
// --- START: إيضاح رأس المال العامل (V72 - مع تصحيح التحذير) ---
// ==================================================================
const note15Container = document.getElementById('note15Content');
if(note15Container) {
    const currentWC = balanceData.current.currentAssets - balanceData.current.currentLiabilities;
    let priorWC_html = '';
    if (comparisonMode && balanceData.prior) {
        const priorWC = balanceData.prior.currentAssets - balanceData.prior.currentLiabilities;
        priorWC_html = `<td class="amount text-end">${formatCurrency(priorWC)}</td>`;
    }
    
    let html = `<div class="note-description"><p>رأس المال العامل هو مقياس للسيولة قصيرة الأجل للشركة.</p></div>
    <table class="financial-table">
        <thead><tr><th>البند</th><th class="text-end">${window._polaris_endDate ? `(${window._polaris_endDate})` : '-'}</th>${comparisonMode ? `<th class="text-end">${window._polaris_priorEndDate ? `(${window._polaris_priorEndDate})` : '-'}</th>` : ''}</tr></thead>
        <tbody>
            <tr><td>مجموع الأصول المتداولة</td><td class="amount text-end">${formatCurrency(balanceData.current.currentAssets)}</td>${comparisonMode ? `<td class="amount text-end">${formatCurrency(balanceData.prior.currentAssets)}</td>` : ''}</tr>
            <tr><td>يخصم: مجموع الالتزامات المتداولة</td><td class="amount text-end negative">(${formatCurrency(balanceData.current.currentLiabilities)})</td>${comparisonMode ? `<td class="amount text-end negative">(${formatCurrency(balanceData.prior.currentLiabilities)})</td>` : ''}</tr>
            <tr class="total"><td><strong>صافي رأس المال العامل</strong></td><td class="amount text-end"><strong>${formatCurrency(currentWC)}</strong></td>${priorWC_html}</tr>
        </tbody>
    </table>`;

    if (currentWC > 0) {
        html += `<div class="alert alert-success mt-3">الشركة لديها سيولة كافية لتغطية التزاماتها قصيرة الأجل.</div>`;
    } else {
        html += `<div class="alert alert-danger mt-3">تحذير: الشركة تواجه عجزاً في السيولة قصيرة الأجل.</div>`;
    }
    
    note15Container.innerHTML = html;
}
// ==================================================================
// --- END: إيضاح رأس المال العامل (V72) ---
// ==================================================================

}
// ==================================================================
// ==================================================================
// --- START: دالة عرض حقوق الملكية (النسخة النهائية) ---
// ==================================================================
// *** UPDATED: displayEquityStatement to handle comparison ***
function displayEquityStatement(equityData, comparisonMode, currentYear, priorYear) {
    const container = document.getElementById('equityStatementContent');
    const detailedContainer = document.getElementById('equityStatementDetailedContent');
    
    if (!equityData || !equityData.current) {
        if(container) container.innerHTML = `<div class="data-empty">لا توجد بيانات كافية لعرض قائمة التغيرات في حقوق الملكية.</div>`;
        return;
    }

    const eq = equityData.current;
    const prior = equityData.prior;

    // بناء الجدول الإجمالي
    let html = `<table class="financial-table ${comparisonMode ? 'comparison-table' : ''}">
        <thead><tr><th>البيان</th><th class="text-end">${window._polaris_endDate ? `(${window._polaris_endDate})` : '-'}</th>${comparisonMode ? `<th class="text-end">${window._polaris_priorEndDate ? `(${window._polaris_priorEndDate})` : '-'}</th>` : ''}</tr></thead>
        <tbody>
            <tr>
                <td>رصيد حقوق الملكية في بداية الفترة</td>
                <td class="amount">${formatCurrency(eq.openingBalance)}</td>
                ${comparisonMode ? `<td class="amount">${formatCurrency(prior ? prior.openingBalance : 0)}</td>` : ''}
            </tr>
            <tr>
                <td>${eq.netProfit >= 0 ? 'يضاف: صافي ربح الفترة' : 'يطرح: صافي خسارة الفترة'}</td>
                <td class="amount ${eq.netProfit >= 0 ? 'positive' : 'negative'}">${formatCurrency(eq.netProfit)}</td>
                ${comparisonMode ? `<td class="amount ${prior && prior.netProfit >= 0 ? 'positive' : 'negative'}">${formatCurrency(prior ? prior.netProfit : 0)}</td>` : ''}
            </tr>
            <tr>
                <td>${eq.partnersCurrentChange >= 0 ? 'يضاف (يخصم): التغير في جاري الشركاء' : 'يطرح (يضاف): التغير في جاري الشركاء'}</td>
                <td class="amount ${eq.partnersCurrentChange >= 0 ? 'positive' : 'negative'}">${formatCurrency(eq.partnersCurrentChange)}</td>
                ${comparisonMode ? `<td class="amount ${prior && prior.partnersCurrentChange >= 0 ? 'positive' : 'negative'}">${formatCurrency(prior ? prior.partnersCurrentChange : 0)}</td>` : ''}
            </tr>
            <tr class="total">
                <td><strong>رصيد حقوق الملكية في نهاية الفترة</strong></td>
                <td class="amount"><strong>${formatCurrency(eq.closingBalance)}</strong></td>
                ${comparisonMode ? `<td class="amount"><strong>${formatCurrency(prior ? prior.closingBalance : 0)}</strong></td>` : ''}
            </tr>
        </tbody>
    </table>`;
    container.innerHTML = html;

    // بناء الجدول التفصيلي
    if (detailedContainer) {
        let detailedHtml = `<table class="financial-table"><thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th class="text-end">${window._polaris_endDate ? `(${window._polaris_endDate})` : '-'}</th></tr></thead><tbody>`;
        if (eq.allAccounts && eq.allAccounts.equity) {
            eq.allAccounts.equity.forEach(acc => {
                detailedHtml += `<tr>
                    <td>${acc.account_id || '-'}</td>
                    <td>${acc.name}</td>
                    <td class="amount">${formatCurrency(acc.finalBalance)}</td>
                </tr>`;
            });
        }
        detailedHtml += `</tbody></table>`;
        detailedContainer.innerHTML = detailedHtml;
    }
}
// ==================================================================
// ==================================================================
// --- START: دالة حساب حقوق الملكية (النسخة النهائية) ---
// ==================================================================
function generateEquityStatement(categorizedData, netProfit, categorizedDataPrior) {
    if (!categorizedData || !categorizedData.equity) {
        return { 
            openingBalance: 0, 
            capital: 0, 
            retainedEarnings: 0, 
            partnersCurrentChange: 0, 
            netProfit: 0, 
            closingBalance: 0, 
            allAccounts: {} 
        };
    }

    // دالة مساعدة لحساب رصيد أول المدة لأي مجموعة من الحسابات
    const getOpeningBalance = (accounts) => {
        if (!accounts) return 0;
        return accounts.reduce((sum, acc) => sum + ((parseFloat(acc.ob_debit) || 0) - (parseFloat(acc.ob_credit) || 0)), 0);
    };

    // 1. حساب رصيد أول المدة الإجمالي (لكل حسابات حقوق الملكية)
    const openingBalance = -getOpeningBalance(categorizedData.equity);

    // 2. حساب رصيد آخر المدة لرأس المال والأرباح المبقاة فقط
    const closingCapital = -categorizedData.equity
        .filter(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'capital')
        .reduce((sum, acc) => sum + acc.finalBalance, 0);
        
    const closingRetained = -categorizedData.equity
        .filter(acc => SUB_CATEGORY_MAPPING[acc.sub_category] === 'retained_earnings')
        .reduce((sum, acc) => sum + acc.finalBalance, 0);

    // 3. حساب التغير في جاري الشركاء (كل ما تبقى)
    const partnersCurrentChange = -categorizedData.equity
        .filter(acc => !['capital', 'retained_earnings'].includes(SUB_CATEGORY_MAPPING[acc.sub_category]))
        .reduce((sum, acc) => sum + acc.finalBalance, 0) - getOpeningBalance(categorizedData.equity.filter(acc => !['capital', 'retained_earnings'].includes(SUB_CATEGORY_MAPPING[acc.sub_category])));

    // 4. حساب الرصيد النهائي للتأكد
    const closingBalance = openingBalance + netProfit + partnersCurrentChange;

    return {
        openingBalance,
        capital: closingCapital,
        retainedEarnings: closingRetained,
        partnersCurrentChange, // <-- التغير في جاري الشركاء
        netProfit,
        closingBalance,
        allAccounts: categorizedData
    };
}
// ==================================================================
// --- END: دالة حساب حقوق الملكية ---
// ==================================================================

// *** NEW: Function to display Pre-Approval Data ***
function displayPreApprovalData(preApprovalData) {
    const container = document.getElementById('preApprovalContent');
    if (!container || !preApprovalData || !preApprovalData.trialBalance) {
        container.innerHTML = '<div class="data-empty">لا توجد بيانات لعرضها.</div>';
        return;
    }

    let html = `<table class="financial-table">
        <thead>
            <tr>
                <th>رقم الحساب</th>
                <th>اسم الحساب</th>
                <th>رصيد أول المدة</th>
                <th>حركة المدين</th>
                <th>حركة الدائن</th>
                <th>الرصيد النهائي</th>
            </tr>
        </thead>
        <tbody>`;

    preApprovalData.trialBalance.forEach(account => {
        const openingBalance = (parseFloat(account.ob_debit) || 0) - (parseFloat(account.ob_credit) || 0);
        const movement = (parseFloat(account.move_debit) || 0) - (parseFloat(account.move_credit) || 0);
        const finalBalance = openingBalance + movement;

        html += `<tr>
            <td>${account.account_id || '-'}</td>
            <td>${account.name}</td>
            <td class="amount">${formatCurrency(openingBalance)}</td>
            <td class="amount">${formatCurrency(account.move_debit)}</td>
            <td class="amount">${formatCurrency(account.move_credit)}</td>
            <td class="amount ${finalBalance < 0 ? 'negative' : ''}">${formatCurrency(finalBalance)}</td>
        </tr>`;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;
    document.getElementById('preApprovalSection').style.display = 'block';
}

// *** NEW: Function to load Pre-Approval Data ***
function loadPreApprovalData() {
    const activeClientId = localStorage.getItem('activeClientId');
    if (!activeClientId) return null;

    const dataKey = `preApprovalData_${activeClientId}`;
    const savedDataJSON = localStorage.getItem(dataKey);

    if (!savedDataJSON) return null;

    try {
        return JSON.parse(savedDataJSON);
    } catch (error) {
        console.error("Failed to parse pre-approval data:", error);
        return null;
    }
}

// ==================================================================
// --- START: دالة التهيئة النهائية (V5 - النسخة المصححة والكاملة) ---
// ==================================================================
// *** UPDATED: initializeDashboard to handle comparison and pre-approval ***
function initializeDashboard() {
    console.log("Attempting to initialize dashboard...");

    let auditData = loadFinalAuditData();
    if (!auditData || !auditData.trialBalance) {
        const params = new URLSearchParams(window.location.search);
        const cid = params.get('clientId') || localStorage.getItem('activeClientId') || 'DEMO';
        if (!localStorage.getItem('activeClientId')) localStorage.setItem('activeClientId', cid);
        auditData = {
            clientInfo: { id: cid, name: 'شركة تجريبية', startDate: '2024-01-01', endDate: '2024-12-31' },
            trialBalance: [],
            adjustments: []
        };
    }

    document.getElementById('loadingIndicator').style.display = 'none';
    updateCompanyInfo(auditData.clientInfo);

    // Load prior year data if available
    const priorYearDataJSON = localStorage.getItem('priorYearDataLoaded');
    if (priorYearDataJSON) {
        try {
            priorYearData = JSON.parse(priorYearDataJSON);
            console.log('✅ تم العثور على بيانات السنة السابقة المحفوظة');
        } catch (error) {
            console.warn('خطأ في قراءة بيانات السنة السابقة:', error);
            priorYearData = null;
        }
    }

    // Set comparison mode from UI or localStorage
    comparisonMode = document.getElementById('comparisonMode').checked;
    if (!comparisonMode && localStorage.getItem('comparisonMode') === 'true') {
        comparisonMode = true;
        document.getElementById('comparisonMode').checked = true;
    }

    const categorizedData = categorizeAccounts(auditData.trialBalance, auditData.adjustments);
    const categorizedDataPrior = priorYearData ? categorizeAccounts(priorYearData.trialBalance, priorYearData.adjustments || []) : null;

    if (Object.values(categorizedData).every(arr => arr.length === 0)) {
        showError("<h4>فشل التصنيف.</h4><p>لم يتم تصنيف أي حسابات. الرجاء التأكد من صحة التصنيفات في صفحة المراجعة.</p>");
        return;
    }

    const incomeData = { 
        current: generateIncomeStatement(categorizedData), 
        prior: categorizedDataPrior ? generateIncomeStatement(categorizedDataPrior) : { totalRevenue: 0, finalNetIncome: 0, grossProfit: 0, /*... other zero values */ }
    };
    
    balanceData = { 
        current: generateBalanceSheet(categorizedData, incomeData.current.finalNetIncome), 
        prior: categorizedDataPrior ? generateBalanceSheet(categorizedDataPrior, incomeData.prior.finalNetIncome, true) : { totalAssets: 0, totalLiabilities: 0, totalEquity: 0, /*... other zero values */ }
    };
    
  const currentYear = new Date(auditData.clientInfo.endDate).getFullYear();
  let priorYear = currentYear - 1;
  if (priorYearData && (priorYearData.year || priorYearData.clientInfo?.endDate)) {
      priorYear = priorYearData.year || new Date(priorYearData.clientInfo.endDate).getFullYear();
  }
  window._polaris_endDate = auditData?.clientInfo?.endDate ? formatDateLong(new Date(auditData.clientInfo.endDate)) : null;
  window._polaris_priorEndDate = priorYearData?.clientInfo?.endDate ? formatDateLong(new Date(priorYearData.clientInfo.endDate)) : null;
  const badge = document.getElementById('comparisonBadge');
  if (badge) {
      if (comparisonMode) {
          badge.textContent = `مقارنة (${window._polaris_endDate || currentYear}) / (${window._polaris_priorEndDate || priorYear})`;
          badge.className = 'badge bg-info ms-2';
      } else {
          badge.textContent = 'بدون مقارنة';
          badge.className = 'badge bg-secondary ms-2';
      }
  }
  const params = new URLSearchParams(window.location.search);
  const cid = params.get('clientId') || localStorage.getItem('activeClientId');
  const withCid = (url) => cid ? `${url}?clientId=${cid}` : url;
  ['top_home','top_mapping','top_cockpit','top_reports','top_vat'].forEach(id => { const el = document.getElementById(id); if (el) { const href = el.getAttribute('href'); if (href) el.setAttribute('href', withCid(href)); } });

    // 1. عرض القوائم الرئيسية
    displayIncomeStatement(incomeData, comparisonMode, currentYear, priorYear);
    displayBalanceSheet(balanceData, auditData, comparisonMode, currentYear, priorYear, incomeData.current.finalNetIncome);
    displayEquityStatement({ 
        current: generateEquityStatement(categorizedData, incomeData.current.finalNetIncome, categorizedDataPrior), 
        prior: categorizedDataPrior ? generateEquityStatement(categorizedDataPrior, incomeData.prior.finalNetIncome, {}) : { openingBalance: 0, netProfit: 0, closingBalance: 0, partnersCurrentChange: 0 }
    }, comparisonMode, currentYear, priorYear);

    // --- START: إضافة قائمة التدفقات النقدية ---
  const cashFlowData = { 
        current: generateCashFlowStatement(incomeData.current, balanceData.current, balanceData.prior, auditData) 
    };
    displayCashFlowStatement(cashFlowData, categorizedData, categorizedDataPrior, auditData, comparisonMode, currentYear, priorYear);
    // --- END: إضافة قائمة التدفقات النقدية ---

    displayKPIDashboard(incomeData, balanceData, auditData);    
    initializeCharts(incomeData, balanceData);

    // 2. استدعاء دوال عرض الإيضاحات
    renderIncomeStatementNotes(categorizedData, comparisonMode, currentYear, priorYear);
    renderBalanceSheetNotes(auditData, balanceData, comparisonMode, currentYear, priorYear);
    renderNote1(auditData);
    renderNote2(auditData);
    renderNote3(auditData, categorizedDataPrior, comparisonMode, currentYear, priorYear);
    renderNote4(auditData, categorizedDataPrior, comparisonMode, currentYear, priorYear);
    renderNote5(auditData, comparisonMode, currentYear, priorYear);
    renderNote6(auditData, categorizedDataPrior, comparisonMode, currentYear, priorYear);
    renderNote7(auditData, balanceData, categorizedDataPrior, comparisonMode, currentYear, priorYear);
    renderNote8(auditData, categorizedDataPrior, comparisonMode, currentYear, priorYear);
    renderNote9(auditData, categorizedDataPrior, comparisonMode, currentYear, priorYear);
    renderNote10(auditData, categorizedDataPrior, comparisonMode, currentYear, priorYear);
    renderNote13(balanceData, comparisonMode);

    // 3. إظهار جميع الأقسام
    document.getElementById('incomeStatementSection').style.display = 'block';
    document.getElementById('balanceSheetSection').style.display = 'block';
    document.getElementById('equityStatementSection').style.display = 'block';
    document.getElementById('cashFlowSection').style.display = 'block';
    document.getElementById('kpiDashboard').style.display = 'block';
    document.getElementById('chartsSection').style.display = 'block';
    document.getElementById('notesSection').style.display = 'block';

    // 4. عرض بيانات ما قبل الموافقة إذا كانت متاحة
    const preApprovalData = loadPreApprovalData();
    if (preApprovalData) {
        displayPreApprovalData(preApprovalData);
    }
}
// ==================================================================
// --- END: دالة التهيئة النهائية ---
// ==================================================================
// **الخطوة 6: ربط دالة التهيئة بحدث تحميل الصفحة**
// هذا يضمن أن الكود سيعمل بمجرد أن تكون الصفحة جاهزة.
window.addEventListener('load', initializeDashboard);

// بناء الروابط مع clientId إن وجد
(function(){
    const params = new URLSearchParams(window.location.search);
    const cid = params.get('clientId') || localStorage.getItem('activeClientId');
    const withCid = (url) => cid ? `${url}?clientId=${cid}` : url;
    const setHref = (id, url) => { const el = document.getElementById(id); if (el) el.href = withCid(url); };
    setHref('nav_mapping','account-mapping.html');
    setHref('nav_cockpit','consolidation-cockpit.html');
    setHref('nav_reports','reporting-pantheon.html');
})();

// ==================================================================
// --- END: الكود الجديد والكامل لملف القوائم المالية ---
// ==================================================================

    </script>
</body>
</html>